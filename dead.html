<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Tab - Carbon</title>
    <script defer async>
      function setConfig() {
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                display: ["Switzer", "Helvetica", "sans-serif"],
                inter: ["Inter", "sans-serif"],
              },
              colors: {
                base: "#191724",
                surface: "#1f1d2e",
                overlay: "#26233a",
                muted: "#6e6a86",
                subtle: "#908caa",
                text: "#e0def4",
                love: "#eb6f92",
                gold: "#f6c177",
                rose: "#ebbcba",
                pine: "#31748f",
                foam: "#9ccfd8",
                iris: "#c4a7e7",
                "highlight-low": "#21202e",
                "highlight-med": "#403d52",
                "highlight-high": "#524f67",
              },
            },
          },
        };
      }
    </script>

    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" />
    <script
      defer
      async
      src="https://cdn.tailwindcss.com"
      onload="setConfig()"
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />

    <style>
      /* Theme Color Variables */
      :root {
        --text-color: #e0def4;
        --surface-color: #1f1d2e;
        --overlay-color: #26233a;
        --highlight-med: #403d52;
        --highlight-high: #524f67;
        --foam: #9ccfd8;
        --love: #eb6f92;
        --gold: #f6c177;
        --pine: #31748f;
        --iris: #c4a7e7;
        --muted: #6e6a86;
        --subtle: #908caa;

        /* Theme variables - Rose Pine (default) */
        --theme-base: #191724;
        --theme-surface: #1f1d2e;
        --theme-overlay: #26233a;
        --theme-muted: #6e6a86;
        --theme-subtle: #908caa;
        --theme-text: #e0def4;
        --theme-love: #eb6f92;
        --theme-gold: #f6c177;
        --theme-rose: #ebbcba;
        --theme-pine: #31748f;
        --theme-foam: #9ccfd8;
        --theme-iris: #c4a7e7;
        --theme-highlight-low: #21202e;
        --theme-highlight-med: #403d52;
        --theme-highlight-high: #524f67;
        --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
      }
      [data-theme="rose-pine"] {
        --theme-base: #191724;
        --theme-surface: #1f1d2e;
        --theme-overlay: #26233a;
        --theme-muted: #6e6a86;
        --theme-subtle: #908caa;
        --theme-text: #e0def4;
        --theme-love: #eb6f92;
        --theme-gold: #f6c177;
        --theme-rose: #ebbcba;
        --theme-pine: #31748f;
        --theme-foam: #9ccfd8;
        --theme-iris: #c4a7e7;
        --theme-highlight-low: #21202e;
        --theme-highlight-med: #403d52;
        --theme-highlight-high: #524f67;
        --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
      }
      [data-theme="dark"] {
        --theme-base: #0f172a;
        --theme-surface: #1e293b;
        --theme-overlay: #334155;
        --theme-muted: #64748b;
        --theme-subtle: #94a3b8;
        --theme-text: #f1f5f9;
        --theme-love: #ef4444;
        --theme-gold: #f59e0b;
        --theme-rose: #f97316;
        --theme-pine: #059669;
        --theme-foam: #06b6d4;
        --theme-iris: #8b5cf6;
        --theme-highlight-low: #1e293b;
        --theme-highlight-med: #475569;
        --theme-highlight-high: #64748b;
        --theme-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      }
      [data-theme="light"] {
        --theme-base: #f8fafc;
        --theme-surface: #e2e8f0;
        --theme-overlay: #cbd5e1;
        --theme-muted: #64748b;
        --theme-subtle: #475569;
        --theme-text: #0f172a;
        --theme-love: #dc2626;
        --theme-gold: #d97706;
        --theme-rose: #ea580c;
        --theme-pine: #047857;
        --theme-foam: #0891b2;
        --theme-iris: #7c3aed;
        --theme-highlight-low: #f1f5f9;
        --theme-highlight-med: #e2e8f0;
        --theme-highlight-high: #cbd5e1;
        --theme-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
      }
      [data-theme="catppuccin"] {
        --theme-base: #1e1e2e;
        --theme-surface: #313244;
        --theme-overlay: #45475a;
        --theme-muted: #6c7086;
        --theme-subtle: #9399b2;
        --theme-text: #cdd6f4;
        --theme-love: #f38ba8;
        --theme-gold: #f9e2af;
        --theme-rose: #fab387;
        --theme-pine: #a6e3a1;
        --theme-foam: #89dceb;
        --theme-iris: #cba6f7;
        --theme-highlight-low: #181825;
        --theme-highlight-med: #313244;
        --theme-highlight-high: #45475a;
        --theme-gradient: linear-gradient(135deg, #1e1e2e 0%, #313244 50%, #45475a 100%);
      }
      [data-theme="nord"] {
        --theme-base: #2e3440;
        --theme-surface: #3b4252;
        --theme-overlay: #434c5e;
        --theme-muted: #4c566a;
        --theme-subtle: #d8dee9;
        --theme-text: #eceff4;
        --theme-love: #bf616a;
        --theme-gold: #ebcb8b;
        --theme-rose: #d08770;
        --theme-pine: #a3be8c;
        --theme-foam: #88c0d0;
        --theme-iris: #b48ead;
        --theme-highlight-low: #2e3440;
        --theme-highlight-med: #434c5e;
        --theme-highlight-high: #4c566a;
        --theme-gradient: linear-gradient(135deg, #2e3440 0%, #3b4252 50%, #434c5e 100%);
      }
      [data-theme="gruvbox"] {
        --theme-base: #282828;
        --theme-surface: #3c3836;
        --theme-overlay: #504945;
        --theme-muted: #665c54;
        --theme-subtle: #a89984;
        --theme-text: #ebdbb2;
        --theme-love: #fb4934;
        --theme-gold: #fabd2f;
        --theme-rose: #fe8019;
        --theme-pine: #b8bb26;
        --theme-foam: #8ec07c;
        --theme-iris: #d3869b;
        --theme-highlight-low: #1d2021;
        --theme-highlight-med: #3c3836;
        --theme-highlight-high: #504945;
        --theme-gradient: linear-gradient(135deg, #282828 0%, #3c3836 50%, #504945 100%);
      }
      [data-theme="tokyo-night"] {
        --theme-base: #1a1b26;
        --theme-surface: #24283b;
        --theme-overlay: #414868;
        --theme-muted: #565f89;
        --theme-subtle: #a9b1d6;
        --theme-text: #c0caf5;
        --theme-love: #f7768e;
        --theme-gold: #e0af68;
        --theme-rose: #ff9e64;
        --theme-pine: #9ece6a;
        --theme-foam: #7dcfff;
        --theme-iris: #bb9af7;
        --theme-highlight-low: #16161e;
        --theme-highlight-med: #24283b;
        --theme-highlight-high: #414868;
        --theme-gradient: linear-gradient(135deg, #1a1b26 0%, #24283b 50%, #414868 100%);
      }
      [data-theme="dracula"] {
        --theme-base: #282a36;
        --theme-surface: #44475a;
        --theme-overlay: #6272a4;
        --theme-muted: #6272a4;
        --theme-subtle: #f8f8f2;
        --theme-text: #f8f8f2;
        --theme-love: #ff5555;
        --theme-gold: #f1fa8c;
        --theme-rose: #ffb86c;
        --theme-pine: #50fa7b;
        --theme-foam: #8be9fd;
        --theme-iris: #bd93f9;
        --theme-highlight-low: #21222c;
        --theme-highlight-med: #44475a;
        --theme-highlight-high: #6272a4;
        --theme-gradient: linear-gradient(135deg, #282a36 0%, #44475a 50%, #6272a4 100%);
      }
      /* Suggestion Box */
      .suggestion-box {
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        z-index: 1200;
        background: #1f1d2e;
        border-radius: 0 0 0.75rem 0.75rem;
        border: 1px solid #26233a;
        border-top: none;
        max-height: 220px;
        overflow-y: auto;
        box-shadow: 0 6px 20px 2px #000a;
        color: #e0def4;
        font-size: 1rem;
        width: 100%;
      }
      .suggestion-item {
        padding: 0.73rem 1.1rem;
        cursor: pointer;
        transition: background 0.16s;
        border-bottom: 1px solid #26233a;
      }
      .suggestion-item:last-child {
        border-bottom: none;
      }
      .suggestion-item:hover,
      .suggestion-item.active {
        background: #26233a;
        color: #9ccfd8;
      }
      /* Bookmark Grid */
      .bookmark-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }
      .bookmark-item {
        background: #1f1d2e;
        border: 1px solid #26233a;
        border-radius: 0.75rem;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .bookmark-item:hover {
        background: #26233a;
        border-color: #9ccfd8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(156, 207, 216, 0.2);
      }
      .bookmark-item.editing {
        border-color: #f6c177;
        background: #403d52;
      }
      /* Theme & background switching */
      body {
        background: var(--theme-gradient);
        background-attachment: fixed;
      }
      /* Settings Modal */
      .settings-modal {
        transition: all 0.3s ease;
      }
      .modal-content {
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal-content::-webkit-scrollbar {
        width: 8px;
      }
      .modal-content::-webkit-scrollbar-track {
        background: var(--theme-surface);
      }
      .modal-content::-webkit-scrollbar-thumb {
        background: var(--theme-foam);
        border-radius: 4px;
      }
      .modal-content::-webkit-scrollbar-thumb:hover {
        background: var(--theme-foam);
      }
      .newtab-bg-preview.active {
        border: 2px solid var(--theme-foam) !important;
      }
      .theme-preview.active {
        border: 2px solid var(--theme-foam) !important;
      }
    </style>
  </head>
  <body class="font-inter bg-gradient-to-br from-base via-surface to-overlay min-h-screen text-text">
    <div class="min-h-screen flex flex-col">
      <!-- Particles Canvas -->
      <canvas id="particles-canvas" class="fixed inset-0 pointer-events-none hidden"></canvas>

      <!-- Header -->
      <header class="p-6 text-center">
        <h1 class="text-4xl font-bold text-text mb-2 flex items-center justify-center gap-3">
          <i class="bx bx-atom text-foam"></i>
          Carbon
        </h1>
      </header>

      <!-- Main Content -->
      <main class="flex-1 max-w-6xl mx-auto w-full px-6">
        <!-- Search Section -->
        <section class="mb-12">
          <div class="max-w-2xl mx-auto">
            <form id="search-form" class="relative">
              <div class="relative">
                <i class="bx bx-search absolute left-4 top-1/2 transform -translate-y-1/2 text-muted text-xl"></i>
                <input
                  id="search-input"
                  type="text"
                  spellcheck="false"
                  autocomplete="off"
                  placeholder="Search or enter website URL"
                  class="w-full h-16 pl-12 pr-16 bg-surface border-2 border-overlay text-text rounded-full text-lg focus:outline-none focus:ring-2 focus:ring-foam focus:border-foam placeholder-muted transition-all"
                />
                <div class="absolute right-4 top-1/2 transform -translate-y-1/2 flex items-center gap-2">
                  <!-- Proxy Toggle -->
                  <button
                    id="proxy-toggle"
                    type="button"
                    class="w-10 h-10 rounded-full bg-highlight-med hover:bg-highlight-high border-2 border-foam flex items-center justify-center transition-all"
                    title="UV Proxy"
                  >
                    <i id="proxy-icon" class="bx bx-cloud text-xl"></i>
                  </button>
                  <!-- Search Engine -->
                  <button
                    id="search-engine-toggle"
                    type="button"
                    class="w-10 h-10 rounded-full bg-highlight-med hover:bg-highlight-high border-2 border-overlay flex items-center justify-center transition-all"
                    title="Search Engine"
                  >
                    <i id="search-engine-icon" class="bx bxl-brave text-xl"></i>
                  </button>
                </div>
              </div>
              <div id="suggestion-box" class="suggestion-box hidden"></div>
            </form>
          </div>
        </section>

        <!-- Bookmarks Section -->
        <section>
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-text flex items-center gap-2">
              <i class="bx bx-bookmark text-foam"></i>
              Bookmarks
            </h2>
            <div class="flex gap-2">
              <button
                id="add-bookmark-btn"
                class="px-4 py-2 bg-foam text-base rounded-lg hover:bg-foam/80 transition-colors flex items-center gap-2"
              >
                <i class="bx bx-plus"></i>
                Add Bookmark
              </button>
              <button
                id="settings-btn"
                class="px-4 py-2 bg-foam text-base rounded-lg hover:bg-foam/80 transition-colors flex items-center gap-2"
              >
                <i class="bx bx-cog"></i>
                Settings
              </button>
            </div>
          </div>
          
          <div id="bookmarks-grid" class="bookmark-grid">
            <!-- Bookmarks will be populated here -->
          </div>
        </section>
      </main>

      <!-- Footer -->
      <footer class="p-6 text-center text-muted text-sm">
        <p>Press <kbd class="bg-highlight-med px-2 py-1 rounded">Ctrl+T</kbd> for new tab</p>
      </footer>
    </div>

    <!-- Add Bookmark Modal -->
    <div id="bookmark-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-50">
      <div class="bg-surface border border-overlay rounded-xl shadow-2xl max-w-md w-[90vw] p-6">
        <h3 class="text-xl font-semibold mb-4 text-text">Add Bookmark</h3>
        <form id="bookmark-form">
          <div class="mb-4">
            <label class="block text-sm font-medium text-text mb-2">Title</label>
            <input
              id="bookmark-title"
              type="text"
              class="w-full px-3 py-2 bg-highlight-med border border-overlay rounded-lg text-text focus:outline-none focus:ring-2 focus:ring-foam"
              placeholder="Bookmark title"
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-text mb-2">URL</label>
            <input
              id="bookmark-url"
              type="url"
              class="w-full px-3 py-2 bg-highlight-med border border-overlay rounded-lg text-text focus:outline-none focus:ring-2 focus:ring-foam"
              placeholder="https://example.com"
            />
          </div>
          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-foam text-base rounded-lg hover:bg-foam/80 transition-colors"
            >
              Add
            </button>
            <button
              type="button"
              id="cancel-bookmark"
              class="flex-1 px-4 py-2 bg-highlight-med text-text rounded-lg hover:bg-highlight-high transition-colors"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-50 settings-modal">
      <div class="bg-surface border border-overlay rounded-xl shadow-2xl max-w-md w-[90vw] p-6 modal-content">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold flex items-center gap-2">
            <i class="bx bx-cog text-foam"></i>
            Settings
          </h2>
          <button id="close-settings" class="text-muted hover:text-love transition-colors">
            <i class="bx bx-x text-2xl"></i>
          </button>
        </div>

        <!-- Theme Selection -->
        <div class="mb-6">
          <h3 class="text-lg font-medium flex items-center gap-2 mb-2">
            <i class="bx bx-palette text-iris"></i>
            Theme
          </h3>
          <p class="text-muted text-sm mb-2">Customize appearance</p>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <div class="theme-preview active rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-theme="rose-pine" style="background: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);">
              <div class="text-center text-xs text-white">Rose Pine</div>
            </div>
            <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-theme="dark" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);">
              <div class="text-center text-xs text-white">Dark</div>
            </div>
            <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-theme="light" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);">
              <div class="text-center text-xs text-black">Light</div>
            </div>
            <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-theme="catppuccin" style="background: linear-gradient(135deg, #1e1e2e 0%, #313244 50%, #45475a 100%);">
              <div class="text-center text-xs text-white">Catppuccin</div>
            </div>
            <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-theme="nord" style="background: linear-gradient(135deg, #2e3440 0%, #3b4252 50%, #434c5e 100%);">
              <div class="text-center text-xs text-white">Nord</div>
            </div>
            <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-theme="gruvbox" style="background: linear-gradient(135deg, #282828 0%, #3c3836 50%, #504945 100%);">
              <div class="text-center text-xs text-white">Gruvbox</div>
            </div>
            <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-theme="tokyo-night" style="background: linear-gradient(135deg, #1a1b26 0%, #24283b 50%, #414868 100%);">
              <div class="text-center text-xs text-white">Tokyo Night</div>
            </div>
            <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-theme="dracula" style="background: linear-gradient(135deg, #282a36 0%, #44475a 50%, #6272a4 100%);">
              <div class="text-center text-xs text-white">Dracula</div>
            </div>
          </div>
        </div>

        <!-- New Tab Background -->
        <div class="mb-6">
          <h3 class="text-lg font-medium flex items-center gap-2 mb-2">
            <i class="bx bx-image text-iris"></i>
            New Tab Background
          </h3>
          <p class="text-muted text-sm mb-2">Customize the background for new tabs (overrides default background)</p>
          
          <!-- Background Type Selection -->
          <div class="mb-4">
            <label class="block text-xs font-medium text-subtle mb-2">Background Type</label>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
              <div class="newtab-bg-preview active rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-newtab-bg="theme" style="background: var(--theme-gradient);">
                <div class="text-center text-xs text-white">Theme</div>
              </div>
              <div class="newtab-bg-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-newtab-bg="image">
                <div class="text-center text-xs text-white">Image</div>
              </div>
              <div class="newtab-bg-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-newtab-bg="unsplash">
                <div class="text-center text-xs text-white">Unsplash</div>
              </div>
              <div class="newtab-bg-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-foam transition-all duration-200" data-newtab-bg="gradient">
                <div class="text-center text-xs text-white">Gradient</div>
              </div>
            </div>
          </div>

          <!-- Image URL Input -->
          <div id="newtab-image-section" class="mb-4 hidden">
            <label class="block text-xs font-medium text-subtle mb-2">Image URL</label>
            <div class="flex gap-2">
              <input type="url" id="newtab-image-url" placeholder="https://example.com/image.jpg" class="flex-1 px-3 py-2 bg-highlight-med border border-overlay text-text rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-foam">
              <button id="test-newtab-image" class="px-3 py-2 bg-gold text-base rounded-lg hover:bg-gold/80 transition-all duration-200">
                <i class="bx bx-test-tube"></i>
              </button>
            </div>
            <p class="text-xs text-muted mt-1">Enter a direct image URL (JPG, PNG, WebP)</p>
          </div>

          <!-- Unsplash Settings -->
          <div id="newtab-unsplash-section" class="mb-4 hidden">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-subtle mb-2">Category</label>
                <select id="newtab-unsplash-category" class="w-full px-3 py-2 bg-highlight-med border border-overlay text-text rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-foam">
                  <option value="nature">Nature</option>
                  <option value="city">City</option>
                  <option value="abstract">Abstract</option>
                  <option value="minimal">Minimal</option>
                  <option value="space">Space</option>
                  <option value="ocean">Ocean</option>
                  <option value="mountains">Mountains</option>
                  <option value="forest">Forest</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-subtle mb-2">Update Frequency</label>
                <select id="newtab-unsplash-frequency" class="w-full px-3 py-2 bg-highlight-med border border-overlay text-text rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-foam">
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Gradient Settings -->
          <div id="newtab-gradient-section" class="mb-4 hidden">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-subtle mb-2">Gradient Type</label>
                <select id="newtab-gradient-type" class="w-full px-3 py-2 bg-highlight-med border border-overlay text-text rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-foam">
                  <option value="linear">Linear</option>
                  <option value="radial">Radial</option>
                  <option value="conic">Conic</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-subtle mb-2">Direction</label>
                <select id="newtab-gradient-direction" class="w-full px-3 py-2 bg-highlight-med border border-overlay text-text rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-foam">
                  <option value="to right">Horizontal</option>
                  <option value="to bottom">Vertical</option>
                  <option value="to bottom right">Diagonal</option>
                  <option value="45deg">45°</option>
                  <option value="135deg">135°</option>
                </select>
              </div>
            </div>
            <div class="mt-4">
              <label class="block text-xs font-medium text-subtle mb-2">Colors</label>
              <div class="flex gap-2">
                <input type="color" id="newtab-gradient-color1" value="#667eea" class="w-12 h-10 border border-overlay rounded cursor-pointer">
                <input type="color" id="newtab-gradient-color2" value="#764ba2" class="w-12 h-10 border border-overlay rounded cursor-pointer">
                <input type="color" id="newtab-gradient-color3" value="#f093fb" class="w-12 h-10 border border-overlay rounded cursor-pointer">
                <button id="random-gradient" class="px-3 py-2 bg-iris text-white rounded-lg text-sm hover:bg-iris/80 transition-all duration-200">
                  <i class="bx bx-shuffle"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Preview -->
          <div class="mt-4">
            <label class="block text-xs font-medium text-subtle mb-2">Preview</label>
            <div id="newtab-bg-preview" class="w-full h-32 rounded-lg border border-overlay relative overflow-hidden">
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-sm font-medium text-white">New Tab Background Preview</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Save Settings -->
        <div class="text-center">
          <button id="save-settings" class="px-6 py-2 bg-foam text-base rounded-lg text-sm font-medium hover:bg-foam/80 transition-all duration-200">
            <i class="bx bx-check mr-1"></i>
            Auto-Save Enabled
          </button>
        </div>
      </div>
    </div>

    <script src="carbon-theme.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script type="module">
      import { makeURL, getProxied, setProxy, getProxy } from '/lethal.mjs';
      
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
        authDomain: "carbon-services.firebaseapp.com",
        projectId: "carbon-services",
        storageBucket: "carbon-services.firebasestorage.app",
        messagingSenderId: "288385472070",
        appId: "1:288385472070:web:c4be3ff186e248fc645c47",
        measurementId: "G-Y2K1RQYE74"
      };
      
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // State Management
      let currentSearchEngine = localStorage.getItem('search-engine') || 'https://search.brave.com/search?q=%s';
      let currentProxy = localStorage.getItem('proxy-backend') || 'uv';
      let bookmarks = JSON.parse(localStorage.getItem('carbon-bookmarks') || '[]');
      let currentUser = null;
      let currentBackground = localStorage.getItem('carbon-background-global') || 'gradient';
      let currentTheme = localStorage.getItem('carbon-theme-global') || 'rose-pine';
      let newtabBackgroundType = localStorage.getItem('carbon-newtab-bg-type') || null;
      let newtabImageUrl = localStorage.getItem('carbon-newtab-image-url') || '';
      let newtabUnsplashCategory = localStorage.getItem('carbon-newtab-unsplash-category') || 'nature';
      let newtabUnsplashFrequency = localStorage.getItem('carbon-newtab-unsplash-frequency') || 'daily';
      let newtabGradientType = localStorage.getItem('carbon-newtab-gradient-type') || 'linear';
      let newtabGradientDirection = localStorage.getItem('carbon-newtab-gradient-direction') || 'to right';
      let newtabGradientColors = JSON.parse(localStorage.getItem('carbon-newtab-gradient-colors') || '["#667eea", "#764ba2", "#f093fb"]');
      
      // DOM Elements
      const searchInput = document.getElementById('search-input');
      const searchForm = document.getElementById('search-form');
      const suggestionBox = document.getElementById('suggestion-box');
      const proxyToggle = document.getElementById('proxy-toggle');
      const proxyIcon = document.getElementById('proxy-icon');
      const searchEngineToggle = document.getElementById('search-engine-toggle');
      const searchEngineIcon = document.getElementById('search-engine-icon');
      const bookmarksGrid = document.getElementById('bookmarks-grid');
      const addBookmarkBtn = document.getElementById('add-bookmark-btn');
      const bookmarkModal = document.getElementById('bookmark-modal');
      const bookmarkForm = document.getElementById('bookmark-form');
      const cancelBookmarkBtn = document.getElementById('cancel-bookmark');
      const particlesCanvas = document.getElementById('particles-canvas');
      const settingsBtn = document.getElementById('settings-btn');
      const settingsModal = document.getElementById('settings-modal');
      const closeSettingsBtn = document.getElementById('close-settings');

      // Search Engine Configuration
      const searchEngines = {
        'https://search.brave.com/search?q=%s': ['Brave', 'bxl-brave'],
        'https://duckduckgo.com/?q=%s': ['DuckDuckGo', 'bxl-duckduckgo'],
        'https://www.google.com/search?q=%s': ['Google', 'bxl-google'],
        'https://www.bing.com/search?q=%s': ['Bing', 'bxl-microsoft'],
        'https://search.yahoo.com/search?p=%s': ['Yahoo', 'bxl-yahoo'],
      };

      // Firebase sync functions
      async function loadBookmarksFromFirebase() {
        if (!currentUser) return;
        try {
          const userDoc = await db.collection('users').doc(currentUser.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            if (userData.bookmarks) {
              bookmarks = userData.bookmarks;
              localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
              renderBookmarks();
            }
          }
        } catch (error) {
          console.error('Error loading bookmarks from Firebase:', error);
        }
      }
      
      async function saveBookmarksToFirebase() {
        if (!currentUser) return;
        try {
          await db.collection('users').doc(currentUser.uid).set({
            bookmarks: bookmarks,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        } catch (error) {
          console.error('Error saving bookmarks to Firebase:', error);
        }
      }

      async function loadSettingsFromFirebase() {
        if (!currentUser) return;
        try {
          const userSettingsDoc = await db.collection('users').doc(currentUser.uid).get();
          if (userSettingsDoc.exists) {
            const userData = userSettingsDoc.data();
            const settings = userData.settings || {};
            if (settings.background) {
              currentBackground = settings.background;
              localStorage.setItem('carbon-background-global', currentBackground);
            }
            if (settings.customBackground) {
              localStorage.setItem('carbon-custom-bg-global', settings.customBackground);
            }
            if (settings.theme) {
              currentTheme = settings.theme;
              localStorage.setItem('carbon-theme-global', currentTheme);
              document.querySelectorAll('.theme-preview').forEach(el => el.classList.remove('active', 'border-foam'));
              document.querySelector(`[data-theme="${currentTheme}"]`)?.classList.add('active', 'border-foam');
            }
            if (settings.newtabBackgroundType) {
              newtabBackgroundType = settings.newtabBackgroundType;
              newtabImageUrl = settings.newtabImageUrl || '';
              newtabUnsplashCategory = settings.newtabUnsplashCategory || 'nature';
              newtabUnsplashFrequency = settings.newtabUnsplashFrequency || 'daily';
              newtabGradientType = settings.newtabGradientType || 'linear';
              newtabGradientDirection = settings.newtabGradientDirection || 'to right';
              newtabGradientColors = settings.newtabGradientColors || ['#667eea', '#764ba2', '#f093fb'];
              loadNewtabBackgroundSettings();
            }
            applyBackground();
            applyTheme(currentTheme);
          }
        } catch (error) {
          console.error('Error loading settings from Firebase:', error);
        }
      }

      async function saveSettingsToFirebase() {
        if (!currentUser) return;
        try {
          const settings = {
            background: currentBackground,
            customBackground: localStorage.getItem('carbon-custom-bg-global') || '',
            theme: currentTheme,
            newtabBackgroundType: newtabBackgroundType,
            newtabImageUrl: newtabImageUrl,
            newtabUnsplashCategory: newtabUnsplashCategory,
            newtabUnsplashFrequency: newtabUnsplashFrequency,
            newtabGradientType: newtabGradientType,
            newtabGradientDirection: newtabGradientDirection,
            newtabGradientColors: newtabGradientColors,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          };
          await db.collection('users').doc(currentUser.uid).set({ settings }, { merge: true });
        } catch (error) {
          console.error('Error saving settings to Firebase:', error);
        }
      }

      // Authentication state observer
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        if (user) {
          loadBookmarksFromFirebase();
          loadSettingsFromFirebase();
        } else {
          loadSettings();
        }
        renderBookmarks();
        applyBackground();
      });

      // Initialize
      function loadSettings() {
        currentBackground = localStorage.getItem('carbon-background-global') || 'gradient';
        currentTheme = localStorage.getItem('carbon-theme-global') || 'rose-pine';
        newtabBackgroundType = localStorage.getItem('carbon-newtab-bg-type') || null;
        newtabImageUrl = localStorage.getItem('carbon-newtab-image-url') || '';
        newtabUnsplashCategory = localStorage.getItem('carbon-newtab-unsplash-category') || 'nature';
        newtabUnsplashFrequency = localStorage.getItem('carbon-newtab-unsplash-frequency') || 'daily';
        newtabGradientType = localStorage.getItem('carbon-newtab-gradient-type') || 'linear';
        newtabGradientDirection = localStorage.getItem('carbon-newtab-gradient-direction') || 'to right';
        newtabGradientColors = JSON.parse(localStorage.getItem('carbon-newtab-gradient-colors') || '["#667eea", "#764ba2", "#f093fb"]');
        applyTheme(currentTheme);
        loadNewtabBackgroundSettings();
        applyBackground();
      }

      function applyTheme(theme) {
        if (window.carbonTheme) {
          window.carbonTheme.applyTheme(theme);
        } else {
          document.documentElement.setAttribute('data-theme', theme);
        }
        updateNewtabBackgroundPreviews();
      }

      function loadNewtabBackgroundSettings() {
        if (!newtabBackgroundType) return;
        document.getElementById('newtab-image-url').value = newtabImageUrl;
        document.getElementById('newtab-unsplash-category').value = newtabUnsplashCategory;
        document.getElementById('newtab-unsplash-frequency').value = newtabUnsplashFrequency;
        document.getElementById('newtab-gradient-type').value = newtabGradientType;
        document.getElementById('newtab-gradient-direction').value = newtabGradientDirection;
        document.getElementById('newtab-gradient-color1').value = newtabGradientColors[0];
        document.getElementById('newtab-gradient-color2').value = newtabGradientColors[1];
        document.getElementById('newtab-gradient-color3').value = newtabGradientColors[2];
        updateNewtabBackgroundUI();
        updateNewtabBackgroundPreview();
      }

      function updateNewtabBackgroundUI() {
        if (!newtabBackgroundType) {
          document.querySelectorAll('.newtab-bg-preview').forEach(el => {
            el.classList.remove('active', 'border-foam');
          });
          document.querySelector('[data-newtab-bg="theme"]').classList.add('active', 'border-foam');
          return;
        }
        document.querySelectorAll('.newtab-bg-preview').forEach(el => {
          el.classList.remove('active', 'border-foam');
        });
        const activeElement = document.querySelector(`[data-newtab-bg="${newtabBackgroundType}"]`);
        if (activeElement) {
          activeElement.classList.add('active', 'border-foam');
        }

        document.getElementById('newtab-image-section').classList.add('hidden');
        document.getElementById('newtab-unsplash-section').classList.add('hidden');
        document.getElementById('newtab-gradient-section').classList.add('hidden');

        switch (newtabBackgroundType) {
          case 'image':
            document.getElementById('newtab-image-section').classList.remove('hidden');
            break;
          case 'unsplash':
            document.getElementById('newtab-unsplash-section').classList.remove('hidden');
            break;
          case 'gradient':
            document.getElementById('newtab-gradient-section').classList.remove('hidden');
            break;
        }
      }

      function updateNewtabBackgroundPreviews() {
        const themePreview = document.querySelector('[data-newtab-bg="theme"]');
        if (themePreview) themePreview.style.background = 'var(--theme-gradient)';
        updateNewtabBackgroundPreview();
      }

      function updateNewtabBackgroundPreview() {
        const preview = document.getElementById('newtab-bg-preview');
        if (!preview) return;

        let backgroundStyle = '';
        if (!newtabBackgroundType || newtabBackgroundType === 'theme') {
          backgroundStyle = 'var(--theme-gradient)';
        } else {
          switch (newtabBackgroundType) {
            case 'image':
              backgroundStyle = newtabImageUrl ? `url(${newtabImageUrl}) center/cover` : 'var(--theme-gradient)';
              break;
            case 'unsplash':
              backgroundStyle = `linear-gradient(135deg, #667eea 0%, #764ba2 100%)`; // Placeholder for preview
              break;
            case 'gradient':
              const gradientColors = newtabGradientColors.join(', ');
              if (newtabGradientType === 'radial') {
                backgroundStyle = `radial-gradient(circle, ${gradientColors})`;
              } else if (newtabGradientType === 'conic') {
                backgroundStyle = `conic-gradient(from 0deg, ${gradientColors})`;
              } else {
                backgroundStyle = `linear-gradient(${newtabGradientDirection}, ${gradientColors})`;
              }
              break;
            default:
              backgroundStyle = 'var(--theme-gradient)';
          }
        }
        preview.style.background = backgroundStyle;
      }

      function saveNewtabBackgroundSettings() {
        localStorage.setItem('carbon-newtab-bg-type', newtabBackgroundType || '');
        localStorage.setItem('carbon-newtab-image-url', newtabImageUrl);
        localStorage.setItem('carbon-newtab-unsplash-category', newtabUnsplashCategory);
        localStorage.setItem('carbon-newtab-unsplash-frequency', newtabUnsplashFrequency);
        localStorage.setItem('carbon-newtab-gradient-type', newtabGradientType);
        localStorage.setItem('carbon-newtab-gradient-direction', newtabGradientDirection);
        localStorage.setItem('carbon-newtab-gradient-colors', JSON.stringify(newtabGradientColors));
        saveSettingsToFirebase();
      }

      // Background Management
      async function applyBackground() {
        const body = document.body;
        const baseColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-base').trim();
        particlesCanvas.classList.add('hidden');

        // Check if new tab background settings should override
        if (newtabBackgroundType && newtabBackgroundType !== 'theme') {
          switch (newtabBackgroundType) {
            case 'image':
              if (newtabImageUrl) {
                body.style.background = `url(${newtabImageUrl}) center/cover fixed`;
              } else {
                body.style.background = 'var(--theme-gradient)';
                body.style.backgroundAttachment = 'fixed';
              }
              break;
            case 'unsplash':
              const imageUrl = await getUnsplashImage();
              if (imageUrl) {
                body.style.background = `url(${imageUrl}) center/cover fixed`;
              } else {
                body.style.background = 'var(--theme-gradient)';
                body.style.backgroundAttachment = 'fixed';
              }
              break;
            case 'gradient':
              const gradientColors = newtabGradientColors.join(', ');
              if (newtabGradientType === 'radial') {
                body.style.background = `radial-gradient(circle, ${gradientColors})`;
              } else if (newtabGradientType === 'conic') {
                body.style.background = `conic-gradient(from 0deg, ${gradientColors})`;
              } else {
                body.style.background = `linear-gradient(${newtabGradientDirection}, ${gradientColors})`;
              }
              body.style.backgroundAttachment = 'fixed';
              break;
            default:
              body.style.background = 'var(--theme-gradient)';
              body.style.backgroundAttachment = 'fixed';
          }
        } else {
          // Original background logic
          const customBg = localStorage.getItem('carbon-custom-bg-global');
          if (customBg) {
            body.style.background = `url(${customBg}) center/cover fixed`;
          } else {
            switch (currentBackground) {
              case 'solid':
                body.style.background = baseColor;
                break;
              case 'pattern':
                body.style.background = `${baseColor} url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="2" fill="%23ffffff" fill-opacity="0.2"/></svg>') repeat`;
                break;
              case 'particles':
                body.style.background = baseColor;
                particlesCanvas.classList.remove('hidden');
                initParticles();
                break;
              case 'gradient':
              default:
                body.style.background = 'var(--theme-gradient)';
                break;
            }
            body.style.backgroundAttachment = currentBackground === 'pattern' ? '' : 'fixed';
          }
        }
      }

      async function getUnsplashImage() {
        const lastFetch = localStorage.getItem('carbon-unsplash-last-fetch');
        const lastImage = localStorage.getItem('carbon-unsplash-image');
        const now = new Date();
        let shouldFetch = false;

        if (!lastFetch || !lastImage) {
          shouldFetch = true;
        } else {
          const lastFetchDate = new Date(parseInt(lastFetch));
          const diffDays = (now - lastFetchDate) / (1000 * 60 * 60 * 24);
          if (newtabUnsplashFrequency === 'daily' && diffDays >= 1) {
            shouldFetch = true;
          } else if (newtabUnsplashFrequency === 'weekly' && diffDays >= 7) {
            shouldFetch = true;
          } else if (newtabUnsplashFrequency === 'monthly' && diffDays >= 30) {
            shouldFetch = true;
          }
        }

        if (shouldFetch) {
          try {
            const response = await fetch(`https://source.unsplash.com/1920x1080/?${newtabUnsplashCategory}`);
            const imageUrl = response.url;
            localStorage.setItem('carbon-unsplash-image', imageUrl);
            localStorage.setItem('carbon-unsplash-last-fetch', Date.now().toString());
            return imageUrl;
          } catch (error) {
            console.error('Error fetching Unsplash image:', error);
            return lastImage || '';
          }
        }
        return lastImage;
      }

      function initParticles() {
        const canvas = particlesCanvas;
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const particlesArray = [];
        const particleCount = 50;

        class Particle {
          constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 3 + 1;
            this.speedX = Math.random() * 0.5 - 0.25;
            this.speedY = Math.random() * 0.5 - 0.25;
          }
          update() {
            this.x += this.speedX;
            this.y += this.speedY;
            if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
            if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
          }
          draw() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
          }
        }

        for (let i = 0; i < particleCount; i++) {
          particlesArray.push(new Particle());
        }

        function animateParticles() {
          if (currentBackground !== 'particles' || particlesCanvas.classList.contains('hidden')) return;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          particlesArray.forEach(particle => {
            particle.update();
            particle.draw();
          });
          requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', () => {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        });

        animateParticles();
      }

      function hslToHex(h, s, l) {
        l /= 100;
        const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
          const k = (n + h / 30) % 12;
          const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
          return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`;
      }

      // Listen for theme and background changes from settings page
      window.addEventListener('storage', (event) => {
        if (event.key === 'carbon-theme-global' && event.newValue) {
          currentTheme = event.newValue;
          applyTheme(event.newValue);
          applyBackground();
        }
        if (event.key === 'carbon-background-global' && event.newValue) {
          currentBackground = event.newValue;
          applyBackground();
        }
        if (event.key === 'carbon-custom-bg-global') {
          applyBackground();
        }
        if (event.key === 'carbon-newtab-bg-type' || event.key === 'carbon-newtab-image-url' || 
            event.key === 'carbon-newtab-unsplash-category' || event.key === 'carbon-newtab-unsplash-frequency' ||
            event.key === 'carbon-newtab-gradient-type' || event.key === 'carbon-newtab-gradient-direction' ||
            event.key === 'carbon-newtab-gradient-colors') {
          newtabBackgroundType = localStorage.getItem('carbon-newtab-bg-type') || null;
          newtabImageUrl = localStorage.getItem('carbon-newtab-image-url') || '';
          newtabUnsplashCategory = localStorage.getItem('carbon-newtab-unsplash-category') || 'nature';
          newtabUnsplashFrequency = localStorage.getItem('carbon-newtab-unsplash-frequency') || 'daily';
          newtabGradientType = localStorage.getItem('carbon-newtab-gradient-type') || 'linear';
          newtabGradientDirection = localStorage.getItem('carbon-newtab-gradient-direction') || 'to right';
          newtabGradientColors = JSON.parse(localStorage.getItem('carbon-newtab-gradient-colors') || '["#667eea", "#764ba2", "#f093fb"]');
          loadNewtabBackgroundSettings();
          applyBackground();
        }
      });
      
      // Listen for theme and settings broadcast messages
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'carbon-theme-change') {
          currentTheme = event.data.theme;
          applyTheme(event.data.theme);
          applyBackground();
        }
        if (event.data && event.data.type === 'carbon-settings-updated') {
          const settings = event.data.settings;
          if (settings.background) {
            currentBackground = settings.background;
            localStorage.setItem('carbon-background-global', currentBackground);
          }
          if (settings.customBackground) {
            localStorage.setItem('carbon-custom-bg-global', settings.customBackground);
          } else {
            localStorage.removeItem('carbon-custom-bg-global');
          }
          if (settings.theme) {
            currentTheme = settings.theme;
            localStorage.setItem('carbon-theme-global', currentTheme);
            applyTheme(currentTheme);
          }
          if (settings.newtabBackgroundType) {
            newtabBackgroundType = settings.newtabBackgroundType;
            newtabImageUrl = settings.newtabImageUrl || '';
            newtabUnsplashCategory = settings.newtabUnsplashCategory || 'nature';
            newtabUnsplashFrequency = settings.newtabUnsplashFrequency || 'daily';
            newtabGradientType = settings.newtabGradientType || 'linear';
            newtabGradientDirection = settings.newtabGradientDirection || 'to right';
            newtabGradientColors = settings.newtabGradientColors || ['#667eea', '#764ba2', '#f093fb'];
            loadNewtabBackgroundSettings();
          }
          applyBackground();
        }
      });

      // Listen for state changes from parent frame
      window.addEventListener("message", function(event) {
        if (event.data && event.data.type === 'carbon-proxy-sync') {
          currentProxy = event.data.proxy;
          localStorage.setItem('proxy-backend', currentProxy);
          updateProxyUI();
        } else if (event.data && event.data.type === 'carbon-search-engine-sync') {
          currentSearchEngine = event.data.searchEngine;
          localStorage.setItem('search-engine', currentSearchEngine);
          updateSearchEngineUI();
        } else if (event.data && event.data.type === 'carbon-vertical-tabs-state') {
          adjustForVerticalTabs(event.data.enabled, true);
        }
      });

      // Function to adjust layout for vertical tabs
      function adjustForVerticalTabs(verticalTabsEnabled, fromParent = false) {
        const body = document.body;
        if (verticalTabsEnabled) {
          body.classList.add('vertical-tabs-active');
        } else {
          body.classList.remove('vertical-tabs-active');
        }
        if (fromParent) {
          body.setAttribute('data-vertical-tabs-detected', 'true');
        }
      }

      // Better detection: Check if we're in an iframe and request vertical tabs state
      function requestVerticalTabsState() {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'carbon-request-vertical-tabs-state'
          }, '*');
        } else {
          const savedVerticalMode = localStorage.getItem("vertical-tabs-mode");
          adjustForVerticalTabs(savedVerticalMode === "true");
        }
      }

      // Listen for resize events as fallback
      window.addEventListener('resize', () => {
        if (!document.body.hasAttribute('data-vertical-tabs-detected')) {
          const isNarrow = window.innerWidth < 1200;
          adjustForVerticalTabs(isNarrow);
        }
      });
      setTimeout(requestVerticalTabsState, 100);
      setTimeout(requestVerticalTabsState, 500);

      // Proxy Toggle
      function updateProxyUI() {
        if (currentProxy === 'scram') {
          proxyToggle.classList.remove('border-foam');
          proxyToggle.classList.add('border-gold', 'bg-gold/20');
          proxyIcon.className = 'bx bx-network-chart text-xl';
          proxyToggle.title = 'Scramjet Proxy';
        } else {
          proxyToggle.classList.remove('border-gold', 'bg-gold/20');
          proxyToggle.classList.add('border-foam');
          proxyIcon.className = 'bx bx-cloud text-xl';
          proxyToggle.title = 'UV Proxy';
        }
      }

      proxyToggle.addEventListener('click', async () => {
        currentProxy = currentProxy === 'uv' ? 'scram' : 'uv';
        localStorage.setItem('proxy-backend', currentProxy);
        await setProxy(currentProxy);
        updateProxyUI();
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'carbon-proxy-sync',
            proxy: currentProxy
          }, '*');
        }
      });

      // Search Engine Toggle
      function updateSearchEngineUI() {
        const [name, icon] = searchEngines[currentSearchEngine] || ['Brave', 'bxl-brave'];
        searchEngineIcon.className = `bx ${icon} text-xl`;
        searchEngineToggle.title = name;
      }

      searchEngineToggle.addEventListener('click', () => {
        const engines = Object.keys(searchEngines);
        const currentIndex = engines.indexOf(currentSearchEngine);
        const nextIndex = (currentIndex + 1) % engines.length;
        currentSearchEngine = engines[nextIndex];
        localStorage.setItem('search-engine', currentSearchEngine);
        updateSearchEngineUI();
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'carbon-search-engine-sync',
            searchEngine: currentSearchEngine
          }, '*');
        }
      });

      // Search Suggestions
      let suggestionActive = -1;
      let currentSuggestions = [];
      let suggestionFetchController = null;

      searchInput.addEventListener('input', async function(e) {
        const val = searchInput.value.trim();
        if (!val || val.startsWith('http')) {
          suggestionBox.classList.add('hidden');
          suggestionBox.innerHTML = '';
          currentSuggestions = [];
          suggestionActive = -1;
          return;
        }
        const apiUrl = `https://corsproxy.io/?url=${encodeURIComponent(`https://duckduckgo.com/ac/?q=${encodeURIComponent(val)}&type=list`)}`;
        if (suggestionFetchController) suggestionFetchController.abort();
        suggestionFetchController = new AbortController();
        try {
          const resp = await fetch(apiUrl, {
            signal: suggestionFetchController.signal,
          });
          if (!resp.ok) throw new Error();
          const data = await resp.json();
          let suggestionsData;
          if (data.contents) {
            if (typeof data.contents === 'string') {
              suggestionsData = JSON.parse(data.contents);
            } else {
              suggestionsData = data.contents;
            }
          } else {
            suggestionsData = data;
          }
          currentSuggestions = (suggestionsData[1] || []).filter(Boolean);
          if (currentSuggestions.length === 0) {
            suggestionBox.classList.add('hidden');
            suggestionBox.innerHTML = '';
            suggestionActive = -1;
            return;
          }
          suggestionBox.innerHTML = currentSuggestions
            .map(
              (s, i) =>
                `<div class="suggestion-item${i === suggestionActive ? ' active' : ''}" data-idx="${i}">${s.replace(/</g, '<')}</div>`
            )
            .join('');
          suggestionBox.classList.remove('hidden');
          suggestionActive = -1;
        } catch (err) {
          suggestionBox.classList.add('hidden');
          suggestionBox.innerHTML = '';
          currentSuggestions = [];
          suggestionActive = -1;
        }
      });

      searchInput.addEventListener('keydown', function(e) {
        if (!currentSuggestions.length || suggestionBox.classList.contains('hidden')) return;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          suggestionActive = (suggestionActive + 1) % currentSuggestions.length;
          updateSuggestionBoxActive();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          suggestionActive = (suggestionActive - 1 + currentSuggestions.length) % currentSuggestions.length;
          updateSuggestionBoxActive();
        } else if (e.key === 'Enter') {
          if (suggestionActive !== -1) {
            e.preventDefault();
            selectSuggestion(suggestionActive);
          }
          suggestionBox.classList.add('hidden');
        } else if (e.key === 'Escape') {
          suggestionBox.classList.add('hidden');
          suggestionActive = -1;
        }
      });

      function updateSuggestionBoxActive() {
        Array.from(suggestionBox.children).forEach((el, i) => {
          if (i === suggestionActive) el.classList.add('active');
          else el.classList.remove('active');
        });
        if (suggestionActive !== -1) {
          const el = suggestionBox.children[suggestionActive];
          if (el) el.scrollIntoView({ block: 'nearest' });
          searchInput.value = currentSuggestions[suggestionActive];
        }
      }

      function selectSuggestion(idx) {
        if (idx < 0 || idx >= currentSuggestions.length) return;
        searchInput.value = currentSuggestions[idx];
        suggestionBox.classList.add('hidden');
        suggestionActive = -1;
      }

      suggestionBox.addEventListener('mousedown', function(e) {
        const target = e.target.closest('.suggestion-item');
        if (target) {
          const idx = parseInt(target.dataset.idx);
          selectSuggestion(idx);
          setTimeout(() => {
            searchForm.dispatchEvent(new Event('submit'));
          }, 0);
        }
      });

      // Search Form Submit
      searchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        suggestionBox.classList.add('hidden');
        suggestionActive = -1;
        const query = searchInput.value.trim();
        if (!query) return;
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'carbon-navigate',
            url: query
          }, '*');
        } else {
          const url = makeURL(query, currentSearchEngine);
          const proxiedUrl = await getProxied(url);
          window.location.href = proxiedUrl;
        }
      });

      // Bookmarks Management
      function renderBookmarks() {
        if (bookmarks.length === 0) {
          bookmarksGrid.innerHTML = `
            <div class="col-span-full text-center text-muted py-8">
              <i class="bx bx-bookmark text-4xl mb-2"></i>
              <p>No bookmarks yet. Click "Add Bookmark" to get started!</p>
            </div>
          `;
          return;
        }
        bookmarksGrid.innerHTML = bookmarks.map((bookmark, index) => `
          <div class="bookmark-item" data-index="${index}">
            <div class="flex items-start justify-between mb-3">
              <div class="w-8 h-8 rounded-lg bg-foam/20 flex items-center justify-center flex-shrink-0">
                <i class="bx bx-bookmark text-foam"></i>
              </div>
              <div class="flex gap-1">
                <button class="edit-bookmark w-6 h-6 rounded hover:bg-highlight-med flex items-center justify-center text-muted hover:text-text transition-colors">
                  <i class="bx bx-edit text-xs"></i>
                </button>
                <button class="delete-bookmark w-6 h-6 rounded hover:bg-love/20 flex items-center justify-center text-muted hover:text-love transition-colors">
                  <i class="bx bx-trash text-xs"></i>
                </button>
              </div>
            </div>
            <h3 class="font-semibold text-text mb-1 truncate">${bookmark.title}</h3>
            <p class="text-sm text-muted truncate">${bookmark.url}</p>
          </div>
        `).join('');
        bookmarksGrid.querySelectorAll('.bookmark-item').forEach(item => {
          const index = parseInt(item.dataset.index);
          const bookmark = bookmarks[index];
          item.addEventListener('click', async (e) => {
            if (e.target.closest('.edit-bookmark') || e.target.closest('.delete-bookmark')) return;
            if (window.parent && window.parent !== window) {
              window.parent.postMessage({
                type: 'carbon-navigate',
                url: bookmark.url
              }, '*');
            } else {
              const url = makeURL(bookmark.url, currentSearchEngine);
              const proxiedUrl = await getProxied(url);
              window.location.href = proxiedUrl;
            }
          });
          item.querySelector('.edit-bookmark').addEventListener('click', (e) => {
            e.stopPropagation();
            editBookmark(index);
          });
          item.querySelector('.delete-bookmark').addEventListener('click', (e) => {
            e.stopPropagation();
            deleteBookmark(index);
          });
        });
      }

      async function addBookmark(title, url) {
        bookmarks.push({ title, url });
        localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
        await saveBookmarksToFirebase();
        renderBookmarks();
      }

      async function editBookmark(index) {
        const bookmark = bookmarks[index];
        const newTitle = prompt('Edit bookmark title:', bookmark.title);
        const newUrl = prompt('Edit bookmark URL:', bookmark.url);
        if (newTitle !== null && newUrl !== null) {
          bookmarks[index] = { title: newTitle || bookmark.title, url: newUrl || bookmark.url };
          localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
          await saveBookmarksToFirebase();
          renderBookmarks();
        }
      }

      async function deleteBookmark(index) {
        if (confirm('Delete this bookmark?')) {
          bookmarks.splice(index, 1);
          localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
          await saveBookmarksToFirebase();
          renderBookmarks();
        }
      }

      // Modal Management
      addBookmarkBtn.addEventListener('click', () => {
        bookmarkModal.classList.remove('opacity-0', 'pointer-events-none');
        bookmarkModal.classList.add('opacity-100', 'pointer-events-auto');
        document.getElementById('bookmark-title').focus();
      });

      cancelBookmarkBtn.addEventListener('click', () => {
        bookmarkModal.classList.add('opacity-0', 'pointer-events-none');
        bookmarkModal.classList.remove('opacity-100', 'pointer-events-auto');
        bookmarkForm.reset();
      });

      bookmarkForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const title = document.getElementById('bookmark-title').value.trim();
        const url = document.getElementById('bookmark-url').value.trim();
        if (title && url) {
          addBookmark(title, url);
          bookmarkModal.classList.add('opacity-0', 'pointer-events-none');
          bookmarkModal.classList.remove('opacity-100', 'pointer-events-auto');
          bookmarkForm.reset();
        }
      });

      // Settings Modal Management
      settingsBtn.addEventListener('click', () => {
        settingsModal.classList.remove('opacity-0', 'pointer-events-none');
        settingsModal.classList.add('opacity-100', 'pointer-events-auto');
      });

      closeSettingsBtn.addEventListener('click', () => {
        settingsModal.classList.add('opacity-0', 'pointer-events-none');
        settingsModal.classList.remove('opacity-100', 'pointer-events-auto');
      });

      // New Tab Background Event Listeners
      document.addEventListener('click', e => {
        if (e.target.closest('.newtab-bg-preview')) {
          const preview = e.target.closest('.newtab-bg-preview');
          const bgType = ['theme', 'image', 'unsplash', 'gradient'].includes(preview.dataset.newtabBg) ? preview.dataset.newtabBg : null;
          if (bgType) {
            newtabBackgroundType = bgType;
            document.querySelectorAll('.newtab-bg-preview').forEach(el => {
              el.classList.remove('active', 'border-foam');
            });
            preview.classList.add('active', 'border-foam');
            updateNewtabBackgroundUI();
            updateNewtabBackgroundPreview();
            saveNewtabBackgroundSettings();
            applyBackground();
          }
        }
        if (e.target.closest('.theme-preview')) {
          const preview = e.target.closest('.theme-preview');
          const theme = preview.dataset.theme;
          document.querySelectorAll('.theme-preview').forEach(el => el.classList.remove('active', 'border-foam'));
          preview.classList.add('active', 'border-foam');
          currentTheme = theme;
          localStorage.setItem('carbon-theme-global', currentTheme);
          applyTheme(currentTheme);
          saveSettingsToFirebase();
        }
      });

      document.getElementById('newtab-image-url').addEventListener('input', function() {
        newtabImageUrl = this.value;
        updateNewtabBackgroundPreview();
        saveNewtabBackgroundSettings();
        applyBackground();
      });

      document.getElementById('test-newtab-image').addEventListener('click', function() {
        const url = document.getElementById('newtab-image-url').value;
        if (url) {
          const preview = document.getElementById('newtab-bg-preview');
          preview.style.background = `url(${url}) center/cover`;
          setTimeout(() => {
            updateNewtabBackgroundPreview();
          }, 2000);
        }
      });

      document.getElementById('newtab-unsplash-category').addEventListener('change', function() {
        newtabUnsplashCategory = this.value;
        saveNewtabBackgroundSettings();
        applyBackground();
      });

      document.getElementById('newtab-unsplash-frequency').addEventListener('change', function() {
        newtabUnsplashFrequency = this.value;
        saveNewtabBackgroundSettings();
        applyBackground();
      });

      document.getElementById('newtab-gradient-type').addEventListener('change', function() {
        newtabGradientType = this.value;
        updateNewtabBackgroundPreview();
        saveNewtabBackgroundSettings();
        applyBackground();
      });

      document.getElementById('newtab-gradient-direction').addEventListener('change', function() {
        newtabGradientDirection = this.value;
        updateNewtabBackgroundPreview();
        saveNewtabBackgroundSettings();
        applyBackground();
      });

      document.getElementById('newtab-gradient-color1').addEventListener('input', function() {
        newtabGradientColors[0] = this.value;
        updateNewtabBackgroundPreview();
        saveNewtabBackgroundSettings();
        applyBackground();
      });

      document.getElementById('newtab-gradient-color2').addEventListener('input', function() {
        newtabGradientColors[1] = this.value;
        updateNewtabBackgroundPreview();
        saveNewtabBackgroundSettings();
        applyBackground();
      });

      document.getElementById('newtab-gradient-color3').addEventListener('input', function() {
        newtabGradientColors[2] = this.value;
        updateNewtabBackgroundPreview();
        saveNewtabBackgroundSettings();
        applyBackground();
      });

      document.getElementById('random-gradient').addEventListener('click', function() {
        const randomHues = [];
        const baseHue = Math.random() * 360;
        for (let i = 0; i < 3; i++) {
          randomHues.push((baseHue + (i * 120)) % 360);
        }
        newtabGradientColors = [
          hslToHex(randomHues[0], 70, 60),
          hslToHex(randomHues[1], 70, 60),
          hslTo
