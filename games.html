<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CARBON - Games</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'rp-base': '#191724',
            'rp-surface': '#1f1d2e',
            'rp-overlay': '#26233a',
            'rp-muted': '#6e6a86',
            'rp-text': '#e0def4',
            'rp-rose': '#ebbcba',
            'rp-pine': '#31748f',
            'rp-foam': '#9ccfd8',
            'rp-love': '#eb6f92',
            'rp-gold': '#f6c177'
          },
          fontFamily: {
            'inter': ['Inter', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .glass {
      backdrop-filter: blur(10px);
      background: rgba(26, 35, 58, 0.3);
    }
  </style>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
      authDomain: "carbon-services.firebaseapp.com",
      projectId: "carbon-services",
      storageBucket: "carbon-services.appspot.com",
      messagingSenderId: "288385472070",
      appId: "1:288385472070:web:c4be3ff186e248fc645c47",
      measurementId: "G-Y2K1RQYE74"
    };

    window.firebaseApp = initializeApp(firebaseConfig);
    window.db = getFirestore(window.firebaseApp);
    window.auth = getAuth(window.firebaseApp);
  </script>
</head>
<body class="bg-rp-base text-rp-text min-h-screen font-inter">

  <!-- Navigation -->
  <nav class="fixed top-0 w-full z-50 glass border-b border-rp-overlay/50">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="text-2xl font-semibold text-rp-rose">CARBON</div>
        
        <div class="hidden md:flex items-center space-x-6">
          <div id="pinnedGame" class="hidden flex items-center space-x-2 px-3 py-2 bg-rp-surface rounded-lg border border-rp-overlay">
            <i class='bx bx-pin text-rp-pine text-sm'></i>
            <span class="text-sm" id="pinnedGameTitle">No game pinned</span>
            <button onclick="unpinGame()" class="text-rp-muted hover:text-rp-love transition-colors">
              <i class='bx bx-x text-sm'></i>
            </button>
          </div>
          
          <div id="authContainer">
            <button id="signInBtn" onclick="signInUser()" class="px-4 py-2 bg-rp-rose text-rp-base rounded-lg hover:bg-rp-rose/90 transition-colors font-medium">
              Sign In
            </button>
            <div id="userProfile" class="hidden flex items-center space-x-3">
              <img id="userAvatar" src="" alt="User" class="w-8 h-8 rounded-full border border-rp-overlay">
              <span id="userName" class="text-sm"></span>
              <button onclick="signOutUser()" class="text-rp-muted hover:text-rp-love transition-colors">
                <i class='bx bx-log-out'></i>
              </button>
            </div>
          </div>
        </div>

        <button class="md:hidden p-2" onclick="toggleMobileMenu()">
          <i class='bx bx-menu text-xl text-rp-rose'></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div id="mobileMenu" class="hidden fixed inset-0 z-40 md:hidden">
    <div class="bg-rp-base/95 backdrop-blur-sm h-full pt-20 px-6">
      <div id="mobileAuthContainer" class="space-y-4">
        <!-- Mobile auth content will be populated by JS -->
      </div>
    </div>
  </div>

  <main class="pt-24 pb-16">
    <div class="max-w-7xl mx-auto px-6">
      
      <!-- Header -->
      <div class="text-center mb-12 fade-in">
        <h1 class="text-4xl md:text-5xl font-light text-rp-text mb-3">
          Game <span class="text-rp-rose font-medium">Collection</span>
        </h1>
        <p class="text-rp-muted text-lg max-w-2xl mx-auto">
          Discover and play amazing games instantly in your browser
        </p>
      </div>

      <!-- Search Bar -->
      <div class="max-w-2xl mx-auto mb-12 fade-in">
        <div class="relative">
          <input 
            type="text" 
            id="searchInput" 
            placeholder="Search games..." 
            class="w-full px-6 py-4 pl-12 bg-rp-surface border border-rp-overlay rounded-xl text-rp-text placeholder-rp-muted focus:outline-none focus:border-rp-pine transition-colors"
            oninput="handleSearchInput()" 
            onkeydown="handleSearchKeydown(event)" 
            onfocus="showAutocomplete()" 
            onblur="hideAutocomplete()"
          >
          <i class='bx bx-search absolute left-4 top-1/2 -translate-y-1/2 text-rp-muted'></i>
          <button 
            onclick="playRandomGame()" 
            class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-2 bg-rp-pine text-rp-text rounded-lg hover:bg-rp-pine/80 transition-colors text-sm font-medium"
          >
            <i class='bx bx-shuffle mr-1'></i>Random
          </button>
          
          <!-- Autocomplete Dropdown -->
          <div id="autocompleteDropdown" class="hidden absolute top-full left-0 right-0 mt-2 bg-rp-surface border border-rp-overlay rounded-xl overflow-hidden z-50">
            <div id="autocompleteResults" class="max-h-60 overflow-y-auto"></div>
          </div>
        </div>
      </div>

      <!-- Categories -->
      <div class="mb-12 fade-in">
        <div class="flex flex-wrap justify-center gap-2" id="categoryButtons">
          <button class="category-btn active px-4 py-2 rounded-lg bg-rp-rose text-rp-base font-medium transition-colors" onclick="filterGames('all', event)">
            All Games
          </button>
        </div>
      </div>

      <!-- Continue Playing Section -->
      <div id="continuePlayingSection" class="hidden mb-12 fade-in">
        <h2 class="text-xl font-medium text-rp-rose mb-4">Continue Playing</h2>
        <div id="continuePlayingCard" class="bg-rp-surface border border-rp-overlay rounded-xl p-6 hover:border-rp-pine transition-colors cursor-pointer"></div>
      </div>

      <!-- Game of the Day -->
      <div class="mb-12 fade-in">
        <h2 class="text-xl font-medium text-rp-gold mb-4 flex items-center">
          <i class='bx bx-star mr-2'></i>
          Game of the Day
        </h2>
        <div id="gameOfTheDayCard" class="bg-rp-surface border border-rp-gold/30 rounded-xl p-6 hover:border-rp-gold/50 transition-colors"></div>
      </div>

      <!-- Daily Picks -->
      <div class="mb-12 fade-in">
        <h2 class="text-xl font-medium text-rp-foam mb-4 flex items-center">
          <i class='bx bx-heart mr-2'></i>
          Daily Picks
        </h2>
        <div id="dailyPicksGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
      </div>

      <!-- Featured Games -->
      <div class="mb-12 fade-in">
        <h2 class="text-xl font-medium text-rp-pine mb-6">Featured Games</h2>
        <div class="relative">
          <div class="overflow-hidden rounded-xl">
            <div id="featuredCarousel" class="flex transition-transform duration-500 ease-out"></div>
          </div>
          <button onclick="previousSlide()" class="absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-rp-base/80 hover:bg-rp-base text-rp-text rounded-full flex items-center justify-center transition-colors">
            <i class='bx bx-chevron-left'></i>
          </button>
          <button onclick="nextSlide()" class="absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-rp-base/80 hover:bg-rp-base text-rp-text rounded-full flex items-center justify-center transition-colors">
            <i class='bx bx-chevron-right'></i>
          </button>
        </div>
      </div>

      <!-- All Games -->
      <div class="fade-in">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-medium text-rp-text">All Games</h2>
          <div class="text-rp-muted text-sm" id="gameCount">Loading...</div>
        </div>
        
        <div id="gamesGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
          <!-- Loading skeleton -->
          <div class="bg-rp-surface rounded-xl aspect-[4/3] animate-pulse"></div>
          <div class="bg-rp-surface rounded-xl aspect-[4/3] animate-pulse"></div>
          <div class="bg-rp-surface rounded-xl aspect-[4/3] animate-pulse"></div>
          <div class="bg-rp-surface rounded-xl aspect-[4/3] animate-pulse"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Categories Footer -->
  <footer class="border-t border-rp-overlay py-8">
    <div class="max-w-7xl mx-auto px-6">
      <h3 class="text-lg font-medium text-rp-muted mb-4">Browse by Category</h3>
      <div class="relative">
        <div id="categoriesCarousel" class="flex space-x-3 overflow-x-auto no-scrollbar pb-2"></div>
      </div>
    </div>
  </footer>

  <script type="module">
    import { doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, onSnapshot, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // Global variables
    let gamesData = [];
    let currentSlide = 0;
    let filteredGames = [];
    let currentFilter = 'all';
    let pinnedGameData = null;
    let allCategories = [];
    let categoryCounts = {};
    let currentUser = null;
    let autocompleteData = [];
    let autocompleteIndex = -1;
    let gameOfTheDay = null;
    let dailyPicks = [];
    let userProgress = {};

    // Fetch games from Firestore
    async function fetchGames() {
      try {
        const gamesQuery = query(collection(window.db, 'games'), orderBy('title'));
        const querySnapshot = await getDocs(gamesQuery);
        const games = [];
        querySnapshot.forEach((docSnap) => {
          const game = { ...docSnap.data(), id: docSnap.id };
          games.push(game);
        });
        return games;
      } catch (error) {
        console.error('Failed to fetch games:', error);
        throw error;
      }
    }

    // Initialize games
    async function initializeGames() {
      try {
        document.getElementById('gamesGrid').innerHTML = `<div class="col-span-full text-center text-rp-muted py-10">Loading games...</div>`;
        gamesData = await fetchGames();
        filteredGames = [...gamesData];
        
        // Process categories
        let catSet = new Set();
        let counts = {};
        gamesData.forEach(game => {
          if (game.category) {
            catSet.add(game.category);
            counts[game.category] = (counts[game.category] || 0) + 1;
          }
        });
        allCategories = Array.from(catSet).sort();
        categoryCounts = counts;
        
        renderCategoryButtons();
        renderGamesGrid();
        updateGameCount();
        renderCategoriesCarousel();
        renderFeaturedCarousel();
      } catch (error) {
        document.getElementById('gamesGrid').innerHTML = `<div class="col-span-full text-center text-rp-love py-10">Failed to load games.</div>`;
      }
    }

    // Authentication setup
    async function setupAuth() {
      onAuthStateChanged(window.auth, async (user) => {
        if (user) {
          currentUser = user;
          document.getElementById('signInBtn').classList.add('hidden');
          document.getElementById('userProfile').classList.remove('hidden');
          document.getElementById('userName').textContent = user.isAnonymous ? 'Guest' : user.displayName || 'User';
          document.getElementById('userAvatar').src = user.photoURL || 'https://via.placeholder.com/32x32/ebbcba/191724?text=U';
          await loadUserProgress();
          await loadPinnedGames();
        } else {
          currentUser = null;
          document.getElementById('signInBtn').classList.remove('hidden');
          document.getElementById('userProfile').classList.add('hidden');
        }
      });
    }

    // Sign in/out functions
    window.signInUser = async () => {
      try {
        await signInAnonymously(window.auth);
      } catch (error) {
        console.error('Sign in failed:', error);
      }
    };

    window.signOutUser = async () => {
      try {
        await window.auth.signOut();
      } catch (error) {
        console.error('Sign out failed:', error);
      }
    };

    // Search and autocomplete
    function setupAutocomplete() {
      autocompleteData = gamesData.map(game => ({
        title: game.title,
        id: game.id,
        category: game.category,
        description: game.description
      }));
    }

    window.handleSearchInput = () => {
      const input = document.getElementById('searchInput');
      const query = input.value.toLowerCase().trim();
      
      if (query.length > 0) {
        const matches = autocompleteData.filter(game => 
          game.title.toLowerCase().includes(query) ||
          game.category.toLowerCase().includes(query) ||
          game.description.toLowerCase().includes(query)
        ).slice(0, 6);
        showAutocompleteResults(matches, query);
      } else {
        hideAutocomplete();
      }
      searchGames();
    };

    function showAutocompleteResults(matches, query) {
      const dropdown = document.getElementById('autocompleteDropdown');
      const results = document.getElementById('autocompleteResults');
      
      if (matches.length === 0) {
        hideAutocomplete();
        return;
      }

      results.innerHTML = matches.map((game, index) => `
        <div class="autocomplete-item p-3 hover:bg-rp-overlay cursor-pointer transition-colors ${index === autocompleteIndex ? 'bg-rp-overlay' : ''}" 
             onclick="selectAutocompleteItem('${game.title.replace(/'/g, "\\'")}')"
             data-index="${index}">
          <div class="flex items-center space-x-3">
            <i class='bx bx-game text-rp-pine'></i>
            <div>
              <div class="font-medium text-rp-text">${highlightText(game.title, query)}</div>
              <div class="text-sm text-rp-muted">${game.category}</div>
            </div>
          </div>
        </div>
      `).join('');
      
      dropdown.classList.remove('hidden');
    }

    function highlightText(text, query) {
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<span class="text-rp-rose">$1</span>');
    }

    window.handleSearchKeydown = (event) => {
      const dropdown = document.getElementById('autocompleteDropdown');
      const items = dropdown.querySelectorAll('.autocomplete-item');
      
      if (dropdown.classList.contains('hidden')) return;

      switch (event.key) {
        case 'ArrowDown':
          event.preventDefault();
          autocompleteIndex = (autocompleteIndex + 1) % items.length;
          updateAutocompleteHighlight();
          break;
        case 'ArrowUp':
          event.preventDefault();
          autocompleteIndex = (autocompleteIndex - 1 + items.length) % items.length;
          updateAutocompleteHighlight();
          break;
        case 'Enter':
          event.preventDefault();
          if (autocompleteIndex >= 0 && items[autocompleteIndex]) {
            const title = items[autocompleteIndex].querySelector('.font-medium').textContent;
            selectAutocompleteItem(title);
          }
          break;
        case 'Escape':
          hideAutocomplete();
          break;
      }
    };

    function updateAutocompleteHighlight() {
      const items = document.querySelectorAll('.autocomplete-item');
      items.forEach((item, index) => {
        if (index === autocompleteIndex) {
          item.classList.add('bg-rp-overlay');
        } else {
          item.classList.remove('bg-rp-overlay');
        }
      });
    }

    window.selectAutocompleteItem = (title) => {
      document.getElementById('searchInput').value = title;
      hideAutocomplete();
      searchGames();
    };

    window.showAutocomplete = () => {
      const input = document.getElementById('searchInput');
      if (input.value.trim().length > 0) {
        handleSearchInput();
      }
    };

    window.hideAutocomplete = () => {
      setTimeout(() => {
        document.getElementById('autocompleteDropdown').classList.add('hidden');
        autocompleteIndex = -1;
      }, 200);
    };

    // Daily content generation
    async function generateDailyContent() {
      const today = new Date().toDateString();
      try {
        const dailyDoc = await getDoc(doc(window.db, 'daily-content', today));
        if (dailyDoc.exists()) {
          const data = dailyDoc.data();
          gameOfTheDay = data.gameOfTheDay;
          dailyPicks = data.dailyPicks;
        } else {
          gameOfTheDay = gamesData[Math.floor(Math.random() * gamesData.length)];
          dailyPicks = getRandomGames(4);
          await setDoc(doc(window.db, 'daily-content', today), {
            gameOfTheDay,
            dailyPicks,
            date: today
          });
        }
        renderGameOfTheDay();
        renderDailyPicks();
      } catch (error) {
        gameOfTheDay = gamesData[Math.floor(Math.random() * gamesData.length)];
        dailyPicks = getRandomGames(4);
        renderGameOfTheDay();
        renderDailyPicks();
      }
    }

    function getRandomGames(count) {
      const shuffled = [...gamesData].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    }

    function renderGameOfTheDay() {
      const card = document.getElementById('gameOfTheDayCard');
      if (!gameOfTheDay) return;

      card.innerHTML = `
        <div class="flex items-center space-x-6">
          <img src="${gameOfTheDay.image}" alt="${gameOfTheDay.title}" class="w-20 h-20 rounded-lg object-cover">
          <div class="flex-1">
            <h3 class="text-lg font-medium text-rp-text mb-2">${gameOfTheDay.title}</h3>
            <p class="text-rp-muted mb-4 text-sm">${gameOfTheDay.description}</p>
            <div class="flex space-x-3">
              <a href="play.html?id=${gameOfTheDay.id}" class="px-4 py-2 bg-rp-gold text-rp-base rounded-lg hover:bg-rp-gold/90 transition-colors font-medium text-sm">
                Play Now
              </a>
              <button onclick="pinGame('${gameOfTheDay.id}')" class="px-3 py-2 bg-rp-overlay text-rp-text rounded-lg hover:bg-rp-overlay/80 transition-colors">
                <i class='bx bx-pin'></i>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderDailyPicks() {
      const grid = document.getElementById('dailyPicksGrid');
      grid.innerHTML = dailyPicks.map(game => `
        <div class="bg-rp-surface border border-rp-overlay rounded-lg overflow-hidden hover:border-rp-foam/50 transition-colors cursor-pointer group" onclick="window.location.href='play.html?id=${game.id}';">
          <img src="${game.image}" alt="${game.title}" class="w-full h-24 object-cover group-hover:scale-105 transition-transform duration-300">
          <div class="p-3">
            <h4 class="font-medium text-rp-text text-sm mb-1">${game.title}</h4>
            <p class="text-rp-muted text-xs">${game.category}</p>
          </div>
        </div>
      `).join('');
    }

    // User progress
    async function loadUserProgress() {
      if (!currentUser) return;
      try {
        const progressDoc = await getDoc(doc(window.db, 'user-progress', currentUser.uid));
        if (progressDoc.exists()) {
          userProgress = progressDoc.data();
          renderContinuePlaying();
        }
      } catch (error) {
        console.error('Failed to load user progress:', error);
      }
    }

    function renderContinuePlaying() {
      const section = document.getElementById('continuePlayingSection');
      const card = document.getElementById('continuePlayingCard');
      
      if (!userProgress.lastPlayed) {
        section.classList.add('hidden');
        return;
      }

      const lastGame = gamesData.find(g => g.id === userProgress.lastPlayed.gameId);
      if (!lastGame) {
        section.classList.add('hidden');
        return;
      }

      section.classList.remove('hidden');
      card.innerHTML = `
        <div class="flex items-center space-x-4">
          <img src="${lastGame.image}" alt="${lastGame.title}" class="w-16 h-16 rounded-lg object-cover">
          <div class="flex-1">
            <h3 class="font-medium text-rp-text mb-1">${lastGame.title}</h3>
            <p class="text-rp-muted text-sm mb-2">Last played ${new Date(userProgress.lastPlayed.timestamp).toLocaleDateString()}</p>
            <div class="w-full bg-rp-overlay rounded-full h-1.5 mb-3">
              <div class="bg-rp-pine h-1.5 rounded-full" style="width: ${userProgress.lastPlayed.progress || 0}%"></div>
            </div>
            <a href="play.html?id=${lastGame.id}" class="inline-block px-4 py-2 bg-rp-pine text-rp-text rounded-lg hover:bg-rp-pine/80 transition-colors font-medium text-sm">
              Continue
            </a>
          </div>
        </div>
      `;
    }

    // Random game function
    window.playRandomGame = () => {
      const randomGame = gamesData[Math.floor(Math.random() * gamesData.length)];
      window.location.href = `play.html?id=${randomGame.id}`;
    };

    // Pinned games
    async function loadPinnedGames() {
      if (!currentUser) return;
      try {
        const pinnedDoc = await getDoc(doc(window.db, 'user-pins', currentUser.uid));
        if (pinnedDoc.exists()) {
          const pinnedGameId = pinnedDoc.data().gameId;
          if (pinnedGameId) {
            const game = gamesData.find(g => g.id === pinnedGameId);
            if (game) {
              pinnedGameData = game;
              document.getElementById('pinnedGame').classList.remove('hidden');
              document.getElementById('pinnedGameTitle').textContent = game.title;
            }
          }
        }
      } catch (error) {
        console.error('Failed to load pinned games:', error);
      }
    }

    window.pinGame = async (gameId) => {
      const game = gamesData.find(g => g.id === gameId);
      if (!game || !currentUser) return;
      
      try {
        await setDoc(doc(window.db, 'user-pins', currentUser.uid), {
          gameId: gameId,
          timestamp: Date.now()
        });
        pinnedGameData = game;
        document.getElementById('pinnedGame').classList.remove('hidden');
        document.getElementById('pinnedGameTitle').textContent = game.title;
      } catch (error) {
        console.error('Failed to pin game:', error);
      }
    };

    window.unpinGame = async () => {
      if (!currentUser) return;
      try {
        await setDoc(doc(window.db, 'user-pins', currentUser.uid), {
          gameId: null,
          timestamp: Date.now()
        });
        pinnedGameData = null;
        document.getElementById('pinnedGame').classList.add('hidden');
      } catch (error) {
        console.error('Failed to unpin game:', error);
      }
    };

    // Games grid rendering
    function renderGamesGrid() {
      const grid = document.getElementById('gamesGrid');
      
      if (filteredGames.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center text-rp-muted py-10">No games found.</div>';
        return;
      }

      grid.innerHTML = filteredGames.map(game => `
        <div class="game-card bg-rp-surface border border-rp-overlay rounded-lg overflow-hidden hover:border-rp-rose/50 transition-all duration-300 group cursor-pointer" 
             data-category="${game.category}" data-title="${game.title.toLowerCase()}"
             onclick="window.location.href='play.html?id=${game.id}';">
          <div class="relative aspect-[4/3] overflow-hidden">
            <img src="${game.image}" alt="${game.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
            <div class="absolute top-2 right-2">
              <button onclick="event.stopPropagation(); pinGame('${game.id}')" class="w-8 h-8 bg-rp-base/80 hover:bg-rp-base text-rp-text rounded-full flex items-center justify-center transition-colors">
                <i class='bx bx-pin text-sm'></i>
              </button>
            </div>
            ${gameOfTheDay && gameOfTheDay.id === game.id ? '<div class="absolute top-2 left-2 px-2 py-1 bg-rp-gold text-rp-base rounded text-xs font-medium">GOTD</div>' : ''}
          </div>
          <div class="p-3">
            <h3 class="font-medium text-rp-text mb-1 text-sm">${game.title}</h3>
            <p class="text-rp-muted text-xs">${game.category}</p>
          </div>
        </div>
      `).join('');
    }

    // Category buttons
    function renderCategoryButtons() {
      const btns = document.getElementById('categoryButtons');
      btns.innerHTML = `
        <button class="category-btn active px-4 py-2 rounded-lg bg-rp-rose text-rp-base font-medium transition-colors" onclick="filterGames('all', event)">
          All Games
        </button>
        ${allCategories.map(cat => `
          <button class="category-btn px-4 py-2 rounded-lg bg-rp-surface border border-rp-overlay text-rp-text hover:border-rp-rose transition-colors"
            onclick="filterGames('${cat}', event)">
            ${cat.charAt(0).toUpperCase() + cat.slice(1)} 
            <span class="text-rp-muted text-sm">(${categoryCounts[cat]})</span>
          </button>
        `).join('')}
      `;
    }

    // Featured carousel
    function renderFeaturedCarousel() {
      const carousel = document.getElementById('featuredCarousel');
      const featuredGames = gamesData.filter(game => game.featured);
      
      if (featuredGames.length === 0) {
        carousel.innerHTML = '<div class="w-full h-64 bg-rp-surface rounded-xl flex items-center justify-center text-rp-muted">No featured games available</div>';
        return;
      }

      carousel.innerHTML = featuredGames.map(game => `
        <div class="flex-shrink-0 w-full">
          <div class="bg-rp-surface border border-rp-overlay rounded-xl overflow-hidden">
            <div class="aspect-video relative">
              <img src="${game.image}" alt="${game.title}" class="w-full h-full object-cover">
              <div class="absolute inset-0 bg-gradient-to-t from-rp-base/80 to-transparent"></div>
              <div class="absolute bottom-6 left-6 right-6">
                <h3 class="text-xl font-medium mb-2 text-rp-text">${game.title}</h3>
                <p class="text-rp-muted mb-4">${game.description}</p>
                <div class="flex space-x-3">
                  <a href="play.html?id=${game.id}" class="px-6 py-2 bg-rp-rose text-rp-base rounded-lg hover:bg-rp-rose/90 transition-colors font-medium">
                    Play Now
                  </a>
                  <button onclick="pinGame('${game.id}')" class="px-4 py-2 bg-rp-overlay text-rp-text rounded-lg hover:bg-rp-overlay/80 transition-colors">
                    <i class='bx bx-pin mr-1'></i>Pin
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
      
      updateCarousel();
    }

    // Carousel controls
    function nextSlide() {
      const featuredGames = gamesData.filter(game => game.featured);
      if (featuredGames.length === 0) return;
      currentSlide = (currentSlide + 1) % featuredGames.length;
      updateCarousel();
    }

    function previousSlide() {
      const featuredGames = gamesData.filter(game => game.featured);
      if (featuredGames.length === 0) return;
      currentSlide = (currentSlide - 1 + featuredGames.length) % featuredGames.length;
      updateCarousel();
    }

    function updateCarousel() {
      const carousel = document.getElementById('featuredCarousel');
      carousel.style.transform = `translateX(-${currentSlide * 100}%)`;
    }

    // Search functionality
    function searchGames() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      filteredGames = gamesData.filter(game => {
        const matchesSearch = game.title.toLowerCase().includes(searchTerm) ||
                              game.description.toLowerCase().includes(searchTerm) ||
                              (game.tags && game.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
        const matchesCategory = currentFilter === 'all' || game.category === currentFilter;
        return matchesSearch && matchesCategory;
      });
      renderGamesGrid();
      updateGameCount();
    }

    // Filter games
    window.filterGames = (category, event) => {
      currentFilter = category;
      
      // Update active states
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('bg-rp-rose', 'text-rp-base');
        btn.classList.add('bg-rp-surface', 'border', 'border-rp-overlay', 'text-rp-text');
      });
      
      if (event && event.target) {
        event.target.classList.add('active');
        event.target.classList.remove('bg-rp-surface', 'border', 'border-rp-overlay', 'text-rp-text');
        event.target.classList.add('bg-rp-rose', 'text-rp-base');
      }

      document.getElementById('searchInput').value = '';
      filteredGames = gamesData.filter(game => category === 'all' || game.category === category);
      renderGamesGrid();
      updateGameCount();
    };

    // Update game count
    function updateGameCount() {
      document.getElementById('gameCount').textContent = `${filteredGames.length} games`;
    }

    // Categories carousel
    function renderCategoriesCarousel() {
      const carousel = document.getElementById('categoriesCarousel');
      carousel.innerHTML = allCategories.map(cat => `
        <button class="flex-shrink-0 px-4 py-2 bg-rp-surface border border-rp-overlay rounded-lg text-rp-text hover:border-rp-pine transition-colors text-sm"
          onclick="filterGames('${cat}', event)">
          ${cat.charAt(0).toUpperCase() + cat.slice(1)}
          <span class="ml-2 text-rp-muted">(${categoryCounts[cat]})</span>
        </button>
      `).join('');
    }

    // Mobile menu toggle
    window.toggleMobileMenu = () => {
      const menu = document.getElementById('mobileMenu');
      menu.classList.toggle('hidden');
    };

    // Global functions
    window.nextSlide = nextSlide;
    window.previousSlide = previousSlide;

    // Initialize everything
    document.addEventListener('DOMContentLoaded', async () => {
      await setupAuth();
      await initializeGames();
      await generateDailyContent();
      
      // Auto-advance carousel
      setInterval(nextSlide, 6000);
    });

    // Navbar scroll effect
    document.addEventListener('scroll', function() {
      const navbar = document.querySelector('nav');
      if (window.scrollY > 50) {
        navbar.style.backgroundColor = 'rgba(31, 29, 46, 0.95)';
      } else {
        navbar.style.backgroundColor = 'rgba(26, 35, 58, 0.3)';
      }
    });
  </script>
</body>
</html>