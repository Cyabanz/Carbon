<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Play Game - CARBON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- XSS Protection Headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://www.gstatic.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; media-src 'self' blob: https:; connect-src 'self' https:; frame-src 'self' https:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <script defer async>
    function setConfig() {
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              display: ["Switzer", "Helvetica", "sans-serif"],
              inter: ["Inter", "sans-serif"],
            },
            colors: {
              'rp-base': '#191724',
              'rp-surface': '#1f1d2e',
              'rp-overlay': '#26233a',
              'rp-muted': '#6e6a86',
              'rp-subtle': '#908caa',
              'rp-text': '#e0def4',
              'rp-love': '#eb6f92',
              'rp-gold': '#f6c177',
              'rp-rose': '#ebbcba',
              'rp-pine': '#31748f',
              'rp-foam': '#9ccfd8',
              'rp-iris': '#c4a7e7',
              'rp-highlight-low': '#21202e',
              'rp-highlight-med': '#403d52',
              'rp-highlight-high': '#524f67'
            }
          }
        }
      };
    }
  </script>
  <script src="https://cdn.tailwindcss.com" onload="setConfig()"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
  <script src="carbon-theme.js"></script>
  <style>
    .loader {
      border: 8px solid #16213e;
      border-top: 8px solid #06b6d4;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .tag-btn.active {
      background: #22d3ee22;
      color: #06b6d4 !important;
      border-color: #06b6d4 !important;
    }
    /* Comment section styles */
    .comment-item {
      transition: all 0.3s ease;
    }
    .comment-item:hover {
      background: rgba(6, 182, 212, 0.05);
    }
    .reply-item {
      border-left: 2px solid #06b6d4;
      margin-left: 1rem;
      padding-left: 1rem;
    }
    .reaction-picker {
      position: absolute;
      z-index: 1000;
      background: var(--theme-overlay);
      border: 1px solid #06b6d4;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .reaction-button {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 16px;
      font-size: 12px;
      background: rgba(6, 182, 212, 0.1);
      color: #06b6d4;
      border: 1px solid rgba(6, 182, 212, 0.3);
      transition: all 0.2s ease;
    }
    .reaction-button:hover {
      background: rgba(6, 182, 212, 0.2);
      transform: scale(1.05);
    }
    .reaction-button.reacted {
      background: rgba(6, 182, 212, 0.3);
      color: #22d3ee;
    }
    .comment-stars {
      color: #fbbf24;
    }
    .comment-textarea {
      background: rgba(24, 27, 42, 0.8);
      border: 1px solid rgba(6, 182, 212, 0.3);
      color: var(--theme-text);
      border-radius: 8px;
      padding: 12px;
      resize: vertical;
      min-height: 80px;
    }
    .comment-textarea:focus {
      outline: none;
      border-color: #06b6d4;
      box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
    }
    emoji-picker {
      --background: var(--theme-overlay);
      --border-color: #06b6d4;
      --button-active-background: rgba(6, 182, 212, 0.2);
      --button-hover-background: rgba(6, 182, 212, 0.1);
      --indicator-color: #06b6d4;
      --input-border-color: rgba(6, 182, 212, 0.3);
      --input-font-color: var(--theme-text);
      --input-background: rgba(24, 27, 42, 0.8);
      --outline-color: #06b6d4;
    }
    
    /* New Game Frame Features */
    .play-stats {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: #06b6d4;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      z-index: 100;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(6, 182, 212, 0.3);
    }
    
    .pause-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      backdrop-filter: blur(10px);
    }
    
    .pause-overlay.hidden {
      display: none;
    }
    
    .pause-content {
      text-align: center;
      color: var(--theme-text);
    }
    
    .pause-title {
      font-size: 2.5rem;
      font-weight: 900;
      color: #06b6d4;
      margin-bottom: 1rem;
      text-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
    }
    
    .pause-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    .pause-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
      font-size: 1rem;
    }
    
    .pause-btn.primary {
      background: linear-gradient(135deg, #06b6d4, #3b82f6);
      color: var(--theme-base);
    }
    
    .pause-btn.primary:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(6, 182, 212, 0.4);
    }
    
    .pause-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--theme-text);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .pause-btn.secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .inactivity-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 150;
      backdrop-filter: blur(5px);
      transition: opacity 0.5s ease;
    }
    
    .inactivity-overlay.hidden {
      display: none;
    }
    
    .inactivity-content {
      text-align: center;
      color: var(--theme-text);
      animation: pulse 2s infinite;
    }
    
    .inactivity-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #06b6d4;
      margin-bottom: 0.5rem;
    }
    
    .game-frame-blurred {
      filter: blur(3px);
      transition: filter 0.5s ease;
    }
    
    .keyboard-shortcuts {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: #06b6d4;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 10px;
      z-index: 100;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(6, 182, 212, 0.3);
      opacity: 0.7;
      transition: opacity 0.3s ease;
    }
    
    .keyboard-shortcuts:hover {
      opacity: 1;
    }
    
    .rate-limit-warning {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 8px;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    /* Theme & Background Styles */
    :root {
      --theme-base: #191724;
      --theme-surface: #1f1d2e;
      --theme-overlay: #26233a;
      --theme-muted: #6e6a86;
      --theme-subtle: #908caa;
      --theme-text: #e0def4;
      --theme-love: #eb6f92;
      --theme-gold: #f6c177;
      --theme-rose: #ebbcba;
      --theme-pine: #31748f;
      --theme-foam: #9ccfd8;
      --theme-iris: #c4a7e7;
      --theme-highlight-low: #21202e;
      --theme-highlight-med: #403d52;
      --theme-highlight-high: #524f67;
      --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
    }
    [data-theme="rose-pine"] {
      --theme-base: #191724;
      --theme-surface: #1f1d2e;
      --theme-overlay: #26233a;
      --theme-muted: #6e6a86;
      --theme-subtle: #908caa;
      --theme-text: #e0def4;
      --theme-love: #eb6f92;
      --theme-gold: #f6c177;
      --theme-rose: #ebbcba;
      --theme-pine: #31748f;
      --theme-foam: #9ccfd8;
      --theme-iris: #c4a7e7;
      --theme-highlight-low: #21202e;
      --theme-highlight-med: #403d52;
      --theme-highlight-high: #524f67;
      --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
    }
    [data-theme="dark"] {
      --theme-base: #0f172a;
      --theme-surface: #1e293b;
      --theme-overlay: #334155;
      --theme-muted: #64748b;
      --theme-subtle: #94a3b8;
      --theme-text: #f1f5f9;
      --theme-love: #ef4444;
      --theme-gold: #f59e0b;
      --theme-rose: #f97316;
      --theme-pine: #059669;
      --theme-foam: #06b6d4;
      --theme-iris: #8b5cf6;
      --theme-highlight-low: #1e293b;
      --theme-highlight-med: #475569;
      --theme-highlight-high: #64748b;
      --theme-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
    }
    [data-theme="light"] {
      --theme-base: #f8fafc;
      --theme-surface: #e2e8f0;
      --theme-overlay: #cbd5e1;
      --theme-muted: #64748b;
      --theme-subtle: #475569;
      --theme-text: #0f172a;
      --theme-love: #dc2626;
      --theme-gold: #d97706;
      --theme-rose: #ea580c;
      --theme-pine: #047857;
      --theme-foam: #0891b2;
      --theme-iris: #7c3aed;
      --theme-highlight-low: #f1f5f9;
      --theme-highlight-med: #e2e8f0;
      --theme-highlight-high: #cbd5e1;
      --theme-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
    }
    [data-theme="catppuccin"] {
      --theme-base: #1e1e2e;
      --theme-surface: #313244;
      --theme-overlay: #45475a;
      --theme-muted: #6c7086;
      --theme-subtle: #9399b2;
      --theme-text: #cdd6f4;
      --theme-love: #f38ba8;
      --theme-gold: #f9e2af;
      --theme-rose: #fab387;
      --theme-pine: #a6e3a1;
      --theme-foam: #89dceb;
      --theme-iris: #cba6f7;
      --theme-highlight-low: #181825;
      --theme-highlight-med: #313244;
      --theme-highlight-high: #45475a;
      --theme-gradient: linear-gradient(135deg, #1e1e2e 0%, #313244 50%, #45475a 100%);
    }
    [data-theme="nord"] {
      --theme-base: #2e3440;
      --theme-surface: #3b4252;
      --theme-overlay: #434c5e;
      --theme-muted: #4c566a;
      --theme-subtle: #d8dee9;
      --theme-text: #eceff4;
      --theme-love: #bf616a;
      --theme-gold: #ebcb8b;
      --theme-rose: #d08770;
      --theme-pine: #a3be8c;
      --theme-foam: #88c0d0;
      --theme-iris: #b48ead;
      --theme-highlight-low: #2e3440;
      --theme-highlight-med: #434c5e;
      --theme-highlight-high: #4c566a;
      --theme-gradient: linear-gradient(135deg, #2e3440 0%, #3b4252 50%, #434c5e 100%);
    }
    [data-theme="gruvbox"] {
      --theme-base: #282828;
      --theme-surface: #3c3836;
      --theme-overlay: #504945;
      --theme-muted: #665c54;
      --theme-subtle: #a89984;
      --theme-text: #ebdbb2;
      --theme-love: #fb4934;
      --theme-gold: #fabd2f;
      --theme-rose: #fe8019;
      --theme-pine: #b8bb26;
      --theme-foam: #8ec07c;
      --theme-iris: #d3869b;
      --theme-highlight-low: #1d2021;
      --theme-highlight-med: #3c3836;
      --theme-highlight-high: #504945;
      --theme-gradient: linear-gradient(135deg, #282828 0%, #3c3836 50%, #504945 100%);
    }
    [data-theme="tokyo-night"] {
      --theme-base: #1a1b26;
      --theme-surface: #24283b;
      --theme-overlay: #414868;
      --theme-muted: #565f89;
      --theme-subtle: #a9b1d6;
      --theme-text: #c0caf5;
      --theme-love: #f7768e;
      --theme-gold: #e0af68;
      --theme-rose: #ff9e64;
      --theme-pine: #9ece6a;
      --theme-foam: #7dcfff;
      --theme-iris: #bb9af7;
      --theme-highlight-low: #16161e;
      --theme-highlight-med: #24283b;
      --theme-highlight-high: #414868;
      --theme-gradient: linear-gradient(135deg, #1a1b26 0%, #24283b 50%, #414868 100%);
    }
    [data-theme="dracula"] {
      --theme-base: #282a36;
      --theme-surface: #44475a;
      --theme-overlay: #6272a4;
      --theme-muted: #6272a4;
      --theme-subtle: #f8f8f2;
      --theme-text: #f8f8f2;
      --theme-love: #ff5555;
      --theme-gold: #f1fa8c;
      --theme-rose: #ffb86c;
      --theme-pine: #50fa7b;
      --theme-foam: #8be9fd;
      --theme-iris: #bd93f9;
      --theme-highlight-low: #21222c;
      --theme-highlight-med: #44475a;
      --theme-highlight-high: #6272a4;
      --theme-gradient: linear-gradient(135deg, #282a36 0%, #44475a 50%, #6272a4 100%);
    }
    body {
      background: var(--theme-gradient);
      background-attachment: fixed;
    }
  </style>
</head>
<body class="bg-rp-base min-h-screen text-rp-text font-inter">
  <!-- Particles Canvas -->
  <canvas id="particles-canvas" class="fixed inset-0 pointer-events-none hidden"></canvas>

  <!-- Preloader -->
  <div id="preloader" class="fixed z-[9999] inset-0 flex flex-col justify-center items-center bg-rp-base">
    <div class="loader"></div>
  </div>

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-8 py-4 bg-rp-surface/80 border-b border-rp-overlay backdrop-blur-md fixed top-0 left-0 right-0 z-50">
    <a href="index.html" class="text-2xl font-extrabold text-rp-foam tracking-tighter">CARBON</a>
    <div class="flex items-center gap-4">
      <div id="userSection"></div>
    </div>
  </nav>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen w-full bg-rp-base fixed left-0 top-0 z-50">
    <div class="bg-rp-surface rounded-2xl shadow-2xl p-12 border border-rp-overlay flex flex-col items-center">
      <div class="text-3xl font-bold text-rp-foam mb-6">Sign In to Play</div>
      <button onclick="googleSignIn()" class="flex items-center gap-3 bg-rp-foam hover:bg-rp-foam/90 text-rp-base font-bold px-6 py-3 rounded-lg text-lg transition">
        <i class='bx bxl-google text-2xl'></i> Sign in with Google
      </button>
      <div id="loginError" class="text-rp-love mt-6 hidden"></div>
    </div>
  </div>

  <main class="pt-28 max-w-4xl mx-auto px-4">
    <div id="gameInfoHolder" class="rounded-2xl shadow-2xl bg-rp-surface border border-rp-overlay overflow-hidden mt-2">
      <!-- Game "cover" with play button -->
      <div class="relative aspect-video bg-black flex items-center justify-center">
        <img id="gameCoverImg" src="" class="w-full h-full object-cover pointer-events-none select-none rounded-t-2xl" alt="Game Cover" />
        <button id="bigPlayBtn" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 bg-gradient-to-br from-rp-foam to-rp-iris text-rp-base font-extrabold rounded-lg px-6 py-3 shadow-lg text-lg hover:scale-105 transition-all flex items-center gap-3 group min-w-[120px]">
          <i class='bx bx-play-circle text-2xl drop-shadow-lg group-hover:scale-110 transition-transform'></i>
          <span class="block text-base font-bold">Play</span>
        </button>
        <div class="absolute bottom-4 left-4 flex gap-3">
          <span id="gameCategoryTag" class="bg-rp-foam/30 text-rp-foam px-3 py-1 rounded text-xs font-semibold"></span>
          <span id="gameFeaturedTag" class="bg-rp-iris/30 text-rp-iris px-3 py-1 rounded text-xs font-semibold hidden">Featured</span>
        </div>
      </div>
      <div class="flex flex-col md:flex-row p-6 gap-6 items-start bg-rp-overlay">
        <div class="flex-1">
          <div id="gameTitleDisplay" class="text-2xl md:text-3xl font-extrabold text-rp-foam mb-3"></div>
          <div id="starRatingSection" class="my-4">
            <div id="starsContainer" class="flex gap-1 text-3xl"></div>
            <div class="text-sm mt-1 flex flex-wrap items-center gap-2 text-rp-subtle">
              <span id="starRatingSummary"></span>
              <span id="starRatingCount"></span>
              <span id="starRatingError" class="text-rp-love"></span>
            </div>
            <div id="ratingPercentContainer" class="flex items-center mt-2 gap-2">
              <span id="ratingPercentText" class="text-rp-iris font-semibold"></span>
              <div class="w-40 h-2 bg-rp-muted rounded overflow-hidden">
                <div id="ratingPercentBar" class="h-2 bg-rp-iris rounded transition-all duration-300" style="width:0%"></div>
              </div>
            </div>
          </div>
          <p id="gameFrameDesc" class="text-rp-text/80 mb-2 text-base leading-relaxed"></p>
          <!-- Game info (dev/release/etc) with tailwind -->
          <div id="gameInfoBox" class="mt-6 w-full">
            <div class="bg-rp-surface border border-rp-overlay rounded-2xl px-6 py-5 text-rp-text">
              <table class="w-full text-left">
                <tbody id="gameInfoTable"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="flex flex-col gap-2 w-full md:w-auto">
          <button id="fullscreenBtn" class="bg-gradient-to-r from-rp-foam to-rp-iris text-rp-base font-bold px-6 py-2 rounded-lg hover:scale-105 transition-transform">Fullscreen</button>
          <a href="profile.html" class="bg-rp-text/10 text-rp-text px-6 py-2 rounded-lg hover:bg-rp-foam/20 transition text-center">View Profile</a>
        </div>
      </div>
    </div>
    <!-- Real iframe, shown after play -->
    <div id="gameFrameContainer" class="rounded-2xl shadow-2xl bg-[#181b2a] border border-cyan-600/30 overflow-hidden mt-8 hidden">
      <div class="relative aspect-video bg-black">
        <iframe id="gameFrameEmbed" src="" class="w-full h-full" frameborder="0" allowfullscreen allow="fullscreen"></iframe>
        
        <!-- Play Stats Display -->
        <div id="playStats" class="play-stats">
          <div class="flex flex-col gap-1">
            <div class="flex items-center gap-2">
              <i class='bx bx-play-circle text-sm'></i>
              <span id="playCount">0 plays</span>
            </div>
            <div class="flex items-center gap-2">
              <i class='bx bx-time text-sm'></i>
              <span id="playTimer">00:00</span>
            </div>
          </div>
        </div>
        
        <!-- Keyboard Shortcuts Display -->
        <div id="keyboardShortcuts" class="keyboard-shortcuts">
          <div class="text-xs">
            <div><strong>P</strong> Play/Pause</div>
            <div><strong>R</strong> Restart</div>
            <div><strong>F</strong> Fullscreen</div>
            <div><strong>M</strong> Mute</div>
          </div>
        </div>
        
        <!-- Pause Overlay -->
        <div id="pauseOverlay" class="pause-overlay hidden">
          <div class="pause-content">
            <div class="pause-title">⏸️ PAUSED</div>
            <p class="text-cyan-200 mb-2">Game is currently paused</p>
            <p class="text-sm text-cyan-300/70">Press P or Spacebar to resume</p>
            <div class="pause-buttons">
              <button id="resumeBtn" class="pause-btn primary">
                <i class='bx bx-play mr-2'></i>
                Resume Game
              </button>
              <button id="restartBtn" class="pause-btn secondary">
                <i class='bx bx-refresh mr-2'></i>
                Restart
              </button>
              <button id="exitGameBtn" class="pause-btn secondary">
                <i class='bx bx-exit mr-2'></i>
                Exit Game
              </button>
            </div>
          </div>
        </div>
        
        <!-- Inactivity Overlay -->
        <div id="inactivityOverlay" class="inactivity-overlay hidden">
          <div class="inactivity-content">
            <div class="inactivity-title">🌫️ Inactive</div>
            <p class="text-cyan-200">Click or press any key to continue</p>
            <div class="mt-4 text-xs text-cyan-300/70">
              <i class='bx bx-mouse text-lg animate-bounce'></i>
            </div>
          </div>
        </div>
        
        <div class="absolute top-4 right-4 flex gap-2 z-10">
          <button id="likeBtn" class="w-10 h-10 bg-white/10 hover:bg-cyan-500/80 text-white rounded-full flex items-center justify-center transition" title="Like">
            <i class='bx bx-like text-xl'></i>
          </button>
          <button id="favBtn" class="w-10 h-10 bg-white/10 hover:bg-pink-500/80 text-white rounded-full flex items-center justify-center transition" title="Favorite">
            <i class='bx bx-heart text-xl'></i>
          </button>
          <button id="dislikeBtn" class="w-10 h-10 bg-white/10 hover:bg-red-500/80 text-white rounded-full flex items-center justify-center transition" title="Dislike">
            <i class='bx bx-dislike text-xl'></i>
          </button>
          <button id="proxyToggleBtn" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center transition border-2 border-cyan-400" title="Toggle Proxy">
            <i id="proxyToggleIcon" class="bx bx-cloud text-xl"></i>
          </button>
          <button id="shareBtn" class="w-10 h-10 bg-white/10 hover:bg-indigo-500/80 text-white rounded-full flex items-center justify-center transition" title="Share">
            <i class='bx bx-share-alt text-xl'></i>
          </button>
          <button id="playlistBtn" class="w-10 h-10 bg-white/10 hover:bg-yellow-400/80 text-white rounded-full flex items-center justify-center transition" title="Add to Playlist">
            <i class='bx bx-list-plus text-xl'></i>
          </button>
        </div>
      </div>
      <div class="flex flex-col md:flex-row p-6 gap-6 items-start bg-[#232445]">
        <div class="flex-1">
          <div id="gameTitleDisplayFrame" class="text-2xl md:text-3xl font-extrabold text-cyan-400 mb-3"></div>
          <div id="starRatingSectionFrame" class="max-w-xl my-4">
            <div id="starsContainerFrame" class="flex gap-1 text-3xl"></div>
            <div class="text-sm mt-1 flex flex-wrap items-center gap-2 text-cyan-200">
              <span id="starRatingSummaryFrame"></span>
              <span id="starRatingCountFrame"></span>
              <span id="starRatingErrorFrame" class="text-pink-400"></span>
            </div>
            <div id="ratingPercentContainerFrame" class="flex items-center mt-2 gap-2">
              <span id="ratingPercentTextFrame" class="text-indigo-400 font-semibold"></span>
              <div class="w-40 h-2 bg-slate-700 rounded overflow-hidden">
                <div id="ratingPercentBarFrame" class="h-2 bg-indigo-400 rounded transition-all duration-300" style="width:0%"></div>
              </div>
            </div>
            <!-- Tag area -->
            <div id="tagsAreaFrame" class="mt-5 flex flex-wrap gap-2"></div>
            <!-- Category count -->
            <div id="categoryGamesCountFrame" class="mt-4 text-cyan-300 text-base font-semibold"></div>
          </div>
        </div>
        <div class="flex flex-col gap-2 w-full md:w-auto">
          <button id="fullscreenBtnBottom" class="bg-gradient-to-r from-cyan-400 to-indigo-500 text-black font-bold px-6 py-2 rounded-lg hover:scale-105 transition-transform">Fullscreen</button>
          <a href="profile.html" class="bg-white/10 text-white px-6 py-2 rounded-lg hover:bg-cyan-400/20 transition text-center">View Profile</a>
        </div>
      </div>
      <!-- Game info in frame panel -->
      <div id="gameInfoBoxFrame" class="mt-6 w-full">
        <div class="bg-[#181b2a] border border-cyan-600/30 rounded-2xl px-6 py-5 text-white mx-6 mb-8">
          <table class="w-full text-left">
            <tbody id="gameInfoTableFrame"></tbody>
          </table>
        </div>
      </div>

      <!-- Comments Section -->
      <div id="commentsSection" class="mt-8 mx-6 mb-8">
        <div class="bg-[#181b2a] border border-cyan-600/30 rounded-2xl px-6 py-6 text-white">
          <!-- Comments Header -->
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-cyan-400 flex items-center gap-2">
              <i class='bx bx-message-square-dots text-3xl'></i>
              Reviews & Comments
              <span id="commentsCount" class="text-lg text-cyan-300 font-normal">
                (0)
              </span>
            </h3>
            
            <!-- Filter Dropdown -->
            <div class="relative">
              <select id="commentFilter" class="bg-[#232445] border border-cyan-600/30 text-white px-4 py-2 rounded-lg text-sm focus:outline-none focus:border-cyan-400">
                <option value="all">All Comments</option>
                <option value="5">⭐⭐⭐⭐⭐ (5 stars)</option>
                <option value="4">⭐⭐⭐⭐ (4 stars)</option>
                <option value="3">⭐⭐⭐ (3 stars)</option>
                <option value="2">⭐⭐ (2 stars)</option>
                <option value="1">⭐ (1 star)</option>
                <option value="no-rating">No Rating</option>
              </select>
            </div>
          </div>

          <!-- Add Comment Form -->
          <div id="addCommentForm" class="mb-6 p-4 bg-[#232445] rounded-lg border border-cyan-600/20">
            <h4 class="text-lg font-semibold text-cyan-400 mb-3">Write a Review</h4>
            
            <!-- Star Rating Input -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-cyan-300 mb-2">Your Rating (Optional)</label>
              <div id="commentStarInput" class="flex gap-1 text-2xl mb-2">
                <!-- Stars will be rendered here -->
              </div>
              <p class="text-xs text-cyan-200/70">Click stars to rate this game</p>
            </div>

            <!-- Comment Text -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-cyan-300 mb-2">Your Comment</label>
              <textarea 
                id="commentText" 
                placeholder="Share your thoughts about this game..."
                class="comment-textarea w-full"
                maxlength="1000"
              ></textarea>
              <div class="flex justify-between text-xs text-cyan-200/70 mt-1">
                <span>Be respectful and constructive</span>
                <span id="commentCharCount">0/1000</span>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="flex gap-3">
              <button 
                id="submitComment" 
                class="bg-gradient-to-r from-cyan-400 to-indigo-500 text-black font-bold px-6 py-2 rounded-lg hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                <i class='bx bx-send mr-2'></i>
                Post Review
              </button>
              <button 
                id="cancelComment" 
                class="bg-white/10 text-white px-6 py-2 rounded-lg hover:bg-red-500/20 transition"
              >
                Cancel
              </button>
            </div>
            
            <!-- Rate Limit Warning -->
            <div id="rateLimitWarning" class="rate-limit-warning hidden">
              <i class='bx bx-error-circle mr-2'></i>
              <span id="rateLimitText">Please wait before posting another comment</span>
            </div>
          </div>

          <!-- Comments List -->
          <div id="commentsList" class="space-y-4">
            <!-- Comments will be rendered here -->
            <div id="commentsLoader" class="text-center py-8 hidden">
              <div class="inline-block w-6 h-6 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
              <p class="text-cyan-300 mt-2">Loading comments...</p>
            </div>
            <div id="noComments" class="text-center py-8 text-cyan-300/70">
              <i class='bx bx-message-square text-4xl mb-2 block'></i>
              <p>No comments yet. Be the first to share your thoughts!</p>
            </div>
          </div>

          <!-- Load More Button -->
          <div id="loadMoreComments" class="text-center mt-6 hidden">
            <button class="bg-white/10 text-cyan-300 px-6 py-2 rounded-lg hover:bg-cyan-500/20 transition">
              Load More Comments
            </button>
          </div>
        </div>
      </div>

      <!-- Reply Modal -->
      <div id="replyModal" class="hidden fixed inset-0 z-[10001] bg-black/70 flex items-center justify-center">
        <div class="bg-[#232445] rounded-xl p-6 max-w-lg w-full mx-4 shadow-2xl border border-cyan-400/20 relative">
          <button onclick="closeReplyModal()" class="absolute top-3 right-4 text-white/70 hover:text-pink-400 text-xl">
            <i class='bx bx-x'></i>
          </button>
          <h3 class="text-xl font-bold mb-4 text-cyan-400">Reply to Comment</h3>
          
          <div id="replyToComment" class="mb-4 p-3 bg-[#181b2a] rounded-lg border border-cyan-600/20">
            <!-- Original comment will be shown here -->
          </div>
          
          <textarea 
            id="replyText" 
            placeholder="Write your reply..."
            class="comment-textarea w-full mb-4"
            maxlength="500"
          ></textarea>
          <div class="text-xs text-cyan-200/70 mb-4 text-right">
            <span id="replyCharCount">0/500</span>
          </div>
          
          <div class="flex gap-3">
            <button 
              id="submitReply" 
              class="bg-gradient-to-r from-cyan-400 to-indigo-500 text-black font-bold px-4 py-2 rounded-lg hover:scale-105 transition-transform disabled:opacity-50"
              disabled
            >
              Post Reply
            </button>
            <button 
              onclick="closeReplyModal()" 
              class="bg-white/10 text-white px-4 py-2 rounded-lg hover:bg-red-500/20 transition"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Reaction Picker (will be positioned dynamically) -->
      <div id="reactionPicker" class="hidden reaction-picker">
        <emoji-picker></emoji-picker>
      </div>

      <div id="tagGamesListModal" class="hidden fixed inset-0 z-[10000] bg-black/70 flex items-center justify-center">
        <div class="bg-[#232445] rounded-xl p-8 max-w-lg w-full shadow-2xl border border-cyan-400/20 relative">
          <button onclick="closeTagGamesModal()" class="absolute top-3 right-4 text-white/70 hover:text-pink-400 text-xl"><i class='bx bx-x'></i></button>
          <h2 class="text-2xl font-bold mb-4 text-cyan-400" id="tagGamesListTitle"></h2>
          <div id="tagGamesListBody" class="space-y-2"></div>
        </div>
      </div>
    </main>

    <script type="module">
      import {
        makeURL,
        getProxied,
        setProxy,
        getProxy,
        setTransport,
        setWisp,
      } from "/lethal.mjs";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
        authDomain: "carbon-services.firebaseapp.com",
        projectId: "carbon-services",
        storageBucket: "carbon-services.firebasestorage.app",
        messagingSenderId: "288385472070",
        appId: "1:288385472070:web:c4be3ff186e248fc645c47",
        measurementId: "G-Y2K1RQYE74"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      // Set authentication persistence
      auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
        .catch(error => console.error('Error setting auth persistence:', error));

      let proxyOption = localStorage.getItem("proxy-backend") || "uv";
      let currentBackground = localStorage.getItem('carbon-background-global') || 'gradient';

      async function ensureProxyReady() {
        if (!getProxy() || getProxy() !== proxyOption) await setProxy(proxyOption);
        let wisp = localStorage.getItem("wisp-server") || "wss://anura.pro/";
        let transport = localStorage.getItem("proxy-transport");
        if (wisp) await setWisp(wisp);
        if (transport) await setTransport(transport);
        else if (navigator.userAgent.indexOf("Firefox") > 0) await setTransport("libcurl");
        else await setTransport("epoxy");
      }

      function updateProxyToggleUI(proxy) {
        const proxyToggleBtn = document.getElementById("proxyToggleBtn");
        const proxyToggleIcon = document.getElementById("proxyToggleIcon");
        if (!proxyToggleBtn || !proxyToggleIcon) return;
        if (proxy === "scram") {
          proxyToggleBtn.classList.remove("border-cyan-400");
          proxyToggleBtn.classList.add("border-gold", "bg-gold/20");
          proxyToggleIcon.className = "bx bx-network-chart text-xl";
          proxyToggleBtn.title = "Scramjet";
        } else {
          proxyToggleBtn.classList.remove("border-gold", "bg-gold/20");
          proxyToggleBtn.classList.add("border-cyan-400");
          proxyToggleIcon.className = "bx bx-cloud text-xl";
          proxyToggleBtn.title = "UV";
        }
      }

      document.getElementById("proxyToggleBtn").addEventListener("click", async () => {
        proxyOption = (getProxy() === "scram") ? "uv" : "scram";
        localStorage.setItem("proxy-backend", proxyOption);
        await ensureProxyReady();
        updateProxyToggleUI(proxyOption);
        if (!document.getElementById("gameFrameContainer").classList.contains("hidden")) {
          loadProxiedGameIframe();
        }
      });

      async function loadProxiedGameIframe() {
        await ensureProxyReady();
        let gamesData = window.gamesData || [];
        let currentGameId = window.currentGameId;
        let currentGame = gamesData.find(g => String(g.id) === String(currentGameId));
        if (!currentGame) return;
        const proxied = await getProxied(currentGame.url);
        document.getElementById("gameFrameEmbed").src = proxied;
      }

      // Background Management
      async function loadSettingsFromFirebase() {
        const user = auth.currentUser;
        if (!user) return;
        try {
          const userSettingsDoc = await db.collection('users').doc(user.uid).get();
          if (userSettingsDoc.exists) {
            const userData = userSettingsDoc.data();
            const settings = userData.settings || {};
            if (settings.background) {
              currentBackground = settings.background;
              localStorage.setItem('carbon-background-global', currentBackground);
            }
            if (settings.customBackground) {
              localStorage.setItem('carbon-custom-bg-global', settings.customBackground);
            }
            applyBackground();
          }
        } catch (error) {
          console.error('Error loading settings from Firebase:', error);
        }
      }

      function applyBackground() {
        const body = document.body;
        const particlesCanvas = document.getElementById('particles-canvas');
        const baseColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-base').trim();
        particlesCanvas.classList.add('hidden');
        const customBg = localStorage.getItem('carbon-custom-bg-global');
        if (customBg) {
          body.style.background = `url(${customBg}) center/cover fixed`;
        } else {
          switch (currentBackground) {
            case 'solid':
              body.style.background = baseColor;
              break;
            case 'pattern':
              body.style.background = `${baseColor} url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="2" fill="%23ffffff" fill-opacity="0.2"/></svg>') repeat`;
              break;
            case 'particles':
              body.style.background = baseColor;
              particlesCanvas.classList.remove('hidden');
              initParticles();
              break;
            case 'gradient':
            default:
              body.style.background = 'var(--theme-gradient)';
              break;
          }
          body.style.backgroundAttachment = currentBackground === 'pattern' ? '' : 'fixed';
        }
      }

      function initParticles() {
        const canvas = document.getElementById('particles-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const particlesArray = [];
        const particleCount = 50;

        class Particle {
          constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 3 + 1;
            this.speedX = Math.random() * 0.5 - 0.25;
            this.speedY = Math.random() * 0.5 - 0.25;
          }
          update() {
            this.x += this.speedX;
            this.y += this.speedY;
            if (this.x < 0 || this.x > canvas.width) this.speedX *= -1;
            if (this.y < 0 || this.y > canvas.height) this.speedY *= -1;
          }
          draw() {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
          }
        }

        for (let i = 0; i < particleCount; i++) {
          particlesArray.push(new Particle());
        }

        function animateParticles() {
          if (currentBackground !== 'particles' || particlesCanvas.classList.contains('hidden')) return;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          particlesArray.forEach(particle => {
            particle.update();
            particle.draw();
          });
          requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', () => {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
        });

        animateParticles();
      }

      // Listen for theme and background changes
      window.addEventListener('storage', (event) => {
        if (event.key === 'carbon-theme-global' && event.newValue) {
          if (window.carbonTheme) {
            window.carbonTheme.applyTheme(event.newValue);
          }
          applyBackground();
        }
        if (event.key === 'carbon-background-global' && event.newValue) {
          currentBackground = event.newValue;
          applyBackground();
        }
        if (event.key === 'carbon-custom-bg-global') {
          applyBackground();
        }
      });

      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'carbon-theme-change') {
          if (window.carbonTheme) {
            window.carbonTheme.applyTheme(event.data.theme);
          }
          applyBackground();
        }
        if (event.data && event.data.type === 'carbon-settings-updated') {
          const settings = event.data.settings;
          if (settings.background) {
            currentBackground = settings.background;
            localStorage.setItem('carbon-background-global', currentBackground);
          }
          if (settings.customBackground) {
            localStorage.setItem('carbon-custom-bg-global', settings.customBackground);
          } else {
            localStorage.removeItem('carbon-custom-bg-global');
          }
          applyBackground();
        }
      });

      window.loadProxiedGameIframe = loadProxiedGameIframe;
      window.ensureProxyReady = ensureProxyReady;
      window.updateProxyToggleUI = updateProxyToggleUI;

      function googleSignIn() {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        auth.signInWithPopup(provider)
          .then(() => {
            document.getElementById('loginError').classList.add('hidden');
          })
          .catch((error) => {
            console.error('Google Sign-In Error:', error.code, error.message);
            const errorMessage = error.code === 'auth/popup-blocked' 
              ? 'Popup blocked. Please allow popups and try again.'
              : error.code === 'auth/network-request-failed' 
              ? 'Network error. Please check your connection and try again.'
              : `Authentication failed: ${error.message}`;
            document.getElementById('loginError').innerText = errorMessage;
            document.getElementById('loginError').classList.remove('hidden');
          });
      }

      function signOut() {
        auth.signOut().then(() => location.reload()).catch(error => {
          console.error('Sign-Out Error:', error);
          document.getElementById('loginError').innerText = 'Failed to sign out. Please try again.';
          document.getElementById('loginError').classList.remove('hidden');
        });
      }

      let gamesData = [];
      let currentGameId = null;
      let currentGame = null;
      let categoryCounts = {};
      let tagCounts = {};

      async function loadGamesData() {
        try {
          const res = await fetch('games.json');
          if (!res.ok) throw new Error('Failed to fetch games data');
          gamesData = await res.json();
          window.gamesData = gamesData;
          categoryCounts = {};
          tagCounts = {};
          gamesData.forEach(game => {
            if (game.category) categoryCounts[game.category] = (categoryCounts[game.category] || 0) + 1;
            if (game.tags && Array.isArray(game.tags)) {
              game.tags.forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1);
            }
          });
          window.categoryCounts = categoryCounts;
          window.tagCounts = tagCounts;
        } catch (error) {
          console.error('Error loading games data:', error);
        }
      }

      function getGameIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        return validateGameId(id);
      }

      function setButtonActive(btn, isActive, activeClass='bg-cyan-500/80') {
        btn.classList.toggle(activeClass, isActive);
      }

      function renderUserSection(user) {
        const section = document.getElementById('userSection');
        if (!user) {
          section.innerHTML = '';
        } else {
          const photoURL = validateUrl(user.photoURL) || '/default-avatar.png';
          const displayName = escapeHtml(user.displayName) || 'User';
          const titleAttr = escapeHtmlAttribute(user.displayName) || 'User';
          
          section.innerHTML = `
            <img src="${escapeHtmlAttribute(photoURL)}" class="w-8 h-8 rounded-full inline mr-2" title="${titleAttr}">
            <span class="mr-3">${displayName}</span>
            <button onclick="signOut()" class="bg-white/10 px-3 py-1 rounded hover:bg-pink-600 text-white">Sign Out</button>
          `;
        }
      }

      function showPreloader() {
        document.getElementById('preloader').style.display = '';
      }

      function hidePreloader() {
        document.getElementById('preloader').style.display = 'none';
      }

      function requestFullScreen(element) {
        if (element.requestFullscreen) element.requestFullscreen();
        else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();
        else if (element.msRequestFullscreen) element.msRequestFullscreen();
        else if (element.mozRequestFullScreen) element.mozRequestFullScreen();
      }

      // --- STAR RATING SYSTEM ---
      let starRatingData = {
        average: 0,
        count: 0,
        yourRating: 0,
        loading: false,
        error: "",
        percent: 0
      };

      function renderStarRatingUI(target = "") {
        const pre = target ? target : "";
        const container = document.getElementById('starsContainer' + pre);
        if (!container) return;
        container.innerHTML = '';
        let fill = starRatingData.yourRating ? starRatingData.yourRating : Math.round(starRatingData.average);
        for (let i = 1; i <= 5; i++) {
          const star = document.createElement('span');
          star.textContent = '★';
          star.className = 'transition-colors duration-150 select-none ' +
            (i <= fill ? 'text-yellow-400' : 'text-slate-600') +
            (firebase.auth().currentUser ? ' cursor-pointer hover:text-yellow-300' : ' cursor-not-allowed');
          if (firebase.auth().currentUser) {
            star.addEventListener('mouseenter', () => {
              for (let j = 0; j < 5; j++) container.children[j].classList.toggle('text-yellow-400', j < i);
              for (let j = i; j < 5; j++) container.children[j].classList.toggle('text-slate-600', j >= i);
            });
            star.addEventListener('mouseleave', () => {
              for (let j = 0; j < 5; j++) {
                container.children[j].classList.toggle('text-yellow-400', j < fill);
                container.children[j].classList.toggle('text-slate-600', j >= fill);
              }
            });
            star.addEventListener('click', async () => {
              await submitStarRating(i);
            });
          }
          container.appendChild(star);
        }
        document.getElementById('starRatingSummary' + pre).textContent =
          starRatingData.count ? `${starRatingData.average.toFixed(2)} / 5` : "Not rated";
        document.getElementById('starRatingCount' + pre).textContent =
          starRatingData.count === 1 ? "1 rating" : (starRatingData.count ? `${starRatingData.count} ratings` : "");
        document.getElementById('starRatingError' + pre).textContent = starRatingData.error || '';
        renderRatingPercentUI(target);
      }

      async function loadStarRating(gameId) {
        starRatingData.loading = true;
        starRatingData.error = "";
        starRatingData.average = 0;
        starRatingData.count = 0;
        starRatingData.yourRating = 0;
        starRatingData.percent = 0;
        try {
          const ratingsRef = db.collection("games").doc(gameId).collection("ratings");
          const snap = await ratingsRef.get();
          let total = 0, count = 0, your = 0, user = firebase.auth().currentUser;
          let highCount = 0;
          snap.forEach(doc => {
            const d = doc.data();
            if (typeof d.rating === "number" && d.rating >= 1 && d.rating <= 5) {
              total += d.rating;
              count++;
              if (d.rating >= 4) highCount++;
              if (user && doc.id === user.uid) your = d.rating;
            }
          });
          starRatingData.average = count ? total / count : 0;
          starRatingData.count = count;
          starRatingData.yourRating = your;
          starRatingData.percent = count ? Math.round((highCount / count) * 100) : 0;
        } catch (e) {
          starRatingData.error = "Failed to load ratings.";
          console.error('Error loading star ratings:', e);
        }
        starRatingData.loading = false;
        renderStarRatingUI();
        renderStarRatingUI("Frame");
      }

      async function submitStarRating(stars) {
        if (!firebase.auth().currentUser) {
          starRatingData.error = "Sign in first!";
          renderStarRatingUI();
          renderStarRatingUI("Frame");
          return;
        }
        if (!currentGameId) {
          starRatingData.error = "Game not loaded!";
          renderStarRatingUI();
          renderStarRatingUI("Frame");
          return;
        }
        if (stars < 1 || stars > 5) {
          starRatingData.error = "Invalid rating value!";
          renderStarRatingUI();
          renderStarRatingUI("Frame");
          return;
        }
        starRatingData.loading = true;
        starRatingData.error = "";
        renderStarRatingUI();
        renderStarRatingUI("Frame");
        try {
          const ref = db.collection("games").doc(currentGameId).collection("ratings").doc(firebase.auth().currentUser.uid);
          await ref.set({
            rating: stars,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          starRatingData.yourRating = stars;
          await loadStarRating(currentGameId);
        } catch (e) {
          starRatingData.error = "Failed to rate, try again.";
          console.error('Error submitting star rating:', e);
          renderStarRatingUI();
          renderStarRatingUI("Frame");
        }
        starRatingData.loading = false;
        renderStarRatingUI();
        renderStarRatingUI("Frame");
      }

      function renderRatingPercentUI(target = "") {
        const pre = target ? target : "";
        const txt = document.getElementById('ratingPercentText' + pre);
        const bar = document.getElementById('ratingPercentBar' + pre);
        if (!txt || !bar) return;
        if (starRatingData.count === 0) {
          txt.textContent = "Not enough ratings yet";
          bar.style.width = "0%";
        } else {
          txt.textContent = `${starRatingData.percent}% of raters gave 4 or 5 stars`;
          bar.style.width = `${starRatingData.percent}%`;
        }
      }

      // --- Tag Modal Logic ---
      function openTagGamesModal(tag) {
        const modal = document.getElementById('tagGamesListModal');
        const title = document.getElementById('tagGamesListTitle');
        const body = document.getElementById('tagGamesListBody');
        
        const sanitizedTag = escapeHtml(tag);
        
        const games = gamesData.filter(g => g.tags && g.tags.includes(tag));
        
        title.innerHTML = `${sanitizedTag.charAt(0).toUpperCase() + sanitizedTag.slice(1)} <span class="text-cyan-400/70 text-base">(${games.length} game${games.length!==1?'s':''})</span>`;
        
        if (games.length) {
          body.innerHTML = games.map(g => {
            const gameId = validateGameId(g.id) || '#';
            const gameTitle = escapeHtml(g.title) || 'Untitled Game';
            return `
              <a href="play.html?id=${escapeHtmlAttribute(gameId)}" class="block px-4 py-2 bg-white/5 rounded-md hover:bg-cyan-500/20 text-white/90 font-semibold transition">
                ${gameTitle}
              </a>
            `;
          }).join('');
        } else {
          body.innerHTML = `<div class="text-white/60">No games in this category.</div>`;
        }
        
        modal.classList.remove("hidden");
      }

      function closeTagGamesModal() {
        document.getElementById('tagGamesListModal').classList.add('hidden');
      }

      function renderCategoryGamesCountFrame(currentGame) {
        const el = document.getElementById('categoryGamesCountFrame');
        if (!el || !currentGame || !currentGame.category || !window.categoryCounts) {
          if (el) el.textContent = "";
          return;
        }
        const cat = currentGame.category;
        const count = window.categoryCounts[cat] || 0;
        el.textContent = `${cat.charAt(0).toUpperCase() + cat.slice(1)} (${count}) games`;
      }

      function renderTagsAreaFrame(currentGame) {
        const el = document.getElementById('tagsAreaFrame');
        if (!el) return;
        if (!currentGame || !currentGame.tags || !currentGame.tags.length) {
          el.innerHTML = "";
          return;
        }
        
        el.innerHTML = currentGame.tags.map(tag => {
          const sanitizedTag = escapeHtml(tag);
          const tagForClick = escapeHtmlAttribute(tag);
          const tagCount = parseInt(window.tagCounts[tag]) || 1;
          
          return `
            <button type="button"
              class="tag-btn inline-block px-3 py-1 bg-gradient-to-r from-cyan-400/20 to-indigo-500/20 text-cyan-300 text-xs rounded-full border border-cyan-400/30 hover:bg-cyan-600/10 transition font-semibold"
              onclick="openTagGamesModal('${tagForClick}')"
              >
              ${sanitizedTag.charAt(0).toUpperCase() + sanitizedTag.slice(1)} <span class="text-cyan-400/70">(${tagCount})</span>
            </button>
          `;
        }).join('');
      }

      function renderGameInfoBox(game, tableId) {
        const el = document.getElementById(tableId);
        if (!el) return;
        
        const developer = escapeHtml(game.developer) || "Unknown";
        const release = escapeHtml(game.release) || "Unknown";
        const technology = escapeHtml(game.technology) || "Unknown";
        const controls = escapeHtml(game.controls) || "See in-game";
        
        let platformsHtml = "Unknown";
        if (Array.isArray(game.platforms)) {
          platformsHtml = game.platforms.map(p => 
            `<span class="bg-[#232445] text-cyan-300 px-2 py-[2px] rounded-full text-xs font-semibold">${escapeHtml(p)}</span>`
          ).join('');
        } else if (game.platforms) {
          platformsHtml = escapeHtml(game.platforms);
        }
        
        el.innerHTML = `
          <tr>
            <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Developer</th>
            <td class="py-1">${developer}</td>
          </tr>
          <tr>
            <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Release</th>
            <td class="py-1">${release}</td>
          </tr>
          <tr>
            <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Technology</th>
            <td class="py-1">${technology}</td>
          </tr>
          <tr>
            <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Platforms</th>
            <td class="flex flex-wrap gap-2 py-1">
              ${platformsHtml}
            </td>
          </tr>
          <tr>
            <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Controls</th>
            <td class="py-1">${controls}</td>
          </tr>
        `;
      }

      // --- COMMENT SYSTEM ---
      let commentsData = {
        comments: [],
        loading: false,
        currentFilter: 'all',
        currentCommentRating: 0,
        currentReplyingTo: null,
        lastVisible: null,
        commentsPerPage: 10
      };

      function initCommentStarInput() {
        const container = document.getElementById('commentStarInput');
        if (!container) return;
        
        container.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
          const star = document.createElement('span');
          star.textContent = '★';
          star.className = 'cursor-pointer transition-colors duration-150 select-none ' + 
            (i <= commentsData.currentCommentRating ? 'text-yellow-400' : 'text-slate-600');
          
          star.addEventListener('mouseenter', () => {
            for (let j = 0; j < 5; j++) {
              container.children[j].classList.toggle('text-yellow-400', j < i);
              container.children[j].classList.toggle('text-slate-600', j >= i);
            }
          });
          
          star.addEventListener('mouseleave', () => {
            for (let j = 0; j < 5; j++) {
              container.children[j].classList.toggle('text-yellow-400', j < commentsData.currentCommentRating);
              container.children[j].classList.toggle('text-slate-600', j >= commentsData.currentCommentRating);
            }
          });
          
          star.addEventListener('click', () => {
            commentsData.currentCommentRating = commentsData.currentCommentRating === i ? 0 : i;
            updateCommentStarInput();
          });
          
          container.appendChild(star);
        }
      }

      function updateCommentStarInput() {
        const container = document.getElementById('commentStarInput');
        if (!container) return;
        
        for (let j = 0; j < 5; j++) {
          container.children[j].classList.toggle('text-yellow-400', j < commentsData.currentCommentRating);
          container.children[j].classList.toggle('text-slate-600', j >= commentsData.currentCommentRating);
        }
      }

      async function loadComments(gameId, loadMore = false) {
        if (!gameId) return;
        
        commentsData.loading = true;
        updateCommentsUI();
        
        try {
          let query = db.collection("games").doc(gameId).collection("comments")
            .orderBy("createdAt", "desc")
            .limit(commentsData.commentsPerPage);
          
          if (loadMore && commentsData.lastVisible) {
            query = query.startAfter(commentsData.lastVisible);
          }
          
          const snapshot = await query.get();
          
          if (loadMore) {
            snapshot.forEach(doc => {
              commentsData.comments.push({ id: doc.id, ...doc.data() });
            });
          } else {
            commentsData.comments = [];
            snapshot.forEach(doc => {
              commentsData.comments.push({ id: doc.id, ...doc.data() });
            });
          }
          
          commentsData.lastVisible = snapshot.docs[snapshot.docs.length - 1] || null;
          
          for (let comment of commentsData.comments) {
            if (!comment.replies) {
              const repliesSnapshot = await db.collection("games").doc(gameId)
                .collection("comments").doc(comment.id)
                .collection("replies")
                .orderBy("createdAt", "asc")
                .get();
              
              comment.replies = [];
              repliesSnapshot.forEach(replyDoc => {
                comment.replies.push({ id: replyDoc.id, ...replyDoc.data() });
              });
            }
          }
          
        } catch (error) {
          console.error("Error loading comments:", error);
        }
        
        commentsData.loading = false;
        updateCommentsUI();
      }

      async function submitComment() {
        const user = firebase.auth().currentUser;
        const text = document.getElementById('commentText').value.trim();
        
        if (!user) {
          alert('Please sign in to comment');
          return;
        }
        
        if (!text) {
          alert('Please enter a comment');
          return;
        }
        
        if (!currentGameId) {
          alert('Game not loaded');
          return;
        }
        
        const sanitizedText = sanitizeText(text, 1000);
        if (!sanitizedText) {
          alert('Invalid comment text');
          return;
        }
        
        const validatedGameId = validateGameId(currentGameId);
        if (!validatedGameId) {
          alert('Invalid game ID');
          return;
        }
        
        try {
          const commentData = {
            text: sanitizedText,
            rating: commentsData.currentCommentRating || null,
            authorId: user.uid,
            authorName: user.displayName || 'Anonymous',
            authorPhoto: user.photoURL || '/default-avatar.png',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            reactions: {},
            reactionCounts: {}
          };
          
          const docRef = await db.collection("games").doc(validatedGameId)
            .collection("comments").add(commentData);
          
          document.getElementById('commentText').value = '';
          commentsData.currentCommentRating = 0;
          updateCommentStarInput();
          updateSubmitButtonState();
          
          await loadComments(validatedGameId);
          
        } catch (error) {
          console.error("Error submitting comment:", error);
          alert('Failed to submit comment. Please try again.');
        }
      }

      async function submitReply() {
        const user = firebase.auth().currentUser;
        const text = document.getElementById('replyText').value.trim();
        
        if (!user || !text || !commentsData.currentReplyingTo) {
          return;
        }
        
        const sanitizedText = sanitizeText(text, 500);
        if (!sanitizedText) {
          alert('Invalid reply text');
          return;
        }
        
        const validatedGameId = validateGameId(currentGameId);
        if (!validatedGameId) {
          alert('Invalid game ID');
          return;
        }
        
        try {
          const replyData = {
            text: sanitizedText,
            authorId: user.uid,
            authorName: user.displayName || 'Anonymous',
            authorPhoto: user.photoURL || '/default-avatar.png',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            reactions: {},
            reactionCounts: {}
          };
          
          await db.collection("games").doc(validatedGameId)
            .collection("comments").doc(commentsData.currentReplyingTo)
            .collection("replies").add(replyData);
          
          closeReplyModal();
          await loadComments(validatedGameId);
          
        } catch (error) {
          console.error("Error submitting reply:", error);
          alert('Failed to submit reply. Please try again.');
        }
      }

      async function toggleReaction(commentId, emoji, isReply = false, replyId = null)
