<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Forum - CARBON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="carbon-theme.js"></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <!-- DOMPurify for XSS protection -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
  
  <!-- Simple Content Filter -->
  <script>
    // Simple browser-compatible content filter
    class SimpleContentFilter {
      constructor() {
        this.badWords = [
          'spam', 'scam', 'hack', 'cheat', 'bot', 'fake',
          // Add more words as needed, keeping it clean and appropriate
        ];
      }
      
      clean(text) {
        if (!text) return '';
        let cleaned = text;
        this.badWords.forEach(word => {
          const regex = new RegExp(word, 'gi');
          cleaned = cleaned.replace(regex, '*'.repeat(word.length));
        });
        return cleaned;
      }
      
      isProfane(text) {
        if (!text) return false;
        return this.badWords.some(word => 
          text.toLowerCase().includes(word.toLowerCase())
        );
      }
    }
    
    // Make it globally available immediately
    window.Filter = SimpleContentFilter;
    console.log('Content filter class loaded');
  </script>

  <!-- Emoji Support Package -->
  <script src="https://unpkg.com/emoji-js@8.0.0/lib/emoji.js"></script>
  <!-- Unicode Emoji Data -->
  <script src="https://unpkg.com/unicode-emoji-json@0.4.0/data-by-group.json" type="application/json" id="emojiData"></script>
  <script>
    // Initialize emoji support after emoji-js loads
    let emojiConverterRetries = 0;
    const maxEmojiConverterRetries = 50; // Max 5 seconds
    
    function initializeEmojiConverter() {
      if (typeof EmojiConvertor !== 'undefined') {
        window.emojiConverter = new EmojiConvertor();
        window.emojiConverter.replace_mode = 'unified';
        window.emojiConverter.allow_native = true;
        console.log('Emoji converter initialized');
      } else if (emojiConverterRetries < maxEmojiConverterRetries) {
        emojiConverterRetries++;
        console.warn(`EmojiConvertor not available, retrying in 100ms (${emojiConverterRetries}/${maxEmojiConverterRetries})`);
        setTimeout(initializeEmojiConverter, 100);
      } else {
        console.error('EmojiConvertor failed to load after maximum retries. Emoji reactions may not work properly.');
        // Create a fallback emoji converter
        window.emojiConverter = {
          replace_mode: 'unified',
          allow_native: true,
          replace_colons: function(text) { return text; },
          replace_unified: function(text) { return text; }
        };
      }
    }
    
    // Try to initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', initializeEmojiConverter);
    
    // Common reaction emojis (quick access)
    window.reactionEmojis = [
      { emoji: 'ðŸ‘', name: 'thumbs_up', unicode: '1f44d' },
      { emoji: 'â¤ï¸', name: 'heart', unicode: '2764' },
      { emoji: 'ðŸ˜‚', name: 'joy', unicode: '1f602' },
      { emoji: 'ðŸ˜®', name: 'open_mouth', unicode: '1f62e' },
      { emoji: 'ðŸ˜¢', name: 'cry', unicode: '1f622' },
      { emoji: 'ðŸ˜¡', name: 'rage', unicode: '1f621' },
      { emoji: 'ðŸ”¥', name: 'fire', unicode: '1f525' },
      { emoji: 'ðŸŽ‰', name: 'tada', unicode: '1f389' }
    ];

    // Extended emoji database for Discord-style suggestions
    window.allEmojis = [
      // Smileys & Emotion
      { emoji: 'ðŸ˜€', name: 'grinning', keywords: ['happy', 'smile', 'grin'] },
      { emoji: 'ðŸ˜ƒ', name: 'smiley', keywords: ['happy', 'smile', 'joy'] },
      { emoji: 'ðŸ˜„', name: 'smile', keywords: ['happy', 'smile', 'laugh'] },
      { emoji: 'ðŸ˜', name: 'grin', keywords: ['happy', 'smile', 'grin'] },
      { emoji: 'ðŸ˜†', name: 'laughing', keywords: ['happy', 'laugh', 'funny'] },
      { emoji: 'ðŸ˜…', name: 'sweat_smile', keywords: ['happy', 'laugh', 'nervous'] },
      { emoji: 'ðŸ¤£', name: 'rofl', keywords: ['laugh', 'funny', 'hilarious'] },
      { emoji: 'ðŸ˜‚', name: 'joy', keywords: ['laugh', 'funny', 'tears'] },
      { emoji: 'ðŸ™‚', name: 'slightly_smiling', keywords: ['smile', 'happy'] },
      { emoji: 'ðŸ™ƒ', name: 'upside_down', keywords: ['silly', 'playful'] },
      { emoji: 'ðŸ˜‰', name: 'wink', keywords: ['flirt', 'playful'] },
      { emoji: 'ðŸ˜Š', name: 'blush', keywords: ['happy', 'shy', 'sweet'] },
      { emoji: 'ðŸ˜‡', name: 'innocent', keywords: ['angel', 'good', 'halo'] },
      { emoji: 'ðŸ¥°', name: 'smiling_face_with_hearts', keywords: ['love', 'happy', 'hearts'] },
      { emoji: 'ðŸ˜', name: 'heart_eyes', keywords: ['love', 'crush', 'heart'] },
      { emoji: 'ðŸ¤©', name: 'star_struck', keywords: ['excited', 'wow', 'star'] },
      { emoji: 'ðŸ˜˜', name: 'kissing_heart', keywords: ['kiss', 'love', 'heart'] },
      { emoji: 'ðŸ˜—', name: 'kissing', keywords: ['kiss', 'love'] },
      { emoji: 'ðŸ˜š', name: 'kissing_closed_eyes', keywords: ['kiss', 'love'] },
      { emoji: 'ðŸ˜™', name: 'kissing_smiling_eyes', keywords: ['kiss', 'love'] },
      { emoji: 'ðŸ¥²', name: 'smiling_face_with_tear', keywords: ['happy', 'cry', 'tear'] },
      { emoji: 'ðŸ˜‹', name: 'yum', keywords: ['delicious', 'food', 'hungry'] },
      { emoji: 'ðŸ˜›', name: 'stuck_out_tongue', keywords: ['playful', 'silly'] },
      { emoji: 'ðŸ˜œ', name: 'stuck_out_tongue_winking_eye', keywords: ['playful', 'silly', 'wink'] },
      { emoji: 'ðŸ¤ª', name: 'zany_face', keywords: ['crazy', 'silly', 'wild'] },
      { emoji: 'ðŸ˜', name: 'stuck_out_tongue_closed_eyes', keywords: ['playful', 'silly'] },
      { emoji: 'ðŸ¤‘', name: 'money_mouth', keywords: ['money', 'rich', 'greedy'] },
      
      // Negative emotions
      { emoji: 'ðŸ˜', name: 'neutral', keywords: ['neutral', 'meh', 'ok'] },
      { emoji: 'ðŸ˜‘', name: 'expressionless', keywords: ['blank', 'meh', 'whatever'] },
      { emoji: 'ðŸ˜¶', name: 'no_mouth', keywords: ['silent', 'quiet', 'speechless'] },
      { emoji: 'ðŸ˜', name: 'smirk', keywords: ['smug', 'confident'] },
      { emoji: 'ðŸ˜’', name: 'unamused', keywords: ['annoyed', 'meh', 'bored'] },
      { emoji: 'ðŸ™„', name: 'eye_roll', keywords: ['annoyed', 'whatever', 'sarcastic'] },
      { emoji: 'ðŸ˜¬', name: 'grimacing', keywords: ['awkward', 'nervous', 'cringe'] },
      { emoji: 'ðŸ˜®â€ðŸ’¨', name: 'face_exhaling', keywords: ['tired', 'sigh', 'relief'] },
      { emoji: 'ðŸ¤¥', name: 'lying', keywords: ['lie', 'pinocchio'] },
      { emoji: 'ðŸ˜Œ', name: 'relieved', keywords: ['calm', 'peaceful', 'relieved'] },
      { emoji: 'ðŸ˜”', name: 'pensive', keywords: ['sad', 'thoughtful', 'down'] },
      { emoji: 'ðŸ˜ª', name: 'sleepy', keywords: ['tired', 'sleep', 'sleepy'] },
      { emoji: 'ðŸ¤¤', name: 'drooling', keywords: ['hungry', 'desire', 'want'] },
      { emoji: 'ðŸ˜´', name: 'sleeping', keywords: ['sleep', 'tired', 'zzz'] },
      { emoji: 'ðŸ˜·', name: 'mask', keywords: ['sick', 'ill', 'covid'] },
      { emoji: 'ðŸ¤’', name: 'thermometer_face', keywords: ['sick', 'fever', 'ill'] },
      { emoji: 'ðŸ¤•', name: 'head_bandage', keywords: ['hurt', 'injured', 'sick'] },
      { emoji: 'ðŸ¤¢', name: 'nauseated', keywords: ['sick', 'gross', 'disgusted'] },
      { emoji: 'ðŸ¤®', name: 'vomiting', keywords: ['sick', 'gross', 'disgusted'] },
      { emoji: 'ðŸ¤§', name: 'sneezing', keywords: ['sick', 'sneeze', 'cold'] },
      { emoji: 'ðŸ¥µ', name: 'hot', keywords: ['hot', 'heat', 'sweating'] },
      { emoji: 'ðŸ¥¶', name: 'cold', keywords: ['cold', 'freezing', 'blue'] },
      { emoji: 'ðŸ˜µ', name: 'dizzy', keywords: ['dizzy', 'confused', 'spiral'] },
      { emoji: 'ðŸ¤¯', name: 'exploding_head', keywords: ['mind_blown', 'shocked', 'wow'] },
      { emoji: 'ðŸ˜³', name: 'flushed', keywords: ['embarrassed', 'shy', 'red'] },
      { emoji: 'ðŸ¥º', name: 'pleading', keywords: ['cute', 'puppy_eyes', 'please'] },
      { emoji: 'ðŸ˜¦', name: 'frowning', keywords: ['sad', 'disappointed'] },
      { emoji: 'ðŸ˜§', name: 'anguished', keywords: ['worried', 'anxious', 'sad'] },
      { emoji: 'ðŸ˜¨', name: 'fearful', keywords: ['scared', 'afraid', 'fear'] },
      { emoji: 'ðŸ˜°', name: 'cold_sweat', keywords: ['nervous', 'anxious', 'worried'] },
      { emoji: 'ðŸ˜¥', name: 'disappointed_relieved', keywords: ['sad', 'disappointed', 'relieved'] },
      { emoji: 'ðŸ˜¢', name: 'cry', keywords: ['sad', 'cry', 'tear'] },
      { emoji: 'ðŸ˜­', name: 'sob', keywords: ['cry', 'sad', 'tears'] },
      { emoji: 'ðŸ˜±', name: 'scream', keywords: ['scared', 'shocked', 'afraid'] },
      { emoji: 'ðŸ˜–', name: 'confounded', keywords: ['frustrated', 'confused', 'annoyed'] },
      { emoji: 'ðŸ˜£', name: 'persevere', keywords: ['frustrated', 'struggling', 'effort'] },
      { emoji: 'ðŸ˜ž', name: 'disappointed', keywords: ['sad', 'disappointed', 'down'] },
      { emoji: 'ðŸ˜“', name: 'sweat', keywords: ['tired', 'working', 'effort'] },
      { emoji: 'ðŸ˜©', name: 'weary', keywords: ['tired', 'exhausted', 'frustrated'] },
      { emoji: 'ðŸ˜«', name: 'tired_face', keywords: ['tired', 'exhausted', 'worn_out'] },
      { emoji: 'ðŸ˜¤', name: 'triumph', keywords: ['proud', 'steaming', 'huffing'] },
      { emoji: 'ðŸ˜¡', name: 'rage', keywords: ['angry', 'mad', 'furious'] },
      { emoji: 'ðŸ˜ ', name: 'angry', keywords: ['angry', 'mad', 'upset'] },
      { emoji: 'ðŸ¤¬', name: 'swearing', keywords: ['angry', 'cursing', 'mad'] },
      
      // Gestures & People
      { emoji: 'ðŸ‘', name: 'thumbs_up', keywords: ['good', 'like', 'yes', 'approve'] },
      { emoji: 'ðŸ‘Ž', name: 'thumbs_down', keywords: ['bad', 'dislike', 'no', 'disapprove'] },
      { emoji: 'ðŸ‘Œ', name: 'ok_hand', keywords: ['ok', 'good', 'perfect'] },
      { emoji: 'âœŒï¸', name: 'peace', keywords: ['peace', 'victory', 'two'] },
      { emoji: 'ðŸ¤ž', name: 'crossed_fingers', keywords: ['luck', 'hope', 'wish'] },
      { emoji: 'ðŸ¤Ÿ', name: 'love_you', keywords: ['love', 'rock', 'metal'] },
      { emoji: 'ðŸ¤˜', name: 'rock', keywords: ['rock', 'metal', 'horns'] },
      { emoji: 'ðŸ¤™', name: 'call_me', keywords: ['call', 'phone', 'shaka'] },
      { emoji: 'ðŸ‘ˆ', name: 'point_left', keywords: ['point', 'left', 'direction'] },
      { emoji: 'ðŸ‘‰', name: 'point_right', keywords: ['point', 'right', 'direction'] },
      { emoji: 'ðŸ‘†', name: 'point_up', keywords: ['point', 'up', 'direction'] },
      { emoji: 'ðŸ‘‡', name: 'point_down', keywords: ['point', 'down', 'direction'] },
      { emoji: 'â˜ï¸', name: 'index_pointing_up', keywords: ['point', 'up', 'one'] },
      { emoji: 'âœ‹', name: 'raised_hand', keywords: ['stop', 'hand', 'high_five'] },
      { emoji: 'ðŸ¤š', name: 'raised_back_of_hand', keywords: ['stop', 'hand'] },
      { emoji: 'ðŸ–ï¸', name: 'hand_splayed', keywords: ['stop', 'hand', 'five'] },
      { emoji: 'ðŸ––', name: 'vulcan', keywords: ['spock', 'star_trek', 'live_long'] },
      { emoji: 'ðŸ‘‹', name: 'wave', keywords: ['hello', 'goodbye', 'hi'] },
      { emoji: 'ðŸ¤', name: 'pinching_hand', keywords: ['small', 'tiny', 'little'] },
      { emoji: 'ðŸ‘', name: 'clap', keywords: ['applause', 'good', 'bravo'] },
      { emoji: 'ðŸ™Œ', name: 'raised_hands', keywords: ['celebration', 'hooray', 'praise'] },
      { emoji: 'ðŸ‘', name: 'open_hands', keywords: ['hug', 'open', 'embrace'] },
      { emoji: 'ðŸ¤²', name: 'palms_up', keywords: ['prayer', 'please', 'open'] },
      { emoji: 'ðŸ¤', name: 'handshake', keywords: ['deal', 'agreement', 'meeting'] },
      { emoji: 'ðŸ™', name: 'pray', keywords: ['prayer', 'thanks', 'please'] },
      
      // Hearts
      { emoji: 'â¤ï¸', name: 'heart', keywords: ['love', 'heart', 'red'] },
      { emoji: 'ðŸ§¡', name: 'orange_heart', keywords: ['love', 'heart', 'orange'] },
      { emoji: 'ðŸ’›', name: 'yellow_heart', keywords: ['love', 'heart', 'yellow'] },
      { emoji: 'ðŸ’š', name: 'green_heart', keywords: ['love', 'heart', 'green'] },
      { emoji: 'ðŸ’™', name: 'blue_heart', keywords: ['love', 'heart', 'blue'] },
      { emoji: 'ðŸ’œ', name: 'purple_heart', keywords: ['love', 'heart', 'purple'] },
      { emoji: 'ðŸ–¤', name: 'black_heart', keywords: ['love', 'heart', 'black'] },
      { emoji: 'ðŸ¤', name: 'white_heart', keywords: ['love', 'heart', 'white'] },
      { emoji: 'ðŸ¤Ž', name: 'brown_heart', keywords: ['love', 'heart', 'brown'] },
      { emoji: 'ðŸ’”', name: 'broken_heart', keywords: ['sad', 'heartbreak', 'love'] },
      { emoji: 'â£ï¸', name: 'heart_exclamation', keywords: ['love', 'heart', 'exclamation'] },
      { emoji: 'ðŸ’•', name: 'two_hearts', keywords: ['love', 'heart', 'two'] },
      { emoji: 'ðŸ’–', name: 'sparkling_heart', keywords: ['love', 'heart', 'sparkle'] },
      { emoji: 'ðŸ’—', name: 'growing_heart', keywords: ['love', 'heart', 'growing'] },
      { emoji: 'ðŸ’˜', name: 'cupid', keywords: ['love', 'heart', 'arrow'] },
      { emoji: 'ðŸ’', name: 'gift_heart', keywords: ['love', 'gift', 'present'] },
      { emoji: 'ðŸ’Ÿ', name: 'heart_decoration', keywords: ['love', 'heart', 'decoration'] },
      
      // Objects & Symbols
      { emoji: 'ðŸ”¥', name: 'fire', keywords: ['hot', 'burn', 'flame'] },
      { emoji: 'ðŸ’¯', name: 'hundred', keywords: ['perfect', 'score', '100'] },
      { emoji: 'ðŸ’¢', name: 'anger', keywords: ['angry', 'mad', 'symbol'] },
      { emoji: 'ðŸ’¥', name: 'boom', keywords: ['explosion', 'bang', 'pow'] },
      { emoji: 'ðŸ’«', name: 'dizzy', keywords: ['star', 'sparkle', 'dizzy'] },
      { emoji: 'ðŸ’¦', name: 'sweat_drops', keywords: ['water', 'sweat', 'splash'] },
      { emoji: 'ðŸ’¨', name: 'dash', keywords: ['fast', 'wind', 'speed'] },
      { emoji: 'ðŸ•³ï¸', name: 'hole', keywords: ['hole', 'empty', 'void'] },
      { emoji: 'ðŸ’¤', name: 'zzz', keywords: ['sleep', 'tired', 'sleeping'] },
      { emoji: 'ðŸŽ‰', name: 'tada', keywords: ['celebration', 'party', 'congrats'] },
      { emoji: 'ðŸŽŠ', name: 'confetti_ball', keywords: ['celebration', 'party', 'confetti'] },
      { emoji: 'ðŸŽˆ', name: 'balloon', keywords: ['party', 'celebration', 'birthday'] },
      { emoji: 'ðŸŽ', name: 'gift', keywords: ['present', 'birthday', 'surprise'] },
      { emoji: 'ðŸ†', name: 'trophy', keywords: ['winner', 'award', 'first'] },
      { emoji: 'ðŸ¥‡', name: 'first_place', keywords: ['gold', 'winner', 'first'] },
      { emoji: 'ðŸ¥ˆ', name: 'second_place', keywords: ['silver', 'second'] },
      { emoji: 'ðŸ¥‰', name: 'third_place', keywords: ['bronze', 'third'] },
      { emoji: 'â­', name: 'star', keywords: ['star', 'favorite', 'good'] },
      { emoji: 'ðŸŒŸ', name: 'glowing_star', keywords: ['star', 'sparkle', 'shiny'] },
      { emoji: 'âœ¨', name: 'sparkles', keywords: ['sparkle', 'magic', 'clean'] },
      { emoji: 'âš¡', name: 'zap', keywords: ['lightning', 'fast', 'power'] },
      { emoji: 'â˜€ï¸', name: 'sunny', keywords: ['sun', 'bright', 'hot'] },
      { emoji: 'ðŸŒˆ', name: 'rainbow', keywords: ['colorful', 'pride', 'weather'] }
    ];
    
    console.log('Emoji converter and database loaded');
  </script>
  
  <script>
    // Tailwind config with theme colors
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'rp-base': '#191724',
            'rp-surface': '#1f1d2e',
            'rp-overlay': '#26233a',
            'rp-muted': '#6e6a86',
            'rp-subtle': '#908caa',
            'rp-text': '#e0def4',
            'rp-love': '#eb6f92',
            'rp-gold': '#f6c177',
            'rp-rose': '#ebbcba',
            'rp-pine': '#31748f',
            'rp-foam': '#9ccfd8',
            'rp-iris': '#c4a7e7',
            'rp-highlight-low': '#21202e',
            'rp-highlight-med': '#403d52',
            'rp-highlight-high': '#524f67'
          }
        }
      }
    }
  </script>
  
  <style>
    :root {
      --text-color: #e0def4;
      --surface-color: #1f1d2e;
      --overlay-color: #26233a;
      --highlight-med: #403d52;
      --highlight-high: #524f67;
      --foam: #9ccfd8;
      --love: #eb6f92;
      --gold: #f6c177;
      --pine: #31748f;
      --iris: #c4a7e7;
      --muted: #6e6a86;
      --subtle: #908caa;

      /* Theme variables - Rose Pine (default) */
      --theme-base: #191724;
      --theme-surface: #1f1d2e;
      --theme-overlay: #26233a;
      --theme-muted: #6e6a86;
      --theme-subtle: #908caa;
      --theme-text: #e0def4;
      --theme-love: #eb6f92;
      --theme-gold: #f6c177;
      --theme-rose: #ebbcba;
      --theme-pine: #31748f;
      --theme-foam: #9ccfd8;
      --theme-iris: #c4a7e7;
      --theme-highlight-low: #21202e;
      --theme-highlight-med: #403d52;
      --theme-highlight-high: #524f67;
      --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
    }
    
    body {
      background: var(--theme-gradient);
      background-attachment: fixed;
      line-height: 1.6;
    }

    /* Enhanced Typography */
    .text-display {
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    .text-heading {
      font-size: 1.875rem;
      font-weight: 600;
      letter-spacing: -0.025em;
    }

    .text-subheading {
      font-size: 1.25rem;
      font-weight: 500;
    }

    /* Enhanced Cards */
    .card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
    }

    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px -1px rgba(0, 0, 0, 0.4);
      border-color: var(--theme-foam);
    }

    /* Enhanced Buttons */
    .btn-primary {
      background: var(--theme-foam);
      color: var(--theme-base);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: var(--theme-pine);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--theme-overlay);
      color: var(--theme-text);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid var(--theme-highlight-med);
      cursor: pointer;
    }

    .btn-secondary:hover {
      background: var(--theme-highlight-med);
      border-color: var(--theme-foam);
    }

    .btn-danger {
      background: var(--theme-love);
      color: var(--theme-text);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .btn-danger:hover {
      background: #d14d72;
      transform: translateY(-1px);
    }

    /* Rank Badges */
    .rank-owner {
      background: linear-gradient(135deg, #f6c177, #eb6f92);
      color: #191724;
    }

    .rank-admin {
      background: linear-gradient(135deg, #eb6f92, #c4a7e7);
      color: #191724;
    }

    .rank-moderator {
      background: linear-gradient(135deg, #9ccfd8, #31748f);
      color: #191724;
    }

    .rank-member {
      background: var(--theme-overlay);
      color: var(--theme-text);
      border: 1px solid var(--theme-highlight-med);
    }

    .rank-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Forum Categories */
    .category-card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .category-card:hover {
      border-color: var(--theme-foam);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px -1px rgba(0, 0, 0, 0.4);
    }

    .category-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 12px;
    }

    /* Search and Filter Styles */
    .search-input {
      background: var(--theme-overlay);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 8px;
      padding: 12px 16px;
      color: var(--theme-text);
      width: 100%;
      transition: all 0.2s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--theme-foam);
      box-shadow: 0 0 0 3px rgba(156, 207, 216, 0.1);
    }

    .search-input::placeholder {
      color: var(--theme-muted);
    }

    /* Post Styles */
    .post-card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }

    .post-card:hover {
      border-color: var(--theme-highlight-med);
    }

    .post-author {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .author-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .text-display {
        font-size: 2rem;
      }
      
      .text-heading {
        font-size: 1.5rem;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* Loading Spinner */
    .spinner {
      border: 2px solid var(--theme-overlay);
      border-radius: 50%;
      border-top: 2px solid var(--theme-foam);
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Reaction Styles */
    .reaction-button {
      background: var(--theme-overlay);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 20px;
      padding: 6px 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
      cursor: pointer;
      font-size: 14px;
    }

    .reaction-button:hover {
      background: var(--theme-highlight-med);
      border-color: var(--theme-foam);
      transform: scale(1.05);
    }

    .reaction-button.active {
      background: var(--theme-foam);
      border-color: var(--theme-foam);
      color: var(--theme-base);
    }

    .reaction-button.active:hover {
      background: var(--theme-pine);
    }

    .reaction-picker {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 8px;
      display: flex;
      gap: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      position: absolute;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: scale(0.95);
      transition: all 0.2s ease;
    }

    .reaction-picker.show {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
    }

    .emoji-option {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
    }

    .emoji-option:hover {
      background: var(--theme-highlight-med);
      transform: scale(1.2);
    }

    .reactions-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--theme-overlay);
    }

    .add-reaction-btn {
      background: var(--theme-overlay);
      border: 1px dashed var(--theme-highlight-med);
      border-radius: 20px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--theme-muted);
    }

    .add-reaction-btn:hover {
      background: var(--theme-highlight-med);
      border-color: var(--theme-foam);
      color: var(--theme-foam);
      transform: scale(1.1);
    }

    /* Reaction animations */
    @keyframes reactionPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    .reaction-animate {
      animation: reactionPop 0.3s ease;
    }

    /* Achievement Styles */
    .achievement-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: linear-gradient(135deg, var(--theme-gold), var(--theme-iris));
      color: var(--theme-base);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .achievement-badge.rare {
      background: linear-gradient(135deg, var(--theme-love), var(--theme-iris));
    }

    .achievement-badge.epic {
      background: linear-gradient(135deg, var(--theme-iris), var(--theme-pine));
    }

    .achievement-badge.legendary {
      background: linear-gradient(135deg, var(--theme-gold), var(--theme-love));
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.9; }
    }

    .achievement-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--theme-surface);
      border: 2px solid var(--theme-gold);
      border-radius: 12px;
      padding: 16px;
      max-width: 300px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      z-index: 9999;
      transform: translateX(350px);
      transition: all 0.4s ease;
    }

    .achievement-notification.show {
      transform: translateX(0);
    }

    .achievement-progress {
      background: var(--theme-overlay);
      border-radius: 8px;
      height: 8px;
      overflow: hidden;
      margin-top: 8px;
    }

    .achievement-progress-bar {
      background: linear-gradient(90deg, var(--theme-foam), var(--theme-iris));
      height: 100%;
      transition: width 0.3s ease;
      border-radius: 8px;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .achievement-card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .achievement-card:hover {
      border-color: var(--theme-foam);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .achievement-card.unlocked {
      border-color: var(--theme-gold);
      background: linear-gradient(135deg, var(--theme-surface), var(--theme-overlay));
    }

    .achievement-card.unlocked::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--theme-gold), var(--theme-iris));
    }

    .achievement-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin: 0 auto 12px;
      background: var(--theme-overlay);
      color: var(--theme-muted);
    }

    .achievement-card.unlocked .achievement-icon {
      background: linear-gradient(135deg, var(--theme-gold), var(--theme-iris));
      color: var(--theme-base);
    }

    .achievement-rarity {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .achievement-rarity.common { background: var(--theme-overlay); color: var(--theme-text); }
    .achievement-rarity.rare { background: var(--theme-love); color: white; }
    .achievement-rarity.epic { background: var(--theme-iris); color: white; }
    .achievement-rarity.legendary { background: var(--theme-gold); color: var(--theme-base); }

    /* Achievement Modal */
    .achievements-modal .modal-content {
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Stats Display */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--theme-overlay);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--theme-foam);
    }

    .stat-label {
      font-size: 12px;
      color: var(--theme-subtle);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .achievement-filter {
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--theme-overlay);
      background: transparent;
      color: var(--theme-text);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .achievement-filter:hover {
      border-color: var(--theme-foam);
      color: var(--theme-foam);
    }

    .achievement-filter.active {
      background: var(--theme-foam);
      border-color: var(--theme-foam);
      color: var(--theme-base);
    }

    /* Discord-style Emoji Picker */
    .emoji-search-container {
      position: relative;
      margin-bottom: 8px;
    }

    .emoji-search-input {
      width: 100%;
      padding: 8px 12px;
      background: var(--theme-overlay);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 8px;
      color: var(--theme-text);
      font-size: 14px;
    }

    .emoji-search-input:focus {
      outline: none;
      border-color: var(--theme-foam);
    }

    .emoji-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1001;
      display: none;
    }

    .emoji-suggestions.show {
      display: block;
    }

    .emoji-suggestion {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .emoji-suggestion:hover {
      background: var(--theme-highlight-med);
    }

    .emoji-suggestion.selected {
      background: var(--theme-foam);
      color: var(--theme-base);
    }

    .emoji-suggestion-emoji {
      font-size: 20px;
      min-width: 24px;
    }

    .emoji-suggestion-info {
      flex: 1;
      min-width: 0;
    }

    .emoji-suggestion-name {
      font-weight: 500;
      font-size: 14px;
    }

    .emoji-suggestion-keywords {
      font-size: 12px;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Enhanced reaction picker */
    .reaction-picker-enhanced {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      position: absolute;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: scale(0.95);
      transition: all 0.2s ease;
      width: 300px;
      max-height: 400px;
    }

    .reaction-picker-enhanced.show {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
    }

    .emoji-tabs {
      display: flex;
      gap: 4px;
      border-bottom: 1px solid var(--theme-overlay);
      padding-bottom: 8px;
    }

    .emoji-tab {
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 16px;
      min-width: 32px;
      text-align: center;
    }

    .emoji-tab:hover {
      background: var(--theme-highlight-med);
    }

    .emoji-tab.active {
      background: var(--theme-foam);
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      max-height: 200px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .emoji-grid::-webkit-scrollbar {
      width: 6px;
    }

    .emoji-grid::-webkit-scrollbar-track {
      background: var(--theme-overlay);
      border-radius: 3px;
    }

    .emoji-grid::-webkit-scrollbar-thumb {
      background: var(--theme-highlight-med);
      border-radius: 3px;
    }

    .emoji-grid-item {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 20px;
    }

    .emoji-grid-item:hover {
      background: var(--theme-highlight-med);
      transform: scale(1.2);
    }

    /* Favorite emotes styles */
    .favorites-section {
      padding: 8px 12px;
      border-bottom: 1px solid var(--theme-overlay);
      background: linear-gradient(135deg, rgba(196, 167, 231, 0.05), rgba(156, 207, 216, 0.05));
    }

    .favorites-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--theme-text);
      margin-bottom: 8px;
    }

    .favorites-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
    }

    .favorite-emoji {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
      position: relative;
      background: rgba(196, 167, 231, 0.1);
    }

    .favorite-emoji:hover {
      background: var(--theme-highlight-med);
      transform: scale(1.1);
    }

    .favorite-star {
      position: absolute;
      top: -2px;
      right: -2px;
      background: var(--theme-gold);
      border-radius: 50%;
      width: 12px;
      height: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      color: var(--theme-base);
    }

    .emoji-item {
      position: relative;
    }

    .emoji-favorite-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      background: var(--theme-overlay);
      border: none;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 10px;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .emoji-item:hover .emoji-favorite-btn {
      display: flex;
    }

    .emoji-favorite-btn:hover {
      background: var(--theme-gold);
      color: var(--theme-base);
    }

    .emoji-favorite-btn.favorited {
      display: flex;
      background: var(--theme-gold);
      color: var(--theme-base);
    }

    .no-favorites {
      text-align: center;
      color: var(--theme-muted);
      font-size: 0.8rem;
      padding: 12px;
      font-style: italic;
    }

    /* Post Formatting Toolbar */
    .formatting-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--theme-overlay);
      background: var(--theme-overlay);
      border-radius: 8px 8px 0 0;
    }

    .format-btn {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 6px;
      color: var(--theme-text);
      cursor: pointer;
      padding: 6px 8px;
      font-size: 0.85rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
      min-width: 32px;
      justify-content: center;
    }

    .format-btn:hover {
      background: var(--theme-foam);
      color: var(--theme-base);
      transform: translateY(-1px);
    }

    .format-btn.active {
      background: var(--theme-foam);
      color: var(--theme-base);
      border-color: var(--theme-foam);
    }

    .format-btn i {
      font-size: 14px;
    }

    .format-divider {
      width: 1px;
      background: var(--theme-overlay);
      margin: 0 4px;
    }

    /* Enhanced textarea with formatting */
    .formatted-textarea {
      border-radius: 0 0 8px 8px !important;
      border-top: none !important;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.5;
    }

    /* Format preview styles */
    .format-preview {
      display: none;
      padding: 12px;
      border: 1px solid var(--theme-overlay);
      border-radius: 0 0 8px 8px;
      background: var(--theme-surface);
      font-family: inherit;
      line-height: 1.5;
      min-height: 60px;
      max-height: 200px;
      overflow-y: auto;
    }

    .format-preview.active {
      display: block;
    }

    /* Markdown rendering styles */
    .format-preview strong, .post-content strong {
      font-weight: 700;
      color: var(--theme-text);
    }

    .format-preview em, .post-content em {
      font-style: italic;
      color: var(--theme-foam);
    }

    .format-preview blockquote, .post-content blockquote {
      border-left: 4px solid var(--theme-foam);
      margin: 8px 0;
      padding-left: 12px;
      color: var(--theme-muted);
      font-style: italic;
    }

    .format-preview code, .post-content code {
      background: var(--theme-overlay);
      color: var(--theme-foam);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Fira Code', 'Monaco', monospace;
      font-size: 0.9em;
    }

    .format-preview pre, .post-content pre {
      background: var(--theme-overlay);
      color: var(--theme-text);
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
      border-left: 4px solid var(--theme-iris);
    }

    .format-preview pre code, .post-content pre code {
      background: none;
      padding: 0;
      color: inherit;
    }

    .format-preview .spoiler, .post-content .spoiler {
      background: var(--theme-overlay);
      color: var(--theme-overlay);
      padding: 2px 6px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
    }

    .format-preview .spoiler:hover, .post-content .spoiler:hover,
    .format-preview .spoiler.revealed, .post-content .spoiler.revealed {
      color: var(--theme-text);
      background: var(--theme-highlight-med);
    }

    .formatting-help {
      font-size: 0.75rem;
      color: var(--theme-muted);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .formatting-help-toggle {
      background: none;
      border: none;
      color: var(--theme-foam);
      cursor: pointer;
      text-decoration: underline;
      font-size: inherit;
    }

    .formatting-help-content {
      display: none;
      margin-top: 8px;
      padding: 8px;
      background: var(--theme-overlay);
      border-radius: 6px;
      font-size: 0.75rem;
      line-height: 1.4;
    }

    .formatting-help-content.active {
      display: block;
    }

    /* Clickable User Profiles */
    .user-link {
      color: var(--theme-foam);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
      cursor: pointer;
      border-radius: 4px;
      padding: 2px 4px;
      margin: -2px -4px;
    }

    .user-link:hover {
      color: var(--theme-iris);
      background: rgba(156, 207, 216, 0.1);
      text-decoration: underline;
    }

    .user-link:active {
      transform: scale(0.98);
    }

    .user-profile-popup {
      position: absolute;
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 1000;
      min-width: 250px;
      display: none;
      top: 100%;
      left: 0;
      margin-top: 8px;
    }

    .user-profile-popup.show {
      display: block;
    }

    .user-profile-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .user-profile-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--theme-foam), var(--theme-iris));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .user-profile-info h4 {
      color: var(--theme-text);
      font-weight: 600;
      margin: 0;
    }

    .user-profile-info .user-rank {
      font-size: 0.8rem;
      margin-top: 2px;
    }

    .user-profile-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 12px 0;
      font-size: 0.85rem;
    }

    .user-profile-stat {
      text-align: center;
      padding: 8px;
      background: var(--theme-overlay);
      border-radius: 8px;
    }

    .user-profile-stat-value {
      font-weight: 600;
      color: var(--theme-foam);
      display: block;
    }

    .user-profile-stat-label {
      color: var(--theme-muted);
      font-size: 0.75rem;
    }

    .user-profile-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .user-profile-btn {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--theme-overlay);
      border-radius: 8px;
      background: var(--theme-overlay);
      color: var(--theme-text);
      text-decoration: none;
      text-align: center;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }

    .user-profile-btn:hover {
      background: var(--theme-foam);
      color: var(--theme-base);
      border-color: var(--theme-foam);
    }

    /* XP and Leveling System */
    .level-badge {
      background: linear-gradient(135deg, var(--theme-gold), #e6a700);
      color: var(--theme-base);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 8px;
      box-shadow: 0 2px 6px rgba(231, 180, 0, 0.3);
    }

    .level-badge.prestige {
      background: linear-gradient(135deg, var(--theme-iris), var(--theme-love));
      box-shadow: 0 2px 6px rgba(196, 167, 231, 0.4);
    }

    .xp-bar-container {
      background: var(--theme-overlay);
      border-radius: 10px;
      height: 8px;
      overflow: hidden;
      margin: 4px 0;
      position: relative;
    }

    .xp-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--theme-foam), var(--theme-iris));
      border-radius: 10px;
      transition: width 0.3s ease;
      position: relative;
    }

    .xp-bar.leveling-up {
      animation: xpGlow 0.5s ease-in-out;
    }

    @keyframes xpGlow {
      0%, 100% { box-shadow: 0 0 5px var(--theme-foam); }
      50% { box-shadow: 0 0 15px var(--theme-foam), 0 0 25px var(--theme-iris); }
    }

    .xp-text {
      font-size: 0.7rem;
      color: var(--theme-muted);
      text-align: center;
      margin-top: 2px;
    }

    .level-up-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, var(--theme-foam), var(--theme-iris));
      color: white;
      padding: 20px 30px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 10000;
      display: none;
      text-align: center;
      min-width: 300px;
    }

    .level-up-notification.show {
      display: block;
      animation: levelUpPop 1s ease-out;
    }

    @keyframes levelUpPop {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      20% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .level-up-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .level-up-details {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .xp-reward-popup {
      position: absolute;
      background: var(--theme-foam);
      color: var(--theme-base);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      z-index: 1000;
      pointer-events: none;
      animation: xpRewardFloat 1.5s ease-out forwards;
    }

    @keyframes xpRewardFloat {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-30px); }
    }

    /* Level-based styling for usernames */
    .user-link.level-novice { color: #8e8e93; }
    .user-link.level-bronze { color: #cd7f32; }
    .user-link.level-silver { color: #c0c0c0; }
    .user-link.level-gold { color: var(--theme-gold); }
    .user-link.level-platinum { color: #e5e4e2; }
    .user-link.level-diamond { color: #b9f2ff; }
    .user-link.level-master { color: var(--theme-iris); }
    .user-link.level-grandmaster { color: var(--theme-love); }

    .level-prestige-indicator {
      display: inline-block;
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 6px solid var(--theme-gold);
      margin-left: 4px;
      transform: translateY(-1px);
    }

    .user-profile-level {
      text-align: center;
      margin: 12px 0;
      padding: 12px;
      background: linear-gradient(135deg, rgba(196, 167, 231, 0.1), rgba(156, 207, 216, 0.1));
      border-radius: 10px;
    }

    .user-profile-level-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--theme-gold);
      display: block;
    }

    .user-profile-level-title {
      font-size: 0.8rem;
      color: var(--theme-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* XP Widget Styles */
    .xp-widget {
      background: linear-gradient(135deg, var(--theme-overlay), var(--theme-surface));
      border: 1px solid var(--theme-highlight-med);
      border-radius: 12px;
      padding: 12px 16px;
      margin-right: 12px;
      min-width: 200px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .xp-widget-content {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .xp-widget-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .xp-widget-level {
      font-weight: 700;
      color: var(--theme-foam);
      font-size: 0.85rem;
    }

    .xp-widget-title {
      font-size: 0.75rem;
      color: var(--theme-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .xp-widget-progress {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .xp-widget-text {
      font-size: 0.7rem;
      color: var(--theme-muted);
      text-align: center;
    }

    /* More prominent XP bars */
    .xp-bar-container {
      height: 10px;
      border-radius: 8px;
      background: var(--theme-overlay);
      overflow: hidden;
      border: 1px solid var(--theme-highlight-med);
    }

    .xp-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--theme-foam), var(--theme-iris), var(--theme-gold));
      border-radius: 8px;
      transition: width 0.5s ease;
      position: relative;
      box-shadow: 0 0 10px rgba(156, 207, 216, 0.3);
    }

    .xp-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(180deg, rgba(255,255,255,0.3), transparent);
      border-radius: 8px 8px 0 0;
    }

    /* Larger, more visible level badges */
    .level-badge {
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 16px;
      box-shadow: 0 3px 8px rgba(231, 180, 0, 0.4);
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .level-badge.prestige {
      box-shadow: 0 3px 8px rgba(196, 167, 231, 0.5);
      animation: prestigeGlow 2s ease-in-out infinite alternate;
    }

    @keyframes prestigeGlow {
      0% { box-shadow: 0 3px 8px rgba(196, 167, 231, 0.5); }
      100% { box-shadow: 0 3px 12px rgba(196, 167, 231, 0.8), 0 0 20px rgba(196, 167, 231, 0.3); }
    }

    /* XP reward popup - make larger and more visible */
    .xp-reward-popup {
      background: linear-gradient(135deg, var(--theme-foam), var(--theme-gold));
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      box-shadow: 0 4px 12px rgba(156, 207, 216, 0.4);
      animation: xpRewardFloat 2s ease-out forwards;
    }

    @keyframes xpRewardFloat {
      0% { 
        opacity: 1; 
        transform: translateY(0) scale(1);
      }
      20% {
        transform: translateY(-10px) scale(1.1);
      }
      100% { 
        opacity: 0; 
        transform: translateY(-40px) scale(0.9);
      }
    }

    /* Level up notification - make even more dramatic */
    .level-up-notification {
      min-width: 400px;
      padding: 30px 40px;
      background: linear-gradient(135deg, var(--theme-foam), var(--theme-iris), var(--theme-gold));
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
      border: 3px solid rgba(255,255,255,0.3);
    }

    .level-up-notification.show {
      animation: levelUpPop 1.2s ease-out;
    }

    @keyframes levelUpPop {
      0% { 
        transform: translate(-50%, -50%) scale(0.7) rotate(-5deg); 
        opacity: 0; 
      }
      15% { 
        transform: translate(-50%, -50%) scale(1.15) rotate(2deg); 
        opacity: 1; 
      }
      30% { 
        transform: translate(-50%, -50%) scale(0.95) rotate(-1deg); 
      }
      100% { 
        transform: translate(-50%, -50%) scale(1) rotate(0deg); 
        opacity: 1; 
      }
    }

    /* Forum sharing styles */
    .forum-share-btn {
      background: var(--theme-overlay);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--theme-text);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }

    .forum-share-btn:hover {
      background: var(--theme-highlight-med);
      border-color: var(--theme-foam);
    }

    .share-modal .modal-content {
      max-width: 400px;
    }

    .share-link-container {
      display: flex;
      gap: 8px;
      margin: 16px 0;
    }

    .share-link-input {
      flex: 1;
      padding: 12px;
      background: var(--theme-overlay);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 8px;
      color: var(--theme-text);
      font-family: monospace;
      font-size: 12px;
    }

    .copy-link-btn {
      padding: 12px 16px;
      background: var(--theme-foam);
      border: none;
      border-radius: 8px;
      color: var(--theme-base);
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 600;
    }

    .copy-link-btn:hover {
      background: var(--theme-pine);
      transform: translateY(-1px);
    }

    .copy-link-btn.copied {
      background: var(--theme-love);
    }

    /* Forum Settings Styles */
    .settings-tab {
      padding: 12px 16px;
      border: none;
      background: transparent;
      color: var(--theme-muted);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 2px solid transparent;
      font-weight: 500;
    }

    .settings-tab:hover {
      color: var(--theme-text);
      background: var(--theme-highlight-med);
    }

    .settings-tab.active {
      color: var(--theme-foam);
      border-bottom-color: var(--theme-foam);
    }

    .settings-content {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-item {
      background: var(--theme-overlay);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 8px;
      padding: 12px;
      transition: all 0.2s ease;
    }

    .message-item:hover {
      border-color: var(--theme-foam);
      transform: translateY(-1px);
    }

    .forum-item {
      background: var(--theme-overlay);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s ease;
    }

    .forum-item:hover {
      border-color: var(--theme-foam);
      transform: translateY(-1px);
    }

    .forum-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .forum-action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--theme-highlight-med);
      background: transparent;
      color: var(--theme-text);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .forum-action-btn:hover {
      background: var(--theme-highlight-med);
    }

    .forum-action-btn.danger {
      border-color: var(--theme-love);
      color: var(--theme-love);
    }

    .forum-action-btn.danger:hover {
      background: var(--theme-love);
      color: var(--theme-base);
    }

    .message-meta {
      font-size: 12px;
      color: var(--theme-muted);
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .message-content {
      color: var(--theme-text);
      line-height: 1.4;
    }

    .forum-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 12px;
      color: var(--theme-muted);
    }

    .forum-stats {
      display: flex;
      gap: 16px;
    }

    .delete-confirmation {
      background: var(--theme-love);
      color: white;
      padding: 8px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 12px;
    }

    .delete-confirmation input {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      padding: 4px 8px;
      color: white;
      margin: 0 8px;
      width: 80px;
    }

    .delete-confirmation button {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      padding: 4px 8px;
      color: white;
      cursor: pointer;
      margin: 0 2px;
    }

    /* AI Chat Styles */
    .ai-chat-modal .modal-content {
      max-width: 700px;
      height: 600px;
      display: flex;
      flex-direction: column;
    }

    .ai-chat-header {
      padding: 20px;
      border-bottom: 1px solid var(--theme-overlay);
      background: linear-gradient(135deg, var(--theme-iris)/10, var(--theme-foam)/10);
    }

    .ai-chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .ai-message, .user-message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.4;
    }

    .user-message {
      align-self: flex-end;
      background: var(--theme-foam);
      color: var(--theme-base);
    }

    .ai-message {
      align-self: flex-start;
      background: var(--theme-overlay);
      color: var(--theme-text);
      border: 1px solid var(--theme-highlight-med);
    }

    .ai-message.thinking {
      opacity: 0.7;
      font-style: italic;
    }

    .ai-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--theme-iris), var(--theme-foam));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      margin-bottom: 8px;
    }

    .ai-chat-input {
      padding: 20px;
      border-top: 1px solid var(--theme-overlay);
      background: var(--theme-surface);
    }

    .ai-input-container {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .ai-input-field {
      flex: 1;
      min-height: 20px;
      max-height: 100px;
      padding: 12px 16px;
      border: 1px solid var(--theme-overlay);
      border-radius: 20px;
      background: var(--theme-overlay);
      color: var(--theme-text);
      resize: none;
      font-family: inherit;
    }

    .ai-input-field:focus {
      outline: none;
      border-color: var(--theme-foam);
    }

    .ai-send-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--theme-foam);
      border: none;
      color: var(--theme-base);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .ai-send-btn:hover {
      background: var(--theme-pine);
      transform: scale(1.05);
    }

    .ai-send-btn:disabled {
      background: var(--theme-muted);
      cursor: not-allowed;
      transform: none;
    }

    .ai-post-indicator {
      background: linear-gradient(135deg, var(--theme-iris), var(--theme-foam));
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .ai-post-indicator i {
      font-size: 12px;
    }

    .ai-quick-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .ai-action-btn {
      padding: 6px 12px;
      border: 1px solid var(--theme-overlay);
      border-radius: 16px;
      background: transparent;
      color: var(--theme-text);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
    }

    .ai-action-btn:hover {
      background: var(--theme-highlight-med);
      border-color: var(--theme-foam);
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--theme-muted);
      font-size: 14px;
    }

    .typing-dots {
      display: flex;
      gap: 2px;
    }

    .typing-dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--theme-muted);
      animation: typingBounce 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typingBounce {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Pinned Forum Styles */
    .forum-pinned {
      background: linear-gradient(135deg, rgba(196, 167, 231, 0.1), rgba(156, 207, 216, 0.1));
      border: 1px solid var(--theme-iris);
      position: relative;
    }

    .forum-pinned::before {
      content: '';
      position: absolute;
      top: -1px;
      left: -1px;
      right: -1px;
      height: 3px;
      background: linear-gradient(90deg, var(--theme-iris), var(--theme-foam));
      border-radius: 8px 8px 0 0;
    }

    .pin-icon {
      color: var(--theme-iris);
      font-size: 1.2rem;
      margin-right: 8px;
    }

    .pin-btn {
      background: transparent;
      border: 1px solid var(--theme-overlay);
      color: var(--theme-muted);
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
    }

    .pin-btn:hover {
      border-color: var(--theme-iris);
      color: var(--theme-iris);
      background: rgba(196, 167, 231, 0.1);
    }

    .pin-btn.pinned {
      background: var(--theme-iris);
      color: white;
      border-color: var(--theme-iris);
    }

    .pin-btn.pinned:hover {
      background: var(--theme-love);
      border-color: var(--theme-love);
    }

    /* Online users indicator */
    .online-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .online-indicator:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .online-users-list {
      display: none;
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 12px;
      min-width: 200px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }

    .online-indicator:hover .online-users-list {
      display: block;
    }

    .online-user-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px solid var(--theme-overlay);
    }

    .online-user-item:last-child {
      border-bottom: none;
    }

    .online-user-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--theme-foam), var(--theme-iris));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .online-user-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      margin-left: auto;
    }
  </style>
</head>

<body class="bg-rp-base min-h-screen text-rp-text font-[Inter] antialiased">
  <!-- Level Up Notification -->
  <div id="levelUpNotification" class="level-up-notification">
    <div class="level-up-title">ðŸŽ‰ Level Up!</div>
    <div class="level-up-details">
      <div>You reached <strong>Level <span id="newLevelNumber"></span></strong></div>
      <div><span id="levelTitleText"></span></div>
      <div style="margin-top: 8px; font-size: 0.8rem;">+<span id="xpRewardAmount"></span> XP Bonus!</div>
    </div>
  </div>

  <!-- Online Users Indicator -->
  <div class="online-indicator" id="onlineIndicator">
    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
    <span id="onlineCountIndicator">0</span>
    <span class="text-sm text-rp-muted">online</span>
    
    <div class="online-users-list" id="onlineUsersList">
      <div class="text-sm font-semibold text-rp-text mb-2">Online Users</div>
      <div id="onlineUsersContent">
        <div class="text-center text-rp-muted py-2">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Particles Canvas -->
  <canvas id="particles-canvas" class="fixed inset-0 pointer-events-none hidden"></canvas>

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-6 py-4 bg-rp-surface/80 border-b border-rp-overlay backdrop-blur-sm fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center gap-6">
      <a href="index.html" class="text-xl font-bold text-rp-foam tracking-tight">CARBON</a>
      <div class="hidden md:flex items-center gap-4">
        <a href="index.html" class="text-rp-subtle hover:text-rp-text transition-colors">Home</a>
        <a href="profile.html" class="text-rp-subtle hover:text-rp-text transition-colors">Profile</a>
        <a href="forum.html" class="text-rp-foam font-medium">Forum</a>
        <button id="achievementsBtn" onclick="showAchievementsModal()" class="text-rp-subtle hover:text-rp-text transition-colors hidden flex items-center gap-1">
          <i class='bx bx-trophy'></i>
          Achievements
        </button>
        <button id="shopBtn" onclick="openCarbonShop()" class="text-rp-subtle hover:text-rp-text transition-colors hidden flex items-center gap-1">
          <i class='bx bx-store'></i>
          Shop
        </button>
        <button id="forumSettingsBtn" onclick="showForumSettingsModal()" class="text-rp-subtle hover:text-rp-text transition-colors hidden flex items-center gap-1">
          <i class='bx bx-cog'></i>
          Settings
        </button>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div id="userSection"></div>
    </div>
  </nav>

  <!-- LOGIN PROMPT (Optional) -->
  <div id="loginPrompt" class="fixed top-20 right-6 bg-rp-surface rounded-xl shadow-2xl p-6 border border-rp-overlay max-w-sm z-40 hidden">
    <div class="text-center mb-6">
      <h3 class="text-lg font-bold text-rp-foam mb-2">Join the Discussion</h3>
      <p class="text-rp-subtle text-sm">Sign in to create forums and post messages</p>
    </div>
    <button onclick="googleSignIn()" class="w-full flex items-center justify-center gap-3 bg-rp-foam hover:bg-rp-foam/90 text-rp-base font-medium px-4 py-2 rounded-lg transition-all duration-200 mb-3">
      <i class='bx bxl-google text-lg'></i>
      Sign In
    </button>
    <button onclick="hideLoginPrompt()" class="w-full text-rp-muted hover:text-rp-text text-sm">
      Browse as Guest
    </button>
    <div id="loginError" class="text-rp-love mt-3 text-sm text-center hidden"></div>
  </div>

  <!-- MAIN FORUM CONTENT -->
  <main id="forumContent" class="pt-24 pb-16 max-w-7xl mx-auto px-6">
    <!-- Forum Header -->
    <div class="card p-8 mb-8">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
        <div>
          <h1 class="text-display text-rp-text mb-2">CARBON Forum</h1>
          <p class="text-rp-subtle">Connect, discuss, and share with the community. Create your own forums!</p>
          <div class="mt-3 flex items-center gap-6 text-sm text-rp-muted">
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
              <span id="onlineCount">0</span> users online
            </div>
            <div class="flex items-center gap-2">
              <i class='bx bx-pin text-rp-foam'></i>
              <span id="pinnedCount">0</span> pinned forums
            </div>
            <div class="flex items-center gap-2">
              <i class='bx bx-chat text-rp-iris'></i>
              <span id="totalForums">0</span> total forums
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div id="xpWidget" class="xp-widget hidden">
            <div class="xp-widget-content">
              <div class="xp-widget-header">
                <span class="xp-widget-level">Level <span id="headerLevel">1</span></span>
                <span class="xp-widget-title" id="headerLevelTitle">Newcomer</span>
              </div>
              <div class="xp-widget-progress">
                <div class="xp-bar-container">
                  <div class="xp-bar" id="headerXPBar" style="width: 0%"></div>
                </div>
                <div class="xp-widget-text">
                  <span id="headerCurrentXP">0</span> / <span id="headerNextLevelXP">100</span> XP
                </div>
              </div>
            </div>
          </div>
          <span id="userRank" class="rank-badge rank-member hidden">Guest</span>
          <button id="createForumBtn" class="btn-primary hidden" onclick="showCreateForumModal()">
            <i class='bx bx-plus mr-2'></i>
            Create Forum
          </button>
          <button id="signInBtn" class="btn-secondary" onclick="showLoginPrompt()">
            <i class='bx bx-log-in mr-2'></i>
            Sign In
          </button>
        </div>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="card p-6 mb-8">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <div class="relative">
            <input type="text" id="searchInput" placeholder="Search forums and posts..." class="search-input pl-12">
            <i class='bx bx-search absolute left-4 top-1/2 transform -translate-y-1/2 text-rp-muted'></i>
          </div>
        </div>
        <div class="flex gap-3">
          <select id="categoryFilter" class="search-input min-w-[150px]">
            <option value="">All Categories</option>
            <option value="general">General</option>
            <option value="gaming">Gaming</option>
            <option value="tech">Technology</option>
            <option value="support">Support</option>
            <option value="announcements">Announcements</option>
          </select>
          <select id="sortFilter" class="search-input min-w-[150px]">
            <option value="recent">Most Recent</option>
            <option value="popular">Most Popular</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Forum Categories -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="categoriesGrid">
      <!-- Categories will be loaded dynamically -->
    </div>

    <!-- Forum Lists -->
    <div class="space-y-6" id="forumsContainer">
      <!-- Forums will be loaded dynamically -->
    </div>

    <!-- Friends & Chat Sidebar -->
    <div id="friendsChatSidebar" class="fixed right-6 top-24 w-80 max-h-[calc(100vh-8rem)] bg-rp-surface rounded-xl border border-rp-overlay shadow-xl backdrop-blur-sm z-30 hidden">
      <!-- Friends List Header -->
      <div class="flex items-center justify-between p-4 border-b border-rp-overlay">
        <h3 class="text-lg font-semibold text-rp-text flex items-center gap-2">
          <i class='bx bx-group text-rp-foam'></i>
          Friends
        </h3>
        <div class="flex items-center gap-2">
          <button id="addFriendsBtn" class="p-2 text-rp-subtle hover:text-rp-foam hover:bg-rp-overlay/50 rounded-lg transition-all duration-200" title="Add Friends">
            <i class='bx bx-user-plus text-lg'></i>
          </button>
          <button id="closeFriendsSidebarBtn" class="p-2 text-rp-subtle hover:text-rp-love hover:bg-rp-love/10 rounded-lg transition-all duration-200">
            <i class='bx bx-x text-lg'></i>
          </button>
        </div>
      </div>

      <!-- Online Friends List -->
      <div class="p-4 max-h-60 overflow-y-auto">
        <h4 class="text-sm font-medium text-rp-text mb-3 flex items-center gap-2">
          <i class='bx bx-wifi text-rp-pine'></i>
          Online Now
        </h4>
        <div id="onlineFriendsListForum" class="space-y-2">
          <!-- Online friends will be populated here -->
        </div>
        <div id="noOnlineFriendsForum" class="text-rp-subtle text-sm text-center py-4">No friends online</div>
      </div>

      <!-- All Friends List -->
      <div class="p-4 border-t border-rp-overlay max-h-60 overflow-y-auto">
        <h4 class="text-sm font-medium text-rp-text mb-3 flex items-center gap-2">
          <i class='bx bx-user text-rp-foam'></i>
          All Friends
        </h4>
        <div id="allFriendsListForum" class="space-y-2">
          <!-- All friends will be populated here -->
        </div>
        <div id="noFriendsForum" class="text-rp-subtle text-sm text-center py-4">
          <i class='bx bx-user-circle text-2xl mb-2 block'></i>
          No friends yet
          <button onclick="showAddFriendsModal()" class="block mx-auto mt-2 px-3 py-1 bg-rp-foam/20 text-rp-foam rounded-lg hover:bg-rp-foam/30 transition-colors text-xs">
            Add Friends
          </button>
        </div>
      </div>
    </div>

    <!-- Friends Sidebar Toggle Button -->
    <button id="friendsSidebarToggle" class="fixed right-6 bottom-6 w-14 h-14 bg-rp-foam hover:bg-rp-foam/90 text-rp-base rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center z-20 hidden">
      <i class='bx bx-group text-xl'></i>
    </button>
  </main>

  <!-- Create Forum Modal -->
  <div id="createForumModal" class="modal">
    <div class="modal-content">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-heading text-rp-text">Create New Forum</h2>
        <button onclick="hideCreateForumModal()" class="text-rp-muted hover:text-rp-text">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      <form id="createForumForm" onsubmit="createForum(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-rp-text font-medium mb-2">Forum Name</label>
            <input type="text" id="forumName" class="search-input" placeholder="Enter forum name (3-50 characters)" maxlength="50" required>
            <p class="text-xs text-rp-muted mt-1">
              <span id="nameCharCount">0</span>/50 characters
            </p>
          </div>
          <div>
            <label class="block text-rp-text font-medium mb-2">Description</label>
            <textarea id="forumDescription" class="search-input" rows="3" placeholder="Describe what this forum is about (10-200 characters)" maxlength="200" required></textarea>
            <p class="text-xs text-rp-muted mt-1">
              <span id="descCharCount">0</span>/200 characters
            </p>
          </div>
          <div>
            <label class="block text-rp-text font-medium mb-2">Category</label>
            <select id="forumCategory" class="search-input" required>
              <option value="">Select a category</option>
              <option value="general">General</option>
              <option value="gaming">Gaming</option>
              <option value="tech">Technology</option>
              <option value="support">Support</option>
              <option value="announcements">Announcements</option>
            </select>
          </div>
          <div class="flex gap-3 pt-4">
            <button type="submit" class="btn-primary flex-1">
              <i class='bx bx-plus mr-2'></i>
              Create Forum
            </button>
            <button type="button" onclick="hideCreateForumModal()" class="btn-secondary">
              Cancel
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Forum View Modal -->
  <div id="forumViewModal" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
      <div class="flex items-center justify-between mb-6">
        <div class="flex-1">
          <h2 id="forumTitle" class="text-heading text-rp-text"></h2>
          <p id="forumDesc" class="text-rp-subtle"></p>
        </div>
        <div class="flex items-center gap-2">
          <button id="shareForumBtn" onclick="showShareForumModal()" class="forum-share-btn">
            <i class='bx bx-share'></i>
            Share
          </button>
          <button id="deleteForumBtn" onclick="confirmDeleteForum()" class="btn-danger text-sm hidden" title="Delete Forum">
            <i class='bx bx-trash mr-1'></i>
            Delete
          </button>
          <button onclick="hideForumViewModal()" class="text-rp-muted hover:text-rp-text">
            <i class='bx bx-x text-2xl'></i>
          </button>
        </div>
      </div>
      
      <!-- New Post Form -->
      <div class="card p-4 mb-6" id="newPostSection">
        <div id="guestPostMessage" class="text-center py-6">
          <i class='bx bx-message-add text-3xl text-rp-muted mb-3'></i>
          <p class="text-rp-subtle mb-4">Sign in to join the conversation and post in this forum</p>
          <button onclick="showLoginPrompt()" class="btn-primary">
            <i class='bx bx-log-in mr-2'></i>
            Sign In to Post
          </button>
        </div>
        <form id="newPostForm" onsubmit="createPost(event)" class="hidden">
          <div class="space-y-3">
            <input type="text" id="postTitle" class="search-input" placeholder="Post title..." required>
            <div class="formatting-toolbar">
              <button type="button" class="format-btn" onclick="applyFormat('bold')" title="Bold (Ctrl+B)">
                <i class='bx bx-bold'></i>
              </button>
              <button type="button" class="format-btn" onclick="applyFormat('italic')" title="Italic (Ctrl+I)">
                <i class='bx bx-italic'></i>
              </button>
              <div class="format-divider"></div>
              <button type="button" class="format-btn" onclick="applyFormat('quote')" title="Quote">
                <i class='bx bx-comment-dots'></i>
              </button>
              <button type="button" class="format-btn" onclick="applyFormat('code')" title="Inline Code">
                <i class='bx bx-code'></i>
              </button>
              <button type="button" class="format-btn" onclick="applyFormat('codeblock')" title="Code Block">
                <i class='bx bx-code-block'></i>
              </button>
              <button type="button" class="format-btn" onclick="applyFormat('spoiler')" title="Spoiler">
                <i class='bx bx-low-vision'></i>
              </button>
              <div class="format-divider"></div>
              <button type="button" class="format-btn" onclick="togglePreview()" title="Toggle Preview" id="previewToggle">
                <i class='bx bx-show'></i>
              </button>
            </div>
            <textarea id="postContent" class="search-input formatted-textarea" rows="3" placeholder="What's on your mind?" required></textarea>
            <div id="formatPreview" class="format-preview"></div>
            <div class="formatting-help">
              <span>Supports:</span>
              <button type="button" class="formatting-help-toggle" onclick="toggleFormattingHelp()">formatting help</button>
              <div class="formatting-help-content" id="formattingHelp">
                <strong>**bold**</strong> â€¢ <em>*italic*</em> â€¢ <code>`inline code`</code><br>
                <blockquote>&gt; quote</blockquote>
                <code>```code block```</code> â€¢ <span class="spoiler">||spoiler||</span>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <button type="button" id="askAiBtn" onclick="showAiChatModal()" class="btn-secondary flex items-center gap-2">
                <i class='bx bx-brain'></i>
                Ask AI
              </button>
              <div class="flex items-center gap-3">
                <div class="xp-reward-preview" style="font-size: 0.8rem; color: var(--theme-foam); display: flex; align-items: center; gap: 4px; background: rgba(156, 207, 216, 0.1); padding: 4px 8px; border-radius: 8px;">
                  <i class='bx bx-plus-circle'></i>
                  <span>+15 XP for posting</span>
                </div>
                <button type="submit" class="btn-primary">
                  <i class='bx bx-send mr-2'></i>
                  Post
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Posts Container -->
      <div id="postsContainer" class="space-y-4 max-h-96 overflow-y-auto">
        <!-- Posts will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="chatModal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 80vh;">
      <!-- Chat Header -->
      <div class="flex items-center justify-between mb-4 pb-4 border-b border-rp-overlay">
        <div class="flex items-center gap-3">
          <img id="chatFriendAvatar" src="" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
          <div>
            <h3 class="text-lg font-semibold text-rp-text">Chat with <span id="chatFriendName" class="text-rp-foam">Friend</span></h3>
            <p class="text-xs text-rp-subtle">Real-time messaging</p>
          </div>
        </div>
        <button onclick="hideChatModal()" class="text-rp-muted hover:text-rp-text">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      
      <!-- Chat Messages Area -->
      <div id="chatMessages" class="h-64 overflow-y-auto p-4 space-y-3 bg-rp-overlay/20 rounded-lg mb-4">
        <!-- Chat messages will be populated here -->
        <div id="chatPlaceholder" class="text-center text-rp-subtle text-sm py-8">
          <i class='bx bx-message-dots text-2xl mb-2 block'></i>
          Start a conversation with <span id="chatFriendNamePlaceholder" class="text-rp-foam">your friend</span>
        </div>
      </div>
      
      <!-- Chat Input Area -->
      <div class="flex gap-3 items-end">
        <div class="flex-1 relative">
          <input id="chatInput" type="text" maxlength="500" placeholder="Type your message..." 
                 class="w-full px-4 py-3 bg-rp-overlay border border-rp-highlight-med rounded-lg text-rp-text placeholder-rp-subtle focus:outline-none focus:ring-2 focus:ring-rp-foam/50 focus:border-rp-foam transition-all duration-200">
          <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-rp-subtle">
            <span id="charCount">0</span>/500
          </div>
        </div>
        <button id="sendMessageBtn" class="w-12 h-12 bg-rp-foam hover:bg-rp-foam/90 text-rp-base rounded-lg transition-all duration-200 flex items-center justify-center">
          <i class='bx bx-send text-lg'></i>
        </button>
      </div>
      <div class="flex items-center justify-between mt-2 text-xs text-rp-subtle">
        <span>Press Enter to send</span>
        <span id="typingIndicator" class="hidden">Friend is typing...</span>
      </div>
    </div>
  </div>

  <!-- Add Friends Modal -->
  <div id="addFriendsModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-heading text-rp-text">Add Friends</h2>
        <button onclick="hideAddFriendsModal()" class="text-rp-muted hover:text-rp-text">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      
      <!-- Search Users -->
      <div class="mb-6">
        <label class="block text-rp-text font-medium mb-2">Find Users</label>
        <div class="relative">
          <input type="text" id="userSearchInput" class="w-full px-4 py-3 pl-12 bg-rp-overlay border border-rp-highlight-med rounded-lg text-rp-text placeholder-rp-subtle focus:outline-none focus:ring-2 focus:ring-rp-foam/50" placeholder="Search by username or email...">
          <i class='bx bx-search absolute left-4 top-1/2 transform -translate-y-1/2 text-rp-muted'></i>
        </div>
      </div>
      
      <!-- Search Results -->
      <div id="userSearchResults" class="space-y-3 max-h-60 overflow-y-auto">
        <div id="searchPlaceholder" class="text-center text-rp-subtle py-8">
          <i class='bx bx-search text-3xl mb-2 block'></i>
          <p>Search for users to add as friends</p>
        </div>
      </div>
      
      <!-- Friend Requests -->
      <div id="friendRequestsSection" class="mt-6 pt-6 border-t border-rp-overlay">
        <h3 class="text-lg font-medium text-rp-text mb-4 flex items-center gap-2">
          <i class='bx bx-user-plus text-rp-iris'></i>
          Friend Requests
        </h3>
        <div id="friendRequestsList" class="space-y-3">
          <div id="noRequests" class="text-center text-rp-subtle py-4">
            No pending friend requests
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Forum Confirmation Modal -->
  <div id="deleteForumModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-rp-love/20 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class='bx bx-trash text-2xl text-rp-love'></i>
        </div>
        <h2 class="text-heading text-rp-text mb-2">Delete Forum</h2>
        <p class="text-rp-subtle">Are you sure you want to delete this forum?</p>
        <p class="text-rp-love text-sm mt-2">âš ï¸ This action cannot be undone. All posts and messages will be permanently lost.</p>
      </div>
      
      <div class="space-y-4">
        <div class="bg-rp-overlay/50 rounded-lg p-4">
          <h3 class="font-medium text-rp-text mb-2">Forum Details:</h3>
          <p class="text-sm text-rp-subtle"><strong>Name:</strong> <span id="deleteForumName"></span></p>
          <p class="text-sm text-rp-subtle"><strong>Posts:</strong> <span id="deleteForumPosts">0</span></p>
        </div>
        
        <div>
          <label class="block text-rp-text font-medium mb-2">
            Type "DELETE" to confirm:
          </label>
          <input type="text" id="deleteConfirmInput" class="search-input" placeholder="Type DELETE here" autocomplete="off">
        </div>
        
        <div class="flex gap-3">
          <button id="confirmDeleteBtn" onclick="deleteForum()" class="btn-danger flex-1" disabled>
            <i class='bx bx-trash mr-2'></i>
            Delete Forever
          </button>
          <button onclick="hideDeleteForumModal()" class="btn-secondary flex-1">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Achievements Modal -->
  <div id="achievementsModal" class="modal achievements-modal">
    <div class="modal-content">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-heading text-rp-text flex items-center gap-3">
          <i class='bx bx-trophy text-rp-gold'></i>
          Achievements
        </h2>
        <button onclick="hideAchievementsModal()" class="text-rp-muted hover:text-rp-text">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      
      <!-- User Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalAchievements">0</div>
          <div class="stat-label">Unlocked</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalPoints">0</div>
          <div class="stat-label">Points</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="completionRate">0%</div>
          <div class="stat-label">Completion</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="userRankDisplay">Newcomer</div>
          <div class="stat-label">Rank</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="forumsOwned">0</div>
          <div class="stat-label">Forums Owned</div>
        </div>
      </div>

      <!-- Achievement Categories -->
      <div class="mb-6">
        <div class="flex items-center gap-3 mb-4">
          <button class="achievement-filter active" data-category="all">All</button>
          <button class="achievement-filter" data-category="forum">Forum</button>
          <button class="achievement-filter" data-category="social">Social</button>
          <button class="achievement-filter" data-category="special">Special</button>
        </div>
      </div>
      
      <!-- Achievements Grid -->
      <div class="achievements-grid" id="achievementsGrid">
        <!-- Achievements will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Achievement Notification Template -->
  <div id="achievementNotificationTemplate" class="achievement-notification" style="display: none;">
    <div class="flex items-start gap-3">
      <div class="achievement-icon">
        <i class='bx bx-trophy'></i>
      </div>
      <div class="flex-1">
        <h4 class="font-bold text-rp-text mb-1">Achievement Unlocked!</h4>
        <p class="text-sm text-rp-subtle mb-2" id="achievementName">Achievement Name</p>
        <div class="achievement-badge" id="achievementBadge">
          <i class='bx bx-star'></i>
          <span>+10 XP</span>
        </div>
      </div>
      <button onclick="hideAchievementNotification(this)" class="text-rp-muted hover:text-rp-text">
        <i class='bx bx-x'></i>
      </button>
    </div>
  </div>

  <!-- Share Forum Modal -->
  <div id="shareForumModal" class="modal share-modal">
    <div class="modal-content">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-heading text-rp-text flex items-center gap-3">
          <i class='bx bx-share text-rp-foam'></i>
          Share Forum
        </h2>
        <button onclick="hideShareForumModal()" class="text-rp-muted hover:text-rp-text">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      
      <div class="mb-4">
        <h3 class="font-bold text-rp-text mb-2" id="shareForumName">Forum Name</h3>
        <p class="text-rp-subtle mb-4" id="shareForumDescription">Forum description</p>
        
        <div class="share-link-container">
          <input type="text" id="shareForumLink" class="share-link-input" readonly placeholder="Generating link..." />
          <button id="copyLinkBtn" onclick="copyForumLink()" class="copy-link-btn">
            <i class='bx bx-copy'></i>
            Copy
          </button>
        </div>
        
        <div class="text-sm text-rp-subtle">
          <i class='bx bx-info-circle'></i>
          Share this link to invite others to join this forum
        </div>
      </div>
    </div>
  </div>

  <!-- AI Chat Modal -->
  <div id="aiChatModal" class="modal ai-chat-modal">
    <div class="modal-content">
      <div class="ai-chat-header">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="ai-avatar">
              <i class='bx bx-brain'></i>
            </div>
            <div>
              <h2 class="text-lg font-bold text-rp-text">Forum AI Assistant</h2>
              <p class="text-sm text-rp-muted">Ask questions, get help, or discuss ideas</p>
            </div>
          </div>
          <button onclick="hideAiChatModal()" class="text-rp-muted hover:text-rp-text">
            <i class='bx bx-x text-2xl'></i>
          </button>
        </div>
      </div>
      
      <div class="ai-chat-messages" id="aiChatMessages">
        <div class="ai-message">
          <div class="ai-avatar">
            <i class='bx bx-brain'></i>
          </div>
          <div>
            Hello! I'm your AI assistant. I can help you with discussions, answer questions, or even create forum posts. What would you like to talk about?
          </div>
          <div class="ai-quick-actions">
            <button class="ai-action-btn" onclick="quickAsk('What are the forum rules?')">Forum Rules</button>
            <button class="ai-action-btn" onclick="quickAsk('Help me write a post about technology')">Write a Post</button>
            <button class="ai-action-btn" onclick="quickAsk('Explain this topic in simple terms')">Explain Topic</button>
          </div>
        </div>
      </div>
      
      <div class="ai-chat-input">
        <div class="ai-input-container">
          <textarea 
            id="aiChatInput" 
            class="ai-input-field" 
            placeholder="Type your message to AI..."
            rows="1"
            onkeydown="handleAiInputKeydown(event)"
            oninput="autoResizeInput(this)"></textarea>
          <button id="aiSendBtn" class="ai-send-btn" onclick="sendAiMessage()">
            <i class='bx bx-send'></i>
          </button>
        </div>
        <div class="mt-3 flex items-center justify-between text-xs text-rp-muted">
          <div class="flex items-center gap-4">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="postAsForumPost" class="rounded">
              <span>Post AI response to forum</span>
            </label>
          </div>
          <div>Press Enter to send, Shift+Enter for new line</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Forum Settings Modal -->
  <div id="forumSettingsModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-heading text-rp-text flex items-center gap-3">
          <i class='bx bx-cog text-rp-foam'></i>
          Forum Settings
        </h2>
        <button onclick="hideForumSettingsModal()" class="text-rp-muted hover:text-rp-text">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      
      <!-- Settings Tabs -->
      <div class="flex border-b border-rp-overlay mb-6">
        <button class="settings-tab active" data-tab="messages" onclick="switchSettingsTab('messages')">
          <i class='bx bx-message'></i>
          Message History
        </button>
        <button class="settings-tab" data-tab="forums" onclick="switchSettingsTab('forums')">
          <i class='bx bx-collection'></i>
          My Forums
        </button>
        <button class="settings-tab" data-tab="stats" onclick="switchSettingsTab('stats')">
          <i class='bx bx-chart'></i>
          Statistics
        </button>
      </div>
      
      <!-- Message History Tab -->
      <div id="settings-messages" class="settings-content">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-rp-text">Your Recent Messages</h3>
          <div class="text-sm text-rp-subtle" id="messageCount">Loading...</div>
        </div>
        
        <div class="space-y-3" id="messageHistoryList">
          <!-- Messages will be loaded here -->
        </div>
        
        <div class="text-center py-8 hidden" id="noMessages">
          <i class='bx bx-message text-4xl text-rp-muted mb-2'></i>
          <p class="text-rp-muted">No messages found</p>
        </div>
      </div>
      
      <!-- My Forums Tab -->
      <div id="settings-forums" class="settings-content hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-rp-text">Forums You Own</h3>
          <div class="text-sm text-rp-subtle" id="forumCount">Loading...</div>
        </div>
        
        <div class="space-y-4" id="ownedForumsList">
          <!-- Owned forums will be loaded here -->
        </div>
        
        <div class="text-center py-8 hidden" id="noForums">
          <i class='bx bx-collection text-4xl text-rp-muted mb-2'></i>
          <p class="text-rp-muted">You haven't created any forums yet</p>
          <button onclick="hideForumSettingsModal(); showCreateForumModal();" class="mt-3 btn-primary">
            Create Your First Forum
          </button>
        </div>
      </div>
      
      <!-- Statistics Tab -->
      <div id="settings-stats" class="settings-content hidden">
        <h3 class="text-lg font-bold text-rp-text mb-4">Your Forum Statistics</h3>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="stat-card">
            <div class="stat-value" id="statsForumPosts">0</div>
            <div class="stat-label">Posts Created</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statsForumsCreated">0</div>
            <div class="stat-label">Forums Created</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statsReactionsGiven">0</div>
            <div class="stat-label">Reactions Given</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statsMessagesSent">0</div>
            <div class="stat-label">Messages Sent</div>
          </div>
        </div>
        
        <div class="bg-rp-surface border border-rp-overlay rounded-lg p-4">
          <h4 class="font-bold text-rp-text mb-3">Activity Overview</h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-rp-subtle">Account Created:</span>
              <span class="text-rp-text" id="statsJoinDate">Loading...</span>
            </div>
            <div class="flex justify-between">
              <span class="text-rp-subtle">Achievement Points:</span>
              <span class="text-rp-text" id="statsAchievementPoints">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-rp-subtle">Current Rank:</span>
              <span class="text-rp-text" id="statsCurrentRank">Newcomer</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // FIREBASE CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
      authDomain: "carbon-services.firebaseapp.com",
      projectId: "carbon-services",
      storageBucket: "carbon-services.firebasestorage.app",
      messagingSenderId: "288385472070",
      appId: "1:288385472070:web:c4be3ff186e248fc645c47",
      measurementId: "G-Y2K1RQYE74"
    };

    // Initialize Firebase with proper app management
    let app, auth, db;
    let firebaseInitialized = false;
    
    function initializeFirebase() {
      if (firebaseInitialized) {
        return true;
      }
      
      try {
        if (typeof firebase === 'undefined') {
          console.log('Firebase SDK not yet loaded, will retry...');
          return false;
        }

        // Check if Firebase app already exists
        try {
          app = firebase.app();
          console.log('Using existing Firebase app');
        } catch (error) {
          // App doesn't exist, create it
          app = firebase.initializeApp(firebaseConfig);
          console.log('Created new Firebase app');
        }

        // Get auth and firestore instances
        auth = app.auth();
        db = app.firestore();
        
        // Enable auth persistence (this should be set consistently across pages)
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
          .then(() => {
            console.log('Auth persistence set to LOCAL');
          })
          .catch((error) => {
            console.warn('Failed to set auth persistence:', error);
          });
        
        // Set global references for compatibility
        window.auth = auth;
        window.db = db;
        window.firebase = firebase;
        
        firebaseInitialized = true;
        console.log('Firebase initialized successfully');
        return true;
      } catch (error) {
        console.error('Error initializing Firebase:', error);
        return false;
      }
    }

    // Wait for Firebase SDK to load, then initialize
    function waitForFirebaseAndInitialize() {
      if (typeof firebase !== 'undefined') {
        initializeFirebase();
      } else {
        setTimeout(waitForFirebaseAndInitialize, 100);
      }
    }

    // Start initialization process
    waitForFirebaseAndInitialize();

    // Global variables
    let currentUser = null;
    let userRank = 'member';
    let currentForumId = null;
    let badWordsFilter = null;
    let activeChatUser = null;
    let friendsList = [];
    let onlineFriends = [];
    let chatUnsubscribe = null;
    let activeReactionPicker = null;
    let reactionListeners = new Map();
    let userCache = new Map();
    let userAchievements = [];
    let achievementDefinitions = [];
    
    // Shop data
    let userCurrency = 100; // Starting currency
    let userFrames = [];
    let userPets = [];
    let userProfileFrames = [];
    let userPetData = {};
    
    const gameFrames = [
      { id: 'fire', name: 'Fire Frame', description: 'Blazing hot border for intense games', color: '#ff4444', price: 150 },
      { id: 'ice', name: 'Ice Frame', description: 'Cool blue frame for chill gaming', color: '#44aaff', price: 150 },
      { id: 'galaxy', name: 'Galaxy Frame', description: 'Cosmic purple border from outer space', color: '#8844ff', price: 200 },
      { id: 'neon', name: 'Neon Frame', description: 'Bright cyan glow for cyber vibes', color: '#00ffff', price: 250 },
      { id: 'gold', name: 'Golden Frame', description: 'Luxurious gold border for winners', color: '#ffd700', price: 300 }
    ];
    
    const pets = [
      { id: 'cat', name: 'Digital Cat', description: 'A cute virtual kitten', emoji: 'ðŸ±', rarity: 'common', price: 50, basePower: 10 },
      { id: 'dog', name: 'Cyber Dog', description: 'Loyal digital companion', emoji: 'ðŸ¶', rarity: 'common', price: 50, basePower: 12 },
      { id: 'dragon', name: 'Pixel Dragon', description: 'Mythical digital beast', emoji: 'ðŸ²', rarity: 'rare', price: 200, basePower: 25 },
      { id: 'robot', name: 'AI Bot', description: 'Advanced artificial companion', emoji: 'ðŸ¤–', rarity: 'epic', price: 400, basePower: 35 },
      { id: 'unicorn', name: 'Rainbow Unicorn', description: 'Magical legendary creature', emoji: 'ðŸ¦„', rarity: 'legendary', price: 800, basePower: 50 }
    ];
    
    const profileFrames = [
      { id: 'silver', name: 'Silver Frame', description: 'Elegant silver border', color: '#c0c0c0', price: 100 },
      { id: 'gold', name: 'Gold Frame', description: 'Premium golden border', color: '#ffd700', price: 250 },
      { id: 'rainbow', name: 'Rainbow Frame', description: 'Colorful animated border', color: '#ff69b4', price: 500 },
      { id: 'diamond', name: 'Diamond Frame', description: 'Sparkling crystal border', color: '#b9f2ff', price: 750 }
    ];

    // Initialize content filter when available
    function initializeContentFilter() {
      try {
        if (typeof Filter !== 'undefined') {
          badWordsFilter = new Filter();
          console.log('Content filter initialized successfully');
        } else {
          console.log('Filter class not found, using basic sanitization only');
        }
      } catch (error) {
        console.warn('Error initializing content filter:', error);
        badWordsFilter = null;
      }
    }

    // Initialize content filter after a small delay to ensure Filter class is loaded
    setTimeout(initializeContentFilter, 50);

    // Initialize achievement definitions
    function initializeAchievements() {
      achievementDefinitions = [
        // Forum Achievements
        {
          id: 'first_post',
          name: 'First Steps',
          description: 'Create your first forum post',
          icon: 'bx-edit',
          category: 'forum',
          rarity: 'common',
          points: 10,
          condition: (stats) => stats.forumPosts >= 1
        },
        {
          id: 'post_master',
          name: 'Post Master',
          description: 'Create 10 forum posts',
          icon: 'bx-message-detail',
          category: 'forum',
          rarity: 'rare',
          points: 50,
          condition: (stats) => stats.forumPosts >= 10
        },
        {
          id: 'forum_creator',
          name: 'Forum Founder',
          description: 'Create your first forum',
          icon: 'bx-plus-circle',
          category: 'forum',
          rarity: 'rare',
          points: 75,
          condition: (stats) => stats.forumsCreated >= 1
        },
        {
          id: 'prolific_creator',
          name: 'Prolific Creator',
          description: 'Create 5 forums',
          icon: 'bx-crown',
          category: 'forum',
          rarity: 'epic',
          points: 200,
          condition: (stats) => stats.forumsCreated >= 5
        },
        {
          id: 'reaction_giver',
          name: 'Reactor',
          description: 'Give 25 reactions to posts',
          icon: 'bx-heart',
          category: 'forum',
          rarity: 'common',
          points: 25,
          condition: (stats) => stats.reactionsGiven >= 25
        },
        {
          id: 'popular_post',
          name: 'Popular',
          description: 'Receive 10 reactions on a single post',
          icon: 'bx-trending-up',
          category: 'forum',
          rarity: 'rare',
          points: 100,
          condition: (stats) => stats.maxReactionsOnPost >= 10
        },

        // Social Achievements
        {
          id: 'first_friend',
          name: 'Social Butterfly',
          description: 'Add your first friend',
          icon: 'bx-user-plus',
          category: 'social',
          rarity: 'common',
          points: 20,
          condition: (stats) => stats.friendsCount >= 1
        },
        {
          id: 'friend_collector',
          name: 'Friend Collector',
          description: 'Have 10 friends',
          icon: 'bx-group',
          category: 'social',
          rarity: 'rare',
          points: 75,
          condition: (stats) => stats.friendsCount >= 10
        },
        {
          id: 'chat_starter',
          name: 'Conversationalist',
          description: 'Send 50 chat messages',
          icon: 'bx-chat',
          category: 'social',
          rarity: 'common',
          points: 30,
          condition: (stats) => stats.messagesSent >= 50
        },
        {
          id: 'chat_master',
          name: 'Chat Master',
          description: 'Send 500 chat messages',
          icon: 'bx-message-rounded-dots',
          category: 'social',
          rarity: 'epic',
          points: 150,
          condition: (stats) => stats.messagesSent >= 500
        },
        {
          id: 'forum_messenger',
          name: 'Forum Messenger',
          description: 'Send 25 messages in forums',
          icon: 'bx-comment-detail',
          category: 'forum',
          rarity: 'common',
          points: 30,
          condition: (stats) => stats.forumMessagesSent >= 25
        },
        {
          id: 'active_poster',
          name: 'Active Poster',
          description: 'Send 100 messages in forums',
          icon: 'bx-comment-dots',
          category: 'forum',
          rarity: 'rare',
          points: 75,
          condition: (stats) => stats.forumMessagesSent >= 100
        },
        {
          id: 'ai_curious',
          name: 'AI Curious',
          description: 'Have your first conversation with AI',
          icon: 'bx-brain',
          category: 'special',
          rarity: 'common',
          points: 20,
          condition: (stats) => stats.aiMessagesExchanged >= 1
        },
        {
          id: 'ai_collaborator',
          name: 'AI Collaborator',
          description: 'Post 5 AI responses to forums',
          icon: 'bx-bot',
          category: 'special',
          rarity: 'rare',
          points: 100,
          condition: (stats) => stats.aiForumPosts >= 5
        },

        // Special Achievements
        {
          id: 'early_adopter',
          name: 'Early Adopter',
          description: 'Join during the first week',
          icon: 'bx-time',
          category: 'special',
          rarity: 'epic',
          points: 250,
          condition: (stats) => {
            const joinDate = new Date(stats.joinedAt);
            const launchDate = new Date('2024-01-01'); // Adjust launch date
            return (joinDate - launchDate) < (7 * 24 * 60 * 60 * 1000);
          }
        },
        {
          id: 'daily_visitor',
          name: 'Daily Visitor',
          description: 'Visit the forum for 7 consecutive days',
          icon: 'bx-calendar-check',
          category: 'special',
          rarity: 'rare',
          points: 100,
          condition: (stats) => stats.consecutiveDays >= 7
        },
        {
          id: 'night_owl',
          name: 'Night Owl',
          description: 'Post between midnight and 6 AM',
          icon: 'bx-moon',
          category: 'special',
          rarity: 'common',
          points: 15,
          condition: (stats) => stats.lateNightPosts >= 1
        },
        {
          id: 'century_club',
          name: 'Century Club',
          description: 'Reach 100 total forum posts',
          icon: 'bx-trophy',
          category: 'forum',
          rarity: 'legendary',
          points: 500,
          condition: (stats) => stats.forumPosts >= 100
        },
        {
          id: 'social_hub',
          name: 'Social Hub',
          description: 'Have 50 friends',
          icon: 'bx-network-chart',
          category: 'social',
          rarity: 'legendary',
          points: 300,
          condition: (stats) => stats.friendsCount >= 50
        }
      ];
    }

    initializeAchievements();

    // XSS Protection Functions using DOMPurify
    function sanitizeHTML(dirty) {
      return DOMPurify.sanitize(dirty, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
    }

    function sanitizeHTMLWithBasicTags(dirty) {
      return DOMPurify.sanitize(dirty, { 
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'br', 'p'], 
        ALLOWED_ATTR: [] 
      });
    }

    function sanitizeText(text) {
      if (!text) return '';
      let sanitized = sanitizeHTML(String(text));
      // Apply bad words filter if available
      if (badWordsFilter) {
        sanitized = badWordsFilter.clean(sanitized);
      }
      return sanitized;
    }

    function sanitizeContent(content) {
      if (!content) return '';
      let sanitized = sanitizeHTMLWithBasicTags(String(content));
      // Apply bad words filter if available
      if (badWordsFilter) {
        sanitized = badWordsFilter.clean(sanitized);
      }
      return sanitized;
    }

    // AUTHENTICATION FUNCTIONS
    function googleSignIn() {
      // Ensure Firebase is initialized
      if (!auth && !initializeFirebase()) {
        console.error('Firebase not initialized');
        return;
      }
      
      const authInstance = auth || window.auth;
      if (!authInstance) {
        console.error('Firebase Auth not available');
        return;
      }
      
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({
        prompt: 'select_account'
      });
      
      // Try popup first, fallback to redirect if COOP blocks it
      authInstance.signInWithPopup(provider)
        .then((result) => {
          console.log('Successfully signed in via popup');
          hideLoginPrompt();
        })
        .catch((error) => {
          console.log('Popup blocked, trying redirect method:', error.code);
          
          // If popup is blocked due to COOP or other reasons, use redirect
          if (error.code === 'auth/popup-blocked' || 
              error.code === 'auth/popup-closed-by-user' ||
              error.message.includes('Cross-Origin-Opener-Policy') ||
              error.message.includes('popup')) {
            
            console.log('Using redirect method due to popup restrictions');
            
            // Show user that redirect is happening
            const loginError = document.getElementById('loginError');
            if (loginError) {
              loginError.innerText = 'Redirecting to Google sign-in...';
              loginError.classList.remove('hidden');
            }
            
            // Use redirect method as fallback
            authInstance.signInWithRedirect(provider);
          } else {
            // Show other errors to user
            const loginError = document.getElementById('loginError');
            if (loginError) {
              loginError.innerText = error.message;
              loginError.classList.remove('hidden');
            }
          }
        });
    }

    function signOut() {
      // Cleanup presence before signing out
      cleanupPresence();
      
      const authInstance = auth || window.auth;
      if (authInstance) {
        authInstance.signOut().then(() => {
          // Clear local state
          currentUser = null;
          userRank = 'member';
          // Reload to reset all UI
          location.reload();
        });
      }
    }

    // USER MANAGEMENT FUNCTIONS
    async function ensureUserDoc(user) {
      const userRef = db.collection('users').doc(user.uid);
      const doc = await userRef.get();
      if (!doc.exists) {
        await userRef.set({
          displayName: user.displayName || "",
          photoURL: user.photoURL || "",
          email: user.email || "",
          username: "",
          rank: "member",
          joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
          status: "online",
          forumPosts: 0,
          forumsCreated: 0,
          reputation: 0,
          friends: [],
          blockedUsers: [],
          messagesSent: 0,
          reactionsGiven: 0,
          maxReactionsOnPost: 0,
          consecutiveDays: 0,
          lateNightPosts: 0,
          forumMessagesSent: 0,
          aiMessagesExchanged: 0,
          aiForumPosts: 0,
          totalAchievementPoints: 0,
          achievements: {},
          currency: 100,
          frames: [],
          pets: [],
          profileFrames: []
        });
      } else {
        // Update last seen and status for existing users
        await userRef.update({
          lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
          status: "online"
        });
      }
    }

    async function getUserRank(uid) {
      try {
        const doc = await db.collection('users').doc(uid).get();
        if (doc.exists) {
          const userData = doc.data();
          return userData.rank || 'member';
        }
        return 'member';
      } catch (error) {
        console.error('Error getting user rank:', error);
        return 'member';
      }
    }

    async function updateUserRank(uid, rank) {
      try {
        await db.collection('users').doc(uid).update({
          rank: rank,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.error('Error updating user rank:', error);
      }
    }

    // FORUM FUNCTIONS
    async function loadCategories() {
      const categories = [
        { id: 'general', name: 'General Discussion', icon: 'bx-chat', color: '#9ccfd8', description: 'General community discussions' },
        { id: 'gaming', name: 'Gaming', icon: 'bx-game', color: '#eb6f92', description: 'Gaming discussions and tips' },
        { id: 'tech', name: 'Technology', icon: 'bx-code-alt', color: '#f6c177', description: 'Tech news and discussions' },
        { id: 'support', name: 'Support', icon: 'bx-help-circle', color: '#c4a7e7', description: 'Get help and support' },
        { id: 'announcements', name: 'Announcements', icon: 'bx-megaphone', color: '#31748f', description: 'Official announcements' }
      ];

      const categoriesGrid = document.getElementById('categoriesGrid');
      categoriesGrid.innerHTML = categories.map(category => `
        <div class="category-card" onclick="filterByCategory('${category.id}')">
          <div class="category-icon" style="background: ${category.color}20; color: ${category.color};">
            <i class='bx ${category.icon}'></i>
          </div>
          <h3 class="font-bold text-rp-text mb-2">${sanitizeText(category.name)}</h3>
          <p class="text-rp-subtle text-sm">${sanitizeText(category.description)}</p>
        </div>
      `).join('');
    }

    async function loadForums() {
      try {
        const querySnapshot = await db.collection('forums').orderBy('createdAt', 'desc').get();
        const forums = [];
        querySnapshot.forEach((doc) => {
          forums.push({ id: doc.id, ...doc.data() });
        });

        displayForums(forums);
      } catch (error) {
        console.error('Error loading forums:', error);
      }
    }

    function displayForums(forums) {
      const container = document.getElementById('forumsContainer');
      if (forums.length === 0) {
        container.innerHTML = `
          <div class="card p-8 text-center">
            <i class='bx bx-chat text-4xl text-rp-muted mb-4'></i>
            <h3 class="text-subheading text-rp-text mb-2">No forums found</h3>
            <p class="text-rp-subtle mb-4">Be the first to create a forum and start a discussion!</p>
            ${currentUser ? '<button onclick="showCreateForumModal()" class="btn-primary"><i class="bx bx-plus mr-2"></i>Create First Forum</button>' : '<button onclick="showLoginPrompt()" class="btn-secondary"><i class="bx bx-log-in mr-2"></i>Sign In to Create Forums</button>'}
          </div>
        `;
        updateForumCounts(0, 0);
        return;
      }

      // Separate pinned and regular forums
      const pinnedForums = forums.filter(forum => forum.isPinned);
      const regularForums = forums.filter(forum => !forum.isPinned);
      
      let html = '';
      
      // Display pinned forums first
      if (pinnedForums.length > 0) {
        html += '<div class="mb-6"><h2 class="text-lg font-semibold text-rp-text mb-4 flex items-center gap-2"><i class="bx bx-pin text-rp-iris"></i>Pinned Forums</h2>';
        html += pinnedForums.map(forum => generateForumHTML(forum, true)).join('');
        html += '</div>';
      }
      
      // Display regular forums
      if (regularForums.length > 0) {
        if (pinnedForums.length > 0) {
          html += '<div class="mb-6"><h2 class="text-lg font-semibold text-rp-text mb-4">All Forums</h2>';
        }
        html += regularForums.map(forum => generateForumHTML(forum, false)).join('');
        if (pinnedForums.length > 0) {
          html += '</div>';
        }
      }

      container.innerHTML = html;
      updateForumCounts(forums.length, pinnedForums.length);
    }

    function generateForumHTML(forum, isPinned) {
      const isOwner = currentUser && forum.createdById === currentUser.uid;
      const canDelete = isOwner || (currentUser && (userRank === 'owner' || userRank === 'admin'));
      const canPin = currentUser && (userRank === 'owner' || userRank === 'admin' || userRank === 'moderator');
      
      return `
        <div class="card p-6 card-hover cursor-pointer ${isPinned ? 'forum-pinned' : ''}" onclick="openForum('${forum.id}', '${sanitizeText(forum.name)}', '${sanitizeText(forum.description)}')">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                ${isPinned ? '<i class="bx bx-pin pin-icon"></i>' : ''}
                <h3 class="text-subheading text-rp-text font-bold">${sanitizeText(forum.name)}</h3>
                <span class="rank-badge" style="background: var(--theme-${forum.category === 'announcements' ? 'love' : 'overlay'});">
                  ${sanitizeText(forum.category)}
                </span>
                ${isOwner ? '<span class="rank-badge rank-owner text-xs">Your Forum</span>' : ''}
              </div>
              <p class="text-rp-subtle mb-4">${sanitizeText(forum.description)}</p>
              <div class="flex items-center gap-4 text-sm text-rp-muted">
                <span><i class='bx bx-message mr-1'></i>${forum.postCount || 0} posts</span>
                <span><i class='bx bx-user mr-1'></i>Created by ${sanitizeText(forum.createdBy)}</span>
                <span><i class='bx bx-time mr-1'></i>${formatDate(forum.createdAt)}</span>
              </div>
            </div>
            <div class="flex flex-col items-end gap-2">
              <div class="flex items-center gap-2" onclick="event.stopPropagation();">
                ${canPin ? `
                  <button class="pin-btn ${isPinned ? 'pinned' : ''}" onclick="toggleForumPin('${forum.id}', ${!isPinned})" title="${isPinned ? 'Unpin' : 'Pin'} forum">
                    <i class='bx ${isPinned ? 'bx-pin' : 'bx-pin'}'></i>
                    ${isPinned ? 'Unpin' : 'Pin'}
                  </button>
                ` : ''}
                ${canDelete ? '<i class="bx bx-trash text-rp-love text-sm opacity-0 group-hover:opacity-100 transition-opacity" title="You can delete this forum"></i>' : ''}
              </div>
              <i class='bx bx-chevron-right text-2xl text-rp-muted'></i>
            </div>
          </div>
        </div>
      `;
    }

    async function createForum(event) {
      event.preventDefault();
      
      if (!currentUser) {
        showLoginPrompt();
        hideCreateForumModal();
        return;
      }

      const name = document.getElementById('forumName').value.trim();
      const description = document.getElementById('forumDescription').value.trim();
      const category = document.getElementById('forumCategory').value;

      // Validate inputs
      if (!name || name.length < 3) {
        alert('Forum name must be at least 3 characters long');
        return;
      }
      
      if (name.length > 50) {
        alert('Forum name must be 50 characters or less');
        return;
      }
      
      if (!description || description.length < 10) {
        alert('Forum description must be at least 10 characters long');
        return;
      }
      
      if (description.length > 200) {
        alert('Forum description must be 200 characters or less');
        return;
      }

      try {
        // Check if forum name already exists
        const existingForum = await db.collection('forums')
          .where('name', '==', sanitizeText(name))
          .get();
        
        if (!existingForum.empty) {
          alert('A forum with this name already exists. Please choose a different name.');
          return;
        }

        await db.collection('forums').add({
          name: sanitizeText(name),
          description: sanitizeText(description),
          category: category,
          createdBy: sanitizeText(currentUser.displayName || 'Anonymous'),
          createdById: currentUser.uid,
          createdByRank: userRank,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          postCount: 0,
          lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
          isActive: true,
          memberCount: 1,
          moderators: [currentUser.uid] // Creator becomes moderator of their forum
        });

        // Update user's forum creation count and check achievements
        await db.collection('users').doc(currentUser.uid).update({
          forumsCreated: firebase.firestore.FieldValue.increment(1)
        });

        // Check for achievements
        const stats = await getUserStats();
        await checkAchievements(stats);

        hideCreateForumModal();
        document.getElementById('createForumForm').reset();
        loadForums();
        
        // Award XP for forum creation
        await trackForumCreation(document.getElementById('createForumBtn'));
        
        // Show success message
        alert('Forum created successfully! You are now the moderator of this forum.');
      } catch (error) {
        console.error('Error creating forum:', error);
        alert('Error creating forum. Please try again.');
      }
    }

    async function openForum(forumId, title, description) {
      currentForumId = forumId;
      document.getElementById('forumTitle').textContent = title;
      document.getElementById('forumDesc').textContent = description;
      document.getElementById('forumViewModal').classList.add('show');
      
      // Check if current user is the forum owner and show delete button
      await checkForumOwnership(forumId);
      
      loadPosts(forumId);
    }

    async function checkForumOwnership(forumId) {
      const deleteBtn = document.getElementById('deleteForumBtn');
      
      if (!currentUser || !deleteBtn) {
        if (deleteBtn) deleteBtn.classList.add('hidden');
        return;
      }
      
      try {
        const forumDoc = await db.collection('forums').doc(forumId).get();
        if (forumDoc.exists) {
          const forumData = forumDoc.data();
          // Show delete button if current user is the creator or has owner/admin rank
          if (forumData.createdById === currentUser.uid || userRank === 'owner' || userRank === 'admin') {
            deleteBtn.classList.remove('hidden');
          } else {
            deleteBtn.classList.add('hidden');
          }
        }
      } catch (error) {
        console.error('Error checking forum ownership:', error);
        deleteBtn.classList.add('hidden');
      }
    }

    async function loadPosts(forumId) {
      try {
        const querySnapshot = await db.collection('forums').doc(forumId).collection('posts')
          .orderBy('createdAt', 'desc').get();
        const posts = [];
        querySnapshot.forEach((doc) => {
          posts.push({ id: doc.id, ...doc.data() });
        });

        displayPosts(posts);
      } catch (error) {
        console.error('Error loading posts:', error);
      }
    }

    function displayPosts(posts) {
      const container = document.getElementById('postsContainer');
      if (posts.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class='bx bx-message text-3xl text-rp-muted mb-2'></i>
            <p class="text-rp-subtle">No posts yet. Be the first to start the conversation!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = posts.map(post => `
        <div class="post-card" id="post-${post.id}">
          <div class="post-author">
${post.isAiPost ? 
              `<img src="data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="20" fill="url(%23gradient)"/><text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" fill="white" font-size="20">ðŸ¤–</text><defs><linearGradient id="gradient"><stop offset="0%" stop-color="%23c4a7e7"/><stop offset="100%" stop-color="%239ccfd8"/></linearGradient></defs></svg>" alt="AI Avatar" class="author-avatar">` :
              `<img src="${post.authorPhoto || 'https://via.placeholder.com/40'}" alt="Avatar" class="author-avatar" onclick="showUserProfile('${post.authorId}', '${sanitizeText(post.authorName)}', '${post.authorRank || 'member'}', '${post.authorPhoto || ''}', event)" style="cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'>">`
            }
            <div>
              <div class="flex items-center gap-2">
                                  ${post.isAiPost ? 
                    `<span class="font-medium text-rp-text">${sanitizeText(post.authorName)}</span>` :
                    `<a href="#" class="user-link level-${post.authorLevelTier || 'novice'}" onclick="showUserProfile('${post.authorId}', '${sanitizeText(post.authorName)}', '${post.authorRank || 'member'}', '${post.authorPhotoURL || ''}', event)">${sanitizeText(post.authorName)}</a>`
                  }
                  <span class="rank-badge rank-${post.authorRank || 'member'}">${post.authorRank || 'member'}</span>
                  ${!post.isAiPost && post.authorLevel ? `
                    <span class="level-badge ${post.authorLevel >= 15 ? 'prestige' : ''}" title="${post.authorLevelTitle || 'Level ' + post.authorLevel}" style="margin-left: 8px; font-size: 0.85rem; padding: 4px 10px;">
                      <i class='bx bx-trophy' style="margin-right: 4px;"></i>Lv.${post.authorLevel}
                    </span>
                  ` : ''}
                ${post.isAiPost ? `<span class="ai-post-indicator"><i class='bx bx-brain'></i>AI</span>` : ''}
              </div>
              <span class="text-sm text-rp-muted">
                ${formatDate(post.createdAt)}
                ${post.isAiPost && post.askedByName ? `â€¢ Asked by ${sanitizeText(post.askedByName)}` : ''}
              </span>
            </div>
          </div>
          <h4 class="font-bold text-rp-text mb-2">${sanitizeText(post.title)}</h4>
          <div class="text-rp-text post-content">${renderMarkdown(sanitizeContent(post.content))}</div>
          
          <!-- Reactions Section -->
          <div class="reactions-container" id="reactions-${post.id}">
            ${generateReactionsHTML(post.reactions || {}, post.id)}
          </div>
          
          <!-- AI Discussion Button -->
          ${currentUser && !post.isAiPost ? `
            <div class="mt-3 pt-3 border-t border-rp-overlay">
              <button onclick="askAiAboutPost('${post.id}', '${sanitizeText(post.title).replace(/'/g, '\\\'').replace(/"/g, '\\"')}', '${sanitizeContent(post.content).replace(/'/g, '\\\'').replace(/"/g, '\\"').replace(/\n/g, ' ')}')" 
                      class="text-sm text-rp-muted hover:text-rp-foam transition-colors flex items-center gap-2">
                <i class='bx bx-brain'></i>
                Ask AI about this post
              </button>
            </div>
          ` : ''}
        </div>
      `).join('');
      
      // Setup reaction listeners for all posts and cache user data
      posts.forEach(post => {
        setupPostReactions(post.id, post.reactions || {});
        // Cache author information
        if (post.authorId && post.authorName) {
          userCache.set(post.authorId, sanitizeText(post.authorName));
        }
      });
    }

    function generateReactionsHTML(reactions, postId) {
      let reactionsHTML = '';
      
      // Display existing reactions
      Object.entries(reactions).forEach(([emoji, data]) => {
        if (data.count > 0) {
          const isActive = currentUser && data.users && data.users.includes(currentUser.uid);
          const userNames = data.users ? data.users.map(uid => getUserDisplayName(uid)).join(', ') : 'Loading...';
          reactionsHTML += `
            <button class="reaction-button ${isActive ? 'active' : ''}" 
                    onclick="toggleReaction('${postId}', '${emoji}')"
                    title="Reacted by: ${userNames}">
              <span class="text-lg">${emoji}</span>
              <span class="text-xs">${data.count}</span>
            </button>
          `;
        }
      });
      
      // Add reaction picker button
      if (currentUser) {
        reactionsHTML += `
          <div class="relative">
            <button class="add-reaction-btn" onclick="showEnhancedReactionPicker('${postId}', this)" title="Add reaction">
              <i class='bx bx-plus'></i>
            </button>
            <div class="reaction-picker-enhanced" id="enhanced-picker-${postId}">
              <div class="favorites-section" id="favorites-${postId}">
                <div class="favorites-title">
                  <i class='bx bxs-star'></i>
                  Favorites
                </div>
                <div class="favorites-grid" id="favorites-grid-${postId}">
                  <div class="no-favorites">No favorite emojis yet</div>
                </div>
              </div>
              <div class="emoji-search-container">
                <input type="text" class="emoji-search-input" placeholder="Search emojis..." 
                       oninput="searchEmojis('${postId}', this.value)" />
                <div class="emoji-suggestions" id="suggestions-${postId}"></div>
              </div>
              <div class="emoji-tabs">
                <div class="emoji-tab active" data-tab="frequent" onclick="switchEmojiTab('${postId}', 'frequent')">ðŸ•’</div>
                <div class="emoji-tab" data-tab="smileys" onclick="switchEmojiTab('${postId}', 'smileys')">ðŸ˜Š</div>
                <div class="emoji-tab" data-tab="gestures" onclick="switchEmojiTab('${postId}', 'gestures')">ðŸ‘</div>
                <div class="emoji-tab" data-tab="hearts" onclick="switchEmojiTab('${postId}', 'hearts')">â¤ï¸</div>
                <div class="emoji-tab" data-tab="objects" onclick="switchEmojiTab('${postId}', 'objects')">ðŸ”¥</div>
              </div>
              <div class="emoji-grid" id="emoji-grid-${postId}">
                ${getFrequentEmojis().map(emoji => `
                  <div class="emoji-item">
                    <div class="emoji-grid-item" onclick="addReaction('${postId}', '${emoji.emoji}')" title="${emoji.name}">
                      ${emoji.emoji}
                    </div>
                    <button class="emoji-favorite-btn" onclick="toggleFavoriteEmoji('${emoji.emoji}', '${emoji.name}', event)" title="Add to favorites">
                      <i class='bx bx-star'></i>
                    </button>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }
      
      return reactionsHTML;
    }

    function getUserDisplayName(uid) {
      if (userCache.has(uid)) {
        return userCache.get(uid);
      }
      
      // Get from current posts if available
      const posts = document.querySelectorAll('.post-card');
      for (const post of posts) {
        const authorElement = post.querySelector('.post-author .font-medium');
        if (post.id.includes(uid) || authorElement) {
          const name = authorElement?.textContent || 'User';
          userCache.set(uid, name);
          return name;
        }
      }
      
      // Fallback - could enhance this to fetch from Firebase
      return 'User';
    }

    async function createPost(event) {
      event.preventDefault();
      
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      
      if (!currentForumId) return;

      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;

      try {
        // Get user level data
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data() || {};
        const currentXP = userData.xp || 0;
        const levelData = calculateLevel(currentXP);

        const postRef = await db.collection('forums').doc(currentForumId).collection('posts').add({
          title: sanitizeText(title),
          content: sanitizeContent(content),
          authorName: currentUser.displayName || 'Anonymous',
          authorId: currentUser.uid,
          authorPhoto: currentUser.photoURL || '',
          authorRank: userRank,
          authorLevel: levelData.level,
          authorLevelTitle: levelData.title,
          authorLevelTier: levelData.tier,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          likes: 0,
          replies: 0,
          reactions: {}
        });

        // Update forum post count
        await db.collection('forums').doc(currentForumId).update({
          postCount: firebase.firestore.FieldValue.increment(1),
          lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update user post count and track achievement
        await trackForumPost();
        await trackForumMessage(); // Track forum message for achievements
        
        // Award XP for post creation
        await trackPostCreation(document.getElementById('createPostBtn'));

        document.getElementById('newPostForm').reset();
        loadPosts(currentForumId);
      } catch (error) {
        console.error('Error creating post:', error);
        alert('Error creating post. Please try again.');
      }
    }

    // SEARCH AND FILTER FUNCTIONS
    function setupSearchAndFilters() {
      const searchInput = document.getElementById('searchInput');
      const categoryFilter = document.getElementById('categoryFilter');
      const sortFilter = document.getElementById('sortFilter');

      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
      });

      categoryFilter.addEventListener('change', performSearch);
      sortFilter.addEventListener('change', performSearch);
    }

    async function performSearch() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      const sortBy = document.getElementById('sortFilter').value;

      try {
        let query = db.collection('forums');
        
        if (categoryFilter) {
          query = query.where('category', '==', categoryFilter);
        }

        // Apply sorting
        switch (sortBy) {
          case 'recent':
            query = query.orderBy('lastActivity', 'desc');
            break;
          case 'popular':
            query = query.orderBy('postCount', 'desc');
            break;
          case 'oldest':
            query = query.orderBy('createdAt', 'asc');
            break;
          default:
            query = query.orderBy('createdAt', 'desc');
        }

        const querySnapshot = await query.get();
        let forums = [];
        querySnapshot.forEach((doc) => {
          forums.push({ id: doc.id, ...doc.data() });
        });

        // Apply search filter on client side (Firestore doesn't support full-text search)
        if (searchTerm) {
          forums = forums.filter(forum => 
            forum.name.toLowerCase().includes(searchTerm) ||
            forum.description.toLowerCase().includes(searchTerm)
          );
        }

        displayForums(forums);
      } catch (error) {
        console.error('Error performing search:', error);
      }
    }

    function filterByCategory(category) {
      document.getElementById('categoryFilter').value = category;
      performSearch();
    }

    // MODAL FUNCTIONS
    function showCreateForumModal() {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      document.getElementById('createForumModal').classList.add('show');
      
      // Setup character counters for the form
      const forumNameInput = document.getElementById('forumName');
      const forumDescInput = document.getElementById('forumDescription');
      const nameCharCount = document.getElementById('nameCharCount');
      const descCharCount = document.getElementById('descCharCount');
      
      // Reset counters
      nameCharCount.textContent = '0';
      descCharCount.textContent = '0';
      
      // Add event listeners for character counting
      forumNameInput.addEventListener('input', (e) => {
        const count = e.target.value.length;
        nameCharCount.textContent = count;
        nameCharCount.className = count > 45 ? 'text-rp-love' : count > 35 ? 'text-rp-gold' : 'text-rp-muted';
      });
      
      forumDescInput.addEventListener('input', (e) => {
        const count = e.target.value.length;
        descCharCount.textContent = count;
        descCharCount.className = count > 180 ? 'text-rp-love' : count > 150 ? 'text-rp-gold' : 'text-rp-muted';
      });
    }

    function hideCreateForumModal() {
      document.getElementById('createForumModal').classList.remove('show');
    }

    function hideForumViewModal() {
      document.getElementById('forumViewModal').classList.remove('show');
      hideActiveReactionPicker();
      cleanupReactionListeners();
      currentForumId = null;
    }

    function showLoginPrompt() {
      document.getElementById('loginPrompt').classList.remove('hidden');
    }

    function hideLoginPrompt() {
      document.getElementById('loginPrompt').classList.add('hidden');
    }

    function showAddFriendsModal() {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      document.getElementById('addFriendsModal').classList.add('show');
      loadFriendRequests();
    }

    function hideAddFriendsModal() {
      document.getElementById('addFriendsModal').classList.remove('show');
      document.getElementById('userSearchInput').value = '';
      document.getElementById('userSearchResults').innerHTML = '<div id="searchPlaceholder" class="text-center text-rp-subtle py-8"><i class="bx bx-search text-3xl mb-2 block"></i><p>Search for users to add as friends</p></div>';
    }

    async function confirmDeleteForum() {
      if (!currentUser || !currentForumId) return;
      
      try {
        // Get forum details for confirmation
        const forumDoc = await db.collection('forums').doc(currentForumId).get();
        if (forumDoc.exists) {
          const forumData = forumDoc.data();
          
          // Check if user has permission to delete
          if (forumData.createdById !== currentUser.uid && userRank !== 'owner' && userRank !== 'admin') {
            alert('You do not have permission to delete this forum');
            return;
          }
          
          // Populate confirmation modal
          document.getElementById('deleteForumName').textContent = forumData.name;
          document.getElementById('deleteForumPosts').textContent = forumData.postCount || 0;
          document.getElementById('deleteConfirmInput').value = '';
          document.getElementById('confirmDeleteBtn').disabled = true;
          
          // Show confirmation modal
          document.getElementById('deleteForumModal').classList.add('show');
          
          // Setup confirmation input listener
          setupDeleteConfirmation();
        }
      } catch (error) {
        console.error('Error preparing forum deletion:', error);
        alert('Error loading forum details');
      }
    }

    function setupDeleteConfirmation() {
      const input = document.getElementById('deleteConfirmInput');
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      
      // Remove existing listeners
      input.removeEventListener('input', handleDeleteInput);
      
      // Add new listener
      input.addEventListener('input', handleDeleteInput);
      
      function handleDeleteInput(e) {
        const value = e.target.value.trim();
        confirmBtn.disabled = value !== 'DELETE';
        
        if (value === 'DELETE') {
          confirmBtn.classList.remove('opacity-50');
        } else {
          confirmBtn.classList.add('opacity-50');
        }
      }
    }

    function hideDeleteForumModal() {
      document.getElementById('deleteForumModal').classList.remove('show');
      document.getElementById('deleteConfirmInput').value = '';
      document.getElementById('confirmDeleteBtn').disabled = true;
    }

    async function deleteForum() {
      if (!currentUser || !currentForumId) return;
      
      const confirmText = document.getElementById('deleteConfirmInput').value.trim();
      if (confirmText !== 'DELETE') {
        alert('Please type "DELETE" to confirm');
        return;
      }
      
      try {
        // Get forum details before deletion for validation
        const forumDoc = await db.collection('forums').doc(currentForumId).get();
        if (!forumDoc.exists) {
          alert('Forum not found');
          hideDeleteForumModal();
          return;
        }
        
        const forumData = forumDoc.data();
        
        // Final permission check
        if (forumData.createdById !== currentUser.uid && userRank !== 'owner' && userRank !== 'admin') {
          alert('You do not have permission to delete this forum');
          hideDeleteForumModal();
          return;
        }
        
        // Show loading state
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<div class="spinner w-4 h-4 mr-2"></div>Deleting...';
        confirmBtn.disabled = true;
        
        // Delete all posts in the forum first
        const postsSnapshot = await db.collection('forums').doc(currentForumId).collection('posts').get();
        const batch = db.batch();
        
        postsSnapshot.forEach((doc) => {
          batch.delete(doc.ref);
        });
        
        // Delete the forum document
        batch.delete(db.collection('forums').doc(currentForumId));
        
        // Commit the batch deletion
        await batch.commit();
        
        // Update user's forum creation count if they were the creator
        if (forumData.createdById === currentUser.uid) {
          await db.collection('users').doc(currentUser.uid).update({
            forumsCreated: firebase.firestore.FieldValue.increment(-1)
          });
        }
        
        // Hide modals and refresh forum list
        hideDeleteForumModal();
        hideForumViewModal();
        loadForums();
        
        alert('Forum deleted successfully');
        
      } catch (error) {
        console.error('Error deleting forum:', error);
        alert('Error deleting forum. Please try again.');
        
        // Reset button state
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.innerHTML = '<i class="bx bx-trash mr-2"></i>Delete Forever';
        confirmBtn.disabled = false;
      }
    }

    function showChatModal(user) {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      
      activeChatUser = user;
      document.getElementById('chatFriendName').textContent = user.displayName || 'Friend';
      document.getElementById('chatFriendNamePlaceholder').textContent = user.displayName || 'Friend';
      document.getElementById('chatFriendAvatar').src = user.photoURL || 'https://via.placeholder.com/40';
      document.getElementById('chatModal').classList.add('show');
      
      loadChatMessages(user.uid);
    }

    function hideChatModal() {
      document.getElementById('chatModal').classList.remove('show');
      if (chatUnsubscribe) {
        chatUnsubscribe();
        chatUnsubscribe = null;
      }
      activeChatUser = null;
      document.getElementById('chatInput').value = '';
      document.getElementById('charCount').textContent = '0';
    }

    // UTILITY FUNCTIONS
    function formatDate(timestamp) {
      if (!timestamp) return 'Just now';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }

    async function updateUserSection() {
      const userSection = document.getElementById('userSection');
      const signInBtn = document.getElementById('signInBtn');
      const userRankBadge = document.getElementById('userRank');
      const createBtn = document.getElementById('createForumBtn');
      
      if (currentUser) {
        // Initialize presence tracking
        try {
          initializePresence();
        } catch (error) {
          console.error('Error initializing presence:', error);
        }
        
        // Get user XP data for header display
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data() || {};
        const currentXP = userData.xp || 0;
        const levelData = calculateLevel(currentXP);
        const progress = formatXPProgress(currentXP, levelData);

        // Show authenticated user UI with XP display
        userSection.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${currentUser.photoURL || 'https://via.placeholder.com/32'}" alt="Profile" class="w-8 h-8 rounded-full">
            <div class="hidden md:block">
              <div class="flex items-center gap-2">
                <span class="text-rp-text font-medium">${sanitizeText(currentUser.displayName || 'User')}</span>
                <span class="rank-badge rank-${userRank}">${userRank}</span>
                <span class="level-badge ${levelData.level >= 15 ? 'prestige' : ''}" title="${levelData.title}">
                  <i class='bx bx-trophy'></i>Lv.${levelData.level}
                </span>
              </div>
              <div class="xp-display mt-1">
                <div class="xp-bar-container" style="width: 120px; height: 6px;">
                  <div class="xp-bar" style="width: ${progress.percentage}%"></div>
                </div>
                <div class="xp-text" style="font-size: 0.65rem;">${currentXP} XP</div>
              </div>
            </div>
            <div class="md:hidden flex items-center gap-1">
              <span class="level-badge ${levelData.level >= 15 ? 'prestige' : ''}" title="${levelData.title}">
                <i class='bx bx-trophy'></i>${levelData.level}
              </span>
            </div>
            <button onclick="signOut()" class="text-rp-muted hover:text-rp-text">
              <i class='bx bx-log-out text-xl'></i>
            </button>
          </div>
        `;
        
        // Hide sign in button and show user rank
        if (signInBtn) signInBtn.classList.add('hidden');
        if (userRankBadge) {
          userRankBadge.textContent = userRank;
          userRankBadge.className = `rank-badge rank-${userRank}`;
          userRankBadge.classList.remove('hidden');
        }
        
        // Show create forum button for all authenticated users
        if (createBtn) {
          createBtn.classList.remove('hidden');
        }
        
        // Update XP widget with current user data
        setTimeout(() => updateXPWidget(), 300);
        
        // Show post form in forums
        const guestMessage = document.getElementById('guestPostMessage');
        const postForm = document.getElementById('newPostForm');
        if (guestMessage) guestMessage.classList.add('hidden');
        if (postForm) postForm.classList.remove('hidden');
        
        // Show friends toggle button
        const friendsToggle = document.getElementById('friendsSidebarToggle');
        if (friendsToggle) friendsToggle.classList.remove('hidden');
        
        // Show achievements button, shop, and settings
        const achievementsBtn = document.getElementById('achievementsBtn');
        if (achievementsBtn) achievementsBtn.classList.remove('hidden');
        
        const shopBtn = document.getElementById('shopBtn');
        if (shopBtn) shopBtn.classList.remove('hidden');
        
        const settingsBtn = document.getElementById('forumSettingsBtn');
        if (settingsBtn) settingsBtn.classList.remove('hidden');
        
        // Load friends data and achievements
        loadFriends();
        loadUserAchievements();
        
        // Handle shared forum links
        handleForumLink();
        
        // Hide login prompt
        hideLoginPrompt();
      } else {
        // Show guest user UI
        userSection.innerHTML = `
          <button onclick="showLoginPrompt()" class="text-rp-muted hover:text-rp-text">
            <i class='bx bx-log-in text-xl'></i>
          </button>
        `;
        
        // Show sign in button and hide user rank
        if (signInBtn) signInBtn.classList.remove('hidden');
        if (userRankBadge) userRankBadge.classList.add('hidden');
        if (createBtn) createBtn.classList.add('hidden');
        
        // Show guest message in forums
        const guestMessage = document.getElementById('guestPostMessage');
        const postForm = document.getElementById('newPostForm');
        if (guestMessage) guestMessage.classList.remove('hidden');
        if (postForm) postForm.classList.add('hidden');
        
        // Hide friends toggle button
        const friendsToggle = document.getElementById('friendsSidebarToggle');
        if (friendsToggle) friendsToggle.classList.add('hidden');
        
        // Hide achievements button, shop, and settings
        const achievementsBtn = document.getElementById('achievementsBtn');
        if (achievementsBtn) achievementsBtn.classList.add('hidden');
        
        const shopBtn = document.getElementById('shopBtn');
        if (shopBtn) shopBtn.classList.add('hidden');
        
        const settingsBtn = document.getElementById('forumSettingsBtn');
        if (settingsBtn) settingsBtn.classList.add('hidden');
        
        // Close friends sidebar
        const friendsSidebar = document.getElementById('friendsChatSidebar');
        if (friendsSidebar) friendsSidebar.classList.add('hidden');
      }
    }

    // Initialize authentication monitoring after Firebase is ready
    function startAuthMonitoring() {
      if (!auth || !firebaseInitialized) {
        console.log('Auth not ready, retrying in 200ms...');
        setTimeout(startAuthMonitoring, 200);
        return;
      }

      console.log('Starting auth monitoring, current user:', auth.currentUser ? auth.currentUser.email : 'none');

      // Handle redirect result for COOP fallback
      auth.getRedirectResult().then((result) => {
        if (result.user) {
          console.log('Successfully signed in via redirect');
          hideLoginPrompt();
          
          // Clear any error messages
          const loginError = document.getElementById('loginError');
          if (loginError) {
            loginError.classList.add('hidden');
          }
        }
      }).catch((error) => {
        console.error('Redirect sign-in error:', error);
        const loginError = document.getElementById('loginError');
        if (loginError) {
          loginError.innerText = `Sign-in error: ${error.message}`;
          loginError.classList.remove('hidden');
        }
      });

      // AUTH STATE OBSERVER
      auth.onAuthStateChanged(handleAuthStateChange);
      
      // Force initial check if user is already signed in
      setTimeout(() => {
        if (auth.currentUser) {
          console.log('User already signed in on page load:', auth.currentUser.email);
          handleAuthStateChange(auth.currentUser);
        }
      }, 100);
    }

    // Separate auth state handler for better management
    async function handleAuthStateChange(user) {
      console.log('Auth state changed:', user ? `Signed in as ${user.email}` : 'Browsing as guest');
      
      if (user) {
        currentUser = user;
        
        try {
          await ensureUserDoc(user);
          userRank = await getUserRank(user.uid);
          console.log('User rank:', userRank);
          
                  // Initialize XP system for user
        await initializeUserXP(user.uid);
        
        // Check for daily login bonus
        await checkDailyLoginBonus(user.uid);
          
          await updateUserSection();
          
          console.log('Forum UI updated for authenticated user');
        } catch (error) {
          console.error('Error handling authenticated user:', error);
          
          // Still try to show basic UI even if some initialization fails
          try {
            await updateUserSection();
          } catch (uiError) {
            console.error('Error updating UI:', uiError);
          }
        }
      } else {
        console.log('Browsing as guest');
        currentUser = null;
        userRank = 'guest';
        await updateUserSection();
      }
      
      // Always show forum content (both for guests and authenticated users)
      // Load forum data regardless of auth state
      if (!document.querySelector('#categoriesGrid').innerHTML) {
        loadCategories();
        loadForums();
        setupSearchAndFilters();
      }
    }

    // Cross-tab sync is now handled inline in initAuthSync function

    // Start authentication monitoring after Firebase is ready
    function startForumAuthentication() {
      // Wait for Firebase initialization
      if (!firebaseInitialized) {
        setTimeout(startForumAuthentication, 200);
        return;
      }
      
      startAuthMonitoring();
      
      // Initialize inline auth sync
      initAuthSync();
    }

    // Authentication Synchronization (inline to avoid timing issues)
    function initAuthSync() {
      if (!auth) return;
      
      // Listen for auth state changes and store in localStorage
      auth.onAuthStateChanged((user) => {
        const authState = {
          isAuthenticated: !!user,
          user: user ? {
            uid: user.uid,
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL
          } : null,
          timestamp: Date.now()
        };
        
        // Store auth state in localStorage for cross-tab communication
        try {
          localStorage.setItem('carbon_auth_state', JSON.stringify(authState));
        } catch (e) {
          console.warn('Failed to store auth state:', e);
        }
      });
      
      // Listen for auth state changes from other tabs
      window.addEventListener('storage', (e) => {
        if (e.key === 'carbon_auth_state' && e.newValue) {
          try {
            const authState = JSON.parse(e.newValue);
            console.log('Received auth sync from another tab:', authState);
            
            if (authState.isAuthenticated && authState.user && !currentUser) {
              console.log('Syncing login state from another tab');
              // The onAuthStateChanged should handle this automatically
            } else if (!authState.isAuthenticated && currentUser) {
              console.log('Syncing logout state from another tab');
              // Force logout UI if needed
              if (!auth.currentUser) {
                handleAuthStateChange(null);
              }
            }
          } catch (error) {
            console.warn('Failed to parse auth state from storage:', error);
          }
        }
      });
    }

    // Start the authentication process
    setTimeout(startForumAuthentication, 100);

    // FRIENDS AND CHAT FUNCTIONS
    async function loadFriends() {
      if (!currentUser) return;
      
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          const friendsIds = userData.friends || [];
          
          if (friendsIds.length === 0) {
            friendsList = [];
            displayFriends();
            return;
          }
          
          // Load friend details
          const friendsData = await Promise.all(
            friendsIds.map(async (friendId) => {
              const friendDoc = await db.collection('users').doc(friendId).get();
              if (friendDoc.exists) {
                return { uid: friendId, ...friendDoc.data() };
              }
              return null;
            })
          );
          
          friendsList = friendsData.filter(friend => friend !== null);
          displayFriends();
          checkOnlineFriends();
        }
      } catch (error) {
        console.error('Error loading friends:', error);
      }
    }

    function displayFriends() {
      const allFriendsContainer = document.getElementById('allFriendsListForum');
      const noFriendsContainer = document.getElementById('noFriendsForum');
      
      if (friendsList.length === 0) {
        allFriendsContainer.innerHTML = '';
        noFriendsContainer.classList.remove('hidden');
        return;
      }
      
      noFriendsContainer.classList.add('hidden');
      allFriendsContainer.innerHTML = friendsList.map(friend => `
        <div class="flex items-center gap-3 p-2 hover:bg-rp-overlay/50 rounded-lg transition-colors">
          <img src="${friend.photoURL || 'https://via.placeholder.com/32'}" alt="Avatar" class="w-8 h-8 rounded-full object-cover">
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-rp-text truncate">${sanitizeText(friend.displayName || 'User')}</p>
            <p class="text-xs text-rp-subtle">${friend.status === 'online' ? 'ðŸŸ¢ Online' : 'âš« Offline'}</p>
          </div>
          <button onclick="showChatModal({uid: '${friend.uid}', displayName: '${sanitizeText(friend.displayName || 'User')}', photoURL: '${friend.photoURL || ''}'});" class="p-1 text-rp-subtle hover:text-rp-foam hover:bg-rp-foam/10 rounded transition-colors">
            <i class='bx bx-message text-sm'></i>
          </button>
        </div>
      `).join('');
    }

    function checkOnlineFriends() {
      onlineFriends = friendsList.filter(friend => friend.status === 'online');
      displayOnlineFriends();
    }

    function displayOnlineFriends() {
      const onlineFriendsContainer = document.getElementById('onlineFriendsListForum');
      const noOnlineContainer = document.getElementById('noOnlineFriendsForum');
      
      if (onlineFriends.length === 0) {
        onlineFriendsContainer.innerHTML = '';
        noOnlineContainer.classList.remove('hidden');
        return;
      }
      
      noOnlineContainer.classList.add('hidden');
      onlineFriendsContainer.innerHTML = onlineFriends.map(friend => `
        <div class="flex items-center gap-3 p-2 hover:bg-rp-overlay/50 rounded-lg transition-colors cursor-pointer" onclick="showChatModal({uid: '${friend.uid}', displayName: '${sanitizeText(friend.displayName || 'User')}', photoURL: '${friend.photoURL || ''}'});">
          <img src="${friend.photoURL || 'https://via.placeholder.com/32'}" alt="Avatar" class="w-8 h-8 rounded-full object-cover">
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-rp-text truncate">${sanitizeText(friend.displayName || 'User')}</p>
            <p class="text-xs text-rp-pine">ðŸŸ¢ Online</p>
          </div>
          <i class='bx bx-message text-rp-subtle'></i>
        </div>
      `).join('');
    }

    async function searchUsers(query) {
      if (!query.trim() || query.length < 2) {
        document.getElementById('userSearchResults').innerHTML = '<div id="searchPlaceholder" class="text-center text-rp-subtle py-8"><i class="bx bx-search text-3xl mb-2 block"></i><p>Search for users to add as friends</p></div>';
        return;
      }
      
      try {
        // Search by username or display name
        const usersSnapshot = await db.collection('users')
          .where('username', '>=', query.toLowerCase())
          .where('username', '<=', query.toLowerCase() + '\uf8ff')
          .limit(10)
          .get();
        
        const results = [];
        usersSnapshot.forEach(doc => {
          if (doc.id !== currentUser.uid) {
            results.push({ uid: doc.id, ...doc.data() });
          }
        });
        
        displaySearchResults(results);
      } catch (error) {
        console.error('Error searching users:', error);
      }
    }

    function displaySearchResults(results) {
      const container = document.getElementById('userSearchResults');
      
      if (results.length === 0) {
        container.innerHTML = '<div class="text-center text-rp-subtle py-8"><p>No users found</p></div>';
        return;
      }
      
      container.innerHTML = results.map(user => `
        <div class="flex items-center gap-3 p-3 border border-rp-overlay rounded-lg">
          <img src="${user.photoURL || 'https://via.placeholder.com/40'}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
          <div class="flex-1 min-w-0">
            <p class="font-medium text-rp-text truncate">${sanitizeText(user.displayName || 'User')}</p>
            <p class="text-sm text-rp-subtle">@${sanitizeText(user.username || 'username')}</p>
          </div>
          <button onclick="sendFriendRequest('${user.uid}');" class="px-3 py-1 bg-rp-foam/20 text-rp-foam rounded-lg hover:bg-rp-foam/30 transition-colors text-sm">
            <i class='bx bx-user-plus mr-1'></i>
            Add
          </button>
        </div>
      `).join('');
    }

    async function sendFriendRequest(targetUid) {
      if (!currentUser || targetUid === currentUser.uid) return;
      
      // Input validation
      if (!targetUid || typeof targetUid !== 'string') {
        console.error('Invalid target UID');
        return;
      }
      
      try {
        // Check if target user exists and get their data
        const targetUserDoc = await db.collection('users').doc(targetUid).get();
        if (!targetUserDoc.exists) {
          alert('User not found');
          return;
        }
        
        // Check if already friends or request exists
        const currentUserDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = currentUserDoc.data();
        const friends = userData?.friends || [];
        const blockedUsers = userData?.blockedUsers || [];
        
        // Check if user is blocked
        if (blockedUsers.includes(targetUid)) {
          alert('Cannot send friend request to blocked user');
          return;
        }
        
        // Check if target user has blocked current user
        const targetUserData = targetUserDoc.data();
        const targetBlockedUsers = targetUserData?.blockedUsers || [];
        if (targetBlockedUsers.includes(currentUser.uid)) {
          alert('Unable to send friend request');
          return;
        }
        
        if (friends.includes(targetUid)) {
          alert('Already friends with this user');
          return;
        }
        
        // Check existing requests
        const existingRequest = await db.collection('friendRequests')
          .where('from', '==', currentUser.uid)
          .where('to', '==', targetUid)
          .get();
        
        if (!existingRequest.empty) {
          alert('Friend request already sent');
          return;
        }
        
        // Send friend request with sanitized data
        await db.collection('friendRequests').add({
          from: currentUser.uid,
          to: targetUid,
          fromName: sanitizeText(currentUser.displayName || 'User'),
          fromPhoto: currentUser.photoURL || '',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'pending'
        });
        
        alert('Friend request sent!');
      } catch (error) {
        console.error('Error sending friend request:', error);
        alert('Error sending friend request');
      }
    }

    async function loadFriendRequests() {
      if (!currentUser) return;
      
      try {
        const requestsSnapshot = await db.collection('friendRequests')
          .where('to', '==', currentUser.uid)
          .where('status', '==', 'pending')
          .get();
        
        const requests = [];
        requestsSnapshot.forEach(doc => {
          requests.push({ id: doc.id, ...doc.data() });
        });
        
        displayFriendRequests(requests);
      } catch (error) {
        console.error('Error loading friend requests:', error);
      }
    }

    function displayFriendRequests(requests) {
      const container = document.getElementById('friendRequestsList');
      const noRequestsContainer = document.getElementById('noRequests');
      
      if (requests.length === 0) {
        container.innerHTML = '';
        noRequestsContainer.classList.remove('hidden');
        return;
      }
      
      noRequestsContainer.classList.add('hidden');
      container.innerHTML = requests.map(request => `
        <div class="flex items-center gap-3 p-3 border border-rp-overlay rounded-lg">
          <img src="${request.fromPhoto || 'https://via.placeholder.com/40'}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
          <div class="flex-1 min-w-0">
            <p class="font-medium text-rp-text truncate">${sanitizeText(request.fromName)}</p>
            <p class="text-sm text-rp-subtle">Wants to be friends</p>
          </div>
          <div class="flex gap-2">
            <button onclick="acceptFriendRequest('${request.id}', '${request.from}');" class="px-3 py-1 bg-rp-foam/20 text-rp-foam rounded-lg hover:bg-rp-foam/30 transition-colors text-sm">
              Accept
            </button>
            <button onclick="rejectFriendRequest('${request.id}');" class="px-3 py-1 bg-rp-love/20 text-rp-love rounded-lg hover:bg-rp-love/30 transition-colors text-sm">
              Decline
            </button>
          </div>
        </div>
      `).join('');
    }

    async function acceptFriendRequest(requestId, fromUid) {
      try {
        const batch = db.batch();
        
        // Add to both users' friends lists
        const currentUserRef = db.collection('users').doc(currentUser.uid);
        const friendUserRef = db.collection('users').doc(fromUid);
        
        batch.update(currentUserRef, {
          friends: firebase.firestore.FieldValue.arrayUnion(fromUid)
        });
        
        batch.update(friendUserRef, {
          friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
        
        // Delete the request
        const requestRef = db.collection('friendRequests').doc(requestId);
        batch.delete(requestRef);
        
        await batch.commit();
        
        loadFriendRequests();
        loadFriends();
        
        // Check achievements for new friend
        const stats = await getUserStats();
        await checkAchievements(stats);
      } catch (error) {
        console.error('Error accepting friend request:', error);
        alert('Error accepting friend request');
      }
    }

    async function rejectFriendRequest(requestId) {
      try {
        await db.collection('friendRequests').doc(requestId).delete();
        loadFriendRequests();
      } catch (error) {
        console.error('Error rejecting friend request:', error);
        alert('Error rejecting friend request');
      }
    }

    // CHAT FUNCTIONS
    async function loadChatMessages(friendUid) {
      if (!currentUser || !friendUid) return;
      
      const chatRoomId = [currentUser.uid, friendUid].sort().join('_');
      
      // Unsubscribe from previous chat
      if (chatUnsubscribe) {
        chatUnsubscribe();
      }
      
      // Subscribe to real-time messages
      chatUnsubscribe = db.collection('chats').doc(chatRoomId).collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot((snapshot) => {
          const messages = [];
          snapshot.forEach(doc => {
            messages.push({ id: doc.id, ...doc.data() });
          });
          displayChatMessages(messages);
        });
    }

    function displayChatMessages(messages) {
      const container = document.getElementById('chatMessages');
      const placeholder = document.getElementById('chatPlaceholder');
      
      if (messages.length === 0) {
        placeholder.classList.remove('hidden');
        container.innerHTML = placeholder.outerHTML;
        return;
      }
      
      container.innerHTML = messages.map(message => {
        const isOwn = message.sender === currentUser.uid;
        return `
          <div class="flex ${isOwn ? 'justify-end' : 'justify-start'}">
            <div class="max-w-xs px-4 py-2 rounded-lg ${isOwn ? 'bg-rp-foam text-rp-base' : 'bg-rp-overlay text-rp-text'}">
              <p class="text-sm">${sanitizeContent(message.text)}</p>
              <p class="text-xs opacity-70 mt-1">${formatTime(message.timestamp)}</p>
            </div>
          </div>
        `;
      }).join('');
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      
      if (!text || !activeChatUser || !currentUser) return;
      
      // Input validation
      if (typeof text !== 'string' || text.length === 0) return;
      
      // Check if users are friends before allowing chat
      const currentUserDoc = await db.collection('users').doc(currentUser.uid).get();
      const userData = currentUserDoc.data();
      const friends = userData?.friends || [];
      const blockedUsers = userData?.blockedUsers || [];
      
      if (!friends.includes(activeChatUser.uid)) {
        alert('You can only chat with friends');
        hideChatModal();
        return;
      }
      
      if (blockedUsers.includes(activeChatUser.uid)) {
        alert('Cannot send message to blocked user');
        hideChatModal();
        return;
      }
      
      // Sanitize message text
      const safeText = sanitizeText(text);
      
      if (safeText.length > 500) {
        alert('Message too long (max 500 characters)');
        return;
      }
      
      if (safeText.length === 0) {
        alert('Message cannot be empty after filtering');
        return;
      }
      
      const chatRoomId = [currentUser.uid, activeChatUser.uid].sort().join('_');
      
      try {
        await db.collection('chats').doc(chatRoomId).collection('messages').add({
          text: safeText,
          sender: currentUser.uid,
          senderName: sanitizeText(currentUser.displayName || 'User'),
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        input.value = '';
        document.getElementById('charCount').textContent = '0';
        
        // Track message sent for achievements
        await trackMessageSent();
      } catch (error) {
        console.error('Error sending message:', error);
        alert('Error sending message');
      }
    }

    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // REACTION SYSTEM FUNCTIONS
    function setupPostReactions(postId, reactions) {
      // Setup real-time listener for reactions
      if (reactionListeners.has(postId)) {
        reactionListeners.get(postId)(); // Unsubscribe previous listener
      }
      
      const unsubscribe = db.collection('forums').doc(currentForumId).collection('posts').doc(postId)
        .onSnapshot((doc) => {
          if (doc.exists) {
            const data = doc.data();
            updateReactionsDisplay(postId, data.reactions || {});
          }
        });
      
      reactionListeners.set(postId, unsubscribe);
    }

    function updateReactionsDisplay(postId, reactions) {
      const container = document.getElementById(`reactions-${postId}`);
      if (container) {
        container.innerHTML = generateReactionsHTML(reactions, postId);
      }
    }

    function showEnhancedReactionPicker(postId, button) {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      
      // Hide any active picker
      hideActiveReactionPicker();
      
      const picker = document.getElementById(`enhanced-picker-${postId}`);
      if (picker) {
        // Position picker above the button
        const rect = button.getBoundingClientRect();
        picker.style.bottom = '40px';
        picker.style.left = '0';
        
        picker.classList.add('show');
        activeReactionPicker = picker;
        
        // Initialize favorites grid
        const favoritesGrid = document.getElementById(`favorites-grid-${postId}`);
        updateFavoritesGrid(favoritesGrid);
        
        // Clear search input
        const searchInput = picker.querySelector('.emoji-search-input');
        if (searchInput) searchInput.value = '';
        
        // Hide suggestions
        const suggestions = document.getElementById(`suggestions-${postId}`);
        if (suggestions) suggestions.classList.remove('show');
        
        // Hide picker when clicking outside
        setTimeout(() => {
          document.addEventListener('click', hidePickerOnClickOutside);
        }, 0);
      }
    }

    function showReactionPicker(postId, button) {
      // Fallback for old picker (if any still exist)
      showEnhancedReactionPicker(postId, button);
    }

    function hideActiveReactionPicker() {
      if (activeReactionPicker) {
        activeReactionPicker.classList.remove('show');
        activeReactionPicker = null;
        document.removeEventListener('click', hidePickerOnClickOutside);
      }
    }

    function hidePickerOnClickOutside(event) {
      if (activeReactionPicker && !activeReactionPicker.contains(event.target) && 
          !event.target.closest('.add-reaction-btn')) {
        hideActiveReactionPicker();
      }
    }

    function getFrequentEmojis() {
      // Return most commonly used emojis
      return window.reactionEmojis;
    }

    function getEmojisByCategory(category) {
      switch (category) {
        case 'frequent':
          return getFrequentEmojis();
        case 'smileys':
          return window.allEmojis.filter(e => 
            e.keywords.some(k => ['happy', 'sad', 'laugh', 'smile', 'cry', 'angry'].includes(k))
          );
        case 'gestures':
          return window.allEmojis.filter(e => 
            e.keywords.some(k => ['hand', 'point', 'thumb', 'clap', 'pray', 'wave'].includes(k))
          );
        case 'hearts':
          return window.allEmojis.filter(e => 
            e.keywords.includes('heart') || e.keywords.includes('love')
          );
        case 'objects':
          return window.allEmojis.filter(e => 
            e.keywords.some(k => ['fire', 'star', 'trophy', 'celebration', 'party'].includes(k))
          );
        default:
          return getFrequentEmojis();
      }
    }

    function switchEmojiTab(postId, category) {
      // Update active tab
      const picker = document.getElementById(`enhanced-picker-${postId}`);
      if (!picker) return;
      
      picker.querySelectorAll('.emoji-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      picker.querySelector(`[data-tab="${category}"]`).classList.add('active');
      
      // Update emoji grid
      const grid = document.getElementById(`emoji-grid-${postId}`);
      const emojis = getEmojisByCategory(category);
      
      grid.innerHTML = emojis.map(emoji => {
        const isFavorited = favoriteEmojis.some(fav => fav.emoji === emoji.emoji);
        return `
          <div class="emoji-item">
            <div class="emoji-grid-item" onclick="addReaction('${postId}', '${emoji.emoji}')" title="${emoji.name}">
              ${emoji.emoji}
            </div>
            <button class="emoji-favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="toggleFavoriteEmoji('${emoji.emoji}', '${emoji.name}', event)" title="${isFavorited ? 'Remove from favorites' : 'Add to favorites'}">
              <i class='bx ${isFavorited ? 'bxs-star' : 'bx-star'}'></i>
            </button>
          </div>
        `;
      }).join('');
    }

    let searchTimeout;
    let selectedSuggestionIndex = -1;

    function searchEmojis(postId, query) {
      clearTimeout(searchTimeout);
      const suggestions = document.getElementById(`suggestions-${postId}`);
      
      if (!query.trim()) {
        suggestions.classList.remove('show');
        return;
      }
      
      searchTimeout = setTimeout(() => {
        const results = window.allEmojis.filter(emoji => {
          const searchTerm = query.toLowerCase();
          return emoji.name.toLowerCase().includes(searchTerm) ||
                 emoji.keywords.some(keyword => keyword.toLowerCase().includes(searchTerm));
        }).slice(0, 8); // Limit to 8 results
        
        displayEmojiSuggestions(postId, results, query);
      }, 150);
    }

    function displayEmojiSuggestions(postId, suggestions, query) {
      const container = document.getElementById(`suggestions-${postId}`);
      selectedSuggestionIndex = -1;
      
      if (suggestions.length === 0) {
        container.innerHTML = '<div class="emoji-suggestion"><span>No emojis found</span></div>';
        container.classList.add('show');
        return;
      }
      
      container.innerHTML = suggestions.map((emoji, index) => `
        <div class="emoji-suggestion" onclick="selectEmojiSuggestion('${postId}', '${emoji.emoji}')" data-index="${index}">
          <span class="emoji-suggestion-emoji">${emoji.emoji}</span>
          <div class="emoji-suggestion-info">
            <div class="emoji-suggestion-name">:${emoji.name}:</div>
            <div class="emoji-suggestion-keywords">${emoji.keywords.join(', ')}</div>
          </div>
        </div>
      `).join('');
      
      container.classList.add('show');
    }

    function selectEmojiSuggestion(postId, emoji) {
      addReaction(postId, emoji);
      hideActiveReactionPicker();
    }

    // Handle keyboard navigation for emoji suggestions
    document.addEventListener('keydown', (e) => {
      if (!activeReactionPicker) return;
      
      const suggestions = activeReactionPicker.querySelector('.emoji-suggestions');
      if (!suggestions || !suggestions.classList.contains('show')) return;
      
      const suggestionItems = suggestions.querySelectorAll('.emoji-suggestion');
      if (suggestionItems.length === 0) return;
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
        updateSelectedSuggestion(suggestionItems);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
        updateSelectedSuggestion(suggestionItems);
      } else if (e.key === 'Enter' && selectedSuggestionIndex >= 0) {
        e.preventDefault();
        suggestionItems[selectedSuggestionIndex].click();
      } else if (e.key === 'Escape') {
        hideActiveReactionPicker();
      }
    });

    function updateSelectedSuggestion(suggestionItems) {
      suggestionItems.forEach((item, index) => {
        item.classList.toggle('selected', index === selectedSuggestionIndex);
      });
      
      if (selectedSuggestionIndex >= 0) {
        suggestionItems[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
      }
    }

    async function addReaction(postId, emoji) {
      if (!currentUser || !currentForumId) return;
      
      hideActiveReactionPicker();
      
      try {
        const postRef = db.collection('forums').doc(currentForumId).collection('posts').doc(postId);
        const postDoc = await postRef.get();
        
        if (!postDoc.exists) return;
        
        const postData = postDoc.data();
        const reactions = postData.reactions || {};
        
        // Initialize reaction if it doesn't exist
        if (!reactions[emoji]) {
          reactions[emoji] = {
            count: 0,
            users: []
          };
        }
        
        // Check if user already reacted with this emoji
        if (reactions[emoji].users.includes(currentUser.uid)) {
          // Remove reaction
          reactions[emoji].count = Math.max(0, reactions[emoji].count - 1);
          reactions[emoji].users = reactions[emoji].users.filter(uid => uid !== currentUser.uid);
          
          // Remove emoji completely if no reactions left
          if (reactions[emoji].count === 0) {
            delete reactions[emoji];
          }
        } else {
          // Add reaction
          reactions[emoji].count++;
          reactions[emoji].users.push(currentUser.uid);
        }
        
        // Update post with new reactions
        await postRef.update({ reactions });
        
        // Track reaction given for achievements (only when adding, not removing)
        if (!reactions[emoji].users.includes(currentUser.uid)) {
          await trackReactionGiven();
          // Award XP for reaction
          await trackReactionGiven(reactionElement);
        }
        
        // Add animation to the reaction button
        animateReaction(postId, emoji);
        
      } catch (error) {
        console.error('Error adding reaction:', error);
      }
    }

    async function toggleReaction(postId, emoji) {
      // Same as addReaction - allows clicking existing reactions to toggle
      await addReaction(postId, emoji);
    }

    function animateReaction(postId, emoji) {
      // Find the reaction button and animate it
      const button = document.querySelector(`#reactions-${postId} .reaction-button[onclick*="${emoji}"]`);
      if (button) {
        button.classList.add('reaction-animate');
        setTimeout(() => {
          button.classList.remove('reaction-animate');
        }, 300);
      }
    }



    // Cleanup reaction listeners when needed
    function cleanupReactionListeners() {
      reactionListeners.forEach(unsubscribe => unsubscribe());
      reactionListeners.clear();
    }

    // ACHIEVEMENT SYSTEM FUNCTIONS
    async function checkAchievements(userStats) {
      if (!currentUser) return;
      
      const newlyUnlocked = [];
      
      for (const achievement of achievementDefinitions) {
        const isAlreadyUnlocked = userAchievements.some(a => a.id === achievement.id);
        
        if (!isAlreadyUnlocked && achievement.condition(userStats)) {
          newlyUnlocked.push(achievement);
          
          // Add to user's achievements
          userAchievements.push({
            id: achievement.id,
            unlockedAt: new Date(),
            points: achievement.points
          });
          
          // Update database
          await unlockAchievement(achievement.id, achievement.points);
          
          // Show notification
          showAchievementNotification(achievement);
        }
      }
      
      return newlyUnlocked;
    }

    async function unlockAchievement(achievementId, points) {
      if (!currentUser) return;
      
      try {
        const userRef = db.collection('users').doc(currentUser.uid);
        await userRef.update({
          [`achievements.${achievementId}`]: {
            unlockedAt: firebase.firestore.FieldValue.serverTimestamp(),
            points: points
          },
          totalAchievementPoints: firebase.firestore.FieldValue.increment(points)
        });
      } catch (error) {
        console.error('Error unlocking achievement:', error);
      }
    }



    async function loadUserAchievements() {
      if (!currentUser) return;
      
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        const achievements = userData.achievements || {};
        
        userAchievements = Object.entries(achievements).map(([id, data]) => ({
          id,
          unlockedAt: data.unlockedAt?.toDate() || new Date(),
          points: data.points || 0
        }));
      } catch (error) {
        console.error('Error loading user achievements:', error);
        userAchievements = [];
      }
    }

    function showAchievementNotification(achievement) {
      const template = document.getElementById('achievementNotificationTemplate');
      const notification = template.cloneNode(true);
      notification.id = 'achievementNotification';
      notification.style.display = 'block';
      
      // Update content
      notification.querySelector('#achievementName').textContent = achievement.name;
      notification.querySelector('.achievement-icon i').className = `bx ${achievement.icon}`;
      
      const badge = notification.querySelector('#achievementBadge');
      badge.className = `achievement-badge ${achievement.rarity}`;
      badge.querySelector('span').textContent = `+${achievement.points} XP`;
      
      // Add to page
      document.body.appendChild(notification);
      
      // Show with animation
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        hideAchievementNotification(notification);
      }, 5000);
    }

    function hideAchievementNotification(notification) {
      if (typeof notification === 'object') {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 400);
      } else {
        // If called with 'this' from template
        const notif = notification.closest('.achievement-notification');
        hideAchievementNotification(notif);
      }
    }

    function showAchievementsModal() {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      
      document.getElementById('achievementsModal').classList.add('show');
      loadAchievementsDisplay();
    }

    function hideAchievementsModal() {
      document.getElementById('achievementsModal').classList.remove('show');
    }

    async function loadAchievementsDisplay() {
      const stats = await getUserStats();
      await loadUserAchievements();
      
      // Update stats display
      const unlockedCount = userAchievements.length;
      const totalCount = achievementDefinitions.length;
      const totalPoints = userAchievements.reduce((sum, ach) => sum + ach.points, 0);
      const completionRate = Math.round((unlockedCount / totalCount) * 100);
      
      document.getElementById('totalAchievements').textContent = `${unlockedCount}/${totalCount}`;
      document.getElementById('totalPoints').textContent = totalPoints;
      document.getElementById('completionRate').textContent = `${completionRate}%`;
      document.getElementById('userRankDisplay').textContent = getUserRankFromPoints(totalPoints);
      document.getElementById('forumsOwned').textContent = stats.forumsOwned || 0;
      
      // Display achievements
      displayAchievements('all');
    }

    function displayAchievements(category) {
      const grid = document.getElementById('achievementsGrid');
      const filteredAchievements = category === 'all' 
        ? achievementDefinitions 
        : achievementDefinitions.filter(a => a.category === category);
      
      grid.innerHTML = filteredAchievements.map(achievement => {
        const isUnlocked = userAchievements.some(a => a.id === achievement.id);
        const stats = {}; // We'll get this from the display call
        const progress = getAchievementProgress(achievement, stats);
        
        return `
          <div class="achievement-card ${isUnlocked ? 'unlocked' : ''}">
            <div class="achievement-rarity ${achievement.rarity}">${achievement.rarity}</div>
            <div class="achievement-icon">
              <i class='bx ${achievement.icon}'></i>
            </div>
            <h3 class="font-bold text-rp-text text-center mb-2">${achievement.name}</h3>
            <p class="text-sm text-rp-subtle text-center mb-3">${achievement.description}</p>
            <div class="flex items-center justify-between">
              <span class="achievement-badge ${achievement.rarity}">
                <i class='bx bx-star'></i>
                ${achievement.points} XP
              </span>
              ${isUnlocked ? 
                '<span class="text-rp-foam text-sm">âœ“ Unlocked</span>' : 
                progress > 0 ? `
                  <div class="achievement-progress">
                    <div class="achievement-progress-bar" style="width: ${Math.min(progress * 100, 100)}%"></div>
                  </div>
                ` : '<span class="text-rp-muted text-sm">Locked</span>'
              }
            </div>
          </div>
        `;
      }).join('');
    }

    function getAchievementProgress(achievement, stats) {
      // This would calculate progress for progressive achievements
      // For now, return 0 for locked, 1 for unlocked
      const isUnlocked = userAchievements.some(a => a.id === achievement.id);
      return isUnlocked ? 1 : 0;
    }

    function getUserRankFromPoints(points) {
      if (points >= 1000) return 'Legend';
      if (points >= 500) return 'Master';
      if (points >= 250) return 'Expert';
      if (points >= 100) return 'Advanced';
      if (points >= 50) return 'Intermediate';
      if (points >= 10) return 'Beginner';
      return 'Newcomer';
    }

    // Achievement tracking functions
    async function trackForumPost() {
      if (!currentUser) return;
      
      // Check if it's a late night post
      const hour = new Date().getHours();
      const isLateNight = hour >= 0 && hour < 6;
      
      const updateData = {
        forumPosts: firebase.firestore.FieldValue.increment(1)
      };
      
      if (isLateNight) {
        updateData.lateNightPosts = firebase.firestore.FieldValue.increment(1);
      }
      
      await db.collection('users').doc(currentUser.uid).update(updateData);
      
      // Check achievements
      const stats = await getUserStats();
      await checkAchievements(stats);
    }

    async function trackReactionGiven() {
      if (!currentUser) return;
      
      await db.collection('users').doc(currentUser.uid).update({
        reactionsGiven: firebase.firestore.FieldValue.increment(1)
      });
      
      const stats = await getUserStats();
      await checkAchievements(stats);
    }

    async function trackMessageSent() {
      if (!currentUser) return;
      
      await db.collection('users').doc(currentUser.uid).update({
        messagesSent: firebase.firestore.FieldValue.increment(1)
      });
      
      const stats = await getUserStats();
      await checkAchievements(stats);
    }

    // FORUM SHARING FUNCTIONS
    function showShareForumModal() {
      if (!currentForumId) return;
      
      // Get current forum data
      db.collection('forums').doc(currentForumId).get().then(doc => {
        if (doc.exists) {
          const forumData = doc.data();
          
          // Update modal content
          document.getElementById('shareForumName').textContent = forumData.name;
          document.getElementById('shareForumDescription').textContent = forumData.description;
          
          // Generate share link
          const shareLink = `${window.location.origin}${window.location.pathname}?forum=${currentForumId}`;
          document.getElementById('shareForumLink').value = shareLink;
          
          // Reset copy button
          const copyBtn = document.getElementById('copyLinkBtn');
          copyBtn.innerHTML = '<i class="bx bx-copy"></i> Copy';
          copyBtn.classList.remove('copied');
          
          // Show modal
          document.getElementById('shareForumModal').classList.add('show');
        }
      }).catch(error => {
        console.error('Error loading forum data for sharing:', error);
      });
    }

    function hideShareForumModal() {
      document.getElementById('shareForumModal').classList.remove('show');
    }

    async function copyForumLink() {
      const linkInput = document.getElementById('shareForumLink');
      const copyBtn = document.getElementById('copyLinkBtn');
      
      try {
        await navigator.clipboard.writeText(linkInput.value);
        
        // Update button to show success
        copyBtn.innerHTML = '<i class="bx bx-check"></i> Copied!';
        copyBtn.classList.add('copied');
        
        // Reset after 2 seconds
        setTimeout(() => {
          copyBtn.innerHTML = '<i class="bx bx-copy"></i> Copy';
          copyBtn.classList.remove('copied');
        }, 2000);
        
      } catch (error) {
        console.error('Failed to copy link:', error);
        
        // Fallback: select text for manual copy
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);
        
        copyBtn.innerHTML = '<i class="bx bx-info-circle"></i> Select & Copy';
        setTimeout(() => {
          copyBtn.innerHTML = '<i class="bx bx-copy"></i> Copy';
        }, 2000);
      }
    }

    // Handle forum links from URL parameters
    function handleForumLink() {
      const urlParams = new URLSearchParams(window.location.search);
      const forumId = urlParams.get('forum');
      
      if (forumId) {
        // Auto-open the specified forum
        setTimeout(() => {
          db.collection('forums').doc(forumId).get().then(doc => {
            if (doc.exists) {
              viewForum(forumId, doc.data());
            }
          });
        }, 1000); // Wait for page to load
      }
    }

    // ENHANCED USER STATS AND TRACKING
    async function getUserStats() {
      if (!currentUser) return {};
      
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        // Count friends
        const friendsCount = (userData.friends || []).length;
        
        // Count forums owned by user
        const forumsOwnedSnapshot = await db.collection('forums')
          .where('createdById', '==', currentUser.uid)
          .where('isActive', '==', true)
          .get();
        const forumsOwned = forumsOwnedSnapshot.size;
        
        // Get additional stats
        const stats = {
          forumPosts: userData.forumPosts || 0,
          forumsCreated: userData.forumsCreated || 0,
          forumsOwned: forumsOwned, // Live count
          friendsCount: friendsCount,
          messagesSent: userData.messagesSent || 0,
          forumMessagesSent: userData.forumMessagesSent || 0, // New field
          aiMessagesExchanged: userData.aiMessagesExchanged || 0,
          aiForumPosts: userData.aiForumPosts || 0,
          reactionsGiven: userData.reactionsGiven || 0,
          maxReactionsOnPost: userData.maxReactionsOnPost || 0,
          joinedAt: userData.joinedAt?.toDate() || new Date(),
          consecutiveDays: userData.consecutiveDays || 0,
          lateNightPosts: userData.lateNightPosts || 0,
          totalAchievementPoints: userData.totalAchievementPoints || 0
        };
        
        return stats;
      } catch (error) {
        console.error('Error getting user stats:', error);
        return {};
      }
    }

    // Track forum messages (different from chat messages)
    async function trackForumMessage() {
      if (!currentUser) return;
      
      await db.collection('users').doc(currentUser.uid).update({
        forumMessagesSent: firebase.firestore.FieldValue.increment(1)
      });
      
      const stats = await getUserStats();
      await checkAchievements(stats);
    }

    // FORUM SETTINGS FUNCTIONS
    function showForumSettingsModal() {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      
      document.getElementById('forumSettingsModal').classList.add('show');
      loadMessageHistory();
    }

    function hideForumSettingsModal() {
      document.getElementById('forumSettingsModal').classList.remove('show');
    }

    function switchSettingsTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      // Update content
      document.querySelectorAll('.settings-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`settings-${tabName}`).classList.remove('hidden');
      
      // Load content based on tab
      switch (tabName) {
        case 'messages':
          loadMessageHistory();
          break;
        case 'forums':
          loadOwnedForums();
          break;
        case 'stats':
          loadUserStatsForSettings();
          break;
      }
    }

    async function loadMessageHistory() {
      if (!currentUser) return;
      
      try {
        // Get user's recent posts from all forums
        const postsSnapshot = await db.collectionGroup('posts')
          .where('authorId', '==', currentUser.uid)
          .orderBy('createdAt', 'desc')
          .limit(20)
          .get();
        
        const messages = [];
        for (const doc of postsSnapshot.docs) {
          const post = { id: doc.id, ...doc.data() };
          
          // Get forum name
          const forumId = doc.ref.parent.parent.id;
          const forumDoc = await db.collection('forums').doc(forumId).get();
          const forumName = forumDoc.exists ? forumDoc.data().name : 'Unknown Forum';
          
          messages.push({
            ...post,
            forumId,
            forumName
          });
        }
        
        displayMessageHistory(messages);
      } catch (error) {
        console.error('Error loading message history:', error);
        document.getElementById('messageCount').textContent = 'Error loading messages';
      }
    }

    function displayMessageHistory(messages) {
      const container = document.getElementById('messageHistoryList');
      const countElement = document.getElementById('messageCount');
      const noMessages = document.getElementById('noMessages');
      
      countElement.textContent = `${messages.length} messages found`;
      
      if (messages.length === 0) {
        container.innerHTML = '';
        noMessages.classList.remove('hidden');
        return;
      }
      
      noMessages.classList.add('hidden');
      
      container.innerHTML = messages.map(message => `
        <div class="message-item">
          <div class="message-meta">
            <span><i class='bx bx-collection'></i> ${sanitizeText(message.forumName)}</span>
            <span><i class='bx bx-time'></i> ${formatDate(message.createdAt)}</span>
            <span><i class='bx bx-heart'></i> ${Object.values(message.reactions || {}).reduce((sum, r) => sum + r.count, 0)} reactions</span>
          </div>
          <div class="font-medium text-rp-text mb-1">${sanitizeText(message.title)}</div>
          <div class="message-content">${sanitizeContent(message.content)}</div>
          <div class="mt-2">
            <button onclick="viewForumFromSettings('${message.forumId}')" class="forum-action-btn">
              <i class='bx bx-link-external'></i>
              View Forum
            </button>
          </div>
        </div>
      `).join('');
    }

    async function loadOwnedForums() {
      if (!currentUser) return;
      
      try {
        const forumsSnapshot = await db.collection('forums')
          .where('createdById', '==', currentUser.uid)
          .where('isActive', '==', true)
          .orderBy('createdAt', 'desc')
          .get();
        
        const forums = [];
        for (const doc of forumsSnapshot.docs) {
          const forum = { id: doc.id, ...doc.data() };
          
          // Get post count
          const postsSnapshot = await db.collection('forums').doc(doc.id).collection('posts').get();
          forum.actualPostCount = postsSnapshot.size;
          
          forums.push(forum);
        }
        
        displayOwnedForums(forums);
      } catch (error) {
        console.error('Error loading owned forums:', error);
        document.getElementById('forumCount').textContent = 'Error loading forums';
      }
    }

    function displayOwnedForums(forums) {
      const container = document.getElementById('ownedForumsList');
      const countElement = document.getElementById('forumCount');
      const noForums = document.getElementById('noForums');
      
      countElement.textContent = `${forums.length} forums owned`;
      
      if (forums.length === 0) {
        container.innerHTML = '';
        noForums.classList.remove('hidden');
        return;
      }
      
      noForums.classList.add('hidden');
      
      container.innerHTML = forums.map(forum => `
        <div class="forum-item" id="forum-item-${forum.id}">
          <div class="forum-meta">
            <div class="forum-stats">
              <span><i class='bx bx-message'></i> ${forum.actualPostCount} posts</span>
              <span><i class='bx bx-group'></i> ${forum.memberCount || 0} members</span>
              <span><i class='bx bx-time'></i> Created ${formatDate(forum.createdAt)}</span>
            </div>
            <span class="text-rp-muted">${forum.category}</span>
          </div>
          
          <h4 class="font-bold text-rp-text mb-2">${sanitizeText(forum.name)}</h4>
          <p class="text-rp-subtle mb-3">${sanitizeText(forum.description)}</p>
          
          <div class="forum-actions">
            <button onclick="viewForumFromSettings('${forum.id}')" class="forum-action-btn">
              <i class='bx bx-link-external'></i>
              Open Forum
            </button>
            <button onclick="shareForumFromSettings('${forum.id}')" class="forum-action-btn">
              <i class='bx bx-share'></i>
              Share
            </button>
            <button onclick="showDeleteConfirmation('${forum.id}')" class="forum-action-btn danger">
              <i class='bx bx-trash'></i>
              Delete
            </button>
          </div>
          
          <div id="delete-confirm-${forum.id}" class="delete-confirmation hidden">
            <strong>âš ï¸ This action cannot be undone!</strong><br>
            Type "DELETE" to confirm:
            <input type="text" id="delete-input-${forum.id}" placeholder="DELETE" />
            <button onclick="confirmDeleteFromSettings('${forum.id}')">Delete Forum</button>
            <button onclick="hideDeleteConfirmation('${forum.id}')">Cancel</button>
          </div>
        </div>
      `).join('');
    }

    async function loadUserStatsForSettings() {
      if (!currentUser) return;
      
      try {
        const stats = await getUserStats();
        
        document.getElementById('statsForumPosts').textContent = stats.forumPosts || 0;
        document.getElementById('statsForumsCreated').textContent = stats.forumsCreated || 0;
        document.getElementById('statsReactionsGiven').textContent = stats.reactionsGiven || 0;
        document.getElementById('statsMessagesSent').textContent = (stats.messagesSent || 0) + (stats.forumMessagesSent || 0);
        document.getElementById('statsJoinDate').textContent = stats.joinedAt ? stats.joinedAt.toLocaleDateString() : 'Unknown';
        document.getElementById('statsAchievementPoints').textContent = stats.totalAchievementPoints || 0;
        document.getElementById('statsCurrentRank').textContent = getUserRankFromPoints(stats.totalAchievementPoints || 0);
      } catch (error) {
        console.error('Error loading user stats:', error);
      }
    }

    function viewForumFromSettings(forumId) {
      hideForumSettingsModal();
      
      // Get forum data and open it
      db.collection('forums').doc(forumId).get().then(doc => {
        if (doc.exists) {
          viewForum(forumId, doc.data());
        }
      });
    }

    function shareForumFromSettings(forumId) {
      hideForumSettingsModal();
      currentForumId = forumId;
      showShareForumModal();
    }

    function showDeleteConfirmation(forumId) {
      document.getElementById(`delete-confirm-${forumId}`).classList.remove('hidden');
    }

    function hideDeleteConfirmation(forumId) {
      document.getElementById(`delete-confirm-${forumId}`).classList.add('hidden');
      document.getElementById(`delete-input-${forumId}`).value = '';
    }

    async function confirmDeleteFromSettings(forumId) {
      const input = document.getElementById(`delete-input-${forumId}`);
      
      if (input.value.trim() !== 'DELETE') {
        alert('Please type "DELETE" to confirm');
        return;
      }
      
      try {
        // Get forum data
        const forumDoc = await db.collection('forums').doc(forumId).get();
        if (!forumDoc.exists) {
          alert('Forum not found');
          return;
        }
        
        const batch = db.batch();
        
        // Delete all posts in the forum
        const postsSnapshot = await db.collection('forums').doc(forumId).collection('posts').get();
        postsSnapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        // Delete the forum
        batch.delete(db.collection('forums').doc(forumId));
        
        // Update user's forum count
        batch.update(db.collection('users').doc(currentUser.uid), {
          forumsCreated: firebase.firestore.FieldValue.increment(-1)
        });
        
        await batch.commit();
        
        // Remove from UI
        document.getElementById(`forum-item-${forumId}`).remove();
        
        // Update count
        const remainingForums = document.querySelectorAll('#ownedForumsList .forum-item').length;
        document.getElementById('forumCount').textContent = `${remainingForums} forums owned`;
        
        if (remainingForums === 0) {
          document.getElementById('noForums').classList.remove('hidden');
        }
        
        // Refresh main forum list if visible
        loadForums();
        
        alert('Forum deleted successfully');
      } catch (error) {
        console.error('Error deleting forum:', error);
        alert('Error deleting forum. Please try again.');
            }
    }

    // SIMPLIFIED SHOP IMPLEMENTATION
    function openCarbonShop() {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      
      // Load user's shop data
      loadUserShopData();
      
      const shopModal = document.createElement('div');
      shopModal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[9999]';
      shopModal.id = 'carbonShopModal';
      shopModal.innerHTML = `
        <div class="bg-rp-surface border border-rp-overlay rounded-xl shadow-2xl max-w-4xl w-[90vw] h-[80vh] flex">
          <!-- Sidebar -->
          <div class="w-64 bg-rp-overlay/50 p-6 border-r border-rp-highlight-med">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-semibold text-rp-text">Carbon Shop</h2>
              <button onclick="closeShop()" class="text-rp-muted hover:text-rp-love transition-colors">
                <i class="bx bx-x text-2xl"></i>
              </button>
            </div>
            
            <div class="bg-rp-foam/10 border border-rp-foam/30 rounded-lg p-4 mb-6">
              <div class="flex items-center gap-2 mb-2">
                <i class="bx bx-coin text-rp-gold text-xl"></i>
                <span class="text-rp-text font-medium">Your Balance</span>
              </div>
              <div class="text-2xl font-bold text-rp-gold" id="shop-currency">${userCurrency}</div>
              <div class="text-xs text-rp-muted">Carbon Coins</div>
            </div>
            
            <nav class="space-y-2">
              <button onclick="showShopSection('frames')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg bg-rp-foam/20 text-rp-foam">
                <i class="bx bx-image mr-2"></i>Game Frames
              </button>
              <button onclick="showShopSection('pets')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-rp-highlight-med text-rp-text">
                <i class="bx bx-heart mr-2"></i>Digital Pets
              </button>
              <button onclick="showShopSection('profileframes')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-rp-highlight-med text-rp-text">
                <i class="bx bx-user mr-2"></i>Profile Frames
              </button>
            </nav>
          </div>
          
          <!-- Main Content -->
          <div class="flex-1 p-6 overflow-y-auto">
            <div id="shop-frames" class="shop-section">
              <h3 class="text-2xl font-bold text-rp-text mb-6">Game Frames</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${gameFrames.map(frame => `
                  <div class="bg-rp-highlight-med rounded-xl p-6 border border-rp-overlay">
                    <div class="w-full h-32 rounded-lg mb-4 border-4 flex items-center justify-center relative overflow-hidden" 
                         style="border-color: ${frame.color}; background: ${frame.color}15;">
                      <span class="text-rp-text font-medium">Frame Preview</span>
                    </div>
                    <h4 class="text-lg font-semibold text-rp-text mb-2">${frame.name}</h4>
                    <p class="text-sm text-rp-muted mb-4">${frame.description}</p>
                    <div class="flex items-center justify-between">
                      <div class="text-rp-gold font-bold">${frame.price} coins</div>
                      <button onclick="purchaseFrame('${frame.id}')" 
                              class="px-4 py-2 rounded-lg transition-colors ${userFrames.includes(frame.id) ? 'bg-rp-pine/20 text-rp-pine' : userCurrency >= frame.price ? 'bg-rp-foam hover:bg-rp-foam/80 text-rp-base' : 'bg-rp-muted/20 text-rp-muted cursor-not-allowed'}">
                        ${userFrames.includes(frame.id) ? 'Owned' : userCurrency >= frame.price ? 'Purchase' : 'Insufficient Funds'}
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div id="shop-pets" class="shop-section hidden">
              <h3 class="text-2xl font-bold text-rp-text mb-6">Digital Pets</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${pets.map(pet => `
                  <div class="bg-rp-highlight-med rounded-xl p-6 border border-rp-overlay">
                    <div class="w-full h-32 rounded-lg mb-4 flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-rp-foam/10 to-rp-iris/10">
                      <div class="text-6xl animate-bounce">${pet.emoji}</div>
                      <div class="absolute top-2 right-2 px-2 py-1 rounded-full text-xs font-bold ${pet.rarity === 'legendary' ? 'bg-rp-gold/20 text-rp-gold' : pet.rarity === 'epic' ? 'bg-rp-iris/20 text-rp-iris' : pet.rarity === 'rare' ? 'bg-rp-foam/20 text-rp-foam' : 'bg-rp-muted/20 text-rp-muted'}">${pet.rarity}</div>
                    </div>
                    <h4 class="text-lg font-semibold text-rp-text mb-2">${pet.name}</h4>
                    <p class="text-sm text-rp-muted mb-4">${pet.description}</p>
                    <div class="flex items-center justify-between">
                      <div class="text-rp-gold font-bold">${pet.price} coins</div>
                      <button onclick="purchasePet('${pet.id}')" 
                              class="px-4 py-2 rounded-lg transition-colors ${userPets.includes(pet.id) ? 'bg-rp-pine/20 text-rp-pine' : userCurrency >= pet.price ? 'bg-rp-foam hover:bg-rp-foam/80 text-rp-base' : 'bg-rp-muted/20 text-rp-muted cursor-not-allowed'}">
                        ${userPets.includes(pet.id) ? 'Adopted' : userCurrency >= pet.price ? 'Adopt' : 'Insufficient Funds'}
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div id="shop-profileframes" class="shop-section hidden">
              <h3 class="text-2xl font-bold text-rp-text mb-6">Profile Frames</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${profileFrames.map(frame => `
                  <div class="bg-rp-highlight-med rounded-xl p-6 border border-rp-overlay">
                    <div class="w-full h-32 rounded-lg mb-4 border-4 flex items-center justify-center relative overflow-hidden" 
                         style="border-color: ${frame.color}; background: ${frame.color}15;">
                      <div class="w-16 h-16 rounded-full border-4" style="border-color: ${frame.color}; background: var(--theme-surface);"></div>
                    </div>
                    <h4 class="text-lg font-semibold text-rp-text mb-2">${frame.name}</h4>
                    <p class="text-sm text-rp-muted mb-4">${frame.description}</p>
                    <div class="flex items-center justify-between">
                      <div class="text-rp-gold font-bold">${frame.price} coins</div>
                      <button onclick="purchaseProfileFrame('${frame.id}')" 
                              class="px-4 py-2 rounded-lg transition-colors ${userProfileFrames.includes(frame.id) ? 'bg-rp-pine/20 text-rp-pine' : userCurrency >= frame.price ? 'bg-rp-foam hover:bg-rp-foam/80 text-rp-base' : 'bg-rp-muted/20 text-rp-muted cursor-not-allowed'}">
                        ${userProfileFrames.includes(frame.id) ? 'Owned' : userCurrency >= frame.price ? 'Purchase' : 'Insufficient Funds'}
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(shopModal);
      
      // Close on backdrop click
      shopModal.addEventListener('click', (e) => {
        if (e.target === shopModal) {
          closeShop();
        }
      });
    }

    function closeShop() {
      const shopModal = document.getElementById('carbonShopModal');
      if (shopModal) {
        shopModal.remove();
      }
    }

    function showShopSection(sectionName) {
      // Update nav buttons
      document.querySelectorAll('.shop-nav-btn').forEach(btn => {
        btn.className = 'shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-rp-highlight-med text-rp-text';
      });
      document.querySelector(`[onclick="showShopSection('${sectionName}')"]`).className = 'shop-nav-btn w-full text-left px-3 py-2 rounded-lg bg-rp-foam/20 text-rp-foam';
      
      // Update content
      document.querySelectorAll('.shop-section').forEach(section => {
        section.classList.add('hidden');
      });
      document.getElementById(`shop-${sectionName}`).classList.remove('hidden');
    }

    async function loadUserShopData() {
      if (!currentUser) return;
      
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          userCurrency = userData.currency || 100;
          userFrames = userData.frames || [];
          userPets = userData.pets || [];
          userProfileFrames = userData.profileFrames || [];
        }
      } catch (error) {
        console.error('Error loading shop data:', error);
      }
    }

    async function purchaseFrame(frameId) {
      const frame = gameFrames.find(f => f.id === frameId);
      if (!frame || userFrames.includes(frameId) || userCurrency < frame.price) return;
      
      try {
        await db.collection('users').doc(currentUser.uid).update({
          currency: firebase.firestore.FieldValue.increment(-frame.price),
          frames: firebase.firestore.FieldValue.arrayUnion(frameId)
        });
        
        userCurrency -= frame.price;
        userFrames.push(frameId);
        
        // Refresh shop
        closeShop();
        openCarbonShop();
        
        alert(`Successfully purchased ${frame.name}!`);
      } catch (error) {
        console.error('Error purchasing frame:', error);
        alert('Error purchasing frame');
      }
    }

    async function purchasePet(petId) {
      const pet = pets.find(p => p.id === petId);
      if (!pet || userPets.includes(petId) || userCurrency < pet.price) return;
      
      try {
        await db.collection('users').doc(currentUser.uid).update({
          currency: firebase.firestore.FieldValue.increment(-pet.price),
          pets: firebase.firestore.FieldValue.arrayUnion(petId)
        });
        
        userCurrency -= pet.price;
        userPets.push(petId);
        
        // Refresh shop
        closeShop();
        openCarbonShop();
        
        alert(`Successfully adopted ${pet.name}!`);
      } catch (error) {
        console.error('Error purchasing pet:', error);
        alert('Error adopting pet');
      }
    }

    async function purchaseProfileFrame(frameId) {
      const frame = profileFrames.find(f => f.id === frameId);
      if (!frame || userProfileFrames.includes(frameId) || userCurrency < frame.price) return;
      
      try {
        await db.collection('users').doc(currentUser.uid).update({
          currency: firebase.firestore.FieldValue.increment(-frame.price),
          profileFrames: firebase.firestore.FieldValue.arrayUnion(frameId)
        });
        
        userCurrency -= frame.price;
        userProfileFrames.push(frameId);
        
        // Refresh shop
        closeShop();
        openCarbonShop();
        
        alert(`Successfully purchased ${frame.name}!`);
      } catch (error) {
        console.error('Error purchasing profile frame:', error);
        alert('Error purchasing profile frame');
             }
     }

    // AI CHAT FUNCTIONALITY
    let aiChatHistory = [];
    
    function showAiChatModal() {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      
      document.getElementById('aiChatModal').classList.add('show');
      
      // Focus input
      setTimeout(() => {
        document.getElementById('aiChatInput').focus();
      }, 100);
    }

    function hideAiChatModal() {
      document.getElementById('aiChatModal').classList.remove('show');
    }

    function handleAiInputKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendAiMessage();
      }
    }

    function autoResizeInput(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
    }

    function quickAsk(question) {
      document.getElementById('aiChatInput').value = question;
      sendAiMessage();
    }

    async function sendAiMessage() {
      const input = document.getElementById('aiChatInput');
      const sendBtn = document.getElementById('aiSendBtn');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Clear input and disable send button
      input.value = '';
      input.style.height = 'auto';
      sendBtn.disabled = true;
      
      // Add user message to chat
      addChatMessage('user', message);
      
      // Add typing indicator
      const typingId = addTypingIndicator();
      
      try {
        // Get AI response from Pollinations.ai
        const aiResponse = await getAiResponse(message);
        
        // Remove typing indicator
        removeTypingIndicator(typingId);
        
        // Add AI response to chat
        addChatMessage('ai', aiResponse);
        
        // Check if user wants to post AI response to forum
        const postToForum = document.getElementById('postAsForumPost').checked;
        if (postToForum && currentForumId) {
          await createAiForumPost(message, aiResponse);
        }
        
      } catch (error) {
        console.error('Error getting AI response:', error);
        removeTypingIndicator(typingId);
        addChatMessage('ai', 'Sorry, I encountered an error. Please try again.');
      }
      
      // Re-enable send button
      sendBtn.disabled = false;
    }

    function addChatMessage(sender, message) {
      const messagesContainer = document.getElementById('aiChatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = sender === 'user' ? 'user-message' : 'ai-message';
      
      if (sender === 'ai') {
        messageDiv.innerHTML = `
          <div class="ai-avatar">
            <i class='bx bx-brain'></i>
          </div>
          <div>${sanitizeContent(message)}</div>
        `;
      } else {
        messageDiv.textContent = message;
      }
      
      messagesContainer.appendChild(messageDiv);
      
      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
             // Store in chat history
       aiChatHistory.push({ sender, message, timestamp: new Date() });
       
       // Track AI message exchange for achievements
       if (currentUser && sender === 'ai') {
         trackAiInteraction();
       }
    }

    function addTypingIndicator() {
      const messagesContainer = document.getElementById('aiChatMessages');
      const typingDiv = document.createElement('div');
      const typingId = 'typing-' + Date.now();
      typingDiv.id = typingId;
      typingDiv.className = 'ai-message thinking';
      typingDiv.innerHTML = `
        <div class="ai-avatar">
          <i class='bx bx-brain'></i>
        </div>
        <div class="typing-indicator">
          <span>AI is thinking</span>
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `;
      
      messagesContainer.appendChild(typingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      return typingId;
    }

    function removeTypingIndicator(typingId) {
      const typingElement = document.getElementById(typingId);
      if (typingElement) {
        typingElement.remove();
      }
    }

    async function getAiResponse(userMessage) {
      // Build context from recent chat history
      const context = aiChatHistory.slice(-5).map(msg => 
        `${msg.sender === 'user' ? 'User' : 'AI'}: ${msg.message}`
      ).join('\\n');
      
      // Get current forum context if available
      let forumContext = '';
      if (currentForumId) {
        try {
          const forumDoc = await db.collection('forums').doc(currentForumId).get();
          if (forumDoc.exists) {
            const forumData = forumDoc.data();
            forumContext = `Current forum: "${forumData.name}" - ${forumData.description}\\n`;
          }
        } catch (error) {
          console.log('Could not get forum context:', error);
        }
      }
      
      // Construct the prompt
      const prompt = `You are a helpful AI assistant in a forum discussion. Be friendly, informative, and concise.
      
      ${forumContext}${context ? 'Recent conversation:\\n' + context + '\\n' : ''}
      
      User: ${userMessage}
      
      AI:`;
      
      // Make request to Pollinations.ai
      const response = await fetch('https://text.pollinations.ai/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          messages: [
            {
              role: 'system',
              content: 'You are a helpful AI assistant in a forum discussion. Be friendly, informative, and concise. Keep responses under 300 words.'
            },
            {
              role: 'user', 
              content: userMessage
            }
          ],
          model: 'openai',
          jsonMode: false
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const aiResponse = await response.text();
      return aiResponse.trim();
    }

    async function createAiForumPost(userQuestion, aiResponse) {
      if (!currentUser || !currentForumId) return;
      
      try {
        // Create a forum post with the AI response
        const postTitle = `AI Response: ${userQuestion.substring(0, 50)}${userQuestion.length > 50 ? '...' : ''}`;
        const postContent = `**Question:** ${userQuestion}

**AI Response:**
${aiResponse}`;
        
        await db.collection('forums').doc(currentForumId).collection('posts').add({
          title: sanitizeText(postTitle),
          content: sanitizeContent(postContent),
          authorName: 'AI Assistant',
          authorId: 'ai-assistant',
          authorPhoto: '',
          authorRank: 'ai',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          likes: 0,
          replies: 0,
          reactions: {},
          isAiPost: true,
          originalQuestion: sanitizeText(userQuestion),
          askedBy: currentUser.uid,
          askedByName: currentUser.displayName || 'Anonymous'
        });
        
        // Update forum post count and last activity
        await db.collection('forums').doc(currentForumId).update({
          postCount: firebase.firestore.FieldValue.increment(1),
          lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Refresh posts display
        loadPosts(currentForumId);
        
                 // Track AI forum post for achievements
         await trackAiForumPost();
         
         // Show success message
         addChatMessage('ai', 'âœ… I\'ve posted my response to the forum!');
         
       } catch (error) {
        console.error('Error creating AI forum post:', error);
        addChatMessage('ai', 'âŒ Sorry, I couldn\'t post to the forum. Please try again.');
             }
     }

    function askAiAboutPost(postId, postTitle, postContent) {
      showAiChatModal();
      
      // Pre-fill the chat with a question about the post
      setTimeout(() => {
        const question = `Can you help me understand this post better? 

Title: "${postTitle}"
Content: "${postContent.substring(0, 200)}${postContent.length > 200 ? '...' : ''}"

What are your thoughts on this?`;
        
        document.getElementById('aiChatInput').value = question;
        autoResizeInput(document.getElementById('aiChatInput'));
        
        // Optionally send immediately
        // sendAiMessage();
             }, 200);
     }

    async function trackAiInteraction() {
      if (!currentUser) return;
      
      try {
        await db.collection('users').doc(currentUser.uid).update({
          aiMessagesExchanged: firebase.firestore.FieldValue.increment(1)
        });
        
        const stats = await getUserStats();
        await checkAchievements(stats);
      } catch (error) {
        console.error('Error tracking AI interaction:', error);
      }
    }

    async function trackAiForumPost() {
      if (!currentUser) return;
      
      try {
        await db.collection('users').doc(currentUser.uid).update({
          aiForumPosts: firebase.firestore.FieldValue.increment(1)
        });
        
        const stats = await getUserStats();
        await checkAchievements(stats);
      } catch (error) {
        console.error('Error tracking AI forum post:', error);
      }
    }

              // Close modals when clicking outside
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          hideCreateForumModal();
          hideForumViewModal();
          hideChatModal();
          hideAddFriendsModal();
          hideDeleteForumModal();
          hideAchievementsModal();
          hideShareForumModal();
          hideForumSettingsModal();
          hideAiChatModal();
        }
      
      // Hide login prompt when clicking outside
      if (!e.target.closest('#loginPrompt') && !e.target.closest('#signInBtn') && 
          !e.target.closest('button[onclick*="showLoginPrompt"]')) {
        hideLoginPrompt();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideCreateForumModal();
        hideForumViewModal();
        hideLoginPrompt();
        hideChatModal();
        hideAddFriendsModal();
        hideDeleteForumModal();
        hideAchievementsModal();
        hideShareForumModal();
        hideForumSettingsModal();
        hideAiChatModal();
      }
      
      // Send message on Enter
      if (e.key === 'Enter' && e.target.id === 'chatInput') {
        e.preventDefault();
        sendMessage();
      }
    });

    // Event Listeners
    // ONLINE USERS AND FORUM MANAGEMENT
    function updateForumCounts(totalForums, pinnedForums) {
      document.getElementById('totalForums').textContent = totalForums;
      document.getElementById('pinnedCount').textContent = pinnedForums;
    }

    async function toggleForumPin(forumId, shouldPin) {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }

      if (userRank !== 'owner' && userRank !== 'admin' && userRank !== 'moderator') {
        alert('Only moderators and above can pin/unpin forums');
        return;
      }

      try {
        await db.collection('forums').doc(forumId).update({
          isPinned: shouldPin,
          pinnedAt: shouldPin ? firebase.firestore.FieldValue.serverTimestamp() : firebase.firestore.FieldValue.delete(),
          pinnedBy: shouldPin ? currentUser.uid : firebase.firestore.FieldValue.delete()
        });

        // Refresh forums display
        loadForums();
        
        const action = shouldPin ? 'pinned' : 'unpinned';
        console.log(`Forum ${action} successfully`);
        
      } catch (error) {
        console.error('Error toggling forum pin:', error);
        alert('Error updating forum pin status');
      }
    }

    // FAVORITE EMOJIS SYSTEM
    let favoriteEmojis = JSON.parse(localStorage.getItem('favoriteEmojis') || '[]');

    function toggleFavoriteEmoji(emoji, name, event) {
      event.stopPropagation();
      
      const existingIndex = favoriteEmojis.findIndex(fav => fav.emoji === emoji);
      
      if (existingIndex > -1) {
        // Remove from favorites
        favoriteEmojis.splice(existingIndex, 1);
        event.target.closest('.emoji-favorite-btn').classList.remove('favorited');
        event.target.innerHTML = '<i class="bx bx-star"></i>';
      } else {
        // Add to favorites
        favoriteEmojis.push({ emoji, name, addedAt: Date.now() });
        event.target.closest('.emoji-favorite-btn').classList.add('favorited');
        event.target.innerHTML = '<i class="bx bxs-star"></i>';
      }
      
      // Save to localStorage
      localStorage.setItem('favoriteEmojis', JSON.stringify(favoriteEmojis));
      
      // Update all open favorites sections
      updateAllFavoritesSections();
      
      console.log('Favorite emojis updated:', favoriteEmojis.length);
    }

    function updateAllFavoritesSections() {
      document.querySelectorAll('[id^="favorites-grid-"]').forEach(grid => {
        updateFavoritesGrid(grid);
      });
    }

    function updateFavoritesGrid(grid) {
      if (favoriteEmojis.length === 0) {
        grid.innerHTML = '<div class="no-favorites">No favorite emojis yet</div>';
        return;
      }
      
      grid.innerHTML = favoriteEmojis.slice(0, 16).map(fav => `
        <div class="favorite-emoji" onclick="addReactionFromFavorite('${getPostIdFromGrid(grid)}', '${fav.emoji}')" title="${fav.name}">
          ${fav.emoji}
          <div class="favorite-star">â˜…</div>
        </div>
      `).join('');
    }

    function getPostIdFromGrid(grid) {
      const gridId = grid.id;
      return gridId.replace('favorites-grid-', '');
    }

    function addReactionFromFavorite(postId, emoji) {
      addReaction(postId, emoji);
      hideActiveReactionPicker();
    }

    function initializeFavoriteEmojis() {
      // Update favorite button states in existing grids
      updateAllFavoritesSections();
    }

    // POST FORMATTING SYSTEM
    let isPreviewMode = false;

    function applyFormat(formatType) {
      const textarea = document.getElementById('postContent');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const selectedText = textarea.value.substring(start, end);
      
      let beforeText = '';
      let afterText = '';
      let newCursorPos = start;
      
      switch (formatType) {
        case 'bold':
          beforeText = '**';
          afterText = '**';
          break;
        case 'italic':
          beforeText = '*';
          afterText = '*';
          break;
        case 'quote':
          beforeText = '> ';
          afterText = '';
          break;
        case 'code':
          beforeText = '`';
          afterText = '`';
          break;
        case 'codeblock':
          beforeText = '```\n';
          afterText = '\n```';
          break;
        case 'spoiler':
          beforeText = '||';
          afterText = '||';
          break;
      }
      
      const newText = textarea.value.substring(0, start) + 
                     beforeText + selectedText + afterText + 
                     textarea.value.substring(end);
      
      textarea.value = newText;
      
      // Set cursor position
      if (selectedText) {
        newCursorPos = start + beforeText.length + selectedText.length + afterText.length;
      } else {
        newCursorPos = start + beforeText.length;
      }
      
      textarea.setSelectionRange(newCursorPos, newCursorPos);
      textarea.focus();
      
      // Update preview if active
      if (isPreviewMode) {
        updatePreview();
      }
    }

    function togglePreview() {
      const textarea = document.getElementById('postContent');
      const preview = document.getElementById('formatPreview');
      const toggleBtn = document.getElementById('previewToggle');
      
      isPreviewMode = !isPreviewMode;
      
      if (isPreviewMode) {
        textarea.style.display = 'none';
        preview.classList.add('active');
        toggleBtn.innerHTML = '<i class="bx bx-edit"></i>';
        toggleBtn.classList.add('active');
        updatePreview();
      } else {
        textarea.style.display = 'block';
        preview.classList.remove('active');
        toggleBtn.innerHTML = '<i class="bx bx-show"></i>';
        toggleBtn.classList.remove('active');
      }
    }

    function updatePreview() {
      const textarea = document.getElementById('postContent');
      const preview = document.getElementById('formatPreview');
      const content = textarea.value;
      
      preview.innerHTML = renderMarkdown(content);
    }

    function renderMarkdown(text) {
      return text
        // Bold
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Italic
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Code blocks
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        // Inline code
        .replace(/`(.*?)`/g, '<code>$1</code>')
        // Quotes
        .replace(/^> (.+)/gm, '<blockquote>$1</blockquote>')
        // Spoilers
        .replace(/\|\|(.*?)\|\|/g, '<span class="spoiler" onclick="toggleSpoiler(this)">$1</span>')
        // Line breaks
        .replace(/\n/g, '<br>');
    }

    function toggleSpoiler(element) {
      element.classList.toggle('revealed');
    }

    function toggleFormattingHelp() {
      const helpContent = document.getElementById('formattingHelp');
      helpContent.classList.toggle('active');
    }

    // Add keyboard shortcuts
    function setupFormattingShortcuts() {
      const textarea = document.getElementById('postContent');
      
      textarea.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch (e.key) {
            case 'b':
              e.preventDefault();
              applyFormat('bold');
              break;
            case 'i':
              e.preventDefault();
              applyFormat('italic');
              break;
            case '`':
              e.preventDefault();
              applyFormat('code');
              break;
          }
        }
      });
      
             // Real-time preview update
       textarea.addEventListener('input', () => {
         if (isPreviewMode) {
           updatePreview();
         }
       });
     }

     // USER PROFILE SYSTEM
     let activeUserPopup = null;

     function showUserProfile(userId, userName, userRank, userPhoto, event) {
       event.preventDefault();
       event.stopPropagation();
       
       // Close any existing popup
       hideUserPopup();
       
       // Don't show popup for own profile, just redirect
       if (currentUser && userId === currentUser.uid) {
         window.open('profile.html', '_blank');
         return;
       }
       
       // Create popup element
       const popup = document.createElement('div');
       popup.className = 'user-profile-popup';
       popup.id = 'userProfilePopup';
       
       // Position popup near the clicked element
       const rect = event.target.getBoundingClientRect();
       popup.style.position = 'fixed';
       popup.style.top = (rect.bottom + 8) + 'px';
       popup.style.left = rect.left + 'px';
       
       // Load user data and show popup
       loadUserProfileData(userId, userName, userRank, userPhoto, popup);
       
       document.body.appendChild(popup);
       activeUserPopup = popup;
       
       // Show popup with animation
       setTimeout(() => {
         popup.classList.add('show');
       }, 10);
       
       // Close on outside click
       setTimeout(() => {
         document.addEventListener('click', handleOutsideClick);
       }, 100);
     }

     function hideUserPopup() {
       if (activeUserPopup) {
         activeUserPopup.remove();
         activeUserPopup = null;
         document.removeEventListener('click', handleOutsideClick);
       }
     }

     function handleOutsideClick(event) {
       if (activeUserPopup && !activeUserPopup.contains(event.target)) {
         hideUserPopup();
       }
     }

     async function loadUserProfileData(userId, userName, userRank, userPhoto, popup) {
       // Show loading state
       popup.innerHTML = `
         <div class="user-profile-header">
           <div class="user-profile-avatar">
             ${userPhoto ? 
               `<img src="${userPhoto}" alt="${userName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
               userName.charAt(0).toUpperCase()
             }
           </div>
           <div class="user-profile-info">
             <h4>${userName}</h4>
             <div class="user-rank">
               <span class="rank-badge rank-${userRank}">${userRank}</span>
             </div>
           </div>
         </div>
         <div style="text-align: center; color: var(--theme-muted); padding: 20px;">
           <i class='bx bx-loader-alt bx-spin'></i> Loading...
         </div>
       `;
       
       try {
         // Fetch user stats from Firestore
         const userDoc = await db.collection('users').doc(userId).get();
         const userData = userDoc.exists ? userDoc.data() : {};
         
         // Get user's post count
         const postsQuery = await db.collection('forumPosts')
           .where('authorId', '==', userId)
           .get();
         const postCount = postsQuery.size;
         
         // Get user's forum count
         const forumsQuery = await db.collection('forums')
           .where('createdById', '==', userId)
           .get();
         const forumCount = forumsQuery.size;
         
                 // Update popup with actual data
        updateUserProfilePopup(popup, {
          userId,
          userName,
          userRank,
          userPhoto,
          postCount,
          forumCount,
          joinDate: userData.createdAt || null,
          achievementPoints: userData.achievementPoints || 0,
          xp: userData.xp || 0,
          level: userData.level || 1,
          levelTitle: userData.levelTitle || 'Newcomer',
          levelTier: userData.levelTier || 'novice'
        });
         
       } catch (error) {
         console.error('Error loading user profile:', error);
         popup.innerHTML += `<div style="color: var(--theme-love); text-align: center; margin-top: 8px;">Failed to load profile data</div>`;
       }
     }

           function updateUserProfilePopup(popup, userData) {
        const joinDate = userData.joinDate ? formatDate(userData.joinDate) : 'Unknown';
        const levelData = calculateLevel(userData.xp);
        const progress = formatXPProgress(userData.xp, levelData);
        
        popup.innerHTML = `
          <div class="user-profile-header">
            <div class="user-profile-avatar">
              ${userData.userPhoto ? 
                `<img src="${userData.userPhoto}" alt="${userData.userName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : 
                userData.userName.charAt(0).toUpperCase()
              }
            </div>
            <div class="user-profile-info">
              <h4>${userData.userName}</h4>
              <div class="user-rank">
                <span class="rank-badge rank-${userData.userRank}">${userData.userRank}</span>
                <span class="level-badge ${userData.level >= 15 ? 'prestige' : ''}" title="${userData.levelTitle}">
                  <i class='bx bx-trophy'></i>Lv.${userData.level}
                </span>
              </div>
            </div>
          </div>
          
          <div class="user-profile-level">
            <span class="user-profile-level-number">Level ${userData.level}</span>
            <span class="user-profile-level-title">${userData.levelTitle}</span>
            <div class="xp-bar-container" title="${progress.current}/${progress.needed} XP to next level">
              <div class="xp-bar" style="width: ${progress.percentage}%"></div>
            </div>
            <div class="xp-text">${userData.xp} XP â€¢ ${progress.current}/${progress.needed} to next level</div>
          </div>
         
         <div class="user-profile-stats">
           <div class="user-profile-stat">
             <span class="user-profile-stat-value">${userData.postCount}</span>
             <span class="user-profile-stat-label">Posts</span>
           </div>
           <div class="user-profile-stat">
             <span class="user-profile-stat-value">${userData.forumCount}</span>
             <span class="user-profile-stat-label">Forums</span>
           </div>
           <div class="user-profile-stat">
             <span class="user-profile-stat-value">${userData.achievementPoints}</span>
             <span class="user-profile-stat-label">Points</span>
           </div>
           <div class="user-profile-stat">
             <span class="user-profile-stat-value">${joinDate}</span>
             <span class="user-profile-stat-label">Joined</span>
           </div>
         </div>
         
         <div class="user-profile-actions">
           <a href="profile.html?user=${userData.userId}" target="_blank" class="user-profile-btn">
             <i class='bx bx-user'></i> View Profile
           </a>
           ${currentUser && userData.userId !== currentUser.uid ? `
             <a href="#" class="user-profile-btn" onclick="startChat('${userData.userId}', '${userData.userName}')">
               <i class='bx bx-message'></i> Message
             </a>
           ` : ''}
         </div>
       `;
     }

     function startChat(userId, userName) {
       // Close popup
       hideUserPopup();
       
       // Open friends sidebar and start chat
       const friendsSidebar = document.getElementById('friendsChatSidebar');
       if (friendsSidebar) {
         friendsSidebar.classList.add('show');
         
         // Focus on chat input if available
         setTimeout(() => {
           const chatInput = document.querySelector('.chat-input');
           if (chatInput) {
             chatInput.focus();
           }
         }, 300);
       }
       
               console.log(`Starting chat with ${userName} (${userId})`);
      }

      // XP AND LEVELING SYSTEM
      const XP_REWARDS = {
        POST_CREATED: 15,
        POST_REACTION: 3,
        FORUM_CREATED: 25,
        DAILY_LOGIN: 10,
        ACHIEVEMENT_UNLOCKED: 50,
        FIRST_POST: 30,
        LEVEL_UP_BONUS: 100
      };

      const LEVEL_THRESHOLDS = [
        { level: 1, xp: 0, title: 'Newcomer', tier: 'novice' },
        { level: 2, xp: 100, title: 'Explorer', tier: 'novice' },
        { level: 3, xp: 250, title: 'Contributor', tier: 'bronze' },
        { level: 4, xp: 450, title: 'Active Member', tier: 'bronze' },
        { level: 5, xp: 700, title: 'Community Helper', tier: 'bronze' },
        { level: 6, xp: 1000, title: 'Forum Regular', tier: 'silver' },
        { level: 7, xp: 1350, title: 'Dedicated User', tier: 'silver' },
        { level: 8, xp: 1750, title: 'Community Leader', tier: 'silver' },
        { level: 9, xp: 2200, title: 'Forum Veteran', tier: 'gold' },
        { level: 10, xp: 2700, title: 'Expert Member', tier: 'gold' },
        { level: 11, xp: 3250, title: 'Community Champion', tier: 'gold' },
        { level: 12, xp: 3850, title: 'Master Contributor', tier: 'platinum' },
        { level: 13, xp: 4500, title: 'Elite Member', tier: 'platinum' },
        { level: 14, xp: 5200, title: 'Forum Legend', tier: 'diamond' },
        { level: 15, xp: 6000, title: 'Grand Master', tier: 'diamond' },
        { level: 16, xp: 7000, title: 'Ultimate User', tier: 'master' },
        { level: 17, xp: 8200, title: 'Supreme Leader', tier: 'grandmaster' },
        { level: 18, xp: 9600, title: 'Forum Deity', tier: 'grandmaster' },
        { level: 19, xp: 11200, title: 'Legendary Master', tier: 'grandmaster' },
        { level: 20, xp: 13000, title: 'Transcendent', tier: 'grandmaster' }
      ];

      function calculateLevel(xp) {
        for (let i = LEVEL_THRESHOLDS.length - 1; i >= 0; i--) {
          if (xp >= LEVEL_THRESHOLDS[i].xp) {
            return LEVEL_THRESHOLDS[i];
          }
        }
        return LEVEL_THRESHOLDS[0];
      }

      function getNextLevel(currentLevel) {
        const nextLevelIndex = LEVEL_THRESHOLDS.findIndex(l => l.level === currentLevel + 1);
        return nextLevelIndex !== -1 ? LEVEL_THRESHOLDS[nextLevelIndex] : null;
      }

      async function awardXP(userId, amount, reason, element = null) {
        if (!userId || amount <= 0) return;

        try {
          const userRef = db.collection('users').doc(userId);
          const userDoc = await userRef.get();
          
          if (!userDoc.exists) return;
          
          const userData = userDoc.data();
          const currentXP = userData.xp || 0;
          const currentLevel = calculateLevel(currentXP);
          const newXP = currentXP + amount;
          const newLevel = calculateLevel(newXP);
          
          // Update user XP
          await userRef.update({
            xp: newXP,
            level: newLevel.level,
            levelTitle: newLevel.title,
            levelTier: newLevel.tier,
            lastXPGain: firebase.firestore.FieldValue.serverTimestamp()
          });

                   // Show XP reward popup
         if (element && userId === currentUser?.uid) {
           showXPReward(element, amount, reason);
         }

         // Update XP widget
         if (userId === currentUser?.uid) {
           setTimeout(() => updateXPWidget(), 200);
         }

         // Check for level up
         if (newLevel.level > currentLevel.level && userId === currentUser?.uid) {
           showLevelUpNotification(newLevel);
           
           // Award level up bonus
           setTimeout(async () => {
             await awardXP(userId, XP_REWARDS.LEVEL_UP_BONUS, 'Level Up Bonus');
           }, 2000);
         }

          console.log(`Awarded ${amount} XP to ${userId} for ${reason}. New total: ${newXP} XP (Level ${newLevel.level})`);
          
        } catch (error) {
          console.error('Error awarding XP:', error);
        }
      }

      function showXPReward(element, amount, reason) {
        const rect = element.getBoundingClientRect();
        const popup = document.createElement('div');
        popup.className = 'xp-reward-popup';
        popup.textContent = `+${amount} XP`;
        
        popup.style.position = 'fixed';
        popup.style.left = (rect.left + rect.width / 2) + 'px';
        popup.style.top = (rect.top - 10) + 'px';
        popup.style.transform = 'translateX(-50%)';
        
        document.body.appendChild(popup);
        
        setTimeout(() => {
          popup.remove();
        }, 1500);
      }

      function showLevelUpNotification(levelData) {
        const notification = document.getElementById('levelUpNotification');
        const levelNumber = document.getElementById('newLevelNumber');
        const levelTitle = document.getElementById('levelTitleText');
        const xpReward = document.getElementById('xpRewardAmount');
        
        levelNumber.textContent = levelData.level;
        levelTitle.textContent = levelData.title;
        xpReward.textContent = XP_REWARDS.LEVEL_UP_BONUS;
        
        notification.classList.add('show');
        
        // Play achievement sound if available
        try {
          const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+D...');
          audio.volume = 0.3;
          audio.play().catch(() => {}); // Ignore if audio fails
        } catch (e) {}
        
        setTimeout(() => {
          notification.classList.remove('show');
        }, 4000);
      }

      function formatXPProgress(currentXP, currentLevel) {
        const nextLevel = getNextLevel(currentLevel.level);
        if (!nextLevel) {
          return { percentage: 100, current: currentXP, needed: 0, total: currentXP };
        }
        
        const currentLevelXP = currentLevel.xp;
        const nextLevelXP = nextLevel.xp;
        const progressXP = currentXP - currentLevelXP;
        const neededXP = nextLevelXP - currentLevelXP;
        const percentage = Math.round((progressXP / neededXP) * 100);
        
        return {
          percentage: Math.min(percentage, 100),
          current: progressXP,
          needed: neededXP,
          total: currentXP
        };
      }

      function getLevelBadgeHTML(levelData, includeProgress = false, currentXP = 0) {
        const isPrestige = levelData.level >= 15;
        const progress = includeProgress ? formatXPProgress(currentXP, levelData) : null;
        
        let html = `<span class="level-badge ${isPrestige ? 'prestige' : ''}" title="${levelData.title}">
          <i class='bx bx-trophy'></i>
          Lv.${levelData.level}
        </span>`;
        
        if (includeProgress && progress) {
          html += `
            <div class="xp-bar-container" title="${progress.current}/${progress.needed} XP to next level">
              <div class="xp-bar" style="width: ${progress.percentage}%"></div>
            </div>
            <div class="xp-text">${progress.current}/${progress.needed} XP</div>
          `;
        }
        
        return html;
      }

      // Initialize user XP data
      async function initializeUserXP(userId) {
        try {
          const userRef = db.collection('users').doc(userId);
          const userDoc = await userRef.get();
          
          if (userDoc.exists) {
            const userData = userDoc.data();
            if (userData.xp === undefined) {
              // Initialize XP for existing user with starting bonus
              const levelData = LEVEL_THRESHOLDS[0];
              await userRef.update({
                xp: 50, // Give starting XP to make system visible
                level: levelData.level,
                levelTitle: levelData.title,
                levelTier: levelData.tier
              });
              
              // Show welcome XP notification
              setTimeout(() => {
                showXPReward(document.querySelector('.user-section') || document.body, 50, 'Welcome Bonus');
              }, 1000);
            }
          }
        } catch (error) {
          console.error('Error initializing user XP:', error);
        }
      }

      // Daily login bonus system
      async function checkDailyLoginBonus(userId) {
        try {
          const userRef = db.collection('users').doc(userId);
          const userDoc = await userRef.get();
          
          if (userDoc.exists) {
            const userData = userDoc.data();
            const lastLogin = userData.lastLoginDate ? userData.lastLoginDate.toDate() : null;
            const today = new Date();
            const todayStr = today.toDateString();
            
            // Check if user hasn't logged in today
            if (!lastLogin || lastLogin.toDateString() !== todayStr) {
              // Award daily login bonus
              await userRef.update({
                lastLoginDate: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              // Show daily bonus after a short delay
              setTimeout(async () => {
                await awardXP(userId, XP_REWARDS.DAILY_LOGIN, 'Daily Login Bonus', document.querySelector('#xpWidget'));
              }, 2000);
            }
          }
        } catch (error) {
          console.error('Error checking daily login bonus:', error);
        }
      }

      // Track XP-earning actions
      async function trackPostCreation(postElement) {
        if (currentUser) {
          await awardXP(currentUser.uid, XP_REWARDS.POST_CREATED, 'Post Created', postElement);
        }
      }

      async function trackReactionGiven(reactionElement) {
        if (currentUser) {
          await awardXP(currentUser.uid, XP_REWARDS.POST_REACTION, 'Reaction Given', reactionElement);
        }
      }

      async function trackForumCreation(forumElement) {
        if (currentUser) {
          await awardXP(currentUser.uid, XP_REWARDS.FORUM_CREATED, 'Forum Created', forumElement);
        }
      }

      // Update XP widget display
      async function updateXPWidget(userId = null) {
        if (!userId && !currentUser) return;
        
        const targetUserId = userId || currentUser.uid;
        
        try {
          const userDoc = await db.collection('users').doc(targetUserId).get();
          const userData = userDoc.data() || {};
          const currentXP = userData.xp || 0;
          const levelData = calculateLevel(currentXP);
          const progress = formatXPProgress(currentXP, levelData);
          const nextLevel = getNextLevel(levelData.level);
          
          // Update header elements
          const headerLevel = document.getElementById('headerLevel');
          const headerLevelTitle = document.getElementById('headerLevelTitle');
          const headerXPBar = document.getElementById('headerXPBar');
          const headerCurrentXP = document.getElementById('headerCurrentXP');
          const headerNextLevelXP = document.getElementById('headerNextLevelXP');
          
          if (headerLevel) headerLevel.textContent = levelData.level;
          if (headerLevelTitle) headerLevelTitle.textContent = levelData.title;
          if (headerXPBar) {
            headerXPBar.style.width = progress.percentage + '%';
            // Add level-up animation
            if (progress.percentage === 100 && nextLevel) {
              headerXPBar.classList.add('leveling-up');
              setTimeout(() => headerXPBar.classList.remove('leveling-up'), 500);
            }
          }
          if (headerCurrentXP) headerCurrentXP.textContent = progress.current;
          if (headerNextLevelXP) headerNextLevelXP.textContent = progress.needed;
          
          // Show XP widget for authenticated users
          const xpWidget = document.getElementById('xpWidget');
          if (xpWidget && targetUserId === currentUser?.uid) {
            xpWidget.classList.remove('hidden');
          }
          
        } catch (error) {
          console.error('Error updating XP widget:', error);
        }
      }

      // Enhanced XP reward function with bigger popups
      function showXPReward(element, amount, reason) {
        const rect = element.getBoundingClientRect();
        const popup = document.createElement('div');
        popup.className = 'xp-reward-popup';
        popup.innerHTML = `
          <div style="display: flex; align-items: center; gap: 6px;">
            <i class='bx bx-plus-circle'></i>
            <span>${amount} XP</span>
          </div>
          <div style="font-size: 0.7rem; opacity: 0.9;">${reason}</div>
        `;
        
        popup.style.position = 'fixed';
        popup.style.left = (rect.left + rect.width / 2) + 'px';
        popup.style.top = (rect.top - 20) + 'px';
        popup.style.transform = 'translateX(-50%)';
        popup.style.zIndex = '9999';
        
        document.body.appendChild(popup);
        
        // Update XP widget after showing reward
        setTimeout(() => updateXPWidget(), 100);
        
        setTimeout(() => {
          popup.remove();
        }, 2000);
      }

    // Real-time presence tracking with Firebase
    // REQUIRED FIRESTORE SECURITY RULES for 'presence' collection:
    // rules_version = '2';
    // service cloud.firestore {
    //   match /databases/{database}/documents {
    //     match /presence/{userId} {
    //       allow read: if true; // Anyone can see who's online
    //       allow write: if request.auth != null && request.auth.uid == userId;
    //     }
    //   }
    // }
    let presenceRef;
    let onlineUsersListener;
    let onlineUsers = new Map();

    function initializePresence() {
      if (!currentUser || !db) {
        console.log('Cannot initialize presence: missing user or database');
        return;
      }

      try {
        const userId = currentUser.uid;
        const userDisplayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'Anonymous';
        
        // Reference to user's presence in Firestore
        presenceRef = db.collection('presence').doc(userId);
      
      // Set user as online
      presenceRef.set({
        userId: userId,
        displayName: userDisplayName,
        email: currentUser.email,
        photoURL: currentUser.photoURL || null,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        isOnline: true,
        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        console.log('User presence set:', userDisplayName);
      }).catch(error => {
        console.error('Error setting presence:', error);
      });

      // Note: Firestore doesn't have onDisconnect, we'll use heartbeat system instead
      // Users will be marked offline if they don't update within 2 minutes

      // Update last seen every 30 seconds while online
      setInterval(() => {
        if (presenceRef && currentUser) {
          presenceRef.update({
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }, 30000);

        // Listen to all online users
        setupOnlineUsersListener();
      } catch (error) {
        console.error('Error in initializePresence:', error);
      }
    }

    function setupOnlineUsersListener() {
      try {
        if (onlineUsersListener) {
          onlineUsersListener();
        }

        if (!db) {
          console.log('Database not available for presence listener');
          return;
        }

        // Listen to users who were online in the last 5 minutes
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
        
        onlineUsersListener = db.collection('presence')
          .where('lastSeen', '>', firebase.firestore.Timestamp.fromDate(fiveMinutesAgo))
          .onSnapshot(snapshot => {
          onlineUsers.clear();
          
          snapshot.forEach(doc => {
            const userData = doc.data();
            const lastSeen = userData.lastSeen?.toDate();
            const isRecentlyActive = lastSeen && (Date.now() - lastSeen.getTime()) < 2 * 60 * 1000; // 2 minutes
            
            onlineUsers.set(doc.id, {
              userId: userData.userId,
              displayName: userData.displayName,
              email: userData.email,
              photoURL: userData.photoURL,
              isOnline: userData.isOnline && isRecentlyActive,
              lastSeen: lastSeen,
              avatar: (userData.displayName || 'U').charAt(0).toUpperCase()
            });
          });
            
            updateOnlineUsersDisplay();
          }, error => {
            console.error('Error in presence listener:', error);
          });
      } catch (error) {
        console.error('Error setting up presence listener:', error);
      }
    }

    function updateOnlineUsersDisplay() {
      const onlineUsersList = Array.from(onlineUsers.values()).filter(user => user.isOnline);
      const onlineCount = onlineUsersList.length;

      // Update online count displays
      document.getElementById('onlineCount').textContent = onlineCount;
      document.getElementById('onlineCountIndicator').textContent = onlineCount;

      // Update online users list
      const onlineUsersContent = document.getElementById('onlineUsersContent');
      
      if (onlineCount === 0) {
        onlineUsersContent.innerHTML = '<div class="text-center text-rp-muted py-2">No users currently online</div>';
        return;
      }

      onlineUsersContent.innerHTML = onlineUsersList.map(user => {
        const isCurrentUser = currentUser && user.userId === currentUser.uid;
        const timeAgo = user.lastSeen ? formatTimeAgo(user.lastSeen) : 'Just now';
        
        return `
          <div class="online-user-item">
            ${user.photoURL ? 
              `<img src="${user.photoURL}" alt="${user.displayName}" class="online-user-avatar" style="object-fit: cover;">` :
              `<div class="online-user-avatar">${user.avatar}</div>`
            }
            <div class="flex-1">
              <div class="text-sm font-medium text-rp-text">
                ${user.displayName}${isCurrentUser ? ' (You)' : ''}
              </div>
              <div class="text-xs text-rp-muted">
                ${isCurrentUser ? 'Active now' : `Active ${timeAgo}`}
              </div>
            </div>
            <div class="online-user-status" style="background: ${user.isOnline ? '#22c55e' : '#6b7280'}"></div>
          </div>
        `;
      }).join('');
    }

    function formatTimeAgo(date) {
      const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
      
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      return `${Math.floor(seconds / 86400)}d ago`;
    }

    function cleanupPresence() {
      if (presenceRef && currentUser) {
        presenceRef.update({
          isOnline: false,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(error => {
          console.log('Error updating presence on cleanup:', error);
        });
      }
      
      if (onlineUsersListener) {
        onlineUsersListener();
      }
    }

    // Update online users periodically to check for inactive users
    function updateOnlineUsers() {
      if (currentUser) {
        updateOnlineUsersDisplay();
      } else {
        // Show 0 for guests
        document.getElementById('onlineCount').textContent = 0;
        document.getElementById('onlineCountIndicator').textContent = 0;
        document.getElementById('onlineUsersContent').innerHTML = 
          '<div class="text-center text-rp-muted py-2">Sign in to see online users</div>';
      }
    }

    function initializeForumEnhancements() {
      // Update online users display
      updateOnlineUsers();
      
      // Update forum counts when forums load
      updateForumCounts(0, 0);
    }

                  document.addEventListener('DOMContentLoaded', () => {
      // Show forum content immediately
      console.log('Page loaded, initializing forum for guest browsing');
      loadCategories();
      loadForums();
      setupSearchAndFilters();
      // Initialize guest UI
      updateUserSection().catch(error => {
        console.error('Error initializing guest UI:', error);
      });
      initializeForumEnhancements();
      setupFormattingShortcuts();
      
      // Cleanup presence when page is unloaded
      window.addEventListener('beforeunload', cleanupPresence);
      window.addEventListener('unload', cleanupPresence);
      
      // Handle visibility changes (tab switching)
      document.addEventListener('visibilitychange', () => {
        if (currentUser && presenceRef) {
          if (document.hidden) {
            // Tab is hidden, user is likely inactive
            presenceRef.update({
              lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            });
          } else {
            // Tab is visible again, user is active
            presenceRef.update({
              isOnline: true,
              lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }
      });
      
      // Setup friends sidebar toggle
      const friendsToggle = document.getElementById('friendsSidebarToggle');
      const friendsSidebar = document.getElementById('friendsChatSidebar');
      const closeSidebar = document.getElementById('closeFriendsSidebarBtn');
      const addFriendsBtn = document.getElementById('addFriendsBtn');
      
      friendsToggle.addEventListener('click', () => {
        friendsSidebar.classList.remove('hidden');
      });
      
      closeSidebar.addEventListener('click', () => {
        friendsSidebar.classList.add('hidden');
      });
      
      addFriendsBtn.addEventListener('click', showAddFriendsModal);
      
      // Setup chat input
      const chatInput = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendMessageBtn');
      const charCount = document.getElementById('charCount');
      
      chatInput.addEventListener('input', (e) => {
        charCount.textContent = e.target.value.length;
      });
      
      sendBtn.addEventListener('click', sendMessage);
      
      // Setup user search
      const userSearchInput = document.getElementById('userSearchInput');
      let searchTimeout;
      
      userSearchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchUsers(e.target.value);
        }, 300);
      });

      // Achievement filter functionality
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('achievement-filter')) {
          // Remove active class from all filters
          document.querySelectorAll('.achievement-filter').forEach(btn => {
            btn.classList.remove('active');
          });
          
          // Add active class to clicked filter
          e.target.classList.add('active');
          
          // Filter achievements
          const category = e.target.dataset.category;
          displayAchievements(category);
        }
      });
    });
  </script>
</body>
</html>