<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Forum - CARBON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="carbon-theme.js"></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <!-- DOMPurify for XSS protection -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
  
  <!-- Simple Content Filter -->
  <script>
    // Simple browser-compatible content filter
    class SimpleContentFilter {
      constructor() {
        this.badWords = [
          'spam', 'scam', 'hack', 'cheat', 'bot', 'fake',
          // Add more words as needed, keeping it clean and appropriate
        ];
      }
      
      clean(text) {
        if (!text) return '';
        let cleaned = text;
        this.badWords.forEach(word => {
          const regex = new RegExp(word, 'gi');
          cleaned = cleaned.replace(regex, '*'.repeat(word.length));
        });
        return cleaned;
      }
      
      isProfane(text) {
        if (!text) return false;
        return this.badWords.some(word => 
          text.toLowerCase().includes(word.toLowerCase())
        );
      }
    }
    
    // Make it globally available immediately
    window.Filter = SimpleContentFilter;
    console.log('Content filter class loaded');
  </script>
  
  <script>
    // Tailwind config with theme colors
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'rp-base': '#191724',
            'rp-surface': '#1f1d2e',
            'rp-overlay': '#26233a',
            'rp-muted': '#6e6a86',
            'rp-subtle': '#908caa',
            'rp-text': '#e0def4',
            'rp-love': '#eb6f92',
            'rp-gold': '#f6c177',
            'rp-rose': '#ebbcba',
            'rp-pine': '#31748f',
            'rp-foam': '#9ccfd8',
            'rp-iris': '#c4a7e7',
            'rp-highlight-low': '#21202e',
            'rp-highlight-med': '#403d52',
            'rp-highlight-high': '#524f67'
          }
        }
      }
    }
  </script>
  
  <style>
    :root {
      --text-color: #e0def4;
      --surface-color: #1f1d2e;
      --overlay-color: #26233a;
      --highlight-med: #403d52;
      --highlight-high: #524f67;
      --foam: #9ccfd8;
      --love: #eb6f92;
      --gold: #f6c177;
      --pine: #31748f;
      --iris: #c4a7e7;
      --muted: #6e6a86;
      --subtle: #908caa;

      /* Theme variables - Rose Pine (default) */
      --theme-base: #191724;
      --theme-surface: #1f1d2e;
      --theme-overlay: #26233a;
      --theme-muted: #6e6a86;
      --theme-subtle: #908caa;
      --theme-text: #e0def4;
      --theme-love: #eb6f92;
      --theme-gold: #f6c177;
      --theme-rose: #ebbcba;
      --theme-pine: #31748f;
      --theme-foam: #9ccfd8;
      --theme-iris: #c4a7e7;
      --theme-highlight-low: #21202e;
      --theme-highlight-med: #403d52;
      --theme-highlight-high: #524f67;
      --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
    }
    
    body {
      background: var(--theme-gradient);
      background-attachment: fixed;
      line-height: 1.6;
    }

    /* Enhanced Typography */
    .text-display {
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    .text-heading {
      font-size: 1.875rem;
      font-weight: 600;
      letter-spacing: -0.025em;
    }

    .text-subheading {
      font-size: 1.25rem;
      font-weight: 500;
    }

    /* Enhanced Cards */
    .card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
    }

    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px -1px rgba(0, 0, 0, 0.4);
      border-color: var(--theme-foam);
    }

    /* Enhanced Buttons */
    .btn-primary {
      background: var(--theme-foam);
      color: var(--theme-base);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: var(--theme-pine);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--theme-overlay);
      color: var(--theme-text);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid var(--theme-highlight-med);
      cursor: pointer;
    }

    .btn-secondary:hover {
      background: var(--theme-highlight-med);
      border-color: var(--theme-foam);
    }

    .btn-danger {
      background: var(--theme-love);
      color: var(--theme-text);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: none;
      cursor: pointer;
    }

    .btn-danger:hover {
      background: #d14d72;
      transform: translateY(-1px);
    }

    /* Rank Badges */
    .rank-owner {
      background: linear-gradient(135deg, #f6c177, #eb6f92);
      color: #191724;
    }

    .rank-admin {
      background: linear-gradient(135deg, #eb6f92, #c4a7e7);
      color: #191724;
    }

    .rank-moderator {
      background: linear-gradient(135deg, #9ccfd8, #31748f);
      color: #191724;
    }

    .rank-member {
      background: var(--theme-overlay);
      color: var(--theme-text);
      border: 1px solid var(--theme-highlight-med);
    }

    .rank-badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Forum Categories */
    .category-card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .category-card:hover {
      border-color: var(--theme-foam);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px -1px rgba(0, 0, 0, 0.4);
    }

    .category-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 12px;
    }

    /* Search and Filter Styles */
    .search-input {
      background: var(--theme-overlay);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 8px;
      padding: 12px 16px;
      color: var(--theme-text);
      width: 100%;
      transition: all 0.2s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--theme-foam);
      box-shadow: 0 0 0 3px rgba(156, 207, 216, 0.1);
    }

    .search-input::placeholder {
      color: var(--theme-muted);
    }

    /* Post Styles */
    .post-card {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }

    .post-card:hover {
      border-color: var(--theme-highlight-med);
    }

    .post-author {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .author-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--theme-surface);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .text-display {
        font-size: 2rem;
      }
      
      .text-heading {
        font-size: 1.5rem;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* Loading Spinner */
    .spinner {
      border: 2px solid var(--theme-overlay);
      border-radius: 50%;
      border-top: 2px solid var(--theme-foam);
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body class="bg-rp-base min-h-screen text-rp-text font-[Inter] antialiased">
  <!-- Particles Canvas -->
  <canvas id="particles-canvas" class="fixed inset-0 pointer-events-none hidden"></canvas>

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-6 py-4 bg-rp-surface/80 border-b border-rp-overlay backdrop-blur-sm fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center gap-6">
      <a href="index.html" class="text-xl font-bold text-rp-foam tracking-tight">CARBON</a>
      <div class="hidden md:flex items-center gap-4">
        <a href="index.html" class="text-rp-subtle hover:text-rp-text transition-colors">Home</a>
        <a href="profile.html" class="text-rp-subtle hover:text-rp-text transition-colors">Profile</a>
        <a href="forum.html" class="text-rp-foam font-medium">Forum</a>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div id="userSection"></div>
    </div>
  </nav>

  <!-- LOGIN PROMPT (Optional) -->
  <div id="loginPrompt" class="fixed top-20 right-6 bg-rp-surface rounded-xl shadow-2xl p-6 border border-rp-overlay max-w-sm z-40 hidden">
    <div class="text-center mb-6">
      <h3 class="text-lg font-bold text-rp-foam mb-2">Join the Discussion</h3>
      <p class="text-rp-subtle text-sm">Sign in to create forums and post messages</p>
    </div>
    <button onclick="googleSignIn()" class="w-full flex items-center justify-center gap-3 bg-rp-foam hover:bg-rp-foam/90 text-rp-base font-medium px-4 py-2 rounded-lg transition-all duration-200 mb-3">
      <i class='bx bxl-google text-lg'></i>
      Sign In
    </button>
    <button onclick="hideLoginPrompt()" class="w-full text-rp-muted hover:text-rp-text text-sm">
      Browse as Guest
    </button>
    <div id="loginError" class="text-rp-love mt-3 text-sm text-center hidden"></div>
  </div>

  <!-- MAIN FORUM CONTENT -->
  <main id="forumContent" class="pt-24 pb-16 max-w-7xl mx-auto px-6">
    <!-- Forum Header -->
    <div class="card p-8 mb-8">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
        <div>
          <h1 class="text-display text-rp-text mb-2">CARBON Forum</h1>
          <p class="text-rp-subtle">Connect, discuss, and share with the community</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="userRank" class="rank-badge rank-member hidden">Guest</span>
          <button id="createForumBtn" class="btn-primary hidden" onclick="showCreateForumModal()">
            <i class='bx bx-plus mr-2'></i>
            Create Forum
          </button>
          <button id="signInBtn" class="btn-secondary" onclick="showLoginPrompt()">
            <i class='bx bx-log-in mr-2'></i>
            Sign In
          </button>
        </div>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="card p-6 mb-8">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <div class="relative">
            <input type="text" id="searchInput" placeholder="Search forums and posts..." class="search-input pl-12">
            <i class='bx bx-search absolute left-4 top-1/2 transform -translate-y-1/2 text-rp-muted'></i>
          </div>
        </div>
        <div class="flex gap-3">
          <select id="categoryFilter" class="search-input min-w-[150px]">
            <option value="">All Categories</option>
            <option value="general">General</option>
            <option value="gaming">Gaming</option>
            <option value="tech">Technology</option>
            <option value="support">Support</option>
            <option value="announcements">Announcements</option>
          </select>
          <select id="sortFilter" class="search-input min-w-[150px]">
            <option value="recent">Most Recent</option>
            <option value="popular">Most Popular</option>
            <option value="oldest">Oldest</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Forum Categories -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="categoriesGrid">
      <!-- Categories will be loaded dynamically -->
    </div>

    <!-- Forum Lists -->
    <div class="space-y-6" id="forumsContainer">
      <!-- Forums will be loaded dynamically -->
    </div>

    <!-- Friends & Chat Sidebar -->
    <div id="friendsChatSidebar" class="fixed right-6 top-24 w-80 max-h-[calc(100vh-8rem)] bg-rp-surface rounded-xl border border-rp-overlay shadow-xl backdrop-blur-sm z-30 hidden">
      <!-- Friends List Header -->
      <div class="flex items-center justify-between p-4 border-b border-rp-overlay">
        <h3 class="text-lg font-semibold text-rp-text flex items-center gap-2">
          <i class='bx bx-group text-rp-foam'></i>
          Friends
        </h3>
        <div class="flex items-center gap-2">
          <button id="addFriendsBtn" class="p-2 text-rp-subtle hover:text-rp-foam hover:bg-rp-overlay/50 rounded-lg transition-all duration-200" title="Add Friends">
            <i class='bx bx-user-plus text-lg'></i>
          </button>
          <button id="closeFriendsSidebarBtn" class="p-2 text-rp-subtle hover:text-rp-love hover:bg-rp-love/10 rounded-lg transition-all duration-200">
            <i class='bx bx-x text-lg'></i>
          </button>
        </div>
      </div>

      <!-- Online Friends List -->
      <div class="p-4 max-h-60 overflow-y-auto">
        <h4 class="text-sm font-medium text-rp-text mb-3 flex items-center gap-2">
          <i class='bx bx-wifi text-rp-pine'></i>
          Online Now
        </h4>
        <div id="onlineFriendsListForum" class="space-y-2">
          <!-- Online friends will be populated here -->
        </div>
        <div id="noOnlineFriendsForum" class="text-rp-subtle text-sm text-center py-4">No friends online</div>
      </div>

      <!-- All Friends List -->
      <div class="p-4 border-t border-rp-overlay max-h-60 overflow-y-auto">
        <h4 class="text-sm font-medium text-rp-text mb-3 flex items-center gap-2">
          <i class='bx bx-user text-rp-foam'></i>
          All Friends
        </h4>
        <div id="allFriendsListForum" class="space-y-2">
          <!-- All friends will be populated here -->
        </div>
        <div id="noFriendsForum" class="text-rp-subtle text-sm text-center py-4">
          <i class='bx bx-user-circle text-2xl mb-2 block'></i>
          No friends yet
          <button onclick="showAddFriendsModal()" class="block mx-auto mt-2 px-3 py-1 bg-rp-foam/20 text-rp-foam rounded-lg hover:bg-rp-foam/30 transition-colors text-xs">
            Add Friends
          </button>
        </div>
      </div>
    </div>

    <!-- Friends Sidebar Toggle Button -->
    <button id="friendsSidebarToggle" class="fixed right-6 bottom-6 w-14 h-14 bg-rp-foam hover:bg-rp-foam/90 text-rp-base rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center z-20 hidden">
      <i class='bx bx-group text-xl'></i>
    </button>
  </main>

  <!-- Create Forum Modal -->
  <div id="createForumModal" class="modal">
    <div class="modal-content">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-heading text-rp-text">Create New Forum</h2>
        <button onclick="hideCreateForumModal()" class="text-rp-muted hover:text-rp-text">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      <form id="createForumForm" onsubmit="createForum(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-rp-text font-medium mb-2">Forum Name</label>
            <input type="text" id="forumName" class="search-input" placeholder="Enter forum name" required>
          </div>
          <div>
            <label class="block text-rp-text font-medium mb-2">Description</label>
            <textarea id="forumDescription" class="search-input" rows="3" placeholder="Describe what this forum is about" required></textarea>
          </div>
          <div>
            <label class="block text-rp-text font-medium mb-2">Category</label>
            <select id="forumCategory" class="search-input" required>
              <option value="">Select a category</option>
              <option value="general">General</option>
              <option value="gaming">Gaming</option>
              <option value="tech">Technology</option>
              <option value="support">Support</option>
              <option value="announcements">Announcements</option>
            </select>
          </div>
          <div class="flex gap-3 pt-4">
            <button type="submit" class="btn-primary flex-1">
              <i class='bx bx-plus mr-2'></i>
              Create Forum
            </button>
            <button type="button" onclick="hideCreateForumModal()" class="btn-secondary">
              Cancel
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Forum View Modal -->
  <div id="forumViewModal" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 id="forumTitle" class="text-heading text-rp-text"></h2>
          <p id="forumDesc" class="text-rp-subtle"></p>
        </div>
        <button onclick="hideForumViewModal()" class="text-rp-muted hover:text-rp-text">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      
      <!-- New Post Form -->
      <div class="card p-4 mb-6" id="newPostSection">
        <div id="guestPostMessage" class="text-center py-6">
          <i class='bx bx-message-add text-3xl text-rp-muted mb-3'></i>
          <p class="text-rp-subtle mb-4">Sign in to join the conversation and post in this forum</p>
          <button onclick="showLoginPrompt()" class="btn-primary">
            <i class='bx bx-log-in mr-2'></i>
            Sign In to Post
          </button>
        </div>
        <form id="newPostForm" onsubmit="createPost(event)" class="hidden">
          <div class="space-y-3">
            <input type="text" id="postTitle" class="search-input" placeholder="Post title..." required>
            <textarea id="postContent" class="search-input" rows="3" placeholder="What's on your mind?" required></textarea>
            <div class="flex justify-end">
              <button type="submit" class="btn-primary">
                <i class='bx bx-send mr-2'></i>
                Post
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Posts Container -->
      <div id="postsContainer" class="space-y-4 max-h-96 overflow-y-auto">
        <!-- Posts will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="chatModal" class="modal">
    <div class="modal-content" style="max-width: 600px; max-height: 80vh;">
      <!-- Chat Header -->
      <div class="flex items-center justify-between mb-4 pb-4 border-b border-rp-overlay">
        <div class="flex items-center gap-3">
          <img id="chatFriendAvatar" src="" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
          <div>
            <h3 class="text-lg font-semibold text-rp-text">Chat with <span id="chatFriendName" class="text-rp-foam">Friend</span></h3>
            <p class="text-xs text-rp-subtle">Real-time messaging</p>
          </div>
        </div>
        <button onclick="hideChatModal()" class="text-rp-muted hover:text-rp-text">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      
      <!-- Chat Messages Area -->
      <div id="chatMessages" class="h-64 overflow-y-auto p-4 space-y-3 bg-rp-overlay/20 rounded-lg mb-4">
        <!-- Chat messages will be populated here -->
        <div id="chatPlaceholder" class="text-center text-rp-subtle text-sm py-8">
          <i class='bx bx-message-dots text-2xl mb-2 block'></i>
          Start a conversation with <span id="chatFriendNamePlaceholder" class="text-rp-foam">your friend</span>
        </div>
      </div>
      
      <!-- Chat Input Area -->
      <div class="flex gap-3 items-end">
        <div class="flex-1 relative">
          <input id="chatInput" type="text" maxlength="500" placeholder="Type your message..." 
                 class="w-full px-4 py-3 bg-rp-overlay border border-rp-highlight-med rounded-lg text-rp-text placeholder-rp-subtle focus:outline-none focus:ring-2 focus:ring-rp-foam/50 focus:border-rp-foam transition-all duration-200">
          <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-rp-subtle">
            <span id="charCount">0</span>/500
          </div>
        </div>
        <button id="sendMessageBtn" class="w-12 h-12 bg-rp-foam hover:bg-rp-foam/90 text-rp-base rounded-lg transition-all duration-200 flex items-center justify-center">
          <i class='bx bx-send text-lg'></i>
        </button>
      </div>
      <div class="flex items-center justify-between mt-2 text-xs text-rp-subtle">
        <span>Press Enter to send</span>
        <span id="typingIndicator" class="hidden">Friend is typing...</span>
      </div>
    </div>
  </div>

  <!-- Add Friends Modal -->
  <div id="addFriendsModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-heading text-rp-text">Add Friends</h2>
        <button onclick="hideAddFriendsModal()" class="text-rp-muted hover:text-rp-text">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      
      <!-- Search Users -->
      <div class="mb-6">
        <label class="block text-rp-text font-medium mb-2">Find Users</label>
        <div class="relative">
          <input type="text" id="userSearchInput" class="w-full px-4 py-3 pl-12 bg-rp-overlay border border-rp-highlight-med rounded-lg text-rp-text placeholder-rp-subtle focus:outline-none focus:ring-2 focus:ring-rp-foam/50" placeholder="Search by username or email...">
          <i class='bx bx-search absolute left-4 top-1/2 transform -translate-y-1/2 text-rp-muted'></i>
        </div>
      </div>
      
      <!-- Search Results -->
      <div id="userSearchResults" class="space-y-3 max-h-60 overflow-y-auto">
        <div id="searchPlaceholder" class="text-center text-rp-subtle py-8">
          <i class='bx bx-search text-3xl mb-2 block'></i>
          <p>Search for users to add as friends</p>
        </div>
      </div>
      
      <!-- Friend Requests -->
      <div id="friendRequestsSection" class="mt-6 pt-6 border-t border-rp-overlay">
        <h3 class="text-lg font-medium text-rp-text mb-4 flex items-center gap-2">
          <i class='bx bx-user-plus text-rp-iris'></i>
          Friend Requests
        </h3>
        <div id="friendRequestsList" class="space-y-3">
          <div id="noRequests" class="text-center text-rp-subtle py-4">
            No pending friend requests
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // FIREBASE CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
      authDomain: "carbon-services.firebaseapp.com",
      projectId: "carbon-services",
      storageBucket: "carbon-services.firebasestorage.app",
      messagingSenderId: "288385472070",
      appId: "1:288385472070:web:c4be3ff186e248fc645c47",
      measurementId: "G-Y2K1RQYE74"
    };

    // Initialize Firebase with proper app management
    let app, auth, db;
    let firebaseInitialized = false;
    
    function initializeFirebase() {
      if (firebaseInitialized) {
        return true;
      }
      
      try {
        if (typeof firebase === 'undefined') {
          console.log('Firebase SDK not yet loaded, will retry...');
          return false;
        }

        // Check if Firebase app already exists
        try {
          app = firebase.app();
          console.log('Using existing Firebase app');
        } catch (error) {
          // App doesn't exist, create it
          app = firebase.initializeApp(firebaseConfig);
          console.log('Created new Firebase app');
        }

        // Get auth and firestore instances
        auth = app.auth();
        db = app.firestore();
        
        // Enable auth persistence (this should be set consistently across pages)
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
          .then(() => {
            console.log('Auth persistence set to LOCAL');
          })
          .catch((error) => {
            console.warn('Failed to set auth persistence:', error);
          });
        
        // Set global references for compatibility
        window.auth = auth;
        window.db = db;
        window.firebase = firebase;
        
        firebaseInitialized = true;
        console.log('Firebase initialized successfully');
        return true;
      } catch (error) {
        console.error('Error initializing Firebase:', error);
        return false;
      }
    }

    // Wait for Firebase SDK to load, then initialize
    function waitForFirebaseAndInitialize() {
      if (typeof firebase !== 'undefined') {
        initializeFirebase();
      } else {
        setTimeout(waitForFirebaseAndInitialize, 100);
      }
    }

    // Start initialization process
    waitForFirebaseAndInitialize();

    // Global variables
    let currentUser = null;
    let userRank = 'member';
    let currentForumId = null;
    let badWordsFilter = null;
    let activeChatUser = null;
    let friendsList = [];
    let onlineFriends = [];
    let chatUnsubscribe = null;

    // Initialize content filter when available
    function initializeContentFilter() {
      try {
        if (typeof Filter !== 'undefined') {
          badWordsFilter = new Filter();
          console.log('Content filter initialized successfully');
        } else {
          console.log('Filter class not found, using basic sanitization only');
        }
      } catch (error) {
        console.warn('Error initializing content filter:', error);
        badWordsFilter = null;
      }
    }

    // Initialize content filter after a small delay to ensure Filter class is loaded
    setTimeout(initializeContentFilter, 50);

    // XSS Protection Functions using DOMPurify
    function sanitizeHTML(dirty) {
      return DOMPurify.sanitize(dirty, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
    }

    function sanitizeHTMLWithBasicTags(dirty) {
      return DOMPurify.sanitize(dirty, { 
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'br', 'p'], 
        ALLOWED_ATTR: [] 
      });
    }

    function sanitizeText(text) {
      if (!text) return '';
      let sanitized = sanitizeHTML(String(text));
      // Apply bad words filter if available
      if (badWordsFilter) {
        sanitized = badWordsFilter.clean(sanitized);
      }
      return sanitized;
    }

    function sanitizeContent(content) {
      if (!content) return '';
      let sanitized = sanitizeHTMLWithBasicTags(String(content));
      // Apply bad words filter if available
      if (badWordsFilter) {
        sanitized = badWordsFilter.clean(sanitized);
      }
      return sanitized;
    }

    // AUTHENTICATION FUNCTIONS
    function googleSignIn() {
      // Ensure Firebase is initialized
      if (!auth && !initializeFirebase()) {
        console.error('Firebase not initialized');
        return;
      }
      
      const authInstance = auth || window.auth;
      if (!authInstance) {
        console.error('Firebase Auth not available');
        return;
      }
      
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({
        prompt: 'select_account'
      });
      
      // Try popup first, fallback to redirect if COOP blocks it
      authInstance.signInWithPopup(provider)
        .catch((error) => {
          console.log('Popup blocked, trying redirect method:', error.code);
          
          // If popup is blocked due to COOP or other reasons, use redirect
          if (error.code === 'auth/popup-blocked' || 
              error.code === 'auth/popup-closed-by-user' ||
              error.message.includes('Cross-Origin-Opener-Policy')) {
            
            // Use redirect method as fallback
            authInstance.signInWithRedirect(provider);
          } else {
            // Show other errors to user
            const loginError = document.getElementById('loginError');
            if (loginError) {
              loginError.innerText = error.message;
              loginError.classList.remove('hidden');
            }
          }
        });
    }

    function signOut() {
      const authInstance = auth || window.auth;
      if (authInstance) {
        authInstance.signOut().then(() => {
          // Clear local state
          currentUser = null;
          userRank = 'member';
          // Reload to reset all UI
          location.reload();
        });
      }
    }

    // USER MANAGEMENT FUNCTIONS
    async function ensureUserDoc(user) {
      const userRef = db.collection('users').doc(user.uid);
      const doc = await userRef.get();
      if (!doc.exists) {
        await userRef.set({
          displayName: user.displayName || "",
          photoURL: user.photoURL || "",
          email: user.email || "",
          username: "",
          rank: "member",
          joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
          status: "online",
          forumPosts: 0,
          reputation: 0,
          friends: [],
          blockedUsers: []
        });
      } else {
        // Update last seen and status for existing users
        await userRef.update({
          lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
          status: "online"
        });
      }
    }

    async function getUserRank(uid) {
      try {
        const doc = await db.collection('users').doc(uid).get();
        if (doc.exists) {
          const userData = doc.data();
          return userData.rank || 'member';
        }
        return 'member';
      } catch (error) {
        console.error('Error getting user rank:', error);
        return 'member';
      }
    }

    async function updateUserRank(uid, rank) {
      try {
        await db.collection('users').doc(uid).update({
          rank: rank,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.error('Error updating user rank:', error);
      }
    }

    // FORUM FUNCTIONS
    async function loadCategories() {
      const categories = [
        { id: 'general', name: 'General Discussion', icon: 'bx-chat', color: '#9ccfd8', description: 'General community discussions' },
        { id: 'gaming', name: 'Gaming', icon: 'bx-game', color: '#eb6f92', description: 'Gaming discussions and tips' },
        { id: 'tech', name: 'Technology', icon: 'bx-code-alt', color: '#f6c177', description: 'Tech news and discussions' },
        { id: 'support', name: 'Support', icon: 'bx-help-circle', color: '#c4a7e7', description: 'Get help and support' },
        { id: 'announcements', name: 'Announcements', icon: 'bx-megaphone', color: '#31748f', description: 'Official announcements' }
      ];

      const categoriesGrid = document.getElementById('categoriesGrid');
      categoriesGrid.innerHTML = categories.map(category => `
        <div class="category-card" onclick="filterByCategory('${category.id}')">
          <div class="category-icon" style="background: ${category.color}20; color: ${category.color};">
            <i class='bx ${category.icon}'></i>
          </div>
          <h3 class="font-bold text-rp-text mb-2">${sanitizeText(category.name)}</h3>
          <p class="text-rp-subtle text-sm">${sanitizeText(category.description)}</p>
        </div>
      `).join('');
    }

    async function loadForums() {
      try {
        const querySnapshot = await db.collection('forums').orderBy('createdAt', 'desc').get();
        const forums = [];
        querySnapshot.forEach((doc) => {
          forums.push({ id: doc.id, ...doc.data() });
        });

        displayForums(forums);
      } catch (error) {
        console.error('Error loading forums:', error);
      }
    }

    function displayForums(forums) {
      const container = document.getElementById('forumsContainer');
      if (forums.length === 0) {
        container.innerHTML = `
          <div class="card p-8 text-center">
            <i class='bx bx-chat text-4xl text-rp-muted mb-4'></i>
            <h3 class="text-subheading text-rp-text mb-2">No forums found</h3>
            <p class="text-rp-subtle">Be the first to create a forum!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = forums.map(forum => `
        <div class="card p-6 card-hover cursor-pointer" onclick="openForum('${forum.id}', '${sanitizeText(forum.name)}', '${sanitizeText(forum.description)}')">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <h3 class="text-subheading text-rp-text font-bold">${sanitizeText(forum.name)}</h3>
                <span class="rank-badge" style="background: var(--theme-${forum.category === 'announcements' ? 'love' : 'overlay'});">
                  ${sanitizeText(forum.category)}
                </span>
              </div>
              <p class="text-rp-subtle mb-4">${sanitizeText(forum.description)}</p>
              <div class="flex items-center gap-4 text-sm text-rp-muted">
                <span><i class='bx bx-message mr-1'></i>${forum.postCount || 0} posts</span>
                <span><i class='bx bx-user mr-1'></i>Created by ${sanitizeText(forum.createdBy)}</span>
                <span><i class='bx bx-time mr-1'></i>${formatDate(forum.createdAt)}</span>
              </div>
            </div>
            <div class="flex flex-col items-end">
              <i class='bx bx-chevron-right text-2xl text-rp-muted'></i>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function createForum(event) {
      event.preventDefault();
      
      if (!currentUser) {
        showLoginPrompt();
        hideCreateForumModal();
        return;
      }
      
      if (userRank !== 'owner' && userRank !== 'admin') {
        alert('Only owners and admins can create forums');
        return;
      }

      const name = document.getElementById('forumName').value;
      const description = document.getElementById('forumDescription').value;
      const category = document.getElementById('forumCategory').value;

      try {
        await db.collection('forums').add({
          name: sanitizeText(name),
          description: sanitizeText(description),
          category: category,
          createdBy: currentUser.displayName || 'Anonymous',
          createdById: currentUser.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          postCount: 0,
          lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });

        hideCreateForumModal();
        document.getElementById('createForumForm').reset();
        loadForums();
      } catch (error) {
        console.error('Error creating forum:', error);
        alert('Error creating forum. Please try again.');
      }
    }

    function openForum(forumId, title, description) {
      currentForumId = forumId;
      document.getElementById('forumTitle').textContent = title;
      document.getElementById('forumDesc').textContent = description;
      document.getElementById('forumViewModal').classList.add('show');
      loadPosts(forumId);
    }

    async function loadPosts(forumId) {
      try {
        const querySnapshot = await db.collection('forums').doc(forumId).collection('posts')
          .orderBy('createdAt', 'desc').get();
        const posts = [];
        querySnapshot.forEach((doc) => {
          posts.push({ id: doc.id, ...doc.data() });
        });

        displayPosts(posts);
      } catch (error) {
        console.error('Error loading posts:', error);
      }
    }

    function displayPosts(posts) {
      const container = document.getElementById('postsContainer');
      if (posts.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class='bx bx-message text-3xl text-rp-muted mb-2'></i>
            <p class="text-rp-subtle">No posts yet. Be the first to start the conversation!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = posts.map(post => `
        <div class="post-card">
          <div class="post-author">
            <img src="${post.authorPhoto || 'https://via.placeholder.com/40'}" alt="Avatar" class="author-avatar">
            <div>
              <div class="flex items-center gap-2">
                <span class="font-medium text-rp-text">${sanitizeText(post.authorName)}</span>
                <span class="rank-badge rank-${post.authorRank || 'member'}">${post.authorRank || 'member'}</span>
              </div>
              <span class="text-sm text-rp-muted">${formatDate(post.createdAt)}</span>
            </div>
          </div>
          <h4 class="font-bold text-rp-text mb-2">${sanitizeText(post.title)}</h4>
          <div class="text-rp-text">${sanitizeContent(post.content)}</div>
        </div>
      `).join('');
    }

    async function createPost(event) {
      event.preventDefault();
      
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      
      if (!currentForumId) return;

      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;

      try {
        await db.collection('forums').doc(currentForumId).collection('posts').add({
          title: sanitizeText(title),
          content: sanitizeContent(content),
          authorName: currentUser.displayName || 'Anonymous',
          authorId: currentUser.uid,
          authorPhoto: currentUser.photoURL || '',
          authorRank: userRank,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          likes: 0,
          replies: 0
        });

        // Update forum post count
        await db.collection('forums').doc(currentForumId).update({
          postCount: firebase.firestore.FieldValue.increment(1),
          lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update user post count
        await db.collection('users').doc(currentUser.uid).update({
          forumPosts: firebase.firestore.FieldValue.increment(1)
        });

        document.getElementById('newPostForm').reset();
        loadPosts(currentForumId);
      } catch (error) {
        console.error('Error creating post:', error);
        alert('Error creating post. Please try again.');
      }
    }

    // SEARCH AND FILTER FUNCTIONS
    function setupSearchAndFilters() {
      const searchInput = document.getElementById('searchInput');
      const categoryFilter = document.getElementById('categoryFilter');
      const sortFilter = document.getElementById('sortFilter');

      let searchTimeout;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
      });

      categoryFilter.addEventListener('change', performSearch);
      sortFilter.addEventListener('change', performSearch);
    }

    async function performSearch() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      const sortBy = document.getElementById('sortFilter').value;

      try {
        let query = db.collection('forums');
        
        if (categoryFilter) {
          query = query.where('category', '==', categoryFilter);
        }

        // Apply sorting
        switch (sortBy) {
          case 'recent':
            query = query.orderBy('lastActivity', 'desc');
            break;
          case 'popular':
            query = query.orderBy('postCount', 'desc');
            break;
          case 'oldest':
            query = query.orderBy('createdAt', 'asc');
            break;
          default:
            query = query.orderBy('createdAt', 'desc');
        }

        const querySnapshot = await query.get();
        let forums = [];
        querySnapshot.forEach((doc) => {
          forums.push({ id: doc.id, ...doc.data() });
        });

        // Apply search filter on client side (Firestore doesn't support full-text search)
        if (searchTerm) {
          forums = forums.filter(forum => 
            forum.name.toLowerCase().includes(searchTerm) ||
            forum.description.toLowerCase().includes(searchTerm)
          );
        }

        displayForums(forums);
      } catch (error) {
        console.error('Error performing search:', error);
      }
    }

    function filterByCategory(category) {
      document.getElementById('categoryFilter').value = category;
      performSearch();
    }

    // MODAL FUNCTIONS
    function showCreateForumModal() {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      document.getElementById('createForumModal').classList.add('show');
    }

    function hideCreateForumModal() {
      document.getElementById('createForumModal').classList.remove('show');
    }

    function hideForumViewModal() {
      document.getElementById('forumViewModal').classList.remove('show');
      currentForumId = null;
    }

    function showLoginPrompt() {
      document.getElementById('loginPrompt').classList.remove('hidden');
    }

    function hideLoginPrompt() {
      document.getElementById('loginPrompt').classList.add('hidden');
    }

    function showAddFriendsModal() {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      document.getElementById('addFriendsModal').classList.add('show');
      loadFriendRequests();
    }

    function hideAddFriendsModal() {
      document.getElementById('addFriendsModal').classList.remove('show');
      document.getElementById('userSearchInput').value = '';
      document.getElementById('userSearchResults').innerHTML = '<div id="searchPlaceholder" class="text-center text-rp-subtle py-8"><i class="bx bx-search text-3xl mb-2 block"></i><p>Search for users to add as friends</p></div>';
    }

    function showChatModal(user) {
      if (!currentUser) {
        showLoginPrompt();
        return;
      }
      
      activeChatUser = user;
      document.getElementById('chatFriendName').textContent = user.displayName || 'Friend';
      document.getElementById('chatFriendNamePlaceholder').textContent = user.displayName || 'Friend';
      document.getElementById('chatFriendAvatar').src = user.photoURL || 'https://via.placeholder.com/40';
      document.getElementById('chatModal').classList.add('show');
      
      loadChatMessages(user.uid);
    }

    function hideChatModal() {
      document.getElementById('chatModal').classList.remove('show');
      if (chatUnsubscribe) {
        chatUnsubscribe();
        chatUnsubscribe = null;
      }
      activeChatUser = null;
      document.getElementById('chatInput').value = '';
      document.getElementById('charCount').textContent = '0';
    }

    // UTILITY FUNCTIONS
    function formatDate(timestamp) {
      if (!timestamp) return 'Just now';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }

    function updateUserSection() {
      const userSection = document.getElementById('userSection');
      const signInBtn = document.getElementById('signInBtn');
      const userRankBadge = document.getElementById('userRank');
      const createBtn = document.getElementById('createForumBtn');
      
      if (currentUser) {
        // Show authenticated user UI
        userSection.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${currentUser.photoURL || 'https://via.placeholder.com/32'}" alt="Profile" class="w-8 h-8 rounded-full">
            <span class="text-rp-text font-medium hidden md:block">${sanitizeText(currentUser.displayName || 'User')}</span>
            <span class="rank-badge rank-${userRank}">${userRank}</span>
            <button onclick="signOut()" class="text-rp-muted hover:text-rp-text">
              <i class='bx bx-log-out text-xl'></i>
            </button>
          </div>
        `;
        
        // Hide sign in button and show user rank
        if (signInBtn) signInBtn.classList.add('hidden');
        if (userRankBadge) {
          userRankBadge.textContent = userRank;
          userRankBadge.className = `rank-badge rank-${userRank}`;
          userRankBadge.classList.remove('hidden');
        }
        
        // Show create forum button for owners and admins
        if (createBtn && (userRank === 'owner' || userRank === 'admin')) {
          createBtn.classList.remove('hidden');
        }
        
        // Show post form in forums
        const guestMessage = document.getElementById('guestPostMessage');
        const postForm = document.getElementById('newPostForm');
        if (guestMessage) guestMessage.classList.add('hidden');
        if (postForm) postForm.classList.remove('hidden');
        
        // Show friends toggle button
        const friendsToggle = document.getElementById('friendsSidebarToggle');
        if (friendsToggle) friendsToggle.classList.remove('hidden');
        
        // Load friends data
        loadFriends();
        
        // Hide login prompt
        hideLoginPrompt();
      } else {
        // Show guest user UI
        userSection.innerHTML = `
          <button onclick="showLoginPrompt()" class="text-rp-muted hover:text-rp-text">
            <i class='bx bx-log-in text-xl'></i>
          </button>
        `;
        
        // Show sign in button and hide user rank
        if (signInBtn) signInBtn.classList.remove('hidden');
        if (userRankBadge) userRankBadge.classList.add('hidden');
        if (createBtn) createBtn.classList.add('hidden');
        
        // Show guest message in forums
        const guestMessage = document.getElementById('guestPostMessage');
        const postForm = document.getElementById('newPostForm');
        if (guestMessage) guestMessage.classList.remove('hidden');
        if (postForm) postForm.classList.add('hidden');
        
        // Hide friends toggle button
        const friendsToggle = document.getElementById('friendsSidebarToggle');
        if (friendsToggle) friendsToggle.classList.add('hidden');
        
        // Close friends sidebar
        const friendsSidebar = document.getElementById('friendsChatSidebar');
        if (friendsSidebar) friendsSidebar.classList.add('hidden');
      }
    }

    // Initialize authentication monitoring after Firebase is ready
    function startAuthMonitoring() {
      if (!auth || !firebaseInitialized) {
        console.log('Auth not ready, retrying in 200ms...');
        setTimeout(startAuthMonitoring, 200);
        return;
      }

      console.log('Starting auth monitoring, current user:', auth.currentUser ? auth.currentUser.email : 'none');

      // Handle redirect result for COOP fallback
      auth.getRedirectResult().then((result) => {
        if (result.user) {
          console.log('Successfully signed in via redirect');
        }
      }).catch((error) => {
        console.error('Redirect sign-in error:', error);
        const loginError = document.getElementById('loginError');
        if (loginError) {
          loginError.innerText = error.message;
          loginError.classList.remove('hidden');
        }
      });

      // AUTH STATE OBSERVER
      auth.onAuthStateChanged(handleAuthStateChange);
      
      // Force initial check if user is already signed in
      setTimeout(() => {
        if (auth.currentUser) {
          console.log('User already signed in on page load:', auth.currentUser.email);
          handleAuthStateChange(auth.currentUser);
        }
      }, 100);
    }

    // Separate auth state handler for better management
    async function handleAuthStateChange(user) {
      console.log('Auth state changed:', user ? `Signed in as ${user.email}` : 'Browsing as guest');
      
      if (user) {
        currentUser = user;
        
        try {
          await ensureUserDoc(user);
          userRank = await getUserRank(user.uid);
          console.log('User rank:', userRank);
          
          updateUserSection();
          
          console.log('Forum UI updated for authenticated user');
        } catch (error) {
          console.error('Error handling authenticated user:', error);
        }
      } else {
        console.log('Browsing as guest');
        currentUser = null;
        userRank = 'guest';
        updateUserSection();
      }
      
      // Always show forum content (both for guests and authenticated users)
      // Load forum data regardless of auth state
      if (!document.querySelector('#categoriesGrid').innerHTML) {
        loadCategories();
        loadForums();
        setupSearchAndFilters();
      }
    }

    // Cross-tab sync is now handled inline in initAuthSync function

    // Start authentication monitoring after Firebase is ready
    function startForumAuthentication() {
      // Wait for Firebase initialization
      if (!firebaseInitialized) {
        setTimeout(startForumAuthentication, 200);
        return;
      }
      
      startAuthMonitoring();
      
      // Initialize inline auth sync
      initAuthSync();
    }

    // Authentication Synchronization (inline to avoid timing issues)
    function initAuthSync() {
      if (!auth) return;
      
      // Listen for auth state changes and store in localStorage
      auth.onAuthStateChanged((user) => {
        const authState = {
          isAuthenticated: !!user,
          user: user ? {
            uid: user.uid,
            email: user.email,
            displayName: user.displayName,
            photoURL: user.photoURL
          } : null,
          timestamp: Date.now()
        };
        
        // Store auth state in localStorage for cross-tab communication
        try {
          localStorage.setItem('carbon_auth_state', JSON.stringify(authState));
        } catch (e) {
          console.warn('Failed to store auth state:', e);
        }
      });
      
      // Listen for auth state changes from other tabs
      window.addEventListener('storage', (e) => {
        if (e.key === 'carbon_auth_state' && e.newValue) {
          try {
            const authState = JSON.parse(e.newValue);
            console.log('Received auth sync from another tab:', authState);
            
            if (authState.isAuthenticated && authState.user && !currentUser) {
              console.log('Syncing login state from another tab');
              // The onAuthStateChanged should handle this automatically
            } else if (!authState.isAuthenticated && currentUser) {
              console.log('Syncing logout state from another tab');
              // Force logout UI if needed
              if (!auth.currentUser) {
                handleAuthStateChange(null);
              }
            }
          } catch (error) {
            console.warn('Failed to parse auth state from storage:', error);
          }
        }
      });
    }

    // Start the authentication process
    setTimeout(startForumAuthentication, 100);

    // FRIENDS AND CHAT FUNCTIONS
    async function loadFriends() {
      if (!currentUser) return;
      
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          const friendsIds = userData.friends || [];
          
          if (friendsIds.length === 0) {
            friendsList = [];
            displayFriends();
            return;
          }
          
          // Load friend details
          const friendsData = await Promise.all(
            friendsIds.map(async (friendId) => {
              const friendDoc = await db.collection('users').doc(friendId).get();
              if (friendDoc.exists) {
                return { uid: friendId, ...friendDoc.data() };
              }
              return null;
            })
          );
          
          friendsList = friendsData.filter(friend => friend !== null);
          displayFriends();
          checkOnlineFriends();
        }
      } catch (error) {
        console.error('Error loading friends:', error);
      }
    }

    function displayFriends() {
      const allFriendsContainer = document.getElementById('allFriendsListForum');
      const noFriendsContainer = document.getElementById('noFriendsForum');
      
      if (friendsList.length === 0) {
        allFriendsContainer.innerHTML = '';
        noFriendsContainer.classList.remove('hidden');
        return;
      }
      
      noFriendsContainer.classList.add('hidden');
      allFriendsContainer.innerHTML = friendsList.map(friend => `
        <div class="flex items-center gap-3 p-2 hover:bg-rp-overlay/50 rounded-lg transition-colors">
          <img src="${friend.photoURL || 'https://via.placeholder.com/32'}" alt="Avatar" class="w-8 h-8 rounded-full object-cover">
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-rp-text truncate">${sanitizeText(friend.displayName || 'User')}</p>
            <p class="text-xs text-rp-subtle">${friend.status === 'online' ? ' Online' : ' Offline'}</p>
          </div>
          <button onclick="showChatModal({uid: '${friend.uid}', displayName: '${sanitizeText(friend.displayName || 'User')}', photoURL: '${friend.photoURL || ''}'});" class="p-1 text-rp-subtle hover:text-rp-foam hover:bg-rp-foam/10 rounded transition-colors">
            <i class='bx bx-message text-sm'></i>
          </button>
        </div>
      `).join('');
    }

    function checkOnlineFriends() {
      onlineFriends = friendsList.filter(friend => friend.status === 'online');
      displayOnlineFriends();
    }

    function displayOnlineFriends() {
      const onlineFriendsContainer = document.getElementById('onlineFriendsListForum');
      const noOnlineContainer = document.getElementById('noOnlineFriendsForum');
      
      if (onlineFriends.length === 0) {
        onlineFriendsContainer.innerHTML = '';
        noOnlineContainer.classList.remove('hidden');
        return;
      }
      
      noOnlineContainer.classList.add('hidden');
      onlineFriendsContainer.innerHTML = onlineFriends.map(friend => `
        <div class="flex items-center gap-3 p-2 hover:bg-rp-overlay/50 rounded-lg transition-colors cursor-pointer" onclick="showChatModal({uid: '${friend.uid}', displayName: '${sanitizeText(friend.displayName || 'User')}', photoURL: '${friend.photoURL || ''}'});">
          <img src="${friend.photoURL || 'https://via.placeholder.com/32'}" alt="Avatar" class="w-8 h-8 rounded-full object-cover">
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-rp-text truncate">${sanitizeText(friend.displayName || 'User')}</p>
            <p class="text-xs text-rp-pine"> Online</p>
          </div>
          <i class='bx bx-message text-rp-subtle'></i>
        </div>
      `).join('');
    }

    async function searchUsers(query) {
      if (!query.trim() || query.length < 2) {
        document.getElementById('userSearchResults').innerHTML = '<div id="searchPlaceholder" class="text-center text-rp-subtle py-8"><i class="bx bx-search text-3xl mb-2 block"></i><p>Search for users to add as friends</p></div>';
        return;
      }
      
      try {
        // Search by username or display name
        const usersSnapshot = await db.collection('users')
          .where('username', '>=', query.toLowerCase())
          .where('username', '<=', query.toLowerCase() + '\uf8ff')
          .limit(10)
          .get();
        
        const results = [];
        usersSnapshot.forEach(doc => {
          if (doc.id !== currentUser.uid) {
            results.push({ uid: doc.id, ...doc.data() });
          }
        });
        
        displaySearchResults(results);
      } catch (error) {
        console.error('Error searching users:', error);
      }
    }

    function displaySearchResults(results) {
      const container = document.getElementById('userSearchResults');
      
      if (results.length === 0) {
        container.innerHTML = '<div class="text-center text-rp-subtle py-8"><p>No users found</p></div>';
        return;
      }
      
      container.innerHTML = results.map(user => `
        <div class="flex items-center gap-3 p-3 border border-rp-overlay rounded-lg">
          <img src="${user.photoURL || 'https://via.placeholder.com/40'}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
          <div class="flex-1 min-w-0">
            <p class="font-medium text-rp-text truncate">${sanitizeText(user.displayName || 'User')}</p>
            <p class="text-sm text-rp-subtle">@${sanitizeText(user.username || 'username')}</p>
          </div>
          <button onclick="sendFriendRequest('${user.uid}');" class="px-3 py-1 bg-rp-foam/20 text-rp-foam rounded-lg hover:bg-rp-foam/30 transition-colors text-sm">
            <i class='bx bx-user-plus mr-1'></i>
            Add
          </button>
        </div>
      `).join('');
    }

    async function sendFriendRequest(targetUid) {
      if (!currentUser || targetUid === currentUser.uid) return;
      
      // Input validation
      if (!targetUid || typeof targetUid !== 'string') {
        console.error('Invalid target UID');
        return;
      }
      
      try {
        // Check if target user exists and get their data
        const targetUserDoc = await db.collection('users').doc(targetUid).get();
        if (!targetUserDoc.exists) {
          alert('User not found');
          return;
        }
        
        // Check if already friends or request exists
        const currentUserDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = currentUserDoc.data();
        const friends = userData?.friends || [];
        const blockedUsers = userData?.blockedUsers || [];
        
        // Check if user is blocked
        if (blockedUsers.includes(targetUid)) {
          alert('Cannot send friend request to blocked user');
          return;
        }
        
        // Check if target user has blocked current user
        const targetUserData = targetUserDoc.data();
        const targetBlockedUsers = targetUserData?.blockedUsers || [];
        if (targetBlockedUsers.includes(currentUser.uid)) {
          alert('Unable to send friend request');
          return;
        }
        
        if (friends.includes(targetUid)) {
          alert('Already friends with this user');
          return;
        }
        
        // Check existing requests
        const existingRequest = await db.collection('friendRequests')
          .where('from', '==', currentUser.uid)
          .where('to', '==', targetUid)
          .get();
        
        if (!existingRequest.empty) {
          alert('Friend request already sent');
          return;
        }
        
        // Send friend request with sanitized data
        await db.collection('friendRequests').add({
          from: currentUser.uid,
          to: targetUid,
          fromName: sanitizeText(currentUser.displayName || 'User'),
          fromPhoto: currentUser.photoURL || '',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'pending'
        });
        
        alert('Friend request sent!');
      } catch (error) {
        console.error('Error sending friend request:', error);
        alert('Error sending friend request');
      }
    }

    async function loadFriendRequests() {
      if (!currentUser) return;
      
      try {
        const requestsSnapshot = await db.collection('friendRequests')
          .where('to', '==', currentUser.uid)
          .where('status', '==', 'pending')
          .get();
        
        const requests = [];
        requestsSnapshot.forEach(doc => {
          requests.push({ id: doc.id, ...doc.data() });
        });
        
        displayFriendRequests(requests);
      } catch (error) {
        console.error('Error loading friend requests:', error);
      }
    }

    function displayFriendRequests(requests) {
      const container = document.getElementById('friendRequestsList');
      const noRequestsContainer = document.getElementById('noRequests');
      
      if (requests.length === 0) {
        container.innerHTML = '';
        noRequestsContainer.classList.remove('hidden');
        return;
      }
      
      noRequestsContainer.classList.add('hidden');
      container.innerHTML = requests.map(request => `
        <div class="flex items-center gap-3 p-3 border border-rp-overlay rounded-lg">
          <img src="${request.fromPhoto || 'https://via.placeholder.com/40'}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
          <div class="flex-1 min-w-0">
            <p class="font-medium text-rp-text truncate">${sanitizeText(request.fromName)}</p>
            <p class="text-sm text-rp-subtle">Wants to be friends</p>
          </div>
          <div class="flex gap-2">
            <button onclick="acceptFriendRequest('${request.id}', '${request.from}');" class="px-3 py-1 bg-rp-foam/20 text-rp-foam rounded-lg hover:bg-rp-foam/30 transition-colors text-sm">
              Accept
            </button>
            <button onclick="rejectFriendRequest('${request.id}');" class="px-3 py-1 bg-rp-love/20 text-rp-love rounded-lg hover:bg-rp-love/30 transition-colors text-sm">
              Decline
            </button>
          </div>
        </div>
      `).join('');
    }

    async function acceptFriendRequest(requestId, fromUid) {
      try {
        const batch = db.batch();
        
        // Add to both users' friends lists
        const currentUserRef = db.collection('users').doc(currentUser.uid);
        const friendUserRef = db.collection('users').doc(fromUid);
        
        batch.update(currentUserRef, {
          friends: firebase.firestore.FieldValue.arrayUnion(fromUid)
        });
        
        batch.update(friendUserRef, {
          friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
        
        // Delete the request
        const requestRef = db.collection('friendRequests').doc(requestId);
        batch.delete(requestRef);
        
        await batch.commit();
        
        loadFriendRequests();
        loadFriends();
      } catch (error) {
        console.error('Error accepting friend request:', error);
        alert('Error accepting friend request');
      }
    }

    async function rejectFriendRequest(requestId) {
      try {
        await db.collection('friendRequests').doc(requestId).delete();
        loadFriendRequests();
      } catch (error) {
        console.error('Error rejecting friend request:', error);
        alert('Error rejecting friend request');
      }
    }

    // CHAT FUNCTIONS
    async function loadChatMessages(friendUid) {
      if (!currentUser || !friendUid) return;
      
      const chatRoomId = [currentUser.uid, friendUid].sort().join('_');
      
      // Unsubscribe from previous chat
      if (chatUnsubscribe) {
        chatUnsubscribe();
      }
      
      // Subscribe to real-time messages
      chatUnsubscribe = db.collection('chats').doc(chatRoomId).collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot((snapshot) => {
          const messages = [];
          snapshot.forEach(doc => {
            messages.push({ id: doc.id, ...doc.data() });
          });
          displayChatMessages(messages);
        });
    }

    function displayChatMessages(messages) {
      const container = document.getElementById('chatMessages');
      const placeholder = document.getElementById('chatPlaceholder');
      
      if (messages.length === 0) {
        placeholder.classList.remove('hidden');
        container.innerHTML = placeholder.outerHTML;
        return;
      }
      
      container.innerHTML = messages.map(message => {
        const isOwn = message.sender === currentUser.uid;
        return `
          <div class="flex ${isOwn ? 'justify-end' : 'justify-start'}">
            <div class="max-w-xs px-4 py-2 rounded-lg ${isOwn ? 'bg-rp-foam text-rp-base' : 'bg-rp-overlay text-rp-text'}">
              <p class="text-sm">${sanitizeContent(message.text)}</p>
              <p class="text-xs opacity-70 mt-1">${formatTime(message.timestamp)}</p>
            </div>
          </div>
        `;
      }).join('');
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      
      if (!text || !activeChatUser || !currentUser) return;
      
      // Input validation
      if (typeof text !== 'string' || text.length === 0) return;
      
      // Check if users are friends before allowing chat
      const currentUserDoc = await db.collection('users').doc(currentUser.uid).get();
      const userData = currentUserDoc.data();
      const friends = userData?.friends || [];
      const blockedUsers = userData?.blockedUsers || [];
      
      if (!friends.includes(activeChatUser.uid)) {
        alert('You can only chat with friends');
        hideChatModal();
        return;
      }
      
      if (blockedUsers.includes(activeChatUser.uid)) {
        alert('Cannot send message to blocked user');
        hideChatModal();
        return;
      }
      
      // Sanitize message text
      const safeText = sanitizeText(text);
      
      if (safeText.length > 500) {
        alert('Message too long (max 500 characters)');
        return;
      }
      
      if (safeText.length === 0) {
        alert('Message cannot be empty after filtering');
        return;
      }
      
      const chatRoomId = [currentUser.uid, activeChatUser.uid].sort().join('_');
      
      try {
        await db.collection('chats').doc(chatRoomId).collection('messages').add({
          text: safeText,
          sender: currentUser.uid,
          senderName: sanitizeText(currentUser.displayName || 'User'),
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        input.value = '';
        document.getElementById('charCount').textContent = '0';
      } catch (error) {
        console.error('Error sending message:', error);
        alert('Error sending message');
      }
    }

    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Close modals when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        hideCreateForumModal();
        hideForumViewModal();
        hideChatModal();
        hideAddFriendsModal();
      }
      
      // Hide login prompt when clicking outside
      if (!e.target.closest('#loginPrompt') && !e.target.closest('#signInBtn') && 
          !e.target.closest('button[onclick*="showLoginPrompt"]')) {
        hideLoginPrompt();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideCreateForumModal();
        hideForumViewModal();
        hideLoginPrompt();
        hideChatModal();
        hideAddFriendsModal();
      }
      
      // Send message on Enter
      if (e.key === 'Enter' && e.target.id === 'chatInput') {
        e.preventDefault();
        sendMessage();
      }
    });

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Show forum content immediately
      console.log('Page loaded, initializing forum for guest browsing');
      loadCategories();
      loadForums();
      setupSearchAndFilters();
      updateUserSection(); // Initialize guest UI
      
      // Setup friends sidebar toggle
      const friendsToggle = document.getElementById('friendsSidebarToggle');
      const friendsSidebar = document.getElementById('friendsChatSidebar');
      const closeSidebar = document.getElementById('closeFriendsSidebarBtn');
      const addFriendsBtn = document.getElementById('addFriendsBtn');
      
      friendsToggle.addEventListener('click', () => {
        friendsSidebar.classList.remove('hidden');
      });
      
      closeSidebar.addEventListener('click', () => {
        friendsSidebar.classList.add('hidden');
      });
      
      addFriendsBtn.addEventListener('click', showAddFriendsModal);
      
      // Setup chat input
      const chatInput = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendMessageBtn');
      const charCount = document.getElementById('charCount');
      
      chatInput.addEventListener('input', (e) => {
        charCount.textContent = e.target.value.length;
      });
      
      sendBtn.addEventListener('click', sendMessage);
      
      // Setup user search
      const userSearchInput = document.getElementById('userSearchInput');
      let searchTimeout;
      
      userSearchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchUsers(e.target.value);
        }, 300);
      });
    });
  </script>
</body>
</html>