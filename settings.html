<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings - Carbon</title>
    <script defer async>
        function setConfig() {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            display: ["Switzer", "Helvetica", "sans-serif"],
                            inter: ["Inter", "sans-serif"],
                        },
                        colors: {
                            base: "#191724",
                            surface: "#1f1d2e",
                            overlay: "#26233a",
                            muted: "#6e6a86",
                            subtle: "#908caa",
                            text: "#e0def4",
                            love: "#eb6f92",
                            gold: "#f6c177",
                            rose: "#ebbcba",
                            pine: "#31748f",
                            foam: "#9ccfd8",
                            iris: "#c4a7e7",
                            "highlight-low": "#21202e",
                            "highlight-med": "#403d52",
                            "highlight-high": "#524f67",
                        },
                    },
                },
            };
        }
    </script>
    <script defer async src="https://cdn.tailwindcss.com" onload="setConfig()"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <style>
        :root {
            /* Theme variables - Rose Pine (default) */
            --theme-base: #191724;
            --theme-surface: #1f1d2e;
            --theme-overlay: #26233a;
            --theme-muted: #6e6a86;
            --theme-subtle: #908caa;
            --theme-text: #e0def4;
            --theme-love: #eb6f92;
            --theme-gold: #f6c177;
            --theme-rose: #ebbcba;
            --theme-pine: #31748f;
            --theme-foam: #9ccfd8;
            --theme-iris: #c4a7e7;
            --theme-highlight-low: #21202e;
            --theme-highlight-med: #403d52;
            --theme-highlight-high: #524f67;
            --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
        }
        
        /* Theme color schemes */
        [data-theme="dark"] {
            --theme-base: #0f172a;
            --theme-surface: #1e293b;
            --theme-overlay: #334155;
            --theme-muted: #64748b;
            --theme-subtle: #94a3b8;
            --theme-text: #f1f5f9;
            --theme-love: #ef4444;
            --theme-gold: #f59e0b;
            --theme-rose: #f97316;
            --theme-pine: #059669;
            --theme-foam: #06b6d4;
            --theme-iris: #8b5cf6;
            --theme-highlight-low: #1e293b;
            --theme-highlight-med: #475569;
            --theme-highlight-high: #64748b;
            --theme-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        }
        
        [data-theme="light"] {
            --theme-base: #f8fafc;
            --theme-surface: #e2e8f0;
            --theme-overlay: #cbd5e1;
            --theme-muted: #64748b;
            --theme-subtle: #475569;
            --theme-text: #0f172a;
            --theme-love: #dc2626;
            --theme-gold: #d97706;
            --theme-rose: #ea580c;
            --theme-pine: #047857;
            --theme-foam: #0891b2;
            --theme-iris: #7c3aed;
            --theme-highlight-low: #f1f5f9;
            --theme-highlight-med: #e2e8f0;
            --theme-highlight-high: #cbd5e1;
            --theme-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
        }
        
        [data-theme="catppuccin"] {
            --theme-base: #1e1e2e;
            --theme-surface: #313244;
            --theme-overlay: #45475a;
            --theme-muted: #6c7086;
            --theme-subtle: #9399b2;
            --theme-text: #cdd6f4;
            --theme-love: #f38ba8;
            --theme-gold: #f9e2af;
            --theme-rose: #fab387;
            --theme-pine: #a6e3a1;
            --theme-foam: #89dceb;
            --theme-iris: #cba6f7;
            --theme-highlight-low: #181825;
            --theme-highlight-med: #313244;
            --theme-highlight-high: #45475a;
            --theme-gradient: linear-gradient(135deg, #1e1e2e 0%, #313244 50%, #45475a 100%);
        }
        
        [data-theme="nord"] {
            --theme-base: #2e3440;
            --theme-surface: #3b4252;
            --theme-overlay: #434c5e;
            --theme-muted: #4c566a;
            --theme-subtle: #d8dee9;
            --theme-text: #eceff4;
            --theme-love: #bf616a;
            --theme-gold: #ebcb8b;
            --theme-rose: #d08770;
            --theme-pine: #a3be8c;
            --theme-foam: #88c0d0;
            --theme-iris: #b48ead;
            --theme-highlight-low: #2e3440;
            --theme-highlight-med: #434c5e;
            --theme-highlight-high: #4c566a;
            --theme-gradient: linear-gradient(135deg, #2e3440 0%, #3b4252 50%, #434c5e 100%);
        }
        
        [data-theme="gruvbox"] {
            --theme-base: #282828;
            --theme-surface: #3c3836;
            --theme-overlay: #504945;
            --theme-muted: #665c54;
            --theme-subtle: #a89984;
            --theme-text: #ebdbb2;
            --theme-love: #fb4934;
            --theme-gold: #fabd2f;
            --theme-rose: #fe8019;
            --theme-pine: #b8bb26;
            --theme-foam: #8ec07c;
            --theme-iris: #d3869b;
            --theme-highlight-low: #1d2021;
            --theme-highlight-med: #3c3836;
            --theme-highlight-high: #504945;
            --theme-gradient: linear-gradient(135deg, #282828 0%, #3c3836 50%, #504945 100%);
        }
        
        [data-theme="tokyo-night"] {
            --theme-base: #1a1b26;
            --theme-surface: #24283b;
            --theme-overlay: #414868;
            --theme-muted: #565f89;
            --theme-subtle: #a9b1d6;
            --theme-text: #c0caf5;
            --theme-love: #f7768e;
            --theme-gold: #e0af68;
            --theme-rose: #ff9e64;
            --theme-pine: #9ece6a;
            --theme-foam: #7dcfff;
            --theme-iris: #bb9af7;
            --theme-highlight-low: #16161e;
            --theme-highlight-med: #24283b;
            --theme-highlight-high: #414868;
            --theme-gradient: linear-gradient(135deg, #1a1b26 0%, #24283b 50%, #414868 100%);
        }
        
        [data-theme="dracula"] {
            --theme-base: #282a36;
            --theme-surface: #44475a;
            --theme-overlay: #6272a4;
            --theme-muted: #6272a4;
            --theme-subtle: #f8f8f2;
            --theme-text: #f8f8f2;
            --theme-love: #ff5555;
            --theme-gold: #f1fa8c;
            --theme-rose: #ffb86c;
            --theme-pine: #50fa7b;
            --theme-foam: #8be9fd;
            --theme-iris: #bd93f9;
            --theme-highlight-low: #21222c;
            --theme-highlight-med: #44475a;
            --theme-highlight-high: #6272a4;
            --theme-gradient: linear-gradient(135deg, #282a36 0%, #44475a 50%, #6272a4 100%);
        }
        
        /* Modern Clean Styling */
        body {
            background: var(--theme-gradient);
            background-attachment: fixed;
            color: var(--theme-text);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--theme-foam), var(--theme-iris));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: var(--theme-muted);
            font-size: 1.1rem;
        }
        
        .card {
            background: var(--theme-surface);
            border: 1px solid var(--theme-overlay);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: var(--theme-foam);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--theme-text);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-description {
            color: var(--theme-muted);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .theme-option {
            width: 100%;
            height: 80px;
            border-radius: 0.75rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .theme-option:hover {
            transform: scale(1.05);
            border-color: var(--theme-foam);
        }
        
        .theme-option.active {
            border-color: var(--theme-foam);
            box-shadow: 0 0 0 3px rgba(156, 207, 216, 0.3);
        }
        
        .bg-option {
            width: 100%;
            height: 100px;
            border-radius: 0.75rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .bg-option:hover {
            transform: scale(1.02);
            border-color: var(--theme-foam);
        }
        
        .bg-option.active {
            border-color: var(--theme-foam);
            box-shadow: 0 0 0 3px rgba(156, 207, 216, 0.3);
        }
        
        .panic-display {
            min-height: 3rem;
            background: var(--theme-overlay);
            border: 2px solid var(--theme-highlight-med);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--theme-foam);
            transition: all 0.3s ease;
        }
        
        .panic-display.recording {
            border-color: var(--theme-love);
            background: var(--theme-love);
            color: white;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .input {
            width: 100%;
            padding: 0.75rem;
            background: var(--theme-overlay);
            border: 1px solid var(--theme-highlight-med);
            border-radius: 0.5rem;
            color: var(--theme-text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--theme-foam);
            box-shadow: 0 0 0 3px rgba(156, 207, 216, 0.1);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--theme-foam), var(--theme-pine));
            color: var(--theme-base);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(156, 207, 216, 0.4);
        }
        
        .btn-secondary {
            background: var(--theme-highlight-med);
            color: var(--theme-text);
            border: 1px solid var(--theme-overlay);
        }
        
        .btn-secondary:hover {
            background: var(--theme-highlight-high);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--theme-love), #d63384);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(235, 111, 146, 0.4);
        }
        
        .upload-area {
            border: 2px dashed var(--theme-highlight-med);
            border-radius: 0.75rem;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--theme-surface);
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--theme-foam);
            background: var(--theme-highlight-med);
        }
        
        .checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--theme-highlight-med);
            border-radius: 0.25rem;
            background: var(--theme-surface);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkbox:checked {
            background: var(--theme-foam);
            border-color: var(--theme-foam);
        }
        
        .checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--theme-base);
            font-weight: bold;
            font-size: 0.875rem;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        .flex-col {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-sm { font-size: 0.875rem; }
        
        /* User info styling */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--theme-overlay);
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }
        
        .user-photo {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            border: 2px solid var(--theme-foam);
        }
        
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }
        
        .login-card {
            background: var(--theme-surface);
            border: 1px solid var(--theme-overlay);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        
        .login-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--theme-foam);
            margin-bottom: 1rem;
        }
        
        .login-description {
            color: var(--theme-muted);
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-card">
            <i class="bx bx-cog text-6xl mb-4" style="color: var(--theme-foam);"></i>
            <h1 class="login-title">Carbon Settings</h1>
            <p class="login-description">Sign in to access your personalized settings</p>
            <button id="google-signin-btn" class="btn btn-primary w-full">
                <i class="bx bxl-google text-xl"></i>
                Continue with Google
            </button>
            <div id="login-error" class="text-love mt-4 text-sm hidden"></div>
        </div>
    </div>

    <!-- Settings Content -->
    <div id="settings-content" class="container hidden">
        <div class="header">
            <h1>Carbon Settings</h1>
            <p>Personalize your Carbon experience</p>
        </div>

        <!-- User Info -->
        <div id="user-info" class="user-info">
            <img id="user-photo" class="user-photo" src="" alt="Profile">
            <div class="flex-col">
                <div style="color: var(--theme-text); font-weight: 600;" id="user-name"></div>
                <button id="sign-out-btn" class="text-sm" style="color: var(--theme-muted); background: none; border: none; cursor: pointer;">Sign Out</button>
            </div>
        </div>

        <!-- Theme Settings -->
        <div class="card">
            <div class="card-title">
                <i class="bx bx-palette"></i>
                Theme
            </div>
            <div class="card-description">
                Choose your preferred color scheme
            </div>
            <div class="theme-grid">
                <div class="theme-option" data-theme="rose-pine" style="background: linear-gradient(135deg, #191724, #26233a);">
                    Rose Pine
                </div>
                <div class="theme-option" data-theme="dark" style="background: linear-gradient(135deg, #0f172a, #334155);">
                    Dark
                </div>
                <div class="theme-option" data-theme="light" style="background: linear-gradient(135deg, #f8fafc, #cbd5e1); color: #0f172a;">
                    Light
                </div>
                <div class="theme-option" data-theme="catppuccin" style="background: linear-gradient(135deg, #1e1e2e, #45475a);">
                    Catppuccin
                </div>
                <div class="theme-option" data-theme="nord" style="background: linear-gradient(135deg, #2e3440, #434c5e);">
                    Nord
                </div>
                <div class="theme-option" data-theme="gruvbox" style="background: linear-gradient(135deg, #282828, #504945);">
                    Gruvbox
                </div>
                <div class="theme-option" data-theme="tokyo-night" style="background: linear-gradient(135deg, #1a1b26, #414868);">
                    Tokyo Night
                </div>
                <div class="theme-option" data-theme="dracula" style="background: linear-gradient(135deg, #282a36, #6272a4);">
                    Dracula
                </div>
            </div>
        </div>

        <!-- Background Settings -->
        <div class="card">
            <div class="card-title">
                <i class="bx bx-image"></i>
                Background
            </div>
            <div class="card-description">
                Set a custom background for your Carbon experience
            </div>
            <div class="theme-grid">
                <div class="bg-option active" data-bg="default">
                    Theme Default
                </div>
                <div class="bg-option" data-bg="https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?w=800" style="background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?w=800')">
                    Geometric
                </div>
                <div class="bg-option" data-bg="https://images.unsplash.com/photo-1518837695005-2083093ee35b?w=800" style="background-image: url('https://images.unsplash.com/photo-1518837695005-2083093ee35b?w=800')">
                    Ocean
                </div>
                <div class="bg-option" data-bg="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800" style="background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800')">
                    Mountains
                </div>
            </div>
            <div class="mt-4">
                <div class="upload-area" id="custom-bg-upload">
                    <i class="bx bx-cloud-upload text-3xl mb-2" style="color: var(--theme-foam);"></i>
                    <div style="color: var(--theme-text); font-weight: 600; margin-bottom: 0.5rem;">Upload Custom Background</div>
                    <div class="text-sm" style="color: var(--theme-muted);">Drop an image here or click to browse</div>
                    <input type="file" id="bg-file-input" accept="image/*" style="display: none;">
                </div>
            </div>
        </div>

        <!-- Panic Key Settings -->
        <div class="card">
            <div class="card-title">
                <i class="bx bx-shield-alt-2"></i>
                Panic Key
            </div>
            <div class="card-description">
                Set a quick key combination to close Carbon and redirect to a safe page
            </div>
            <div class="flex-between">
                <div class="flex-col" style="flex: 1;">
                    <label class="text-sm" style="color: var(--theme-text);">Current Panic Key</label>
                    <div id="panic-key-display" class="panic-display">
                        Not Set
                    </div>
                </div>
                <div class="flex-col">
                    <button id="set-panic-key-btn" class="btn btn-primary">Set Key</button>
                    <button id="clear-panic-key-btn" class="btn btn-secondary">Clear</button>
                </div>
            </div>
            <div class="mt-4">
                <label class="flex-col">
                    <span class="text-sm" style="color: var(--theme-text);">Redirect URL</span>
                    <input type="url" id="panic-url" class="input" placeholder="https://classroom.google.com" value="https://classroom.google.com">
                </label>
            </div>
        </div>

        <!-- Privacy & Security -->
        <div class="card">
            <div class="card-title">
                <i class="bx bx-shield"></i>
                Privacy & Security
            </div>
            <div class="card-description">
                Configure privacy and security settings
            </div>
            <div class="flex-col">
                <label class="flex-between">
                    <span style="color: var(--theme-text);">Clear browsing data on exit</span>
                    <input type="checkbox" class="checkbox" id="clear-on-exit">
                </label>
                <label class="flex-between">
                    <span style="color: var(--theme-text);">Enable incognito mode</span>
                    <input type="checkbox" class="checkbox" id="incognito-mode">
                </label>
                <label class="flex-between">
                    <span style="color: var(--theme-text);">Block analytics tracking</span>
                    <input type="checkbox" class="checkbox" id="block-tracking" checked>
                </label>
            </div>
        </div>

        <!-- Export/Import Settings -->
        <div class="grid-2">
            <div class="card">
                <div class="card-title">
                    <i class="bx bx-export"></i>
                    Export Settings
                </div>
                <div class="card-description">
                    Export your settings to a file
                </div>
                <button id="export-settings-btn" class="btn btn-primary">
                    <i class="bx bx-download"></i>
                    Export
                </button>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <i class="bx bx-import"></i>
                    Import Settings
                </div>
                <div class="card-description">
                    Import settings from a file
                </div>
                <button id="import-settings-btn" class="btn btn-secondary">
                    <i class="bx bx-upload"></i>
                    Import
                </button>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
            </div>
        </div>

        <!-- Reset Settings -->
        <div class="card">
            <div class="card-title">
                <i class="bx bx-refresh"></i>
                Reset Settings
            </div>
            <div class="card-description">
                Reset all settings to their default values. This action cannot be undone.
            </div>
            <button id="reset-settings-btn" class="btn btn-danger">
                <i class="bx bx-reset"></i>
                Reset All Settings
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="carbon-theme.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
         <script>
         // Firebase configuration
         const firebaseConfig = {
             apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
             authDomain: "carbon-services.firebaseapp.com",
             projectId: "carbon-services",
             storageBucket: "carbon-services.firebasestorage.app",
             messagingSenderId: "288385472070",
             appId: "1:288385472070:web:c4be3ff186e248fc645c47",
             measurementId: "G-Y2K1RQYE74"
         };
         
         // Initialize Firebase
         firebase.initializeApp(firebaseConfig);
         const auth = firebase.auth();
         const db = firebase.firestore();
         
         let currentUser = null;
         let panicKey = null;
         let currentTheme = 'rose-pine';
         let currentBackground = 'default';
         
         // Authentication state observer
         auth.onAuthStateChanged((user) => {
             currentUser = user;
             
             if (user) {
                 // User is signed in - show settings
                 document.getElementById('login-screen').classList.add('hidden');
                 document.getElementById('settings-content').classList.remove('hidden');
                 
                 // Update user info
                 document.getElementById('user-photo').src = user.photoURL || '';
                 document.getElementById('user-name').textContent = user.displayName || 'User';
                 
                 loadSettings();
             } else {
                 // User is not signed in - show login
                 document.getElementById('login-screen').classList.remove('hidden');
                 document.getElementById('settings-content').classList.add('hidden');
             }
         });
         
         // Google Sign In
         async function googleSignIn() {
             try {
                 const provider = new firebase.auth.GoogleAuthProvider();
                 await auth.signInWithPopup(provider);
             } catch (error) {
                 console.error('Sign in error:', error);
                 document.getElementById('login-error').innerText = error.message;
                 document.getElementById('login-error').classList.remove('hidden');
             }
         }
         
         // Sign Out
         async function signOut() {
             try {
                 await auth.signOut();
             } catch (error) {
                 console.error('Sign out error:', error);
             }
         }
         
         // Load settings
         function loadSettings() {
             // Load theme
             const savedTheme = localStorage.getItem('carbon-theme-global') || 'rose-pine';
             currentTheme = savedTheme;
             applyTheme(currentTheme);
             
             // Set active theme option
             document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
             document.querySelector(`[data-theme="${savedTheme}"]`)?.classList.add('active');
             
             // Load background
             const savedBg = localStorage.getItem('carbon-background-global') || 'default';
             currentBackground = savedBg;
             
             // Set active background option
             document.querySelectorAll('.bg-option').forEach(el => el.classList.remove('active'));
             document.querySelector(`[data-bg="${savedBg}"]`)?.classList.add('active');
             
             // Load panic key
             const savedPanicKey = localStorage.getItem('carbon-panic-key');
             if (savedPanicKey) {
                 panicKey = savedPanicKey;
                 document.getElementById('panic-key-display').textContent = panicKey.toUpperCase();
                 document.getElementById('panic-key-display').classList.remove('recording');
             }
             
             // Load panic URL
             const savedPanicUrl = localStorage.getItem('carbon-panic-url') || 'https://classroom.google.com';
             document.getElementById('panic-url').value = savedPanicUrl;
             
             // Load privacy settings
             document.getElementById('clear-on-exit').checked = localStorage.getItem('carbon-clear-on-exit') === 'true';
             document.getElementById('incognito-mode').checked = localStorage.getItem('carbon-incognito-mode') === 'true';
             document.getElementById('block-tracking').checked = localStorage.getItem('carbon-block-tracking') !== 'false';
         }
         
         // Save settings
         function saveSettings() {
             localStorage.setItem('carbon-theme-global', currentTheme);
             localStorage.setItem('carbon-background-global', currentBackground);
             localStorage.setItem('carbon-panic-key', panicKey || '');
             localStorage.setItem('carbon-panic-url', document.getElementById('panic-url').value);
             localStorage.setItem('carbon-clear-on-exit', document.getElementById('clear-on-exit').checked);
             localStorage.setItem('carbon-incognito-mode', document.getElementById('incognito-mode').checked);
             localStorage.setItem('carbon-block-tracking', document.getElementById('block-tracking').checked);
             
             // Notify parent window
             if (window.parent && window.parent !== window) {
                 window.parent.postMessage({
                     type: 'carbon-settings-updated',
                     settings: {
                         theme: currentTheme,
                         background: currentBackground,
                         panicKey: panicKey,
                         panicUrl: document.getElementById('panic-url').value
                     }
                 }, '*');
             }
         }
         
         // Apply theme
         function applyTheme(theme) {
             document.documentElement.setAttribute('data-theme', theme);
             if (window.carbonTheme) {
                 window.carbonTheme.setTheme(theme);
             }
         }
         
         // Event listeners
         document.getElementById('google-signin-btn').addEventListener('click', googleSignIn);
         document.getElementById('sign-out-btn').addEventListener('click', signOut);
         
         // Theme selection
         document.querySelectorAll('.theme-option').forEach(option => {
             option.addEventListener('click', function() {
                 document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
                 this.classList.add('active');
                 currentTheme = this.dataset.theme;
                 applyTheme(currentTheme);
                 saveSettings();
             });
         });
         
         // Background selection
         document.querySelectorAll('.bg-option').forEach(option => {
             option.addEventListener('click', function() {
                 document.querySelectorAll('.bg-option').forEach(el => el.classList.remove('active'));
                 this.classList.add('active');
                 currentBackground = this.dataset.bg;
                 saveSettings();
             });
         });
         
         // Panic key functionality
         document.getElementById('set-panic-key-btn').addEventListener('click', function() {
             const display = document.getElementById('panic-key-display');
             display.textContent = 'Press any key...';
             display.classList.add('recording');
             
             function recordKey(e) {
                 e.preventDefault();
                 panicKey = e.key.toLowerCase();
                 display.textContent = panicKey.toUpperCase();
                 display.classList.remove('recording');
                 document.removeEventListener('keydown', recordKey);
                 saveSettings();
             }
             
             document.addEventListener('keydown', recordKey);
         });
         
         document.getElementById('clear-panic-key-btn').addEventListener('click', function() {
             panicKey = null;
             document.getElementById('panic-key-display').textContent = 'Not Set';
             saveSettings();
         });
         
         // Custom background upload
         document.getElementById('custom-bg-upload').addEventListener('click', () => {
             document.getElementById('bg-file-input').click();
         });
         
         document.getElementById('bg-file-input').addEventListener('change', function(e) {
             const file = e.target.files[0];
             if (file) {
                 const reader = new FileReader();
                 reader.onload = function(e) {
                     const dataUrl = e.target.result;
                     localStorage.setItem('carbon-custom-bg-global', dataUrl);
                     document.body.style.background = `url(${dataUrl}) center/cover fixed`;
                     saveSettings();
                 };
                 reader.readAsDataURL(file);
             }
         });
         
         // Privacy settings
         document.getElementById('clear-on-exit').addEventListener('change', saveSettings);
         document.getElementById('incognito-mode').addEventListener('change', saveSettings);
         document.getElementById('block-tracking').addEventListener('change', saveSettings);
         
         // Export settings
         document.getElementById('export-settings-btn').addEventListener('click', function() {
             const settings = {
                 theme: currentTheme,
                 background: currentBackground,
                 panicKey: panicKey,
                 panicUrl: document.getElementById('panic-url').value,
                 clearOnExit: document.getElementById('clear-on-exit').checked,
                 incognitoMode: document.getElementById('incognito-mode').checked,
                 blockTracking: document.getElementById('block-tracking').checked,
                 customBackground: localStorage.getItem('carbon-custom-bg-global'),
                 exportDate: new Date().toISOString()
             };
             
             const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = 'carbon-settings.json';
             a.click();
             URL.revokeObjectURL(url);
         });
         
         // Import settings
         document.getElementById('import-settings-btn').addEventListener('click', () => {
             document.getElementById('import-file-input').click();
         });
         
         document.getElementById('import-file-input').addEventListener('change', function(e) {
             const file = e.target.files[0];
             if (file) {
                 const reader = new FileReader();
                 reader.onload = function(e) {
                     try {
                         const settings = JSON.parse(e.target.result);
                         
                         // Apply imported settings
                         if (settings.theme) {
                             currentTheme = settings.theme;
                             applyTheme(currentTheme);
                             document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
                             document.querySelector(`[data-theme="${settings.theme}"]`)?.classList.add('active');
                         }
                         
                         if (settings.background) {
                             currentBackground = settings.background;
                             document.querySelectorAll('.bg-option').forEach(el => el.classList.remove('active'));
                             document.querySelector(`[data-bg="${settings.background}"]`)?.classList.add('active');
                         }
                         
                         if (settings.panicKey) {
                             panicKey = settings.panicKey;
                             document.getElementById('panic-key-display').textContent = panicKey.toUpperCase();
                         }
                         
                         if (settings.panicUrl) {
                             document.getElementById('panic-url').value = settings.panicUrl;
                         }
                         
                         if (settings.customBackground) {
                             localStorage.setItem('carbon-custom-bg-global', settings.customBackground);
                         }
                         
                         document.getElementById('clear-on-exit').checked = settings.clearOnExit || false;
                         document.getElementById('incognito-mode').checked = settings.incognitoMode || false;
                         document.getElementById('block-tracking').checked = settings.blockTracking !== false;
                         
                         saveSettings();
                         alert('Settings imported successfully!');
                     } catch (error) {
                         alert('Invalid settings file. Please select a valid Carbon settings JSON file.');
                     }
                 };
                 reader.readAsText(file);
             }
         });
         
         // Reset settings
         document.getElementById('reset-settings-btn').addEventListener('click', function() {
             if (confirm('Are you sure you want to reset all settings? This cannot be undone.')) {
                 // Clear all Carbon settings from localStorage
                 const carbonKeys = Object.keys(localStorage).filter(key => key.startsWith('carbon-'));
                 carbonKeys.forEach(key => localStorage.removeItem(key));
                 
                 // Reset to defaults
                 currentTheme = 'rose-pine';
                 currentBackground = 'default';
                 panicKey = null;
                 
                 // Reset UI
                 loadSettings();
                 alert('Settings have been reset to defaults.');
             }
         });
         
         // Initialize
         document.addEventListener('DOMContentLoaded', function() {
             if (auth.currentUser) {
                 loadSettings();
             }
         });
     </script>
</body>
</html>
