<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings - Carbon</title>
    <script defer async>
        function setConfig() {
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            display: ["Switzer", "Helvetica", "sans-serif"],
                            inter: ["Inter", "sans-serif"],
                        },
                        colors: {
                            base: "#191724",
                            surface: "#1f1d2e",
                            overlay: "#26233a",
                            muted: "#6e6a86",
                            subtle: "#908caa",
                            text: "#e0def4",
                            love: "#eb6f92",
                            gold: "#f6c177",
                            rose: "#ebbcba",
                            pine: "#31748f",
                            foam: "#9ccfd8",
                            iris: "#c4a7e7",
                            "highlight-low": "#21202e",
                            "highlight-med": "#403d52",
                            "highlight-high": "#524f67",
                        },
                    },
                },
            };
        }
    </script>
    <script defer async src="https://cdn.tailwindcss.com" onload="setConfig()"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <style>
        :root {
            --text-color: #e0def4;
            --surface-color: #1f1d2e;
            --overlay-color: #26233a;
            --highlight-med: #403d52;
            --highlight-high: #524f67;
            --foam: #9ccfd8;
            --love: #eb6f92;
            --gold: #f6c177;
            --pine: #31748f;
            --iris: #c4a7e7;
            --muted: #6e6a86;
            --subtle: #908caa;
            
            /* Theme variables - Rose Pine (default) */
            --theme-base: #191724;
            --theme-surface: #1f1d2e;
            --theme-overlay: #26233a;
            --theme-muted: #6e6a86;
            --theme-subtle: #908caa;
            --theme-text: #e0def4;
            --theme-love: #eb6f92;
            --theme-gold: #f6c177;
            --theme-rose: #ebbcba;
            --theme-pine: #31748f;
            --theme-foam: #9ccfd8;
            --theme-iris: #c4a7e7;
            --theme-highlight-low: #21202e;
            --theme-highlight-med: #403d52;
            --theme-highlight-high: #524f67;
            --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
        }
        
        /* Theme color schemes */
        [data-theme="dark"] {
            --theme-base: #0f172a;
            --theme-surface: #1e293b;
            --theme-overlay: #334155;
            --theme-muted: #64748b;
            --theme-subtle: #94a3b8;
            --theme-text: #f1f5f9;
            --theme-love: #ef4444;
            --theme-gold: #f59e0b;
            --theme-rose: #f97316;
            --theme-pine: #059669;
            --theme-foam: #06b6d4;
            --theme-iris: #8b5cf6;
            --theme-highlight-low: #1e293b;
            --theme-highlight-med: #475569;
            --theme-highlight-high: #64748b;
            --theme-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        }
        
        [data-theme="light"] {
            --theme-base: #f8fafc;
            --theme-surface: #e2e8f0;
            --theme-overlay: #cbd5e1;
            --theme-muted: #64748b;
            --theme-subtle: #475569;
            --theme-text: #0f172a;
            --theme-love: #dc2626;
            --theme-gold: #d97706;
            --theme-rose: #ea580c;
            --theme-pine: #047857;
            --theme-foam: #0891b2;
            --theme-iris: #7c3aed;
            --theme-highlight-low: #f1f5f9;
            --theme-highlight-med: #e2e8f0;
            --theme-highlight-high: #cbd5e1;
            --theme-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
        }
        
        [data-theme="catppuccin"] {
            --theme-base: #1e1e2e;
            --theme-surface: #313244;
            --theme-overlay: #45475a;
            --theme-muted: #6c7086;
            --theme-subtle: #9399b2;
            --theme-text: #cdd6f4;
            --theme-love: #f38ba8;
            --theme-gold: #f9e2af;
            --theme-rose: #fab387;
            --theme-pine: #a6e3a1;
            --theme-foam: #89dceb;
            --theme-iris: #cba6f7;
            --theme-highlight-low: #181825;
            --theme-highlight-med: #313244;
            --theme-highlight-high: #45475a;
            --theme-gradient: linear-gradient(135deg, #1e1e2e 0%, #313244 50%, #45475a 100%);
        }
        
        [data-theme="nord"] {
            --theme-base: #2e3440;
            --theme-surface: #3b4252;
            --theme-overlay: #434c5e;
            --theme-muted: #4c566a;
            --theme-subtle: #d8dee9;
            --theme-text: #eceff4;
            --theme-love: #bf616a;
            --theme-gold: #ebcb8b;
            --theme-rose: #d08770;
            --theme-pine: #a3be8c;
            --theme-foam: #88c0d0;
            --theme-iris: #b48ead;
            --theme-highlight-low: #2e3440;
            --theme-highlight-med: #434c5e;
            --theme-highlight-high: #4c566a;
            --theme-gradient: linear-gradient(135deg, #2e3440 0%, #3b4252 50%, #434c5e 100%);
        }
        
        [data-theme="gruvbox"] {
            --theme-base: #282828;
            --theme-surface: #3c3836;
            --theme-overlay: #504945;
            --theme-muted: #665c54;
            --theme-subtle: #a89984;
            --theme-text: #ebdbb2;
            --theme-love: #fb4934;
            --theme-gold: #fabd2f;
            --theme-rose: #fe8019;
            --theme-pine: #b8bb26;
            --theme-foam: #8ec07c;
            --theme-iris: #d3869b;
            --theme-highlight-low: #1d2021;
            --theme-highlight-med: #3c3836;
            --theme-highlight-high: #504945;
            --theme-gradient: linear-gradient(135deg, #282828 0%, #3c3836 50%, #504945 100%);
        }
        
        [data-theme="tokyo-night"] {
            --theme-base: #1a1b26;
            --theme-surface: #24283b;
            --theme-overlay: #414868;
            --theme-muted: #565f89;
            --theme-subtle: #a9b1d6;
            --theme-text: #c0caf5;
            --theme-love: #f7768e;
            --theme-gold: #e0af68;
            --theme-rose: #ff9e64;
            --theme-pine: #9ece6a;
            --theme-foam: #7dcfff;
            --theme-iris: #bb9af7;
            --theme-highlight-low: #16161e;
            --theme-highlight-med: #24283b;
            --theme-highlight-high: #414868;
            --theme-gradient: linear-gradient(135deg, #1a1b26 0%, #24283b 50%, #414868 100%);
        }
        
        [data-theme="dracula"] {
            --theme-base: #282a36;
            --theme-surface: #44475a;
            --theme-overlay: #6272a4;
            --theme-muted: #6272a4;
            --theme-subtle: #f8f8f2;
            --theme-text: #f8f8f2;
            --theme-love: #ff5555;
            --theme-gold: #f1fa8c;
            --theme-rose: #ffb86c;
            --theme-pine: #50fa7b;
            --theme-foam: #8be9fd;
            --theme-iris: #bd93f9;
            --theme-highlight-low: #21222c;
            --theme-highlight-med: #44475a;
            --theme-highlight-high: #6272a4;
            --theme-gradient: linear-gradient(135deg, #282a36 0%, #44475a 50%, #6272a4 100%);
        }
        
        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .setting-card {
            background: var(--surface-color);
            border: 1px solid var(--overlay-color);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .setting-card:hover {
            border-color: var(--highlight-med);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        }
        
        .bg-preview, .theme-preview {
            width: 120px;
            height: 80px;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .bg-preview.active, .theme-preview.active {
            border-color: var(--foam);
            box-shadow: 0 0 0 2px rgba(156, 207, 216, 0.3);
        }
        
        .bg-preview:hover, .theme-preview:hover {
            border-color: var(--muted);
            transform: scale(1.05);
        }
        
        .panic-key-display {
            min-height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            background: var(--overlay-color);
            border-radius: 0.75rem;
            color: var(--foam);
            border: 2px solid var(--highlight-med);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .panic-key-display.recording {
            border-color: var(--love);
            background: var(--love);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .panic-key-display.recording::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .image-upload {
            border: 2px dashed var(--highlight-med);
            border-radius: 0.75rem;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--surface-color) 0%, var(--overlay-color) 100%);
        }
        
        .image-upload:hover {
            border-color: var(--foam);
            background: var(--highlight-med);
            transform: translateY(-2px);
        }
        
        .image-upload.dragover {
            border-color: var(--foam);
            background: var(--highlight-med);
            transform: scale(1.02);
        }
        
        .custom-bg-preview {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            background-size: cover;
            background-position: center;
            border: 2px solid var(--highlight-med);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .custom-bg-preview:hover {
            border-color: var(--foam);
            transform: scale(1.02);
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .feature-item {
            background: var(--highlight-med);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .feature-item:hover {
            background: var(--highlight-high);
            transform: translateY(-2px);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, var(--foam) 0%, var(--iris) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--foam) 0%, var(--pine) 100%);
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(156, 207, 216, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--love) 0%, #d63384 100%);
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(235, 111, 146, 0.4);
        }
        
        .input-field {
            background: var(--overlay-color);
            border: 1px solid var(--highlight-med);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: var(--foam);
            box-shadow: 0 0 0 3px rgba(156, 207, 216, 0.1);
            outline: none;
        }
        
        .checkbox-custom {
            appearance: none;
            width: 1.2rem;
            height: 1.2rem;
            border: 2px solid var(--highlight-med);
            border-radius: 0.25rem;
            background: var(--surface-color);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkbox-custom:checked {
            background: var(--foam);
            border-color: var(--foam);
        }
        
        .checkbox-custom:checked::before {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--surface-color);
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--foam);
            margin-right: 0.5rem;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.inactive {
            background: var(--muted);
            animation: none;
        }
    </style>
</head>
<body class="font-inter bg-gradient-to-br from-base via-surface to-overlay text-text min-h-screen">
    <!-- Login Screen (shown when not authenticated) -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center px-4">
        <div class="bg-surface border border-overlay rounded-xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <i class="bx bx-cog text-6xl text-foam mb-4"></i>
                <h1 class="text-2xl font-bold text-text mb-2">Carbon Settings</h1>
                <p class="text-muted">Sign in to access your settings and sync across devices</p>
            </div>
            <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 bg-foam hover:bg-foam/90 text-base font-medium px-6 py-3 rounded-lg transition-all duration-200">
                <i class='bx bxl-google text-xl'></i>
                Continue with Google
            </button>
            <div id="login-error" class="text-love mt-4 text-sm text-center hidden"></div>
        </div>
    </div>

    <!-- Settings Content (shown when authenticated) -->
    <div id="settings-content" class="settings-container hidden">
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold mb-2 text-text flex items-center gap-3">
                        <i class="bx bx-cog text-foam"></i>
                        <span class="gradient-text">Carbon Settings</span>
                    </h1>
                    <p class="text-muted text-lg">Customize your Carbon browser experience with advanced features</p>
                </div>
                <div id="user-info" class="text-right">
                    <div class="flex items-center gap-3">
                        <img id="user-photo" class="w-10 h-10 rounded-full border-2 border-foam/50" src="" alt="Profile">
                        <div>
                            <p id="user-name" class="text-text font-medium"></p>
                            <button id="sign-out-btn" class="text-muted hover:text-love text-sm transition-colors">Sign Out</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panic Key Settings -->
        <div class="setting-card">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i class="bx bx-shield-alt-2 text-love"></i>
                Panic Key
                <span id="panic-status" class="status-indicator inactive"></span>
            </h2>
            <p class="text-muted mb-4">Set a panic key to quickly close Carbon and redirect to a safe page</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Current Panic Key</label>
                    <div id="panic-key-display" class="panic-key-display">
                        Press "Set Key" to configure
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Actions</label>
                    <div class="flex gap-2">
                        <button id="set-panic-key" class="px-4 py-2 btn-primary text-base rounded-lg font-medium transition-all">
                            <i class="bx bx-key mr-2"></i>Set Key
                        </button>
                        <button id="clear-panic-key" class="px-4 py-2 btn-danger text-white rounded-lg font-medium transition-all">
                            <i class="bx bx-trash mr-2"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <label class="block text-sm font-medium mb-2">Panic Redirect URL</label>
                <input type="url" id="panic-url" placeholder="https://classroom.google.com" 
                       class="input-field w-full px-3 py-2 rounded-lg">
            </div>
        </div>

        <!-- Theme & Background Settings -->
        <div class="setting-card">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i class="bx bx-palette text-iris"></i>
                Theme & Background
            </h2>
            <p class="text-muted mb-4">Choose your preferred theme and background</p>
            
            <div class="mb-6">
                <label class="block text-sm font-medium mb-3">Theme Colors</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="theme-preview active" data-theme="rose-pine" style="background: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%); border: 2px solid #9ccfd8;">
                        <div class="text-center text-xs p-2 text-white">Rose Pine</div>
                    </div>
                    <div class="theme-preview" data-theme="dark" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%); border: 2px solid transparent;">
                        <div class="text-center text-xs p-2 text-white">Dark</div>
                    </div>
                    <div class="theme-preview" data-theme="light" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%); border: 2px solid transparent;">
                        <div class="text-center text-xs p-2 text-black">Light</div>
                    </div>
                    <div class="theme-preview" data-theme="catppuccin" style="background: linear-gradient(135deg, #1e1e2e 0%, #313244 50%, #45475a 100%); border: 2px solid transparent;">
                        <div class="text-center text-xs p-2 text-white">Catppuccin</div>
                    </div>
                    <div class="theme-preview" data-theme="nord" style="background: linear-gradient(135deg, #2e3440 0%, #3b4252 50%, #434c5e 100%); border: 2px solid transparent;">
                        <div class="text-center text-xs p-2 text-white">Nord</div>
                    </div>
                    <div class="theme-preview" data-theme="gruvbox" style="background: linear-gradient(135deg, #282828 0%, #3c3836 50%, #504945 100%); border: 2px solid transparent;">
                        <div class="text-center text-xs p-2 text-white">Gruvbox</div>
                    </div>
                    <div class="theme-preview" data-theme="tokyo-night" style="background: linear-gradient(135deg, #1a1b26 0%, #24283b 50%, #414868 100%); border: 2px solid transparent;">
                        <div class="text-center text-xs p-2 text-white">Tokyo Night</div>
                    </div>
                    <div class="theme-preview" data-theme="dracula" style="background: linear-gradient(135deg, #282a36 0%, #44475a 50%, #6272a4 100%); border: 2px solid transparent;">
                        <div class="text-center text-xs p-2 text-white">Dracula</div>
                    </div>
                    <div class="theme-preview color-wheel-trigger" style="background: linear-gradient(135deg, #9ccfd8 0%, #c4a7e7 50%, #eb6f92 100%); border: 2px solid transparent; cursor: pointer;">
                        <div class="text-center text-xs p-2 text-white flex items-center justify-center gap-1">
                            <i class="bx bx-palette"></i>
                            Custom
                        </div>
                    </div>
                </div>
                
                <!-- Custom Themes Display -->
                <div id="custom-themes-section" class="mt-4 hidden">
                    <h4 class="text-sm font-medium mb-3 text-text">Your Custom Themes</h4>
                    <div id="custom-themes-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <!-- Custom themes will be populated here -->
                    </div>
                </div>
                
                <!-- Color Wheel Container -->
                <div id="color-wheel-container" class="mt-6 hidden">
                    <!-- Color wheel will be created here -->
                </div>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium mb-3">Background Options</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-preview active" data-bg="gradient" style="background: var(--theme-gradient);">
                        <div class="text-center text-xs p-2 text-white">Gradient</div>
                    </div>
                    <div class="bg-preview" data-bg="solid" style="background: var(--theme-base);">
                        <div class="text-center text-xs p-2 text-white">Solid</div>
                    </div>
                    <div class="bg-preview" data-bg="pattern" style="background: var(--theme-base) url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="1" fill="%23ffffff" fill-opacity="0.1"/></svg>');">
                        <div class="text-center text-xs p-2 text-white">Pattern</div>
                    </div>
                    <div class="bg-preview" data-bg="particles" style="background: var(--theme-base);">
                        <div class="text-center text-xs p-2 text-white">Particles</div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium mb-3">Custom Background Image</label>
                <div class="image-upload" id="bg-upload">
                    <i class="bx bx-cloud-upload text-3xl text-muted mb-2"></i>
                    <p class="text-muted">Click to upload or drag and drop an image</p>
                    <p class="text-xs text-subtle mt-1">Supports JPG, PNG, WebP</p>
                </div>
                <input type="file" id="bg-file-input" accept="image/*" style="display: none;">
                
                <div id="custom-bg-preview" class="mt-4 hidden">
                    <div class="custom-bg-preview" id="bg-preview-image"></div>
                    <div class="flex gap-2 mt-2">
                        <button id="remove-bg" class="px-3 py-1 bg-love hover:bg-love/80 text-white rounded text-sm">
                            Remove
                        </button>
                        <button id="change-bg" class="px-3 py-1 bg-foam hover:bg-foam/80 text-base rounded text-sm">
                            Change
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Cloaking -->
        <div class="setting-card">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i class="bx bx-mask text-gold"></i>
                Tab Cloaking
            </h2>
            <p class="text-muted mb-4">Disguise your tab title and favicon to avoid detection</p>
            
            <div class="flex items-center gap-4 mb-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="tab-cloaking-enabled" class="checkbox-custom">
                    <span>Enable Tab Cloaking</span>
                </label>
            </div>
            
            <div id="cloaking-options" class="space-y-4 opacity-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Fake Title</label>
                        <input type="text" id="cloak-title" placeholder="Google Classroom" 
                               class="input-field w-full px-3 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Fake Favicon URL</label>
                        <input type="url" id="cloak-favicon" placeholder="https://classroom.google.com/favicon.ico" 
                               class="input-field w-full px-3 py-2 rounded-lg">
                    </div>
                </div>
                
                <div class="bg-highlight-med p-4 rounded-lg">
                    <h4 class="font-medium mb-2">Quick Presets</h4>
                    <div class="flex gap-2 flex-wrap">
                        <button class="cloak-preset px-3 py-1 bg-foam hover:bg-foam/80 text-base rounded text-sm" 
                                data-title="Google Classroom" data-favicon="https://classroom.google.com/favicon.ico">
                            Google Classroom
                        </button>
                        <button class="cloak-preset px-3 py-1 bg-foam hover:bg-foam/80 text-base rounded text-sm" 
                                data-title="Google Docs" data-favicon="https://docs.google.com/favicon.ico">
                            Google Docs
                        </button>
                        <button class="cloak-preset px-3 py-1 bg-foam hover:bg-foam/80 text-base rounded text-sm" 
                                data-title="Khan Academy" data-favicon="https://www.khanacademy.org/favicon.ico">
                            Khan Academy
                        </button>
                        <button class="cloak-preset px-3 py-1 bg-foam hover:bg-foam/80 text-base rounded text-sm" 
                                data-title="Schoology" data-favicon="https://www.schoology.com/favicon.ico">
                            Schoology
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fullscreen Controls -->
        <div class="setting-card">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i class="bx bx-fullscreen text-pine"></i>
                Fullscreen Controls
            </h2>
            <p class="text-muted mb-4">Enable fullscreen mode and configure behavior</p>
            
            <div class="flex items-center gap-4 mb-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="fullscreen-enabled" class="checkbox-custom">
                    <span>Enable Fullscreen Button</span>
                </label>
            </div>
            
            <div class="flex gap-2">
                <button id="enter-fullscreen" class="px-4 py-2 bg-pine hover:bg-pine/80 text-white rounded-lg font-medium transition-all">
                    Enter Fullscreen
                </button>
                <button id="exit-fullscreen" class="px-4 py-2 bg-love hover:bg-love/80 text-white rounded-lg font-medium transition-all">
                    Exit Fullscreen
                </button>
            </div>
        </div>

        <!-- Close Prevention -->
        <div class="setting-card">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i class="bx bx-shield-x text-love"></i>
                Close Prevention
            </h2>
            <p class="text-muted mb-4">Prevent accidental closing of Carbon</p>
            
            <div class="space-y-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="close-prevention-enabled" class="checkbox-custom">
                    <span>Enable Close Prevention</span>
                </label>
                
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="confirm-close" class="checkbox-custom">
                    <span>Show confirmation dialog before closing</span>
                </label>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Custom Close Message</label>
                    <input type="text" id="close-message" placeholder="Are you sure you want to close Carbon?" 
                           class="input-field w-full px-3 py-2 rounded-lg">
                </div>
            </div>
        </div>

        <!-- Teacher Prevention -->
        <div class="setting-card">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i class="bx bx-user-x text-gold"></i>
                Teacher Prevention
            </h2>
            <p class="text-muted mb-4">Advanced privacy and stealth features</p>
            
            <div class="space-y-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="disable-right-click" class="checkbox-custom">
                    <span>Disable right-click menu</span>
                </label>
                
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="disable-devtools" class="checkbox-custom">
                    <span>Disable developer tools shortcuts</span>
                </label>
                
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="disable-select" class="checkbox-custom">
                    <span>Disable text selection</span>
                </label>
                
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="hide-cursor" class="checkbox-custom">
                    <span>Hide cursor when idle</span>
                </label>
                
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="blur-on-unfocus" class="checkbox-custom">
                    <span>Blur screen when window loses focus</span>
                </label>
            </div>
        </div>

        <!-- Save Settings -->
        <div class="text-center">
            <button id="save-settings" class="px-8 py-4 btn-primary text-base rounded-lg font-medium transition-all text-lg">
                <i class="bx bx-check mr-2"></i>
                Auto-Save Enabled
            </button>
        </div>
    </div>

    <script src="carbon-theme.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
            authDomain: "carbon-services.firebaseapp.com",
            projectId: "carbon-services",
            storageBucket: "carbon-services.firebasestorage.app",
            messagingSenderId: "288385472070",
            appId: "1:288385472070:web:c4be3ff186e248fc645c47",
            measurementId: "G-Y2K1RQYE74"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let panicKey = null;
        let isRecordingPanicKey = false;
        let currentTheme = 'rose-pine';
        let currentBackground = 'gradient';
        let currentUser = null;
        
        // Google Sign In
        async function googleSignIn() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Sign in error:', error);
                document.getElementById('login-error').innerText = error.message;
                document.getElementById('login-error').classList.remove('hidden');
            }
        }
        
        // Sign Out
        async function signOut() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }
        
        // Authentication state observer
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            
            if (user) {
                // User is signed in - show settings
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('settings-content').classList.remove('hidden');
                
                // Update user info
                document.getElementById('user-photo').src = user.photoURL || '';
                document.getElementById('user-name').textContent = user.displayName || 'User';
                
                loadSettingsFromFirebase();
            } else {
                // User is not signed in - show login
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('settings-content').classList.add('hidden');
            }
        });
        
        // Load settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already authenticated
            if (auth.currentUser) {
                loadSettingsFromFirebase();
            } else {
                loadSettings();
            }
        });

        // Firebase settings sync
        async function loadSettingsFromFirebase() {
            if (!currentUser) {
                loadSettings();
                return;
            }
            
            try {
                const userSettingsDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userSettingsDoc.exists) {
                    const userData = userSettingsDoc.data();
                    const settings = userData.settings || {};
                    
                    // Load settings from Firebase
                    if (settings.panicKey) {
                        panicKey = settings.panicKey;
                        document.getElementById('panic-key-display').textContent = panicKey.toUpperCase();
                    }
                    
                    if (settings.panicUrl) {
                        document.getElementById('panic-url').value = settings.panicUrl;
                    }
                    
                    if (settings.theme) {
                        currentTheme = settings.theme;
                        document.querySelectorAll('.theme-preview').forEach(el => el.classList.remove('active'));
                        document.querySelector(`[data-theme="${settings.theme}"]`)?.classList.add('active');
                    }
                    
                    if (settings.background) {
                        currentBackground = settings.background;
                        document.querySelectorAll('.bg-preview').forEach(el => el.classList.remove('active'));
                        document.querySelector(`[data-bg="${settings.background}"]`)?.classList.add('active');
                    }
                    
                    if (settings.customBackground) {
                        showCustomBgPreview(settings.customBackground);
                    }
                    
                    // Load tab cloaking settings
                    document.getElementById('tab-cloaking-enabled').checked = settings.cloakingEnabled || false;
                    document.getElementById('cloak-title').value = settings.cloakTitle || '';
                    document.getElementById('cloak-favicon').value = settings.cloakFavicon || '';
                    
                    // Load other settings
                    document.getElementById('fullscreen-enabled').checked = settings.fullscreenEnabled || false;
                    document.getElementById('close-prevention-enabled').checked = settings.closePreventionEnabled || false;
                    document.getElementById('confirm-close').checked = settings.confirmClose || false;
                    document.getElementById('close-message').value = settings.closeMessage || '';
                    document.getElementById('disable-right-click').checked = settings.disableRightClick || false;
                    document.getElementById('disable-devtools').checked = settings.disableDevtools || false;
                    document.getElementById('disable-select').checked = settings.disableSelect || false;
                    document.getElementById('hide-cursor').checked = settings.hideCursor || false;
                    document.getElementById('blur-on-unfocus').checked = settings.blurOnUnfocus || false;
                    
                    // Apply settings immediately
                    applySettings();
                    toggleCloakingOptions();
                    updateStatusIndicators();
                    loadCustomThemes();
                } else {
                    // No Firebase settings found, load from localStorage
                    loadSettings();
                }
            } catch (error) {
                console.error('Error loading settings from Firebase:', error);
                loadSettings(); // Fallback to localStorage
            }
        }
        
        async function saveSettingsToFirebase() {
            if (!currentUser) {
                return;
            }
            
            try {
                const settings = {
                    panicKey: panicKey || '',
                    panicUrl: document.getElementById('panic-url').value,
                    theme: currentTheme,
                    background: currentBackground,
                    customBackground: localStorage.getItem('carbon-custom-bg-global') || '',
                    cloakingEnabled: document.getElementById('tab-cloaking-enabled').checked,
                    cloakTitle: document.getElementById('cloak-title').value,
                    cloakFavicon: document.getElementById('cloak-favicon').value,
                    fullscreenEnabled: document.getElementById('fullscreen-enabled').checked,
                    closePreventionEnabled: document.getElementById('close-prevention-enabled').checked,
                    confirmClose: document.getElementById('confirm-close').checked,
                    closeMessage: document.getElementById('close-message').value,
                    disableRightClick: document.getElementById('disable-right-click').checked,
                    disableDevtools: document.getElementById('disable-devtools').checked,
                    disableSelect: document.getElementById('disable-select').checked,
                    hideCursor: document.getElementById('hide-cursor').checked,
                    blurOnUnfocus: document.getElementById('blur-on-unfocus').checked,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid).set({
                    settings: settings
                }, { merge: true });
                
                console.log('Settings saved to Firebase successfully');
            } catch (error) {
                console.error('Error saving settings to Firebase:', error);
            }
        }

        // Settings management
        function loadSettings() {
            // Load panic key
            const savedPanicKey = localStorage.getItem('carbon-panic-key');
            if (savedPanicKey) {
                panicKey = savedPanicKey;
                document.getElementById('panic-key-display').textContent = panicKey.toUpperCase();
            }
            
            // Load panic URL
            const savedPanicUrl = localStorage.getItem('carbon-panic-url');
            if (savedPanicUrl) {
                document.getElementById('panic-url').value = savedPanicUrl;
            }
            
            // Load theme using enhanced theme system
            const savedTheme = localStorage.getItem('carbon-theme-global') || 'rose-pine';
            currentTheme = savedTheme;
            document.querySelectorAll('.theme-preview').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-theme="${savedTheme}"]`)?.classList.add('active');
            
            // Load custom themes
            loadCustomThemes();
            
            // Load background
            const savedBg = localStorage.getItem('carbon-background') || 'gradient';
            currentBackground = savedBg;
            document.querySelectorAll('.bg-preview').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-bg="${savedBg}"]`)?.classList.add('active');
            
            // Load custom background
            const savedCustomBg = localStorage.getItem('carbon-custom-bg-global');
            if (savedCustomBg) {
                showCustomBgPreview(savedCustomBg);
            }
            
            // Load tab cloaking
            const cloakingEnabled = localStorage.getItem('carbon-cloak-enabled') === 'true';
            document.getElementById('tab-cloaking-enabled').checked = cloakingEnabled;
            document.getElementById('cloak-title').value = localStorage.getItem('carbon-cloak-title') || '';
            document.getElementById('cloak-favicon').value = localStorage.getItem('carbon-cloak-favicon') || '';
            toggleCloakingOptions();
            
            // Load fullscreen
            const fullscreenEnabled = localStorage.getItem('carbon-fullscreen-enabled') === 'true';
            document.getElementById('fullscreen-enabled').checked = fullscreenEnabled;
            
            // Load close prevention
            document.getElementById('close-prevention-enabled').checked = localStorage.getItem('carbon-close-prevention') === 'true';
            document.getElementById('confirm-close').checked = localStorage.getItem('carbon-confirm-close') === 'true';
            document.getElementById('close-message').value = localStorage.getItem('carbon-close-message') || '';
            
            // Load teacher prevention
            document.getElementById('disable-right-click').checked = localStorage.getItem('carbon-disable-right-click') === 'true';
            document.getElementById('disable-devtools').checked = localStorage.getItem('carbon-disable-devtools') === 'true';
            document.getElementById('disable-select').checked = localStorage.getItem('carbon-disable-select') === 'true';
            document.getElementById('hide-cursor').checked = localStorage.getItem('carbon-hide-cursor') === 'true';
            document.getElementById('blur-on-unfocus').checked = localStorage.getItem('carbon-blur-unfocus') === 'true';
            
            // Update status indicators
            updateStatusIndicators();
        }

        function loadCustomThemes() {
            if (!window.carbonTheme) {
                setTimeout(loadCustomThemes, 100);
                return;
            }

            const customThemes = window.carbonTheme.customThemes;
            const customThemesGrid = document.getElementById('custom-themes-grid');
            const customThemesSection = document.getElementById('custom-themes-section');
            
            // Clear existing custom themes
            customThemesGrid.innerHTML = '';
            
            if (Object.keys(customThemes).length > 0) {
                customThemesSection.classList.remove('hidden');
                
                Object.entries(customThemes).forEach(([name, theme]) => {
                    const themeDiv = document.createElement('div');
                    themeDiv.className = 'theme-preview custom-theme-preview';
                    themeDiv.dataset.theme = name;
                    themeDiv.style.background = `linear-gradient(135deg, ${theme.base} 0%, ${theme.surface} 50%, ${theme.overlay} 100%)`;
                    themeDiv.style.border = currentTheme === name ? '2px solid #9ccfd8' : '2px solid transparent';
                    themeDiv.innerHTML = `
                        <div class="text-center text-xs p-2 text-white flex items-center justify-center gap-1">
                            <span class="truncate">${name}</span>
                            <button class="delete-custom-theme ml-1 text-red-400 hover:text-red-300" data-theme="${name}">×</button>
                        </div>
                    `;
                    customThemesGrid.appendChild(themeDiv);
                });
            } else {
                customThemesSection.classList.add('hidden');
            }
        }

        async function saveSettings() {
            // Save panic key
            localStorage.setItem('carbon-panic-key', panicKey || '');
            localStorage.setItem('carbon-panic-url', document.getElementById('panic-url').value);
            
            // Save theme and background using global keys
            localStorage.setItem('carbon-theme-global', currentTheme);
            localStorage.setItem('carbon-background-global', currentBackground);
            
            // Save tab cloaking
            localStorage.setItem('carbon-cloak-enabled', document.getElementById('tab-cloaking-enabled').checked);
            localStorage.setItem('carbon-cloak-title', document.getElementById('cloak-title').value);
            localStorage.setItem('carbon-cloak-favicon', document.getElementById('cloak-favicon').value);
            
            // Save fullscreen
            localStorage.setItem('carbon-fullscreen-enabled', document.getElementById('fullscreen-enabled').checked);
            
            // Save close prevention
            localStorage.setItem('carbon-close-prevention', document.getElementById('close-prevention-enabled').checked);
            localStorage.setItem('carbon-confirm-close', document.getElementById('confirm-close').checked);
            localStorage.setItem('carbon-close-message', document.getElementById('close-message').value);
            
            // Save teacher prevention
            localStorage.setItem('carbon-disable-right-click', document.getElementById('disable-right-click').checked);
            localStorage.setItem('carbon-disable-devtools', document.getElementById('disable-devtools').checked);
            localStorage.setItem('carbon-disable-select', document.getElementById('disable-select').checked);
            localStorage.setItem('carbon-hide-cursor', document.getElementById('hide-cursor').checked);
            localStorage.setItem('carbon-blur-unfocus', document.getElementById('blur-on-unfocus').checked);
            
            // Save to Firebase if user is authenticated
            if (currentUser) {
                await saveSettingsToFirebase();
            }
            
            // Apply settings immediately
            applySettings();
            
            // Notify parent window to refresh settings
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'carbon-settings-refresh'
                }, '*');
            }
            
            // Update status indicators
            updateStatusIndicators();
            
            // Show success message
            const btn = document.getElementById('save-settings');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bx bx-check mr-2"></i>Saved!';
            btn.classList.add('bg-pine');
            btn.classList.remove('bg-foam');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('bg-pine');
                btn.classList.add('bg-foam');
            }, 2000);
        }

        function updateStatusIndicators() {
            // Update panic key status
            const panicStatus = document.getElementById('panic-status');
            if (panicKey) {
                panicStatus.classList.remove('inactive');
                panicStatus.classList.add('active');
            } else {
                panicStatus.classList.add('inactive');
                panicStatus.classList.remove('active');
            }
            
            // Update other status indicators as needed
            // Add more status indicators for other features
        }

        function applySettings() {
            // Apply theme
            applyTheme(currentTheme);
            
            // Apply background
            applyBackground();
            
            // Apply tab cloaking
            applyTabCloaking();
            
            // Apply teacher prevention
            applyTeacherPrevention();
            
            // Apply close prevention
            applyClosePrevention();
            
            // Notify parent window of settings changes
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'carbon-settings-updated',
                    settings: {
                        panicKey: panicKey,
                        panicUrl: document.getElementById('panic-url').value,
                        theme: currentTheme,
                        background: currentBackground,
                        cloaking: {
                            enabled: document.getElementById('tab-cloaking-enabled').checked,
                            title: document.getElementById('cloak-title').value,
                            favicon: document.getElementById('cloak-favicon').value
                        }
                    }
                }, '*');
            }
        }

        function applyTheme(theme) {
            // Use the enhanced theme system
            if (window.carbonTheme) {
                window.carbonTheme.setTheme(theme);
            } else {
                // Fallback if theme system not ready
                document.documentElement.setAttribute('data-theme', theme);
            }
            
            // Update background preview styles based on theme
            updateBackgroundPreviews();
        }

        function updateBackgroundPreviews() {
            const gradientPreview = document.querySelector('[data-bg="gradient"]');
            const solidPreview = document.querySelector('[data-bg="solid"]');
            const patternPreview = document.querySelector('[data-bg="pattern"]');
            
            if (gradientPreview) {
                gradientPreview.style.background = 'var(--theme-gradient)';
            }
            if (solidPreview) {
                solidPreview.style.background = 'var(--theme-base)';
            }
            if (patternPreview) {
                const baseColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-base').trim();
                patternPreview.style.background = `${baseColor} url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="1" fill="%23ffffff" fill-opacity="0.1"/></svg>')`;
            }
        }



        function applyBackground() {
            const body = document.body;
            const customBg = localStorage.getItem('carbon-custom-bg-global');
            
            if (customBg) {
                body.style.background = `url(${customBg}) center/cover`;
                body.style.backgroundAttachment = 'fixed';
            } else {
                switch (currentBackground) {
                    case 'solid':
                        body.style.background = 'var(--theme-base)';
                        break;
                    case 'pattern':
                        body.style.background = `var(--theme-base) url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="1" fill="%23ffffff" fill-opacity="0.1"/></svg>')`;
                        break;
                    case 'particles':
                        body.style.background = 'var(--theme-base)';
                        // Add particle effect if needed
                        break;
                    case 'gradient':
                    default:
                        body.style.background = 'var(--theme-gradient)';
                        break;
                }
                body.style.backgroundAttachment = 'fixed';
            }
        }

        function applyTabCloaking() {
            const enabled = document.getElementById('tab-cloaking-enabled').checked;
            const title = document.getElementById('cloak-title').value;
            const favicon = document.getElementById('cloak-favicon').value;
            
            if (enabled && title) {
                document.title = title;
                
                if (favicon) {
                    const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                    link.type = 'image/x-icon';
                    link.rel = 'shortcut icon';
                    link.href = favicon;
                    document.getElementsByTagName('head')[0].appendChild(link);
                }
            } else {
                document.title = 'Settings - Carbon';
            }
        }

        function applyTeacherPrevention() {
            // Disable right-click
            if (document.getElementById('disable-right-click').checked) {
                document.addEventListener('contextmenu', e => e.preventDefault());
            }
            
            // Disable text selection
            if (document.getElementById('disable-select').checked) {
                document.body.style.userSelect = 'none';
                document.body.style.webkitUserSelect = 'none';
                document.body.style.mozUserSelect = 'none';
            }
            
            // Hide cursor when idle
            if (document.getElementById('hide-cursor').checked) {
                let cursorTimer;
                document.addEventListener('mousemove', () => {
                    document.body.style.cursor = 'default';
                    clearTimeout(cursorTimer);
                    cursorTimer = setTimeout(() => {
                        document.body.style.cursor = 'none';
                    }, 3000);
                });
            }
            
            // Blur on unfocus
            if (document.getElementById('blur-on-unfocus').checked) {
                window.addEventListener('blur', () => {
                    document.body.style.filter = 'blur(10px)';
                });
                window.addEventListener('focus', () => {
                    document.body.style.filter = 'none';
                });
            }
        }

        function applyClosePrevention() {
            const enabled = document.getElementById('close-prevention-enabled').checked;
            const confirm = document.getElementById('confirm-close').checked;
            const message = document.getElementById('close-message').value || 'Are you sure you want to close Carbon?';
            
            if (enabled) {
                window.addEventListener('beforeunload', (e) => {
                    if (confirm) {
                        e.preventDefault();
                        e.returnValue = message;
                        return message;
                    }
                });
            }
        }

        // Panic key functionality
        document.getElementById('set-panic-key').addEventListener('click', function() {
            if (isRecordingPanicKey) return;
            
            isRecordingPanicKey = true;
            const display = document.getElementById('panic-key-display');
            display.textContent = 'Press any key...';
            display.classList.add('recording');
            
            function recordKey(e) {
                e.preventDefault();
                panicKey = e.key.toLowerCase();
                display.textContent = panicKey.toUpperCase();
                display.classList.remove('recording');
                isRecordingPanicKey = false;
                document.removeEventListener('keydown', recordKey);
                
                // Update status indicator
                updateStatusIndicators();
            }
            
            document.addEventListener('keydown', recordKey);
        });

        document.getElementById('clear-panic-key').addEventListener('click', function() {
            panicKey = null;
            document.getElementById('panic-key-display').textContent = 'Press "Set Key" to configure';
            
            // Update status indicator
            updateStatusIndicators();
        });

        // Theme selection
        document.addEventListener('click', function(e) {
            // Handle theme preview clicks
            if (e.target.closest('.theme-preview:not(.color-wheel-trigger)')) {
                const preview = e.target.closest('.theme-preview');
                const themeName = preview.dataset.theme;
                
                if (themeName) {
                    document.querySelectorAll('.theme-preview').forEach(el => el.classList.remove('active'));
                    preview.classList.add('active');
                    currentTheme = themeName;
                    applyTheme(currentTheme);
                }
            }
            
            // Handle color wheel trigger
            if (e.target.closest('.color-wheel-trigger')) {
                const container = document.getElementById('color-wheel-container');
                container.classList.remove('hidden');
                container.innerHTML = '';
                
                window.carbonTheme.createColorWheel(container, (themeName, theme) => {
                    container.classList.add('hidden');
                    loadCustomThemes();
                    // Select the new theme
                    currentTheme = themeName;
                    document.querySelectorAll('.theme-preview').forEach(el => el.classList.remove('active'));
                    document.querySelector(`[data-theme="${themeName}"]`)?.classList.add('active');
                });
            }
            
            // Handle custom theme deletion
            if (e.target.closest('.delete-custom-theme')) {
                e.stopPropagation();
                const themeName = e.target.closest('.delete-custom-theme').dataset.theme;
                
                if (confirm(`Delete custom theme "${themeName}"?`)) {
                    window.carbonTheme.deleteCustomTheme(themeName);
                    loadCustomThemes();
                    
                    // If deleted theme was active, switch to default
                    if (currentTheme === themeName) {
                        currentTheme = 'rose-pine';
                        applyTheme(currentTheme);
                        document.querySelectorAll('.theme-preview').forEach(el => el.classList.remove('active'));
                        document.querySelector(`[data-theme="rose-pine"]`)?.classList.add('active');
                    }
                }
            }
        });

        // Background selection
        document.querySelectorAll('.bg-preview').forEach(preview => {
            preview.addEventListener('click', function() {
                document.querySelectorAll('.bg-preview').forEach(el => el.classList.remove('active'));
                this.classList.add('active');
                currentBackground = this.dataset.bg;
                applyBackground();
            });
        });

        // Custom background upload
        document.getElementById('bg-upload').addEventListener('click', () => {
            document.getElementById('bg-file-input').click();
        });

        document.getElementById('bg-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const dataUrl = e.target.result;
                    localStorage.setItem('carbon-custom-bg-global', dataUrl);
                    showCustomBgPreview(dataUrl);
                    applyBackground();
                };
                reader.readAsDataURL(file);
            }
        });

        function showCustomBgPreview(dataUrl) {
            const preview = document.getElementById('custom-bg-preview');
            const image = document.getElementById('bg-preview-image');
            image.style.backgroundImage = `url(${dataUrl})`;
            preview.classList.remove('hidden');
        }

        document.getElementById('remove-bg').addEventListener('click', function() {
            localStorage.removeItem('carbon-custom-bg-global');
            document.getElementById('custom-bg-preview').classList.add('hidden');
            applyBackground();
        });

        document.getElementById('change-bg').addEventListener('click', () => {
            document.getElementById('bg-file-input').click();
        });

        // Tab cloaking
        document.getElementById('tab-cloaking-enabled').addEventListener('change', toggleCloakingOptions);

        function toggleCloakingOptions() {
            const enabled = document.getElementById('tab-cloaking-enabled').checked;
            const options = document.getElementById('cloaking-options');
            options.style.opacity = enabled ? '1' : '0.5';
            options.style.pointerEvents = enabled ? 'auto' : 'none';
        }

        // Cloaking presets
        document.querySelectorAll('.cloak-preset').forEach(preset => {
            preset.addEventListener('click', function() {
                document.getElementById('cloak-title').value = this.dataset.title;
                document.getElementById('cloak-favicon').value = this.dataset.favicon;
            });
        });

        // Fullscreen controls
        document.getElementById('enter-fullscreen').addEventListener('click', function() {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            }
        });

        document.getElementById('exit-fullscreen').addEventListener('click', function() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        });

        // Authentication event listeners
        document.getElementById('google-signin-btn').addEventListener('click', googleSignIn);
        document.getElementById('sign-out-btn').addEventListener('click', signOut);

        // Auto save functionality
        let autoSaveTimeout;
        let isAutoSaving = false;
        
        function triggerAutoSave() {
            if (isAutoSaving) return;
            
            // Clear existing timeout
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            
            // Set new timeout for auto save (debounced)
            autoSaveTimeout = setTimeout(async () => {
                try {
                    isAutoSaving = true;
                    await autoSaveSettings();
                    showAutoSaveStatus('✓ Auto-saved', 'success');
                } catch (error) {
                    console.error('Auto save failed:', error);
                    showAutoSaveStatus('⚠ Auto-save failed', 'error');
                } finally {
                    isAutoSaving = false;
                }
            }, 1000); // 1 second delay
            
            // Show saving indicator
            showAutoSaveStatus('💾 Saving...', 'saving');
        }
        
        async function autoSaveSettings() {
            // Save panic key
            localStorage.setItem('carbon-panic-key', panicKey || '');
            localStorage.setItem('carbon-panic-url', document.getElementById('panic-url').value);
            
            // Save theme and background using global keys
            localStorage.setItem('carbon-theme-global', currentTheme);
            localStorage.setItem('carbon-background-global', currentBackground);
            
            // Save tab cloaking
            localStorage.setItem('carbon-cloak-enabled', document.getElementById('tab-cloaking-enabled').checked);
            localStorage.setItem('carbon-cloak-title', document.getElementById('cloak-title').value);
            localStorage.setItem('carbon-cloak-favicon', document.getElementById('cloak-favicon').value);
            
            // Save fullscreen
            localStorage.setItem('carbon-fullscreen-enabled', document.getElementById('fullscreen-enabled').checked);
            
            // Save close prevention
            localStorage.setItem('carbon-close-prevention', document.getElementById('close-prevention-enabled').checked);
            localStorage.setItem('carbon-confirm-close', document.getElementById('confirm-close').checked);
            localStorage.setItem('carbon-close-message', document.getElementById('close-message').value);
            
            // Save teacher prevention
            localStorage.setItem('carbon-disable-right-click', document.getElementById('disable-right-click').checked);
            localStorage.setItem('carbon-disable-devtools', document.getElementById('disable-devtools').checked);
            localStorage.setItem('carbon-disable-select', document.getElementById('disable-select').checked);
            localStorage.setItem('carbon-hide-cursor', document.getElementById('hide-cursor').checked);
            localStorage.setItem('carbon-blur-unfocus', document.getElementById('blur-on-unfocus').checked);
            
            // Save to Firebase if user is authenticated
            if (currentUser) {
                await saveSettingsToFirebase();
            }
            
            // Apply settings immediately
            applySettings();
            
            // Notify parent window to refresh settings
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'carbon-settings-refresh'
                }, '*');
            }
            
            // Update status indicators
            updateStatusIndicators();
        }
        
        function showAutoSaveStatus(message, type) {
            const btn = document.getElementById('save-settings');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = message;
            btn.classList.remove('bg-foam', 'bg-pine', 'bg-love', 'bg-gold');
            
            if (type === 'success') {
                btn.classList.add('bg-pine');
            } else if (type === 'error') {
                btn.classList.add('bg-love');
            } else if (type === 'saving') {
                btn.classList.add('bg-gold');
            }
            
            if (type !== 'saving') {
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-pine', 'bg-love', 'bg-gold');
                    btn.classList.add('bg-foam');
                }, 2000);
            }
        }
        
        // Add auto save listeners to all form elements
        function setupAutoSaveListeners() {
            // Text inputs
            const textInputs = [
                'panic-url', 'cloak-title', 'cloak-favicon', 'close-message'
            ];
            textInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', triggerAutoSave);
                    element.addEventListener('blur', triggerAutoSave);
                }
            });
            
            // Checkboxes
            const checkboxes = [
                'tab-cloaking-enabled', 'fullscreen-enabled', 'close-prevention-enabled',
                'confirm-close', 'disable-right-click', 'disable-devtools', 
                'disable-select', 'hide-cursor', 'blur-on-unfocus'
            ];
            checkboxes.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', triggerAutoSave);
                }
            });
            
            // Theme and background changes
            document.addEventListener('click', function(e) {
                if (e.target.closest('.theme-preview') || e.target.closest('.bg-preview')) {
                    setTimeout(triggerAutoSave, 100); // Small delay to ensure state is updated
                }
            });
            
            // Custom background upload
            document.getElementById('bg-file-input').addEventListener('change', function() {
                setTimeout(triggerAutoSave, 500); // Delay for file processing
            });
        }
        
        // Initialize auto save
        setupAutoSaveListeners();
        
        // Save settings button (now manual save)
        document.getElementById('save-settings').addEventListener('click', saveSettings);

        // Note: Panic key works globally in proxy.html, not in settings

        // Disable dev tools shortcuts if enabled
        document.addEventListener('keydown', function(e) {
            if (document.getElementById('disable-devtools').checked) {
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && e.key === 'I') || 
                    (e.ctrlKey && e.shiftKey && e.key === 'J') || 
                    (e.ctrlKey && e.key === 'U')) {
                    e.preventDefault();
                    return false;
                }
            }
        });

        // Apply settings on load
        applySettings();
    </script>
</body>
</html>
