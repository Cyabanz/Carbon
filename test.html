<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CARBON</title>
    <script defer async>
      function setConfig() {
        // Default rose-pine colors for initial load
        const defaultColors = {
          base: "#191724",
          surface: "#1f1d2e",
          overlay: "#26233a",
          muted: "#6e6a86",
          subtle: "#908caa",
          text: "#e0def4",
          love: "#eb6f92",
          gold: "#f6c177",
          rose: "#ebbcba",
          pine: "#31748f",
          foam: "#9ccfd8",
          iris: "#c4a7e7",
          "highlight-low": "#21202e",
          "highlight-med": "#403d52",
          "highlight-high": "#524f67",
        };
        
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                display: ["Switzer", "Helvetica", "sans-serif"],
                inter: ["Inter", "sans-serif"],
              },
              colors: defaultColors,
            },
          },
        };
      }
      
      // Function to update Tailwind config with theme colors
      function updateTailwindConfig(theme) {
        if (window.tailwind && window.tailwind.config) {
          const colorMap = {
            base: theme.base,
            surface: theme.surface,
            overlay: theme.overlay,
            muted: theme.muted,
            subtle: theme.subtle,
            text: theme.text,
            love: theme.love,
            gold: theme.gold,
            rose: theme.rose,
            pine: theme.pine,
            foam: theme.foam,
            iris: theme.iris,
            "highlight-low": theme.highlightLow,
            "highlight-med": theme.highlightMed,
            "highlight-high": theme.highlightHigh,
          };
          
          Object.assign(window.tailwind.config.theme.extend.colors, colorMap);
          console.log('ðŸŽ¨ Updated Tailwind config with theme colors');
        }
      }
    </script>

    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" />
    <script
      defer
      async
      src="https://cdn.tailwindcss.com"
      onload="setConfig()"
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="carbon-theme.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
      .suggestion-box {
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        z-index: 1200;
        background: #1f1d2e; /* surface */
        border-radius: 0 0 0.75rem 0.75rem;
        border: 1px solid #26233a; /* overlay */
        border-top: none;
        max-height: 220px;
        overflow-y: auto;
        box-shadow: 0 6px 20px 2px #000a;
        color: #e0def4; /* text */
        font-size: 1rem;
        width: 100%;
      }
      .suggestion-item {
        padding: 0.73rem 1.1rem;
        cursor: pointer;
        transition: background 0.16s;
        border-bottom: 1px solid #26233a; /* overlay */
      }
      .suggestion-item:last-child {
        border-bottom: none;
      }
      .suggestion-item:hover,
      .suggestion-item.active {
        background: #26233a; /* overlay */
        color: #9ccfd8; /* foam */
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .dropdown-list {
        min-width: 160px;
      }
      .dropdown-list button {
        font-size: 1rem;
      }
      
      /* Browser-style vertical tabs */
      .vertical-tabs-container {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 280px;
        background: #1f1d2e;
        border-right: 1px solid #26233a;
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
      }
      
      .vertical-tabs-container.open {
        transform: translateX(0);
      }
      
      .content-with-vertical-tabs {
        margin-left: 0;
        transition: margin-left 0.3s ease;
      }
      
      .content-with-vertical-tabs.with-vertical-tabs {
        margin-left: 280px;
      }
      
      /* Browser-style scrollbar */
      #vertical-tabs-list::-webkit-scrollbar {
        width: 6px;
      }
      
      #vertical-tabs-list::-webkit-scrollbar-track {
        background: #21202e;
      }
      
      #vertical-tabs-list::-webkit-scrollbar-thumb {
        background: #403d52;
        border-radius: 3px;
      }
      
      #vertical-tabs-list::-webkit-scrollbar-thumb:hover {
        background: #524f67;
      }

      /* Game Frame Styles */
      .frame-neon {
        border: 4px solid #00ffff;
        box-shadow: 0 0 20px #00ffff50, inset 0 0 20px #00ffff20;
        border-radius: 12px;
        animation: neonPulse 2s infinite;
      }

      @keyframes neonPulse {
        0%, 100% { box-shadow: 0 0 20px #00ffff50, inset 0 0 20px #00ffff20; }
        50% { box-shadow: 0 0 30px #00ffff80, inset 0 0 30px #00ffff30; }
      }

      .frame-fire {
        border: 4px solid #ff4500;
        box-shadow: 0 0 25px #ff450080, inset 0 0 25px #ff450030;
        border-radius: 12px;
        position: relative;
        animation: fireFlicker 1.5s infinite;
      }

      @keyframes fireFlicker {
        0%, 100% { box-shadow: 0 0 25px #ff450080, inset 0 0 25px #ff450030; }
        25% { box-shadow: 0 0 35px #ff6500a0, inset 0 0 35px #ff650040; }
        75% { box-shadow: 0 0 20px #ff2500a0, inset 0 0 20px #ff250040; }
      }

      .frame-galaxy {
        border: 4px solid #9400d3;
        background: linear-gradient(45deg, #9400d3, #4b0082, #0000ff, #9400d3);
        background-size: 400% 400%;
        box-shadow: 0 0 30px #9400d380, inset 0 0 30px #9400d320;
        border-radius: 12px;
        animation: galaxyRotate 4s infinite;
      }

      @keyframes galaxyRotate {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }

      .frame-diamond {
        border: 4px solid #b9f2ff;
        box-shadow: 0 0 25px #b9f2ff80, inset 0 0 25px #b9f2ff30;
        border-radius: 12px;
        position: relative;
        animation: diamondSparkle 3s infinite;
      }

      @keyframes diamondSparkle {
        0%, 100% { box-shadow: 0 0 25px #b9f2ff80, inset 0 0 25px #b9f2ff30; }
        33% { box-shadow: 0 0 35px #ffffff80, inset 0 0 35px #ffffff30; }
        66% { box-shadow: 0 0 30px #b9f2ff80, inset 0 0 30px #b9f2ff30; }
      }

      .frame-rainbow {
        border: 4px solid;
        border-image: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #00ff00, #0080ff, #8000ff) 1;
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        animation: rainbowShift 2s infinite;
      }

      @keyframes rainbowShift {
        0% { filter: hue-rotate(0deg); }
        100% { filter: hue-rotate(360deg); }
      }

      .frame-shadow {
        border: 4px solid #2d1b69;
        box-shadow: 0 0 30px #2d1b6980, inset 0 0 30px #2d1b6930, 0 0 50px #000000a0;
        border-radius: 12px;
        position: relative;
        animation: shadowPulse 3s infinite;
      }

      @keyframes shadowPulse {
        0%, 100% { box-shadow: 0 0 30px #2d1b6980, inset 0 0 30px #2d1b6930, 0 0 50px #000000a0; }
        50% { box-shadow: 0 0 40px #2d1b69a0, inset 0 0 40px #2d1b6940, 0 0 70px #000000c0; }
      }

      /* Profile Frame Styles */
      .profile-frame-red {
        border: 3px solid #ff4444 !important;
        box-shadow: 0 0 15px #ff444450 !important;
      }

      .profile-frame-blue {
        border: 3px solid #4444ff !important;
        box-shadow: 0 0 15px #4444ff50 !important;
      }

      .profile-frame-orange {
        border: 3px solid #ff8844 !important;
        box-shadow: 0 0 15px #ff884450 !important;
      }

      .profile-frame-green {
        border: 3px solid #44ff44 !important;
        box-shadow: 0 0 15px #44ff4450 !important;
      }

      .profile-frame-purple {
        border: 3px solid #8844ff !important;
        box-shadow: 0 0 15px #8844ff50 !important;
      }

      .profile-frame-gold {
        border: 3px solid #ffd700 !important;
        box-shadow: 0 0 20px #ffd70080 !important;
        animation: goldGlow 2s infinite;
      }

      @keyframes goldGlow {
        0%, 100% { box-shadow: 0 0 20px #ffd70080 !important; }
        50% { box-shadow: 0 0 30px #ffd700a0 !important; }
      }

      .profile-frame-silver {
        border: 3px solid #c0c0c0 !important;
        box-shadow: 0 0 15px #c0c0c080 !important;
      }

      .profile-frame-rainbow {
        border: 3px solid !important;
        border-image: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #00ff00, #0080ff, #8000ff) 1 !important;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.5) !important;
        animation: rainbowProfileShift 3s infinite !important;
      }

      @keyframes rainbowProfileShift {
        0% { filter: hue-rotate(0deg); }
        100% { filter: hue-rotate(360deg); }
      }
    </style>
  </head>
  <body class="font-inter bg-gradient-to-br from-base via-surface to-overlay min-h-screen text-text overflow-hidden">
    <!-- Particles Canvas -->
    <canvas id="particles-canvas" class="fixed inset-0 pointer-events-none hidden"></canvas>
    
    <main class="flex flex-col h-screen">
      <!-- Browser Window -->
      <div class="flex-1 flex flex-col bg-surface shadow-2xl border border-overlay rounded-t-lg overflow-hidden">
        <!-- Browser Title Bar -->
        <!-- <div class="bg-overlay border-b border-highlight-med px-4 py-2 flex items-center justify-between"> -->
        <!--   <div class="flex items-center gap-2"> -->
        <!--     <div class="flex gap-1.5"> -->
        <!--       <div class="w-3 h-3 bg-love rounded-full"></div> -->
        <!--       <div class="w-3 h-3 bg-gold rounded-full"></div> -->
        <!--       <div class="w-3 h-3 bg-foam rounded-full"></div> -->
        <!--     </div> -->
        <!--     <span class="ml-4 text-sm font-medium text-text">Carbon Browser</span> -->
        <!--   </div> -->
        <!--   <div class="flex items-center gap-2"> -->
        <!--     <button class="p-1 hover:bg-highlight-med rounded"> -->
        <!--       <i class="bx bx-minus text-muted"></i> -->
        <!--     </button> -->
        <!--     <button class="p-1 hover:bg-highlight-med rounded"> -->
        <!--       <i class="bx bx-square text-muted"></i> -->
        <!--     </button> -->
        <!--     <button class="p-1 hover:bg-highlight-med rounded"> -->
        <!--       <i class="bx bx-x text-muted"></i> -->
        <!--     </button> -->
        <!--   </div> -->
        <!-- </div> -->
          <!-- Vertical Tabs Sidebar -->
          <div id="vertical-tabs-container" class="vertical-tabs-container">
            <div class="p-4 border-b border-highlight-med bg-surface">
              <h3 class="text-text font-semibold flex items-center gap-2">
                <i class="bx bx-tab text-foam"></i>
                All Tabs
              </h3>
            </div>
            <div id="vertical-tabs-list" class="overflow-y-auto flex-1 bg-overlay/50"></div>
            <!-- Vertical Tab Controls -->
            <div id="vertical-tab-controls" class="p-4 border-t border-highlight-med bg-surface hidden">
              <div class="grid grid-cols-2 gap-2 mb-3">
                <button
                  id="vertical-new-tab-btn"
                  class="w-full p-2 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center gap-2"
                  title="New Tab (Ctrl+T)"
                >
                  <i class="bx bx-plus text-sm"></i>
                  <span class="text-xs">New Tab</span>
                </button>
                <button
                  id="vertical-hide-tab-bar-toggle"
                  class="w-full p-2 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center gap-2"
                  title="Hide Tab Bar"
                >
                  <i class="bx bx-show text-sm"></i>
                  <span class="text-xs">Hide Bar</span>
                </button>
              </div>
              <div class="grid grid-cols-2 gap-2 mb-3">
                <button
                  id="vertical-tab-groups-toggle"
                  class="w-full p-2 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center gap-2"
                  title="Manage Tab Groups"
                >
                  <i class="bx bx-collection text-sm"></i>
                  <span class="text-xs">Groups</span>
                </button>
                <button
                  id="vertical-tabs-layout-toggle"
                  class="w-full p-2 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center gap-2"
                  title="Hide Vertical Tabs"
                >
                  <i class="bx bx-sidebar text-sm rotate-180"></i>
                  <span class="text-xs">Hide Vertical</span>
                </button>
              </div>
            </div>
          </div>
          <!-- Main Content Wrapper -->
          <div id="main-content-wrapper" class="content-with-vertical-tabs collapsed">
          
          <!-- Browser Tab Bar -->
          <div class="bg-overlay/80 border-b border-highlight-med flex items-end">
            <!-- Tabs Container -->
            <div
              id="tabs-bar"
              class="flex items-end flex-1 overflow-x-auto scrollbar-hide px-2"
              style="scrollbar-width: none; -ms-overflow-style: none;"
            ></div>
            
            <!-- Tab Controls -->
            <div id="horizontal-tab-controls" class="flex items-center gap-1 px-2 pb-1">
              <button
                id="new-tab-btn"
                class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center"
                title="New Tab (Ctrl+T)"
              >
                <i class="bx bx-plus text-lg"></i>
              </button>
              <button
                id="hide-tab-bar-toggle"
                class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center"
                title="Hide Tab Bar"
              >
                <i class="bx bx-show text-lg"></i>
              </button>
              <button
                id="tab-groups-toggle"
                class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center"
                title="Manage Tab Groups"
              >
                <i class="bx bx-collection text-lg"></i>
              </button>
              <button
                id="tabs-layout-toggle"
                class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center"
                title="Show All Tabs"
              >
                <i class="bx bx-menu text-lg"></i>
              </button>
            </div>
          </div>

          <!-- Browser Navigation Bar -->
          <div class="bg-surface border-b border-highlight-med px-4 py-3">
            <div class="flex items-center gap-3">
              <!-- Navigation Controls -->
              <div class="flex items-center gap-1">
                <button
                  id="back-btn"
                  class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                  title="Go back"
                >
                  <i class="bx bx-chevron-left text-lg"></i>
                </button>
                <button
                  id="forward-btn"
                  class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                  title="Go forward"
                >
                  <i class="bx bx-chevron-right text-lg"></i>
                </button>
                <button
                  id="refresh-btn"
                  class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center"
                  title="Reload"
                >
                  <i class="bx bx-refresh text-lg"></i>
                </button>
              </div>

              <!-- Address Bar -->
              <form id="address-bar-form" class="max-w-7xl full relative mx-auto flex justify-center">
                <div class="relative">
                  <i class="bx bx-lock-alt absolute left-3 top-1/2 transform -translate-y-1/2 text-foam text-sm"></i>
<input
                     id="address-bar-input"
                     type="text"
                     spellcheck="false"
                     autocomplete="off"
                     placeholder="Search or enter website URL"
                     class="w-[36rem] max-w-2xl h-10 pl-9 pr-12 bg-highlight-med border border-overlay text-text rounded-full text-base focus:outline-none focus:ring-2 focus:ring-foam focus:border-transparent placeholder-muted"
                   />                  <button type="submit" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-muted hover:text-text">
                    <i class="bx bx-search text-sm"></i>
                  </button>
                </div>
                <div id="suggestion-box" class="suggestion-box hidden"></div>
              </form>

              <!-- Browser Controls -->
              <div class="flex items-center gap-1">
                <!-- Search Engine Selector -->
                <div class="relative">
                  <button
                    id="search-engine-btn"
                    class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center"
                    title="Search Engine"
                  >
                    <i id="search-engine-icon" class="bx bxl-google text-lg"></i>
                  </button>
                  <div
                    id="search-engine-dropdown"
                    class="hidden absolute right-0 top-10 bg-overlay border border-highlight-med rounded-lg shadow-lg z-50 py-1 min-w-40"
                  >
                    <button
                      data-engine="https://www.google.com/search?q=%s"
                      class="w-full flex items-center gap-2 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bxl-google text-foam"></i>Google
                    </button>
                    <button
                      data-engine="https://search.brave.com/search?q=%s"
                      class="w-full flex items-center gap-2 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bxl-brave text-gold"></i>Brave
                    </button>
                    <button
                      data-engine="https://duckduckgo.com/?q=%s"
                      class="w-full flex items-center gap-2 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bxl-duckduckgo text-love"></i>DuckDuckGo
                    </button>
                    <button
                      data-engine="https://www.bing.com/search?q=%s"
                      class="w-full flex items-center gap-2 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bxl-microsoft text-foam"></i>Bing
                    </button>
                  </div>
                </div>

                <!-- Redirect Button -->
                <button
                  id="redirect-btn"
                  class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center"
                  title="Redirect to Carbon Website"
                >
                  <i id="redirect-icon" class="bx bx-link-external text-lg"></i>
                </button>

                <!-- Proxy Toggle -->
                <div class="relative">
                  <button
                    id="proxy-toggle-btn"
                    class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center"
                    title="Proxy Settings"
                  >
                    <i id="proxy-toggle-icon" class="bx bx-shield text-lg"></i>
                  </button>
                  <div
                    id="proxy-dropdown"
                    class="hidden absolute right-0 top-10 bg-overlay border border-highlight-med rounded-lg shadow-lg z-50 py-1 min-w-36"
                  >
                    <button
                      data-proxy="uv"
                      class="w-full flex items-center gap-2 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-cloud text-foam"></i>UV
                    </button>
                    <button
                      data-proxy="scram"
                      class="w-full flex items-center gap-2 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-network-chart text-pine"></i>Scramjet
                    </button>
                  </div>
                </div>

                <!-- Private Browsing Toggle -->
                <button
                  id="private-browsing-btn"
                  class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center"
                  title="Open Private Browser"
                >
                  <i id="private-browsing-icon" class="bx bx-hide text-lg"></i>
                </button>

                <!-- Fullscreen Toggle -->
                <button
                  id="fullscreen-toggle-btn"
                  class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center"
                  title="Enter Fullscreen (F11)"
                >
                  <i id="fullscreen-toggle-icon" class="bx bx-fullscreen text-lg"></i>
                </button>

                <!-- Browser Menu -->
                <div class="relative">
                  <button
                    id="menu-btn"
                    class="w-8 h-8 rounded-md bg-transparent hover:bg-highlight-med text-muted hover:text-text transition-all flex items-center justify-center"
                    title="Customize and control Carbon"
                  >
                    <i class="bx bx-dots-vertical-rounded text-lg"></i>
                  </button>
                  <div
                    id="dropdown-menu"
                    class="hidden absolute right-0 top-10 bg-overlay border border-highlight-med rounded-lg shadow-lg z-50 py-2 min-w-64"
                  >
                    <!-- User Profile -->
                    <div id="user-profile-section" class="hidden px-3 py-3 border-b border-highlight-med mb-2">
                      <div class="flex items-center gap-3">
                        <div class="relative">
                          <img id="user-profile-pic" src="" alt="Profile" class="carbon-profile-avatar w-10 h-10 rounded-full border-2 border-foam object-cover">
                          <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-overlay"></div>
                        </div>
                        <div class="flex-1 min-w-0">
                          <p id="user-display-name" class="text-sm font-medium text-text truncate">User Name</p>
                          <p id="user-email" class="text-xs text-muted truncate">user@example.com</p>
                        </div>
                        <button id="profile-menu-btn" class="p-1 text-muted hover:text-foam transition-colors">
                          <i class="bx bx-user text-lg"></i>
                        </button>
                      </div>
                    </div>
                    
                    <!-- Tab Management -->
                    <div class="px-3 py-1 text-xs font-medium text-muted uppercase tracking-wide border-b border-highlight-med mb-2">
                      Tab Management
                    </div>
                    <button
                      id="duplicate-active-tab-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-copy text-foam"></i>
                      <span>Duplicate Tab</span>
                      <span class="ml-auto text-xs text-muted">Ctrl+Shift+D</span>
                    </button>
                    <button
                      id="close-other-tabs-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-x-circle text-love"></i>
                      <span>Close Other Tabs</span>
                      <span class="ml-auto text-xs text-muted">Ctrl+Shift+O</span>
                    </button>
                    <button
                      id="close-all-tabs-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-x text-love"></i>
                      <span>Close All Tabs</span>
                    </button>
                    <button
                      id="reload-all-tabs-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-refresh text-pine"></i>
                      <span>Reload All Tabs</span>
                      <span class="ml-auto text-xs text-muted">Ctrl+Shift+R</span>
                    </button>
                    <button
                      id="unpin-all-tabs-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-pin text-foam"></i>
                      <span>Unpin All Tabs</span>
                    </button>

                    <!-- History & Tools -->
                    <div class="px-3 py-1 text-xs font-medium text-muted uppercase tracking-wide border-b border-highlight-med mb-2 mt-3">
                      History & Tools
                    </div>
                    <button
                      id="history-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-history text-iris"></i>
                      <span>Show Tab History</span>
                    </button>
                    <button
                      id="global-history-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-time text-iris"></i>
                      <span>Browse All History</span>
                    </button>
                    <button
                      id="clear-history-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-trash text-love"></i>
                      <span>Clear History</span>
                    </button>
                    <button
                      id="restore-tabs-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-history text-pine"></i>
                      <span>Restore Tabs</span>
                    </button>

                    <!-- Carbon Pages -->
                    <div class="px-3 py-1 text-xs font-medium text-muted uppercase tracking-wide border-b border-highlight-med mb-2 mt-3">
                      Carbon Pages
                    </div>
                    <button
                      id="carbon-account-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-user text-foam"></i>
                      <span>Account Profile</span>
                    </button>
                    <button
                      id="carbon-settings-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-cog text-iris"></i>
                      <span>Settings</span>
                    </button>
                    <button
                      id="carbon-games-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-game text-gold"></i>
                      <span>Games</span>
                    </button>
                    <button
                      id="carbon-shop-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-store text-pine"></i>
                      <span>Carbon Shop</span>
                      <span class="ml-auto text-xs bg-gold/20 text-gold px-2 py-0.5 rounded-full">NEW</span>
                    </button>
                    <button
                      id="carbon-ai-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-brain text-rose"></i>
                      <span>AI Assistant</span>
                    </button>
                    <button
                      id="carbon-vm-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-server text-gold"></i>
                      <span>Carbon VM</span>
                    </button>

                    <!-- Settings -->
                    <div class="px-3 py-1 text-xs font-medium text-muted uppercase tracking-wide border-b border-highlight-med mb-2 mt-3">
                      Settings
                    </div>
                    <button
                      id="wisp-btn"
                      class="w-full flex items-center gap-3 px-3 py-2 text-text hover:bg-highlight-med transition-colors text-sm"
                    >
                      <i class="bx bx-server text-muted"></i>
                      <span>Configure Wisp Server</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Content Area -->
          <div id="iframe-container" class="flex-1 bg-gradient-to-br from-base to-surface relative overflow-hidden min-h-0">
            <div class="absolute inset-0 bg-gradient-to-br from-foam/5 via-transparent to-iris/5"></div>
          </div>
          
      </div> <!-- End Main Content Wrapper -->
    </div> <!-- End Browser Window -->

      <!-- History Modal -->
      <div
        id="history-modal-bg"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-50"
      >
        <div
          id="history-modal"
          class="bg-surface border border-highlight-med rounded-xl shadow-2xl max-w-md w-[90vw] p-6 relative transform scale-95 opacity-0 transition-all duration-300"
        >
          <button
            id="close-history-modal"
            class="absolute top-4 right-4 text-muted hover:text-love transition-colors"
          >
            <i class="bx bx-x text-xl"></i>
          </button>
          <h2 class="text-lg font-semibold mb-4 text-text flex items-center">
            <i class="bx bx-history mr-2 text-foam"></i>
            Tab History
          </h2>
          <div
            id="modal-history-list"
            class="max-h-80 overflow-y-auto space-y-1 text-subtle"
          ></div>
        </div>
      </div>

      <!-- Tab Context Menu Modal -->
      <div
        id="tab-context-menu-bg"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-50"
      >
        <div
          id="tab-context-menu"
          class="bg-surface border border-highlight-med rounded-xl shadow-2xl max-w-sm w-[90vw] p-6 relative transform scale-95 opacity-0 transition-all duration-300"
        >
          <button
            id="close-tab-context-menu"
            class="absolute top-3 right-3 text-muted hover:text-love transition-colors"
          >
            <i class="bx bx-x text-xl"></i>
          </button>
          
          <h2 class="text-lg font-semibold mb-4 text-text flex items-center">
            <i class="bx bx-cog mr-2 text-foam"></i>
            Tab Settings
          </h2>
          
          <!-- Rename Tab -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-text mb-2">
              <i class="bx bx-edit mr-1"></i>Custom Title
            </label>
            <input
              id="tab-rename-input"
              type="text"
              placeholder="Enter custom title..."
              class="w-full px-3 py-2 bg-highlight-med border border-overlay rounded-lg text-text placeholder-muted focus:outline-none focus:border-foam focus:ring-1 focus:ring-foam"
            />
          </div>
          
          <!-- Tab Group -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-text mb-2">
              <i class="bx bx-collection mr-1"></i>Tab Group
            </label>
            <div class="flex gap-2">
              <select
                id="tab-group-select"
                class="flex-1 px-3 py-2 bg-highlight-med border border-overlay rounded-lg text-text focus:outline-none focus:border-foam focus:ring-1 focus:ring-foam"
              >
                <option value="">No Group</option>
              </select>
              <button
                id="create-group-btn"
                class="px-3 py-2 bg-foam hover:bg-foam/80 text-base rounded-lg transition-all"
                title="Create New Group"
              >
                <i class="bx bx-plus"></i>
              </button>
            </div>
          </div>

          <!-- Tab Notes -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-text mb-2">
              <i class="bx bx-note mr-1"></i>Notes
            </label>
            <textarea
              id="tab-notes-input"
              placeholder="Add notes for this tab..."
              rows="3"
              class="w-full px-3 py-2 bg-highlight-med border border-overlay rounded-lg text-text placeholder-muted focus:outline-none focus:border-foam focus:ring-1 focus:ring-foam resize-none"
            ></textarea>
          </div>
          
          <!-- Color Picker -->
          <div class="mb-5">
            <label class="block text-sm font-medium text-text mb-2">
              <i class="bx bx-palette mr-1"></i>Tab Color
            </label>
            <div class="grid grid-cols-6 gap-2">
              <button class="tab-color-btn w-8 h-8 rounded-full border-2 border-transparent hover:border-text transition-all" 
                      data-color="none" style="background: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 8px 8px; background-position: 0 0, 0 4px, 4px -4px, -4px 0px;" title="No Color"></button>
              <button class="tab-color-btn w-8 h-8 rounded-full bg-red-500 border-2 border-transparent hover:border-text transition-all" data-color="#ef4444" title="Red"></button>
              <button class="tab-color-btn w-8 h-8 rounded-full bg-blue-500 border-2 border-transparent hover:border-text transition-all" data-color="#3b82f6" title="Blue"></button>
              <button class="tab-color-btn w-8 h-8 rounded-full bg-green-500 border-2 border-transparent hover:border-text transition-all" data-color="#22c55e" title="Green"></button>
              <button class="tab-color-btn w-8 h-8 rounded-full bg-yellow-500 border-2 border-transparent hover:border-text transition-all" data-color="#eab308" title="Yellow"></button>
              <button class="tab-color-btn w-8 h-8 rounded-full bg-purple-500 border-2 border-transparent hover:border-text transition-all" data-color="#a855f7" title="Purple"></button>
              <button class="tab-color-btn w-8 h-8 rounded-full bg-pink-500 border-2 border-transparent hover:border-text transition-all" data-color="#ec4899" title="Pink"></button>
              <button class="tab-color-btn w-8 h-8 rounded-full bg-orange-500 border-2 border-transparent hover:border-text transition-all" data-color="#f97316" title="Orange"></button>
              <button class="tab-color-btn w-8 h-8 rounded-full bg-teal-500 border-2 border-transparent hover:border-text transition-all" data-color="#14b8a6" title="Teal"></button>
              <button class="tab-color-btn w-8 h-8 rounded-full bg-cyan-500 border-2 border-transparent hover:border-text transition-all" data-color="#06b6d4" title="Cyan"></button>
              <button class="tab-color-btn w-8 h-8 rounded-full bg-indigo-500 border-2 border-transparent hover:border-text transition-all" data-color="#6366f1" title="Indigo"></button>
              <button class="tab-color-btn w-8 h-8 rounded-full bg-rose-500 border-2 border-transparent hover:border-text transition-all" data-color="#f43f5e" title="Rose"></button>
            </div>
          </div>
          
          <!-- Lock/Pin Options -->
          <div class="flex gap-3 mb-6">
            <button
              id="tab-lock-toggle"
              class="flex-1 flex items-center justify-center gap-2 p-3 bg-highlight-med hover:bg-highlight-high border border-foam/50 rounded-lg transition-all"
            >
              <i class="bx bx-lock-alt"></i>
              <span>Toggle Lock</span>
            </button>
            <button
              id="tab-pin-toggle"
              class="flex-1 flex items-center justify-center gap-2 p-3 bg-highlight-med hover:bg-highlight-high border border-foam/50 rounded-lg transition-all"
            >
              <i class="bx bx-pin"></i>
              <span>Toggle Pin</span>
            </button>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex gap-3">
            <button
              id="tab-duplicate-btn"
              class="flex-1 flex items-center justify-center gap-2 p-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium transition-all"
            >
              <i class="bx bx-copy"></i>
              Duplicate
            </button>
            <button
              id="tab-close-btn"
              class="flex-1 flex items-center justify-center gap-2 p-3 bg-love hover:bg-love/80 text-white rounded-lg font-medium transition-all"
            >
              <i class="bx bx-x"></i>
              Close
            </button>
          </div>
        </div>
      </div>

      <!-- Tab Groups Management Modal -->
      <div
        id="tab-groups-modal-bg"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-50"
      >
        <div
          id="tab-groups-modal"
          class="bg-surface border border-highlight-med rounded-xl shadow-2xl max-w-lg w-[90vw] p-6 relative transform scale-95 opacity-0 transition-all duration-300"
        >
          <button
            id="close-tab-groups-modal"
            class="absolute top-3 right-3 text-muted hover:text-love transition-colors"
          >
            <i class="bx bx-x text-xl"></i>
          </button>
          
          <h2 class="text-lg font-semibold mb-4 text-text flex items-center">
            <i class="bx bx-collection mr-2 text-foam"></i>
            Tab Groups
          </h2>
          
          <!-- Create New Group -->
          <div class="mb-6 p-4 bg-highlight-med rounded-lg">
            <h3 class="text-sm font-medium text-text mb-3">Create New Group</h3>
            <div class="flex gap-2 mb-3">
              <input
                id="new-group-name"
                type="text"
                placeholder="Group name..."
                class="flex-1 px-3 py-2 bg-surface border border-overlay rounded-lg text-text placeholder-muted focus:outline-none focus:border-foam focus:ring-1 focus:ring-foam"
              />
              <select
                id="new-group-color"
                class="px-3 py-2 bg-surface border border-overlay rounded-lg text-text focus:outline-none focus:border-foam focus:ring-1 focus:ring-foam"
              >
                <option value="#3b82f6">Blue</option>
                <option value="#ef4444">Red</option>
                <option value="#22c55e">Green</option>
                <option value="#eab308">Yellow</option>
                <option value="#a855f7">Purple</option>
                <option value="#ec4899">Pink</option>
                <option value="#f97316">Orange</option>
                <option value="#14b8a6">Teal</option>
                <option value="#06b6d4">Cyan</option>
                <option value="#6366f1">Indigo</option>
              </select>
            </div>
            <button
              id="create-new-group-btn"
              class="w-full px-4 py-2 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium transition-all"
            >
              <i class="bx bx-plus mr-2"></i>Create Group
            </button>
          </div>
          
          <!-- Existing Groups -->
          <div class="mb-4">
            <h3 class="text-sm font-medium text-text mb-3">Existing Groups</h3>
            <div id="groups-list" class="space-y-2 max-h-64 overflow-y-auto">
              <div class="text-center text-muted py-4">No groups created yet</div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <script type="module" defer>
      // --- Proxy functions with error handling ---
      let makeURL, getProxied, setProxy, setTransport, setWisp;
      
      try {
        const lethalModule = await import("/lethal.mjs");
        makeURL = lethalModule.makeURL;
        getProxied = lethalModule.getProxied;
        setProxy = lethalModule.setProxy;
        setTransport = lethalModule.setTransport;
        setWisp = lethalModule.setWisp;
        console.log('âœ… Lethal proxy module loaded successfully');
      } catch (error) {
        console.warn('âš ï¸ Lethal proxy module failed to load:', error);
        // Provide fallback functions
        makeURL = (url) => url;
        getProxied = (url) => url;
        setProxy = () => {};
        setTransport = () => {};
        setWisp = () => {};
        console.log('ðŸ”„ Using fallback proxy functions');
      }
      // --- END LETHAL IMPORTS ---

      const engines = {
        "https://search.brave.com/search?q=%s": ["Brave", "bxl-brave"],
        "https://duckduckgo.com/?q=%s": ["DuckDuckGo", "bxl-duckduckgo"],
        "https://www.google.com/search?q=%s": ["Google", "bxl-google"],
        "https://www.bing.com/search?q=%s": ["Bing", "bxl-microsoft"],
        "https://search.yahoo.com/search?p=%s": ["Yahoo", "bxl-yahoo"],
        "https://www.ecosia.org/search?q=%s": ["Ecosia", "bxl-leaf"],
      };

      // --- Search Engine Dropdown as Boxicon Button ---
      const wispBtn = document.getElementById("wisp-btn");
      const searchEngineBtn = document.getElementById("search-engine-btn");
      const searchEngineIcon = document.getElementById("search-engine-icon");
      const searchEngineDropdown = document.getElementById(
        "search-engine-dropdown",
      );
      function getCurrentSearchEngine() {
        return (
          localStorage.getItem("search-engine") ||
          "https://search.brave.com/search?q=%s"
        );
      }
      function setCurrentSearchEngine(url) {
        localStorage.setItem("search-engine", url);
        updateSearchEngineDisplay();
      }
      function updateSearchEngineDisplay() {
        const current = getCurrentSearchEngine();
        const [name, icon] = engines[current] || ["Brave", "bxl-brave"];
        searchEngineIcon.className = `bx ${icon} text-2xl`;
        searchEngineBtn.title = name;
      }
      searchEngineBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        searchEngineDropdown.classList.toggle("hidden");
      });
      wispBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const wispServer =
          localStorage.getItem("wisp-server") || "wss://anura.pro/";
        const newWisp = prompt("Enter Wisp server URL:", wispServer);
        if (newWisp) {
          setWisp(newWisp);
          localStorage.setItem("wisp-server", newWisp);
          alert(`Wisp server set to: ${newWisp}`);
        }
      });
      document
        .querySelectorAll("#search-engine-dropdown [data-engine]")
        .forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const engine = e.currentTarget.dataset.engine;
            setCurrentSearchEngine(engine);
            searchEngineDropdown.classList.add("hidden");
            const tab = getActiveTab();
            if (tab && tab.history[tab.pointer]) {
              let v = tab.history[tab.pointer];
              if (!/^(https?:)?\/\//.test(v) && v.length > 0)
                renderTabContent(tab);
            }
          });
        });
      updateSearchEngineDisplay();

      const proxyToggleBtn = document.getElementById("proxy-toggle-btn");
      const proxyToggleIcon = document.getElementById("proxy-toggle-icon");
      const proxyDropdown = document.getElementById("proxy-dropdown");
      function getCurrentProxy() {
        return localStorage.getItem("proxy-backend") || "uv";
      }
      function setCurrentProxy(proxy) {
        localStorage.setItem("proxy-backend", proxy);
        updateProxyToggleUI(proxy);
      }
      function updateProxyToggleUI(proxy) {
        if (proxy === "scram") {
          proxyToggleBtn.classList.remove("border-foam");
          proxyToggleBtn.classList.add("border-gold", "bg-gold/20");
          proxyToggleIcon.className = "bx bx-network-chart text-2xl";
          proxyToggleBtn.title = "Scramjet";
        } else {
          proxyToggleBtn.classList.remove("border-gold", "bg-gold/20");
          proxyToggleBtn.classList.add("border-foam");
          proxyToggleIcon.className = "bx bx-cloud text-2xl";
          proxyToggleBtn.title = "UV";
        }
      }
      proxyToggleBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        proxyDropdown.classList.toggle("hidden");
      });
      document
        .querySelectorAll("#proxy-dropdown [data-proxy]")
        .forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const proxy = e.currentTarget.dataset.proxy;
            await setProxy(proxy);
            setCurrentProxy(proxy);
            proxyDropdown.classList.add("hidden");
            const tab = getActiveTab();
            if (tab) renderTabContent(tab);
          });
        });
      updateProxyToggleUI(getCurrentProxy());

      // --- Fullscreen Functionality ---
      const fullscreenToggleBtn = document.getElementById("fullscreen-toggle-btn");
      const fullscreenToggleIcon = document.getElementById("fullscreen-toggle-icon");
      
      function updateFullscreenUI() {
        if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
          fullscreenToggleIcon.className = "bx bx-exit-fullscreen text-lg";
          fullscreenToggleBtn.title = "Exit Fullscreen (F11)";
        } else {
          fullscreenToggleIcon.className = "bx bx-fullscreen text-lg";
          fullscreenToggleBtn.title = "Enter Fullscreen (F11)";
        }
      }

      async function toggleFullscreen() {
        try {
          if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
            // Exit fullscreen
            if (document.exitFullscreen) {
              await document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
              await document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
              await document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
              await document.msExitFullscreen();
            }
          } else {
            // Enter fullscreen
            const element = document.documentElement;
            if (element.requestFullscreen) {
              await element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) {
              await element.webkitRequestFullscreen();
            } else if (element.mozRequestFullScreen) {
              await element.mozRequestFullScreen();
            } else if (element.msRequestFullscreen) {
              await element.msRequestFullscreen();
            }
          }
        } catch (error) {
          console.error('Error toggling fullscreen:', error);
        }
      }

      // Add event listeners for fullscreen
      fullscreenToggleBtn.addEventListener("click", toggleFullscreen);
      
      // Listen for fullscreen changes
      document.addEventListener("fullscreenchange", updateFullscreenUI);
      document.addEventListener("webkitfullscreenchange", updateFullscreenUI);
      document.addEventListener("mozfullscreenchange", updateFullscreenUI);
      document.addEventListener("MSFullscreenChange", updateFullscreenUI);
      
      // Initialize fullscreen UI
      updateFullscreenUI();

      // Add F11 keyboard shortcut
      document.addEventListener("keydown", (e) => {
        if (e.key === "F11") {
          e.preventDefault();
          toggleFullscreen();
        }
      });

      // --- Redirect Button Functionality ---
      const redirectBtn = document.getElementById("redirect-btn");
      
      function redirectToCarbonWebsite() {
        console.log("ðŸ”„ Redirect button clicked!");
        
        const tab = getActiveTab();
        if (!tab) {
          console.log("âŒ No active tab found");
          return;
        }
        
        const currentUrl = tab.history[tab.pointer] || "";
        console.log("ðŸ” Current URL:", currentUrl);
        console.log("ðŸ” Tab pointer:", tab.pointer);
        console.log("ðŸ” Tab history:", tab.history);
        
        // Check if current URL is a carbon:// URL
        if (currentUrl.startsWith("carbon://")) {
          const carbonPath = currentUrl.replace("carbon://", "");
          console.log("ðŸŽ¯ Carbon path detected:", carbonPath);
          
          let redirectUrl = "https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/";
          
          // Map carbon:// paths to actual website URLs
          switch (carbonPath) {
            case "settings":
              redirectUrl = "https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/settings.html";
              break;
            case "games":
              redirectUrl = "https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/games.html";
              break;
            case "ai":
              redirectUrl = "https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/ai.html";
              break;
            case "account":
              redirectUrl = "https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/profile.html";
              break;
            case "history":
              redirectUrl = "https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/history.html";
              break;
            case "play":
              redirectUrl = "https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/play.html";
              break;
            case "chat":
              redirectUrl = "https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/carbon.html";
              break;
            case "code":
              redirectUrl = "https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/code.html";
              break;
            case "no":
              redirectUrl = "https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/no.html";
              break;
            case "newtab":
            default:
              redirectUrl = "https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/index.html";
              break;
          }
          
          console.log("ðŸš€ Redirecting to:", redirectUrl);
          
          // Navigate to the redirect URL in a new tab
          const newTab = createTab(redirectUrl);
          setActiveTab(newTab.id);
        } else {
          console.log("â„¹ï¸ Not a carbon:// URL, redirecting to main website");
          // If not a carbon:// URL, just go to the main website
          const newTab = createTab("https://carbon-git-cursor-align-authentication-64a676-cyabanzs-projects.vercel.app/");
          setActiveTab(newTab.id);
        }
      }
      
      redirectBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        redirectToCarbonWebsite();
      });

      // --- Proxy Setup ---
      let backend = getCurrentProxy();
      let wisp = localStorage.getItem("wisp-server") || "wss://anura.pro/";
      let transport = localStorage.getItem("proxy-transport");
      setWisp(wisp);
      setProxy(backend);
      if (transport) setTransport(transport);
      else if (navigator.userAgent.indexOf("Firefox") > 0)
        setTransport("libcurl");
      else setTransport("epoxy");

      // --- Tabs Logic ---
      let tabs = [];
      let activeTab = null;
      let tabIdCounter = 1;
      let closedTabsSnapshot = [];
      let verticalTabsMode = false;
      
      // --- Tab Groups Logic ---
      let tabGroups = [];
      let groupIdCounter = 1;
      function createTab(url = "carbon://newtab") {
        const id = "tab-" + tabIdCounter++;
        let title = "New Tab";
        
        if (url === "carbon://newtab") {
          title = "New Tab";
        } else if (url === "carbon://history") {
          title = "History";
        } else if (url === "carbon://account") {
          title = "Account Profile";
        } else if (url === "carbon://settings") {
          title = "Settings";
        } else if (url === "carbon://games") {
          title = "Games";
        } else if (url === "carbon://ai") {
          title = "AI Assistant";
        } else if (url === "carbon://vm") {
          title = "Virtual Machine";
        } else if (url === "carbon://multi") {
          title = "Multi Player";
        } else if (url) {
          title = url;
        }
        
        return {
          id,
          title,
          url,
          history: url ? [url] : ["carbon://newtab"],
          pointer: url ? 0 : 0,
          pinned: false,
          locked: false,
          color: null,
          customTitle: null,
          groupId: null,
          notes: "",
        };
      }
      function renderTabs() {
        if (verticalTabsMode) {
          renderVerticalTabs();
        } else {
          renderHorizontalTabs();
        }
      }
      
      function renderHorizontalTabs() {
        const tabsBar = document.getElementById("tabs-bar");
        tabsBar.innerHTML = "";
        
        // Sort tabs: pinned first, then regular
        const sortedTabs = [...tabs].sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          return 0;
        });
        
        sortedTabs.forEach((tab, idx) => {
          const tabElement = document.createElement("div");
          
          // Browser-style tab styling
          const isActive = tab.id === activeTab;
          
          // Base tab styling with browser-like trapezoid shape
          tabElement.className = `
            relative flex items-center px-4 py-2 mx-0.5 cursor-pointer select-none transition-all duration-200 group 
            min-w-32 max-w-64 h-9 rounded-t-lg border-r border-highlight-med
            ${isActive 
              ? 'bg-surface text-text border-b border-highlight-med z-10 shadow-sm' 
              : 'bg-highlight-med text-subtle hover:bg-highlight-med/90 border-b border-highlight-med'
            }
          `;
          
          // Apply color theming for active tabs
          if (tab.color && isActive) {
            tabElement.style.borderTop = `2px solid ${tab.color}`;
          }
          
          // Pinned tab styling
          if (tab.pinned) {
            tabElement.style.background = isActive ? '#f8fafc' : '#e2e8f0';
            if (isActive) {
              tabElement.style.borderTop = '2px solid #3b82f6';
            }
          }
          
          tabElement.setAttribute("data-tab-id", tab.id);
          
          const content = document.createElement("div");
          content.className = "flex items-center w-full min-w-0 gap-2";
          
          // Favicon placeholder
          const favicon = document.createElement("div");
          favicon.className = "w-4 h-4 flex-shrink-0 rounded-sm bg-gray-400 flex items-center justify-center";
          if (tab.color) {
            favicon.style.backgroundColor = tab.color;
            favicon.innerHTML = '<div class="w-2 h-2 bg-text rounded-full"></div>';
          } else {
            favicon.innerHTML = '<i class="bx bx-world text-xs text-text"></i>';
          }
          content.appendChild(favicon);
          
          // Status indicators
          const statusContainer = document.createElement("div");
          statusContainer.className = "flex items-center gap-1 flex-shrink-0";
          
          // Notes indicator
          if (tab.notes && tab.notes.trim()) {
            const notesIcon = document.createElement("i");
            notesIcon.className = "bx bx-note text-xs text-iris";
            notesIcon.title = "Has notes";
            statusContainer.appendChild(notesIcon);
          }
          
          // Pin indicator
          if (tab.pinned) {
            const pinIcon = document.createElement("i");
            pinIcon.className = "bx bx-pin text-xs text-foam";
            statusContainer.appendChild(pinIcon);
          }
          
          // Lock indicator  
          if (tab.locked) {
            const lockIcon = document.createElement("i");
            lockIcon.className = "bx bx-lock-alt text-xs text-gold";
            statusContainer.appendChild(lockIcon);
          }
          
          if (statusContainer.children.length > 0) {
            content.appendChild(statusContainer);
          }
          
          // Tab title
          const title = document.createElement("span");
          const displayTitle = tab.customTitle || tab.title || "New Tab";
          title.textContent = displayTitle.length > 24 ? displayTitle.slice(0, 21) + "..." : displayTitle;
          title.className = "flex-1 truncate text-sm font-normal min-w-0";
          content.appendChild(title);
          
          // Tab actions (only show on hover)
          const actionsContainer = document.createElement("div");
          actionsContainer.className = "flex items-center gap-0.5 flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity";
          
          // Options button
          const optionsBtn = document.createElement("button");
          optionsBtn.className = "w-5 h-5 rounded flex items-center justify-center hover:bg-highlight-med/20 transition-colors";
          optionsBtn.innerHTML = '<i class="bx bx-dots-horizontal-rounded text-xs"></i>';
          optionsBtn.title = "Tab options";
          optionsBtn.onclick = (e) => {
            e.stopPropagation();
            openTabContextMenu(tab.id);
          };
          actionsContainer.appendChild(optionsBtn);
          
          // Close button
          const closeBtn = document.createElement("button");
          closeBtn.className = "w-5 h-5 rounded flex items-center justify-center hover:bg-love/20 transition-colors";
          closeBtn.innerHTML = '<i class="bx bx-x text-xs"></i>';
          closeBtn.title = tab.locked ? "Tab is locked" : "Close tab";
          
          if (tab.locked) {
            closeBtn.className += " opacity-50 cursor-not-allowed";
          } else {
            closeBtn.onclick = (e) => {
              e.stopPropagation();
              removeTab(tab.id);
            };
          }
          actionsContainer.appendChild(closeBtn);
          
          content.appendChild(actionsContainer);
          tabElement.appendChild(content);
          
          // Tab interactions
          tabElement.onclick = () => setActiveTab(tab.id);
          tabElement.oncontextmenu = (e) => {
            e.preventDefault();
            openTabContextMenu(tab.id);
          };
          
          tabsBar.appendChild(tabElement);
        });
      }
      
      function renderVerticalTabs() {
        const verticalTabsList = document.getElementById("vertical-tabs-list");
        verticalTabsList.innerHTML = "";
        
        // Sort tabs: pinned first, then regular
        const sortedTabs = [...tabs].sort((a, b) => {
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          return 0;
        });
        
        sortedTabs.forEach((tab) => {
          const tabElement = document.createElement("button");
          
          // Browser-style vertical tab styling
          const isActive = tab.id === activeTab;
          
          tabElement.className = `
            w-full p-3 text-left transition-all duration-200 border-l-4 group flex items-center justify-between
            ${isActive 
              ? 'bg-highlight-med text-text border-foam' 
              : 'text-subtle border-transparent hover:bg-highlight-med hover:text-text'
            }
          `;
          
          tabElement.setAttribute("data-tab-id", tab.id);
          
          // Apply color theming
          if (tab.color) {
            tabElement.style.borderLeftColor = tab.color;
            if (isActive) {
              tabElement.style.backgroundColor = `${tab.color}15`;
            }
          }
          
          // Pinned tab styling
          if (tab.pinned) {
            tabElement.style.backgroundColor = isActive ? '#dbeafe' : '#f1f5f9';
            if (!tab.color) {
              tabElement.style.borderLeftColor = '#3b82f6';
            }
          }
          
          const leftContent = document.createElement("div");
          leftContent.className = "flex items-center gap-2 flex-1 min-w-0";
          
          // Favicon placeholder
          const favicon = document.createElement("div");
          favicon.className = "w-4 h-4 flex-shrink-0 rounded-sm bg-gray-400 flex items-center justify-center";
          if (tab.color) {
            favicon.style.backgroundColor = tab.color;
            favicon.innerHTML = '<div class="w-2 h-2 bg-text rounded-full"></div>';
          } else {
            favicon.innerHTML = '<i class="bx bx-world text-xs text-text"></i>';
          }
          leftContent.appendChild(favicon);
          
          // Status indicators
          const statusContainer = document.createElement("div");
          statusContainer.className = "flex items-center gap-1 flex-shrink-0";
          
          // Notes indicator
          if (tab.notes && tab.notes.trim()) {
            const notesIcon = document.createElement("i");
            notesIcon.className = "bx bx-note text-xs text-iris";
            notesIcon.title = "Has notes";
            statusContainer.appendChild(notesIcon);
          }
          
          // Pin indicator
          if (tab.pinned) {
            const pinIcon = document.createElement("i");
            pinIcon.className = "bx bx-pin text-xs text-foam";
            statusContainer.appendChild(pinIcon);
          }
          
          // Lock indicator
          if (tab.locked) {
            const lockIcon = document.createElement("i");
            lockIcon.className = "bx bx-lock-alt text-xs text-gold";
            statusContainer.appendChild(lockIcon);
          }
          
          if (statusContainer.children.length > 0) {
            leftContent.appendChild(statusContainer);
          }
          
          // Tab title
          const title = document.createElement("span");
          const displayTitle = tab.customTitle || tab.title || "New Tab";
          title.textContent = displayTitle.length > 28 ? displayTitle.slice(0, 25) + "..." : displayTitle;
          title.className = "truncate text-sm font-normal min-w-0";
          leftContent.appendChild(title);
          
          // Tab actions
          const rightContent = document.createElement("div");
          rightContent.className = "flex items-center gap-1 flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity";
          
          // Options button
          const optionsBtn = document.createElement("button");
          optionsBtn.className = "w-5 h-5 rounded flex items-center justify-center hover:bg-highlight-med/20 transition-colors";
          optionsBtn.innerHTML = '<i class="bx bx-dots-horizontal-rounded text-xs"></i>';
          optionsBtn.title = "Tab options";
          optionsBtn.onclick = (e) => {
            e.stopPropagation();
            openTabContextMenu(tab.id);
          };
          rightContent.appendChild(optionsBtn);
          
          // Close button
          const closeBtn = document.createElement("button");
          closeBtn.className = "w-5 h-5 rounded flex items-center justify-center hover:bg-love/20 transition-colors";
          closeBtn.innerHTML = '<i class="bx bx-x text-xs"></i>';
          closeBtn.title = tab.locked ? "Tab is locked" : "Close tab";
          
          if (tab.locked) {
            closeBtn.className += " opacity-50 cursor-not-allowed";
          } else {
            closeBtn.onclick = (e) => {
              e.stopPropagation();
              removeTab(tab.id);
            };
          }
          rightContent.appendChild(closeBtn);
          
          tabElement.appendChild(leftContent);
          tabElement.appendChild(rightContent);
          
          tabElement.onclick = () => setActiveTab(tab.id);
          tabElement.oncontextmenu = (e) => {
            e.preventDefault();
            openTabContextMenu(tab.id);
          };
          
          verticalTabsList.appendChild(tabElement);
        });
        
        // Clear horizontal tabs
        document.getElementById("tabs-bar").innerHTML = "";
      }
      function updateAddressBar(tab) {
        let url = tab.history[tab.pointer] || "";
        
        // Keep carbon:// URLs in the address bar instead of showing the actual HTML file
        if (url.startsWith("carbon://")) {
          document.getElementById("address-bar-input").value = url;
        } else {
          document.getElementById("address-bar-input").value = url;
        }
      }
      function renderTabContent(tab, forceReload = false) {
        const iframeContainer = document.getElementById("iframe-container");

        // Hide all iframes
        Array.from(iframeContainer.children).forEach(child => {
            if (child.tagName === 'IFRAME') {
                child.classList.add('hidden');
            }
        });

        let iframe = document.getElementById(`iframe-${tab.id}`);

        if (!iframe) {
            iframe = document.createElement('iframe');
            iframe.id = `iframe-${tab.id}`;
            iframe.title = "Browser Content";
            iframe.className = "w-full h-full border-0 fixed";
            iframe.style.minHeight = '0';
            iframe.style.height = '100%';
            iframe.style.width = '100%';
           iframe.onload = () => {
               try {
                   const url = iframe.contentWindow.location.href;
                   if (url === 'about:blank') return;
                   
                   // Don't update history for carbon:// URLs - they're already correct
                   if (tab.history[tab.pointer] && tab.history[tab.pointer].startsWith('carbon://')) {
                       // Try to get the real title from the iframe for carbon pages
                       let realTitle = null;
                       try {
                           realTitle = iframe.contentDocument?.title || iframe.contentWindow?.document?.title;
                       } catch (e) {}
                       if (realTitle && !tab.customTitle && realTitle !== 'New Tab - Carbon' && realTitle !== 'History - Carbon') {
                           tab.title = realTitle;
                           renderTabs();
                       }
                       return;
                   }
                   
                   // For regular URLs, decode and update normally
                   const decodedUrl = Ultraviolet.codec.plain.decode(url.split('/').pop());
                   updateTabHistory(tab, decodedUrl);
                   updateAddressBar(tab);
                   // Try to get the real title from the iframe
                   let realTitle = null;
                   try {
                       realTitle = iframe.contentDocument?.title || iframe.contentWindow?.document?.title;
                   } catch (e) {}
                   if (realTitle && !tab.customTitle) {
                       tab.title = realTitle;
                       renderTabs();
                   } else {
                       renderTabs();
                   }
               } catch (e) {
                   console.error('Error decoding URL:', e);
               }
           };            iframeContainer.appendChild(iframe);
            
            // Notify new iframe about vertical tabs state
            setTimeout(() => {
              try {
                iframe.contentWindow.postMessage({
                  type: 'carbon-vertical-tabs-state',
                  enabled: verticalTabsMode
                }, '*');
              } catch (e) {
                // Ignore cross-origin errors
              }
            }, 500);
        }

        iframe.classList.remove('hidden');

        if (
          !tab ||
          typeof tab.pointer !== "number" ||
          tab.pointer < 0 ||
          !tab.history[tab.pointer]
        ) {
          iframe.src = "";
          delete iframe.dataset.loadedUrl;
          return;
        }
        let url = tab.history[tab.pointer];
        if (iframe.dataset.loadedUrl !== url || forceReload) {
            // Handle carbon:// protocol URLs
            if (url.startsWith("carbon://")) {
              if (url === "carbon://newtab") {
                // Conditionally load vertical-newtab.html for vertical tabs mode
                if (verticalTabsMode) {
                  iframe.src = "/vertical-newtab.html";
                  console.log('ðŸ”„ Loading vertical new tab layout');
                } else {
                  iframe.src = "/newtab.html";
                }
                iframe.dataset.loadedUrl = url;
              } else if (url === "carbon://history") {
                iframe.src = "/history.html";
                iframe.dataset.loadedUrl = url;
              } else if (url === "carbon://account") {
                iframe.src = "/profile.html";
                iframe.dataset.loadedUrl = url;
              } else if (url === "carbon://settings") {
                iframe.src = "/settings.html";
                iframe.dataset.loadedUrl = url;
              } else if (url === "carbon://games") {
                iframe.src = "/games.html";
                iframe.dataset.loadedUrl = url;
              } else if (url === "carbon://ai") {
                iframe.src = "/ai.html";
                iframe.dataset.loadedUrl = url;
              } else if (url === "carbon://vm") {
                iframe.src = "/vm.html";
                iframe.dataset.loadedUrl = url;
              } else if (url === "carbon://multi") {
                iframe.src = "/multi.html";
                iframe.dataset.loadedUrl = url;
              }
              return;
            }
            
            let search = getCurrentSearchEngine();
            makeURLAndProxied(url, search).then((src) => {
              iframe.src = src;
              iframe.dataset.loadedUrl = url;
            });
        }
      }
      async function makeURLAndProxied(url, search) {
        try {
          let urlToLoad = makeURL(url, search);
          return await getProxied(urlToLoad);
        } catch (e) {
          return "";
        }
      }
      function setActiveTab(tabId) {
        activeTab = tabId;
        renderTabs();
        const tab = tabs.find((t) => t.id === tabId);
        updateAddressBar(tab);
        renderTabContent(tab);
      }
      function addTab(url = "carbon://newtab") {
        const tab = createTab(url);
        tabs.push(tab);
        setActiveTab(tab.id);
      }
      // Enhanced tab management functions
      let currentContextTabId = null;
      
      function openTabContextMenu(tabId) {
        currentContextTabId = tabId;
        const tab = tabs.find(t => t.id === tabId);
        if (!tab) return;
        
        // Update modal elements with current tab data
        document.getElementById("tab-rename-input").value = tab.customTitle || "";
        document.getElementById("tab-notes-input").value = tab.notes || "";
        
        // Update group selection
        updateGroupSelect();
        document.getElementById("tab-group-select").value = tab.groupId || "";
        
        // Update color selection
        document.querySelectorAll(".tab-color-btn").forEach(btn => {
          btn.classList.remove("border-overlay");
          if ((btn.dataset.color === "none" && !tab.color) || btn.dataset.color === tab.color) {
            btn.classList.add("border-overlay");
          }
        });
        
        // Update lock and pin button states
        const lockBtn = document.getElementById("tab-lock-toggle");
        const pinBtn = document.getElementById("tab-pin-toggle");
        
        lockBtn.innerHTML = tab.locked 
          ? '<i class="bx bx-lock-open-alt"></i><span>Unlock Tab</span>' 
          : '<i class="bx bx-lock-alt"></i><span>Lock Tab</span>';
          
        pinBtn.innerHTML = tab.pinned 
          ? '<i class="bx bx-pin"></i><span>Unpin Tab</span>' 
          : '<i class="bx bx-pin"></i><span>Pin Tab</span>';
        
        // Show modal
        const modal = document.getElementById("tab-context-menu-bg");
        const dialog = document.getElementById("tab-context-menu");
        modal.classList.remove("pointer-events-none", "opacity-0");
        modal.classList.add("pointer-events-auto", "opacity-100");
        dialog.classList.remove("scale-95", "opacity-0");
        dialog.classList.add("scale-100", "opacity-100");
      }
      
      function closeTabContextMenu() {
        const modal = document.getElementById("tab-context-menu-bg");
        const dialog = document.getElementById("tab-context-menu");
        modal.classList.add("pointer-events-none", "opacity-0");
        modal.classList.remove("pointer-events-auto", "opacity-100");
        dialog.classList.add("scale-95", "opacity-0");
        dialog.classList.remove("scale-100", "opacity-100");
        currentContextTabId = null;
      }
      
      // Tab Groups Management Functions
      function createTabGroup(name, color) {
        const group = {
          id: "group-" + groupIdCounter++,
          name: name.trim(),
          color: color,
        };
        tabGroups.push(group);
        saveTabGroups();
        return group;
      }
      
      function updateGroupSelect() {
        const select = document.getElementById("tab-group-select");
        select.innerHTML = '<option value="">No Group</option>';
        tabGroups.forEach(group => {
          const option = document.createElement("option");
          option.value = group.id;
          option.textContent = group.name;
          option.style.color = group.color;
          select.appendChild(option);
        });
      }
      
      function assignTabToGroup(tabId, groupId) {
        const tab = tabs.find(t => t.id === tabId);
        if (tab) {
          tab.groupId = groupId || null;
          renderTabs();
          saveTabsData();
        }
      }
      
      function updateTabNotes(tabId, notes) {
        const tab = tabs.find(t => t.id === tabId);
        if (tab) {
          tab.notes = notes;
          saveTabsData();
        }
      }
      
      function deleteTabGroup(groupId) {
        const groupIndex = tabGroups.findIndex(g => g.id === groupId);
        if (groupIndex !== -1) {
          tabs.forEach(tab => {
            if (tab.groupId === groupId) {
              tab.groupId = null;
            }
          });
          tabGroups.splice(groupIndex, 1);
          renderTabs();
          saveTabGroups();
          saveTabsData();
        }
      }
      
      function openTabGroupsModal() {
        renderGroupsList();
        const modal = document.getElementById("tab-groups-modal-bg");
        const dialog = document.getElementById("tab-groups-modal");
        modal.classList.remove("pointer-events-none", "opacity-0");
        modal.classList.add("pointer-events-auto", "opacity-100");
        dialog.classList.remove("scale-95", "opacity-0");
        dialog.classList.add("scale-100", "opacity-100");
      }
      
      function closeTabGroupsModal() {
        const modal = document.getElementById("tab-groups-modal-bg");
        const dialog = document.getElementById("tab-groups-modal");
        modal.classList.add("pointer-events-none", "opacity-0");
        modal.classList.remove("pointer-events-auto", "opacity-100");
        dialog.classList.add("scale-95", "opacity-0");
        dialog.classList.remove("scale-100", "opacity-100");
      }
      
      function renderGroupsList() {
        const groupsList = document.getElementById("groups-list");
        groupsList.innerHTML = "";
        
        if (tabGroups.length === 0) {
          groupsList.innerHTML = '<div class="text-center text-muted py-4">No groups created yet</div>';
          return;
        }
        
        tabGroups.forEach(group => {
          const groupElement = document.createElement("div");
          groupElement.className = "p-3 bg-highlight-med rounded-lg flex items-center justify-between";
          
          const leftContent = document.createElement("div");
          leftContent.className = "flex items-center gap-3";
          
          const colorIndicator = document.createElement("div");
          colorIndicator.className = "w-4 h-4 rounded-full flex-shrink-0";
          colorIndicator.style.backgroundColor = group.color;
          leftContent.appendChild(colorIndicator);
          
          const groupInfo = document.createElement("div");
          groupInfo.className = "flex-1";
          
          const groupName = document.createElement("div");
          groupName.className = "font-medium text-text";
          groupName.textContent = group.name;
          groupInfo.appendChild(groupName);
          
          const tabCount = tabs.filter(t => t.groupId === group.id).length;
          const tabCountText = document.createElement("div");
          tabCountText.className = "text-xs text-muted";
          tabCountText.textContent = `${tabCount} tab${tabCount !== 1 ? 's' : ''}`;
          groupInfo.appendChild(tabCountText);
          
          leftContent.appendChild(groupInfo);
          
          const rightContent = document.createElement("div");
          rightContent.className = "flex items-center gap-1";
          
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "w-8 h-8 rounded flex items-center justify-center hover:bg-love/20 transition-colors";
          deleteBtn.innerHTML = '<i class="bx bx-trash text-xs text-love"></i>';
          deleteBtn.title = "Delete group";
          deleteBtn.onclick = () => {
            if (confirm(`Delete group "${group.name}"? Tabs will be ungrouped.`)) {
              deleteTabGroup(group.id);
              renderGroupsList();
            }
          };
          rightContent.appendChild(deleteBtn);
          
          groupElement.appendChild(leftContent);
          groupElement.appendChild(rightContent);
          groupsList.appendChild(groupElement);
        });
      }
      
      // Data persistence functions
      function saveTabGroups() {
        localStorage.setItem("tab-groups", JSON.stringify(tabGroups));
      }
      
      function loadTabGroups() {
        const saved = localStorage.getItem("tab-groups");
        if (saved) {
          tabGroups = JSON.parse(saved);
          groupIdCounter = Math.max(...tabGroups.map(g => parseInt(g.id.replace("group-", ""))), 0) + 1;
        }
      }
      
      function saveTabsData() {
        localStorage.setItem("tabs-data", JSON.stringify(tabs));
      }
      
      // Enhanced Firebase sync for browser data AND all settings
      async function syncAllDataToFirebase() {
        if (!currentUser) return;
        
        try {
          const browserData = {
            tabs: tabs.map(tab => ({
              id: tab.id,
              url: tab.history[tab.pointer] || 'carbon://newtab',
              title: tab.title || 'New Tab',
              customTitle: tab.customTitle || null,
              history: tab.history || [],
              pointer: tab.pointer || 0,
              groupId: tab.groupId || null,
              pinned: tab.pinned || false,
              locked: tab.locked || false,
              color: tab.color || null,
              notes: tab.notes || null,
              timestamp: Date.now()
            })),
            tabGroups: tabGroups.map(group => ({
              id: group.id,
              name: group.name,
              color: group.color,
              timestamp: Date.now()
            })),
            pinnedTabs: tabs.filter(tab => tab.pinned).map(tab => ({
              id: tab.id,
              url: tab.history[tab.pointer] || 'carbon://newtab',
              title: tab.title || 'New Tab',
              customTitle: tab.customTitle || null,
              groupId: tab.groupId || null,
              timestamp: Date.now()
            })),
            tabHistory: JSON.parse(localStorage.getItem('carbon-history') || '[]'),
            tabSnapshots: JSON.parse(localStorage.getItem('carbon-tab-snapshots') || '[]'),
            bookmarks: JSON.parse(localStorage.getItem('carbon-bookmarks') || '[]'),
            activeTabId: activeTab,
            verticalTabsMode: verticalTabsMode,
            tabBarHidden: tabBarHidden,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          // Sync all current settings as well
          const settings = {
            panicKey: panicKey || '',
            panicUrl: localStorage.getItem('carbon-panic-url') || '',
            theme: localStorage.getItem('carbon-theme-global') || 'rose-pine',
            background: localStorage.getItem('carbon-background-global') || 'gradient',
            customBackground: localStorage.getItem('carbon-custom-bg-global') || '',
            customThemes: JSON.parse(localStorage.getItem('carbon-custom-themes') || '{}'),
            cloakingEnabled: tabCloakingEnabled,
            cloakTitle: cloakTitle,
            cloakFavicon: cloakFavicon,
            fullscreenEnabled: localStorage.getItem('carbon-fullscreen-enabled') === 'true',
            closePreventionEnabled: localStorage.getItem('carbon-close-prevention') === 'true',
            confirmClose: localStorage.getItem('carbon-confirm-close') === 'true',
            closeMessage: localStorage.getItem('carbon-close-message') || '',
            disableRightClick: localStorage.getItem('carbon-disable-right-click') === 'true',
            disableDevtools: localStorage.getItem('carbon-disable-devtools') === 'true',
            disableSelect: localStorage.getItem('carbon-disable-select') === 'true',
            hideCursor: localStorage.getItem('carbon-hide-cursor') === 'true',
            blurOnUnfocus: localStorage.getItem('carbon-blur-unfocus') === 'true',
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          await db.collection('users').doc(currentUser.uid).set({
            browserData: browserData,
            settings: settings,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          
          console.log('Enhanced data synced to Firebase successfully');
        } catch (error) {
          console.error('Error syncing data to Firebase:', error);
        }
      }
      
      // Enhanced function to restore all data from Firebase
      async function restoreAllDataFromFirebase() {
        if (!currentUser) return;
        
        try {
          const doc = await db.collection('users').doc(currentUser.uid).get();
          if (doc.exists) {
            const data = doc.data();
            
            // Restore browser data
            if (data.browserData) {
              const browserData = data.browserData;
              
              // Restore tabs
              if (browserData.tabs && browserData.tabs.length > 0) {
                tabs = browserData.tabs.map(tabData => ({
                  id: tabData.id,
                  url: tabData.url,
                  title: tabData.title,
                  customTitle: tabData.customTitle,
                  history: tabData.history || [tabData.url],
                  pointer: tabData.pointer || 0,
                  groupId: tabData.groupId,
                  pinned: tabData.pinned || false,
                  locked: tabData.locked || false,
                  color: tabData.color,
                  notes: tabData.notes
                }));
              }
              
              // Restore tab groups
              if (browserData.tabGroups) {
                tabGroups = browserData.tabGroups.map(groupData => ({
                  id: groupData.id,
                  name: groupData.name,
                  color: groupData.color
                }));
                saveTabGroups();
              }
              
              // Restore tab history
              if (browserData.tabHistory) {
                localStorage.setItem('carbon-history', JSON.stringify(browserData.tabHistory));
              }
              
              // Restore tab snapshots
              if (browserData.tabSnapshots) {
                localStorage.setItem('carbon-tab-snapshots', JSON.stringify(browserData.tabSnapshots));
              }
              
              // Restore bookmarks
              if (browserData.bookmarks) {
                localStorage.setItem('carbon-bookmarks', JSON.stringify(browserData.bookmarks));
              }
              
              // Restore active tab
              if (browserData.activeTabId) {
                activeTab = browserData.activeTabId;
              }
              
              // Restore vertical tabs mode
              if (browserData.verticalTabsMode !== undefined) {
                verticalTabsMode = browserData.verticalTabsMode;
                localStorage.setItem("vertical-tabs-mode", verticalTabsMode);
              }
              
              // Restore tab bar visibility
              if (browserData.tabBarHidden !== undefined) {
                tabBarHidden = browserData.tabBarHidden;
                localStorage.setItem("tab-bar-hidden", tabBarHidden);
              }
            }
            
            // Restore settings
            if (data.settings) {
              const settings = data.settings;
              
              if (settings.panicKey) panicKey = settings.panicKey;
              if (settings.panicUrl) localStorage.setItem('carbon-panic-url', settings.panicUrl);
              if (settings.theme) localStorage.setItem('carbon-theme-global', settings.theme);
              if (settings.background) localStorage.setItem('carbon-background-global', settings.background);
              if (settings.customBackground) localStorage.setItem('carbon-custom-bg-global', settings.customBackground);
              if (settings.customThemes) localStorage.setItem('carbon-custom-themes', JSON.stringify(settings.customThemes));
              
              if (settings.cloakingEnabled !== undefined) tabCloakingEnabled = settings.cloakingEnabled;
              if (settings.cloakTitle) cloakTitle = settings.cloakTitle;
              if (settings.cloakFavicon) cloakFavicon = settings.cloakFavicon;
              
              // Restore all boolean settings
              if (settings.fullscreenEnabled !== undefined) localStorage.setItem('carbon-fullscreen-enabled', settings.fullscreenEnabled);
              if (settings.closePreventionEnabled !== undefined) localStorage.setItem('carbon-close-prevention', settings.closePreventionEnabled);
              if (settings.confirmClose !== undefined) localStorage.setItem('carbon-confirm-close', settings.confirmClose);
              if (settings.closeMessage) localStorage.setItem('carbon-close-message', settings.closeMessage);
              if (settings.disableRightClick !== undefined) localStorage.setItem('carbon-disable-right-click', settings.disableRightClick);
              if (settings.disableDevtools !== undefined) localStorage.setItem('carbon-disable-devtools', settings.disableDevtools);
              if (settings.disableSelect !== undefined) localStorage.setItem('carbon-disable-select', settings.disableSelect);
              if (settings.hideCursor !== undefined) localStorage.setItem('carbon-hide-cursor', settings.hideCursor);
              if (settings.blurOnUnfocus !== undefined) localStorage.setItem('carbon-blur-unfocus', settings.blurOnUnfocus);
            }
            
            // Re-render everything
            renderTabs();
            saveTabsData();
            applyAllSettings();
            
            console.log('All data restored from Firebase successfully');
          }
        } catch (error) {
          console.error('Error restoring data from Firebase:', error);
        }
      }
      
      function loadTabsData() {
        const saved = localStorage.getItem("tabs-data");
        if (saved) {
          try {
            const savedTabs = JSON.parse(saved);
            savedTabs.forEach(savedTab => {
              if (savedTab.groupId || savedTab.notes) {
                const existingTab = tabs.find(t => t.url === savedTab.url);
                if (existingTab) {
                  existingTab.groupId = savedTab.groupId;
                  existingTab.notes = savedTab.notes;
                }
              }
            });
          } catch (e) {
            console.warn("Failed to load tabs data:", e);
          }
        }
      }
      
      function duplicateTab(tabId) {
        const sourceTab = tabs.find(t => t.id === tabId);
        if (!sourceTab) return;
        
        const newTab = {
          ...sourceTab,
          id: "tab-" + tabIdCounter++,
          pinned: false, // Don't copy pinned state
          locked: false, // Don't copy locked state
        };
        
        tabs.push(newTab);
        setActiveTab(newTab.id);
        renderTabs();
      }
      
      function renameTab(tabId, newTitle) {
        const tab = tabs.find(t => t.id === tabId);
        if (tab) {
          tab.customTitle = newTitle.trim() || null;
          renderTabs();
        }
      }
      
      function setTabColor(tabId, color) {
        const tab = tabs.find(t => t.id === tabId);
        if (tab) {
          tab.color = color === "none" ? null : color;
          renderTabs();
        }
      }
      
      function toggleTabLock(tabId) {
        const tab = tabs.find(t => t.id === tabId);
        if (tab) {
          tab.locked = !tab.locked;
          renderTabs();
        }
      }
      
      function closeOtherTabs(keepTabId) {
        const tabToKeep = tabs.find(t => t.id === keepTabId);
        if (!tabToKeep) return;
        
        // Check for locked tabs
        const lockedTabs = tabs.filter(t => t.id !== keepTabId && t.locked);
        if (lockedTabs.length > 0) {
          alert(`Cannot close ${lockedTabs.length} locked tab(s). Unlock them first.`);
          return;
        }
        
        takeTabsSnapshot();
        tabs = [tabToKeep];
        activeTab = keepTabId;
        renderTabs();
      }
      
      function reloadAllTabs() {
        tabs.forEach(tab => {
          const iframe = document.getElementById(`iframe-${tab.id}`);
          if (iframe && tab.history[tab.pointer]) {
            const url = tab.history[tab.pointer];
            if (iframe.dataset.loadedUrl !== url) {
              // Only reload if URL changed
              let search = getCurrentSearchEngine();
              makeURLAndProxied(url, search).then((src) => {
                iframe.src = src;
                iframe.dataset.loadedUrl = url;
              });
            }
          }
        });
        alert(`Reloaded all tabs that changed.`);
      }

      function removeTab(tabId) {
        const tab = tabs.find((t) => t.id === tabId);
        if (tab && tab.locked) {
          alert("This tab is locked and cannot be closed.");
          return;
        }
        
        // Don't allow closing the last tab
        if (tabs.length <= 1) {
          // Instead of closing, navigate to new tab page
          const lastTab = tabs[0];
          if (lastTab) {
            lastTab.url = "carbon://newtab";
            lastTab.title = "New Tab";
            lastTab.history = ["carbon://newtab"];
            lastTab.pointer = 0;
            lastTab.customTitle = null;
            updateAddressBar(lastTab);
            renderTabContent(lastTab);
            renderTabs();
          }
          return;
        }
        
        const idx = tabs.findIndex((t) => t.id === tabId);
        if (idx !== -1) {
          takeTabsSnapshot();
          const iframe = document.getElementById(`iframe-${tabId}`);
          if (iframe) {
            iframe.remove();
          }
          tabs.splice(idx, 1);
          if (activeTab === tabId) {
            if (tabs[idx - 1]) setActiveTab(tabs[idx - 1].id);
            else if (tabs[idx]) setActiveTab(tabs[idx].id);
            else {
              activeTab = null;
              renderTabs();
              document.getElementById("address-bar-input").value = "";
            }
          } else {
            renderTabs();
          }
        }
      }
      function updateTabHistory(tab, url) {
        if (tab.pointer < tab.history.length - 1) {
          tab.history = tab.history.slice(0, tab.pointer + 1);
        }
        tab.history.push(url);
        tab.pointer = tab.history.length - 1;
        tab.url = url;
        // Only update title if no custom title is set
        if (!tab.customTitle) {
          if (url === "carbon://newtab") {
            tab.title = "New Tab";
          } else if (url === "carbon://history") {
            tab.title = "History";
          } else if (url === "carbon://account") {
            tab.title = "Account Profile";
          } else if (url === "carbon://settings") {
            tab.title = "Settings";
          } else if (url === "carbon://games") {
            tab.title = "Games";
          } else if (url === "carbon://ai") {
            tab.title = "AI Assistant";
          } else {
            tab.title = url ? url : "New Tab";
          }
        }
        
        // Add to global history (but not carbon:// URLs)
        addToGlobalHistory(url, tab.title);
      }
      
      function addToGlobalHistory(url, title = '') {
        // Don't add carbon:// URLs to global history
        if (url.startsWith('carbon://')) return;
        
        try {
          // Get existing history
          const history = JSON.parse(localStorage.getItem('carbon-history') || '[]');
          
          const item = {
            id: Date.now() + Math.random(),
            url: url,
            title: title || url,
            timestamp: new Date().toISOString(),
            visits: 1
          };
          
          // Check if URL already exists
          const existingIndex = history.findIndex(h => h.url === url);
          if (existingIndex !== -1) {
            history[existingIndex].timestamp = item.timestamp;
            history[existingIndex].visits++;
            history[existingIndex].title = title || history[existingIndex].title;
          } else {
            history.unshift(item);
          }
          
          // Limit history to 1000 items
          if (history.length > 1000) {
            history.splice(1000);
          }
          
          // Save history
          localStorage.setItem('carbon-history', JSON.stringify(history));
          
          // Send to history page if it's open
          const historyIframes = document.querySelectorAll('iframe[src="/history.html"]');
          historyIframes.forEach(iframe => {
            try {
              iframe.contentWindow.postMessage({
                type: 'carbon-add-history',
                url: url,
                title: title
              }, '*');
            } catch (e) {
              // Ignore cross-origin errors
            }
          });
        } catch (e) {
          console.error('Error adding to global history:', e);
        }
      }
      function getActiveTab() {
        return tabs.find((t) => t.id === activeTab);
      }
      
      function togglePinTab(tabId) {
        const tab = tabs.find((t) => t.id === tabId);
        if (tab) {
          tab.pinned = !tab.pinned;
          renderTabs();
        }
      }
      
      function toggleVerticalTabs() {
        verticalTabsMode = !verticalTabsMode;
        
        const verticalContainer = document.getElementById("vertical-tabs-container");
        const verticalControls = document.getElementById("vertical-tab-controls");
        const horizontalControls = document.getElementById("horizontal-tab-controls");
        const mainContent = document.getElementById("main-content-wrapper");
        const toggleBtn = document.getElementById("tabs-layout-toggle");
        const verticalToggleBtn = document.getElementById("vertical-tabs-layout-toggle");
        
        if (verticalTabsMode) {
          verticalContainer.classList.add("open");
          verticalControls.classList.remove("hidden");
          horizontalControls.classList.add("hidden");
          mainContent.classList.add("with-vertical-tabs");
          toggleBtn.innerHTML = '<i class="bx bx-sidebar text-lg rotate-180"></i>';
          toggleBtn.title = "Hide Vertical Tabs";
          if (verticalToggleBtn) {
            verticalToggleBtn.innerHTML = '<i class="bx bx-sidebar text-sm rotate-180"></i><span class="text-xs">Hide Vertical</span>';
          }
          
          // Attach event listeners for vertical tab controls
          setTimeout(attachVerticalTabListeners, 150);
        } else {
          verticalContainer.classList.remove("open");
          verticalControls.classList.add("hidden");
          horizontalControls.classList.remove("hidden");
          mainContent.classList.remove("with-vertical-tabs");
          toggleBtn.innerHTML = '<i class="bx bx-sidebar text-lg"></i>';
          toggleBtn.title = "Show Vertical Tabs";
          if (verticalToggleBtn) {
            verticalToggleBtn.innerHTML = '<i class="bx bx-sidebar text-sm"></i><span class="text-xs">Show Vertical</span>';
          }
        }
        
        renderTabs();
        localStorage.setItem("vertical-tabs-mode", verticalTabsMode);
        
              // Notify all iframes about vertical tabs state change
      setTimeout(notifyIframesVerticalTabsState, 200);
      
      // Refresh current newtab to switch between regular and vertical layouts
      setTimeout(() => {
        const currentTab = tabs.find(t => t.id === activeTab);
        if (currentTab && currentTab.history[currentTab.pointer] === 'carbon://newtab') {
          console.log('ðŸ”„ Refreshing newtab to switch layout mode');
          renderTabContent(currentTab, true);
        }
      }, 300);
      }
      
      let tabBarHidden = localStorage.getItem("tab-bar-hidden") === "true";
      
      function toggleTabBarVisibility() {
        tabBarHidden = !tabBarHidden;
        const tabsBar = document.getElementById("tabs-bar");
        const toggleBtn = document.getElementById("hide-tab-bar-toggle");
        const verticalToggleBtn = document.getElementById("vertical-hide-tab-bar-toggle");
        
        if (tabBarHidden) {
          tabsBar.style.display = "none";
          toggleBtn.innerHTML = '<i class="bx bx-hide text-lg"></i>';
          toggleBtn.title = "Show Tab Bar";
          if (verticalToggleBtn) {
            verticalToggleBtn.innerHTML = '<i class="bx bx-hide text-sm"></i><span class="text-xs">Show Bar</span>';
            verticalToggleBtn.title = "Show Tab Bar";
          }
        } else {
          tabsBar.style.display = "";
          toggleBtn.innerHTML = '<i class="bx bx-show text-lg"></i>';
          toggleBtn.title = "Hide Tab Bar";
          if (verticalToggleBtn) {
            verticalToggleBtn.innerHTML = '<i class="bx bx-show text-sm"></i><span class="text-xs">Hide Bar</span>';
            verticalToggleBtn.title = "Hide Tab Bar";
          }
        }
        
        localStorage.setItem("tab-bar-hidden", tabBarHidden);
      }

      const addressInput = document.getElementById("address-bar-input");
      const suggestionBox = document.getElementById("suggestion-box");
      let suggestionActive = -1;
      let currentSuggestions = [];
      let suggestionFetchController = null;
      addressInput.addEventListener("input", async function (e) {
        const val = addressInput.value.trim();
        if (!val || val.startsWith("http")) {
          suggestionBox.classList.add("hidden");
          suggestionBox.innerHTML = "";
          currentSuggestions = [];
          suggestionActive = -1;
          return;
        }

        const apiUrl = `https://corsproxy.io/?url=${encodeURIComponent(`https://duckduckgo.com/ac/?q=${encodeURIComponent(val)}&type=list`)}`;
        if (suggestionFetchController) suggestionFetchController.abort();
        suggestionFetchController = new AbortController();
        try {
          const resp = await fetch(apiUrl, {
            signal: suggestionFetchController.signal,
          });
          if (!resp.ok) throw new Error();
          const data = await resp.json();
          let suggestionsData;
          if (data.contents) {
            if (typeof data.contents === "string") {
              suggestionsData = JSON.parse(data.contents);
            } else {
              suggestionsData = data.contents;
            }
          } else {
            suggestionsData = data;
          }
          currentSuggestions = (suggestionsData[1] || []).filter(Boolean);
          if (currentSuggestions.length === 0) {
            suggestionBox.classList.add("hidden");
            suggestionBox.innerHTML = "";
            suggestionActive = -1;
            return;
          }
          suggestionBox.innerHTML = currentSuggestions
            .map(
              (s, i) =>
                `<div class="suggestion-item${i === suggestionActive ? " active" : ""}" data-idx="${i}">${s.replace(/</g, "&lt;")}</div>`,
            )
            .join("");
          suggestionBox.classList.remove("hidden");
          suggestionActive = -1;
        } catch (err) {
          suggestionBox.classList.add("hidden");
          suggestionBox.innerHTML = "";
          currentSuggestions = [];
          suggestionActive = -1;
        }
      });
      addressInput.addEventListener("keydown", function (e) {
        if (
          !currentSuggestions.length ||
          suggestionBox.classList.contains("hidden")
        )
          return;
        if (e.key === "ArrowDown") {
          e.preventDefault();
          suggestionActive = (suggestionActive + 1) % currentSuggestions.length;
          updateSuggestionBoxActive();
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          suggestionActive =
            (suggestionActive - 1 + currentSuggestions.length) %
            currentSuggestions.length;
          updateSuggestionBoxActive();
        } else if (e.key === "Enter") {
          if (suggestionActive !== -1) {
            e.preventDefault();
            selectSuggestion(suggestionActive);
          }
          suggestionBox.classList.add("hidden");
        } else if (e.key === "Escape") {
          suggestionBox.classList.add("hidden");
          suggestionActive = -1;
        }
      });
      function updateSuggestionBoxActive() {
        Array.from(suggestionBox.children).forEach((el, i) => {
          if (i === suggestionActive) el.classList.add("active");
          else el.classList.remove("active");
        });
        if (suggestionActive !== -1) {
          const el = suggestionBox.children[suggestionActive];
          if (el) el.scrollIntoView({ block: "nearest" });
          addressInput.value = currentSuggestions[suggestionActive];
        }
      }
      function selectSuggestion(idx) {
        if (idx < 0 || idx >= currentSuggestions.length) return;
        addressInput.value = currentSuggestions[idx];
        suggestionBox.classList.add("hidden");
        suggestionActive = -1;
      }
      suggestionBox.addEventListener("mousedown", function (e) {
        const target = e.target.closest(".suggestion-item");
        if (target) {
          const idx = parseInt(target.dataset.idx);
          selectSuggestion(idx);
          setTimeout(() => {
            document
              .getElementById("address-bar-form")
              .dispatchEvent(new Event("submit"));
          }, 0);
        }
      });
      document.addEventListener("click", function (e) {
        if (!suggestionBox.contains(e.target) && e.target !== addressInput) {
          suggestionBox.classList.add("hidden");
          suggestionActive = -1;
        }
        if (!proxyDropdown.contains(e.target) && e.target !== proxyToggleBtn) {
          proxyDropdown.classList.add("hidden");
        }
        if (
          !searchEngineDropdown.contains(e.target) &&
          e.target !== searchEngineBtn
        ) {
          searchEngineDropdown.classList.add("hidden");
        }
      });

      document
        .getElementById("address-bar-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          suggestionBox.classList.add("hidden");
          suggestionActive = -1;
          const tab = getActiveTab();
          if (!tab) return;
          let url = addressInput.value.trim();
          if (!url) return;
          
          // Handle carbon:// protocol URLs
          if (url.startsWith("carbon://")) {
            updateTabHistory(tab, url);
            renderTabs();
            renderTabContent(tab);
            return;
          }
          
          updateTabHistory(tab, url);
          renderTabs();
          renderTabContent(tab);
        });
      document.getElementById("back-btn").onclick = function () {
        const tab = getActiveTab();
        if (!tab || tab.pointer <= 0) return;
        tab.pointer--;
        updateAddressBar(tab);
        renderTabContent(tab);
      };
      document.getElementById("forward-btn").onclick = function () {
        const tab = getActiveTab();
        if (!tab || tab.pointer >= tab.history.length - 1) return;
        tab.pointer++;
        updateAddressBar(tab);
        renderTabContent(tab);
      };
      document.getElementById("refresh-btn").onclick = function () {
        const tab = getActiveTab();
        if (!tab) return;
        const iframe = document.getElementById(`iframe-${tab.id}`);
        if (iframe) {
          iframe.contentWindow.location.reload();
        }
      };
      function takeTabsSnapshot() {
        const snapshot = {
          tabs: tabs.map(tab => ({
            id: tab.id,
            url: tab.history[tab.pointer] || 'carbon://newtab',
            title: tab.title || 'New Tab',
            customTitle: tab.customTitle || null,
            history: tab.history || [],
            pointer: tab.pointer || 0,
            groupId: tab.groupId || null,
            pinned: tab.pinned || false,
            locked: tab.locked || false,
            color: tab.color || null,
            notes: tab.notes || null,
            timestamp: Date.now()
          })),
          tabGroups: tabGroups.map(group => ({
            id: group.id,
            name: group.name,
            color: group.color
          })),
          activeTabId: activeTab,
          verticalTabsMode: verticalTabsMode,
          tabBarHidden: tabBarHidden,
          timestamp: Date.now(),
          sessionId: Date.now() + Math.random().toString(36).substr(2, 9)
        };
        
        // Store in legacy format for backward compatibility
        closedTabsSnapshot = JSON.parse(JSON.stringify(tabs));
        localStorage.setItem("last-tabs", JSON.stringify(closedTabsSnapshot));
        
        // Store enhanced snapshot
        const snapshots = JSON.parse(localStorage.getItem('carbon-tab-snapshots') || '[]');
        snapshots.unshift(snapshot);
        if (snapshots.length > 20) snapshots.pop(); // Keep more snapshots
        localStorage.setItem('carbon-tab-snapshots', JSON.stringify(snapshots));
        
        // Also sync to Firebase if user is authenticated
        if (currentUser) {
          syncAllDataToFirebase();
        }
      }
      
      function restoreTabsFromSnapshot() {
        // Try enhanced snapshots first
        const snapshots = JSON.parse(localStorage.getItem('carbon-tab-snapshots') || '[]');
        if (snapshots.length > 0) {
          const snapshot = snapshots.shift();
          localStorage.setItem('carbon-tab-snapshots', JSON.stringify(snapshots));
          
          // Close all current tabs
          tabs.forEach(tab => {
            const iframe = document.getElementById(`iframe-${tab.id}`);
            if (iframe) iframe.remove();
          });
          
          // Restore tabs from snapshot with full data
          tabs = snapshot.tabs.map(tabData => ({
            id: tabData.id,
            url: tabData.url,
            title: tabData.title,
            customTitle: tabData.customTitle,
            history: tabData.history || [tabData.url],
            pointer: tabData.pointer || 0,
            groupId: tabData.groupId,
            pinned: tabData.pinned || false,
            locked: tabData.locked || false,
            color: tabData.color,
            notes: tabData.notes
          }));
          
          // Restore tab groups
          if (snapshot.tabGroups) {
            tabGroups = snapshot.tabGroups.map(groupData => ({
              id: groupData.id,
              name: groupData.name,
              color: groupData.color
            }));
            saveTabGroups();
          }
          
          // Restore UI state
          activeTab = snapshot.activeTabId;
          if (snapshot.verticalTabsMode !== undefined) {
            verticalTabsMode = snapshot.verticalTabsMode;
            localStorage.setItem("vertical-tabs-mode", verticalTabsMode);
          }
          if (snapshot.tabBarHidden !== undefined) {
            tabBarHidden = snapshot.tabBarHidden;
            localStorage.setItem("tab-bar-hidden", tabBarHidden);
          }
          
          renderTabs();
          saveTabsData();
          
          alert(`Tabs restored from snapshot (${new Date(snapshot.timestamp).toLocaleString()}).`);
          return;
        }
        
        // Fall back to legacy snapshot format
        let fromLS = localStorage.getItem("last-tabs");
        let snapshot = closedTabsSnapshot.length
          ? closedTabsSnapshot
          : fromLS
            ? JSON.parse(fromLS)
            : [];
        if (!snapshot.length) return;
        
        tabs = snapshot.map((tab) => ({
          ...tab,
          id: "tab-" + tabIdCounter++,
          pinned: tab.pinned || false,
        }));
        activeTab = tabs.length ? tabs[0].id : null;
        renderTabs();
        setActiveTab(activeTab);
        closedTabsSnapshot = [];
        localStorage.removeItem("last-tabs");
      }
      
      // Enhanced restore function for Firebase data
      async function restoreTabsFromFirebase() {
        if (!currentUser) {
          alert('Please sign in to restore tabs from cloud.');
          return;
        }
        
        try {
          await restoreAllDataFromFirebase();
          alert('Tabs and settings restored from cloud successfully!');
        } catch (error) {
          console.error('Error restoring from Firebase:', error);
          alert('Failed to restore from cloud. Please try again.');
        }
      }
      
      // Function to show restore options
      function showRestoreOptions() {
        const localSnapshots = JSON.parse(localStorage.getItem('carbon-tab-snapshots') || '[]');
        const hasFirebaseData = currentUser !== null;
        
        let message = 'Choose restore option:\n\n';
        
        if (localSnapshots.length > 0) {
          message += `1. Restore from local snapshot (${localSnapshots.length} available)\n`;
          message += `   Latest: ${new Date(localSnapshots[0].timestamp).toLocaleString()}\n\n`;
        }
        
        if (hasFirebaseData) {
          message += '2. Restore from cloud backup\n\n';
        }
        
        if (localSnapshots.length === 0 && !hasFirebaseData) {
          alert('No snapshots or cloud backup available to restore.');
          return;
        }
        
        const choice = prompt(message + 'Enter your choice (1 or 2):');
        
        if (choice === '1' && localSnapshots.length > 0) {
          restoreTabsFromSnapshot();
        } else if (choice === '2' && hasFirebaseData) {
          restoreTabsFromFirebase();
        } else {
          alert('Invalid choice or option not available.');
        }
      }
      const menuBtn = document.getElementById("menu-btn");
      const dropdown = document.getElementById("dropdown-menu");
      menuBtn.onclick = (e) => {
        dropdown.classList.toggle("hidden");
        e.stopPropagation();
      };
      window.onclick = (e) => {
        if (!dropdown.contains(e.target) && e.target !== menuBtn)
          dropdown.classList.add("hidden");
      };
      document.getElementById("clear-history-btn").onclick = function () {
        const tab = getActiveTab();
        if (!tab) return;
        tab.history = [];
        tab.pointer = -1;
        tab.url = "New Tab";
        tab.title = "New Tab";
        updateAddressBar(tab);
        renderTabContent(tab);
        dropdown.classList.add("hidden");
      };
      document.getElementById("close-all-tabs-btn").onclick = function () {
        if (tabs.length > 0) takeTabsSnapshot();
        const iframeContainer = document.getElementById("iframe-container");
        Array.from(iframeContainer.children).forEach(child => {
            if (child.tagName === 'IFRAME') {
                child.remove();
            }
        });
        // Always keep at least one tab open
        tabs = [];
        activeTab = null;
        addTab("carbon://newtab"); // This will create a new tab with newtab
        dropdown.classList.add("hidden");
      };
      document.getElementById("restore-tabs-btn").onclick = function () {
        showRestoreOptions();
        dropdown.classList.add("hidden");
      };
      
      document.getElementById("global-history-btn").onclick = function () {
        const tab = getActiveTab();
        if (tab) {
          updateTabHistory(tab, "carbon://history");
          updateAddressBar(tab);
          renderTabs();
          renderTabContent(tab);
        }
        dropdown.classList.add("hidden");
      };
      
      document.getElementById("unpin-all-tabs-btn").onclick = function () {
        tabs.forEach(tab => tab.pinned = false);
        renderTabs();
        dropdown.classList.add("hidden");
      };

      // Carbon Pages navigation
      document.getElementById("carbon-account-btn").onclick = function () {
        const tab = getActiveTab();
        if (tab) {
          updateTabHistory(tab, "carbon://account");
          updateAddressBar(tab);
          renderTabs();
          renderTabContent(tab);
        }
        dropdown.classList.add("hidden");
      };

      document.getElementById("carbon-settings-btn").onclick = function () {
        const tab = getActiveTab();
        if (tab) {
          updateTabHistory(tab, "carbon://settings");
          updateAddressBar(tab);
          renderTabs();
          renderTabContent(tab);
        }
        dropdown.classList.add("hidden");
      };

      document.getElementById("carbon-games-btn").onclick = function () {
        const tab = getActiveTab();
        if (tab) {
          updateTabHistory(tab, "carbon://games");
          updateAddressBar(tab);
          renderTabs();
          renderTabContent(tab);
        }
        dropdown.classList.add("hidden");
      };

      document.getElementById("carbon-ai-btn").onclick = function () {
        const tab = getActiveTab();
        if (tab) {
          updateTabHistory(tab, "carbon://ai");
          updateAddressBar(tab);
          renderTabs();
          renderTabContent(tab);
        }
        dropdown.classList.add("hidden");
      };
      
      document.getElementById("carbon-vm-btn").onclick = function () {
        const tab = getActiveTab();
        if (tab) {
          updateTabHistory(tab, "carbon://vm");
          updateAddressBar(tab);
          renderTabs();
          renderTabContent(tab);
        }
        dropdown.classList.add("hidden");
      };
      
      // Enhanced tab management event listeners
      document.getElementById("close-other-tabs-btn").onclick = function () {
        if (activeTab) {
          closeOtherTabs(activeTab);
        }
        dropdown.classList.add("hidden");
      };
      
      document.getElementById("reload-all-tabs-btn").onclick = function () {
        reloadAllTabs();
        dropdown.classList.add("hidden");
      };
      
      document.getElementById("duplicate-active-tab-btn").onclick = function () {
        if (activeTab) {
          duplicateTab(activeTab);
        }
        dropdown.classList.add("hidden");
      };
      
      // Tab context menu event listeners
      document.getElementById("close-tab-context-menu").onclick = closeTabContextMenu;
      document.getElementById("tab-context-menu-bg").onclick = function(e) {
        if (e.target === this) closeTabContextMenu();
      };
      
      // Tab rename functionality
      document.getElementById("tab-rename-input").addEventListener("input", function() {
        if (currentContextTabId) {
          renameTab(currentContextTabId, this.value);
        }
      });
      
      // Tab notes functionality
      document.getElementById("tab-notes-input").addEventListener("input", function() {
        if (currentContextTabId) {
          updateTabNotes(currentContextTabId, this.value);
        }
      });
      
      // Tab group functionality
      document.getElementById("tab-group-select").addEventListener("change", function() {
        if (currentContextTabId) {
          assignTabToGroup(currentContextTabId, this.value);
        }
      });
      
      document.getElementById("create-group-btn").addEventListener("click", function() {
        const name = prompt("Enter group name:");
        if (name && name.trim()) {
          const group = createTabGroup(name, "#3b82f6");
          updateGroupSelect();
          if (currentContextTabId) {
            document.getElementById("tab-group-select").value = group.id;
            assignTabToGroup(currentContextTabId, group.id);
          }
        }
      });
      
      // Color picker functionality
      document.querySelectorAll(".tab-color-btn").forEach(btn => {
        btn.addEventListener("click", function() {
          const color = this.dataset.color;
          if (currentContextTabId) {
            setTabColor(currentContextTabId, color);
          }
          
                  // Update visual selection
        document.querySelectorAll(".tab-color-btn").forEach(b => b.classList.remove("border-overlay"));
        this.classList.add("border-overlay");
        });
      });
      
      // Toggle buttons
      document.getElementById("tab-lock-toggle").onclick = function() {
        if (currentContextTabId) {
          toggleTabLock(currentContextTabId);
          openTabContextMenu(currentContextTabId); // Refresh button state
        }
      };
      
      document.getElementById("tab-pin-toggle").onclick = function() {
        if (currentContextTabId) {
          togglePinTab(currentContextTabId);
          openTabContextMenu(currentContextTabId); // Refresh button state
        }
      };
      
      // Action buttons
      document.getElementById("tab-duplicate-btn").onclick = function() {
        if (currentContextTabId) {
          duplicateTab(currentContextTabId);
          closeTabContextMenu();
        }
      };
      
      document.getElementById("tab-close-btn").onclick = function() {
        if (currentContextTabId) {
          removeTab(currentContextTabId);
          closeTabContextMenu();
        }
      };
      
      // Tab Groups Modal event listeners
      document.getElementById("close-tab-groups-modal").onclick = closeTabGroupsModal;
      document.getElementById("tab-groups-modal-bg").onclick = function(e) {
        if (e.target === this) closeTabGroupsModal();
      };
      
      document.getElementById("create-new-group-btn").onclick = function() {
        const name = document.getElementById("new-group-name").value.trim();
        const color = document.getElementById("new-group-color").value;
        
        if (name) {
          createTabGroup(name, color);
          document.getElementById("new-group-name").value = "";
          renderGroupsList();
        }
      };
      document
        .getElementById("new-tab-btn")
        .addEventListener("click", () => addTab());
      
      document
        .getElementById("hide-tab-bar-toggle")
        .addEventListener("click", toggleTabBarVisibility);
        
      document
        .getElementById("tab-groups-toggle")
        .addEventListener("click", openTabGroupsModal);
        
      document
        .getElementById("tabs-layout-toggle")
        .addEventListener("click", toggleVerticalTabs);

      // Add event listeners for vertical tab controls
      function attachVerticalTabListeners() {
        const verticalNewTabBtn = document.getElementById("vertical-new-tab-btn");
        const verticalHideTabBarToggle = document.getElementById("vertical-hide-tab-bar-toggle");
        const verticalTabGroupsToggle = document.getElementById("vertical-tab-groups-toggle");
        const verticalTabsLayoutToggle = document.getElementById("vertical-tabs-layout-toggle");
        
        if (verticalNewTabBtn && !verticalNewTabBtn.hasAttribute('data-listener-attached')) {
          verticalNewTabBtn.addEventListener("click", () => addTab("carbon://newtab"));
          verticalNewTabBtn.setAttribute('data-listener-attached', 'true');
        }
        
        if (verticalHideTabBarToggle && !verticalHideTabBarToggle.hasAttribute('data-listener-attached')) {
          verticalHideTabBarToggle.addEventListener("click", toggleTabBarVisibility);
          verticalHideTabBarToggle.setAttribute('data-listener-attached', 'true');
        }
        
        if (verticalTabGroupsToggle && !verticalTabGroupsToggle.hasAttribute('data-listener-attached')) {
          verticalTabGroupsToggle.addEventListener("click", openTabGroupsModal);
          verticalTabGroupsToggle.setAttribute('data-listener-attached', 'true');
        }
        
        if (verticalTabsLayoutToggle && !verticalTabsLayoutToggle.hasAttribute('data-listener-attached')) {
          verticalTabsLayoutToggle.addEventListener("click", toggleVerticalTabs);
          verticalTabsLayoutToggle.setAttribute('data-listener-attached', 'true');
        }
      }
      
      function notifyIframesVerticalTabsState() {
        // Send vertical tabs state to all iframes
        const iframes = document.querySelectorAll('#iframe-container iframe');
        iframes.forEach(iframe => {
          try {
            iframe.contentWindow.postMessage({
              type: 'carbon-vertical-tabs-state',
              enabled: verticalTabsMode
            }, '*');
          } catch (e) {
            // Ignore cross-origin errors
          }
        });
      }

      const historyBtn = document.getElementById("history-btn");
      const historyModalBg = document.getElementById("history-modal-bg");
      const historyModal = document.getElementById("history-modal");
      const modalHistoryList = document.getElementById("modal-history-list");
      const closeHistoryModalBtn = document.getElementById(
        "close-history-modal",
      );
      historyBtn.onclick = (e) => {
        renderModalHistoryList();
        openHistoryModal();
        e.stopPropagation();
      };
      closeHistoryModalBtn.onclick = closeHistoryModal;
      historyModalBg.onclick = function (e) {
        if (e.target === historyModalBg) closeHistoryModal();
      };
      function openHistoryModal() {
        historyModalBg.classList.remove("pointer-events-none", "opacity-0");
        historyModalBg.classList.add("pointer-events-auto", "opacity-100");
        historyModal.classList.remove("scale-95", "opacity-0");
        historyModal.classList.add("scale-100", "opacity-100");
      }
      function closeHistoryModal() {
        historyModalBg.classList.add("pointer-events-none", "opacity-0");
        historyModalBg.classList.remove("pointer-events-auto", "opacity-100");
        historyModal.classList.add("scale-95", "opacity-0");
        historyModal.classList.remove("scale-100", "opacity-100");
      }
      function renderModalHistoryList() {
        const tab = getActiveTab();
        modalHistoryList.innerHTML = "";
        if (!tab || !tab.history.length) {
          modalHistoryList.innerHTML =
            "<div class='text-subtle italic text-center py-4'>No history for this tab.</div>";
          return;
        }
        tab.history.forEach((url, idx) => {
          const row = document.createElement("div");
          row.className = `flex items-center justify-between p-3 rounded-lg hover:bg-highlight-med cursor-pointer transition-colors ${idx === tab.pointer ? "bg-foam/20 border border-foam" : ""}`;
          row.innerHTML = `<span class="flex-1 ${idx === tab.pointer ? "text-foam font-bold" : ""} truncate">${url}</span>`;
          row.onclick = () => {
            tab.pointer = idx;
            updateAddressBar(tab);
            renderTabContent(tab);
            closeHistoryModal();
          };
          if (tab.history.length > 1) {
            const rmBtn = document.createElement("button");
            rmBtn.className = "ml-2 text-subtle hover:text-love";
            rmBtn.title = "Remove from history";
            rmBtn.textContent = "âœ•";
            rmBtn.onclick = (e) => {
              e.stopPropagation();
              tab.history.splice(idx, 1);
              if (tab.pointer >= tab.history.length)
                tab.pointer = tab.history.length - 1;
              renderModalHistoryList();
            };
            row.appendChild(rmBtn);
          }
          modalHistoryList.appendChild(row);
        });
      }

      // -- Message Listener for iframe communication --
      window.addEventListener("message", function(event) {
        if (event.data && event.data.type === 'carbon-navigate') {
          const tab = getActiveTab();
          if (tab) {
            const url = event.data.url;
            updateTabHistory(tab, url);
            renderTabs();
            renderTabContent(tab);
          }
        } else if (event.data && event.data.type === 'carbon-proxy-sync') {
          // Sync proxy state from newtab iframe
          const proxy = event.data.proxy;
          setCurrentProxy(proxy);
          setProxy(proxy);
        } else if (event.data && event.data.type === 'carbon-search-engine-sync') {
          // Sync search engine state from newtab iframe
          const searchEngine = event.data.searchEngine;
          setCurrentSearchEngine(searchEngine);
        } else if (event.data && event.data.type === 'carbon-request-vertical-tabs-state') {
          // Send current vertical tabs state to requesting iframe
          event.source.postMessage({
            type: 'carbon-vertical-tabs-state',
            enabled: verticalTabsMode
          }, '*');
        } else if (event.data && event.data.type === 'carbon-navigate') {
          // Handle navigation requests from vertical-newtab.html
          if (event.data.url) {
            addTab(event.data.url);
          }
        }
      });

      // -- Keyboard Shortcuts --
      document.addEventListener("keydown", (e) => {
        // PANIC KEY - Check this FIRST before any other shortcuts
        if (panicKey && panicKey.trim() !== '') {
          console.log('ðŸ”‘ Key pressed:', e.key.toLowerCase(), 'Panic key set to:', panicKey);
          if (e.key.toLowerCase() === panicKey.toLowerCase()) {
            const panicUrl = localStorage.getItem('carbon-panic-url') || 'https://classroom.google.com';
            console.log('ðŸš¨ðŸš¨ðŸš¨ PANIC KEY TRIGGERED! ðŸš¨ðŸš¨ðŸš¨');
            console.log('Redirecting to:', panicUrl);
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            // Alert to confirm it's working (remove in production)
            alert('PANIC KEY ACTIVATED! Redirecting to: ' + panicUrl);
            
            // Immediately redirect the entire window
            try {
              window.top.location.href = panicUrl;
            } catch (error) {
              console.log('Top location failed, using window.location');
              window.location.href = panicUrl;
            }
            return false;
          }
        } else {
          // Only log occasionally to avoid spam
          if (Math.random() < 0.01) {
            console.log('âš ï¸ Panic key not set or empty. Current value:', panicKey);
          }
        }
        
        // Dev tools prevention
        if (localStorage.getItem('carbon-disable-devtools') === 'true') {
          if (e.key === 'F12' || 
              (e.ctrlKey && e.shiftKey && e.key === 'I') || 
              (e.ctrlKey && e.shiftKey && e.key === 'J') || 
              (e.ctrlKey && e.key === 'U')) {
            e.preventDefault();
            return false;
          }
        }
        
        // Regular keyboard shortcuts
        if (
          (e.ctrlKey || e.metaKey) &&
          !e.shiftKey &&
          e.key.toLowerCase() === "t"
        ) {
          e.preventDefault();
          addTab();
        }
        if (
          (e.ctrlKey || e.metaKey) &&
          !e.shiftKey &&
          e.key.toLowerCase() === "w"
        ) {
          e.preventDefault();
          if (activeTab) removeTab(activeTab);
        }
        if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key === "Tab") {
          e.preventDefault();
          const idx = tabs.findIndex((t) => t.id === activeTab);
          if (tabs.length > 1 && idx !== -1)
            setActiveTab(tabs[(idx + 1) % tabs.length].id);
        }
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "Tab") {
          e.preventDefault();
          const idx = tabs.findIndex((t) => t.id === activeTab);
          if (tabs.length > 1 && idx !== -1)
            setActiveTab(tabs[(idx - 1 + tabs.length) % tabs.length].id);
        }
        if (e.altKey && !e.shiftKey && e.key === "ArrowLeft")
          document.getElementById("back-btn").click();
        if (e.altKey && !e.shiftKey && e.key === "ArrowRight")
          document.getElementById("forward-btn").click();
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === "e") {
          e.preventDefault();
          toggleVerticalTabs();
        }
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === "p") {
          e.preventDefault();
          if (activeTab) togglePinTab(activeTab);
        }
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === "d") {
          e.preventDefault();
          if (activeTab) duplicateTab(activeTab);
        }
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === "l") {
          e.preventDefault();
          if (activeTab) toggleTabLock(activeTab);
        }
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === "o") {
          e.preventDefault();
          if (activeTab) closeOtherTabs(activeTab);
        }
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === "r") {
          e.preventDefault();
          reloadAllTabs();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          e.preventDefault();
          if (activeTab) openTabContextMenu(activeTab);
        }
      });

      // Firebase configuration and settings sync
      const firebaseConfig = {
        apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
        authDomain: "carbon-services.firebaseapp.com",
        projectId: "carbon-services",
        storageBucket: "carbon-services.firebasestorage.app",
        messagingSenderId: "288385472070",
        appId: "1:288385472070:web:c4be3ff186e248fc645c47",
        measurementId: "G-Y2K1RQYE74"
      };
      
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      
      let currentUser = null;
      let panicKey = null;
      let tabCloakingEnabled = false;
      let cloakTitle = '';
      let cloakFavicon = '';
      
      // Settings sync from Firebase
      async function loadSettingsFromFirebase() {
        if (!currentUser) return;
        
        try {
          const userSettingsDoc = await db.collection('users').doc(currentUser.uid).get();
          if (userSettingsDoc.exists) {
            const userData = userSettingsDoc.data();
            const settings = userData.settings || {};
            
                         // Load panic key and URL
             panicKey = settings.panicKey || null;
             if (settings.panicUrl) {
               localStorage.setItem('carbon-panic-url', settings.panicUrl);
             }
             
             // Load tab cloaking settings
             tabCloakingEnabled = settings.cloakingEnabled || false;
             cloakTitle = settings.cloakTitle || '';
             cloakFavicon = settings.cloakFavicon || '';
             
             // Load theme settings
             if (settings.theme) {
               localStorage.setItem('carbon-theme-global', settings.theme);
             }
             if (settings.customThemes && window.carbonTheme) {
               window.carbonTheme.customThemes = settings.customThemes;
               window.carbonTheme.saveCustomThemes();
             }
             if (settings.background) {
               localStorage.setItem('carbon-background-global', settings.background);
             }
             if (settings.customBackground) {
               localStorage.setItem('carbon-custom-bg-global', settings.customBackground);
             }
             
             console.log('Settings loaded from Firebase:', {
               panicKey: panicKey,
               panicUrl: settings.panicUrl,
               cloakingEnabled: tabCloakingEnabled,
               cloakTitle: cloakTitle,
               theme: settings.theme,
               background: settings.background
             });
            
            // Apply settings
            applyAllSettings();
          }
        } catch (error) {
          console.error('Error loading settings from Firebase:', error);
        }
      }
      
      // Load settings from localStorage (fallback)
      function loadLocalSettings() {
        // Debug: Log all localStorage values
        console.log('ðŸ” Debugging localStorage values:');
        console.log('carbon-panic-key:', localStorage.getItem('carbon-panic-key'));
        console.log('carbon-cloak-enabled:', localStorage.getItem('carbon-cloak-enabled'));
        console.log('carbon-cloak-title:', localStorage.getItem('carbon-cloak-title'));
        console.log('carbon-cloak-favicon:', localStorage.getItem('carbon-cloak-favicon'));
        
        panicKey = localStorage.getItem('carbon-panic-key') || null;
        tabCloakingEnabled = localStorage.getItem('carbon-cloak-enabled') === 'true';
        cloakTitle = localStorage.getItem('carbon-cloak-title') || '';
        cloakFavicon = localStorage.getItem('carbon-cloak-favicon') || '';
        
        console.log('ðŸ“š Settings loaded from localStorage:', {
          panicKey: panicKey,
          cloakingEnabled: tabCloakingEnabled,
          cloakTitle: cloakTitle,
          cloakFavicon: cloakFavicon
        });
        
        applyAllSettings();
      }
      
      // Apply all settings
      function applyAllSettings() {
        console.log('ðŸ”§ Applying all settings...');
        applyTabCloaking();
        applyTeacherPrevention();
        applyClosePrevention();
        applyThemeSettings();
        // Trigger Firebase sync when settings are applied
        triggerSettingsSync();
      }
      
      // Apply theme settings
      function applyThemeSettings() {
        // Apply current theme if carbon theme system is available
        if (window.carbonTheme) {
          const currentTheme = localStorage.getItem('carbon-theme-global') || 'rose-pine';
          console.log('ðŸŽ¨ Applying theme:', currentTheme);
          window.carbonTheme.applyTheme(currentTheme);
          
          // Update Tailwind config with current theme colors
          const themeData = window.carbonTheme.getTheme(currentTheme);
          if (themeData && typeof updateTailwindConfig === 'function') {
            updateTailwindConfig(themeData);
          }
        } else {
          console.log('âš ï¸ Carbon theme system not yet available, retrying...');
          // Retry after a short delay if theme system isn't ready
          setTimeout(applyThemeSettings, 100);
        }
      }
      
      // Manual reload function for debugging
      window.reloadSettings = function() {
        console.log('ðŸ”„ Manually reloading settings...');
        loadLocalSettings();
        if (currentUser) {
          loadSettingsFromFirebase();
        }
      };
      
      // Debug functions for testing
      window.testPanicKey = function() {
        console.log('ðŸ§ª Testing panic key. Current panic key:', panicKey);
        console.log('ðŸ’¾ localStorage panic key:', localStorage.getItem('carbon-panic-key'));
        if (panicKey) {
          console.log('âœ… Panic key is set. Try pressing:', panicKey);
        } else {
          console.log('âŒ No panic key set. Set one in settings first.');
        }
      };
      
      window.testTabCloaking = function() {
        console.log('ðŸ§ª Testing tab cloaking:');
        console.log('Enabled:', tabCloakingEnabled);
        console.log('Title:', cloakTitle);
        console.log('Favicon:', cloakFavicon);
        console.log('Current document title:', document.title);
        if (tabCloakingEnabled && cloakTitle) {
          console.log('âœ… Tab cloaking should be active');
        } else {
          console.log('âŒ Tab cloaking not active. Enable in settings first.');
        }
      };
      
      // Manual trigger for testing
      window.manualTabCloak = function(title, favicon) {
        console.log('ðŸŽ­ Manually triggering tab cloaking...');
        tabCloakingEnabled = true;
        cloakTitle = title || 'Google Classroom';
        cloakFavicon = favicon || 'https://ssl.gstatic.com/classroom/favicon.png';
        
        localStorage.setItem('carbon-cloak-enabled', 'true');
        localStorage.setItem('carbon-cloak-title', cloakTitle);
        localStorage.setItem('carbon-cloak-favicon', cloakFavicon);
        
        applyTabCloaking();
        console.log('âœ… Manual tab cloaking applied');
      };
      
      // Theme testing functions
      window.testThemeSystem = function() {
        console.log('ðŸ§ª Testing theme system:');
        console.log('Theme system available:', !!window.carbonTheme);
        if (window.carbonTheme) {
          console.log('Current theme:', window.carbonTheme.getCurrentTheme());
          console.log('Available themes:', Object.keys(window.carbonTheme.getAllThemes()));
          console.log('Custom themes:', Object.keys(window.carbonTheme.customThemes));
        }
        console.log('Saved theme in localStorage:', localStorage.getItem('carbon-theme-global'));
      };
      
      window.manualThemeChange = function(themeName) {
        console.log('ðŸŽ¨ Manually changing theme to:', themeName);
        if (window.carbonTheme) {
          window.carbonTheme.applyTheme(themeName);
          console.log('âœ… Theme applied successfully');
        } else {
          console.log('âŒ Theme system not available');
        }
      };
      
      // Check settings every 5 seconds to ensure they're loaded
      setInterval(() => {
        if (!panicKey && !tabCloakingEnabled) {
          const storedPanicKey = localStorage.getItem('carbon-panic-key');
          const storedCloaking = localStorage.getItem('carbon-cloak-enabled');
          if (storedPanicKey || storedCloaking === 'true') {
            console.log('ðŸ”„ Settings found in localStorage but not loaded. Reloading...');
            loadLocalSettings();
          }
        }
      }, 5000);
      
      // Tab cloaking functionality
      function applyTabCloaking() {
        console.log('ðŸŽ­ Applying tab cloaking with values:', {
          enabled: tabCloakingEnabled,
          enabledType: typeof tabCloakingEnabled,
          title: cloakTitle,
          titleType: typeof cloakTitle,
          titleLength: cloakTitle ? cloakTitle.length : 0,
          favicon: cloakFavicon,
          faviconType: typeof cloakFavicon
        });
        
        // More robust checking
        const isEnabled = (tabCloakingEnabled === true || tabCloakingEnabled === 'true');
        const hasTitle = cloakTitle && cloakTitle.trim() !== '';
        
        console.log('ðŸ” Cloaking checks:', {
          isEnabled: isEnabled,
          hasTitle: hasTitle,
          willApplyCloak: isEnabled && hasTitle
        });
        
        if (isEnabled && hasTitle) {
          // Change the document title immediately
          const newTitle = cloakTitle.trim();
          document.title = newTitle;
          console.log('âœ… Document title changed from CARBON to:', document.title);
          
          if (cloakFavicon && cloakFavicon.trim() !== '') {
            // Remove existing favicon links
            const existingLinks = document.querySelectorAll("link[rel*='icon']");
            console.log('ðŸ—‘ï¸ Removing', existingLinks.length, 'existing favicon links');
            existingLinks.forEach(link => {
              console.log('ðŸ—‘ï¸ Removing favicon:', link.href);
              link.remove();
            });
            
            // Add new favicon with multiple formats for better compatibility
            const timestamp = new Date().getTime();
            const faviconUrl = cloakFavicon.trim();
            
            // Primary favicon
            const link = document.createElement('link');
            link.type = 'image/x-icon';
            link.rel = 'shortcut icon';
            link.href = faviconUrl + '?v=' + timestamp;
            document.head.appendChild(link);
            
            // Standard icon
            const iconLink = document.createElement('link');
            iconLink.rel = 'icon';
            iconLink.type = 'image/x-icon';
            iconLink.href = faviconUrl + '?v=' + timestamp;
            document.head.appendChild(iconLink);
            
            // Apple touch icon for mobile
            const appleLink = document.createElement('link');
            appleLink.rel = 'apple-touch-icon';
            appleLink.href = faviconUrl + '?v=' + timestamp;
            document.head.appendChild(appleLink);
            
            console.log('âœ… Added new favicon links for:', faviconUrl);
          } else {
            console.log('âš ï¸ No favicon URL provided or empty');
          }
        } else {
          console.log('âŒ Tab cloaking not applied - Enabled:', isEnabled, 'Has title:', hasTitle);
          document.title = 'CARBON';
          // Reset to default favicon if not cloaking
          const existingLinks = document.querySelectorAll("link[rel*='icon']");
          existingLinks.forEach(link => link.remove());
        }
      }
      
      // Teacher prevention (same as settings.html)
      function applyTeacherPrevention() {
        // Disable right-click
        if (localStorage.getItem('carbon-disable-right-click') === 'true') {
          document.addEventListener('contextmenu', e => e.preventDefault());
        }
        
        // Disable text selection
        if (localStorage.getItem('carbon-disable-select') === 'true') {
          document.body.style.userSelect = 'none';
          document.body.style.webkitUserSelect = 'none';
          document.body.style.mozUserSelect = 'none';
        }
        
        // Hide cursor when idle
        if (localStorage.getItem('carbon-hide-cursor') === 'true') {
          let cursorTimer;
          document.addEventListener('mousemove', () => {
            document.body.style.cursor = 'default';
            clearTimeout(cursorTimer);
            cursorTimer = setTimeout(() => {
              document.body.style.cursor = 'none';
            }, 3000);
          });
        }
        
        // Blur on unfocus
        if (localStorage.getItem('carbon-blur-unfocus') === 'true') {
          window.addEventListener('blur', () => {
            document.body.style.filter = 'blur(10px)';
          });
          window.addEventListener('focus', () => {
            document.body.style.filter = 'none';
          });
        }
      }
      
      // Close prevention
      function applyClosePrevention() {
        const enabled = localStorage.getItem('carbon-close-prevention') === 'true';
        const confirm = localStorage.getItem('carbon-confirm-close') === 'true';
        const message = localStorage.getItem('carbon-close-message') || 'Are you sure you want to close Carbon?';
        
        if (enabled) {
          window.addEventListener('beforeunload', (e) => {
            if (confirm) {
              e.preventDefault();
              e.returnValue = message;
              return message;
            }
          });
        }
      }
      
      // Clean up game rooms when page unloads
      window.addEventListener('beforeunload', () => {
        if (currentGameRoom && currentUser) {
          // Try to clean up the room immediately
          db.collection('game-rooms').doc(currentGameRoom).get().then(doc => {
            if (doc.exists) {
              const gameRoom = doc.data();
              if (gameRoom.hostId === currentUser.uid && gameRoom.status === 'waiting') {
                // Delete waiting room
                db.collection('game-rooms').doc(currentGameRoom).delete();
              } else if (gameRoom.status === 'playing') {
                // Mark as completed with disconnection
                db.collection('game-rooms').doc(currentGameRoom).update({
                  status: 'completed',
                  winner: gameRoom.hostId === currentUser.uid ? 
                    (gameRoom.gameType === 'tictactoe' ? 'O' : 'blue') : 
                    (gameRoom.gameType === 'tictactoe' ? 'X' : 'red'),
                  disconnectedPlayer: currentUser.uid
                });
              }
            }
          }).catch(error => {
            console.error('Error cleaning up room on page unload:', error);
          });
        }
      });
      

      
      // Update user profile display
      function updateUserProfile(user) {
        const profileSection = document.getElementById('user-profile-section');
        const profilePic = document.getElementById('user-profile-pic');
        const displayName = document.getElementById('user-display-name');
        const email = document.getElementById('user-email');
        const profileMenuBtn = document.getElementById('profile-menu-btn');
        
        if (user) {
          // Show profile section
          profileSection.classList.remove('hidden');
          
          // Update profile picture with fallback
          const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=9ccfd8&color=191724&size=128`;
          profilePic.src = photoURL;
          profilePic.onerror = () => {
            profilePic.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email || 'User')}&background=9ccfd8&color=191724&size=128`;
          };
          
          // Update display name and email
          displayName.textContent = user.displayName || 'User';
          email.textContent = user.email || '';
          
          // Add profile menu click handler
          profileMenuBtn.onclick = () => {
            window.open('profile.html', '_blank');
          };
        } else {
          // Hide profile section when not signed in
          profileSection.classList.add('hidden');
        }
      }

      // Authentication state observer
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        updateUserProfile(user);
        
        if (user) {
          console.log('ðŸ‘¤ User signed in, loading all settings and data...');
          loadSettingsFromFirebase();
          loadShopDataFromFirebase(); // Load shop data from Firebase
          // Load themes from Firebase if theme system is available
          if (window.carbonTheme) {
            window.carbonTheme.loadThemesFromFirebase();
          }
          // Load frames from Firebase
          loadFramesFromFirebase();
          // Also restore browser data from Firebase
          setTimeout(() => {
            restoreAllDataFromFirebase();
          }, 1000);
        } else {
          console.log('ðŸ‘¤ User signed out, using local settings...');
          loadLocalSettings();
          loadShopDataFromLocalStorage(); // Load shop data from localStorage
        }
      });
      
      // Listen for settings changes from settings page
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'carbon-settings-updated') {
          console.log('ðŸ“¨ Received settings update - Full data:', JSON.stringify(event.data, null, 2));
          console.log('ðŸ“¨ Settings object:', JSON.stringify(event.data.settings, null, 2));
          
          const settings = event.data.settings;
          
          // Parse panic key
          panicKey = settings.panicKey || null;
          console.log('ðŸ”‘ Parsed panic key:', panicKey);
          
          if (settings.panicUrl) {
            localStorage.setItem('carbon-panic-url', settings.panicUrl);
            console.log('ðŸ”— Set panic URL:', settings.panicUrl);
          }
          
          // Parse tab cloaking - try multiple possible structures
          if (settings.cloaking) {
            // Handle both boolean and string values
            tabCloakingEnabled = (settings.cloaking.enabled === true || settings.cloaking.enabled === 'true');
            cloakTitle = (settings.cloaking.title || '').toString();
            cloakFavicon = (settings.cloaking.favicon || '').toString();
            
            // Also update localStorage to keep in sync
            localStorage.setItem('carbon-cloak-enabled', tabCloakingEnabled.toString());
            localStorage.setItem('carbon-cloak-title', cloakTitle);
            localStorage.setItem('carbon-cloak-favicon', cloakFavicon);
            
            console.log('ðŸŽ­ Parsed cloaking from settings.cloaking:', {
              enabled: tabCloakingEnabled,
              title: cloakTitle,
              favicon: cloakFavicon
            });
          } else if (settings.tabCloaking) {
            tabCloakingEnabled = settings.tabCloaking.enabled || false;
            cloakTitle = settings.tabCloaking.title || '';
            cloakFavicon = settings.tabCloaking.favicon || '';
            
            // Also update localStorage to keep in sync
            localStorage.setItem('carbon-cloak-enabled', tabCloakingEnabled);
            localStorage.setItem('carbon-cloak-title', cloakTitle);
            localStorage.setItem('carbon-cloak-favicon', cloakFavicon);
            
            console.log('ðŸŽ­ Parsed cloaking from settings.tabCloaking:', {
              enabled: tabCloakingEnabled,
              title: cloakTitle,
              favicon: cloakFavicon
            });
          } else {
            // Try direct properties
            tabCloakingEnabled = settings.cloakingEnabled || settings.enabled || false;
            cloakTitle = settings.cloakTitle || settings.title || '';
            cloakFavicon = settings.cloakFavicon || settings.favicon || '';
            
            // Also update localStorage to keep in sync
            localStorage.setItem('carbon-cloak-enabled', tabCloakingEnabled);
            localStorage.setItem('carbon-cloak-title', cloakTitle);
            localStorage.setItem('carbon-cloak-favicon', cloakFavicon);
            
            console.log('ðŸŽ­ Parsed cloaking from direct properties:', {
              enabled: tabCloakingEnabled,
              title: cloakTitle,
              favicon: cloakFavicon
            });
          }
          
          // Also update panic key in localStorage
          if (panicKey) {
            localStorage.setItem('carbon-panic-key', panicKey);
          }
          
          // Handle theme changes
          if (settings.theme && window.carbonTheme) {
            console.log('ðŸŽ¨ Applying theme from settings:', settings.theme);
            window.carbonTheme.applyTheme(settings.theme);
          }
          
          // Handle custom themes
          if (settings.customThemes && window.carbonTheme) {
            console.log('ðŸŽ¨ Loading custom themes from settings');
            window.carbonTheme.customThemes = settings.customThemes;
            window.carbonTheme.saveCustomThemes();
          }
          
          // Handle background settings
          if (settings.background) {
            localStorage.setItem('carbon-background-global', settings.background);
          }
          if (settings.customBackground) {
            localStorage.setItem('carbon-custom-bg-global', settings.customBackground);
          }
          
          console.log('âœ… Final parsed settings:', {
            panicKey: panicKey,
            tabCloakingEnabled: tabCloakingEnabled,
            cloakTitle: cloakTitle,
            cloakFavicon: cloakFavicon,
            theme: settings.theme,
            background: settings.background
          });
          
          applyAllSettings();
        } else if (event.data && event.data.type === 'carbon-settings-refresh') {
          console.log('Refreshing settings from Firebase/localStorage');
          // Reload settings when settings page saves
          if (currentUser) {
            loadSettingsFromFirebase();
          } else {
            loadLocalSettings();
          }
        }
      });
      

      
      // Auto-sync all data every 30 seconds if user is authenticated
      setInterval(() => {
        if (currentUser) {
          syncAllDataToFirebase();
        }
      }, 30000);
      
      // === CARBON SHOP SYSTEM ===
      let userCurrency = 0;
      let userFrames = [];
      let userPets = [];
      let userProfileFrames = [];
      let userPetData = {};
      let userBadges = [];
      let shopDataLoaded = false;
      
      const gameFrames = [
        { id: 'neon', name: 'Neon Glow', price: 500, color: '#00ffff', description: 'Electric neon border with pulsing glow effect' },
        { id: 'fire', name: 'Fire Frame', price: 750, color: '#ff4500', description: 'Animated fire border with ember particles' },
        { id: 'galaxy', name: 'Galaxy Portal', price: 1000, color: '#9400d3', description: 'Cosmic border with swirling stars' },
        { id: 'diamond', name: 'Diamond Elite', price: 1500, color: '#b9f2ff', description: 'Crystalline border with sparkle effects' },
        { id: 'rainbow', name: 'Rainbow Storm', price: 2000, color: 'linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #00ff00, #0080ff, #8000ff)', description: 'Animated rainbow border' },
        { id: 'shadow', name: 'Shadow Realm', price: 1200, color: '#2d1b69', description: 'Dark mystical border with shadow effects' }
      ];
      
      const lootBoxes = [
        {
          id: 'daily-mystery',
          name: 'Daily Mystery Box',
          price: 250,
          rarity: 'mystery',
          borderColor: '#f97316',
          gradient: 'linear-gradient(135deg, #f97316, #fb923c)',
          description: 'ðŸŽ² One per day! Random surprise item from any category',
          rewards: {
            random: true,
            currency: { min: 100, max: 500 },
            special: 25
          },
          isDaily: true
        },
        {
          id: 'basic',
          name: 'Basic Crate',
          price: 200,
          rarity: 'common',
          borderColor: '#6b7280',
          gradient: 'linear-gradient(135deg, #6b7280, #9ca3af)',
          description: 'A simple crate with basic rewards',
          rewards: {
            frames: 0,
            currency: { min: 50, max: 150 },
            special: 5
          }
        },
        {
          id: 'advanced',
          name: 'Advanced Box',
          price: 500,
          rarity: 'rare',
          borderColor: '#3b82f6',
          gradient: 'linear-gradient(135deg, #3b82f6, #60a5fa)',
          description: 'Better rewards with a chance for frames',
          rewards: {
            frames: 1,
            currency: { min: 200, max: 400 },
            special: 15
          }
        },
        {
          id: 'elite',
          name: 'Elite Container',
          price: 1000,
          rarity: 'epic',
          borderColor: '#a855f7',
          gradient: 'linear-gradient(135deg, #a855f7, #c084fc)',
          description: 'Premium container with guaranteed frames',
          rewards: {
            frames: 2,
            currency: { min: 500, max: 800 },
            special: 30
          }
        },
        {
          id: 'legendary',
          name: 'Legendary Vault',
          price: 2000,
          rarity: 'legendary',
          borderColor: '#f59e0b',
          gradient: 'linear-gradient(135deg, #f59e0b, #fbbf24)',
          description: 'The ultimate reward vault with exclusive frames',
          rewards: {
            frames: 3,
            currency: { min: 1000, max: 1500 },
            special: 50
          }
        }
      ];
      
      const pets = [
        { id: 'dragon', name: 'Cyber Dragon', price: 800, description: 'A glowing digital companion that follows you around', emoji: 'ðŸ‰', rarity: 'epic', basePower: 75 },
        { id: 'cat', name: 'Pixel Cat', price: 300, description: 'A cute 8-bit feline friend', emoji: 'ðŸ±', rarity: 'common', basePower: 25 },
        { id: 'robot', name: 'Nano Bot', price: 600, description: 'A helpful AI assistant', emoji: 'ðŸ¤–', rarity: 'rare', basePower: 50 },
        { id: 'phoenix', name: 'Fire Phoenix', price: 1200, description: 'Legendary creature with flame effects', emoji: 'ðŸ”¥', rarity: 'legendary', basePower: 100 },
        { id: 'unicorn', name: 'Rainbow Unicorn', price: 1500, description: 'Magical unicorn with rainbow trail', emoji: 'ðŸ¦„', rarity: 'legendary', basePower: 120 },
        { id: 'ghost', name: 'Friendly Ghost', price: 400, description: 'A spooky but harmless companion', emoji: 'ðŸ‘»', rarity: 'rare', basePower: 35 },
        // Fusion pets
        { id: 'cybernetic-phoenix', name: 'Cybernetic Phoenix', description: 'Fusion of Cyber Dragon + Fire Phoenix', emoji: 'ðŸ¤–ðŸ”¥', rarity: 'mythic', basePower: 200, fusion: ['dragon', 'phoenix'] },
        { id: 'shadow-cat', name: 'Shadow Cat', description: 'Fusion of Pixel Cat + Friendly Ghost', emoji: 'ðŸ±ðŸ‘»', rarity: 'epic', basePower: 65, fusion: ['cat', 'ghost'] },
        { id: 'rainbow-dragon', name: 'Rainbow Dragon', description: 'Fusion of Cyber Dragon + Rainbow Unicorn', emoji: 'ðŸ‰ðŸ¦„', rarity: 'cosmic', basePower: 250, fusion: ['dragon', 'unicorn'] }
      ];

      // Gacha system
      const gachaTypes = [
        {
          id: 'standard',
          name: 'Standard Gacha',
          cost: 100,
          description: 'Basic gacha with common rewards',
          rates: { common: 70, rare: 25, epic: 4.5, legendary: 0.5 }
        },
        {
          id: 'premium',
          name: 'Premium Gacha',
          cost: 300,
          description: 'Better rates for rare items',
          rates: { common: 50, rare: 35, epic: 12, legendary: 3 }
        },
        {
          id: 'ultimate',
          name: 'Ultimate Gacha',
          cost: 500,
          description: 'Guaranteed rare or better!',
          rates: { common: 0, rare: 60, epic: 30, legendary: 10 }
        }
      ];

      // Pet badges and achievements
      const petBadges = [
        { id: 'first-pet', name: 'First Friend', description: 'Adopt your first pet', icon: 'ðŸ¾', reward: 50 },
        { id: 'pet-collector', name: 'Pet Collector', description: 'Own 5 different pets', icon: 'ðŸ†', reward: 200 },
        { id: 'level-master', name: 'Level Master', description: 'Get a pet to level 10', icon: 'â­', reward: 300 },
        { id: 'fusion-expert', name: 'Fusion Expert', description: 'Create your first fusion pet', icon: 'ðŸ”¬', reward: 500 },
        { id: 'battle-veteran', name: 'Battle Veteran', description: 'Win 10 pet battles', icon: 'âš”ï¸', reward: 400 },
        { id: 'rare-collector', name: 'Rare Collector', description: 'Own 3 legendary pets', icon: 'ðŸ’Ž', reward: 1000 }
      ];

      let dailyMysteryUsed = false;
      
      // === FIREBASE SHOP DATA MANAGEMENT ===
      
      async function loadShopDataFromFirebase() {
        if (!currentUser || !db) {
          loadShopDataFromLocalStorage();
          return;
        }
        
        try {
          const docRef = db.collection('users').doc(currentUser.uid);
          const doc = await docRef.get();
          
          if (doc.exists) {
            const data = doc.data();
            const shopData = data.shopData || {};
            
            userCurrency = shopData.currency || 0;
            userFrames = shopData.frames || [];
            userPets = shopData.pets || [];
            userProfileFrames = shopData.profileFrames || [];
            userPetData = shopData.petData || {};
            userBadges = shopData.badges || [];
            
            // Load frame selections
            if (shopData.selectedGameFrame) {
              localStorage.setItem('carbon-selected-frame', shopData.selectedGameFrame);
            }
            if (shopData.selectedProfileFrame) {
              localStorage.setItem('carbon-selected-profile-frame', shopData.selectedProfileFrame);
            }
            
            // Check daily mystery box usage
            const lastDailyUse = shopData.lastDailyMystery;
            const today = new Date().toDateString();
            dailyMysteryUsed = (lastDailyUse === today);
            
            // First time user bonus
            if (userCurrency === 0 && !shopData.hasReceivedWelcomeBonus) {
              userCurrency = 100;
              await saveShopDataToFirebase({ welcomeBonus: true });
              showNotification('Welcome to Carbon!', 'You received 100 Carbon Coins to get started!', 'success');
            }
          } else {
            // New user - give welcome bonus
            userCurrency = 100;
            await saveShopDataToFirebase({ welcomeBonus: true });
            showNotification('Welcome to Carbon!', 'You received 100 Carbon Coins to get started!', 'success');
          }
          
          shopDataLoaded = true;
          updateCurrencyDisplay();
        } catch (error) {
          console.error('Error loading shop data from Firebase:', error);
          loadShopDataFromLocalStorage();
        }
      }
      
      async function saveShopDataToFirebase(options = {}) {
        if (!currentUser || !db) {
          saveShopDataToLocalStorage();
          return;
        }
        
        try {
          const shopData = {
            currency: userCurrency,
            frames: userFrames,
            pets: userPets,
            profileFrames: userProfileFrames,
            petData: userPetData,
            badges: userBadges,
            selectedGameFrame: localStorage.getItem('carbon-selected-frame') || 'default',
            selectedProfileFrame: localStorage.getItem('carbon-selected-profile-frame') || 'default',
            lastDailyMystery: dailyMysteryUsed ? new Date().toDateString() : null,
            hasReceivedWelcomeBonus: options.welcomeBonus || true,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          await db.collection('users').doc(currentUser.uid).set({
            shopData: shopData
          }, { merge: true });
          
          // Also save to localStorage as backup
          saveShopDataToLocalStorage();
        } catch (error) {
          console.error('Error saving shop data to Firebase:', error);
          // Fallback to localStorage
          saveShopDataToLocalStorage();
        }
      }
      
      function loadShopDataFromLocalStorage() {
        userCurrency = parseInt(localStorage.getItem('carbon-currency') || '0');
        userFrames = JSON.parse(localStorage.getItem('carbon-frames') || '[]');
        userPets = JSON.parse(localStorage.getItem('carbon-pets') || '[]');
        userProfileFrames = JSON.parse(localStorage.getItem('carbon-profile-frames') || '[]');
        userPetData = JSON.parse(localStorage.getItem('carbon-pet-data') || '{}');
        userBadges = JSON.parse(localStorage.getItem('carbon-badges') || '[]');
        
        const lastDailyUse = localStorage.getItem('carbon-daily-mystery-date');
        const today = new Date().toDateString();
        dailyMysteryUsed = (lastDailyUse === today);
        
        // First time user check for localStorage
        if (userCurrency === 0 && !localStorage.getItem('carbon-currency-initialized')) {
          userCurrency = 100;
          localStorage.setItem('carbon-currency-initialized', 'true');
          showNotification('Welcome to Carbon!', 'You received 100 Carbon Coins to get started!', 'success');
        }
        
        shopDataLoaded = true;
        updateCurrencyDisplay();
      }
      
      function saveShopDataToLocalStorage() {
        localStorage.setItem('carbon-currency', userCurrency.toString());
        localStorage.setItem('carbon-frames', JSON.stringify(userFrames));
        localStorage.setItem('carbon-pets', JSON.stringify(userPets));
        localStorage.setItem('carbon-profile-frames', JSON.stringify(userProfileFrames));
        localStorage.setItem('carbon-pet-data', JSON.stringify(userPetData));
        localStorage.setItem('carbon-badges', JSON.stringify(userBadges));
        
        if (dailyMysteryUsed) {
          localStorage.setItem('carbon-daily-mystery-date', new Date().toDateString());
        }
      }

      const profileFrames = [
        { id: 'red', name: 'Red Frame', price: 200, color: '#ff4444', description: 'Classic red border for your profile' },
        { id: 'blue', name: 'Blue Frame', price: 200, color: '#4444ff', description: 'Cool blue border for your profile' },
        { id: 'orange', name: 'Orange Frame', price: 200, color: '#ff8844', description: 'Vibrant orange border for your profile' },
        { id: 'green', name: 'Green Frame', price: 200, color: '#44ff44', description: 'Nature green border for your profile' },
        { id: 'purple', name: 'Purple Frame', price: 200, color: '#8844ff', description: 'Royal purple border for your profile' },
        { id: 'gold', name: 'Gold Frame', price: 500, color: '#ffd700', description: 'Premium gold border for your profile' },
        { id: 'silver', name: 'Silver Frame', price: 300, color: '#c0c0c0', description: 'Elegant silver border for your profile' },
        { id: 'rainbow', name: 'Rainbow Frame', price: 800, color: 'linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #00ff00, #0080ff, #8000ff)', description: 'Animated rainbow border' }
      ];

      const miniGames = [
        { id: 'clicker', name: 'Carbon Clicker', reward: 50, description: 'Click as fast as you can!' },
        { id: 'memory', name: 'Memory Match', reward: 100, description: 'Match the carbon molecules' },
        { id: 'reaction', name: 'Reaction Test', reward: 75, description: 'Test your reaction speed' },
        { id: 'blackjack', name: 'Blackjack', reward: 200, description: 'Classic card game - beat the dealer!' },
        { id: 'roulette', name: 'Roulette', reward: 300, description: 'Spin the wheel and win big!' }
      ];

      // Mini-game implementations
      function playClickerGame() {
        let clicks = 0;
        let timeLeft = 10;
        
        const gameModal = createGameModal('Carbon Clicker', `
          <div class="text-center">
            <div class="text-6xl font-bold text-foam mb-4" id="click-counter">0</div>
            <div class="text-xl mb-4">Time: <span id="time-left" class="text-gold">${timeLeft}</span>s</div>
            <button id="click-button" class="w-32 h-32 bg-foam hover:bg-foam/80 text-base rounded-full text-4xl font-bold transition-transform hover:scale-110 active:scale-95">
              CLICK!
            </button>
            <div class="mt-4 text-muted">Click as fast as you can!</div>
          </div>
        `);
        
        const clickButton = gameModal.querySelector('#click-button');
        const clickCounter = gameModal.querySelector('#click-counter');
        const timeDisplay = gameModal.querySelector('#time-left');
        
        clickButton.addEventListener('click', () => {
          clicks++;
          clickCounter.textContent = clicks;
          clickButton.style.transform = 'scale(0.95)';
          setTimeout(() => clickButton.style.transform = '', 100);
        });
        
        const timer = setInterval(() => {
          timeLeft--;
          timeDisplay.textContent = timeLeft;
          if (timeLeft <= 0) {
            clearInterval(timer);
            endClickerGame(clicks);
          }
        }, 1000);
        
        function endClickerGame(finalClicks) {
          const reward = Math.min(finalClicks * 5, 250); // Max 250 coins
          userCurrency += reward;
          updateCurrencyDisplay();
          saveCurrencyToStorage();
          
          gameModal.innerHTML = `
            <div class="text-center">
              <i class="bx bx-trophy text-6xl text-gold mb-4"></i>
              <h3 class="text-2xl font-bold text-text mb-2">Game Complete!</h3>
              <p class="text-muted mb-4">You clicked ${finalClicks} times!</p>
              <p class="text-xl text-foam mb-6">Earned: <span class="text-gold">${reward}</span> Carbon Coins</p>
              <button onclick="closeGameModal()" class="px-6 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium">
                Continue
              </button>
            </div>
          `;
        }
      }
      
      function playMemoryGame() {
        const symbols = ['ðŸ”¥', 'âš¡', 'ðŸŒŸ', 'ðŸ’Ž', 'ðŸŽ®', 'ðŸš€'];
        let cards = [...symbols, ...symbols].sort(() => Math.random() - 0.5);
        let flipped = [];
        let matches = 0;
        let attempts = 0;
        
        const gameModal = createGameModal('Memory Match', `
          <div class="text-center">
            <div class="text-lg mb-4">Matches: <span id="matches" class="text-gold">0</span>/6 | Attempts: <span id="attempts" class="text-muted">0</span></div>
            <div class="grid grid-cols-4 gap-2 max-w-sm mx-auto" id="memory-grid"></div>
          </div>
        `);
        
        const grid = gameModal.querySelector('#memory-grid');
        const matchesDisplay = gameModal.querySelector('#matches');
        const attemptsDisplay = gameModal.querySelector('#attempts');
        
        cards.forEach((symbol, index) => {
          const card = document.createElement('button');
          card.className = 'w-16 h-16 bg-highlight-med hover:bg-highlight-high rounded-lg text-2xl transition-all';
          card.dataset.index = index;
          card.dataset.symbol = symbol;
          card.textContent = '?';
          
          card.addEventListener('click', () => flipCard(card));
          grid.appendChild(card);
        });
        
        function flipCard(card) {
          if (flipped.length >= 2 || card.classList.contains('flipped')) return;
          
          card.textContent = card.dataset.symbol;
          card.classList.add('flipped', 'bg-foam', 'text-base');
          flipped.push(card);
          
          if (flipped.length === 2) {
            attempts++;
            attemptsDisplay.textContent = attempts;
            
            setTimeout(() => {
              if (flipped[0].dataset.symbol === flipped[1].dataset.symbol) {
                matches++;
                matchesDisplay.textContent = matches;
                flipped.forEach(c => c.classList.add('matched', 'bg-pine'));
                
                if (matches === 6) {
                  endMemoryGame(attempts);
                }
              } else {
                flipped.forEach(c => {
                  c.textContent = '?';
                  c.classList.remove('flipped', 'bg-foam', 'text-base');
                });
              }
              flipped = [];
            }, 1000);
          }
        }
        
        function endMemoryGame(totalAttempts) {
          const baseReward = 100;
          const bonus = Math.max(0, (20 - totalAttempts) * 10); // Bonus for fewer attempts
          const reward = baseReward + bonus;
          
          userCurrency += reward;
          updateCurrencyDisplay();
          saveCurrencyToStorage();
          
          setTimeout(() => {
            gameModal.innerHTML = `
              <div class="text-center">
                <i class="bx bx-brain text-6xl text-foam mb-4"></i>
                <h3 class="text-2xl font-bold text-text mb-2">Excellent Memory!</h3>
                <p class="text-muted mb-2">Completed in ${totalAttempts} attempts</p>
                <p class="text-xl text-foam mb-6">Earned: <span class="text-gold">${reward}</span> Carbon Coins</p>
                <button onclick="closeGameModal()" class="px-6 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium">
                  Continue
                </button>
              </div>
            `;
          }, 1500);
        }
      }
      
      function playReactionGame() {
        let gameStarted = false;
        let startTime = 0;
        
        const gameModal = createGameModal('Reaction Test', `
          <div class="text-center">
            <div class="w-64 h-64 mx-auto mb-6 rounded-lg border-2 border-highlight-med flex items-center justify-center" id="reaction-area">
              <div class="text-muted">Wait for GREEN...</div>
            </div>
            <div class="text-lg text-muted" id="reaction-instruction">Click when the area turns GREEN!</div>
          </div>
        `);
        
        const reactionArea = gameModal.querySelector('#reaction-area');
        const instruction = gameModal.querySelector('#reaction-instruction');
        
        // Random delay between 1-5 seconds
        const delay = Math.random() * 4000 + 1000;
        
        setTimeout(() => {
          reactionArea.className = 'w-64 h-64 mx-auto mb-6 rounded-lg border-2 border-foam bg-foam/20 flex items-center justify-center cursor-pointer';
          reactionArea.innerHTML = '<div class="text-base text-4xl font-bold">CLICK NOW!</div>';
          instruction.textContent = 'CLICK NOW!';
          gameStarted = true;
          startTime = Date.now();
        }, delay);
        
        reactionArea.addEventListener('click', () => {
          if (!gameStarted) {
            instruction.textContent = 'Too early! Wait for green...';
            instruction.className = 'text-lg text-love';
            return;
          }
          
          const reactionTime = Date.now() - startTime;
          endReactionGame(reactionTime);
        });
        
        function endReactionGame(time) {
          let reward = 75;
          let rating = 'Good';
          
          if (time < 300) {
            reward = 150;
            rating = 'Incredible!';
          } else if (time < 500) {
            reward = 125;
            rating = 'Excellent!';
          } else if (time < 700) {
            reward = 100;
            rating = 'Great!';
          }
          
          userCurrency += reward;
          updateCurrencyDisplay();
          saveCurrencyToStorage();
          
          reactionArea.innerHTML = `
            <div class="text-center">
              <i class="bx bx-time text-6xl text-foam mb-4"></i>
              <h3 class="text-2xl font-bold text-text mb-2">${rating}</h3>
              <p class="text-muted mb-2">Reaction Time: ${time}ms</p>
              <p class="text-xl text-foam mb-6">Earned: <span class="text-gold">${reward}</span> Carbon Coins</p>
              <button onclick="closeGameModal()" class="px-6 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium">
                Continue
              </button>
            </div>
          `;
          instruction.textContent = '';
        }
      }
      
      function createGameModal(title, content) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[9999]';
        modal.innerHTML = `
          <div class="bg-surface border border-highlight-med rounded-xl shadow-2xl max-w-lg w-[90vw] p-6">
            <div class="flex items-center justify-between mb-6">
              <h2 class="text-xl font-semibold text-text">${title}</h2>
              <button onclick="closeGameModal()" class="text-muted hover:text-love transition-colors">
                <i class="bx bx-x text-2xl"></i>
              </button>
            </div>
            <div>${content}</div>
          </div>
        `;
        document.body.appendChild(modal);
        window.currentGameModal = modal;
        return modal;
      }
      
      window.closeGameModal = function() {
        if (window.currentGameModal) {
          window.currentGameModal.remove();
          window.currentGameModal = null;
        }
      };

      function playBlackjackGame() {
        let playerCards = [];
        let dealerCards = [];
        let gameEnded = false;
        let bet = 50; // Fixed bet for simplicity
        
        const gameModal = createGameModal('Blackjack', `
          <div class="text-center">
            <div class="mb-4">
              <div class="text-lg font-semibold text-foam mb-2">Bet: <span class="text-gold">${bet}</span> coins</div>
              <div class="text-sm text-muted">Beat the dealer to 21!</div>
            </div>
            
            <div class="mb-6">
              <div class="mb-4">
                <h4 class="text-md font-semibold text-text mb-2">Dealer Cards</h4>
                <div id="dealer-cards" class="flex justify-center gap-2 mb-2"></div>
                <div id="dealer-total" class="text-sm text-muted"></div>
              </div>
              
              <div>
                <h4 class="text-md font-semibold text-text mb-2">Your Cards</h4>
                <div id="player-cards" class="flex justify-center gap-2 mb-2"></div>
                <div id="player-total" class="text-sm text-foam font-semibold"></div>
              </div>
            </div>
            
            <div id="game-controls" class="flex gap-3 justify-center">
              <button id="hit-btn" class="px-4 py-2 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium">Hit</button>
              <button id="stand-btn" class="px-4 py-2 bg-gold hover:bg-gold/80 text-base rounded-lg font-medium">Stand</button>
            </div>
            
            <div id="game-result" class="hidden mt-4"></div>
          </div>
        `);
        
        function createCard() {
          const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
          const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
          return {
            suit: suits[Math.floor(Math.random() * suits.length)],
            value: values[Math.floor(Math.random() * values.length)]
          };
        }
        
        function calculateTotal(cards) {
          let total = 0;
          let aces = 0;
          
          for (let card of cards) {
            if (card.value === 'A') {
              aces++;
              total += 11;
            } else if (['J', 'Q', 'K'].includes(card.value)) {
              total += 10;
            } else {
              total += parseInt(card.value);
            }
          }
          
          // Adjust for aces
          while (total > 21 && aces > 0) {
            total -= 10;
            aces--;
          }
          
          return total;
        }
        
        function renderCards(cards, containerId, hideFirst = false) {
          const container = gameModal.querySelector(`#${containerId}`);
          container.innerHTML = '';
          
          cards.forEach((card, index) => {
            const cardEl = document.createElement('div');
            cardEl.className = 'w-12 h-16 bg-white text-black rounded border-2 border-gray-300 flex flex-col items-center justify-center text-xs font-bold';
            
            if (hideFirst && index === 0) {
              cardEl.innerHTML = '<div class="text-lg">?</div>';
              cardEl.className += ' bg-blue-900 text-white';
            } else {
              cardEl.innerHTML = `<div>${card.value}</div><div class="${card.suit === 'â™¥' || card.suit === 'â™¦' ? 'text-red-500' : 'text-black'}">${card.suit}</div>`;
            }
            
            container.appendChild(cardEl);
          });
        }
        
        function updateDisplay() {
          renderCards(dealerCards, 'dealer-cards', !gameEnded);
          renderCards(playerCards, 'player-cards');
          
          const playerTotal = calculateTotal(playerCards);
          const dealerTotal = gameEnded ? calculateTotal(dealerCards) : '?';
          
          gameModal.querySelector('#player-total').textContent = `Total: ${playerTotal}`;
          gameModal.querySelector('#dealer-total').textContent = gameEnded ? `Total: ${dealerTotal}` : '';
        }
        
        function endGame(result, message) {
          gameEnded = true;
          updateDisplay();
          
          let reward = 0;
          if (result === 'win') {
            reward = bet * 2;
            userCurrency += reward;
          } else if (result === 'push') {
            reward = bet;
            userCurrency += reward;
          }
          
          updateCurrencyDisplay();
          saveCurrencyToStorage();
          
          gameModal.querySelector('#game-controls').classList.add('hidden');
          gameModal.querySelector('#game-result').classList.remove('hidden');
          gameModal.querySelector('#game-result').innerHTML = `
            <div class="text-center">
              <h3 class="text-xl font-bold mb-2 ${result === 'win' ? 'text-pine' : result === 'lose' ? 'text-love' : 'text-gold'}">${message}</h3>
              <p class="text-foam mb-4">Earned: <span class="text-gold">${reward}</span> Carbon Coins</p>
              <button onclick="closeGameModal()" class="px-6 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium">
                Continue
              </button>
            </div>
          `;
        }
        
        // Initialize game
        if (userCurrency < bet) {
          endGame('lose', 'Insufficient funds!');
          return;
        }
        
        userCurrency -= bet;
        updateCurrencyDisplay();
        saveCurrencyToStorage();
        
        // Deal initial cards
        playerCards = [createCard(), createCard()];
        dealerCards = [createCard(), createCard()];
        
        updateDisplay();
        
        // Check for blackjack
        const playerTotal = calculateTotal(playerCards);
        const dealerTotal = calculateTotal(dealerCards);
        
        if (playerTotal === 21) {
          if (dealerTotal === 21) {
            endGame('push', 'Push! Both have Blackjack');
          } else {
            endGame('win', 'Blackjack! You Win!');
          }
          return;
        }
        
        // Game controls
        gameModal.querySelector('#hit-btn').addEventListener('click', () => {
          if (gameEnded) return;
          
          playerCards.push(createCard());
          const total = calculateTotal(playerCards);
          updateDisplay();
          
          if (total > 21) {
            endGame('lose', 'Bust! You went over 21');
          } else if (total === 21) {
            // Auto-stand on 21
            stand();
          }
        });
        
        gameModal.querySelector('#stand-btn').addEventListener('click', stand);
        
        function stand() {
          if (gameEnded) return;
          
          // Dealer plays
          while (calculateTotal(dealerCards) < 17) {
            dealerCards.push(createCard());
          }
          
          const playerTotal = calculateTotal(playerCards);
          const dealerTotal = calculateTotal(dealerCards);
          
          if (dealerTotal > 21) {
            endGame('win', 'Dealer Bust! You Win!');
          } else if (playerTotal > dealerTotal) {
            endGame('win', 'You Win!');
          } else if (playerTotal < dealerTotal) {
            endGame('lose', 'Dealer Wins!');
          } else {
            endGame('push', 'Push! It\'s a tie');
          }
        }
      }

      function playRouletteGame() {
        let bet = 25;
        let selectedBet = null;
        
        const gameModal = createGameModal('Roulette', `
          <div class="text-center">
            <div class="mb-4">
              <div class="text-lg font-semibold text-foam mb-2">Bet: <span class="text-gold">${bet}</span> coins</div>
              <div class="text-sm text-muted">Choose your bet and spin the wheel!</div>
            </div>
            
            <div class="mb-6">
              <div class="w-32 h-32 mx-auto mb-4 relative">
                <div id="roulette-wheel" class="w-full h-full rounded-full border-8 border-gold bg-gradient-to-r from-red-600 to-black relative overflow-hidden transition-transform duration-3000">
                  <div class="absolute inset-2 rounded-full bg-gradient-to-r from-red-500 via-black to-red-500"></div>
                  <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full z-10"></div>
                  <div class="absolute top-2 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-b-8 border-transparent border-b-foam z-20"></div>
                </div>
              </div>
              
              <div class="text-xl font-bold text-foam" id="winning-number">0</div>
            </div>
            
            <div class="mb-6">
              <h4 class="text-md font-semibold text-text mb-3">Place Your Bet</h4>
              <div class="grid grid-cols-3 gap-2 max-w-xs mx-auto">
                <button class="bet-btn px-3 py-2 bg-love hover:bg-love/80 text-white rounded text-sm" data-bet="red">Red (2x)</button>
                <button class="bet-btn px-3 py-2 bg-surface hover:bg-surface/80 text-white rounded text-sm" data-bet="black">Black (2x)</button>
                <button class="bet-btn px-3 py-2 bg-pine hover:bg-pine/80 text-white rounded text-sm" data-bet="green">Green (14x)</button>
                <button class="bet-btn px-3 py-2 bg-foam hover:bg-foam/80 text-base rounded text-sm" data-bet="odd">Odd (2x)</button>
                <button class="bet-btn px-3 py-2 bg-foam hover:bg-foam/80 text-base rounded text-sm" data-bet="even">Even (2x)</button>
                <button class="bet-btn px-3 py-2 bg-gold hover:bg-gold/80 text-base rounded text-sm" data-bet="lucky">Lucky 7 (10x)</button>
              </div>
              
              <div class="mt-3 text-sm text-muted" id="selected-bet">Select a bet to continue</div>
            </div>
            
            <div id="game-controls">
              <button id="spin-btn" class="px-6 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium opacity-50" disabled>
                Spin Wheel
              </button>
            </div>
            
            <div id="game-result" class="hidden mt-4"></div>
          </div>
        `);
        
        const numbers = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
        const redNumbers = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
        const blackNumbers = [2, 4, 6, 8, 10, 11, 13, 15, 17, 20, 22, 24, 26, 28, 29, 31, 33, 35];
        
        if (userCurrency < bet) {
          gameModal.querySelector('#game-result').classList.remove('hidden');
          gameModal.querySelector('#game-result').innerHTML = `
            <div class="text-center">
              <h3 class="text-xl font-bold text-love mb-2">Insufficient Funds!</h3>
              <button onclick="closeGameModal()" class="px-6 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium">
                Continue
              </button>
            </div>
          `;
          return;
        }
        
        // Bet selection
        gameModal.querySelectorAll('.bet-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            gameModal.querySelectorAll('.bet-btn').forEach(b => b.classList.remove('ring-2', 'ring-foam'));
            btn.classList.add('ring-2', 'ring-foam');
            selectedBet = btn.dataset.bet;
            gameModal.querySelector('#selected-bet').textContent = `Selected: ${btn.textContent}`;
            gameModal.querySelector('#spin-btn').disabled = false;
            gameModal.querySelector('#spin-btn').classList.remove('opacity-50');
          });
        });
        
        gameModal.querySelector('#spin-btn').addEventListener('click', () => {
          if (!selectedBet) return;
          
          userCurrency -= bet;
          updateCurrencyDisplay();
          saveCurrencyToStorage();
          
          gameModal.querySelector('#game-controls').style.display = 'none';
          
          // Spin animation
          const wheel = gameModal.querySelector('#roulette-wheel');
          const spins = 5 + Math.random() * 5;
          const finalRotation = spins * 360;
          wheel.style.transform = `rotate(${finalRotation}deg)`;
          
          setTimeout(() => {
            const winningNumber = numbers[Math.floor(Math.random() * numbers.length)];
            gameModal.querySelector('#winning-number').textContent = winningNumber;
            
            let isWin = false;
            let multiplier = 0;
            
            switch (selectedBet) {
              case 'red':
                isWin = redNumbers.includes(winningNumber);
                multiplier = 2;
                break;
              case 'black':
                isWin = blackNumbers.includes(winningNumber);
                multiplier = 2;
                break;
              case 'green':
                isWin = winningNumber === 0;
                multiplier = 14;
                break;
              case 'odd':
                isWin = winningNumber > 0 && winningNumber % 2 === 1;
                multiplier = 2;
                break;
              case 'even':
                isWin = winningNumber > 0 && winningNumber % 2 === 0;
                multiplier = 2;
                break;
              case 'lucky':
                isWin = winningNumber === 7;
                multiplier = 10;
                break;
            }
            
            let reward = 0;
            if (isWin) {
              reward = bet * multiplier;
              userCurrency += reward;
              updateCurrencyDisplay();
              saveCurrencyToStorage();
            }
            
            gameModal.querySelector('#game-result').classList.remove('hidden');
            gameModal.querySelector('#game-result').innerHTML = `
              <div class="text-center">
                <h3 class="text-xl font-bold mb-2 ${isWin ? 'text-pine' : 'text-love'}">
                  ${isWin ? 'You Win!' : 'You Lose!'}
                </h3>
                <p class="text-muted mb-2">Winning Number: <span class="font-bold ${redNumbers.includes(winningNumber) ? 'text-love' : winningNumber === 0 ? 'text-pine' : 'text-text'}">${winningNumber}</span></p>
                <p class="text-foam mb-4">Earned: <span class="text-gold">${reward}</span> Carbon Coins</p>
                <button onclick="closeGameModal()" class="px-6 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium">
                  Continue
                </button>
              </div>
            `;
          }, 3000);
        });
      }
      
      function openCarbonShop() {
        // Clean up any old waiting rooms when opening shop (helps with database hygiene)
        if (currentUser) {
          db.collection('game-rooms')
            .where('hostId', '==', currentUser.uid)
            .where('status', '==', 'waiting')
            .get()
            .then(snapshot => {
              snapshot.docs.forEach(doc => {
                const room = doc.data();
                const roomAge = Date.now() - (room.createdAt?.toDate?.()?.getTime() || 0);
                // Delete rooms older than 5 minutes
                if (roomAge > 5 * 60 * 1000) {
                  console.log('Cleaning up old waiting room:', doc.id);
                  doc.ref.delete();
                }
              });
            })
            .catch(error => {
              console.error('Error cleaning up old rooms:', error);
            });
        }
        
        const shopModal = document.createElement('div');
        shopModal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[9999]';
        shopModal.innerHTML = `
          <div class="bg-surface border border-highlight-med rounded-xl shadow-2xl max-w-6xl w-[95vw] h-[90vh] flex">
            <!-- Sidebar -->
            <div class="w-64 bg-overlay/50 p-6 border-r border-highlight-med">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-text">Carbon Shop</h2>
                <button onclick="closeShop()" class="text-muted hover:text-love transition-colors">
                  <i class="bx bx-x text-2xl"></i>
                </button>
              </div>
              
              <div class="bg-foam/10 border border-foam/30 rounded-lg p-4 mb-6">
                <div class="flex items-center gap-2 mb-2">
                  <i class="bx bx-coin text-gold text-xl"></i>
                  <span class="text-text font-medium">Your Balance</span>
                </div>
                <div class="text-2xl font-bold text-gold" id="shop-currency">${userCurrency}</div>
                <div class="text-xs text-muted">Carbon Coins</div>
              </div>
              
                             <nav class="space-y-2">
                 <button onclick="showShopSection('frames')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg bg-foam/20 text-foam">
                   <i class="bx bx-image mr-2"></i>Game Frames
                 </button>
                 <button onclick="showShopSection('selector')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-highlight-med text-text">
                   <i class="bx bx-palette mr-2"></i>Frame Selector
                 </button>
                 <button onclick="showShopSection('pets')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-highlight-med text-text">
                   <i class="bx bx-heart mr-2"></i>Pets
                 </button>
                 <button onclick="showShopSection('profileframes')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-highlight-med text-text">
                   <i class="bx bx-user mr-2"></i>Profile Frames
                 </button>
                 <button onclick="showShopSection('lootboxes')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-highlight-med text-text">
                   <i class="bx bx-package mr-2"></i>Loot Boxes
                 </button>
                 <button onclick="showShopSection('gacha')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-highlight-med text-text">
                   <i class="bx bx-dice-6 mr-2"></i>Gacha Pulls
                 </button>
                 <button onclick="showShopSection('petmanagement')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-highlight-med text-text">
                   <i class="bx bx-cog mr-2"></i>Pet Management
                 </button>
                 <button onclick="showShopSection('badges')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-highlight-med text-text">
                   <i class="bx bx-medal mr-2"></i>Badges & Trophies
                 </button>
                 <button onclick="showShopSection('minigames')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-highlight-med text-text">
                   <i class="bx bx-game mr-2"></i>Mini Games
                 </button>
                 <button onclick="showShopSection('multiplayer')" class="shop-nav-btn w-full text-left px-3 py-2 rounded-lg hover:bg-highlight-med text-text">
                   <i class="bx bx-group mr-2"></i>2-Player Games
                 </button>
               </nav>
            </div>
            
            <!-- Main Content -->
            <div class="flex-1 p-6 overflow-y-auto">
              <div id="shop-frames" class="shop-section">
                <h3 class="text-2xl font-bold text-text mb-6">Game Frames</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  ${gameFrames.map(frame => `
                    <div class="bg-highlight-med rounded-xl p-6 border border-overlay">
                      <div class="w-full h-32 rounded-lg mb-4 border-4 flex items-center justify-center relative overflow-hidden" 
                           style="border-color: ${frame.color}; background: ${frame.color}15;">
                        <span class="text-text font-medium">Game Preview</span>
                        ${frame.id === 'fire' ? '<div class="absolute inset-0 bg-gradient-to-r from-orange-500/20 to-red-500/20 animate-pulse"></div>' : ''}
                        ${frame.id === 'galaxy' ? '<div class="absolute inset-0 bg-gradient-to-r from-purple-500/20 to-blue-500/20"></div>' : ''}
                        ${frame.id === 'neon' ? '<div class="absolute inset-0 shadow-lg shadow-cyan-500/50"></div>' : ''}
                      </div>
                      <h4 class="text-lg font-semibold text-text mb-2">${frame.name}</h4>
                      <p class="text-sm text-muted mb-4">${frame.description}</p>
                      <div class="flex items-center justify-between">
                        <div class="text-gold font-bold">${frame.price} coins</div>
                        <button onclick="purchaseFrame('${frame.id}')" 
                                class="px-4 py-2 rounded-lg transition-colors ${userFrames.includes(frame.id) ? 'bg-pine/20 text-pine' : userCurrency >= frame.price ? 'bg-foam hover:bg-foam/80 text-base' : 'bg-muted/20 text-muted cursor-not-allowed'}">
                          ${userFrames.includes(frame.id) ? 'Owned' : userCurrency >= frame.price ? 'Purchase' : 'Insufficient Funds'}
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
                             </div>
               
               <div id="shop-selector" class="shop-section hidden">
                 <h3 class="text-2xl font-bold text-text mb-6">Frame Selector</h3>
                 <p class="text-muted mb-6">Choose which frame to use when playing games. Only frames you own can be selected.</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                   <div class="bg-highlight-med rounded-xl p-6 border border-overlay">
                     <div class="w-full h-32 rounded-lg mb-4 border-4 border-gray-400 flex items-center justify-center bg-gray-100/10">
                       <span class="text-text font-medium">Default Frame</span>
                     </div>
                     <h4 class="text-lg font-semibold text-text mb-2">Default</h4>
                     <p class="text-sm text-muted mb-4">Standard game border</p>
                     <button onclick="selectFrame('default')" class="w-full px-4 py-2 bg-foam hover:bg-foam/80 text-base rounded-lg transition-colors">
                       Select
                     </button>
                   </div>
                   ${gameFrames.filter(frame => userFrames.includes(frame.id)).map(frame => `
                     <div class="bg-highlight-med rounded-xl p-6 border border-overlay">
                       <div class="w-full h-32 rounded-lg mb-4 border-4 flex items-center justify-center relative overflow-hidden" 
                            style="border-color: ${frame.color}; background: ${frame.color}15;">
                         <span class="text-text font-medium">Game Preview</span>
                         ${frame.id === 'fire' ? '<div class="absolute inset-0 bg-gradient-to-r from-orange-500/20 to-red-500/20 animate-pulse"></div>' : ''}
                         ${frame.id === 'galaxy' ? '<div class="absolute inset-0 bg-gradient-to-r from-purple-500/20 to-blue-500/20"></div>' : ''}
                         ${frame.id === 'neon' ? '<div class="absolute inset-0 shadow-lg shadow-cyan-500/50"></div>' : ''}
                       </div>
                       <h4 class="text-lg font-semibold text-text mb-2">${frame.name}</h4>
                       <p class="text-sm text-muted mb-4">${frame.description}</p>
                       <button onclick="selectFrame('${frame.id}')" class="w-full px-4 py-2 bg-foam hover:bg-foam/80 text-base rounded-lg transition-colors">
                         Select
                       </button>
                     </div>
                   `).join('')}
                 </div>
                 ${userFrames.length === 0 ? `
                   <div class="text-center py-12">
                     <i class="bx bx-package text-6xl text-muted mb-4"></i>
                     <h4 class="text-xl font-semibold text-text mb-2">No Frames Owned</h4>
                     <p class="text-muted mb-4">Purchase frames from the Game Frames section to customize your gaming experience!</p>
                     <button onclick="showShopSection('frames')" class="px-6 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium">
                       Browse Frames
                     </button>
                   </div>
                 ` : ''}
               </div>
               
               <div id="shop-pets" class="shop-section hidden">
                 <h3 class="text-2xl font-bold text-text mb-6">Digital Pets</h3>
                 <p class="text-muted mb-6">Adopt adorable digital companions to keep you company!</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                   ${pets.map(pet => `
                     <div class="bg-highlight-med rounded-xl p-6 border border-overlay">
                       <div class="w-full h-32 rounded-lg mb-4 flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-foam/10 to-iris/10">
                         <div class="text-6xl animate-bounce">${pet.emoji}</div>
                         <div class="absolute top-2 right-2 px-2 py-1 rounded-full text-xs font-bold ${pet.rarity === 'legendary' ? 'bg-gold/20 text-gold' : pet.rarity === 'epic' ? 'bg-iris/20 text-iris' : pet.rarity === 'rare' ? 'bg-foam/20 text-foam' : 'bg-muted/20 text-muted'}">${pet.rarity}</div>
                       </div>
                       <h4 class="text-lg font-semibold text-text mb-2">${pet.name}</h4>
                       <p class="text-sm text-muted mb-4">${pet.description}</p>
                       <div class="flex items-center justify-between">
                         <div class="text-gold font-bold">${pet.price} coins</div>
                         <button onclick="purchasePet('${pet.id}')" 
                                 class="px-4 py-2 rounded-lg transition-colors ${userPets.includes(pet.id) ? 'bg-pine/20 text-pine' : userCurrency >= pet.price ? 'bg-foam hover:bg-foam/80 text-base' : 'bg-muted/20 text-muted cursor-not-allowed'}">
                           ${userPets.includes(pet.id) ? 'Adopted' : userCurrency >= pet.price ? 'Adopt' : 'Insufficient Funds'}
                         </button>
                       </div>
                     </div>
                   `).join('')}
                 </div>
               </div>
               
               <div id="shop-profileframes" class="shop-section hidden">
                 <h3 class="text-2xl font-bold text-text mb-6">Profile Frames</h3>
                 <p class="text-muted mb-6">Customize your profile with colorful borders!</p>
                 
                 <!-- Profile Frame Selector -->
                 <div class="mb-8 p-4 bg-highlight-med rounded-xl">
                   <h4 class="text-lg font-semibold text-text mb-4">Equip Profile Frame</h4>
                   <p class="text-muted mb-4">Choose which frame to display around your profile picture. Only frames you own can be selected.</p>
                   <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                     <div class="bg-overlay rounded-lg p-4 border border-highlight-med">
                       <div class="w-16 h-16 mx-auto mb-2 rounded-full bg-surface border-2 border-gray-400 flex items-center justify-center">
                         <i class="bx bx-user text-2xl text-muted"></i>
                       </div>
                       <h5 class="text-sm font-semibold text-text text-center mb-2">Default</h5>
                       <button onclick="selectProfileFrame('default')" class="w-full px-3 py-1 bg-foam hover:bg-foam/80 text-base rounded text-sm transition-colors">
                         Select
                       </button>
                     </div>
                     ${profileFrames.filter(frame => userProfileFrames.includes(frame.id)).map(frame => `
                       <div class="bg-overlay rounded-lg p-4 border border-highlight-med">
                         <div class="w-16 h-16 mx-auto mb-2 rounded-full border-4 flex items-center justify-center relative overflow-hidden" 
                              style="border-color: ${frame.color}; background: var(--theme-surface);">
                           <i class="bx bx-user text-2xl text-text"></i>
                           ${frame.id === 'rainbow' ? '<div class="absolute inset-0 rounded-full bg-gradient-to-r from-red-500/20 via-yellow-500/20 to-blue-500/20 animate-pulse"></div>' : ''}
                         </div>
                         <h5 class="text-sm font-semibold text-text text-center mb-2">${frame.name}</h5>
                         <button onclick="selectProfileFrame('${frame.id}')" class="w-full px-3 py-1 bg-foam hover:bg-foam/80 text-base rounded text-sm transition-colors">
                           Select
                         </button>
                       </div>
                     `).join('')}
                   </div>
                   ${userProfileFrames.length === 0 ? `
                     <div class="text-center py-8">
                       <i class="bx bx-package text-4xl text-muted mb-2"></i>
                       <p class="text-muted">Purchase frames below to customize your profile!</p>
                     </div>
                   ` : ''}
                 </div>
                 
                 <!-- Available Profile Frames -->
                 <h4 class="text-lg font-semibold text-text mb-4">Available Frames</h4>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                   ${profileFrames.map(frame => `
                     <div class="bg-highlight-med rounded-xl p-6 border border-overlay">
                       <div class="w-full h-32 rounded-lg mb-4 border-4 flex items-center justify-center relative overflow-hidden" 
                            style="border-color: ${frame.color}; background: ${frame.color}15;">
                         <div class="w-16 h-16 rounded-full border-4" style="border-color: ${frame.color}; background: var(--theme-surface);"></div>
                         ${frame.id === 'rainbow' ? '<div class="absolute inset-0 bg-gradient-to-r from-red-500/20 via-yellow-500/20 to-blue-500/20 animate-pulse"></div>' : ''}
                       </div>
                       <h4 class="text-lg font-semibold text-text mb-2">${frame.name}</h4>
                       <p class="text-sm text-muted mb-4">${frame.description}</p>
                       <div class="flex items-center justify-between">
                         <div class="text-gold font-bold">${frame.price} coins</div>
                         <button onclick="purchaseProfileFrame('${frame.id}')" 
                                 class="px-4 py-2 rounded-lg transition-colors ${userProfileFrames.includes(frame.id) ? 'bg-pine/20 text-pine' : userCurrency >= frame.price ? 'bg-foam hover:bg-foam/80 text-base' : 'bg-muted/20 text-muted cursor-not-allowed'}">
                           ${userProfileFrames.includes(frame.id) ? 'Owned' : userCurrency >= frame.price ? 'Purchase' : 'Insufficient Funds'}
                         </button>
                       </div>
                     </div>
                   `).join('')}
                 </div>
               </div>
               
               <div id="shop-lootboxes" class="shop-section hidden">
                 <h3 class="text-2xl font-bold text-text mb-6">Loot Boxes</h3>
                 <p class="text-muted mb-6">Open loot boxes to discover frames, currency, and special rewards!</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                   ${lootBoxes.map(box => {
                     const isToday = box.isDaily && localStorage.getItem('carbon-daily-mystery-date') === new Date().toDateString();
                     const canAfford = userCurrency >= box.price;
                     const canOpen = canAfford && !isToday;
                     
                     return `
                       <div class="bg-highlight-med rounded-xl p-6 border-2 ${isToday ? 'opacity-60' : ''}" style="border-color: ${box.borderColor};">
                         <div class="w-full h-32 rounded-lg mb-4 flex items-center justify-center relative overflow-hidden" 
                              style="background: ${box.gradient};">
                           <div class="relative">
                             <i class="bx bx-package text-6xl text-white drop-shadow-lg"></i>
                             <div class="absolute inset-0 bg-gradient-to-t from-transparent to-white/20 rounded-lg"></div>
                           </div>
                           ${box.rarity === 'mystery' ? '<div class="absolute inset-0 bg-gradient-to-r from-orange-500/30 to-yellow-500/30 animate-pulse"></div>' : ''}
                           ${box.rarity === 'legendary' ? '<div class="absolute inset-0 bg-gradient-to-r from-yellow-500/30 to-orange-500/30 animate-pulse"></div>' : ''}
                           ${box.rarity === 'epic' ? '<div class="absolute inset-0 bg-gradient-to-r from-purple-500/30 to-pink-500/30"></div>' : ''}
                           ${isToday ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center"><span class="text-white font-bold">USED TODAY</span></div>' : ''}
                         </div>
                         <h4 class="text-lg font-semibold text-text mb-2">${box.name}</h4>
                         <p class="text-sm text-muted mb-3">${box.description}</p>
                         <div class="text-xs text-muted mb-4">
                           ${box.rewards.random ? `
                             <div class="mb-1">ðŸŽ² Random surprise item!</div>
                             <div class="mb-1">ðŸ’° ${box.rewards.currency.min}-${box.rewards.currency.max} coins</div>
                             <div>âœ¨ ${box.rewards.special}% special bonus chance</div>
                           ` : `
                             <div class="mb-1">ðŸŽ ${box.rewards.frames > 0 ? box.rewards.frames + ' frames guaranteed' : 'No frames'}</div>
                             <div class="mb-1">ðŸ’° ${box.rewards.currency.min}-${box.rewards.currency.max} coins</div>
                             <div>âœ¨ ${box.rewards.special}% special item chance</div>
                           `}
                         </div>
                         <div class="flex items-center justify-between">
                           <div class="text-gold font-bold">${box.price} coins</div>
                           <button onclick="openLootBox('${box.id}')" 
                                   class="px-4 py-2 rounded-lg transition-colors ${canOpen ? 'bg-foam hover:bg-foam/80 text-base' : 'bg-muted/20 text-muted cursor-not-allowed'}">
                             ${isToday ? 'Used Today' : canAfford ? 'Open Box' : 'Insufficient Funds'}
                           </button>
                         </div>
                       </div>
                     `;
                   }).join('')}
                 </div>
               </div>
               
               <!-- Gacha Section -->
               <div id="shop-gacha" class="shop-section hidden">
                 <h3 class="text-2xl font-bold text-text mb-6">Gacha Pulls</h3>
                 <p class="text-muted mb-6">Roll for rare items! Higher tier gachas have better drop rates.</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                   ${gachaTypes.map(gacha => `
                     <div class="bg-highlight-med rounded-xl p-6 border border-overlay">
                       <div class="w-full h-32 rounded-lg mb-4 flex items-center justify-center bg-gradient-to-br from-iris/20 to-love/20">
                         <i class="bx bx-dice-6 text-6xl text-iris animate-pulse"></i>
                       </div>
                       <h4 class="text-lg font-semibold text-text mb-2">${gacha.name}</h4>
                       <p class="text-sm text-muted mb-4">${gacha.description}</p>
                       <div class="text-xs text-muted mb-4 space-y-1">
                         <div>ðŸŽ¯ Common: ${gacha.rates.common}%</div>
                         <div>ðŸ’™ Rare: ${gacha.rates.rare}%</div>
                         <div>ðŸ’œ Epic: ${gacha.rates.epic}%</div>
                         <div>âœ¨ Legendary: ${gacha.rates.legendary}%</div>
                       </div>
                       <div class="flex items-center justify-between">
                         <div class="text-gold font-bold">${gacha.cost} coins</div>
                         <button onclick="pullGacha('${gacha.id}')" 
                                 class="px-4 py-2 rounded-lg transition-colors ${userCurrency >= gacha.cost ? 'bg-iris hover:bg-iris/80 text-white' : 'bg-muted/20 text-muted cursor-not-allowed'}">
                           ${userCurrency >= gacha.cost ? 'Pull!' : 'Insufficient Funds'}
                         </button>
                       </div>
                     </div>
                   `).join('')}
                 </div>
               </div>

               <!-- Pet Management Section -->
               <div id="shop-petmanagement" class="shop-section hidden">
                 <h3 class="text-2xl font-bold text-text mb-6">Pet Management</h3>
                 <p class="text-muted mb-6">Level up your pets, create fusions, and manage your collection!</p>
                 
                 ${userPets.length > 0 ? `
                   <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                     ${userPets.map(petId => {
                       const pet = pets.find(p => p.id === petId);
                       const petData = userPetData[petId] || { level: 1, xp: 0, battles: 0 };
                       const maxXp = petData.level * 100;
                       const power = pet.basePower + (petData.level - 1) * 10;
                       const levelUpCost = petData.level * 50;
                       
                       return `
                         <div class="bg-highlight-med rounded-xl p-6 border border-overlay">
                           <div class="flex items-center justify-between mb-4">
                             <div class="text-4xl">${pet.emoji}</div>
                             <div class="text-right">
                               <div class="text-lg font-bold text-text">Level ${petData.level}</div>
                               <div class="text-sm text-muted">Power: ${power}</div>
                             </div>
                           </div>
                           <h4 class="text-lg font-semibold text-text mb-2">${pet.name}</h4>
                           
                           <!-- XP Bar -->
                           <div class="mb-4">
                             <div class="flex justify-between text-xs text-muted mb-1">
                               <span>XP: ${petData.xp}/${maxXp}</span>
                               <span>Battles: ${petData.battles}</span>
                             </div>
                             <div class="w-full bg-overlay rounded-full h-2">
                               <div class="bg-foam h-2 rounded-full transition-all duration-300" style="width: ${(petData.xp / maxXp) * 100}%"></div>
                             </div>
                           </div>
                           
                           <div class="space-y-2">
                             <button onclick="levelUpPet('${petId}')" 
                                     class="w-full px-4 py-2 rounded-lg transition-colors ${userCurrency >= levelUpCost ? 'bg-gold hover:bg-gold/80 text-base' : 'bg-muted/20 text-muted cursor-not-allowed'} text-sm">
                               Level Up (${levelUpCost} coins)
                             </button>
                             <button onclick="battleWithPet('${petId}')" 
                                     class="w-full px-4 py-2 bg-love hover:bg-love/80 text-white rounded-lg transition-colors text-sm">
                               Battle Training (+XP)
                             </button>
                           </div>
                         </div>
                       `;
                     }).join('')}
                   </div>
                   
                   <!-- Fusion Section -->
                   <div class="bg-highlight-med rounded-xl p-6 border border-overlay mb-6">
                     <h4 class="text-xl font-bold text-text mb-4 flex items-center gap-2">
                       <i class="bx bx-dna text-iris"></i>
                       Pet Fusion Laboratory
                     </h4>
                     <p class="text-muted mb-4">Combine two pets to create powerful fusion creatures!</p>
                     
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                       <div>
                         <label class="block text-sm font-medium text-text mb-2">Pet 1</label>
                         <select id="fusionPet1" class="w-full px-3 py-2 bg-overlay border border-highlight-med rounded-lg text-text">
                           <option value="">Select first pet...</option>
                           ${userPets.map(petId => {
                             const pet = pets.find(p => p.id === petId);
                             return `<option value="${petId}">${pet.emoji} ${pet.name}</option>`;
                           }).join('')}
                         </select>
                       </div>
                       <div>
                         <label class="block text-sm font-medium text-text mb-2">Pet 2</label>
                         <select id="fusionPet2" class="w-full px-3 py-2 bg-overlay border border-highlight-med rounded-lg text-text">
                           <option value="">Select second pet...</option>
                           ${userPets.map(petId => {
                             const pet = pets.find(p => p.id === petId);
                             return `<option value="${petId}">${pet.emoji} ${pet.name}</option>`;
                           }).join('')}
                         </select>
                       </div>
                       <div>
                         <label class="block text-sm font-medium text-text mb-2">Action</label>
                         <button onclick="attemptFusion()" class="w-full px-4 py-2 bg-iris hover:bg-iris/80 text-white rounded-lg transition-colors">
                           Fuse Pets (500 coins)
                         </button>
                       </div>
                     </div>
                     
                     <div id="fusionPreview" class="text-center py-4 text-muted">
                       Select two pets to see fusion preview
                     </div>
                   </div>
                 ` : `
                   <div class="text-center py-12">
                     <i class="bx bx-heart text-6xl text-muted mb-4"></i>
                     <h4 class="text-xl font-semibold text-text mb-2">No Pets Adopted</h4>
                     <p class="text-muted mb-4">Adopt pets from the Digital Pets section to start managing them!</p>
                     <button onclick="showShopSection('pets')" class="px-6 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium">
                       Adopt Pets
                     </button>
                   </div>
                 `}
               </div>

               <!-- Badges Section -->
               <div id="shop-badges" class="shop-section hidden">
                 <h3 class="text-2xl font-bold text-text mb-6">Badges & Trophies</h3>
                 <p class="text-muted mb-6">Earn badges by completing achievements and show off your accomplishments!</p>
                 
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                   ${petBadges.map(badge => {
                     const earned = userBadges.includes(badge.id);
                     return `
                       <div class="bg-highlight-med rounded-xl p-6 border border-overlay ${earned ? 'border-gold' : ''}">
                         <div class="w-full h-32 rounded-lg mb-4 flex items-center justify-center ${earned ? 'bg-gold/20' : 'bg-muted/10'}">
                           <div class="text-6xl ${earned ? 'animate-pulse' : 'grayscale opacity-50'}">${badge.icon}</div>
                         </div>
                         <h4 class="text-lg font-semibold text-text mb-2">${badge.name}</h4>
                         <p class="text-sm text-muted mb-4">${badge.description}</p>
                         <div class="flex items-center justify-between">
                           <div class="text-gold font-bold">+${badge.reward} coins</div>
                           <div class="px-3 py-1 rounded-full text-xs font-bold ${earned ? 'bg-gold/20 text-gold' : 'bg-muted/20 text-muted'}">
                             ${earned ? 'EARNED' : 'LOCKED'}
                           </div>
                         </div>
                       </div>
                     `;
                   }).join('')}
                 </div>
               </div>

               <!-- Multiplayer Games Section -->
               <div id="shop-multiplayer" class="shop-section hidden">
                 <h3 class="text-2xl font-bold text-text mb-6">2-Player Games</h3>
                 <p class="text-muted mb-6">Challenge friends to real-time multiplayer games using Firebase!</p>
                 
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                   <div class="bg-highlight-med rounded-xl p-6 border border-overlay">
                     <div class="w-full h-32 bg-gradient-to-br from-love/20 to-gold/20 rounded-lg mb-4 flex items-center justify-center">
                       <i class="bx bx-grid-alt text-4xl text-love"></i>
                     </div>
                     <h4 class="text-lg font-semibold text-text mb-2">Tic Tac Toe</h4>
                     <p class="text-sm text-muted mb-4">Classic strategy game for two players</p>
                     <button onclick="startMultiplayerGame('tictactoe')" class="w-full px-4 py-2 bg-love hover:bg-love/80 text-white rounded-lg transition-colors">
                       Start Game
                     </button>
                   </div>
                   
                   <div class="bg-highlight-med rounded-xl p-6 border border-overlay">
                     <div class="w-full h-32 bg-gradient-to-br from-iris/20 to-foam/20 rounded-lg mb-4 flex items-center justify-center">
                       <i class="bx bx-circle text-4xl text-iris"></i>
                     </div>
                     <h4 class="text-lg font-semibold text-text mb-2">Connect Four</h4>
                     <p class="text-sm text-muted mb-4">Drop tokens to get four in a row</p>
                     <button onclick="startMultiplayerGame('connect4')" class="w-full px-4 py-2 bg-iris hover:bg-iris/80 text-white rounded-lg transition-colors">
                       Start Game
                     </button>
                   </div>
                 </div>
               </div>

               <div id="shop-minigames" class="shop-section hidden">
                <h3 class="text-2xl font-bold text-text mb-6">Mini Games</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  ${miniGames.map(game => `
                    <div class="bg-highlight-med rounded-xl p-6 border border-overlay">
                      <div class="w-full h-32 bg-gradient-to-br from-foam/20 to-iris/20 rounded-lg mb-4 flex items-center justify-center">
                        <i class="bx bx-${game.id === 'clicker' ? 'mouse' : game.id === 'memory' ? 'brain' : game.id === 'reaction' ? 'time' : game.id === 'blackjack' ? 'card' : game.id === 'roulette' ? 'circle' : 'game'} text-4xl text-foam"></i>
                      </div>
                      <h4 class="text-lg font-semibold text-text mb-2">${game.name}</h4>
                      <p class="text-sm text-muted mb-4">${game.description}</p>
                      <div class="flex items-center justify-between">
                        <div class="text-foam">Earn up to <span class="text-gold font-bold">${game.reward}</span> coins</div>
                        <button onclick="playMiniGame('${game.id}')" class="px-4 py-2 bg-foam hover:bg-foam/80 text-base rounded-lg transition-colors">
                          Play
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(shopModal);
        window.currentShopModal = shopModal;
      }
      
      window.closeShop = function() {
        // Clean up any waiting game rooms when closing the shop
        if (currentGameRoom) {
          db.collection('game-rooms').doc(currentGameRoom).get().then(doc => {
            if (doc.exists) {
              const gameRoom = doc.data();
              // Only clean up if we're the host and the game is still waiting
              if (gameRoom.hostId === currentUser.uid && gameRoom.status === 'waiting') {
                console.log('Cleaning up waiting room on shop close:', currentGameRoom);
                db.collection('game-rooms').doc(currentGameRoom).delete();
              }
            }
          }).catch(error => {
            console.error('Error cleaning up room on shop close:', error);
          });
          
          // Clear listeners
          if (gameListener) {
            gameListener();
            gameListener = null;
          }
          
          currentGameRoom = null;
        }
        
        // Close any open game modals
        if (window.currentGameModal) {
          window.currentGameModal.remove();
          window.currentGameModal = null;
        }
        
        if (window.currentShopModal) {
          window.currentShopModal.remove();
          window.currentShopModal = null;
        }
      };
      
      window.showShopSection = function(section) {
        document.querySelectorAll('.shop-section').forEach(s => s.classList.add('hidden'));
        document.querySelectorAll('.shop-nav-btn').forEach(btn => {
          btn.classList.remove('bg-foam/20', 'text-foam');
          btn.classList.add('hover:bg-highlight-med', 'text-text');
        });
        
        document.getElementById(`shop-${section}`).classList.remove('hidden');
        event.target.classList.add('bg-foam/20', 'text-foam');
        event.target.classList.remove('hover:bg-highlight-med', 'text-text');
      };
      
      window.purchaseFrame = function(frameId) {
        const frame = gameFrames.find(f => f.id === frameId);
        if (!frame || userFrames.includes(frameId) || userCurrency < frame.price) return;
        
        userCurrency -= frame.price;
        userFrames.push(frameId);
        
        updateCurrencyDisplay();
        saveCurrencyToStorage();
        saveFramesToStorage();
        
        // Refresh shop display
        closeShop();
        openCarbonShop();
        
        // Show success notification
        showNotification('Purchase Successful!', `You've unlocked the ${frame.name} frame!`, 'success');
      };

      window.purchasePet = function(petId) {
        const pet = pets.find(p => p.id === petId);
        if (!pet || userPets.includes(petId) || userCurrency < pet.price) return;
        
        userCurrency -= pet.price;
        userPets.push(petId);
        
        // Initialize pet data
        if (!userPetData[petId]) {
          userPetData[petId] = { level: 1, xp: 0, battles: 0 };
        }
        
        updateCurrencyDisplay();
        saveCurrencyToStorage();
        savePetsToStorage();
        savePetDataToStorage();
        
        // Check badges
        checkBadges();
        
        // Refresh shop display
        closeShop();
        openCarbonShop();
        
        // Show success notification
        showNotification('Pet Adopted!', `You've adopted ${pet.name} ${pet.emoji}!`, 'success');
      };

      window.purchaseProfileFrame = function(frameId) {
        const frame = profileFrames.find(f => f.id === frameId);
        if (!frame || userProfileFrames.includes(frameId) || userCurrency < frame.price) return;
        
        userCurrency -= frame.price;
        userProfileFrames.push(frameId);
        
        updateCurrencyDisplay();
        saveCurrencyToStorage();
        saveProfileFramesToStorage();
        
        // Refresh shop display
        closeShop();
        openCarbonShop();
        
        // Show success notification
        showNotification('Frame Unlocked!', `You've unlocked the ${frame.name}!`, 'success');
      };

      window.selectProfileFrame = function(frameId) {
        window.carbonProfileFrames.setActiveFrame(frameId);
        
        // Apply to current page
        window.carbonProfileFrames.applyActiveFrame();
        
        // Send frame update to other pages
        const gameIframes = document.querySelectorAll('iframe[src*="play.html"], iframe[src*="profile.html"], iframe[src*="games.html"]');
        gameIframes.forEach(iframe => {
          iframe.contentWindow.postMessage({
            type: 'carbon-profile-frame-update',
            frameId: frameId,
            frameData: frameId === 'default' ? null : profileFrames.find(f => f.id === frameId)
          }, '*');
        });
        
        // Save to Firebase
        saveFramesToFirebase();
        
        showNotification('Profile Frame Selected', `${frameId === 'default' ? 'Default' : profileFrames.find(f => f.id === frameId)?.name} profile frame is now active!`, 'success');
        
        // Refresh shop to show selection
        closeShop();
        setTimeout(() => openCarbonShop(), 100);
      };
      
             window.playMiniGame = function(gameId) {
         closeShop();
         
         switch(gameId) {
           case 'clicker':
             playClickerGame();
             break;
           case 'memory':
             playMemoryGame();
             break;
           case 'reaction':
             playReactionGame();
             break;
           case 'blackjack':
             playBlackjackGame();
             break;
           case 'roulette':
             playRouletteGame();
             break;
         }
       };
       
       window.selectFrame = function(frameId) {
         window.carbonFrames.setActiveFrame(frameId);
         
         // Send frame update to play.html iframe
         const gameIframes = document.querySelectorAll('iframe[src*="play.html"]');
         gameIframes.forEach(iframe => {
           iframe.contentWindow.postMessage({
             type: 'carbon-frame-update',
             frameId: frameId,
             frameData: frameId === 'default' ? null : gameFrames.find(f => f.id === frameId)
           }, '*');
         });
         
         // Save to Firebase
         saveFramesToFirebase();
         
         showNotification('Frame Selected', `${frameId === 'default' ? 'Default' : gameFrames.find(f => f.id === frameId)?.name} frame is now active!`, 'success');
         
         // Refresh shop to show selection
         closeShop();
         setTimeout(() => openCarbonShop(), 100);
       };

       window.openLootBox = function(boxId) {
         const box = lootBoxes.find(b => b.id === boxId);
         if (!box || userCurrency < box.price) return;
         
         // Check daily mystery box restriction
         if (box.isDaily) {
           const today = new Date().toDateString();
           const lastUsed = localStorage.getItem('carbon-daily-mystery-date');
           
           if (lastUsed === today) {
             showNotification('Daily Limit Reached', 'You can only open one Daily Mystery Box per day!', 'warning');
             return;
           }
           
           localStorage.setItem('carbon-daily-mystery-date', today);
         }
         
         // Deduct cost
         userCurrency -= box.price;
         saveCurrencyToStorage();
         
         // Generate rewards
         const rewards = box.rewards.random ? generateRandomReward() : generateLootBoxRewards(box);
         
         // Add rewards to user
         userCurrency += rewards.currency;
         rewards.frames?.forEach(frameId => {
           if (!userFrames.includes(frameId)) {
             userFrames.push(frameId);
           }
         });
         rewards.pets?.forEach(petId => {
           if (!userPets.includes(petId)) {
             userPets.push(petId);
             if (!userPetData[petId]) {
               userPetData[petId] = { level: 1, xp: 0, battles: 0 };
             }
             checkBadges();
           }
         });
         rewards.profileFrames?.forEach(frameId => {
           if (!userProfileFrames.includes(frameId)) {
             userProfileFrames.push(frameId);
           }
         });
         
         saveCurrencyToStorage();
         saveFramesToStorage();
         savePetsToStorage();
         saveProfileFramesToStorage();
         savePetDataToStorage();
         updateCurrencyDisplay();
         
         // Show rewards modal
         showLootBoxRewards(box, rewards);
         
         // Close shop and reopen to refresh
         closeShop();
         setTimeout(() => openCarbonShop(), 2000);
       };

       function generateRandomReward() {
         const rewards = {
           currency: Math.floor(Math.random() * 400) + 100,
           frames: [],
           pets: [],
           profileFrames: [],
           special: null
         };
         
         // Random chance for different reward types
         const rand = Math.random();
         
         if (rand < 0.3) {
           // 30% chance for pet
           const availablePets = pets.filter(p => !p.fusion && !userPets.includes(p.id));
           if (availablePets.length > 0) {
             rewards.pets.push(availablePets[Math.floor(Math.random() * availablePets.length)].id);
           }
         } else if (rand < 0.6) {
           // 30% chance for game frame
           const availableFrames = gameFrames.filter(f => !userFrames.includes(f.id));
           if (availableFrames.length > 0) {
             rewards.frames.push(availableFrames[Math.floor(Math.random() * availableFrames.length)].id);
           }
         } else if (rand < 0.85) {
           // 25% chance for profile frame
           const availableProfileFrames = profileFrames.filter(f => !userProfileFrames.includes(f.id));
           if (availableProfileFrames.length > 0) {
             rewards.profileFrames.push(availableProfileFrames[Math.floor(Math.random() * availableProfileFrames.length)].id);
           }
         }
         
         // 25% chance for special bonus
         if (Math.random() < 0.25) {
           const bonusCurrency = Math.floor(rewards.currency * 0.5);
           rewards.currency += bonusCurrency;
           rewards.special = `Mystery Bonus: +${bonusCurrency} coins!`;
         }
         
         return rewards;
       }
       
       function generateLootBoxRewards(box) {
         const rewards = {
           currency: Math.floor(Math.random() * (box.rewards.currency.max - box.rewards.currency.min + 1)) + box.rewards.currency.min,
           frames: [],
           special: null
         };
         
         // Generate frames based on box type
         const availableFrames = gameFrames.filter(f => !userFrames.includes(f.id));
         
         if (box.rewards.frames > 0 && availableFrames.length > 0) {
           const frameCount = Math.min(box.rewards.frames, availableFrames.length);
           
           for (let i = 0; i < frameCount; i++) {
             let selectedFrame;
             
             if (box.rarity === 'legendary') {
               // Legendary boxes can give any frame, prefer expensive ones
               selectedFrame = availableFrames.sort((a, b) => b.price - a.price)[Math.floor(Math.random() * Math.min(3, availableFrames.length))];
             } else if (box.rarity === 'epic') {
               // Epic boxes prefer mid-tier frames
               const midTierFrames = availableFrames.filter(f => f.price >= 750);
               selectedFrame = midTierFrames.length > 0 ? 
                 midTierFrames[Math.floor(Math.random() * midTierFrames.length)] :
                 availableFrames[Math.floor(Math.random() * availableFrames.length)];
             } else if (box.rarity === 'rare') {
               // Rare boxes give lower-tier frames
               const lowerTierFrames = availableFrames.filter(f => f.price <= 1000);
               selectedFrame = lowerTierFrames.length > 0 ?
                 lowerTierFrames[Math.floor(Math.random() * lowerTierFrames.length)] :
                 availableFrames[Math.floor(Math.random() * availableFrames.length)];
             }
             
             if (selectedFrame) {
               rewards.frames.push(selectedFrame.id);
               availableFrames.splice(availableFrames.indexOf(selectedFrame), 1);
             }
           }
         }
         
         // Special item chance
         if (Math.random() * 100 < box.rewards.special) {
           const bonusCurrency = Math.floor(rewards.currency * 0.5);
           rewards.currency += bonusCurrency;
           rewards.special = `Bonus ${bonusCurrency} coins!`;
         }
         
         return rewards;
       }
       
       function showLootBoxRewards(box, rewards) {
         const modal = document.createElement('div');
         modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999]';
         
         const frameNames = rewards.frames.map(frameId => {
           const frame = gameFrames.find(f => f.id === frameId);
           return frame ? frame.name : frameId;
         });
         
         modal.innerHTML = `
           <div class="bg-surface border-2 rounded-xl shadow-2xl max-w-md w-[90vw] p-6 text-center" style="border-color: ${box.borderColor};">
             <div class="mb-6">
               <div class="w-24 h-24 mx-auto mb-4 rounded-lg flex items-center justify-center" style="background: ${box.gradient};">
                 <i class="bx bx-package-open text-4xl text-white"></i>
               </div>
               <h2 class="text-2xl font-bold text-text mb-2">${box.name} Opened!</h2>
               <p class="text-muted">Here's what you found:</p>
             </div>
             
             <div class="space-y-3 mb-6">
               <div class="bg-highlight-med rounded-lg p-3">
                 <div class="flex items-center justify-center gap-2">
                   <i class="bx bx-coin text-gold text-xl"></i>
                   <span class="text-lg font-semibold text-gold">${rewards.currency} Carbon Coins</span>
                 </div>
               </div>
               
               ${rewards.frames && rewards.frames.length > 0 ? `
                 <div class="bg-highlight-med rounded-lg p-3">
                   <div class="flex items-center justify-center gap-2 mb-2">
                     <i class="bx bx-image text-foam text-xl"></i>
                     <span class="text-lg font-semibold text-text">New Game Frames!</span>
                   </div>
                   <div class="text-sm text-foam">${frameNames.join(', ')}</div>
                 </div>
               ` : ''}
               
               ${rewards.pets && rewards.pets.length > 0 ? `
                 <div class="bg-highlight-med rounded-lg p-3">
                   <div class="flex items-center justify-center gap-2 mb-2">
                     <i class="bx bx-heart text-iris text-xl"></i>
                     <span class="text-lg font-semibold text-text">New Pets!</span>
                   </div>
                   <div class="text-sm text-iris">${rewards.pets.map(petId => {
                     const pet = pets.find(p => p.id === petId);
                     return pet ? `${pet.emoji} ${pet.name}` : petId;
                   }).join(', ')}</div>
                 </div>
               ` : ''}
               
               ${rewards.profileFrames && rewards.profileFrames.length > 0 ? `
                 <div class="bg-highlight-med rounded-lg p-3">
                   <div class="flex items-center justify-center gap-2 mb-2">
                     <i class="bx bx-user text-love text-xl"></i>
                     <span class="text-lg font-semibold text-text">New Profile Frames!</span>
                   </div>
                   <div class="text-sm text-love">${rewards.profileFrames.map(frameId => {
                     const frame = profileFrames.find(f => f.id === frameId);
                     return frame ? frame.name : frameId;
                   }).join(', ')}</div>
                 </div>
               ` : ''}
               
               ${rewards.special ? `
                 <div class="bg-highlight-med rounded-lg p-3">
                   <div class="flex items-center justify-center gap-2">
                     <i class="bx bx-star text-gold text-xl"></i>
                     <span class="text-lg font-semibold text-gold">${rewards.special}</span>
                   </div>
                 </div>
               ` : ''}
             </div>
             
             <button onclick="this.parentElement.parentElement.remove()" 
                     class="w-full px-6 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium transition-colors">
               Awesome!
             </button>
           </div>
         `;
         
         document.body.appendChild(modal);
         
         // Auto-remove after 10 seconds
         setTimeout(() => {
           if (modal.parentNode) modal.remove();
         }, 10000);
       };
      
      function updateCurrencyDisplay() {
        const currencyEl = document.getElementById('shop-currency');
        if (currencyEl) currencyEl.textContent = userCurrency;
      }
      
      function saveCurrencyToStorage() {
        localStorage.setItem('carbon-currency', userCurrency.toString());
        if (currentUser && shopDataLoaded) {
          saveShopDataToFirebase();
        }
      }
      
              function saveFramesToStorage() {
          localStorage.setItem('carbon-frames', JSON.stringify(userFrames));
          if (currentUser && shopDataLoaded) {
            saveShopDataToFirebase();
          }
        }

              function savePetsToStorage() {
          localStorage.setItem('carbon-pets', JSON.stringify(userPets));
          if (currentUser && shopDataLoaded) {
            saveShopDataToFirebase();
          }
        }

              function saveProfileFramesToStorage() {
          localStorage.setItem('carbon-profile-frames', JSON.stringify(userProfileFrames));
          if (currentUser && shopDataLoaded) {
            saveShopDataToFirebase();
          }
        }

              function savePetDataToStorage() {
          localStorage.setItem('carbon-pet-data', JSON.stringify(userPetData));
          if (currentUser && shopDataLoaded) {
            saveShopDataToFirebase();
          }
        }

              function saveBadgesToStorage() {
          localStorage.setItem('carbon-badges', JSON.stringify(userBadges));
          if (currentUser && shopDataLoaded) {
            saveShopDataToFirebase();
          }
        }

      // Gacha system functions
      window.pullGacha = function(gachaId) {
        const gacha = gachaTypes.find(g => g.id === gachaId);
        if (!gacha || userCurrency < gacha.cost) return;
        
        userCurrency -= gacha.cost;
        saveCurrencyToStorage();
        
        // Generate random item based on rates
        const rand = Math.random() * 100;
        let rarity = 'common';
        let cumulative = 0;
        
        for (const [rarityLevel, rate] of Object.entries(gacha.rates)) {
          cumulative += rate;
          if (rand <= cumulative) {
            rarity = rarityLevel;
            break;
          }
        }
        
        // Give reward based on rarity
        const rewards = generateGachaReward(rarity);
        
        // Apply rewards
        userCurrency += rewards.currency || 0;
        if (rewards.frame && !userFrames.includes(rewards.frame)) {
          userFrames.push(rewards.frame);
        }
        if (rewards.pet && !userPets.includes(rewards.pet)) {
          userPets.push(rewards.pet);
        }
        if (rewards.profileFrame && !userProfileFrames.includes(rewards.profileFrame)) {
          userProfileFrames.push(rewards.profileFrame);
        }
        
        updateCurrencyDisplay();
        saveCurrencyToStorage();
        saveFramesToStorage();
        savePetsToStorage();
        saveProfileFramesToStorage();
        
        showGachaResults(gacha, rarity, rewards);
        
        closeShop();
        setTimeout(() => openCarbonShop(), 2000);
      };

      function generateGachaReward(rarity) {
        const rewards = {};
        
        switch(rarity) {
          case 'common':
            rewards.currency = Math.floor(Math.random() * 100) + 50;
            break;
          case 'rare':
            rewards.currency = Math.floor(Math.random() * 200) + 150;
            if (Math.random() < 0.3) {
              const availablePets = pets.filter(p => p.rarity === 'common' && !userPets.includes(p.id));
              if (availablePets.length > 0) {
                rewards.pet = availablePets[Math.floor(Math.random() * availablePets.length)].id;
              }
            }
            break;
          case 'epic':
            rewards.currency = Math.floor(Math.random() * 300) + 250;
            const availableFrames = gameFrames.filter(f => !userFrames.includes(f.id));
            if (availableFrames.length > 0) {
              rewards.frame = availableFrames[Math.floor(Math.random() * availableFrames.length)].id;
            }
            break;
          case 'legendary':
            rewards.currency = Math.floor(Math.random() * 500) + 500;
            const legendaryPets = pets.filter(p => p.rarity === 'legendary' && !userPets.includes(p.id));
            if (legendaryPets.length > 0) {
              rewards.pet = legendaryPets[Math.floor(Math.random() * legendaryPets.length)].id;
            }
            const expensiveFrames = gameFrames.filter(f => f.price >= 1000 && !userFrames.includes(f.id));
            if (expensiveFrames.length > 0) {
              rewards.frame = expensiveFrames[Math.floor(Math.random() * expensiveFrames.length)].id;
            }
            break;
        }
        
        return rewards;
      }

      function showGachaResults(gacha, rarity, rewards) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999]';
        
        const rarityColors = {
          common: '#6b7280',
          rare: '#3b82f6', 
          epic: '#a855f7',
          legendary: '#f59e0b'
        };
        
        modal.innerHTML = `
          <div class="bg-surface border-2 rounded-xl shadow-2xl max-w-md w-[90vw] p-6 text-center" style="border-color: ${rarityColors[rarity]};">
            <div class="mb-6">
              <div class="w-24 h-24 mx-auto mb-4 rounded-lg flex items-center justify-center animate-pulse" style="background: ${rarityColors[rarity]}30;">
                <i class="bx bx-dice-6 text-4xl" style="color: ${rarityColors[rarity]};"></i>
              </div>
              <h2 class="text-2xl font-bold text-text mb-2">${rarity.toUpperCase()} PULL!</h2>
              <p class="text-muted">Here's what you got:</p>
            </div>
            
            <div class="space-y-3 mb-6">
              ${rewards.currency ? `
                <div class="bg-highlight-med rounded-lg p-3">
                  <div class="flex items-center justify-center gap-2">
                    <i class="bx bx-coin text-gold text-xl"></i>
                    <span class="text-lg font-semibold text-gold">${rewards.currency} Carbon Coins</span>
                  </div>
                </div>
              ` : ''}
              
              ${rewards.frame ? `
                <div class="bg-highlight-med rounded-lg p-3">
                  <div class="flex items-center justify-center gap-2">
                    <i class="bx bx-image text-foam text-xl"></i>
                    <span class="text-lg font-semibold text-text">New Frame: ${gameFrames.find(f => f.id === rewards.frame)?.name}!</span>
                  </div>
                </div>
              ` : ''}
              
              ${rewards.pet ? `
                <div class="bg-highlight-med rounded-lg p-3">
                  <div class="flex items-center justify-center gap-2">
                    <span class="text-2xl">${pets.find(p => p.id === rewards.pet)?.emoji}</span>
                    <span class="text-lg font-semibold text-text">New Pet: ${pets.find(p => p.id === rewards.pet)?.name}!</span>
                  </div>
                </div>
              ` : ''}
              
              ${rewards.profileFrame ? `
                <div class="bg-highlight-med rounded-lg p-3">
                  <div class="flex items-center justify-center gap-2">
                    <i class="bx bx-user text-iris text-xl"></i>
                    <span class="text-lg font-semibold text-text">New Profile Frame: ${profileFrames.find(f => f.id === rewards.profileFrame)?.name}!</span>
                  </div>
                </div>
              ` : ''}
            </div>
            
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="w-full px-6 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg font-medium transition-colors">
              Amazing!
            </button>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        setTimeout(() => {
          if (modal.parentNode) modal.remove();
        }, 10000);
      }

      // Pet management functions
      window.levelUpPet = function(petId) {
        const pet = pets.find(p => p.id === petId);
        const petData = userPetData[petId] || { level: 1, xp: 0, battles: 0 };
        const levelUpCost = petData.level * 50;
        
        if (!pet || userCurrency < levelUpCost) return;
        
        userCurrency -= levelUpCost;
        petData.level += 1;
        petData.xp = 0;
        userPetData[petId] = petData;
        
        updateCurrencyDisplay();
        saveCurrencyToStorage();
        savePetDataToStorage();
        
        showNotification('Level Up!', `${pet.name} is now level ${petData.level}!`, 'success');
        
        // Check for level master badge
        if (petData.level >= 10 && !userBadges.includes('level-master')) {
          earnBadge('level-master');
        }
        
        closeShop();
        setTimeout(() => {
          openCarbonShop();
          showShopSection('petmanagement');
        }, 100);
      };

      window.battleWithPet = function(petId) {
        const pet = pets.find(p => p.id === petId);
        const petData = userPetData[petId] || { level: 1, xp: 0, battles: 0 };
        
        // Random XP gain from battle (20-50 XP)
        const xpGain = Math.floor(Math.random() * 31) + 20;
        petData.xp += xpGain;
        petData.battles += 1;
        
        // Level up if enough XP
        const maxXp = petData.level * 100;
        if (petData.xp >= maxXp) {
          petData.level += 1;
          petData.xp = 0;
          showNotification('Level Up!', `${pet.name} leveled up to ${petData.level}!`, 'success');
          
          // Check for level master badge
          if (petData.level >= 10 && !userBadges.includes('level-master')) {
            earnBadge('level-master');
          }
        } else {
          showNotification('Training Complete!', `${pet.name} gained ${xpGain} XP!`, 'success');
        }
        
        userPetData[petId] = petData;
        savePetDataToStorage();
        
        // Check for battle veteran badge
        const totalBattles = Object.values(userPetData).reduce((sum, data) => sum + (data.battles || 0), 0);
        if (totalBattles >= 10 && !userBadges.includes('battle-veteran')) {
          earnBadge('battle-veteran');
        }
        
        closeShop();
        setTimeout(() => {
          openCarbonShop();
          showShopSection('petmanagement');
        }, 100);
      };

      window.attemptFusion = function() {
        const pet1Id = document.getElementById('fusionPet1')?.value;
        const pet2Id = document.getElementById('fusionPet2')?.value;
        
        if (!pet1Id || !pet2Id || pet1Id === pet2Id || userCurrency < 500) {
          showNotification('Fusion Failed', 'Select two different pets and ensure you have 500 coins!', 'error');
          return;
        }
        
        // Check if a fusion recipe exists
        const fusionPet = pets.find(p => p.fusion && 
          p.fusion.includes(pet1Id) && p.fusion.includes(pet2Id));
        
        if (!fusionPet) {
          showNotification('Fusion Failed', 'These pets cannot be fused together!', 'error');
          return;
        }
        
        if (userPets.includes(fusionPet.id)) {
          showNotification('Fusion Failed', 'You already own this fusion pet!', 'error');
          return;
        }
        
        // Perform fusion
        userCurrency -= 500;
        userPets.push(fusionPet.id);
        
        // Initialize fusion pet with higher level
        const pet1Data = userPetData[pet1Id] || { level: 1 };
        const pet2Data = userPetData[pet2Id] || { level: 1 };
        const fusionLevel = Math.floor((pet1Data.level + pet2Data.level) / 2) + 1;
        
        userPetData[fusionPet.id] = {
          level: fusionLevel,
          xp: 0,
          battles: 0
        };
        
        updateCurrencyDisplay();
        saveCurrencyToStorage();
        savePetsToStorage();
        savePetDataToStorage();
        
        showNotification('Fusion Success!', `Created ${fusionPet.name} at level ${fusionLevel}!`, 'success');
        
        // Check for fusion expert badge
        if (!userBadges.includes('fusion-expert')) {
          earnBadge('fusion-expert');
        }
        
        closeShop();
        setTimeout(() => {
          openCarbonShop();
          showShopSection('petmanagement');
        }, 100);
      };

      function earnBadge(badgeId) {
        const badge = petBadges.find(b => b.id === badgeId);
        if (!badge || userBadges.includes(badgeId)) return;
        
        userBadges.push(badgeId);
        userCurrency += badge.reward;
        
        updateCurrencyDisplay();
        saveCurrencyToStorage();
        saveBadgesToStorage();
        
        showNotification('Badge Earned!', `${badge.icon} ${badge.name} - Earned ${badge.reward} coins!`, 'success');
      }

      // Check badges on various actions
      function checkBadges() {
        // First pet badge
        if (userPets.length >= 1 && !userBadges.includes('first-pet')) {
          earnBadge('first-pet');
        }
        
        // Pet collector badge
        if (userPets.length >= 5 && !userBadges.includes('pet-collector')) {
          earnBadge('pet-collector');
        }
        
        // Rare collector badge
        const legendaryPets = userPets.filter(petId => {
          const pet = pets.find(p => p.id === petId);
          return pet && pet.rarity === 'legendary';
        });
        if (legendaryPets.length >= 3 && !userBadges.includes('rare-collector')) {
          earnBadge('rare-collector');
        }
      }

             // Multiplayer games
       let currentGameRoom = null;
       let gameListener = null;
       let winnerScreenShown = false;
      
             window.startMultiplayerGame = function(gameType) {
         if (!currentUser) {
           showNotification('Sign In Required', 'Please sign in to play multiplayer games!', 'error');
           return;
         }
         
         console.log('Starting multiplayer game:', gameType, 'for user:', currentUser.uid);
         
         closeShop();
         createGameLobby(gameType);
       };

                    async function createGameLobby(gameType) {
         try {
           winnerScreenShown = false;
           
           // Create a new game room
           const gameRoom = {
             gameType: gameType,
             hostId: currentUser.uid,
             hostName: currentUser.displayName || 'Anonymous',
             hostPhoto: currentUser.photoURL || '',
             guestId: null,
             guestName: null,
             guestPhoto: null,
             status: 'waiting', // waiting, playing, completed
             gameState: gameType === 'tictactoe' ? initTicTacToeState() : initConnect4State(),
             winner: null,
             createdAt: firebase.firestore.FieldValue.serverTimestamp(),
             lastActivity: firebase.firestore.FieldValue.serverTimestamp()
           };

                      console.log('Creating game room:', gameRoom);
           
           if (gameType === 'connect4') {
             console.log('Connect 4 board structure:', gameRoom.gameState.board);
             console.log('Board length:', gameRoom.gameState.board.length);
             
             // Test helper functions
             console.log('Testing Connect 4 helpers:');
             console.log('Position (0,0) index:', getConnect4Index(0, 0), 'should be 0');
             console.log('Position (5,6) index:', getConnect4Index(5, 6), 'should be 41');
             console.log('Index 0 coords:', getConnect4RowCol(0), 'should be {row:0, col:0}');
             console.log('Index 41 coords:', getConnect4RowCol(41), 'should be {row:5, col:6}');
           }

          const docRef = await db.collection('game-rooms').add(gameRoom);
           currentGameRoom = docRef.id;
           
           console.log('Game room created successfully with ID:', docRef.id);
           
           showGameLobby(gameRoom, docRef.id, true);
           listenToGameRoom(docRef.id);
          
        } catch (error) {
          console.error('Error creating game room:', error);
          showNotification('Error', 'Failed to create game room!', 'error');
        }
      }

      function initTicTacToeState() {
        return {
          board: Array(9).fill(null),
          currentPlayer: 'X'
        };
      }

      function initConnect4State() {
        return {
          board: Array(42).fill(null), // Flattened 6x7 grid (6*7=42)
          currentPlayer: 'red'
        };
      }

      function showGameLobby(gameRoom, roomId, isHost) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[9999]';
        modal.id = 'gameModal';
        
        const gameTitle = gameRoom.gameType === 'tictactoe' ? 'Tic Tac Toe' : 'Connect Four';
        const gameIcon = gameRoom.gameType === 'tictactoe' ? 'bx-grid-alt' : 'bx-circle';
        
        modal.innerHTML = `
          <div class="bg-surface border border-highlight-med rounded-xl shadow-2xl max-w-4xl w-[95vw] h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between p-6 border-b border-highlight-med">
              <div class="flex items-center gap-3">
                <i class="bx ${gameIcon} text-3xl text-foam"></i>
                <div>
                  <h2 class="text-2xl font-bold text-text">${gameTitle}</h2>
                  <p class="text-muted">Room ID: ${roomId}</p>
                </div>
              </div>
              <button onclick="leaveGame()" class="text-muted hover:text-love transition-colors">
                <i class="bx bx-x text-2xl"></i>
              </button>
            </div>
            
            <!-- Game Content -->
            <div class="flex-1 flex">
              <!-- Game Area -->
              <div class="flex-1 p-6 flex flex-col items-center justify-center">
                <div id="gameArea">
                  ${gameRoom.status === 'waiting' ? `
                    <div class="text-center">
                      <div class="w-32 h-32 mx-auto mb-6 bg-highlight-med rounded-full flex items-center justify-center">
                        <i class="bx bx-loader-alt text-6xl text-foam animate-spin"></i>
                      </div>
                      <h3 class="text-xl font-bold text-text mb-2">Waiting for Player...</h3>
                      <p class="text-muted mb-4">Share the room ID with a friend to start playing!</p>
                      <div class="flex gap-2 justify-center">
                        <input type="text" value="${roomId}" readonly class="px-3 py-2 bg-overlay border border-highlight-med rounded-lg text-text text-sm font-mono">
                        <button onclick="copyRoomId('${roomId}')" class="px-4 py-2 bg-foam hover:bg-foam/80 text-base rounded-lg transition-colors">
                          <i class="bx bx-copy"></i>
                        </button>
                      </div>
                    </div>
                  ` : '<!-- Game will be rendered here -->'}
                </div>
              </div>
              
              <!-- Players Panel -->
              <div class="w-80 bg-highlight-med/50 p-6 border-l border-highlight-med">
                <h3 class="text-lg font-bold text-text mb-4">Players</h3>
                
                <!-- Host Player -->
                <div class="bg-surface rounded-lg p-4 mb-3">
                  <div class="flex items-center gap-3">
                    <img src="${gameRoom.hostPhoto || 'https://via.placeholder.com/40'}" 
                         class="carbon-profile-avatar w-10 h-10 rounded-full border-2 border-foam">
                    <div class="flex-1">
                      <div class="font-semibold text-text">${gameRoom.hostName}</div>
                      <div class="text-xs text-foam">Host ${gameRoom.gameType === 'tictactoe' ? '(X)' : '(Red)'}</div>
                    </div>
                    ${gameRoom.gameState && gameRoom.gameState.currentPlayer === (gameRoom.gameType === 'tictactoe' ? 'X' : 'red') && gameRoom.status === 'playing' ? 
                      '<div class="w-3 h-3 bg-foam rounded-full animate-pulse"></div>' : ''}
                  </div>
                </div>
                
                <!-- Guest Player -->
                <div class="bg-surface rounded-lg p-4 mb-6">
                  ${gameRoom.guestId ? `
                    <div class="flex items-center gap-3">
                      <img src="${gameRoom.guestPhoto || 'https://via.placeholder.com/40'}" 
                           class="carbon-profile-avatar w-10 h-10 rounded-full border-2 border-love">
                      <div class="flex-1">
                        <div class="font-semibold text-text">${gameRoom.guestName}</div>
                        <div class="text-xs text-love">Guest ${gameRoom.gameType === 'tictactoe' ? '(O)' : '(Blue)'}</div>
                      </div>
                      ${gameRoom.gameState && gameRoom.gameState.currentPlayer === (gameRoom.gameType === 'tictactoe' ? 'O' : 'blue') && gameRoom.status === 'playing' ? 
                        '<div class="w-3 h-3 bg-love rounded-full animate-pulse"></div>' : ''}
                    </div>
                  ` : `
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-full border-2 border-dashed border-muted flex items-center justify-center">
                        <i class="bx bx-user text-muted"></i>
                      </div>
                      <div class="flex-1">
                        <div class="font-semibold text-muted">Waiting...</div>
                        <div class="text-xs text-muted">Guest ${gameRoom.gameType === 'tictactoe' ? '(O)' : '(Blue)'}</div>
                      </div>
                    </div>
                  `}
                </div>
                
                <!-- Game Status -->
                <div class="bg-surface rounded-lg p-4">
                  <h4 class="font-semibold text-text mb-2">Game Status</h4>
                  <div id="gameStatus" class="text-sm">
                    ${gameRoom.status === 'waiting' ? 
                      '<span class="text-gold">Waiting for player...</span>' : 
                      gameRoom.status === 'playing' ? 
                      '<span class="text-foam">Game in progress</span>' : 
                      '<span class="text-love">Game completed</span>'}
                  </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-6 space-y-2">
                  <button onclick="findRandomOpponent('${gameRoom.gameType}')" 
                          class="w-full px-4 py-2 bg-iris hover:bg-iris/80 text-white rounded-lg transition-colors text-sm ${gameRoom.status !== 'waiting' ? 'hidden' : ''}">
                    <i class="bx bx-shuffle mr-2"></i>Find Random Player
                  </button>
                  <button onclick="leaveGame()" 
                          class="w-full px-4 py-2 bg-love hover:bg-love/80 text-white rounded-lg transition-colors text-sm">
                    <i class="bx bx-exit mr-2"></i>Leave Game
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        window.currentGameModal = modal;
      }

      async function listenToGameRoom(roomId) {
        if (gameListener) {
          gameListener();
        }
        
        gameListener = db.collection('game-rooms').doc(roomId).onSnapshot(doc => {
          if (!doc.exists) {
            showNotification('Game Ended', 'The game room has been closed.', 'info');
            leaveGame();
            return;
          }
          
          const gameRoom = doc.data();
          updateGameUI(gameRoom, roomId);
        });
      }

             function updateGameUI(gameRoom, roomId) {
         if (!window.currentGameModal) {
           console.log('No current game modal');
           return;
         }
         
         console.log('Updating game UI:', gameRoom);
         
         const gameArea = document.getElementById('gameArea');
         const gameStatus = document.getElementById('gameStatus');
         
         if (gameRoom.status === 'playing' && gameArea && gameRoom.gameState) {
           console.log('Rendering game for:', gameRoom.gameType);
           // Render the actual game
           if (gameRoom.gameType === 'tictactoe') {
             renderTicTacToe(gameRoom, roomId);
           } else if (gameRoom.gameType === 'connect4') {
             renderConnect4(gameRoom, roomId);
           }
         } else {
           console.log('Not rendering game:', {
             status: gameRoom.status,
             hasGameArea: !!gameArea,
             hasGameState: !!gameRoom.gameState
           });
         }
        
        // Update game status
        if (gameStatus) {
          const isMyTurn = (
            (gameRoom.gameState && (gameRoom.gameState.currentPlayer === 'X' || gameRoom.gameState.currentPlayer === 'red')) && gameRoom.hostId === currentUser.uid
          ) || (
            (gameRoom.gameState && (gameRoom.gameState.currentPlayer === 'O' || gameRoom.gameState.currentPlayer === 'blue')) && gameRoom.guestId === currentUser.uid
          );
          
          if (gameRoom.status === 'waiting') {
            gameStatus.innerHTML = '<span class="text-gold">Waiting for player...</span>';
          } else if (gameRoom.status === 'playing') {
            if (isMyTurn) {
              gameStatus.innerHTML = '<span class="text-foam">Your turn!</span>';
            } else {
              gameStatus.innerHTML = '<span class="text-muted">Opponent\'s turn</span>';
            }
                     } else if (gameRoom.status === 'completed') {
             // Check if someone disconnected
             if (gameRoom.disconnectedPlayer) {
               const disconnectedPlayerName = gameRoom.disconnectedPlayer === gameRoom.hostId ? 
                 (gameRoom.hostName || 'Host') : 
                 (gameRoom.guestName || 'Guest');
               
               if (gameRoom.disconnectedPlayer === currentUser.uid) {
                 // Current user disconnected (shouldn't normally see this, but just in case)
                 gameStatus.innerHTML = '<span class="text-muted">You left the game</span>';
               } else {
                 // Opponent disconnected
                 gameStatus.innerHTML = '<span class="text-love">Opponent disconnected</span>';
                 showNotification('Game Ended', `${disconnectedPlayerName} left the game`, 'info');
                 
                 // Automatically close the game after a short delay
                 setTimeout(() => {
                   leaveGame();
                 }, 2000);
                 return; // Don't show winner screen for disconnections
               }
             } else if (gameRoom.winner === 'draw') {
               gameStatus.innerHTML = '<span class="text-gold">Draw!</span>';
             } else {
               const didIWin = (
                 (gameRoom.winner === 'X' || gameRoom.winner === 'red') && gameRoom.hostId === currentUser.uid
               ) || (
                 (gameRoom.winner === 'O' || gameRoom.winner === 'blue') && gameRoom.guestId === currentUser.uid
               );
               gameStatus.innerHTML = didIWin ? 
                 '<span class="text-foam">You won! ðŸŽ‰</span>' : 
                 '<span class="text-love">You lost ðŸ˜¢</span>';
             }
             
             // Show winner screen only for normal game completions (not disconnections)
             if (!gameRoom.disconnectedPlayer) {
               setTimeout(() => showWinnerScreen(gameRoom), 1000);
             }
           }
        }
        
        // Update players panel
        updatePlayersPanel(gameRoom);
      }

             function updatePlayersPanel(gameRoom) {
         // Only update player panel without re-rendering the entire modal
         console.log('Updating players panel for game room:', gameRoom);
         
         // Skip re-rendering the entire modal during active gameplay
         if (gameRoom.status === 'playing') {
           console.log('Skipping full modal re-render during active game');
           return;
         }
         
         // Only re-render modal for significant changes (like player joining)
         if (window.currentGameModal) {
           const gameArea = document.getElementById('gameArea');
           const gameAreaHTML = gameArea ? gameArea.innerHTML : '';
           
           window.currentGameModal.remove();
           showGameLobby(gameRoom, currentGameRoom, gameRoom.hostId === currentUser.uid);
           
           // Restore game area if it was rendered
           const newGameArea = document.getElementById('gameArea');
           if (newGameArea && gameAreaHTML && gameRoom.status === 'playing') {
             if (gameRoom.gameType === 'tictactoe') {
               renderTicTacToe(gameRoom, currentGameRoom);
             } else {
               renderConnect4(gameRoom, currentGameRoom);
             }
           }
         }
       }

      window.copyRoomId = function(roomId) {
        navigator.clipboard.writeText(roomId).then(() => {
          showNotification('Copied!', 'Room ID copied to clipboard', 'success');
        });
      };

             window.leaveGame = function() {
         winnerScreenShown = false;
         
         if (gameListener) {
           gameListener();
           gameListener = null;
         }
         
         if (currentGameRoom) {
          // Clean up the game room if host is leaving and no game in progress
          db.collection('game-rooms').doc(currentGameRoom).get().then(doc => {
            if (doc.exists) {
              const gameRoom = doc.data();
              if (gameRoom.hostId === currentUser.uid && gameRoom.status === 'waiting') {
                // Delete room if host leaves before game starts
                db.collection('game-rooms').doc(currentGameRoom).delete();
              } else {
                // Mark player as disconnected
                db.collection('game-rooms').doc(currentGameRoom).update({
                  status: 'completed',
                  winner: gameRoom.hostId === currentUser.uid ? 
                    (gameRoom.gameType === 'tictactoe' ? 'O' : 'blue') : 
                    (gameRoom.gameType === 'tictactoe' ? 'X' : 'red'),
                  disconnectedPlayer: currentUser.uid
                });
              }
            }
          });
          currentGameRoom = null;
        }
        
        if (window.currentGameModal) {
          window.currentGameModal.remove();
          window.currentGameModal = null;
        }
      };

      window.findRandomOpponent = async function(gameType) {
        showNotification('Searching...', 'Looking for available players', 'info');
        
        try {
          // Look for waiting rooms of the same game type
          const waitingRooms = await db.collection('game-rooms')
            .where('gameType', '==', gameType)
            .where('status', '==', 'waiting')
            .where('hostId', '!=', currentUser.uid)
            .limit(5) // Get more rooms to check for validity
            .get();
          
          if (!waitingRooms.empty) {
            // Try to join the first valid room
            for (const roomDoc of waitingRooms.docs) {
              try {
                // Double-check the room is still valid before joining
                const freshRoomDoc = await db.collection('game-rooms').doc(roomDoc.id).get();
                if (freshRoomDoc.exists && freshRoomDoc.data().status === 'waiting') {
                  await joinGame(roomDoc.id);
                  return; // Successfully joined
                } else {
                  // Room is stale, skip to next one
                  console.log('Skipping stale room:', roomDoc.id);
                  continue;
                }
              } catch (joinError) {
                console.error('Error joining room:', roomDoc.id, joinError);
                continue; // Try next room
              }
            }
            // If we get here, no valid rooms were found
            showNotification('No Players Found', 'No waiting games found. Your room is now public for others to join!', 'info');
          } else {
            showNotification('No Players Found', 'No waiting games found. Your room is now public for others to join!', 'info');
          }
        } catch (error) {
          console.error('Error finding opponent:', error);
          showNotification('Error', 'Failed to find opponent', 'error');
        }
      };

                           async function joinGame(roomId) {
          try {
            // Get the game room to determine the game type
            const roomDoc = await db.collection('game-rooms').doc(roomId).get();
            const gameRoom = roomDoc.data();
            
                         await db.collection('game-rooms').doc(roomId).update({
               guestId: currentUser.uid,
               guestName: currentUser.displayName || 'Anonymous',
               guestPhoto: currentUser.photoURL || '',
               status: 'playing',
               'gameState.currentPlayer': gameRoom.gameType === 'tictactoe' ? 'X' : 'red' // Start with X (host) in tic-tac-toe, red in connect4
             });
          
          currentGameRoom = roomId;
          
          // Close current modal and show the joined game
          if (window.currentGameModal) {
            window.currentGameModal.remove();
          }
          
                     // Get the updated game room data
           const updatedDoc = await db.collection('game-rooms').doc(roomId).get();
           if (updatedDoc.exists) {
             showGameLobby(updatedDoc.data(), roomId, false);
             listenToGameRoom(roomId);
           }
          
                 } catch (error) {
           console.error('Error joining game:', error);
           showNotification('Error', 'Failed to join game!', 'error');
         }
       }

       // === TIC TAC TOE GAME LOGIC ===
       function renderTicTacToe(gameRoom, roomId) {
         console.log('Rendering Tic Tac Toe:', gameRoom);
         const gameArea = document.getElementById('gameArea');
         if (!gameArea) {
           console.error('Game area not found');
           return;
         }
         
         if (!gameRoom.gameState || !gameRoom.gameState.board) {
           console.error('Invalid game state for Tic Tac Toe:', gameRoom.gameState);
           return;
         }
         
         const isMyTurn = (
           (gameRoom.gameState.currentPlayer === 'X' && gameRoom.hostId === currentUser.uid) ||
           (gameRoom.gameState.currentPlayer === 'O' && gameRoom.guestId === currentUser.uid)
         );
         
         gameArea.innerHTML = `
           <div class="text-center mb-6">
             <h3 class="text-2xl font-bold text-text mb-2">Tic Tac Toe</h3>
             <p class="text-muted">
               ${isMyTurn ? 'Your turn!' : `Waiting for opponent...`}
               <span class="ml-2 px-2 py-1 rounded text-xs font-bold ${gameRoom.gameState.currentPlayer === 'X' ? 'bg-foam/20 text-foam' : 'bg-love/20 text-love'}">
                 ${gameRoom.gameState.currentPlayer}
               </span>
             </p>
           </div>
           
           <div class="tic-tac-toe-board grid grid-cols-3 gap-2 w-80 h-80 mx-auto">
             ${gameRoom.gameState.board.map((cell, index) => `
               <button 
                 onclick="makeTicTacToeMove(${index})"
                 class="w-full h-full bg-highlight-med hover:bg-highlight-high rounded-lg text-6xl font-bold transition-colors ${!isMyTurn || cell || gameRoom.status === 'completed' ? 'cursor-not-allowed opacity-50' : 'cursor-pointer'}"
                 ${!isMyTurn || cell || gameRoom.status === 'completed' ? 'disabled' : ''}
               >
                 <span class="${cell === 'X' ? 'text-foam' : cell === 'O' ? 'text-love' : ''}">${cell || ''}</span>
               </button>
             `).join('')}
           </div>
         `;
       }
       
                window.makeTicTacToeMove = async function(index) {
           if (!currentGameRoom) {
             console.error('No current game room');
             return;
           }
           
           console.log('Making Tic Tac Toe move at index:', index);
           
           try {
             const gameDoc = await db.collection('game-rooms').doc(currentGameRoom).get();
             if (!gameDoc.exists) {
               console.error('Game room does not exist');
               return;
             }
             
             const gameRoom = gameDoc.data();
             console.log('Current game state:', gameRoom);
             
             if (!gameRoom.gameState) {
               console.error('No game state found');
               return;
             }
             
             const isMyTurn = (
               (gameRoom.gameState.currentPlayer === 'X' && gameRoom.hostId === currentUser.uid) ||
               (gameRoom.gameState.currentPlayer === 'O' && gameRoom.guestId === currentUser.uid)
             );
             
             console.log('Turn validation:', {
               currentPlayer: gameRoom.gameState.currentPlayer,
               hostId: gameRoom.hostId,
               guestId: gameRoom.guestId,
               currentUserId: currentUser.uid,
               isMyTurn: isMyTurn
             });
             
             if (!isMyTurn || gameRoom.gameState.board[index] || gameRoom.status !== 'playing') {
               console.log('Move blocked:', {
                 isMyTurn,
                 cellOccupied: gameRoom.gameState.board[index],
                 gameStatus: gameRoom.status,
                 currentPlayer: gameRoom.gameState.currentPlayer
               });
               return;
             }
           
           // Make the move
           const newBoard = [...gameRoom.gameState.board];
           newBoard[index] = gameRoom.gameState.currentPlayer;
           
           // Check for winner
           const winner = checkTicTacToeWinner(newBoard);
           const isDraw = !winner && newBoard.every(cell => cell !== null);
           
           const updateData = {
             'gameState.board': newBoard,
             lastActivity: firebase.firestore.FieldValue.serverTimestamp()
           };
           
           if (winner || isDraw) {
             updateData.status = 'completed';
             updateData.winner = winner || 'draw';
           } else {
             updateData['gameState.currentPlayer'] = gameRoom.gameState.currentPlayer === 'X' ? 'O' : 'X';
           }
           
           await db.collection('game-rooms').doc(currentGameRoom).update(updateData);
           
         } catch (error) {
           console.error('Error making move:', error);
           showNotification('Error', 'Failed to make move!', 'error');
         }
       };
       
       function checkTicTacToeWinner(board) {
         const winPatterns = [
           [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
           [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
           [0, 4, 8], [2, 4, 6] // diagonals
         ];
         
         for (const pattern of winPatterns) {
           const [a, b, c] = pattern;
           if (board[a] && board[a] === board[b] && board[a] === board[c]) {
             return board[a];
           }
         }
         
         return null;
       }

       // === CONNECT 4 GAME LOGIC ===
       
       // Helper functions for Connect 4 board conversion
       function getConnect4Index(row, col) {
         return row * 7 + col;
       }
       
       function getConnect4RowCol(index) {
         return {
           row: Math.floor(index / 7),
           col: index % 7
         };
       }
       
       function getConnect4Cell(board, row, col) {
         if (row < 0 || row >= 6 || col < 0 || col >= 7) {
           console.warn('Invalid Connect 4 coordinates:', row, col);
           return null;
         }
         return board[getConnect4Index(row, col)];
       }
       
       function setConnect4Cell(board, row, col, value) {
         if (row < 0 || row >= 6 || col < 0 || col >= 7) {
           console.error('Invalid Connect 4 coordinates for setting:', row, col);
           return;
         }
         board[getConnect4Index(row, col)] = value;
       }
       
       function renderConnect4(gameRoom, roomId) {
         console.log('Rendering Connect 4:', gameRoom);
         const gameArea = document.getElementById('gameArea');
         if (!gameArea) {
           console.error('Game area not found');
           return;
         }
         
         if (!gameRoom.gameState || !gameRoom.gameState.board) {
           console.error('Invalid game state for Connect 4:', gameRoom.gameState);
           return;
         }
         
         const isMyTurn = (
           (gameRoom.gameState.currentPlayer === 'red' && gameRoom.hostId === currentUser.uid) ||
           (gameRoom.gameState.currentPlayer === 'blue' && gameRoom.guestId === currentUser.uid)
         );
         
         gameArea.innerHTML = `
           <div class="text-center mb-6">
             <h3 class="text-2xl font-bold text-text mb-2">Connect Four</h3>
             <p class="text-muted">
               ${isMyTurn ? 'Your turn!' : `Waiting for opponent...`}
               <span class="ml-2 px-2 py-1 rounded text-xs font-bold ${gameRoom.gameState.currentPlayer === 'red' ? 'bg-love/20 text-love' : 'bg-iris/20 text-iris'}">
                 ${gameRoom.gameState.currentPlayer.toUpperCase()}
               </span>
             </p>
           </div>
           
           <div class="connect4-board mx-auto">
             <!-- Column buttons -->
             <div class="grid grid-cols-7 gap-1 mb-2">
               ${Array(7).fill().map((_, col) => `
                 <button 
                   onclick="makeConnect4Move(${col})"
                   class="w-16 h-8 bg-highlight-med hover:bg-highlight-high rounded-t-lg transition-colors ${!isMyTurn || gameRoom.status === 'completed' ? 'cursor-not-allowed opacity-50' : 'cursor-pointer'}"
                   ${!isMyTurn || gameRoom.status === 'completed' ? 'disabled' : ''}
                 >
                   <i class="bx bx-down-arrow ${gameRoom.gameState.currentPlayer === 'red' ? 'text-love' : 'text-iris'}"></i>
                 </button>
               `).join('')}
             </div>
             
             <!-- Game board -->
             <div class="grid grid-cols-7 grid-rows-6 gap-1 bg-surface p-3 rounded-lg border-2 border-highlight-med">
               ${Array(6).fill().map((_, row) =>
                 Array(7).fill().map((_, col) => {
                   const cell = getConnect4Cell(gameRoom.gameState.board, row, col);
                   return `
                     <div class="w-16 h-16 bg-highlight-med rounded-full flex items-center justify-center border-2 border-overlay" style="grid-row: ${row + 1}; grid-column: ${col + 1};">
                       ${cell ? `<div class="w-12 h-12 rounded-full ${cell === 'red' ? 'bg-love' : 'bg-iris'}"></div>` : ''}
                     </div>
                   `;
                 }).join('')
               ).join('')}
             </div>
           </div>
         `;
       }
       
                window.makeConnect4Move = async function(column) {
           if (!currentGameRoom) {
             console.error('No current game room');
             return;
           }
           
           console.log('Making Connect 4 move in column:', column);
           
           try {
             const gameDoc = await db.collection('game-rooms').doc(currentGameRoom).get();
             if (!gameDoc.exists) {
               console.error('Game room does not exist');
               return;
             }
             
             const gameRoom = gameDoc.data();
             console.log('Current Connect 4 game state:', gameRoom);
             
             if (!gameRoom.gameState) {
               console.error('No game state found for Connect 4');
               return;
             }
             
             const isMyTurn = (
               (gameRoom.gameState.currentPlayer === 'red' && gameRoom.hostId === currentUser.uid) ||
               (gameRoom.gameState.currentPlayer === 'blue' && gameRoom.guestId === currentUser.uid)
             );
             
             console.log('Connect 4 turn validation:', {
               currentPlayer: gameRoom.gameState.currentPlayer,
               hostId: gameRoom.hostId,
               guestId: gameRoom.guestId,
               currentUserId: currentUser.uid,
               isMyTurn: isMyTurn
             });
             
             if (!isMyTurn || gameRoom.status !== 'playing') {
               console.log('Connect 4 move blocked:', {
                 isMyTurn,
                 gameStatus: gameRoom.status,
                 currentPlayer: gameRoom.gameState.currentPlayer,
                 hostId: gameRoom.hostId,
                 guestId: gameRoom.guestId,
                 currentUserId: currentUser.uid
               });
               return;
             }
           
                        // Find the lowest empty row in the column
             const newBoard = [...gameRoom.gameState.board];
             let row = -1;
             
             for (let r = 5; r >= 0; r--) {
               if (!getConnect4Cell(newBoard, r, column)) {
                 row = r;
                 break;
               }
             }
             
             if (row === -1) {
               // Column is full
               showNotification('Invalid Move', 'Column is full!', 'warning');
               return;
             }
             
             // Make the move
             setConnect4Cell(newBoard, row, column, gameRoom.gameState.currentPlayer);
           
                        // Check for winner
             const winner = checkConnect4Winner(newBoard, row, column, gameRoom.gameState.currentPlayer);
             const isDraw = !winner && Array(7).fill().every((_, col) => getConnect4Cell(newBoard, 0, col) !== null);
           
           const updateData = {
             'gameState.board': newBoard,
             lastActivity: firebase.firestore.FieldValue.serverTimestamp()
           };
           
           if (winner || isDraw) {
             updateData.status = 'completed';
             updateData.winner = winner || 'draw';
           } else {
             updateData['gameState.currentPlayer'] = gameRoom.gameState.currentPlayer === 'red' ? 'blue' : 'red';
           }
           
           await db.collection('game-rooms').doc(currentGameRoom).update(updateData);
           
         } catch (error) {
           console.error('Error making move:', error);
           showNotification('Error', 'Failed to make move!', 'error');
         }
       };
       
       function checkConnect4Winner(board, row, col, player) {
         const directions = [
           [0, 1],   // horizontal
           [1, 0],   // vertical
           [1, 1],   // diagonal /
           [1, -1]   // diagonal \
         ];
         
         for (const [dr, dc] of directions) {
           let count = 1;
           
           // Check positive direction
           for (let i = 1; i < 4; i++) {
             const r = row + dr * i;
             const c = col + dc * i;
             if (r >= 0 && r < 6 && c >= 0 && c < 7 && getConnect4Cell(board, r, c) === player) {
               count++;
             } else {
               break;
             }
           }
           
           // Check negative direction
           for (let i = 1; i < 4; i++) {
             const r = row - dr * i;
             const c = col - dc * i;
             if (r >= 0 && r < 6 && c >= 0 && c < 7 && getConnect4Cell(board, r, c) === player) {
               count++;
             } else {
               break;
             }
           }
           
           if (count >= 4) {
             return player;
           }
         }
         
         return null;
       }

       // Winner Screen
       function showWinnerScreen(gameRoom) {
         // Don't show winner screen if already shown or modal doesn't exist
         if (winnerScreenShown || document.getElementById('winnerModal') || !window.currentGameModal) return;
         
         winnerScreenShown = true;
         
         const didIWin = (
           (gameRoom.winner === 'X' || gameRoom.winner === 'red') && gameRoom.hostId === currentUser.uid
         ) || (
           (gameRoom.winner === 'O' || gameRoom.winner === 'blue') && gameRoom.guestId === currentUser.uid
         );
         
         const isDraw = gameRoom.winner === 'draw';
         const gameTitle = gameRoom.gameType === 'tictactoe' ? 'Tic Tac Toe' : 'Connect Four';
         
         const winnerModal = document.createElement('div');
         winnerModal.id = 'winnerModal';
         winnerModal.className = 'fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-[10000]';
         
         let titleText, titleColor, bgGradient, icon;
         
         if (isDraw) {
           titleText = "It's a Draw!";
           titleColor = 'text-gold';
           bgGradient = 'from-gold/20 to-gold/10';
           icon = 'bx-medal';
         } else if (didIWin) {
           titleText = "You Won!";
           titleColor = 'text-foam';
           bgGradient = 'from-foam/20 to-foam/10';
           icon = 'bx-trophy';
         } else {
           titleText = "You Lost";
           titleColor = 'text-love';
           bgGradient = 'from-love/20 to-love/10';
           icon = 'bx-sad';
         }
         
         winnerModal.innerHTML = `
           <div class="bg-surface border border-highlight-med rounded-2xl shadow-2xl max-w-md w-[90vw] mx-4 overflow-hidden animate-[fadeInUp_0.5s_ease-out]">
             <div class="bg-gradient-to-br ${bgGradient} p-8 text-center relative">
               ${didIWin ? `
                 <div class="absolute inset-0 overflow-hidden">
                   <div class="confetti"></div>
                   <div class="confetti"></div>
                   <div class="confetti"></div>
                   <div class="confetti"></div>
                   <div class="confetti"></div>
                   <div class="confetti"></div>
                   <div class="confetti"></div>
                   <div class="confetti"></div>
                 </div>
               ` : ''}
               
               <div class="relative z-10">
                 <div class="w-20 h-20 mx-auto mb-4 ${isDraw ? 'bg-gold/20' : didIWin ? 'bg-foam/20' : 'bg-love/20'} rounded-full flex items-center justify-center animate-bounce">
                   <i class="bx ${icon} text-4xl ${titleColor}"></i>
                 </div>
                 
                 <h2 class="text-3xl font-bold ${titleColor} mb-2">${titleText}</h2>
                 <p class="text-muted text-lg">${gameTitle} Complete</p>
                 
                 ${!isDraw ? `
                   <div class="mt-4 flex items-center justify-center gap-4">
                     <div class="flex items-center gap-2">
                       <img src="${didIWin ? (gameRoom.hostId === currentUser.uid ? gameRoom.hostPhoto : gameRoom.guestPhoto) : (gameRoom.hostId === currentUser.uid ? gameRoom.guestPhoto : gameRoom.hostPhoto)}" 
                            class="carbon-profile-avatar w-8 h-8 rounded-full border-2 ${didIWin ? 'border-foam' : 'border-love'}">
                       <span class="text-text font-semibold">${didIWin ? 'You' : (gameRoom.hostId === currentUser.uid ? gameRoom.guestName : gameRoom.hostName)}</span>
                     </div>
                     <span class="text-muted">won as</span>
                     <span class="px-3 py-1 rounded-full ${gameRoom.winner === 'X' || gameRoom.winner === 'red' ? 'bg-foam/20 text-foam' : 'bg-love/20 text-love'} font-bold">
                       ${gameRoom.gameType === 'tictactoe' ? gameRoom.winner : gameRoom.winner.toUpperCase()}
                     </span>
                   </div>
                 ` : ''}
               </div>
             </div>
             
             <div class="p-6 space-y-3">
               <button onclick="startNewGame('${gameRoom.gameType}')" 
                       class="w-full px-4 py-3 bg-foam hover:bg-foam/80 text-base rounded-lg transition-colors font-semibold">
                 <i class="bx bx-refresh mr-2"></i>Play Again
               </button>
               
               <button onclick="closeWinnerScreen()" 
                       class="w-full px-4 py-3 bg-highlight-med hover:bg-highlight-high text-text rounded-lg transition-colors font-semibold">
                 <i class="bx bx-home mr-2"></i>Back to Games
               </button>
             </div>
           </div>
           
           <style>
             .confetti {
               position: absolute;
               width: 10px;
               height: 10px;
               background: linear-gradient(45deg, #9ccfd8, #c4a7e7, #eb6f92, #f6c177);
               animation: confetti-fall 3s linear infinite;
             }
             
             .confetti:nth-child(1) { left: 10%; animation-delay: 0s; }
             .confetti:nth-child(2) { left: 20%; animation-delay: 0.2s; }
             .confetti:nth-child(3) { left: 30%; animation-delay: 0.4s; }
             .confetti:nth-child(4) { left: 40%; animation-delay: 0.6s; }
             .confetti:nth-child(5) { left: 60%; animation-delay: 0.8s; }
             .confetti:nth-child(6) { left: 70%; animation-delay: 1s; }
             .confetti:nth-child(7) { left: 80%; animation-delay: 1.2s; }
             .confetti:nth-child(8) { left: 90%; animation-delay: 1.4s; }
             
             @keyframes confetti-fall {
               0% {
                 transform: translateY(-100vh) rotate(0deg);
                 opacity: 1;
               }
               100% {
                 transform: translateY(100vh) rotate(720deg);
                 opacity: 0;
               }
             }
           </style>
         `;
         
         document.body.appendChild(winnerModal);
         
         // Apply profile frames
         setTimeout(() => {
           const selectedFrame = localStorage.getItem('carbon-selected-profile-frame');
           const profileElements = winnerModal.querySelectorAll('.carbon-profile-avatar');
           profileElements.forEach(element => {
             // Remove all existing profile frame classes
             ['red', 'blue', 'orange', 'green', 'purple', 'gold', 'silver', 'rainbow'].forEach(color => {
               element.classList.remove(`profile-frame-${color}`);
             });
             // Apply active frame class
             if (selectedFrame && selectedFrame !== 'default') {
               element.classList.add(`profile-frame-${selectedFrame}`);
             }
           });
         }, 100);
       }

       window.startNewGame = function(gameType) {
         closeWinnerScreen();
         leaveGame();
         setTimeout(() => {
           winnerScreenShown = false;
           createGameLobby(gameType);
         }, 500);
       };

       window.closeWinnerScreen = function() {
         const winnerModal = document.getElementById('winnerModal');
         if (winnerModal) {
           winnerModal.remove();
         }
         winnerScreenShown = false;
         leaveGame();
       };

       // Room joining via ID
        window.joinGameById = async function() {
          const roomId = prompt('Enter Room ID:');
          if (!roomId) return;
          
          try {
            const gameDoc = await db.collection('game-rooms').doc(roomId).get();
            if (!gameDoc.exists) {
              showNotification('Room Not Found', 'Game room does not exist!', 'error');
              return;
            }
            
            const gameRoom = gameDoc.data();
            if (gameRoom.status !== 'waiting') {
              showNotification('Game In Progress', 'This game has already started!', 'warning');
              return;
            }
            
            if (gameRoom.hostId === currentUser.uid) {
              showNotification('Invalid', 'You cannot join your own game!', 'warning');
              return;
            }
            
            await joinGame(roomId);
            
          } catch (error) {
            console.error('Error joining game by ID:', error);
            showNotification('Error', 'Failed to join game!', 'error');
          }
        };

        // Listen for messages from other windows/frames
        window.addEventListener('message', function(event) {
          if (event.data && event.data.type === 'start-multiplayer-game') {
            startMultiplayerGame(event.data.gameType);
          } else if (event.data && event.data.type === 'join-game-by-id') {
            joinGameById();
          }
        });
        
        // === PRIVATE BROWSING SYSTEM ===
      let privateBrowsingMode = false;
      let privateTabHistory = [];
      
      function togglePrivateBrowsing() {
        privateBrowsingMode = !privateBrowsingMode;
        const btn = document.getElementById('private-browsing-btn');
        const icon = document.getElementById('private-browsing-icon');
        
        if (privateBrowsingMode) {
          btn.classList.add('bg-love/20', 'border-love/30');
          btn.title = 'Exit Private Browsing';
          icon.className = 'bx bx-shield-check text-lg text-love';
          
          // Show notification
          showNotification('Private Browsing Active', 'Your browsing history will not be saved', 'info');
          
          // Clear private history on activation
          privateTabHistory = [];
        } else {
          btn.classList.remove('bg-love/20', 'border-love/30');
          btn.title = 'Open Private Browser';
          icon.className = 'bx bx-hide text-lg';
          
          showNotification('Private Browsing Disabled', 'Normal browsing mode restored', 'info');
          
          // Clear private history when exiting
          privateTabHistory = [];
        }
        
        // Update current tab indicator
        const activeTab = getActiveTab();
        if (activeTab) {
          renderTabs();
        }
      }
      
             // Override history functions for private browsing
       const originalUpdateTabHistory = updateTabHistory;
       updateTabHistory = function(tabId, url) {
         const tab = tabs.find(t => t.id === tabId);
         if (tab && privateBrowsingMode) {
           // Mark tab as private
           tab.isPrivate = true;
           
           // Store in private history instead
           if (!privateTabHistory.find(entry => entry.url === url && entry.tabId === tabId)) {
             privateTabHistory.push({
               tabId: tabId,
               url: url,
               title: tab.title || 'Untitled',
               timestamp: Date.now()
             });
           }
           return; // Don't save to regular history
         }
         
         return originalUpdateTabHistory.apply(this, arguments);
       };
       
       // Override addTab to mark new tabs as private if in private mode
       const originalAddTabFunc = addTab;
       addTab = function(url, title) {
         const tab = originalAddTabFunc.call(this, url, title);
         if (privateBrowsingMode && tab) {
           tab.isPrivate = true;
           renderTabs(); // Re-render to show private indicator
         }
         return tab;
       };
      
      // Notification system
      function showNotification(title, message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 bg-surface border border-highlight-med rounded-lg p-4 shadow-lg z-[9999] transform translate-x-full transition-transform duration-300`;
        
        const iconMap = {
          success: 'bx-check-circle text-pine',
          error: 'bx-error-circle text-love',
          warning: 'bx-error text-gold',
          info: 'bx-info-circle text-foam'
        };
        
        notification.innerHTML = `
          <div class="flex items-start gap-3">
            <i class="bx ${iconMap[type]} text-xl"></i>
            <div class="flex-1">
              <div class="font-medium text-text">${title}</div>
              <div class="text-sm text-muted">${message}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="text-muted hover:text-love transition-colors">
              <i class="bx bx-x"></i>
            </button>
          </div>
        `;
        
        document.body.appendChild(notification);
        
        // Slide in
        setTimeout(() => notification.classList.remove('translate-x-full'), 100);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
          notification.classList.add('translate-x-full');
          setTimeout(() => notification.remove(), 300);
        }, 4000);
      }

      // Hook into tab operations and settings changes to sync data
      const originalAddTab = addTab;
      const originalRemoveTab = removeTab;
      
      addTab = function(...args) {
        const result = originalAddTab.apply(this, args);
        if (currentUser) {
          setTimeout(() => syncAllDataToFirebase(), 1000);
        }
        return result;
      };
      
      removeTab = function(...args) {
        const result = originalRemoveTab.apply(this, args);
        if (currentUser) {
          setTimeout(() => syncAllDataToFirebase(), 1000);
        }
        return result;
      };
      
      updateTabHistory = function(...args) {
        const result = originalUpdateTabHistory.apply(this, args);
        if (currentUser) {
          setTimeout(() => syncAllDataToFirebase(), 2000);
        }
        return result;
      };
      
      // Sync when settings change
      function triggerSettingsSync() {
        if (currentUser) {
          setTimeout(() => syncAllDataToFirebase(), 500);
        }
      }

      // -- INIT --
      // Load saved data
      loadTabGroups();
      
      // Restore vertical tabs mode from localStorage
      const savedVerticalMode = localStorage.getItem("vertical-tabs-mode");
      if (savedVerticalMode === "true") {
        verticalTabsMode = true;
        const verticalContainer = document.getElementById("vertical-tabs-container");
        const verticalControls = document.getElementById("vertical-tab-controls");
        const horizontalControls = document.getElementById("horizontal-tab-controls");
        const mainContent = document.getElementById("main-content-wrapper");
        const toggleBtn = document.getElementById("tabs-layout-toggle");
        
        verticalContainer.classList.add("open");
        verticalControls.classList.remove("hidden");
        horizontalControls.classList.add("hidden");
        mainContent.classList.add("with-vertical-tabs");
        toggleBtn.innerHTML = '<i class="bx bx-sidebar text-lg rotate-180"></i>';
        toggleBtn.title = "Hide Vertical Tabs";
        
        // Attach vertical tab event listeners
        setTimeout(attachVerticalTabListeners, 100);
        
        // Notify existing iframes about vertical tabs state
        setTimeout(notifyIframesVerticalTabsState, 600);
      }
      
      // Restore tab bar visibility from localStorage
      if (tabBarHidden) {
        const tabsBar = document.getElementById("tabs-bar");
        const toggleBtn = document.getElementById("hide-tab-bar-toggle");
        const verticalToggleBtn = document.getElementById("vertical-hide-tab-bar-toggle");
        tabsBar.style.display = "none";
        toggleBtn.innerHTML = '<i class="bx bx-hide text-lg"></i>';
        toggleBtn.title = "Show Tab Bar";
        if (verticalToggleBtn) {
          verticalToggleBtn.innerHTML = '<i class="bx bx-hide text-sm"></i><span class="text-xs">Show Bar</span>';
          verticalToggleBtn.title = "Show Tab Bar";
        }
      }
      
      if (tabs.length === 0) addTab("carbon://newtab");
      else loadTabsData();
      
      // Initialize settings immediately - try both methods to ensure we get settings
      console.log('ðŸš€ Initializing settings on page load...');
      loadLocalSettings(); // Load localStorage first for immediate effect
      
      // Initialize shop data
      console.log('ðŸ›’ Initializing shop data...');
      if (currentUser) {
        loadShopDataFromFirebase();
      } else {
        loadShopDataFromLocalStorage();
      }
      
      // Initialize theme system
      console.log('ðŸŽ¨ Initializing theme system...');
      initializeThemeSystem();
      
      // Also load from Firebase if user is authenticated
      if (auth.currentUser) {
        console.log('ðŸ‘¤ User already authenticated, loading from Firebase...');
        loadSettingsFromFirebase();
      } else {
        console.log('ðŸ‘¤ No user authenticated, using localStorage settings only');
      }
      
      // Initialize theme system connection to Firebase
      function initializeThemeSystem() {
        // Wait for carbon theme to be available
        const checkThemeSystem = () => {
          if (window.carbonTheme) {
            console.log('âœ… Carbon theme system available');
            
            // Connect theme system to Firebase auth
            if (typeof firebase !== 'undefined' && firebase.auth) {
              firebase.auth().onAuthStateChanged((user) => {
                if (user && window.carbonTheme) {
                  // Load themes from Firebase when user signs in
                  window.carbonTheme.loadThemesFromFirebase();
                }
              });
            }
            
            // Apply saved theme
            const savedTheme = localStorage.getItem('carbon-theme-global') || 'rose-pine';
            window.carbonTheme.applyTheme(savedTheme);
            
                         // Listen for theme changes and sync to Firebase
             const originalApplyTheme = window.carbonTheme.applyTheme;
             window.carbonTheme.applyTheme = function(themeName) {
               const result = originalApplyTheme.call(this, themeName);
               
               // Update Tailwind config when theme changes
               const themeData = this.getTheme(themeName);
               if (themeData && typeof updateTailwindConfig === 'function') {
                 updateTailwindConfig(themeData);
               }
               
               // Sync theme change to Firebase if user is authenticated
               if (currentUser) {
                 setTimeout(() => syncAllDataToFirebase(), 500);
               }
               return result;
             };
            
          } else {
            console.log('â³ Waiting for Carbon theme system...');
            setTimeout(checkThemeSystem, 100);
          }
        };
        checkThemeSystem();
      }

      // Initialize Carbon Shop and Private Browsing
      document.getElementById('carbon-shop-btn').addEventListener('click', (e) => {
        e.preventDefault();
        const dropdownMenu = document.getElementById('dropdown-menu');
        dropdownMenu.classList.add('hidden');
        openCarbonShop();
      });
      
      document.getElementById('private-browsing-btn').addEventListener('click', (e) => {
        e.preventDefault();
        togglePrivateBrowsing();
      });
      
      // Give users some starting currency if they're new
      if (userCurrency === 0 && !localStorage.getItem('carbon-currency-initialized')) {
        userCurrency = 100; // Starting bonus
        saveCurrencyToStorage();
        localStorage.setItem('carbon-currency-initialized', 'true');
        setTimeout(() => {
          showNotification('Welcome to Carbon!', 'You received 100 Carbon Coins to get started!', 'success');
        }, 2000);
      }

      // Initialize sortable for horizontal tabs
      const tabsContainer = document.getElementById("tabs-bar");
      new Sortable(tabsContainer, {
        animation: 150,
        onEnd: function (evt) {
          const { oldIndex, newIndex } = evt;
          if (oldIndex === newIndex) return;
          
          // Get sorted tabs (pinned first, then regular)
          const sortedTabs = [...tabs].sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return 0;
          });
          
          const [movedTab] = sortedTabs.splice(oldIndex, 1);
          sortedTabs.splice(newIndex, 0, movedTab);
          
          // Update the original tabs array to match the new order
          tabs = sortedTabs;
          renderTabs();
        },
      });
      
      // Initialize sortable for vertical tabs
      const verticalTabsContainer = document.getElementById("vertical-tabs-list");
      new Sortable(verticalTabsContainer, {
        animation: 150,
        onEnd: function (evt) {
          const { oldIndex, newIndex } = evt;
          if (oldIndex === newIndex) return;
          
          // Get sorted tabs (pinned first, then regular)
          const sortedTabs = [...tabs].sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return 0;
          });
          
          const [movedTab] = sortedTabs.splice(oldIndex, 1);
          sortedTabs.splice(newIndex, 0, movedTab);
          
          // Update the original tabs array to match the new order
          tabs = sortedTabs;
          renderTabs();
        },
      });

      // New Tab Background System - Apply settings from settings.html
      let newtabBackgroundType = 'theme';
      let newtabImageUrl = '';
      let newtabUnsplashCategory = 'nature';
      let newtabUnsplashFrequency = 'daily';
      let newtabGradientType = 'linear';
      let newtabGradientDirection = 'to right';
      let newtabGradientColors = ['#667eea', '#764ba2', '#f093fb'];

      function initializeNewtabBackgroundSystem() {
        // Load saved newtab background preference
        loadNewtabBackgroundSettings();
        
        // Listen for newtab background changes from settings page
        window.addEventListener('storage', (event) => {
          if (event.key === 'carbon-newtab-bg-type' && event.newValue) {
            newtabBackgroundType = event.newValue;
            applyNewtabBackground();
          }
        });

        // Listen for theme broadcast messages
        window.addEventListener('message', (event) => {
          if (event.data && event.data.type === 'carbon-settings-updated') {
            if (event.data.settings.newtabBackgroundType) {
              newtabBackgroundType = event.data.settings.newtabBackgroundType;
              newtabImageUrl = event.data.settings.newtabImageUrl || '';
              newtabUnsplashCategory = event.data.settings.newtabUnsplashCategory || 'nature';
              newtabUnsplashFrequency = event.data.settings.newtabUnsplashFrequency || 'daily';
              newtabGradientType = event.data.settings.newtabGradientType || 'linear';
              newtabGradientDirection = event.data.settings.newtabGradientDirection || 'to right';
              newtabGradientColors = event.data.settings.newtabGradientColors || ['#667eea', '#764ba2', '#f093fb'];
              applyNewtabBackground();
            }
          }
          
          // Listen for newtab background updates
          if (event.data && event.data.type === 'carbon-newtab-bg-updated') {
            const settings = event.data.settings;
            newtabBackgroundType = settings.type;
            newtabImageUrl = settings.imageUrl;
            newtabUnsplashCategory = settings.unsplashCategory;
            newtabUnsplashFrequency = settings.unsplashFrequency;
            newtabGradientType = settings.gradientType;
            newtabGradientDirection = settings.gradientDirection;
            newtabGradientColors = settings.gradientColors;
            applyNewtabBackground();
          }
        });
      }

      function loadNewtabBackgroundSettings() {
        newtabBackgroundType = localStorage.getItem('carbon-newtab-bg-type') || 'theme';
        newtabImageUrl = localStorage.getItem('carbon-newtab-image-url') || '';
        newtabUnsplashCategory = localStorage.getItem('carbon-newtab-unsplash-category') || 'nature';
        newtabUnsplashFrequency = localStorage.getItem('carbon-newtab-unsplash-frequency') || 'daily';
        newtabGradientType = localStorage.getItem('carbon-newtab-gradient-type') || 'linear';
        newtabGradientDirection = localStorage.getItem('carbon-newtab-gradient-direction') || 'to right';
        const savedColors = localStorage.getItem('carbon-newtab-gradient-colors');
        if (savedColors) {
          newtabGradientColors = JSON.parse(savedColors);
        }
        
        applyNewtabBackground();
      }

      async function applyNewtabBackground() {
        const body = document.body;
        const particlesCanvas = document.getElementById('particles-canvas');
        
        // Hide particles canvas by default
        if (particlesCanvas) particlesCanvas.classList.add('hidden');
        
        // Reset body background
        body.classList.remove('bg-gradient-to-br', 'from-base', 'via-surface', 'to-overlay');
        body.style.background = '';
        
        switch (newtabBackgroundType) {
          case 'theme':
            // Use theme gradient
            body.style.background = 'var(--theme-gradient)';
            body.style.backgroundAttachment = 'fixed';
            break;
          case 'image':
            if (newtabImageUrl) {
              body.style.background = `url(${newtabImageUrl}) center/cover fixed`;
            } else {
              body.style.background = 'var(--theme-gradient)';
              body.style.backgroundAttachment = 'fixed';
            }
            break;
          case 'unsplash':
            try {
              const unsplashUrl = await getUnsplashImage(newtabUnsplashCategory);
              if (unsplashUrl) {
                body.style.background = `url(${unsplashUrl}) center/cover fixed`;
              } else {
                body.style.background = 'var(--theme-gradient)';
                body.style.backgroundAttachment = 'fixed';
              }
            } catch (error) {
              console.error('Error loading Unsplash image:', error);
              body.style.background = 'var(--theme-gradient)';
              body.style.backgroundAttachment = 'fixed';
            }
            break;
          case 'gradient':
            const gradientColors = newtabGradientColors.join(', ');
            if (newtabGradientType === 'radial') {
              body.style.background = `radial-gradient(circle, ${gradientColors})`;
              body.style.backgroundAttachment = 'fixed';
            } else if (newtabGradientType === 'conic') {
              body.style.background = `conic-gradient(from 0deg, ${gradientColors})`;
              body.style.backgroundAttachment = 'fixed';
            } else {
              body.style.background = `linear-gradient(${newtabGradientDirection}, ${gradientColors})`;
              body.style.backgroundAttachment = 'fixed';
            }
            break;
          default:
            body.style.background = 'var(--theme-gradient)';
            body.style.backgroundAttachment = 'fixed';
            break;
        }
      }

      async function getUnsplashImage(category = 'nature') {
        try {
          const response = await fetch(`https://source.unsplash.com/1920x1080/?${category}`);
          return response.url;
        } catch (error) {
          console.error('Error fetching Unsplash image:', error);
          return null;
        }
      }

      function initParticles() {
        const canvas = document.getElementById('particles-canvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const particlesArray = [];
        const particleCount = 50;
        
        class Particle {
          constructor() {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.vx = (Math.random() - 0.5) * 2;
            this.vy = (Math.random() - 0.5) * 2;
            this.radius = Math.random() * 3 + 1;
            this.opacity = Math.random() * 0.5 + 0.2;
          }
          
          update() {
            this.x += this.vx;
            this.y += this.vy;
            
            if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
            if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
          }
          
          draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(156, 207, 216, ${this.opacity})`;
            ctx.fill();
          }
        }
        
        function createParticles() {
          particlesArray.length = 0;
          for (let i = 0; i < particleCount; i++) {
            particlesArray.push(new Particle());
          }
        }
        
        function animate() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          
          particlesArray.forEach(particle => {
            particle.update();
            particle.draw();
          });
          
          if (!canvas.classList.contains('hidden')) {
            requestAnimationFrame(animate);
          }
        }
        
        createParticles();
        animate();
        
        window.addEventListener('resize', () => {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          createParticles();
        });
      }

      async function loadNewtabBackgroundFromFirebase(uid) {
        try {
          const userDoc = await db.collection('users').doc(uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            const settings = userData.settings || {};
            
            if (settings.newtabBackgroundType) {
              newtabBackgroundType = settings.newtabBackgroundType;
              newtabImageUrl = settings.newtabImageUrl || '';
              newtabUnsplashCategory = settings.newtabUnsplashCategory || 'nature';
              newtabUnsplashFrequency = settings.newtabUnsplashFrequency || 'daily';
              newtabGradientType = settings.newtabGradientType || 'linear';
              newtabGradientDirection = settings.newtabGradientDirection || 'to right';
              newtabGradientColors = settings.newtabGradientColors || ['#667eea', '#764ba2', '#f093fb'];
              
              // Save to localStorage for consistency
              localStorage.setItem('carbon-newtab-bg-type', newtabBackgroundType);
              localStorage.setItem('carbon-newtab-image-url', newtabImageUrl);
              localStorage.setItem('carbon-newtab-unsplash-category', newtabUnsplashCategory);
              localStorage.setItem('carbon-newtab-unsplash-frequency', newtabUnsplashFrequency);
              localStorage.setItem('carbon-newtab-gradient-type', newtabGradientType);
              localStorage.setItem('carbon-newtab-gradient-direction', newtabGradientDirection);
              localStorage.setItem('carbon-newtab-gradient-colors', JSON.stringify(newtabGradientColors));
            }
            
            applyNewtabBackground();
          }
        } catch (error) {
          console.error('Error loading newtab background from Firebase:', error);
        }
      }

              // Initialize newtab background system
        initializeNewtabBackgroundSystem();
        
        // Export frame data for iframe container integration
        window.carbonFrames = {
          userFrames: userFrames,
          gameFrames: gameFrames,
          getActiveFrame: function() {
            const selectedFrame = localStorage.getItem('carbon-selected-frame');
            return userFrames.includes(selectedFrame) ? selectedFrame : 'default';
          },
          setActiveFrame: function(frameId) {
            if (userFrames.includes(frameId) || frameId === 'default') {
              localStorage.setItem('carbon-selected-frame', frameId);
              this.applyActiveFrame();
            }
          },
          applyActiveFrame: function() {
            const activeFrame = this.getActiveFrame();
            
            // Send frame update to all play.html iframes
            const gameIframes = document.querySelectorAll('iframe[src*="play.html"]');
            gameIframes.forEach(iframe => {
              iframe.contentWindow.postMessage({
                type: 'carbon-frame-update',
                frameId: activeFrame,
                frameData: activeFrame === 'default' ? null : gameFrames.find(f => f.id === activeFrame)
              }, '*');
            });
          }
        };

        // Export profile frame data and system
        window.carbonProfileFrames = {
          userProfileFrames: userProfileFrames,
          profileFrames: profileFrames,
          getActiveFrame: function() {
            const selectedFrame = localStorage.getItem('carbon-selected-profile-frame');
            return userProfileFrames.includes(selectedFrame) ? selectedFrame : 'default';
          },
          setActiveFrame: function(frameId) {
            if (userProfileFrames.includes(frameId) || frameId === 'default') {
              localStorage.setItem('carbon-selected-profile-frame', frameId);
            }
          },
          applyActiveFrame: function() {
            const activeFrame = this.getActiveFrame();
            
            // Apply to all profile elements on current page
            const profileElements = document.querySelectorAll('.carbon-profile-avatar, .user-avatar, .profile-avatar, [data-profile-avatar]');
            profileElements.forEach(element => {
              // Remove all existing profile frame classes
              profileFrames.forEach(frame => {
                element.classList.remove(`profile-frame-${frame.id}`);
              });
              
              // Apply active frame class
              if (activeFrame !== 'default') {
                element.classList.add(`profile-frame-${activeFrame}`);
              }
            });
          }
        };

        // Apply active frames on page load
        setTimeout(() => {
          window.carbonFrames.applyActiveFrame();
          window.carbonProfileFrames.applyActiveFrame();
        }, 500);

        // Firebase frame sync functions
        async function saveFramesToFirebase() {
          const user = auth?.currentUser;
          if (!user) return;
          
          try {
            const framesData = {
              selectedGameFrame: localStorage.getItem('carbon-selected-frame') || 'default',
              selectedProfileFrame: localStorage.getItem('carbon-selected-profile-frame') || 'default',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('user-frames').doc(user.uid).set(framesData, { merge: true });
            console.log('âœ… Frames saved to Firebase');
          } catch (error) {
            console.error('âŒ Error saving frames to Firebase:', error);
          }
        }

        async function loadFramesFromFirebase() {
          const user = auth?.currentUser;
          if (!user) return;
          
          try {
            const framesDoc = await db.collection('user-frames').doc(user.uid).get();
            if (framesDoc.exists) {
              const data = framesDoc.data();
              
              if (data.selectedGameFrame) {
                localStorage.setItem('carbon-selected-frame', data.selectedGameFrame);
              }
              
              if (data.selectedProfileFrame) {
                localStorage.setItem('carbon-selected-profile-frame', data.selectedProfileFrame);
              }
              
              // Apply frames after loading
              setTimeout(() => {
                window.carbonFrames.applyActiveFrame();
                window.carbonProfileFrames.applyActiveFrame();
              }, 100);
              
              console.log('âœ… Frames loaded from Firebase');
            }
          } catch (error) {
            console.error('âŒ Error loading frames from Firebase:', error);
          }
        }

        // Make functions globally available
        window.saveFramesToFirebase = saveFramesToFirebase;
        window.loadFramesFromFirebase = loadFramesFromFirebase;
        
                 // Listen for frame selection changes
         window.addEventListener('message', (event) => {
           if (event.data && event.data.type === 'carbon-frame-selected') {
             window.carbonFrames.setActiveFrame(event.data.frameId);
           }
         });
    </script>
  </body>
</html>
