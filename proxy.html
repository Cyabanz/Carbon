<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web Tabs App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Carbon Design System CSS -->
  <link rel="stylesheet" href="https://unpkg.com/carbon-components/css/carbon-components.min.css">
  <style>
    body {
      background: #f4f4f4;
      font-family: 'IBM Plex Sans', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .app-bar {
      background: #ffffff;
      padding: 1rem 2rem 0.5rem 2rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      z-index: 2;
      position: relative;
    }
    .tabs-list {
      display: flex;
      align-items: center;
      user-select: none;
      padding: 0.5rem 0 0.5rem 2rem;
      background: #f4f4f4;
      overflow-x: auto;
      white-space: nowrap;
      gap: 0.25rem;
    }
    .tab {
      display: flex;
      align-items: center;
      background: #fff;
      border-radius: 6px 6px 0 0;
      margin-right: 0.25rem;
      padding: 0.25rem 0.75rem 0.25rem 0.5rem;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      position: relative;
      min-width: 140px;
      transition: background 0.15s, border 0.15s;
      font-size: 0.98rem;
    }
    .tab.active {
      background: #e5e5e5;
      border: 1px solid #bebebe;
      border-bottom: 2px solid #0f62fe;
      z-index: 2;
    }
    .tab .favicon {
      width: 18px;
      height: 18px;
      margin-right: 8px;
      border-radius: 3px;
      background: #eee;
      object-fit: contain;
    }
    .tab .tab-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 120px;
      margin-right: 8px;
    }
    .tab .close-btn {
      color: #888;
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: 0.25rem;
      transition: color 0.2s;
      padding: 0 2px;
    }
    .tab .close-btn:hover {
      color: #e71d36;
    }
    .tab-add-btn {
      background: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1.3rem;
      padding: 0 0.7rem;
      cursor: pointer;
      transition: background 0.15s;
      color: #0f62fe;
      margin-left: 0.15rem;
      margin-top: 0.1rem;
      height: 33px;
    }
    .tab-add-btn:hover {
      background: #e5e5e5;
    }
    #tab-content {
      height: calc(100vh - 150px);
      min-height: 350px;
      background: #fff;
      box-shadow: 0 1px 6px rgba(0,0,0,0.05);
      border-radius: 0 0 10px 10px;
      margin: 0 2rem 2rem 2rem;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }
    #tab-content iframe {
      border: none;
      width: 100%;
      height: 100%;
      min-height: 320px;
      background: #fff;
    }
    @media (max-width: 700px) {
      .app-bar, #tab-content { margin: 0; border-radius: 0; }
      .tabs-list { padding-left: 0.5rem; }
    }
  </style>
</head>
<body>
  <div class="app-bar">
    <div class="bx--search bx--search--lg" role="search">
      <input class="bx--search-input" type="text" placeholder="Type URL or search and press Enter (Ctrl+T for new tab)" id="url-input" autocomplete="off" spellcheck="false" aria-label="Search or URL">
      <button class="bx--search-close" tabindex="-1" aria-label="Clear input" type="button"></button>
    </div>
  </div>
  <nav>
    <ul id="tabs-list" class="tabs-list"></ul>
    <button id="tab-add-btn" class="tab-add-btn" title="New Tab (Ctrl+T)">+</button>
  </nav>
  <main id="tab-content"></main>

  <!-- SortableJS for drag-and-drop tabs -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
    // --- Tab data and helpers
    let tabs = [];
    let activeTabId = null;
    let tabIdCounter = 0;

    function sanitizeUrl(urlOrQuery) {
      urlOrQuery = urlOrQuery.trim();
      if (urlOrQuery.match(/^https?:\/\//i)) return urlOrQuery;
      // Domain only: e.g. github.com
      if (urlOrQuery.match(/^([a-z0-9-]+\.)+[a-z]{2,}(\/.*)?$/i)) return 'https://' + urlOrQuery;
      // Otherwise, treat as search query
      return 'https://duckduckgo.com/?q=' + encodeURIComponent(urlOrQuery);
    }

    function getFaviconUrl(url) {
      try {
        const u = new URL(url);
        return `https://www.google.com/s2/favicons?domain=${u.hostname}&sz=32`;
      } catch {
        return `https://www.google.com/s2/favicons?domain=invalid&sz=32`;
      }
    }

    function addTab(url, select = true) {
      tabIdCounter++;
      const id = 'tab' + tabIdCounter;
      const favicon = getFaviconUrl(url);
      const title = url.replace(/^https?:\/\//, '').replace(/\/$/, '');
      tabs.push({ id, url, title, favicon });
      if (select) activeTabId = id;
      renderTabs();
      if (select) loadTabContent(id);
    }

    function removeTab(id) {
      const idx = tabs.findIndex(t => t.id === id);
      if (idx === -1) return;
      tabs.splice(idx, 1);
      if (activeTabId === id) {
        if (tabs[idx]) activeTabId = tabs[idx].id;
        else if (tabs[idx-1]) activeTabId = tabs[idx-1].id;
        else activeTabId = tabs[0]?.id || null;
      }
      renderTabs();
      if (activeTabId) loadTabContent(activeTabId);
      else document.getElementById('tab-content').innerHTML = '';
    }

    function switchTab(dir) {
      if (!activeTabId || tabs.length < 2) return;
      let idx = tabs.findIndex(t => t.id === activeTabId);
      if (dir === 'next') idx = (idx + 1) % tabs.length;
      if (dir === 'prev') idx = (idx - 1 + tabs.length) % tabs.length;
      activeTabId = tabs[idx].id;
      renderTabs();
      loadTabContent(activeTabId);
    }

    function updateTabTitleFromIframe(tab, iframe) {
      try {
        // Try to get title from iframe (if same origin)
        const doc = iframe.contentDocument || iframe.contentWindow?.document;
        if (doc && doc.title) {
          tab.title = doc.title;
          renderTabs();
        }
      } catch {
        // Cross-origin, fallback to nothing
      }
    }

    function renderTabs() {
      const ul = document.getElementById('tabs-list');
      ul.innerHTML = '';
      tabs.forEach(tab => {
        const li = document.createElement('li');
        li.className = 'tab' + (tab.id === activeTabId ? ' active' : '');
        li.dataset.tabId = tab.id;
        li.innerHTML = `
          <img class="favicon" src="${tab.favicon}" alt="favicon">
          <span class="tab-title" title="${tab.title}">${tab.title}</span>
          <button class="close-btn" title="Close tab (Ctrl+W)" tabindex="-1">&times;</button>
        `;
        li.querySelector('.close-btn').onclick = e => {
          e.stopPropagation();
          removeTab(tab.id);
        };
        li.onclick = (e) => {
          if (tab.id !== activeTabId) {
            activeTabId = tab.id;
            renderTabs();
            loadTabContent(tab.id);
          }
        };
        ul.appendChild(li);
      });
    }

    function loadTabContent(tabId) {
      const tab = tabs.find(t => t.id === tabId);
      if (!tab) return;
      const main = document.getElementById('tab-content');
      main.innerHTML = `<iframe sandbox="allow-scripts allow-forms allow-same-origin" src="${tab.url}" title="${tab.title}"></iframe>`;
      // Try to update the tab title after iframe loads (may fail cross-origin)
      const iframe = main.querySelector('iframe');
      iframe.addEventListener('load', () => {
        // Try to update tab title from iframe if possible
        try {
          let docTitle = iframe.contentDocument ? iframe.contentDocument.title : '';
          if (docTitle && docTitle.length > 0) {
            tab.title = docTitle;
            renderTabs();
          }
        } catch {
          // Cross-origin: do nothing
        }
      });
    }

    // --- UI events

    // Search bar: open URL or search query in new tab (Enter)
    document.getElementById('url-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const input = this.value.trim();
        if (!input) return;
        addTab(sanitizeUrl(input));
        this.value = '';
      }
    });
    // Clear button
    document.querySelector('.bx--search-close').addEventListener('click', function() {
      document.getElementById('url-input').value = '';
      document.getElementById('url-input').focus();
    });

    // Add new tab button
    document.getElementById('tab-add-btn').addEventListener('click', function() {
      addTab('https://www.example.com');
      document.getElementById('url-input').focus();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // New tab: Ctrl+T or Cmd+T
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 't') {
        e.preventDefault();
        addTab('https://www.example.com');
        document.getElementById('url-input').focus();
      }
      // Close tab: Ctrl+W or Cmd+W
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'w') {
        e.preventDefault();
        if (activeTabId) removeTab(activeTabId);
      }
      // Switch tab: Ctrl+Tab, Ctrl+Shift+Tab
      if ((e.ctrlKey || e.metaKey) && e.key === 'Tab') {
        e.preventDefault();
        if (e.shiftKey) switchTab('prev');
        else switchTab('next');
      }
    });

    // --- Drag-n-drop tabs
    Sortable.create(document.getElementById('tabs-list'), {
      animation: 180,
      direction: 'horizontal',
      filter: '.close-btn',
      draggable: '.tab',
      onEnd: function(evt) {
        if (evt.oldIndex === evt.newIndex) return;
        const moved = tabs.splice(evt.oldIndex, 1)[0];
        tabs.splice(evt.newIndex, 0, moved);
        renderTabs();
      }
    });

    // --- Initial tab
    addTab('https://carbon-design-system.github.io/carbon-website/');

  </script>
</body>
</html>
