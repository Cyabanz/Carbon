<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carbon - New Tab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        base: '#191724',
                        surface: '#1f1d2e',
                        overlay: '#26233a',
                        muted: '#6e6a86',
                        subtle: '#908caa',
                        text: '#e0def4',
                        love: '#eb6f92',
                        gold: '#f6c177',
                        rose: '#ebbcba',
                        pine: '#31748f',
                        foam: '#9ccfd8',
                        iris: '#c4a7e7',
                        'highlight-low': '#21202e',
                        'highlight-med': '#403d52',
                        'highlight-high': '#524f67',
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fade-in 0.5s ease-out forwards',
                        'slide-up': 'slide-up 0.3s ease-out forwards',
                    },
                    keyframes: {
                        'float': {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        'fade-in': {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0px)' },
                        },
                        'slide-up': {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0%)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
            background-attachment: fixed;
        }
        
        .glass {
            background: rgba(31, 29, 46, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(156, 207, 216, 0.1);
        }
        
        .glow-hover:hover {
            box-shadow: 0 0 30px rgba(156, 207, 216, 0.3);
        }
        
        .bookmark-card {
            background: linear-gradient(135deg, rgba(31, 29, 46, 0.9) 0%, rgba(38, 35, 58, 0.7) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(156, 207, 216, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .bookmark-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 30px rgba(156, 207, 216, 0.2);
            border-color: rgba(156, 207, 216, 0.3);
        }
        
        .search-glow {
            box-shadow: 0 0 50px rgba(156, 207, 216, 0.1);
        }
        
        .search-glow:focus-within {
            box-shadow: 0 0 60px rgba(156, 207, 216, 0.3);
        }
    </style>
</head>
<body class="min-h-screen bg-base text-text font-inter">
    <!-- Animated Background Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-20 left-20 w-32 h-32 rounded-full bg-foam/5 animate-float"></div>
        <div class="absolute top-40 right-32 w-24 h-24 rounded-full bg-iris/5 animate-float" style="animation-delay: 1s;"></div>
        <div class="absolute bottom-40 left-1/3 w-20 h-20 rounded-full bg-love/5 animate-float" style="animation-delay: 2s;"></div>
        <div class="absolute bottom-20 right-20 w-28 h-28 rounded-full bg-gold/5 animate-float" style="animation-delay: 0.5s;"></div>
    </div>

    <div class="relative z-10 min-h-screen flex flex-col">
        <!-- Header -->
        <header class="pt-16 pb-8 text-center animate-fade-in">
            <div class="inline-flex items-center justify-center gap-4 mb-4">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-foam to-iris flex items-center justify-center shadow-2xl">
                    <i class="bx bx-atom text-3xl text-base"></i>
                </div>
                <h1 class="text-6xl font-bold bg-gradient-to-r from-foam via-iris to-rose bg-clip-text text-transparent">
                    Carbon
                </h1>
            </div>
            <p class="text-subtle text-lg font-medium">Your gateway to the web</p>
        </header>

        <!-- Main Content -->
        <main class="flex-1 max-w-7xl mx-auto w-full px-6">
            <!-- Search Section -->
            <section class="mb-16 animate-fade-in" style="animation-delay: 0.2s;">
                <div class="max-w-4xl mx-auto">
                    <div class="glass rounded-3xl p-8 search-glow">
                        <form class="relative">
                            <div class="relative group">
                                <i class="bx bx-search absolute left-6 top-1/2 transform -translate-y-1/2 text-foam text-2xl group-focus-within:text-iris transition-colors"></i>
                                <input
                                    type="text"
                                    placeholder="Search anything or enter a URL..."
                                    class="w-full h-16 pl-16 pr-32 bg-surface/50 border-2 border-overlay/50 text-text text-xl rounded-2xl focus:outline-none focus:ring-4 focus:ring-foam/20 focus:border-foam placeholder-muted transition-all duration-300"
                                />
                                
                                <!-- Control Buttons -->
                                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center gap-2">
                                    <!-- Proxy Toggle -->
                                    <button type="button" class="w-12 h-12 rounded-xl bg-highlight-med hover:bg-highlight-high border-2 border-foam/50 hover:border-foam flex items-center justify-center transition-all duration-300 glow-hover group">
                                        <i class="bx bx-cloud text-xl text-foam group-hover:text-iris transition-colors"></i>
                                    </button>
                                    
                                    <!-- Search Engine -->
                                    <button type="button" class="w-12 h-12 rounded-xl bg-highlight-med hover:bg-highlight-high border-2 border-gold/50 hover:border-gold flex items-center justify-center transition-all duration-300 glow-hover group">
                                        <i class="bx bxl-brave text-xl text-gold group-hover:text-rose transition-colors"></i>
                                    </button>
                                    
                                    <!-- Search Submit -->
                                    <button type="submit" class="w-12 h-12 rounded-xl bg-gradient-to-br from-foam to-iris hover:from-iris hover:to-love flex items-center justify-center transition-all duration-300 transform hover:scale-105 shadow-lg">
                                        <i class="bx bx-right-arrow-alt text-xl text-base"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Search Suggestions (hidden by default) -->
                        <div class="mt-4 glass rounded-2xl p-4 hidden">
                            <div class="space-y-2">
                                <div class="flex items-center gap-3 p-3 rounded-xl hover:bg-highlight-med/50 cursor-pointer transition-colors">
                                    <i class="bx bx-search text-foam"></i>
                                    <span class="text-text">Sample suggestion</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="mb-16 animate-fade-in" style="animation-delay: 0.4s;">
                <div class="max-w-4xl mx-auto">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button class="glass rounded-2xl p-6 hover:bg-highlight-med/50 transition-all duration-300 transform hover:scale-105 glow-hover group">
                            <i class="bx bx-history text-3xl text-foam mb-3 group-hover:text-iris transition-colors"></i>
                            <p class="text-text font-medium">History</p>
                        </button>
                        
                        <button class="glass rounded-2xl p-6 hover:bg-highlight-med/50 transition-all duration-300 transform hover:scale-105 glow-hover group">
                            <i class="bx bx-download text-3xl text-gold mb-3 group-hover:text-rose transition-colors"></i>
                            <p class="text-text font-medium">Downloads</p>
                        </button>
                        
                        <button class="glass rounded-2xl p-6 hover:bg-highlight-med/50 transition-all duration-300 transform hover:scale-105 glow-hover group">
                            <i class="bx bx-cog text-3xl text-iris mb-3 group-hover:text-love transition-colors"></i>
                            <p class="text-text font-medium">Settings</p>
                        </button>
                        
                        <button class="glass rounded-2xl p-6 hover:bg-highlight-med/50 transition-all duration-300 transform hover:scale-105 glow-hover group">
                            <i class="bx bx-shield text-3xl text-pine mb-3 group-hover:text-foam transition-colors"></i>
                            <p class="text-text font-medium">Privacy</p>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Bookmarks Section -->
            <section class="animate-fade-in" style="animation-delay: 0.6s;">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold text-text flex items-center gap-3">
                        <i class="bx bx-bookmark text-foam"></i>
                        Bookmarks
                    </h2>
                    <button class="glass rounded-2xl px-6 py-3 hover:bg-highlight-med/50 transition-all duration-300 transform hover:scale-105 flex items-center gap-3 glow-hover group">
                        <i class="bx bx-plus text-foam group-hover:text-iris transition-colors"></i>
                        <span class="text-text font-medium">Add Bookmark</span>
                    </button>
                </div>
                
                <!-- Bookmarks Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Sample Bookmark Cards -->
                    <div class="bookmark-card rounded-2xl p-6 cursor-pointer group">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-foam to-iris flex items-center justify-center shadow-lg">
                                <i class="bx bx-globe text-xl text-base"></i>
                            </div>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="w-8 h-8 rounded-lg bg-highlight-med/50 hover:bg-highlight-high flex items-center justify-center text-subtle hover:text-text transition-colors">
                                    <i class="bx bx-edit text-sm"></i>
                                </button>
                                <button class="w-8 h-8 rounded-lg bg-love/20 hover:bg-love/30 flex items-center justify-center text-love transition-colors">
                                    <i class="bx bx-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <h3 class="text-text font-semibold text-lg mb-2">GitHub</h3>
                        <p class="text-subtle text-sm opacity-70">github.com</p>
                    </div>
                    
                    <div class="bookmark-card rounded-2xl p-6 cursor-pointer group">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-gold to-rose flex items-center justify-center shadow-lg">
                                <i class="bx bx-code-alt text-xl text-base"></i>
                            </div>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="w-8 h-8 rounded-lg bg-highlight-med/50 hover:bg-highlight-high flex items-center justify-center text-subtle hover:text-text transition-colors">
                                    <i class="bx bx-edit text-sm"></i>
                                </button>
                                <button class="w-8 h-8 rounded-lg bg-love/20 hover:bg-love/30 flex items-center justify-center text-love transition-colors">
                                    <i class="bx bx-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <h3 class="text-text font-semibold text-lg mb-2">Stack Overflow</h3>
                        <p class="text-subtle text-sm opacity-70">stackoverflow.com</p>
                    </div>
                    
                    <div class="bookmark-card rounded-2xl p-6 cursor-pointer group">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-iris to-love flex items-center justify-center shadow-lg">
                                <i class="bx bx-video text-xl text-base"></i>
                            </div>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="w-8 h-8 rounded-lg bg-highlight-med/50 hover:bg-highlight-high flex items-center justify-center text-subtle hover:text-text transition-colors">
                                    <i class="bx bx-edit text-sm"></i>
                                </button>
                                <button class="w-8 h-8 rounded-lg bg-love/20 hover:bg-love/30 flex items-center justify-center text-love transition-colors">
                                    <i class="bx bx-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <h3 class="text-text font-semibold text-lg mb-2">YouTube</h3>
                        <p class="text-subtle text-sm opacity-70">youtube.com</p>
                    </div>
                    
                    <div class="bookmark-card rounded-2xl p-6 cursor-pointer group">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-pine to-foam flex items-center justify-center shadow-lg">
                                <i class="bx bx-news text-xl text-base"></i>
                            </div>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="w-8 h-8 rounded-lg bg-highlight-med/50 hover:bg-highlight-high flex items-center justify-center text-subtle hover:text-text transition-colors">
                                    <i class="bx bx-edit text-sm"></i>
                                </button>
                                <button class="w-8 h-8 rounded-lg bg-love/20 hover:bg-love/30 flex items-center justify-center text-love transition-colors">
                                    <i class="bx bx-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                        <h3 class="text-text font-semibold text-lg mb-2">Hacker News</h3>
                        <p class="text-subtle text-sm opacity-70">news.ycombinator.com</p>
                    </div>
                    
                    <!-- Add more bookmark cards as needed -->
                    <div class="bookmark-card rounded-2xl p-6 cursor-pointer group border-2 border-dashed border-overlay/50 hover:border-foam/50 bg-transparent">
                        <div class="flex flex-col items-center justify-center h-full text-center py-4">
                            <i class="bx bx-plus text-4xl text-foam mb-3 group-hover:text-iris transition-colors"></i>
                            <p class="text-subtle font-medium">Add Bookmark</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="pt-16 pb-8 text-center animate-fade-in" style="animation-delay: 0.8s;">
            <div class="text-subtle text-sm">
                <p class="mb-2">Press <kbd class="bg-highlight-med px-3 py-1 rounded-lg text-foam font-mono">Ctrl+K</kbd> to focus search</p>
                <p class="opacity-70">Carbon Browser - Privacy-focused web experience</p>
            </div>
        </footer>
    </div>

    <!-- Add Bookmark Modal (hidden by default) -->
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-all duration-300 z-50">
        <div class="glass rounded-3xl shadow-2xl max-w-md w-[90vw] p-8 transform scale-90 transition-transform duration-300">
            <h3 class="text-2xl font-bold mb-6 text-text flex items-center gap-3">
                <i class="bx bx-bookmark-plus text-foam"></i>
                Add Bookmark
            </h3>
            <form class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-text mb-2">Title</label>
                    <input
                        type="text"
                        class="w-full px-4 py-3 bg-surface/50 border-2 border-overlay/50 rounded-xl text-text focus:outline-none focus:ring-4 focus:ring-foam/20 focus:border-foam transition-all"
                        placeholder="Enter bookmark title"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-text mb-2">URL</label>
                    <input
                        type="url"
                        class="w-full px-4 py-3 bg-surface/50 border-2 border-overlay/50 rounded-xl text-text focus:outline-none focus:ring-4 focus:ring-foam/20 focus:border-foam transition-all"
                        placeholder="https://example.com"
                    />
                </div>
                <div class="flex gap-3 pt-4">
                    <button
                        type="submit"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-foam to-iris text-base rounded-xl hover:from-iris hover:to-love transition-all duration-300 transform hover:scale-105 font-medium"
                    >
                        Add Bookmark
                    </button>
                    <button
                        type="button"
                        class="flex-1 px-6 py-3 bg-highlight-med text-text rounded-xl hover:bg-highlight-high transition-colors font-medium"
                    >
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
    <script src="carbon-theme.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script type="module">
      import { makeURL, getProxied, setProxy, getProxy } from '/lethal.mjs';
      
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
        authDomain: "carbon-services.firebaseapp.com",
        projectId: "carbon-services",
        storageBucket: "carbon-services.firebasestorage.app",
        messagingSenderId: "288385472070",
        appId: "1:288385472070:web:c4be3ff186e248fc645c47",
        measurementId: "G-Y2K1RQYE74"
      };
      
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      // THEME SYNC - Now auto-syncs from settings.html via enhanced theme system
      // The carbon-theme.js handles theme application automatically from global storage
      
      // Listen for theme changes from settings page
      window.addEventListener('storage', (event) => {
        if (event.key === 'carbon-theme-global' && event.newValue) {
          // Theme changed in another tab/window - apply automatically
          if (window.carbonTheme) {
            window.carbonTheme.applyTheme(event.newValue);
          }
        }
      });
      
      // Listen for theme broadcast messages
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'carbon-theme-change') {
          // Theme changed in settings - apply automatically
          if (window.carbonTheme) {
            window.carbonTheme.applyTheme(event.data.theme);
          }
        }
      });

      // Initialize theme on load (carbon-theme.js handles this automatically)
      // --- END THEME CODE ---

      // Search Engine Configuration
      const searchEngines = {
        'https://search.brave.com/search?q=%s': ['Brave', 'bxl-brave'],
        'https://duckduckgo.com/?q=%s': ['DuckDuckGo', 'bxl-duckduckgo'],
        'https://www.google.com/search?q=%s': ['Google', 'bxl-google'],
        'https://www.bing.com/search?q=%s': ['Bing', 'bxl-microsoft'],
        'https://search.yahoo.com/search?p=%s': ['Yahoo', 'bxl-yahoo'],
      };

      // State Management
      let currentSearchEngine = localStorage.getItem('search-engine') || 'https://search.brave.com/search?q=%s';
      let currentProxy = localStorage.getItem('proxy-backend') || 'uv';
      let bookmarks = JSON.parse(localStorage.getItem('carbon-bookmarks') || '[]');
      let currentUser = null;
      
      // Firebase sync functions
      async function loadBookmarksFromFirebase() {
        if (!currentUser) return;
        
        try {
          const userDoc = await db.collection('users').doc(currentUser.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            if (userData.bookmarks) {
              bookmarks = userData.bookmarks;
              localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
              renderBookmarks();
            }
          }
        } catch (error) {
          console.error('Error loading bookmarks from Firebase:', error);
        }
      }
      
      async function saveBookmarksToFirebase() {
        if (!currentUser) return;
        
        try {
          await db.collection('users').doc(currentUser.uid).set({
            bookmarks: bookmarks,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        } catch (error) {
          console.error('Error saving bookmarks to Firebase:', error);
        }
      }
      
      // Authentication state observer
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        if (user) {
          loadBookmarksFromFirebase();
        }
      });

      // DOM Elements
      const searchInput = document.getElementById('search-input');
      const searchForm = document.getElementById('search-form');
      const suggestionBox = document.getElementById('suggestion-box');
      const proxyToggle = document.getElementById('proxy-toggle');
      const proxyIcon = document.getElementById('proxy-icon');
      const searchEngineToggle = document.getElementById('search-engine-toggle');
      const searchEngineIcon = document.getElementById('search-engine-icon');
      const bookmarksGrid = document.getElementById('bookmarks-grid');
      const addBookmarkBtn = document.getElementById('add-bookmark-btn');
      const bookmarkModal = document.getElementById('bookmark-modal');
      const bookmarkForm = document.getElementById('bookmark-form');
      const cancelBookmarkBtn = document.getElementById('cancel-bookmark');

      // Initialize
      updateProxyUI();
      updateSearchEngineUI();
      renderBookmarks();

      // Listen for state changes from parent frame
      window.addEventListener("message", function(event) {
        if (event.data && event.data.type === 'carbon-proxy-sync') {
          currentProxy = event.data.proxy;
          localStorage.setItem('proxy-backend', currentProxy);
          updateProxyUI();
        } else if (event.data && event.data.type === 'carbon-search-engine-sync') {
          currentSearchEngine = event.data.searchEngine;
          localStorage.setItem('search-engine', currentSearchEngine);
          updateSearchEngineUI();
        } else if (event.data && event.data.type === 'carbon-vertical-tabs-state') {
          adjustForVerticalTabs(event.data.enabled, true);
        }
      });

      // Function to adjust layout for vertical tabs
      function adjustForVerticalTabs(verticalTabsEnabled, fromParent = false) {
        const body = document.body;
        if (verticalTabsEnabled) {
          body.classList.add('vertical-tabs-active');
        } else {
          body.classList.remove('vertical-tabs-active');
        }
        // Mark that we've received explicit state from parent
        if (fromParent) {
          body.setAttribute('data-vertical-tabs-detected', 'true');
        }
      }

      // Better detection: Check if we're in an iframe and request vertical tabs state
      function requestVerticalTabsState() {
        if (window.parent && window.parent !== window) {
          // Request vertical tabs state from parent
          window.parent.postMessage({
            type: 'carbon-request-vertical-tabs-state'
          }, '*');
        } else {
          // Not in iframe, check localStorage as fallback
          const savedVerticalMode = localStorage.getItem("vertical-tabs-mode");
          adjustForVerticalTabs(savedVerticalMode === "true");
        }
      }

      // Listen for resize events as fallback
      window.addEventListener('resize', () => {
        // Only auto-detect if we haven't received explicit state from parent
        if (!document.body.hasAttribute('data-vertical-tabs-detected')) {
          const isNarrow = window.innerWidth < 1200;
          adjustForVerticalTabs(isNarrow);
        }
      });
      // Initial detection
      setTimeout(requestVerticalTabsState, 100);
      setTimeout(requestVerticalTabsState, 500);

      // Proxy Toggle
      function updateProxyUI() {
        if (currentProxy === 'scram') {
          proxyToggle.classList.remove('border-foam');
          proxyToggle.classList.add('border-gold', 'bg-gold/20');
          proxyIcon.className = 'bx bx-network-chart text-xl';
          proxyToggle.title = 'Scramjet Proxy';
        } else {
          proxyToggle.classList.remove('border-gold', 'bg-gold/20');
          proxyToggle.classList.add('border-foam');
          proxyIcon.className = 'bx bx-cloud text-xl';
          proxyToggle.title = 'UV Proxy';
        }
      }

      proxyToggle.addEventListener('click', async () => {
        currentProxy = currentProxy === 'uv' ? 'scram' : 'uv';
        localStorage.setItem('proxy-backend', currentProxy);
        await setProxy(currentProxy);
        updateProxyUI();
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'carbon-proxy-sync',
            proxy: currentProxy
          }, '*');
        }
      });

      // Search Engine Toggle
      function updateSearchEngineUI() {
        const [name, icon] = searchEngines[currentSearchEngine] || ['Brave', 'bxl-brave'];
        searchEngineIcon.className = `bx ${icon} text-xl`;
        searchEngineToggle.title = name;
      }

      searchEngineToggle.addEventListener('click', () => {
        const engines = Object.keys(searchEngines);
        const currentIndex = engines.indexOf(currentSearchEngine);
        const nextIndex = (currentIndex + 1) % engines.length;
        currentSearchEngine = engines[nextIndex];
        localStorage.setItem('search-engine', currentSearchEngine);
        updateSearchEngineUI();
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'carbon-search-engine-sync',
            searchEngine: currentSearchEngine
          }, '*');
        }
      });

      // Search Suggestions
      let suggestionActive = -1;
      let currentSuggestions = [];
      let suggestionFetchController = null;

      searchInput.addEventListener('input', async function(e) {
        const val = searchInput.value.trim();
        if (!val || val.startsWith('http')) {
          suggestionBox.classList.add('hidden');
          suggestionBox.innerHTML = '';
          currentSuggestions = [];
          suggestionActive = -1;
          return;
        }
        const apiUrl = `https://corsproxy.io/?url=${encodeURIComponent(`https://duckduckgo.com/ac/?q=${encodeURIComponent(val)}&type=list`)}`;
        if (suggestionFetchController) suggestionFetchController.abort();
        suggestionFetchController = new AbortController();
        try {
          const resp = await fetch(apiUrl, {
            signal: suggestionFetchController.signal,
          });
          if (!resp.ok) throw new Error();
          const data = await resp.json();
          let suggestionsData;
          if (data.contents) {
            if (typeof data.contents === 'string') {
              suggestionsData = JSON.parse(data.contents);
            } else {
              suggestionsData = data.contents;
            }
          } else {
            suggestionsData = data;
          }
          currentSuggestions = (suggestionsData[1] || []).filter(Boolean);
          if (currentSuggestions.length === 0) {
            suggestionBox.classList.add('hidden');
            suggestionBox.innerHTML = '';
            suggestionActive = -1;
            return;
          }
          suggestionBox.innerHTML = currentSuggestions
            .map(
              (s, i) =>
                `<div class="suggestion-item${i === suggestionActive ? ' active' : ''}" data-idx="${i}">${s.replace(/</g, '&lt;')}</div>`
            )
            .join('');
          suggestionBox.classList.remove('hidden');
          suggestionActive = -1;
        } catch (err) {
          suggestionBox.classList.add('hidden');
          suggestionBox.innerHTML = '';
          currentSuggestions = [];
          suggestionActive = -1;
        }
      });

      searchInput.addEventListener('keydown', function(e) {
        if (!currentSuggestions.length || suggestionBox.classList.contains('hidden')) return;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          suggestionActive = (suggestionActive + 1) % currentSuggestions.length;
          updateSuggestionBoxActive();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          suggestionActive = (suggestionActive - 1 + currentSuggestions.length) % currentSuggestions.length;
          updateSuggestionBoxActive();
        } else if (e.key === 'Enter') {
          if (suggestionActive !== -1) {
            e.preventDefault();
            selectSuggestion(suggestionActive);
          }
          suggestionBox.classList.add('hidden');
        } else if (e.key === 'Escape') {
          suggestionBox.classList.add('hidden');
          suggestionActive = -1;
        }
      });

      function updateSuggestionBoxActive() {
        Array.from(suggestionBox.children).forEach((el, i) => {
          if (i === suggestionActive) el.classList.add('active');
          else el.classList.remove('active');
        });
        if (suggestionActive !== -1) {
          const el = suggestionBox.children[suggestionActive];
          if (el) el.scrollIntoView({ block: 'nearest' });
          searchInput.value = currentSuggestions[suggestionActive];
        }
      }

      function selectSuggestion(idx) {
        if (idx < 0 || idx >= currentSuggestions.length) return;
        searchInput.value = currentSuggestions[idx];
        suggestionBox.classList.add('hidden');
        suggestionActive = -1;
      }

      suggestionBox.addEventListener('mousedown', function(e) {
        const target = e.target.closest('.suggestion-item');
        if (target) {
          const idx = parseInt(target.dataset.idx);
          selectSuggestion(idx);
          setTimeout(() => {
            searchForm.dispatchEvent(new Event('submit'));
          }, 0);
        }
      });

      // Search Form Submit
      searchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        suggestionBox.classList.add('hidden');
        suggestionActive = -1;
        const query = searchInput.value.trim();
        if (!query) return;
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'carbon-navigate',
            url: query
          }, '*');
        } else {
          const url = makeURL(query, currentSearchEngine);
          const proxiedUrl = await getProxied(url);
          window.location.href = proxiedUrl;
        }
      });

      // Bookmarks Management
      function renderBookmarks() {
        if (bookmarks.length === 0) {
          bookmarksGrid.innerHTML = `
            <div class="col-span-full text-center text-muted py-8">
              <i class="bx bx-bookmark text-4xl mb-2"></i>
              <p>No bookmarks yet. Click "Add Bookmark" to get started!</p>
            </div>
          `;
          return;
        }
        bookmarksGrid.innerHTML = bookmarks.map((bookmark, index) => `
          <div class="bookmark-item" data-index="${index}">
            <div class="flex items-start justify-between mb-3">
              <div class="w-8 h-8 rounded-lg bg-foam/20 flex items-center justify-center flex-shrink-0">
                <i class="bx bx-bookmark text-foam"></i>
              </div>
              <div class="flex gap-1">
                <button class="edit-bookmark w-6 h-6 rounded hover:bg-highlight-med flex items-center justify-center text-muted hover:text-text transition-colors">
                  <i class="bx bx-edit text-xs"></i>
                </button>
                <button class="delete-bookmark w-6 h-6 rounded hover:bg-love/20 flex items-center justify-center text-muted hover:text-love transition-colors">
                  <i class="bx bx-trash text-xs"></i>
                </button>
              </div>
            </div>
            <h3 class="font-semibold text-text mb-1 truncate">${bookmark.title}</h3>
            <p class="text-sm text-muted truncate">${bookmark.url}</p>
          </div>
        `).join('');
        bookmarksGrid.querySelectorAll('.bookmark-item').forEach(item => {
          const index = parseInt(item.dataset.index);
          const bookmark = bookmarks[index];
          item.addEventListener('click', async (e) => {
            if (e.target.closest('.edit-bookmark') || e.target.closest('.delete-bookmark')) return;
            if (window.parent && window.parent !== window) {
              window.parent.postMessage({
                type: 'carbon-navigate',
                url: bookmark.url
              }, '*');
            } else {
              const url = makeURL(bookmark.url, currentSearchEngine);
              const proxiedUrl = await getProxied(url);
              window.location.href = proxiedUrl;
            }
          });
          item.querySelector('.edit-bookmark').addEventListener('click', (e) => {
            e.stopPropagation();
            editBookmark(index);
          });
          item.querySelector('.delete-bookmark').addEventListener('click', (e) => {
            e.stopPropagation();
            deleteBookmark(index);
          });
        });
      }

      async function addBookmark(title, url) {
        bookmarks.push({ title, url });
        localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
        await saveBookmarksToFirebase();
        renderBookmarks();
      }

      async function editBookmark(index) {
        const bookmark = bookmarks[index];
        const newTitle = prompt('Edit bookmark title:', bookmark.title);
        const newUrl = prompt('Edit bookmark URL:', bookmark.url);
        if (newTitle !== null && newUrl !== null) {
          bookmarks[index] = { title: newTitle || bookmark.title, url: newUrl || bookmark.url };
          localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
          await saveBookmarksToFirebase();
          renderBookmarks();
        }
      }

      async function deleteBookmark(index) {
        if (confirm('Delete this bookmark?')) {
          bookmarks.splice(index, 1);
          localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
          await saveBookmarksToFirebase();
          renderBookmarks();
        }
      }

      // Modal Management
      addBookmarkBtn.addEventListener('click', () => {
        bookmarkModal.classList.remove('opacity-0', 'pointer-events-none');
        bookmarkModal.classList.add('opacity-100', 'pointer-events-auto');
        document.getElementById('bookmark-title').focus();
      });

      cancelBookmarkBtn.addEventListener('click', () => {
        bookmarkModal.classList.add('opacity-0', 'pointer-events-none');
        bookmarkModal.classList.remove('opacity-100', 'pointer-events-auto');
        bookmarkForm.reset();
      });

      bookmarkForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const title = document.getElementById('bookmark-title').value.trim();
        const url = document.getElementById('bookmark-url').value.trim();
        if (title && url) {
          addBookmark(title, url);
          bookmarkModal.classList.add('opacity-0', 'pointer-events-none');
          bookmarkModal.classList.remove('opacity-100', 'pointer-events-auto');
          bookmarkForm.reset();
        }
      });

      // Click outside to close suggestions
      document.addEventListener('click', function(e) {
        if (!suggestionBox.contains(e.target) && e.target !== searchInput) {
          suggestionBox.classList.add('hidden');
          suggestionActive = -1;
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          searchInput.focus();
        }
      });
    </script>
  </body>
</html>
