<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Tab - Carbon</title>
    <script defer async>
      function setConfig() {
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                display: ["Switzer", "Helvetica", "sans-serif"],
                inter: ["Inter", "sans-serif"],
              },
              colors: {
                base: "#191724",
                surface: "#1f1d2e",
                overlay: "#26233a",
                muted: "#6e6a86",
                subtle: "#908caa",
                text: "#e0def4",
                love: "#eb6f92",
                gold: "#f6c177",
                rose: "#ebbcba",
                pine: "#31748f",
                foam: "#9ccfd8",
                iris: "#c4a7e7",
                "highlight-low": "#21202e",
                "highlight-med": "#403d52",
                "highlight-high": "#524f67",
              },
            },
          },
        };
      }
    </script>

    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" />
    <script
      defer
      async
      src="https://cdn.tailwindcss.com"
      onload="setConfig()"
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />

    <style>
      .suggestion-box {
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        z-index: 1200;
        background: #1f1d2e;
        border-radius: 0 0 0.75rem 0.75rem;
        border: 1px solid #26233a;
        border-top: none;
        max-height: 220px;
        overflow-y: auto;
        box-shadow: 0 6px 20px 2px #000a;
        color: #e0def4;
        font-size: 1rem;
        width: 100%;
      }
      .suggestion-item {
        padding: 0.73rem 1.1rem;
        cursor: pointer;
        transition: background 0.16s;
        border-bottom: 1px solid #26233a;
      }
      .suggestion-item:last-child {
        border-bottom: none;
      }
      .suggestion-item:hover,
      .suggestion-item.active {
        background: #26233a;
        color: #9ccfd8;
      }
      .bookmark-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
      }
      .bookmark-item {
        background: #1f1d2e;
        border: 1px solid #26233a;
        border-radius: 0.75rem;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }
      .bookmark-item:hover {
        background: #26233a;
        border-color: #9ccfd8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(156, 207, 216, 0.2);
      }
      .bookmark-item.editing {
        border-color: #f6c177;
        background: #403d52;
      }
    </style>
  </head>
  <body class="font-inter bg-gradient-to-br from-base via-surface to-overlay min-h-screen text-text">
    <div class="min-h-screen flex flex-col">
      <!-- Header -->
      <header class="p-6 text-center">
        <h1 class="text-4xl font-bold text-text mb-2 flex items-center justify-center gap-3">
          <i class="bx bx-atom text-foam"></i>
          Carbon
        </h1>
        <p class="text-muted text-sm">New Tab</p>
      </header>

      <!-- Main Content -->
      <main class="flex-1 max-w-6xl mx-auto w-full px-6">
        <!-- Search Section -->
        <section class="mb-12">
          <div class="max-w-2xl mx-auto">
            <form id="search-form" class="relative">
              <div class="relative">
                <i class="bx bx-search absolute left-4 top-1/2 transform -translate-y-1/2 text-muted text-xl"></i>
                <input
                  id="search-input"
                  type="text"
                  spellcheck="false"
                  autocomplete="off"
                  placeholder="Search or enter website URL"
                  class="w-full h-16 pl-12 pr-16 bg-surface border-2 border-overlay text-text rounded-full text-lg focus:outline-none focus:ring-2 focus:ring-foam focus:border-foam placeholder-muted transition-all"
                />
                <div class="absolute right-4 top-1/2 transform -translate-y-1/2 flex items-center gap-2">
                  <!-- Proxy Toggle -->
                  <button
                    id="proxy-toggle"
                    type="button"
                    class="w-10 h-10 rounded-full bg-highlight-med hover:bg-highlight-high border-2 border-foam flex items-center justify-center transition-all"
                    title="UV Proxy"
                  >
                    <i id="proxy-icon" class="bx bx-cloud text-xl"></i>
                  </button>
                  <!-- Search Engine -->
                  <button
                    id="search-engine-toggle"
                    type="button"
                    class="w-10 h-10 rounded-full bg-highlight-med hover:bg-highlight-high border-2 border-overlay flex items-center justify-center transition-all"
                    title="Search Engine"
                  >
                    <i id="search-engine-icon" class="bx bxl-brave text-xl"></i>
                  </button>
                </div>
              </div>
              <div id="suggestion-box" class="suggestion-box hidden"></div>
            </form>
          </div>
        </section>

        <!-- Bookmarks Section -->
        <section>
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-text flex items-center gap-2">
              <i class="bx bx-bookmark text-foam"></i>
              Bookmarks
            </h2>
            <button
              id="add-bookmark-btn"
              class="px-4 py-2 bg-foam text-base rounded-lg hover:bg-foam/80 transition-colors flex items-center gap-2"
            >
              <i class="bx bx-plus"></i>
              Add Bookmark
            </button>
          </div>
          
          <div id="bookmarks-grid" class="bookmark-grid">
            <!-- Bookmarks will be populated here -->
          </div>
        </section>
      </main>

      <!-- Footer -->
      <footer class="p-6 text-center text-muted text-sm">
        <p>Press <kbd class="bg-highlight-med px-2 py-1 rounded">Ctrl+T</kbd> for new tab</p>
      </footer>
    </div>

    <!-- Add Bookmark Modal -->
    <div id="bookmark-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-50">
      <div class="bg-surface border border-overlay rounded-xl shadow-2xl max-w-md w-[90vw] p-6">
        <h3 class="text-xl font-semibold mb-4 text-text">Add Bookmark</h3>
        <form id="bookmark-form">
          <div class="mb-4">
            <label class="block text-sm font-medium text-text mb-2">Title</label>
            <input
              id="bookmark-title"
              type="text"
              class="w-full px-3 py-2 bg-highlight-med border border-overlay rounded-lg text-text focus:outline-none focus:ring-2 focus:ring-foam"
              placeholder="Bookmark title"
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-text mb-2">URL</label>
            <input
              id="bookmark-url"
              type="url"
              class="w-full px-3 py-2 bg-highlight-med border border-overlay rounded-lg text-text focus:outline-none focus:ring-2 focus:ring-foam"
              placeholder="https://example.com"
            />
          </div>
          <div class="flex gap-2">
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-foam text-base rounded-lg hover:bg-foam/80 transition-colors"
            >
              Add
            </button>
            <button
              type="button"
              id="cancel-bookmark"
              class="flex-1 px-4 py-2 bg-highlight-med text-text rounded-lg hover:bg-highlight-high transition-colors"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { makeURL, getProxied, setProxy, getProxy } from '/lethal.mjs';

      // Search Engine Configuration
      const searchEngines = {
        'https://search.brave.com/search?q=%s': ['Brave', 'bxl-brave'],
        'https://duckduckgo.com/?q=%s': ['DuckDuckGo', 'bxl-duckduckgo'],
        'https://www.google.com/search?q=%s': ['Google', 'bxl-google'],
        'https://www.bing.com/search?q=%s': ['Bing', 'bxl-microsoft'],
        'https://search.yahoo.com/search?p=%s': ['Yahoo', 'bxl-yahoo'],
      };

      // State Management
      let currentSearchEngine = localStorage.getItem('search-engine') || 'https://search.brave.com/search?q=%s';
      let currentProxy = localStorage.getItem('proxy-backend') || 'uv';
      let bookmarks = JSON.parse(localStorage.getItem('carbon-bookmarks') || '[]');

      // DOM Elements
      const searchInput = document.getElementById('search-input');
      const searchForm = document.getElementById('search-form');
      const suggestionBox = document.getElementById('suggestion-box');
      const proxyToggle = document.getElementById('proxy-toggle');
      const proxyIcon = document.getElementById('proxy-icon');
      const searchEngineToggle = document.getElementById('search-engine-toggle');
      const searchEngineIcon = document.getElementById('search-engine-icon');
      const bookmarksGrid = document.getElementById('bookmarks-grid');
      const addBookmarkBtn = document.getElementById('add-bookmark-btn');
      const bookmarkModal = document.getElementById('bookmark-modal');
      const bookmarkForm = document.getElementById('bookmark-form');
      const cancelBookmarkBtn = document.getElementById('cancel-bookmark');

      // Initialize
      updateProxyUI();
      updateSearchEngineUI();
      renderBookmarks();

      // Listen for state changes from parent frame
      window.addEventListener("message", function(event) {
        if (event.data && event.data.type === 'carbon-proxy-sync') {
          currentProxy = event.data.proxy;
          localStorage.setItem('proxy-backend', currentProxy);
          updateProxyUI();
        } else if (event.data && event.data.type === 'carbon-search-engine-sync') {
          currentSearchEngine = event.data.searchEngine;
          localStorage.setItem('search-engine', currentSearchEngine);
          updateSearchEngineUI();
        }
      });

      // Proxy Toggle
      function updateProxyUI() {
        if (currentProxy === 'scram') {
          proxyToggle.classList.remove('border-foam');
          proxyToggle.classList.add('border-gold', 'bg-gold/20');
          proxyIcon.className = 'bx bx-network-chart text-xl';
          proxyToggle.title = 'Scramjet Proxy';
        } else {
          proxyToggle.classList.remove('border-gold', 'bg-gold/20');
          proxyToggle.classList.add('border-foam');
          proxyIcon.className = 'bx bx-cloud text-xl';
          proxyToggle.title = 'UV Proxy';
        }
      }

      proxyToggle.addEventListener('click', async () => {
        currentProxy = currentProxy === 'uv' ? 'scram' : 'uv';
        localStorage.setItem('proxy-backend', currentProxy);
        await setProxy(currentProxy);
        updateProxyUI();
        
        // Sync with parent frame if we're in an iframe
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'carbon-proxy-sync',
            proxy: currentProxy
          }, '*');
        }
      });

      // Search Engine Toggle
      function updateSearchEngineUI() {
        const [name, icon] = searchEngines[currentSearchEngine] || ['Brave', 'bxl-brave'];
        searchEngineIcon.className = `bx ${icon} text-xl`;
        searchEngineToggle.title = name;
      }

      searchEngineToggle.addEventListener('click', () => {
        const engines = Object.keys(searchEngines);
        const currentIndex = engines.indexOf(currentSearchEngine);
        const nextIndex = (currentIndex + 1) % engines.length;
        currentSearchEngine = engines[nextIndex];
        localStorage.setItem('search-engine', currentSearchEngine);
        updateSearchEngineUI();
        
        // Sync with parent frame if we're in an iframe
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'carbon-search-engine-sync',
            searchEngine: currentSearchEngine
          }, '*');
        }
      });

      // Search Suggestions
      let suggestionActive = -1;
      let currentSuggestions = [];
      let suggestionFetchController = null;

      searchInput.addEventListener('input', async function(e) {
        const val = searchInput.value.trim();
        if (!val || val.startsWith('http')) {
          suggestionBox.classList.add('hidden');
          suggestionBox.innerHTML = '';
          currentSuggestions = [];
          suggestionActive = -1;
          return;
        }

        const apiUrl = `https://corsproxy.io/?url=${encodeURIComponent(`https://duckduckgo.com/ac/?q=${encodeURIComponent(val)}&type=list`)}`;
        if (suggestionFetchController) suggestionFetchController.abort();
        suggestionFetchController = new AbortController();

        try {
          const resp = await fetch(apiUrl, {
            signal: suggestionFetchController.signal,
          });
          if (!resp.ok) throw new Error();
          const data = await resp.json();
          let suggestionsData;
          if (data.contents) {
            if (typeof data.contents === 'string') {
              suggestionsData = JSON.parse(data.contents);
            } else {
              suggestionsData = data.contents;
            }
          } else {
            suggestionsData = data;
          }
          currentSuggestions = (suggestionsData[1] || []).filter(Boolean);
          if (currentSuggestions.length === 0) {
            suggestionBox.classList.add('hidden');
            suggestionBox.innerHTML = '';
            suggestionActive = -1;
            return;
          }
          suggestionBox.innerHTML = currentSuggestions
            .map(
              (s, i) =>
                `<div class="suggestion-item${i === suggestionActive ? ' active' : ''}" data-idx="${i}">${s.replace(/</g, '&lt;')}</div>`
            )
            .join('');
          suggestionBox.classList.remove('hidden');
          suggestionActive = -1;
        } catch (err) {
          suggestionBox.classList.add('hidden');
          suggestionBox.innerHTML = '';
          currentSuggestions = [];
          suggestionActive = -1;
        }
      });

      searchInput.addEventListener('keydown', function(e) {
        if (!currentSuggestions.length || suggestionBox.classList.contains('hidden')) return;
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          suggestionActive = (suggestionActive + 1) % currentSuggestions.length;
          updateSuggestionBoxActive();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          suggestionActive = (suggestionActive - 1 + currentSuggestions.length) % currentSuggestions.length;
          updateSuggestionBoxActive();
        } else if (e.key === 'Enter') {
          if (suggestionActive !== -1) {
            e.preventDefault();
            selectSuggestion(suggestionActive);
          }
          suggestionBox.classList.add('hidden');
        } else if (e.key === 'Escape') {
          suggestionBox.classList.add('hidden');
          suggestionActive = -1;
        }
      });

      function updateSuggestionBoxActive() {
        Array.from(suggestionBox.children).forEach((el, i) => {
          if (i === suggestionActive) el.classList.add('active');
          else el.classList.remove('active');
        });
        if (suggestionActive !== -1) {
          const el = suggestionBox.children[suggestionActive];
          if (el) el.scrollIntoView({ block: 'nearest' });
          searchInput.value = currentSuggestions[suggestionActive];
        }
      }

      function selectSuggestion(idx) {
        if (idx < 0 || idx >= currentSuggestions.length) return;
        searchInput.value = currentSuggestions[idx];
        suggestionBox.classList.add('hidden');
        suggestionActive = -1;
      }

      suggestionBox.addEventListener('mousedown', function(e) {
        const target = e.target.closest('.suggestion-item');
        if (target) {
          const idx = parseInt(target.dataset.idx);
          selectSuggestion(idx);
          setTimeout(() => {
            searchForm.dispatchEvent(new Event('submit'));
          }, 0);
        }
      });

      // Search Form Submit
      searchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        suggestionBox.classList.add('hidden');
        suggestionActive = -1;
        
        const query = searchInput.value.trim();
        if (!query) return;

        // Check if we're in an iframe (within the proxy browser)
        if (window.parent && window.parent !== window) {
          // Send message to parent frame to navigate
          window.parent.postMessage({
            type: 'carbon-navigate',
            url: query
          }, '*');
        } else {
          // Navigate normally if not in iframe
          const url = makeURL(query, currentSearchEngine);
          const proxiedUrl = await getProxied(url);
          window.location.href = proxiedUrl;
        }
      });

      // Bookmarks Management
      function renderBookmarks() {
        if (bookmarks.length === 0) {
          bookmarksGrid.innerHTML = `
            <div class="col-span-full text-center text-muted py-8">
              <i class="bx bx-bookmark text-4xl mb-2"></i>
              <p>No bookmarks yet. Click "Add Bookmark" to get started!</p>
            </div>
          `;
          return;
        }

        bookmarksGrid.innerHTML = bookmarks.map((bookmark, index) => `
          <div class="bookmark-item" data-index="${index}">
            <div class="flex items-start justify-between mb-3">
              <div class="w-8 h-8 rounded-lg bg-foam/20 flex items-center justify-center flex-shrink-0">
                <i class="bx bx-bookmark text-foam"></i>
              </div>
              <div class="flex gap-1">
                <button class="edit-bookmark w-6 h-6 rounded hover:bg-highlight-med flex items-center justify-center text-muted hover:text-text transition-colors">
                  <i class="bx bx-edit text-xs"></i>
                </button>
                <button class="delete-bookmark w-6 h-6 rounded hover:bg-love/20 flex items-center justify-center text-muted hover:text-love transition-colors">
                  <i class="bx bx-trash text-xs"></i>
                </button>
              </div>
            </div>
            <h3 class="font-semibold text-text mb-1 truncate">${bookmark.title}</h3>
            <p class="text-sm text-muted truncate">${bookmark.url}</p>
          </div>
        `).join('');

        // Add event listeners
        bookmarksGrid.querySelectorAll('.bookmark-item').forEach(item => {
          const index = parseInt(item.dataset.index);
          const bookmark = bookmarks[index];

          item.addEventListener('click', async (e) => {
            if (e.target.closest('.edit-bookmark') || e.target.closest('.delete-bookmark')) return;
            
            // Check if we're in an iframe (within the proxy browser)
            if (window.parent && window.parent !== window) {
              // Send message to parent frame to navigate
              window.parent.postMessage({
                type: 'carbon-navigate',
                url: bookmark.url
              }, '*');
            } else {
              // Navigate normally if not in iframe
              const url = makeURL(bookmark.url, currentSearchEngine);
              const proxiedUrl = await getProxied(url);
              window.location.href = proxiedUrl;
            }
          });

          item.querySelector('.edit-bookmark').addEventListener('click', (e) => {
            e.stopPropagation();
            editBookmark(index);
          });

          item.querySelector('.delete-bookmark').addEventListener('click', (e) => {
            e.stopPropagation();
            deleteBookmark(index);
          });
        });
      }

      function addBookmark(title, url) {
        bookmarks.push({ title, url });
        localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
        renderBookmarks();
      }

      function editBookmark(index) {
        const bookmark = bookmarks[index];
        const newTitle = prompt('Edit bookmark title:', bookmark.title);
        const newUrl = prompt('Edit bookmark URL:', bookmark.url);
        
        if (newTitle !== null && newUrl !== null) {
          bookmarks[index] = { title: newTitle || bookmark.title, url: newUrl || bookmark.url };
          localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
          renderBookmarks();
        }
      }

      function deleteBookmark(index) {
        if (confirm('Delete this bookmark?')) {
          bookmarks.splice(index, 1);
          localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
          renderBookmarks();
        }
      }

      // Modal Management
      addBookmarkBtn.addEventListener('click', () => {
        bookmarkModal.classList.remove('opacity-0', 'pointer-events-none');
        bookmarkModal.classList.add('opacity-100', 'pointer-events-auto');
        document.getElementById('bookmark-title').focus();
      });

      cancelBookmarkBtn.addEventListener('click', () => {
        bookmarkModal.classList.add('opacity-0', 'pointer-events-none');
        bookmarkModal.classList.remove('opacity-100', 'pointer-events-auto');
        bookmarkForm.reset();
      });

      bookmarkForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const title = document.getElementById('bookmark-title').value.trim();
        const url = document.getElementById('bookmark-url').value.trim();
        
        if (title && url) {
          addBookmark(title, url);
          bookmarkModal.classList.add('opacity-0', 'pointer-events-none');
          bookmarkModal.classList.remove('opacity-100', 'pointer-events-auto');
          bookmarkForm.reset();
        }
      });

      // Click outside to close suggestions
      document.addEventListener('click', function(e) {
        if (!suggestionBox.contains(e.target) && e.target !== searchInput) {
          suggestionBox.classList.add('hidden');
          suggestionActive = -1;
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          searchInput.focus();
        }
      });
    </script>
  </body>
</html>