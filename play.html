<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Play Game - CARBON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    .loader {
      border: 8px solid #16213e;
      border-top: 8px solid #06b6d4;
      border-radius: 50%;
      width: 70px;
      height: 70px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .tag-btn.active {
      background: #22d3ee22;
      color: #06b6d4 !important;
      border-color: #06b6d4 !important;
    }
    .suggested-scrollbar::-webkit-scrollbar {width: 6px;}
    .suggested-scrollbar::-webkit-scrollbar-thumb {background: #232445; border-radius: 3px;}
    .suggested-scrollbar::-webkit-scrollbar-track {background: transparent;}
    .star.filled { color: #ffd600; }
    .star.disabled { cursor: not-allowed; }
    .comment-rating-stars .star { font-size: 1.4em; cursor: pointer; }
    .comment-rating-stars .star.disabled { color: #888; cursor: not-allowed; }
    .comment-rating-stars .star.filled { color: #ffd600; }
    .comment-form-info { color: #aaa; font-size: 1em; margin: 10px 0; }
    .comment-count-badge {
      background: #06b6d4;
      color: #fff;
      font-size: 0.9em;
      padding: 2px 7px;
      border-radius: 10px;
      margin-left: 4px;
      vertical-align: middle;
      font-weight: 600;
    }
    .star-label { min-width: 36px; display: inline-block; text-align: right; margin-right: 6px; }
    .histogram-bar-bg { background: #232445; border-radius: 6px; width: 120px; height: 12px; display: inline-block; vertical-align: middle; margin: 0 7px; }
    .histogram-bar-fill { background: #ffd600; border-radius: 6px; height: 12px; transition: width .3s; }
    .histogram-count { min-width: 18px; display: inline-block; text-align: left; margin-left: 4px; }
    .histogram-toggle-btn { background: #232445; color: #ffd600; border: 1px solid #ffd600; border-radius: 6px; padding: 2px 10px; font-size: 0.95em; margin: 8px 0; cursor: pointer; }
    .rating-histogram { margin: 12px 0 6px 0; }
    .comment { background: #232445; border-radius: 14px; margin-bottom: 12px; padding: 14px 14px 10px 14px; display: flex; flex-direction: row; gap: 12px; }
    .comment-avatar { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; margin-right: 12px; }
    .comment-main { flex: 1; }
    .comment-user { font-weight: 600; color: #ffd600; }
    .comment-date { color: #aaa; font-size: 0.89em; margin-left: 8px;}
    .comment-actions button, .reply-btn, .show-replies-btn, .report-btn { background: none; border: none; color: #06b6d4; cursor: pointer; font-size: 1em; margin-right: 10px; }
    .comment-actions button:disabled, .report-btn:disabled { color: #888; cursor: not-allowed; }
    .emoji-picker-bar { margin-top: 6px; }
    .reaction-btn { background: #232445; border-radius: 8px; color: #ffd600; border: 1px solid #ffd60033; margin-right: 4px; padding: 0 5px; font-size: 1.05em; cursor: pointer; }
    .reaction-btn.reacted { background: #ffd60022; }
    .reaction-btn.add-reaction-btn { color: #06b6d4; border: 1px dashed #06b6d4; font-size: 1.15em; }
    .reply { background: #1a1a2e; border-radius: 10px; margin: 6px 0 6px 24px; padding: 9px 12px; color: #fff; }
    .reply-form textarea { width: 100%; border-radius: 8px; border: 1px solid #232445; min-height: 38px; color: #fff; background: #181b2a; margin-bottom: 6px; padding: 4px 7px; resize: vertical; }
    .reply-form { margin: 9px 0 7px 20px; }
    .reply-post-btn { background: #06b6d4; color: #fff; border: none; border-radius: 7px; padding: 4px 16px; cursor: pointer; font-weight: 700; }
    .reply-error { color: #f87171; margin-top: 2px; font-size: 0.93em; }
    .star-value-preview { font-weight: 700; color: #ffd600; margin-left: 7px; }
    .comment-form { margin: 32px 0 18px 0; }
    .comment-input { width: 100%; border-radius: 10px; border: 1px solid #232445; min-height: 38px; color: #fff; background: #181b2a; padding: 8px 14px; margin-bottom: 8px; resize: vertical; }
    .comment-post-btn { background: #06b6d4; color: #fff; border: none; border-radius: 7px; padding: 8px 20px; cursor: pointer; font-weight: 700; }
    .comment-error { color: #f87171; margin: 7px 0 0 0; font-size: 1em; }
    .comment-sort-filter { display: flex; align-items: center; gap: 1.2em; margin: 10px 0 18px 0; }
    .comment-sort-dropdown { background: #232445; color: #ffd600; border: 1px solid #ffd60033; border-radius: 7px; font-size: 1em; padding: 1px 8px; }
    .filter-star-btn { background: #232445; color: #ffd600; border: 1px solid #ffd60033; border-radius: 7px; font-size: 1em; padding: 0 6px; cursor: pointer; margin-right: 4px; }
    .filter-star-btn.active { background: #ffd60022; }
    .user-badge { background: #06b6d4; color: #fff; border-radius: 6px; font-size: 0.87em; font-weight: 700; padding: 2px 7px; margin-left: 5px;}
    #emojiPicker { position: absolute; z-index: 2000; display: none; }
  </style>
  <!-- Emoji Picker (Web Component) -->
  <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js" type="module"></script>
</head>
<body class="bg-gradient-to-br from-[#0f0f23] via-[#1a1a2e] to-[#16213e] min-h-screen text-white font-[Inter]">

  <!-- Preloader -->
  <div id="preloader" class="fixed z-[9999] inset-0 flex flex-col justify-center items-center bg-gradient-to-br from-[#0f0f23] via-[#1a1a2e] to-[#16213e]">
    <div class="loader"></div>
  </div>

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-8 py-4 bg-[#0f0f23cc] border-b border-white/10 backdrop-blur-md fixed top-0 left-0 right-0 z-50">
    <a href="index.html" class="text-2xl font-extrabold bg-gradient-to-r from-cyan-400 to-indigo-500 bg-clip-text text-transparent tracking-tighter">CARBON</a>
    <div class="flex items-center gap-4">
      <div id="userSection"></div>
    </div>
  </nav>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen w-full bg-gradient-to-br from-[#0f0f23] via-[#1a1a2e] to-[#16213e] fixed left-0 top-0 z-50">
    <div class="bg-[#1a1a2e] rounded-2xl shadow-2xl p-12 border border-cyan-600/30 flex flex-col items-center">
      <div class="text-3xl font-bold bg-gradient-to-r from-cyan-400 to-indigo-500 bg-clip-text text-transparent mb-6">Sign In to Play</div>
      <button onclick="googleSignIn()" class="flex items-center gap-3 bg-cyan-500 hover:bg-cyan-400 text-black font-bold px-6 py-3 rounded-lg text-lg transition">
        <i class='bx bxl-google text-2xl'></i> Sign in with Google
      </button>
      <div id="loginError" class="text-pink-400 mt-6 hidden"></div>
    </div>
  </div>

  <main class="pt-28 max-w-7xl mx-auto px-4">
    <div class="flex flex-col-reverse lg:flex-row gap-8">
      <!-- LEFT: Main Content (Game Info, Game Frame, etc) -->
      <div class="flex-1 min-w-0">
        <div id="gameInfoHolder" class="rounded-2xl shadow-2xl bg-[#181b2a] border border-cyan-600/30 overflow-hidden mt-2"></div>
        <div id="gameFrameContainer" class="rounded-2xl shadow-2xl bg-[#181b2a] border border-cyan-600/30 overflow-hidden mt-8 hidden"></div>
        <!-- --- COMMENT SECTION --- -->
        <div id="commentSectionWrap" class="mt-10 mb-12 max-w-3xl mx-auto">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-xl font-bold text-cyan-400">Comments</span>
            <span class="comment-count-badge">0</span>
          </div>
          <div class="comment-sort-filter"></div>
          <form class="comment-form flex flex-col gap-2" style="display:none;">
            <div class="flex flex-col md:flex-row md:items-center gap-3">
              <div class="comment-rating-stars"></div>
              <span class="star-value-preview"></span>
            </div>
            <textarea class="comment-input" placeholder="Write your comment..." maxlength="500"></textarea>
            <button class="comment-post-btn bg-cyan-500 hover:bg-cyan-400 px-6 py-2 rounded-lg font-bold text-white transition w-fit" type="submit" disabled>Post</button>
            <div class="comment-error"></div>
          </form>
          <div class="comment-form-info" style="display:none;">Sign in to post a comment.</div>
          <div class="comments-list mt-6"></div>
        </div>
        <!-- Emoji Picker -->
        <emoji-picker id="emojiPicker"></emoji-picker>
      </div>
      <!-- RIGHT: SUGGESTED GAMES SIDEBAR -->
      <aside id="suggestedSidebar"
        class="relative w-full lg:w-80 shrink-0 mb-6 lg:mb-0 lg:sticky lg:top-32">
        <div class="bg-[#181b2a] border border-cyan-600/30 rounded-[22px] shadow-xl px-4 py-6 h-full">
          <h2 class="text-xl font-extrabold text-cyan-400 mb-4 flex items-center gap-2">
            <i class='bx bx-joystick text-2xl'></i>
            Suggested Games
          </h2>
          <div id="suggestedGamesList" class="flex flex-col gap-4 max-h-[70vh] overflow-y-auto suggested-scrollbar"></div>
        </div>
      </aside>
    </div>
    <!-- Tag modal -->
    <div id="tagGamesListModal" class="hidden fixed inset-0 z-[10000] bg-black/70 flex items-center justify-center">
      <div class="bg-[#232445] rounded-xl p-8 max-w-lg w-full shadow-2xl border border-cyan-400/20 relative">
        <button onclick="closeTagGamesModal()" class="absolute top-3 right-4 text-white/70 hover:text-pink-400 text-xl"><i class='bx bx-x'></i></button>
        <h2 class="text-2xl font-bold mb-4 text-cyan-400" id="tagGamesListTitle"></h2>
        <div id="tagGamesListBody" class="space-y-2"></div>
      </div>
    </div>
  </main>

 <!-- --- PROXY & APP SCRIPTS --- -->
<script type="module">
  import {
    makeURL,
    getProxied,
    setProxy,
    getProxy,
    setTransport,
    setWisp,
  } from "/lethal.mjs";
  let proxyOption = localStorage.getItem("proxy-backend") || "uv";
  async function ensureProxyReady() {
    if (!getProxy() || getProxy() !== proxyOption) await setProxy(proxyOption);
    let wisp = localStorage.getItem("wisp-server") || "wss://anura.pro/";
    let transport = localStorage.getItem("proxy-transport");
    if (wisp) await setWisp(wisp);
    if (transport) await setTransport(transport);
    else if (navigator.userAgent.indexOf("Firefox") > 0) await setTransport("libcurl");
    else await setTransport("epoxy");
  }
  function updateProxyToggleUI(proxy) {
    const proxyToggleBtn = document.getElementById("proxyToggleBtn");
    const proxyToggleIcon = document.getElementById("proxyToggleIcon");
    if (!proxyToggleBtn || !proxyToggleIcon) return;
    if (proxy === "scram") {
      proxyToggleBtn.classList.remove("border-cyan-400");
      proxyToggleBtn.classList.add("border-gold", "bg-gold/20");
      proxyToggleIcon.className = "bx bx-network-chart text-xl";
      proxyToggleBtn.title = "Scramjet";
    } else {
      proxyToggleBtn.classList.remove("border-gold", "bg-gold/20");
      proxyToggleBtn.classList.add("border-cyan-400");
      proxyToggleIcon.className = "bx bx-cloud text-xl";
      proxyToggleBtn.title = "UV";
    }
  }
  document.addEventListener("DOMContentLoaded", function() {
    setTimeout(() => updateProxyToggleUI(proxyOption), 200);
  });
  document.addEventListener("DOMContentLoaded", function() {
    const btn = document.getElementById("proxyToggleBtn");
    if (btn) {
      btn.addEventListener("click", async () => {
        proxyOption = (getProxy() === "scram") ? "uv" : "scram";
        localStorage.setItem("proxy-backend", proxyOption);
        await ensureProxyReady();
        updateProxyToggleUI(proxyOption);
        if (!document.getElementById("gameFrameContainer").classList.contains("hidden")) {
          loadProxiedGameIframe();
        }
      });
    }
  });
  async function loadProxiedGameIframe() {
    await ensureProxyReady();
    let gamesData = window.gamesData || [];
    let currentGameId = window.currentGameId;
    let currentGame = gamesData.find(g => String(g.id) === String(currentGameId));
    if (!currentGame) return;
    const proxied = await getProxied(currentGame.url);
    document.getElementById("gameFrameEmbed").src = proxied;
  }
  window.loadProxiedGameIframe = loadProxiedGameIframe;
  window.ensureProxyReady = ensureProxyReady;
  window.updateProxyToggleUI = updateProxyToggleUI;
</script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
    authDomain: "carbon-services.firebaseapp.com",
    projectId: "carbon-services",
    storageBucket: "carbon-services.firebasestorage.app",
    messagingSenderId: "288385472070",
    appId: "1:288385472070:web:c4be3ff186e248fc645c47",
    measurementId: "G-Y2K1RQYE74"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  function googleSignIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .catch((error) => {
        document.getElementById('loginError').innerText = error.message;
        document.getElementById('loginError').classList.remove('hidden');
      });
  }
  function signOut() {
    auth.signOut().then(() => location.reload());
  }

  let gamesData = [];
  let currentGameId = null;
  let currentGame = null;
  let categoryCounts = {};
  let tagCounts = {};

  async function loadGamesData() {
    const res = await fetch('games.json');
    gamesData = await res.json();
    window.gamesData = gamesData;
    categoryCounts = {};
    tagCounts = {};
    gamesData.forEach(game => {
      if (game.category) categoryCounts[game.category] = (categoryCounts[game.category] || 0) + 1;
      if (game.tags && Array.isArray(game.tags)) {
        game.tags.forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1);
      }
    });
    window.categoryCounts = categoryCounts;
    window.tagCounts = tagCounts;
  }

  function getGameIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
  }
  function setButtonActive(btn, isActive, activeClass='bg-cyan-500/80') {
    btn.classList.toggle(activeClass, isActive);
  }
  function renderUserSection(user) {
    const section = document.getElementById('userSection');
    if (!section) return;
    if (!user) {
      section.innerHTML = '';
    } else {
      section.innerHTML = `
        <img src="${user.photoURL}" class="w-8 h-8 rounded-full inline mr-2" title="${user.displayName}">
        <span class="mr-3">${user.displayName}</span>
        <button onclick="signOut()" class="bg-white/10 px-3 py-1 rounded hover:bg-pink-600 text-white">Sign Out</button>
      `;
    }
  }
  function showPreloader() {
    document.getElementById('preloader').style.display = '';
  }
  function hidePreloader() {
    document.getElementById('preloader').style.display = 'none';
  }
  function requestFullScreen(element) {
    if (element.requestFullscreen) element.requestFullscreen();
    else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();
    else if (element.msRequestFullscreen) element.msRequestFullscreen();
    else if (element.mozRequestFullScreen) element.mozRequestFullScreen();
  }

  let starRatingData = {
    average: 0,
    count: 0,
    yourRating: 0,
    loading: false,
    error: "",
    percent: 0
  };

  function renderStarRatingUI(target = "") {
    const pre = target ? target : "";
    const container = document.getElementById('starsContainer' + pre);
    if (!container) return;
    container.innerHTML = '';
    let fill = starRatingData.yourRating ? starRatingData.yourRating : Math.round(starRatingData.average);
    for (let i = 1; i <= 5; i++) {
      const star = document.createElement('span');
      star.textContent = '★';
      star.className = 'transition-colors duration-150 select-none ' +
        (i <= fill ? 'text-yellow-400' : 'text-slate-600') +
        (firebase.auth().currentUser ? ' cursor-pointer hover:text-yellow-300' : ' cursor-not-allowed');
      if (firebase.auth().currentUser) {
        star.addEventListener('mouseenter', () => {
          for (let j = 0; j < 5; j++) container.children[j].classList.toggle('text-yellow-400', j < i);
          for (let j = i; j < 5; j++) container.children[j].classList.toggle('text-slate-600', j >= i);
        });
        star.addEventListener('mouseleave', () => {
          for (let j = 0; j < 5; j++) {
            container.children[j].classList.toggle('text-yellow-400', j < fill);
            container.children[j].classList.toggle('text-slate-600', j >= fill);
          }
        });
        star.addEventListener('click', async () => {
          await submitStarRating(i);
        });
      }
      container.appendChild(star);
    }
    document.getElementById('starRatingSummary' + pre).textContent =
      starRatingData.count ? `${starRatingData.average.toFixed(2)} / 5` : "Not rated";
    document.getElementById('starRatingCount' + pre).textContent =
      starRatingData.count === 1 ? "1 rating" : (starRatingData.count ? `${starRatingData.count} ratings` : "");
    document.getElementById('starRatingError' + pre).textContent = starRatingData.error || '';
    renderRatingPercentUI(target);
  }

  async function loadStarRating(gameId) {
    starRatingData.loading = true;
    starRatingData.error = "";
    starRatingData.average = 0;
    starRatingData.count = 0;
    starRatingData.yourRating = 0;
    starRatingData.percent = 0;
    try {
      const ratingsRef = db.collection("games").doc(gameId).collection("ratings");
      const snap = await ratingsRef.get();
      let total = 0, count = 0, your = 0, user = firebase.auth().currentUser;
      let highCount = 0;
      snap.forEach(doc => {
        const d = doc.data();
        if (typeof d.rating === "number" && d.rating >= 1 && d.rating <= 5) {
          total += d.rating;
          count++;
          if (d.rating >= 4) highCount++;
          if (user && doc.id === user.uid) your = d.rating;
        }
      });
      starRatingData.average = count ? total / count : 0;
      starRatingData.count = count;
      starRatingData.yourRating = your;
      starRatingData.percent = count ? Math.round((highCount / count) * 100) : 0;
    } catch (e) {
      starRatingData.error = "Failed to load ratings.";
    }
    starRatingData.loading = false;
    renderStarRatingUI();
    renderStarRatingUI("Frame");
  }

  async function submitStarRating(stars) {
    if (!firebase.auth().currentUser) {
      starRatingData.error = "Sign in first!";
      renderStarRatingUI();
      renderStarRatingUI("Frame");
      return;
    }
    if (!currentGameId) {
      starRatingData.error = "Game not loaded!";
      renderStarRatingUI();
      renderStarRatingUI("Frame");
      return;
    }
    if (stars < 1 || stars > 5) {
      starRatingData.error = "Invalid rating value!";
      renderStarRatingUI();
      renderStarRatingUI("Frame");
      return;
    }
    starRatingData.loading = true;
    starRatingData.error = "";
    renderStarRatingUI();
    renderStarRatingUI("Frame");
    try {
      const ref = db.collection("games").doc(currentGameId).collection("ratings").doc(firebase.auth().currentUser.uid);
      await ref.set({
        rating: stars,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      starRatingData.yourRating = stars;
      await loadStarRating(currentGameId);
    } catch (e) {
      starRatingData.error = "Failed to rate, try again.";
      renderStarRatingUI();
      renderStarRatingUI("Frame");
    }
    starRatingData.loading = false;
    renderStarRatingUI();
    renderStarRatingUI("Frame");
  }

  function renderRatingPercentUI(target = "") {
    const pre = target ? target : "";
    const txt = document.getElementById('ratingPercentText' + pre);
    const bar = document.getElementById('ratingPercentBar' + pre);
    if (!txt || !bar) return;
    if (starRatingData.count === 0) {
      txt.textContent = "Not enough ratings yet";
      bar.style.width = "0%";
    } else {
      txt.textContent = `${starRatingData.percent}% of raters gave 4 or 5 stars`;
      bar.style.width = `${starRatingData.percent}%`;
    }
  }

  function getSuggestedGames(currentId, currentCategory, limit = 8) {
    let filtered = [];
    if (currentId && currentCategory) {
      filtered = gamesData.filter(
        g => g.id !== currentId && g.category === currentCategory
      );
    }
    if (filtered.length < limit) {
      let others = gamesData.filter(g => g.id !== currentId && !filtered.includes(g));
      while (filtered.length < limit && others.length) {
        let idx = Math.floor(Math.random() * others.length);
        filtered.push(others.splice(idx, 1)[0]);
      }
    }
    for (let i = filtered.length - 1; i > 0; i--) {
      let j = Math.floor(Math.random() * (i + 1));
      [filtered[i], filtered[j]] = [filtered[j], filtered[i]];
    }
    return filtered.slice(0, limit);
  }

  function renderSuggestedGamesSidebar(suggestedGames) {
    const container = document.getElementById("suggestedGamesList");
    if (!container) return;
    container.innerHTML = suggestedGames.map(game => `
      <a href="play.html?id=${game.id}" 
        class="block group overflow-hidden shadow-lg bg-[#232445] border border-white/10 hover:border-cyan-400/60 transition relative rounded-[22px]">
        <div class="relative aspect-[16/9] bg-black rounded-t-[22px] overflow-hidden">
          <img src="${game.image || 'https://via.placeholder.com/400x300/232445/ffffff?text=No+Image'}" 
               alt="${game.title}" 
               class="w-full h-full object-cover group-hover:scale-[1.04] transition duration-200 pointer-events-none select-none" />
          ${game.featured ? `<span class="absolute top-2 right-2 bg-indigo-600/80 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow">FEATURED</span>` : ""}
        </div>
        <div class="p-3 flex flex-col gap-1">
          <div class="text-cyan-300 font-bold text-base truncate group-hover:text-cyan-400 transition">${game.title}</div>
          <div class="flex items-center gap-2 flex-wrap">
            <span class="bg-cyan-400/20 text-cyan-300 text-xs px-2 py-0.5 rounded-full font-semibold">${game.category || ''}</span>
            ${(game.tags && game.tags.length) ? `<span class="bg-indigo-400/20 text-indigo-200 text-xs px-2 py-0.5 rounded-full font-semibold">${game.tags[0]}</span>` : ""}
          </div>
        </div>
      </a>
    `).join('');
  }

  
</script>
<script src="comment-section.js"></script>