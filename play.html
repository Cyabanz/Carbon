<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CARBON Game Frame</title>
    <script defer async>
      function setConfig() {
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                display: ["Switzer", "Helvetica", "sans-serif"],
                inter: ["Inter", "sans-serif"],
              },
              colors: {
                base: "#191724",
                surface: "#1f1d2e",
                overlay: "#26233a",
                muted: "#6e6a86",
                subtle: "#908caa",
                text: "#e0def4",
                love: "#eb6f92",
                gold: "#f6c177",
                rose: "#ebbcba",
                pine: "#31748f",
                foam: "#9ccfd8",
                iris: "#c4a7e7",
                "highlight-low": "#21202e",
                "highlight-med": "#403d52",
                "highlight-high": "#524f67",
              },
            },
          },
        };
      }
    </script>
    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" />
    <script defer async src="https://cdn.tailwindcss.com" onload="setConfig()"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="/css/boxicons.min.css" rel="stylesheet" />
    <style>
      .iframe-overlay-btn {
        transition: border-color 0.2s, background 0.2s;
      }
    </style>
  </head>
  <body class="font-inter bg-gradient-to-br from-base via-surface to-overlay min-h-screen text-text overflow-x-hidden">
    <main class="flex flex-col items-center justify-center min-h-screen p-4">
      <div class="w-full max-w-6xl mx-auto">
        <div class="bg-surface/90 backdrop-blur-sm rounded-2xl shadow-2xl border border-overlay/50 overflow-hidden">
          <div class="bg-black border-t border-highlight-med/30 relative">
            <iframe id="game-iframe" title="Game Frame" class="w-full h-[80vh] border-0 bg-black"></iframe>
            <!-- Overlay Buttons -->
            <div class="absolute top-4 right-4 flex gap-2 z-10">
              <button id="likeBtn" class="w-10 h-10 bg-white/10 hover:bg-cyan-500/80 text-white rounded-full flex items-center justify-center transition" title="Like">
                <i class='bx bx-like text-xl'></i>
              </button>
              <button id="favBtn" class="w-10 h-10 bg-white/10 hover:bg-pink-500/80 text-white rounded-full flex items-center justify-center transition" title="Favorite">
                <i class='bx bx-heart text-xl'></i>
              </button>
              <button id="dislikeBtn" class="w-10 h-10 bg-white/10 hover:bg-red-500/80 text-white rounded-full flex items-center justify-center transition" title="Dislike">
                <i class='bx bx-dislike text-xl'></i>
              </button>
              <!-- Proxy Toggle Icon Button -->
              <button id="proxyToggleBtn" class="w-10 h-10 bg-white/10 iframe-overlay-btn rounded-full flex items-center justify-center transition border-2 border-cyan-400"
                title="Toggle Proxy">
                <i id="proxyToggleIcon" class="bx bx-cloud text-xl"></i>
              </button>
              <button id="shareBtn" class="w-10 h-10 bg-white/10 hover:bg-indigo-500/80 text-white rounded-full flex items-center justify-center transition" title="Share">
                <i class='bx bx-share-alt text-xl'></i>
              </button>
              <button id="playlistBtn" class="w-10 h-10 bg-white/10 hover:bg-yellow-400/80 text-white rounded-full flex items-center justify-center transition" title="Add to Playlist">
                <i class='bx bx-list-plus text-xl'></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
    <script type="module">
      import {
        makeURL,
        getProxied,
        setProxy,
        getProxy,
        setTransport,
        setWisp,
      } from "/lethal.mjs";

      // Fetch games.json and get game by ID from ?id= param
      async function fetchGamesData() {
        const res = await fetch("/games.json");
        if (!res.ok) throw new Error("Failed to load games.json");
        return await res.json();
      }
      function getGameIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id");
      }

      // Proxy toggle logic
      const proxyToggleBtn = document.getElementById("proxyToggleBtn");
      const proxyToggleIcon = document.getElementById("proxyToggleIcon");
      function updateProxyToggleUI(proxy) {
        if (proxy === "scram") {
          proxyToggleBtn.classList.remove("border-cyan-400");
          proxyToggleBtn.classList.add("border-gold", "bg-gold/20");
          proxyToggleIcon.className = "bx bx-network-chart text-xl";
          proxyToggleBtn.title = "Scramjet";
        } else {
          proxyToggleBtn.classList.remove("border-gold", "bg-gold/20");
          proxyToggleBtn.classList.add("border-cyan-400");
          proxyToggleIcon.className = "bx bx-cloud text-xl";
          proxyToggleBtn.title = "UV";
        }
      }
      proxyToggleBtn.addEventListener("click", async () => {
        const current = getProxy() || localStorage.getItem("proxy-backend") || "uv";
        const next = current === "scram" ? "uv" : "scram";
        await setProxy(next);
        localStorage.setItem("proxy-backend", next);
        updateProxyToggleUI(next);
        // Reload the game with the new proxy
        loadGameFrame();
      });

      // Loads the game via lethal.mjs proxy (like the browser tabs above)
      async function loadGameFrame() {
        const gameId = getGameIdFromURL();
        if (!gameId) return;
        let game = null;
        try {
          const games = await fetchGamesData();
          game = games.find(g => String(g.id) === String(gameId));
        } catch (e) {
          alert("Could not load games list.");
          return;
        }
        if (!game) {
          alert("Game not found.");
          return;
        }
        const proxy = getProxy() || localStorage.getItem("proxy-backend") || "uv";
        // Lethal requires setProxy (and optionally setTransport/setWisp) before getProxied
        await setProxy(proxy);
        // Default transport/wisp setup (optional, for consistency)
        let wisp = localStorage.getItem("wisp-server") || "wss://anura.pro/";
        let transport = localStorage.getItem("proxy-transport");
        if (wisp) setWisp(wisp);
        if (transport) setTransport(transport);
        else if (navigator.userAgent.indexOf("Firefox") > 0) setTransport("libcurl");
        else setTransport("epoxy");
        // Always use the proxy (UV or scram) via lethal.mjs
        const url = makeURL(game.url, "https://search.brave.com/search?q=%s");
        const proxied = await getProxied(url);
        document.getElementById("game-iframe").src = proxied;
      }

      // Initial setup and load
      (async () => {
        const proxy = getProxy() || localStorage.getItem("proxy-backend") || "uv";
        updateProxyToggleUI(proxy);
        await setProxy(proxy);
        await loadGameFrame();
      })();
    </script>
  </body>
</html>
