<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Extensions Settings</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #181a1b;
      color: #e8e6e3;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 420px;
      margin: 40px auto;
      background: #23272a;
      border-radius: 12px;
      padding: 32px 28px 24px 28px;
      box-shadow: 0 4px 32px #0003;
    }
    h1 {
      font-size: 1.5em;
      margin-bottom: 1.4em;
      letter-spacing: 0.01em;
      text-align: center;
    }
    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid #2c2f33;
    }
    .setting-row:last-child {
      border-bottom: none;
    }
    .setting-label {
      font-size: 1.09em;
      letter-spacing: 0.01em;
    }

    /* Slide Toggle Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 28px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #444951;
      transition: .2s;
      border-radius: 28px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background: #e8e6e3;
      transition: .2s;
      border-radius: 50%;
      box-shadow: 0 2px 8px #0002;
    }
    input:checked + .slider {
      background: #2684ff;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
      background: #fff;
    }
    .desc {
      font-size: 0.98em;
      color: #b2b2b2;
      margin-bottom: 1.4em;
      text-align: center;
    }
    .divider {
      border: none;
      border-top: 1px solid #33373d;
      margin: 30px 0 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Extensions Settings</h1>
    <div class="desc">
      Toggle Ultraviolet iframe features and injectors.<br>
      Your preferences are saved in this browser.
    </div>
    <div class="setting-row">
      <span class="setting-label">Enable Dark Mode (in iframe)</span>
      <label class="switch">
        <input type="checkbox" id="toggle-dark" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="setting-row">
      <span class="setting-label">Enable Custom CSS Injector</span>
      <label class="switch">
        <input type="checkbox" id="toggle-css" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="setting-row">
      <span class="setting-label">Enable Custom JS Injector</span>
      <label class="switch">
        <input type="checkbox" id="toggle-js" checked>
        <span class="slider"></span>
      </label>
    </div>
    <hr class="divider">
    <div class="desc" style="font-size:0.92em;">
      These settings affect only Ultraviolet-proxied iframes.
    </div>
  </div>
  <script>
    // Ultraviolet config
    self.__uv$config = {
      prefix: "/uv/",
      encodeUrl: Ultraviolet.codec.plain.encode,
      decodeUrl: Ultraviolet.codec.plain.decode,
      handler: "https://cdn.jsdelivr.net/npm/@titaniumnetwork-dev/ultraviolet/dist/uv.handler.js",
      client: "https://cdn.jsdelivr.net/npm/@titaniumnetwork-dev/ultraviolet/dist/uv.client.js",
      bundle: "https://cdn.jsdelivr.net/npm/@titaniumnetwork-dev/ultraviolet/dist/uv.bundle.js",
      config: "/uv.config.js",
      sw: "https://cdn.jsdelivr.net/npm/@titaniumnetwork-dev/ultraviolet/dist/uv.sw.js"
    };

    // Keys for localStorage
    const STORAGE_KEY = "uv-extension-settings";
    const defaultSettings = {
      dark: true,
      css: true,
      js: true
    };

    function saveSettings(settings) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
    }
    function loadSettings() {
      try {
        return Object.assign({}, defaultSettings, JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"));
      } catch {
        return defaultSettings;
      }
    }

    // UI toggle logic
    const toggles = {
      dark: document.getElementById('toggle-dark'),
      css: document.getElementById('toggle-css'),
      js: document.getElementById('toggle-js')
    };
    function applySettingsToUI(settings) {
      toggles.dark.checked = !!settings.dark;
      toggles.css.checked = !!settings.css;
      toggles.js.checked = !!settings.js;
    }

    function onChange() {
      const newSettings = {
        dark: toggles.dark.checked,
        css: toggles.css.checked,
        js: toggles.js.checked
      };
      saveSettings(newSettings);
      // Optional: Notify parent or reload if needed
    }

    // Attach listeners
    for (const key in toggles) {
      toggles[key].addEventListener('change', onChange);
    }

    // Load + apply on page load
    const settings = loadSettings();
    applySettingsToUI(settings);

    // --- INJECTION LOGIC ---
    // Only run in browser context, not in worker
    if (typeof window !== "undefined" && typeof document !== "undefined") {
      (function globalEnhancementsInjection() {
        function waitForEvalReady() {
          return new Promise(resolve => {
            if (typeof __uv$eval !== "undefined") return resolve();
            const interval = setInterval(() => {
              if (typeof __uv$eval !== "undefined") {
                clearInterval(interval);
                resolve();
              }
            }, 10);
          });
        }

        // Only run in the proxied iframe, not the main window
        if (window.top === window) return;

        waitForEvalReady().then(() => {
          // Load user settings from parent if possible, fallback to local
          let extSettings = defaultSettings;
          try {
            if (window.parent && window.parent !== window && window.parent.localStorage) {
              extSettings = Object.assign({}, defaultSettings, JSON.parse(window.parent.localStorage.getItem(STORAGE_KEY) || "{}"));
            } else {
              extSettings = loadSettings();
            }
          } catch {
            extSettings = loadSettings();
          }

          let evalScript = "";

          if (extSettings.dark) {
            evalScript += `
            (function injectDarkCSS() {
              const darkCSS = \`
                html, body {
                  background: #181a1b !important;
                  color: #e8e6e3 !important;
                  color-scheme: dark !important;
                }
                * {
                  background-color: transparent !important;
                  border-color: #23272a !important;
                  color: inherit !important;
                }
                a, a * {
                  color: #8ab4f8 !important;
                }
                [class*="background"], [class*="container"], [class*="scroller"], [class*="content"] {
                  background: #181a1b !important;
                  color: #e8e6e3 !important;
                }
                ::selection {
                  background: #3a3f41 !important;
                }
                ::-webkit-scrollbar {
                  background: #23272a !important;
                  width: 12px;
                }
                ::-webkit-scrollbar-thumb {
                  background: #2c2f33 !important;
                }
              \`;
              let style = document.createElement('style');
              style.id = 'uv-injected-dark-css';
              style.textContent = darkCSS;
              document.head.appendChild(style);
            })();`;
          }
          if (extSettings.css) {
            evalScript += `
            window.injectCustomCSS = function(css) {
              let styleTag = document.getElementById('custom-css-injector');
              if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = 'custom-css-injector';
                document.head.appendChild(styleTag);
              }
              styleTag.textContent = css;
            };`;
          }
          if (extSettings.js) {
            evalScript += `
            window.injectCustomScript = function(js) {
              let scriptTag = document.createElement('script');
              scriptTag.type = 'text/javascript';
              scriptTag.textContent = js;
              document.body.appendChild(scriptTag);
            };`;
          }

          if (evalScript.trim()) {
            __uv$eval(evalScript);
          }
        });
      })();
    }
  </script>
</body>
</html>
