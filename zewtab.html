<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Tab - Carbon</title>
    <script defer async>
      function setConfig() {
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                display: ["Switzer", "Helvetica", "sans-serif"],
                inter: ["Inter", "sans-serif"],
              },
              colors: {
                base: "#191724",
                surface: "#1f1d2e",
                overlay: "#26233a",
                muted: "#6e6a86",
                subtle: "#908caa",
                text: "#e0def4",
                love: "#eb6f92",
                gold: "#f6c177",
                rose: "#ebbcba",
                pine: "#31748f",
                foam: "#9ccfd8",
                iris: "#c4a7e7",
                "highlight-low": "#21202e",
                "highlight-med": "#403d52",
                "highlight-high": "#524f67",
              },
            },
          },
        };
      }
    </script>

    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" />
    <script
      defer
      async
      src="https://cdn.tailwindcss.com"
      onload="setConfig()"
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />

    <style>
      :root {
        --text-color: #e0def4;
        --surface-color: #1f1d2e;
        --overlay-color: #26233a;
        --highlight-med: #403d52;
        --highlight-high: #524f67;
        --foam: #9ccfd8;
        --love: #eb6f92;
        --gold: #f6c177;
        --pine: #31748f;
        --iris: #c4a7e7;
        --muted: #6e6a86;
        --subtle: #908caa;
        --theme-base: #191724;
        --theme-surface: #1f1d2e;
        --theme-overlay: #26233a;
        --theme-muted: #6e6a86;
        --theme-subtle: #908caa;
        --theme-text: #e0def4;
        --theme-love: #eb6f92;
        --theme-gold: #f6c177;
        --theme-rose: #ebbcba;
        --theme-pine: #31748f;
        --theme-foam: #9ccfd8;
        --theme-iris: #c4a7e7;
        --theme-highlight-low: #21202e;
        --theme-highlight-med: #403d52;
        --theme-highlight-high: #524f67;
        --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
      }
      .bookmark-card:hover {
        transform: translateY(-2px);
      }
      .bookmark-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .bookmark-options {
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .bookmark-card:hover .bookmark-options {
        opacity: 1;
      }
      .settings-modal {
        transition: all 0.3s ease;
      }
      .modal-content {
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal-content::-webkit-scrollbar {
        width: 8px;
      }
      .modal-content::-webkit-scrollbar-track {
        background: var(--theme-surface);
      }
      .modal-content::-webkit-scrollbar-thumb {
        background: var(--theme-foam);
        border-radius: 4px;
      }
      .modal-content::-webkit-scrollbar-thumb:hover {
        background: var(--theme-foam);
      }
      .theme-preview.active {
        border: 2px solid var(--theme-foam) !important;
      }
      .newtab-bg-preview.active {
        border: 2px solid var(--theme-foam) !important;
      }
      .select-none {
        user-select: none;
      }
      .blur-sm {
        filter: blur(4px);
      }
    </style>
  </head>
  <body class="font-inter min-h-screen bg-[var(--theme-base)] text-[var(--theme-text)] transition-all duration-300">
    <!-- Theme color schemes -->
    <script>
      document.documentElement.setAttribute('data-theme', 'rose-pine');
    </script>

    <!-- Particles Canvas -->
    <canvas id="particles-canvas" class="fixed inset-0 pointer-events-none hidden"></canvas>

    <!-- Main Content -->
    <div class="min-h-screen flex flex-col items-center justify-center px-4 relative">
      <!-- Clock -->
      <div id="clock" class="text-4xl md:text-5xl font-display font-semibold mb-6"></div>

      <!-- Search Bar -->
      <div class="w-full max-w-lg relative mb-8">
        <input
          type="text"
          id="search-input"
          placeholder="Search the web..."
          class="w-full px-4 py-3 bg-[var(--theme-surface)] text-[var(--theme-text)] rounded-lg border border-[var(--theme-highlight-med)] focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200 text-sm"
        />
        <i class="bx bx-search absolute right-3 top-1/2 transform -translate-y-1/2 text-[var(--theme-muted)]"></i>
      </div>

      <!-- Bookmarks -->
      <div id="bookmarks-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 max-w-4xl w-full">
        <!-- Bookmarks will be populated dynamically -->
      </div>

      <!-- Settings Button -->
      <button id="settings-btn" class="fixed bottom-4 right-4 bg-[var(--theme-foam)] text-[var(--theme-base)] p-2 rounded-full shadow-lg hover:bg-[var(--theme-foam)]/80 transition-all duration-200">
        <i class="bx bx-cog text-xl"></i>
      </button>

      <!-- Settings Modal -->
      <div id="settings-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden transition-all duration-300">
        <div class="bg-[var(--theme-surface)] rounded-xl p-6 max-w-lg w-full shadow-lg modal-content">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold flex items-center gap-2">
              <i class="bx bx-cog text-[var(--theme-foam)]"></i>
              Settings
            </h2>
            <button id="close-settings" class="text-[var(--theme-muted)] hover:text-[var(--theme-love)] transition-colors">
              <i class="bx bx-x text-2xl"></i>
            </button>
          </div>

          <!-- Panic Key -->
          <div class="mb-6">
            <h3 class="text-lg font-medium flex items-center gap-2 mb-2">
              <i class="bx bx-shield-alt-2 text-[var(--theme-love)]"></i>
              Panic Key
              <span id="panic-status" class="w-2 h-2 rounded-full bg-[var(--theme-muted)]"></span>
            </h3>
            <p class="text-[var(--theme-muted)] text-sm mb-2">Set a key to close Carbon and redirect</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-1">Current Key</label>
                <div id="panic-key-display" class="bg-[var(--theme-overlay)] text-[var(--theme-foam)] rounded-lg p-3 text-center text-sm font-medium">Press "Set Key" to configure</div>
              </div>
              <div>
                <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-1">Actions</label>
                <div class="flex gap-2">
                  <button id="set-panic-key" class="flex items-center gap-1 px-3 py-2 bg-[var(--theme-foam)] text-[var(--theme-base)] rounded-lg text-sm hover:bg-[var(--theme-foam)]/80 transition-all duration-200">
                    <i class="bx bx-key"></i>
                    Set Key
                  </button>
                  <button id="clear-panic-key" class="flex items-center gap-1 px-3 py-2 bg-[var(--theme-love)] text-white rounded-lg text-sm hover:bg-[var(--theme-love)]/80 transition-all duration-200">
                    <i class="bx bx-trash"></i>
                    Clear
                  </button>
                </div>
              </div>
            </div>
            <div class="mt-4">
              <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-1">Redirect URL</label>
              <input type="url" id="panic-url" placeholder="https://classroom.google.com" class="w-full px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
            </div>
          </div>

          <!-- Theme & Background -->
          <div class="mb-6">
            <h3 class="text-lg font-medium flex items-center gap-2 mb-2">
              <i class="bx bx-palette text-[var(--theme-iris)]"></i>
              Theme & Background
            </h3>
            <p class="text-[var(--theme-muted)] text-sm mb-2">Customize appearance</p>
            <div class="mb-4">
              <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-2">Themes</label>
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div class="theme-preview active rounded-lg p-2 cursor-pointer border border-transparent hover:border-[var(--theme-foam)] transition-all duration-200" data-theme="rose-pine" style="background: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);">
                  <div class="text-center text-xs text-white">Rose Pine</div>
                </div>
                <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-[var(--theme-foam)] transition-all duration-200" data-theme="dark" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);">
                  <div class="text-center text-xs text-white">Dark</div>
                </div>
                <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-[var(--theme-foam)] transition-all duration-200" data-theme="light" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);">
                  <div class="text-center text-xs text-black">Light</div>
                </div>
                <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-[var(--theme-foam)] transition-all duration-200" data-theme="catppuccin" style="background: linear-gradient(135deg, #1e1e2e 0%, #313244 50%, #45475a 100%);">
                  <div class="text-center text-xs text-white">Catppuccin</div>
                </div>
                <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-[var(--theme-foam)] transition-all duration-200" data-theme="nord" style="background: linear-gradient(135deg, #2e3440 0%, #3b4252 50%, #434c5e 100%);">
                  <div class="text-center text-xs text-white">Nord</div>
                </div>
                <div class="theme-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-[var(--theme-foam)] transition-all duration-200" data-theme="dracula" style="background: linear-gradient(135deg, #282a36 0%, #44475a 50%, #6272a4 100%);">
                  <div class="text-center text-xs text-white">Dracula</div>
                </div>
              </div>
            </div>

            <!-- New Tab Background Settings -->
            <div class="mt-6">
              <h3 class="text-lg font-medium flex items-center gap-2 mb-2">
                <i class="bx bx-image text-[var(--theme-iris)]"></i>
                New Tab Background
              </h3>
              <p class="text-[var(--theme-muted)] text-sm mb-2">Customize the background for new tabs</p>
              
              <!-- Background Type Selection -->
              <div class="mb-4">
                <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-2">Background Type</label>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                  <div class="newtab-bg-preview active rounded-lg p-2 cursor-pointer border border-[var(--theme-foam)] transition-all duration-200" data-newtab-bg="theme" style="background: var(--theme-gradient);">
                    <div class="text-center text-xs text-white">Theme</div>
                  </div>
                  <div class="newtab-bg-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-[var(--theme-foam)] transition-all duration-200" data-newtab-bg="image">
                    <div class="text-center text-xs text-white">Image</div>
                  </div>
                  <div class="newtab-bg-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-[var(--theme-foam)] transition-all duration-200" data-newtab-bg="unsplash">
                    <div class="text-center text-xs text-white">Unsplash</div>
                  </div>
                  <div class="newtab-bg-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-[var(--theme-foam)] transition-all duration-200" data-newtab-bg="gradient">
                    <div class="text-center text-xs text-white">Gradient</div>
                  </div>
                </div>
              </div>

              <!-- Image URL Input -->
              <div id="newtab-image-section" class="mb-4 hidden">
                <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-2">Image URL</label>
                <div class="flex gap-2">
                  <input type="url" id="newtab-image-url" placeholder="https://example.com/image.jpg" class="flex-1 px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
                  <button id="test-newtab-image" class="px-3 py-2 bg-[var(--theme-gold)] text-[var(--theme-base)] rounded-lg text-sm hover:bg-[var(--theme-gold)]/80 transition-all duration-200">
                    <i class="bx bx-test-tube"></i>
                  </button>
                </div>
                <p class="text-xs text-[var(--theme-muted)] mt-1">Enter a direct image URL (JPG, PNG, WebP)</p>
              </div>

              <!-- Unsplash Settings -->
              <div id="newtab-unsplash-section" class="mb-4 hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-2">Category</label>
                    <select id="newtab-unsplash-category" class="w-full px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
                      <option value="nature">Nature</option>
                      <option value="city">City</option>
                      <option value="abstract">Abstract</option>
                      <option value="minimal">Minimal</option>
                      <option value="space">Space</option>
                      <option value="ocean">Ocean</option>
                      <option value="mountains">Mountains</option>
                      <option value="forest">Forest</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-2">Update Frequency</label>
                    <select id="newtab-unsplash-frequency" class="w-full px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
                      <option value="daily">Daily</option>
                      <option value="weekly">Weekly</option>
                      <option value="monthly">Monthly</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Gradient Settings -->
              <div id="newtab-gradient-section" class="mb-4 hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-2">Gradient Type</label>
                    <select id="newtab-gradient-type" class="w-full px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
                      <option value="linear">Linear</option>
                      <option value="radial">Radial</option>
                      <option value="conic">Conic</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-2">Direction</label>
                    <select id="newtab-gradient-direction" class="w-full px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
                      <option value="to right">Horizontal</option>
                      <option value="to bottom">Vertical</option>
                      <option value="to bottom right">Diagonal</option>
                      <option value="45deg">45°</option>
                      <option value="135deg">135°</option>
                    </select>
                  </div>
                </div>
                <div class="mt-4">
                  <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-2">Colors</label>
                  <div class="flex gap-2">
                    <input type="color" id="newtab-gradient-color1" value="#667eea" class="w-12 h-10 border border-[var(--theme-highlight-med)] rounded cursor-pointer">
                    <input type="color" id="newtab-gradient-color2" value="#764ba2" class="w-12 h-10 border border-[var(--theme-highlight-med)] rounded cursor-pointer">
                    <input type="color" id="newtab-gradient-color3" value="#f093fb" class="w-12 h-10 border border-[var(--theme-highlight-med)] rounded cursor-pointer">
                    <button id="random-gradient" class="px-3 py-2 bg-[var(--theme-iris)] text-white rounded-lg text-sm hover:bg-[var(--theme-iris)]/80 transition-all duration-200">
                      <i class="bx bx-shuffle"></i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Preview -->
              <div class="mt-4">
                <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-2">Preview</label>
                <div id="newtab-bg-preview" class="w-full h-32 rounded-lg border border-[var(--theme-highlight-med)] relative overflow-hidden">
                  <div class="absolute inset-0 flex items-center justify-center">
                    <span class="text-sm font-medium text-white">New Tab Background Preview</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Save Settings -->
          <div class="text-center">
            <button id="save-settings" class="px-6 py-2 bg-[var(--theme-foam)] text-[var(--theme-base)] rounded-lg text-sm font-medium hover:bg-[var(--theme-foam)]/80 transition-all duration-200">
              <i class="bx bx-check mr-1"></i>
              Auto-Save Enabled
            </button>
          </div>
        </div>
      </div>

      <!-- Add Bookmark Modal -->
      <div id="add-bookmark-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden transition-all duration-300">
        <div class="bg-[var(--theme-surface)] rounded-xl p-6 max-w-sm w-full shadow-lg">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold flex items-center gap-2">
              <i class="bx bx-bookmark-plus text-[var(--theme-foam)]"></i>
              Add Bookmark
            </h2>
            <button id="close-add-bookmark" class="text-[var(--theme-muted)] hover:text-[var(--theme-love)] transition-colors">
              <i class="bx bx-x text-2xl"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-1">Name</label>
              <input type="text" id="bookmark-name" placeholder="Bookmark Name" class="w-full px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
            </div>
            <div>
              <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-1">URL</label>
              <input type="url" id="bookmark-url" placeholder="https://example.com" class="w-full px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
            </div>
            <div>
              <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-1">Icon (optional)</label>
              <input type="url" id="bookmark-icon" placeholder="https://example.com/icon.png" class="w-full px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
            </div>
            <button id="save-bookmark" class="w-full px-4 py-2 bg-[var(--theme-foam)] text-[var(--theme-base)] rounded-lg text-sm hover:bg-[var(--theme-foam)]/80 transition-all duration-200">
              Save Bookmark
            </button>
          </div>
        </div>
      </div>

      <!-- Edit Bookmark Modal -->
      <div id="edit-bookmark-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden transition-all duration-300">
        <div class="bg-[var(--theme-surface)] rounded-xl p-6 max-w-sm w-full shadow-lg">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold flex items-center gap-2">
              <i class="bx bx-edit text-[var(--theme-foam)]"></i>
              Edit Bookmark
            </h2>
            <button id="close-edit-bookmark" class="text-[var(--theme-muted)] hover:text-[var(--theme-love)] transition-colors">
              <i class="bx bx-x text-2xl"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-1">Name</label>
              <input type="text" id="edit-bookmark-name" class="w-full px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
            </div>
            <div>
              <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-1">URL</label>
              <input type="url" id="edit-bookmark-url" class="w-full px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
            </div>
            <div>
              <label class="block text-xs font-medium text-[var(--theme-subtle)] mb-1">Icon (optional)</label>
              <input type="url" id="edit-bookmark-icon" class="w-full px-3 py-2 bg-[var(--theme-overlay)] border border-[var(--theme-highlight-med)] text-[var(--theme-text)] rounded-lg text-sm focus:border-[var(--theme-foam)] focus:ring-1 focus:ring-[var(--theme-foam)]/30 transition-all duration-200">
            </div>
            <div class="flex gap-2">
              <button id="update-bookmark" class="flex-1 px-4 py-2 bg-[var(--theme-foam)] text-[var(--theme-base)] rounded-lg text-sm hover:bg-[var(--theme-foam)]/80 transition-all duration-200">
                Update
              </button>
              <button id="delete-bookmark" class="flex-1 px-4 py-2 bg-[var(--theme-love)] text-white rounded-lg text-sm hover:bg-[var(--theme-love)]/80 transition-all duration-200">
                Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
        authDomain: "carbon-services.firebaseapp.com",
        projectId: "carbon-services",
        storageBucket: "carbon-services.firebasestorage.app",
        messagingSenderId: "288385472070",
        appId: "1:288385472070:web:c4be3ff186e248fc645c47",
        measurementId: "G-Y2K1RQYE74"
      };
      
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      
      let bookmarks = [];
      let panicKey = null;
      let isRecordingPanicKey = false;
      let currentTheme = 'rose-pine';
      let currentUser = null;

      // New Tab Background Settings
      let newtabBackgroundType = 'theme';
      let newtabImageUrl = '';
      let newtabUnsplashCategory = 'nature';
      let newtabUnsplashFrequency = 'daily';
      let newtabGradientType = 'linear';
      let newtabGradientDirection = 'to right';
      let newtabGradientColors = ['#667eea', '#764ba2', '#f093fb'];

      function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById('clock').textContent = timeString;
      }

      async function loadBookmarks() {
        if (currentUser) {
          try {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('bookmarks').get();
            bookmarks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          } catch (error) {
            console.error('Error loading bookmarks:', error);
          }
        } else {
          bookmarks = JSON.parse(localStorage.getItem('carbon-bookmarks') || '[]');
        }
        renderBookmarks();
      }

      function renderBookmarks() {
        const container = document.getElementById('bookmarks-container');
        container.innerHTML = '';
        bookmarks.forEach((bookmark, index) => {
          const card = document.createElement('div');
          card.className = 'bookmark-card bg-[var(--theme-surface)] rounded-lg p-4 flex flex-col items-center justify-center shadow-sm hover:shadow-md transition-all duration-200 relative';
          card.innerHTML = `
            <a href="${bookmark.url}" target="_blank" class="flex flex-col items-center w-full">
              ${bookmark.icon ? `<img src="${bookmark.icon}" alt="${bookmark.name}" class="w-8 h-8 mb-2 rounded">` : `<i class="bx bx-link text-2xl text-[var(--theme-foam)] mb-2"></i>`}
              <span class="text-sm text-center text-[var(--theme-text)] truncate w-full">${bookmark.name}</span>
            </a>
            <div class="bookmark-options absolute top-2 right-2 flex gap-1">
              <button class="edit-bookmark text-[var(--theme-muted)] hover:text-[var(--theme-foam)] transition-colors" data-index="${index}">
                <i class="bx bx-edit text-sm"></i>
              </button>
              <button class="delete-bookmark text-[var(--theme-muted)] hover:text-[var(--theme-love)] transition-colors" data-index="${index}">
                <i class="bx bx-trash text-sm"></i>
              </button>
            </div>
          `;
          container.appendChild(card);
        });

        const addCard = document.createElement('div');
        addCard.className = 'bookmark-card bg-[var(--theme-surface)] rounded-lg p-4 flex flex-col items-center justify-center shadow-sm hover:shadow-md transition-all duration-200 cursor-pointer';
        addCard.innerHTML = `
          <i class="bx bx-plus text-2xl text-[var(--theme-foam)] mb-2"></i>
          <span class="text-sm text-[var(--theme-text)]">Add Bookmark</span>
        `;
        addCard.addEventListener('click', () => {
          document.getElementById('add-bookmark-modal').classList.remove('hidden');
          document.getElementById('bookmark-name').focus();
        });
        container.appendChild(addCard);
      }

      async function addBookmark(bookmark) {
        if (currentUser) {
          try {
            const docRef = await db.collection('users').doc(currentUser.uid).collection('bookmarks').add(bookmark);
            bookmarks.push({ id: docRef.id, ...bookmark });
          } catch (error) {
            console.error('Error adding bookmark:', error);
          }
        } else {
          bookmarks.push(bookmark);
          localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
        }
        renderBookmarks();
      }

      async function updateBookmark(index, updatedBookmark) {
        if (currentUser) {
          try {
            const bookmark = bookmarks[index];
            await db.collection('users').doc(currentUser.uid).collection('bookmarks').doc(bookmark.id).update(updatedBookmark);
            bookmarks[index] = { id: bookmark.id, ...updatedBookmark };
          } catch (error) {
            console.error('Error updating bookmark:', error);
          }
        } else {
          bookmarks[index] = updatedBookmark;
          localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
        }
        renderBookmarks();
      }

      async function deleteBookmark(index) {
        if (currentUser) {
          try {
            const bookmark = bookmarks[index];
            await db.collection('users').doc(currentUser.uid).collection('bookmarks').doc(bookmark.id).delete();
            bookmarks.splice(index, 1);
          } catch (error) {
            console.error('Error deleting bookmark:', error);
          }
        } else {
          bookmarks.splice(index, 1);
          localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
        }
        renderBookmarks();
      }

      async function loadSettingsFromFirebase() {
        if (!currentUser) {
          loadSettings();
          return;
        }
        try {
          const userSettingsDoc = await db.collection('users').doc(currentUser.uid).get();
          if (userSettingsDoc.exists) {
            const settings = userSettingsDoc.data().settings || {};
            if (settings.panicKey) {
              panicKey = settings.panicKey;
              document.getElementById('panic-key-display').textContent = panicKey.toUpperCase();
            }
            if (settings.panicUrl) {
              document.getElementById('panic-url').value = settings.panicUrl;
            }
            if (settings.theme) {
              currentTheme = settings.theme;
              document.querySelectorAll('.theme-preview').forEach(el => el.classList.remove('active', 'border-[var(--theme-foam)]'));
              document.querySelector(`[data-theme="${settings.theme}"]`)?.classList.add('active', 'border-[var(--theme-foam)]');
            }
            // Load New Tab Background Settings
            if (settings.newtabBackgroundType) {
              newtabBackgroundType = settings.newtabBackgroundType;
              newtabImageUrl = settings.newtabImageUrl || '';
              newtabUnsplashCategory = settings.newtabUnsplashCategory || 'nature';
              newtabUnsplashFrequency = settings.newtabUnsplashFrequency || 'daily';
              newtabGradientType = settings.newtabGradientType || 'linear';
              newtabGradientDirection = settings.newtabGradientDirection || 'to right';
              newtabGradientColors = settings.newtabGradientColors || ['#667eea', '#764ba2', '#f093fb'];
              loadNewtabBackgroundSettings();
            }
            applySettings();
            updateStatusIndicators();
          } else {
            loadSettings();
          }
        } catch (error) {
          console.error('Error loading settings from Firebase:', error);
          loadSettings();
        }
      }

      async function saveSettingsToFirebase() {
        if (!currentUser) return;
        try {
          const settings = {
            panicKey: panicKey || '',
            panicUrl: document.getElementById('panic-url').value,
            theme: currentTheme,
            newtabBackgroundType: newtabBackgroundType,
            newtabImageUrl: newtabImageUrl,
            newtabUnsplashCategory: newtabUnsplashCategory,
            newtabUnsplashFrequency: newtabUnsplashFrequency,
            newtabGradientType: newtabGradientType,
            newtabGradientDirection: newtabGradientDirection,
            newtabGradientColors: newtabGradientColors,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          };
          await db.collection('users').doc(currentUser.uid).set({ settings }, { merge: true });
        } catch (error) {
          console.error('Error saving settings to Firebase:', error);
        }
      }

      function loadSettings() {
        const savedPanicKey = localStorage.getItem('carbon-panic-key');
        if (savedPanicKey) {
          panicKey = savedPanicKey;
          document.getElementById('panic-key-display').textContent = panicKey.toUpperCase();
        }
        const savedPanicUrl = localStorage.getItem('carbon-panic-url');
        if (savedPanicUrl) {
          document.getElementById('panic-url').value = savedPanicUrl;
        }
        const savedTheme = localStorage.getItem('carbon-theme-global') || 'rose-pine';
        currentTheme = savedTheme;
        document.querySelectorAll('.theme-preview').forEach(el => el.classList.remove('active', 'border-[var(--theme-foam)]'));
        document.querySelector(`[data-theme="${savedTheme}"]`)?.classList.add('active', 'border-[var(--theme-foam)]');
        
        // Load New Tab Background Settings
        newtabBackgroundType = localStorage.getItem('carbon-newtab-bg-type') || 'theme';
        newtabImageUrl = localStorage.getItem('carbon-newtab-image-url') || '';
        newtabUnsplashCategory = localStorage.getItem('carbon-newtab-unsplash-category') || 'nature';
        newtabUnsplashFrequency = localStorage.getItem('carbon-newtab-unsplash-frequency') || 'daily';
        newtabGradientType = localStorage.getItem('carbon-newtab-gradient-type') || 'linear';
        newtabGradientDirection = localStorage.getItem('carbon-newtab-gradient-direction') || 'to right';
        const savedColors = localStorage.getItem('carbon-newtab-gradient-colors');
        if (savedColors) {
          newtabGradientColors = JSON.parse(savedColors);
        }
        
        updateNewtabBackgroundUI();
        applyBackground();
        applySettings();
        updateStatusIndicators();
      }

      function updateStatusIndicators() {
        const panicStatus = document.getElementById('panic-status');
        if (panicKey) {
          panicStatus.classList.remove('bg-[var(--theme-muted)]');
          panicStatus.classList.add('bg-[var(--theme-foam)]', 'animate-pulse');
        } else {
          panicStatus.classList.remove('bg-[var(--theme-foam)]', 'animate-pulse');
          panicStatus.classList.add('bg-[var(--theme-muted)]');
        }
      }

      function applySettings() {
        applyTheme(currentTheme);
        applyBackground();
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({
            type: 'carbon-settings-updated',
            settings: {
              panicKey: panicKey,
              panicUrl: document.getElementById('panic-url').value,
              theme: currentTheme,
              newtabBackgroundType: newtabBackgroundType,
              newtabImageUrl: newtabImageUrl,
              newtabUnsplashCategory: newtabUnsplashCategory,
              newtabUnsplashFrequency: newtabUnsplashFrequency,
              newtabGradientType: newtabGradientType,
              newtabGradientDirection: newtabGradientDirection,
              newtabGradientColors: newtabGradientColors
            }
          }, '*');
        }
      }

      function applyTheme(theme) {
        if (window.carbonTheme) {
          window.carbonTheme.setTheme(theme);
        } else {
          document.documentElement.setAttribute('data-theme', theme);
        }
        updateNewtabBackgroundPreviews();
      }

      function updateNewtabBackgroundPreviews() {
        const themePreview = document.querySelector('[data-newtab-bg="theme"]');
        if (themePreview) themePreview.style.background = 'var(--theme-gradient)';
        // Update other previews if needed
        updateNewtabBackgroundPreview();
      }

      async function applyBackground() {
        const body = document.body;
        const particlesCanvas = document.getElementById('particles-canvas');
        particlesCanvas.classList.add('hidden');
        body.style.background = '';

        switch (newtabBackgroundType) {
          case 'theme':
            body.style.background = 'var(--theme-gradient)';
            body.style.backgroundAttachment = 'fixed';
            break;
          case 'image':
            if (newtabImageUrl) {
              body.style.background = `url(${newtabImageUrl}) center/cover fixed`;
            } else {
              body.style.background = 'var(--theme-gradient)';
              body.style.backgroundAttachment = 'fixed';
            }
            break;
          case 'unsplash':
            const imageUrl = await getUnsplashImage();
            if (imageUrl) {
              body.style.background = `url(${imageUrl}) center/cover fixed`;
            } else {
              body.style.background = 'var(--theme-gradient)';
              body.style.backgroundAttachment = 'fixed';
            }
            break;
          case 'gradient':
            const gradientColors = newtabGradientColors.join(', ');
            if (newtabGradientType === 'radial') {
              body.style.background = `radial-gradient(circle, ${gradientColors})`;
            } else if (newtabGradientType === 'conic') {
              body.style.background = `conic-gradient(from 0deg, ${gradientColors})`;
            } else {
              body.style.background = `linear-gradient(${newtabGradientDirection}, ${gradientColors})`;
            }
            body.style.backgroundAttachment = 'fixed';
            break;
          default:
            body.style.background = 'var(--theme-gradient)';
            body.style.backgroundAttachment = 'fixed';
            break;
        }
      }

      async function getUnsplashImage() {
        const lastFetch = localStorage.getItem('carbon-unsplash-last-fetch');
        const lastImage = localStorage.getItem('carbon-unsplash-image');
        const now = new Date();
        let shouldFetch = false;

        if (!lastFetch || !lastImage) {
          shouldFetch = true;
        } else {
          const lastFetchDate = new Date(parseInt(lastFetch));
          const diffDays = (now - lastFetchDate) / (1000 * 60 * 60 * 24);
          if (newtabUnsplashFrequency === 'daily' && diffDays >= 1) {
            shouldFetch = true;
          } else if (newtabUnsplashFrequency === 'weekly' && diffDays >= 7) {
            shouldFetch = true;
          } else if (newtabUnsplashFrequency === 'monthly' && diffDays >= 30) {
            shouldFetch = true;
          }
        }

        if (shouldFetch) {
          try {
            const response = await fetch(`https://source.unsplash.com/1920x1080/?${newtabUnsplashCategory}`);
            const imageUrl = response.url;
            localStorage.setItem('carbon-unsplash-image', imageUrl);
            localStorage.setItem('carbon-unsplash-last-fetch', Date.now().toString());
            return imageUrl;
          } catch (error) {
            console.error('Error fetching Unsplash image:', error);
            return lastImage || 'var(--theme-gradient)';
          }
        }
        return lastImage;
      }

      function loadNewtabBackgroundSettings() {
        document.getElementById('newtab-image-url').value = newtabImageUrl;
        document.getElementById('newtab-unsplash-category').value = newtabUnsplashCategory;
        document.getElementById('newtab-unsplash-frequency').value = newtabUnsplashFrequency;
        document.getElementById('newtab-gradient-type').value = newtabGradientType;
        document.getElementById('newtab-gradient-direction').value = newtabGradientDirection;
        document.getElementById('newtab-gradient-color1').value = newtabGradientColors[0];
        document.getElementById('newtab-gradient-color2').value = newtabGradientColors[1];
        document.getElementById('newtab-gradient-color3').value = newtabGradientColors[2];
        updateNewtabBackgroundUI();
        updateNewtabBackgroundPreview();
      }

      function updateNewtabBackgroundUI() {
        document.querySelectorAll('.newtab-bg-preview').forEach(el => {
          el.classList.remove('active', 'border-[var(--theme-foam)]');
        });
        const activeElement = document.querySelector(`[data-newtab-bg="${newtabBackgroundType}"]`);
        if (activeElement) {
          activeElement.classList.add('active', 'border-[var(--theme-foam)]');
        }

        document.getElementById('newtab-image-section').classList.add('hidden');
        document.getElementById('newtab-unsplash-section').classList.add('hidden');
        document.getElementById('newtab-gradient-section').classList.add('hidden');

        switch (newtabBackgroundType) {
          case 'image':
            document.getElementById('newtab-image-section').classList.remove('hidden');
            break;
          case 'unsplash':
            document.getElementById('newtab-unsplash-section').classList.remove('hidden');
            break;
          case 'gradient':
            document.getElementById('newtab-gradient-section').classList.remove('hidden');
            break;
        }
      }

      function updateNewtabBackgroundPreview() {
        const preview = document.getElementById('newtab-bg-preview');
        if (!preview) return;

        let backgroundStyle = '';
        switch (newtabBackgroundType) {
          case 'theme':
            backgroundStyle = 'var(--theme-gradient)';
            break;
          case 'image':
            backgroundStyle = newtabImageUrl ? `url(${newtabImageUrl}) center/cover` : 'var(--theme-gradient)';
            break;
          case 'unsplash':
            backgroundStyle = `linear-gradient(135deg, #667eea 0%, #764ba2 100%)`; // Placeholder for preview
            break;
          case 'gradient':
            const gradientColors = newtabGradientColors.join(', ');
            if (newtabGradientType === 'radial') {
              backgroundStyle = `radial-gradient(circle, ${gradientColors})`;
            } else if (newtabGradientType === 'conic') {
              backgroundStyle = `conic-gradient(from 0deg, ${gradientColors})`;
            } else {
              backgroundStyle = `linear-gradient(${newtabGradientDirection}, ${gradientColors})`;
            }
            break;
          default:
            backgroundStyle = 'var(--theme-gradient)';
        }
        
        preview.style.background = backgroundStyle;
      }

      function saveNewtabBackgroundSettings() {
        localStorage.setItem('carbon-newtab-bg-type', newtabBackgroundType);
        localStorage.setItem('carbon-newtab-image-url', newtabImageUrl);
        localStorage.setItem('carbon-newtab-unsplash-category', newtabUnsplashCategory);
        localStorage.setItem('carbon-newtab-unsplash-frequency', newtabUnsplashFrequency);
        localStorage.setItem('carbon-newtab-gradient-type', newtabGradientType);
        localStorage.setItem('carbon-newtab-gradient-direction', newtabGradientDirection);
        localStorage.setItem('carbon-newtab-gradient-colors', JSON.stringify(newtabGradientColors));
      }

      function hslToHex(h, s, l) {
        l /= 100;
        const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
          const k = (n + h / 30) % 12;
          const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
          return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`;
      }

      auth.onAuthStateChanged(user => {
        currentUser = user;
        loadBookmarks();
        loadSettingsFromFirebase();
      });

      document.addEventListener('DOMContentLoaded', () => {
        updateClock();
        setInterval(updateClock, 1000);
        loadSettings();
        loadBookmarks();

        document.getElementById('settings-btn').addEventListener('click', () => {
          document.getElementById('settings-modal').classList.remove('hidden');
        });

        document.getElementById('close-settings').addEventListener('click', () => {
          document.getElementById('settings-modal').classList.add('hidden');
        });

        document.getElementById('set-panic-key').addEventListener('click', () => {
          if (isRecordingPanicKey) return;
          isRecordingPanicKey = true;
          const display = document.getElementById('panic-key-display');
          display.textContent = 'Press any key...';
          display.classList.add('bg-[var(--theme-love)]', 'text-white', 'border-[var(--theme-love)]', 'animate-pulse');
          function recordKey(e) {
            e.preventDefault();
            panicKey = e.key.toLowerCase();
            display.textContent = panicKey.toUpperCase();
            display.classList.remove('bg-[var(--theme-love)]', 'text-white', 'border-[var(--theme-love)]', 'animate-pulse');
            isRecordingPanicKey = false;
            document.removeEventListener('keydown', recordKey);
            updateStatusIndicators();
            triggerAutoSave();
          }
          document.addEventListener('keydown', recordKey);
        });

        document.getElementById('clear-panic-key').addEventListener('click', () => {
          panicKey = null;
          document.getElementById('panic-key-display').textContent = 'Press "Set Key" to configure';
          updateStatusIndicators();
          triggerAutoSave();
        });

        document.getElementById('panic-url').addEventListener('input', triggerAutoSave);

        document.querySelectorAll('.theme-preview').forEach(preview => {
          preview.addEventListener('click', () => {
            document.querySelectorAll('.theme-preview').forEach(el => el.classList.remove('active', 'border-[var(--theme-foam)]'));
            preview.classList.add('active', 'border-[var(--theme-foam)]');
            currentTheme = preview.dataset.theme;
            localStorage.setItem('carbon-theme-global', currentTheme);
            applyTheme(currentTheme);
            triggerAutoSave();
          });
        });

        document.getElementById('save-bookmark').addEventListener('click', () => {
          const name = document.getElementById('bookmark-name').value;
          const url = document.getElementById('bookmark-url').value;
          const icon = document.getElementById('bookmark-icon').value;
          if (name && url) {
            addBookmark({ name, url, icon });
            document.getElementById('add-bookmark-modal').classList.add('hidden');
            document.getElementById('bookmark-name').value = '';
            document.getElementById('bookmark-url').value = '';
            document.getElementById('bookmark-icon').value = '';
          }
        });

        document.getElementById('close-add-bookmark').addEventListener('click', () => {
          document.getElementById('add-bookmark-modal').classList.add('hidden');
        });

        document.getElementById('bookmarks-container').addEventListener('click', e => {
          if (e.target.closest('.edit-bookmark')) {
            const index = e.target.closest('.edit-bookmark').dataset.index;
            const bookmark = bookmarks[index];
            document.getElementById('edit-bookmark-name').value = bookmark.name;
            document.getElementById('edit-bookmark-url').value = bookmark.url;
            document.getElementById('edit-bookmark-icon').value = bookmark.icon || '';
            document.getElementById('edit-bookmark-modal').dataset.index = index;
            document.getElementById('edit-bookmark-modal').classList.remove('hidden');
          }
          if (e.target.closest('.delete-bookmark')) {
            const index = e.target.closest('.delete-bookmark').dataset.index;
            if (confirm('Delete this bookmark?')) {
              deleteBookmark(index);
            }
          }
        });

        document.getElementById('update-bookmark').addEventListener('click', () => {
          const index = document.getElementById('edit-bookmark-modal').dataset.index;
          const name = document.getElementById('edit-bookmark-name').value;
          const url = document.getElementById('edit-bookmark-url').value;
          const icon = document.getElementById('edit-bookmark-icon').value;
          if (name && url) {
            updateBookmark(index, { name, url, icon });
            document.getElementById('edit-bookmark-modal').classList.add('hidden');
          }
        });

        document.getElementById('delete-bookmark').addEventListener('click', () => {
          const index = document.getElementById('edit-bookmark-modal').dataset.index;
          deleteBookmark(index);
          document.getElementById('edit-bookmark-modal').classList.add('hidden');
        });

        document.getElementById('close-edit-bookmark').addEventListener('click', () => {
          document.getElementById('edit-bookmark-modal').classList.add('hidden');
        });

        document.getElementById('search-input').addEventListener('keypress', e => {
          if (e.key === 'Enter') {
            const query = e.target.value;
            if (query) {
              window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            }
          }
        });

        // New Tab Background Event Listeners
        document.addEventListener('click', e => {
          if (e.target.closest('.newtab-bg-preview')) {
            const preview = e.target.closest('.newtab-bg-preview');
            const bgType = preview.dataset.newtabBg;
            if (bgType) {
              document.querySelectorAll('.newtab-bg-preview').forEach(el => {
                el.classList.remove('active', 'border-[var(--theme-foam)]');
              });
              preview.classList.add('active', 'border-[var(--theme-foam)]');
              newtabBackgroundType = bgType;
              updateNewtabBackgroundUI();
              updateNewtabBackgroundPreview();
              saveNewtabBackgroundSettings();
              applyBackground();
              triggerAutoSave();
            }
          }
        });

        document.getElementById('newtab-image-url').addEventListener('input', function() {
          newtabImageUrl = this.value;
          updateNewtabBackgroundPreview();
          saveNewtabBackgroundSettings();
          applyBackground();
          triggerAutoSave();
        });

        document.getElementById('test-newtab-image').addEventListener('click', function() {
          const url = document.getElementById('newtab-image-url').value;
          if (url) {
            const preview = document.getElementById('newtab-bg-preview');
            preview.style.background = `url(${url}) center/cover`;
            setTimeout(() => {
              updateNewtabBackgroundPreview();
            }, 2000);
          }
        });

        document.getElementById('newtab-unsplash-category').addEventListener('change', function() {
          newtabUnsplashCategory = this.value;
          saveNewtabBackgroundSettings();
          applyBackground();
          triggerAutoSave();
        });

        document.getElementById('newtab-unsplash-frequency').addEventListener('change', function() {
          newtabUnsplashFrequency = this.value;
          saveNewtabBackgroundSettings();
          applyBackground();
          triggerAutoSave();
        });

        document.getElementById('newtab-gradient-type').addEventListener('change', function() {
          newtabGradientType = this.value;
          updateNewtabBackgroundPreview();
          saveNewtabBackgroundSettings();
          applyBackground();
          triggerAutoSave();
        });

        document.getElementById('newtab-gradient-direction').addEventListener('change', function() {
          newtabGradientDirection = this.value;
          updateNewtabBackgroundPreview();
          saveNewtabBackgroundSettings();
          applyBackground();
          triggerAutoSave();
        });

        document.getElementById('newtab-gradient-color1').addEventListener('input', function() {
          newtabGradientColors[0] = this.value;
          updateNewtabBackgroundPreview();
          saveNewtabBackgroundSettings();
          applyBackground();
          triggerAutoSave();
        });

        document.getElementById('newtab-gradient-color2').addEventListener('input', function() {
          newtabGradientColors[1] = this.value;
          updateNewtabBackgroundPreview();
          saveNewtabBackgroundSettings();
          applyBackground();
          triggerAutoSave();
        });

        document.getElementById('newtab-gradient-color3').addEventListener('input', function() {
          newtabGradientColors[2] = this.value;
          updateNewtabBackgroundPreview();
          saveNewtabBackgroundSettings();
          applyBackground();
          triggerAutoSave();
        });

        document.getElementById('random-gradient').addEventListener('click', function() {
          const randomHues = [];
          const baseHue = Math.random() * 360;
          
          for (let i = 0; i < 3; i++) {
            randomHues.push((baseHue + (i * 120)) % 360);
          }

          newtabGradientColors = [
            hslToHex(randomHues[0], 70, 60),
            hslToHex(randomHues[1], 70, 60),
            hslToHex(randomHues[2], 70, 60)
          ];

          document.getElementById('newtab-gradient-color1').value = newtabGradientColors[0];
          document.getElementById('newtab-gradient-color2').value = newtabGradientColors[1];
          document.getElementById('newtab-gradient-color3').value = newtabGradientColors[2];

          updateNewtabBackgroundPreview();
          saveNewtabBackgroundSettings();
          applyBackground();
          triggerAutoSave();
        });
      });

      let autoSaveTimeout;
      let isAutoSaving = false;

      function triggerAutoSave() {
        if (isAutoSaving) return;
        if (autoSaveTimeout) clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(async () => {
          try {
            isAutoSaving = true;
            await autoSaveSettings();
            showAutoSaveStatus('✓ Saved', 'success');
          } catch (error) {
            console.error('Auto save failed:', error);
            showAutoSaveStatus('⚠ Failed', 'error');
          } finally {
            isAutoSaving = false;
          }
        }, 1000);
        showAutoSaveStatus('💾 Saving...', 'saving');
      }

      async function autoSaveSettings() {
        localStorage.setItem('carbon-panic-key', panicKey || '');
        localStorage.setItem('carbon-panic-url', document.getElementById('panic-url').value);
        localStorage.setItem('carbon-theme-global', currentTheme);
        saveNewtabBackgroundSettings();
        
        if (currentUser) {
          await saveSettingsToFirebase();
        }
        applySettings();
      }

      function showAutoSaveStatus(message, type) {
        const btn = document.getElementById('save-settings');
        const originalText = btn.innerHTML;
        btn.innerHTML = message;
        btn.classList.remove('bg-[var(--theme-foam)]', 'bg-[var(--theme-pine)]', 'bg-[var(--theme-love)]');
        if (type === 'success') {
          btn.classList.add('bg-[var(--theme-pine)]');
        } else if (type === 'error') {
          btn.classList.add('bg-[var(--theme-love)]');
        } else if (type === 'saving') {
          btn.classList.add('bg-[var(--theme-gold)]');
        }
        if (type !== 'saving') {
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('bg-[var(--theme-pine)]', 'bg-[var(--theme-love)]', 'bg-[var(--theme-gold)]');
            btn.classList.add('bg-[var(--theme-foam)]');
          }, 1500);
        }
      }

      document.getElementById('save-settings').addEventListener('click', async () => {
        await autoSaveSettings();
      });
    </script>
  </body>
</html>
