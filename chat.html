<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CARBON - Chat Rooms</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.0/dist/purify.min.js"></script>
  
  <!-- Emoji Support Package - Use working CDN -->
  <script src="https://cdn.jsdelivr.net/npm/emoji-js@6.0.1/lib/emoji.min.js"></script>
  
  <!-- Firebase SDKs (same version as profile.html) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <script>
    // Immediate global function definitions for onclick handlers
    // These are available immediately when HTML loads
    
    window.googleSignIn = function() {
      console.log('GoogleSignIn called - Firebase status:', {
        firebaseLoaded: typeof firebase !== 'undefined',
        firebaseInitialized: window.firebaseInitialized,
        mainFunctionReady: typeof window.mainGoogleSignIn === 'function'
      });
      
      if (typeof firebase === 'undefined' || !window.firebaseInitialized) {
        if (window.showNotification) {
          window.showNotification('Please Wait', 'Chat system is still loading. Please try again in a moment.', 'warning');
        } else {
          alert('Chat system is still loading. Please try again in a moment.');
        }
        
        // Auto-retry after a few seconds if Firebase is taking too long
        setTimeout(() => {
          if (window.firebaseInitialized && window.mainGoogleSignIn) {
            console.log('Firebase ready now, auto-retrying sign in...');
            window.mainGoogleSignIn();
          }
        }, 2000);
        return;
      }
      
      // Call the main googleSignIn function once Firebase is ready
      if (window.mainGoogleSignIn) {
        window.mainGoogleSignIn();
      } else {
        console.error('Main googleSignIn function not loaded yet');
        if (window.showNotification) {
          window.showNotification('Error', 'Authentication system not ready. Please refresh the page.', 'error');
        }
      }
    };

    // Other critical functions that need immediate availability
    window.showCreateRoomModal = function() {
      if (window.mainShowCreateRoomModal) {
        window.mainShowCreateRoomModal();
      } else {
        console.log('Create room function not yet loaded');
      }
    };

    window.hideCreateRoomModal = function() {
      if (window.mainHideCreateRoomModal) {
        window.mainHideCreateRoomModal();
      }
    };

    // Debugging function to check if functions are loaded
    window.debugFunctions = function() {
      console.log('Available functions:', {
        googleSignIn: typeof window.googleSignIn,
        mainGoogleSignIn: typeof window.mainGoogleSignIn,
        firebase: typeof firebase,
        firebaseInitialized: window.firebaseInitialized
      });
    };
  </script>

  <style>
    /* Modern Design System */
    :root {
      /* Brand Colors */
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --secondary: #06b6d4;
      --accent: #f59e0b;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      
      /* Neutral Palette */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      /* Theme Variables */
      --background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      --surface: rgba(255, 255, 255, 0.08);
      --surface-hover: rgba(255, 255, 255, 0.12);
      --surface-active: rgba(255, 255, 255, 0.16);
      --border: rgba(255, 255, 255, 0.1);
      --border-hover: rgba(255, 255, 255, 0.2);
      --text-primary: #f9fafb;
      --text-secondary: #d1d5db;
      --text-muted: #9ca3af;
      
      /* Legacy theme variables for compatibility */
      --theme-base: #0f0f23;
      --theme-surface: rgba(255, 255, 255, 0.08);
      --theme-overlay: rgba(255, 255, 255, 0.1);
      --theme-muted: #737373;
      --theme-text: #ffffff;
      --theme-foam: var(--primary);
      --theme-iris: var(--secondary);
      --theme-highlight-med: var(--border);
      
      /* Glass Effect */
      --glass: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --backdrop-blur: 20px;
      
      /* Spacing */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;
      
      /* Border Radius */
      --radius-sm: 4px;
      --radius: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-2xl: 20px;
      
      /* Transitions */
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Reset & Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--background);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 400;
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Utility Classes */
    .glass {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
    }

    .glass-strong {
      background: var(--surface);
      border: 1px solid var(--border);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
    }

    .hidden { display: none !important; }

    /* Layout System */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space-4);
      min-height: 100vh;
    }

    .chat-container {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: var(--space-6);
      height: calc(100vh - var(--space-8));
      max-height: 900px;
    }

    /* Sidebar Components */
    .rooms-sidebar {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
      overflow: hidden;
      display: flex;
      flex-direction: column;
      color: var(--text-primary);
    }

    .sidebar-tabs {
      display: flex;
      background: var(--glass);
      border-radius: var(--radius-lg);
      padding: var(--space-1);
      margin-bottom: var(--space-6);
      border: 1px solid var(--border);
    }

    .sidebar-tab {
      flex: 1;
      padding: var(--space-2) var(--space-2);
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-1);
      font-size: 0.75rem;
      font-weight: 500;
      position: relative;
      min-width: 0;
      white-space: nowrap;
    }

    .sidebar-tab:hover {
      background: var(--surface-hover);
      color: var(--text-primary);
    }

    .sidebar-tab.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .sidebar-content::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: var(--radius-full);
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: var(--border-hover);
    }

    /* Art Gallery Components */
    .art-gallery-container {
      padding: var(--space-2) 0;
    }

    .art-piece-small {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-3);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .art-piece-small::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(99, 102, 241, 0.05) 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .art-piece-small:hover {
      background: var(--surface-hover);
      border-color: var(--border-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .art-piece-small:hover::before {
      opacity: 1;
    }

    .art-piece-thumbnail {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      object-fit: cover;
      border: 1px solid var(--border);
      flex-shrink: 0;
    }

    .art-piece-details {
      flex: 1;
      min-width: 0;
      z-index: 1;
    }

    .art-piece-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.8rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: var(--space-1);
    }

    .art-piece-author {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .art-piece-meta {
      font-size: 0.65rem;
      color: var(--primary);
      margin-top: var(--space-1);
    }

    /* Art Deletion UI */
    .art-piece-actions {
      position: absolute;
      top: var(--space-2);
      right: var(--space-2);
      display: flex;
      gap: var(--space-1);
      opacity: 0;
      transition: var(--transition);
      z-index: 2;
    }

    .art-piece:hover .art-piece-actions,
    .art-piece-small:hover .art-piece-actions {
      opacity: 1;
    }

    .art-action-btn {
      width: 24px;
      height: 24px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      transition: var(--transition);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
    }

    .art-delete-btn {
      background: rgba(239, 68, 68, 0.9);
      color: white;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .art-delete-btn:hover {
      background: var(--error);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
    }

    /* Confirmation Dialog */
    .delete-confirmation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 4000;
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
    }

    .delete-confirmation.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .delete-dialog {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-8);
      max-width: 400px;
      width: 90%;
      text-align: center;
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
      animation: slideIn 0.3s ease;
    }

    .delete-dialog h3 {
      color: var(--text-primary);
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: var(--space-4);
    }

    .delete-dialog p {
      color: var(--text-secondary);
      margin-bottom: var(--space-6);
      line-height: 1.6;
    }

    .delete-dialog-actions {
      display: flex;
      gap: var(--space-3);
      justify-content: center;
    }

    .delete-preview {
      width: 120px;
      height: 120px;
      border-radius: var(--radius-lg);
      object-fit: cover;
      margin: 0 auto var(--space-4);
      border: 2px solid var(--border);
    }

    /* Art Gallery Improvements */
    .art-piece {
      position: relative;
    }

    .art-piece-small {
      position: relative;
    }

    .art-piece-ownership {
      position: absolute;
      top: var(--space-2);
      left: var(--space-2);
      background: rgba(99, 102, 241, 0.9);
      color: white;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius);
      font-size: 0.65rem;
      font-weight: 600;
      opacity: 0;
      transition: var(--transition);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
    }

    .art-piece:hover .art-piece-ownership,
    .art-piece-small:hover .art-piece-ownership {
      opacity: 1;
    }

    /* Leaderboard System */
    .leaderboard-container {
      padding: var(--space-2) 0;
      overflow: hidden;
      width: 100%;
    }

    .leaderboard-search {
      margin-bottom: var(--space-6);
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      padding-left: var(--space-10);
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: var(--transition);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
    }

    .search-input:focus {
      outline: none;
      border-color: var(--room-color, #6366f1);
      box-shadow: 0 0 0 3px rgba(var(--room-color-rgb, 99, 102, 241), 0.1);
      background: var(--surface);
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-icon {
      position: absolute;
      left: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 1.1rem;
      pointer-events: none;
    }

    .leaderboard-tabs {
      display: flex;
      background: var(--glass);
      border-radius: var(--radius-lg);
      padding: var(--space-1);
      margin-bottom: var(--space-6);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .leaderboard-tab {
      flex: 1;
      padding: var(--space-2);
      border: none;
      background: transparent;
      color: var(--text-secondary);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-1);
      font-size: 0.75rem;
      font-weight: 500;
      min-width: 0;
      overflow: hidden;
      white-space: nowrap;
      max-width: 100%;
    }

    .leaderboard-tab:hover {
      background: var(--surface-hover);
      color: var(--text-primary);
      transform: none; /* Prevent any transform that could cause overflow */
    }

    .leaderboard-tab.active {
      background: var(--room-color, #6366f1);
      color: white;
      box-shadow: 0 2px 8px rgba(var(--room-color-rgb, 99, 102, 241), 0.3);
    }

    .leaderboard-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }

    .leaderboard-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(99, 102, 241, 0.05) 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .leaderboard-item:hover {
      background: var(--surface-hover);
      border-color: var(--border-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1;
    }

    .leaderboard-item:hover::before {
      opacity: 1;
    }

    .leaderboard-rank {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      font-weight: 700;
      font-size: 0.875rem;
      flex-shrink: 0;
      z-index: 1;
    }

    .leaderboard-rank.top-1 {
      background: linear-gradient(135deg, #ffd700, #ffed4a);
      color: #92400e;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    }

    .leaderboard-rank.top-2 {
      background: linear-gradient(135deg, #c0c0c0, #e5e5e5);
      color: #374151;
      box-shadow: 0 4px 12px rgba(192, 192, 192, 0.4);
    }

    .leaderboard-rank.top-3 {
      background: linear-gradient(135deg, #cd7f32, #d4a574);
      color: #92400e;
      box-shadow: 0 4px 12px rgba(205, 127, 50, 0.4);
    }

    .leaderboard-rank.regular {
      background: var(--surface);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .leaderboard-avatar {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      object-fit: cover;
      border: 2px solid var(--border);
      flex-shrink: 0;
      z-index: 1;
    }

    .leaderboard-avatar.placeholder {
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .leaderboard-info {
      flex: 1;
      min-width: 0;
      z-index: 1;
    }

    .leaderboard-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
      margin-bottom: var(--space-1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .leaderboard-stats {
      display: flex;
      gap: var(--space-4);
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .leaderboard-stat {
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .leaderboard-xp {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      z-index: 1;
    }

    .leaderboard-xp-amount {
      font-weight: 700;
      color: var(--room-color, #6366f1);
      font-size: 1rem;
      margin-bottom: var(--space-1);
    }

    .leaderboard-level {
      font-size: 0.7rem;
      color: var(--text-muted);
      padding: var(--space-1) var(--space-2);
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .leaderboard-crown {
      position: absolute;
      top: -8px;
      right: var(--space-3);
      color: #ffd700;
      font-size: 1.2rem;
      z-index: 2;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .leaderboard-item.current-user {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }

    .leaderboard-item.current-user::before {
      opacity: 1;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
    }

    .leaderboard-follow-btn {
      background: var(--room-color, #6366f1);
      color: white;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      margin-top: var(--space-2);
      opacity: 0;
      z-index: 1;
    }

    .leaderboard-item:hover .leaderboard-follow-btn {
      opacity: 1;
    }

    .leaderboard-follow-btn:hover {
      background: rgba(var(--room-color-rgb, 99, 102, 241), 0.8);
      transform: scale(1.1);
    }

    .leaderboard-follow-btn.following {
      background: #10b981;
    }

    .leaderboard-follow-btn.following:hover {
      background: #ef4444;
    }

    .search-results {
      margin-top: var(--space-4);
    }

    .search-no-results {
      text-align: center;
      padding: var(--space-8);
      color: var(--text-muted);
      font-style: italic;
    }

    .leaderboard-loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: var(--space-8);
      color: var(--text-muted);
    }

    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top: 2px solid var(--primary);
      border-radius: var(--radius-full);
      animation: spin 1s linear infinite;
      margin-right: var(--space-3);
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Chat Main Area */
    .chat-main {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
    }

    .chat-header {
      padding: var(--space-5) var(--space-6);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      background: var(--glass);
      position: relative;
      overflow: hidden;
      gap: var(--space-4);
    }

    .chat-title-section {
      flex: 1;
      min-width: 0;
    }

    .chat-title-main {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-2);
      flex-wrap: wrap;
    }

    .chat-title-text {
      font-size: 1.375rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
      line-height: 1.2;
    }

    .room-type-badge {
      background: var(--glass);
      color: var(--text-secondary);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-lg);
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid var(--border);
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .room-type-badge.default {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border-color: rgba(34, 197, 94, 0.3);
    }

    .room-type-badge.temporary {
      background: rgba(249, 115, 22, 0.1);
      color: #f97316;
      border-color: rgba(249, 115, 22, 0.3);
    }

    .chat-stats-row {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      flex-wrap: wrap;
    }

    .user-count-display {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      background: var(--glass);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .user-count-display i {
      color: var(--room-color, #6366f1);
    }

    .chat-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);
      pointer-events: none;
    }

    .chat-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      z-index: 1;
    }

    .chat-header .header-actions {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      z-index: 1;
      align-items: flex-end;
    }

    .header-actions-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      flex-wrap: wrap;
    }

    .chat-messages {
      flex: 1;
      padding: var(--space-4);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: var(--radius-full);
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: var(--border-hover);
    }

    .chat-input-area {
      padding: var(--space-6);
      border-top: 1px solid var(--border);
      background: var(--glass);
      color: var(--text-primary);
    }

    /* Room Item Styles */
    .room-item {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-3);
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border);
      background: var(--glass);
      position: relative;
      overflow: hidden;
      color: var(--text-primary);
    }

    .room-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(99, 102, 241, 0.05) 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .room-item:hover {
      background: var(--surface-hover);
      border-color: var(--border-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .room-item:hover::before {
      opacity: 1;
    }

    .room-item.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .room-item.active::before {
      opacity: 0;
    }

    /* Button System */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
    }

    .btn-secondary {
      background: var(--glass);
      color: var(--text-primary);
      border-color: var(--border);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--surface-hover);
      border-color: var(--border-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn-success {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    .btn-success:hover:not(:disabled) {
      background: #059669;
      border-color: #059669;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: var(--error);
      color: white;
      border-color: var(--error);
    }

    .btn-danger:hover:not(:disabled) {
      background: #dc2626;
      border-color: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .btn-sm {
      padding: var(--space-2) var(--space-3);
      font-size: 0.75rem;
      border-radius: var(--radius);
    }

    .btn-lg {
      padding: var(--space-4) var(--space-6);
      font-size: 1rem;
      border-radius: var(--radius-lg);
    }

    /* Form Controls */
    .form-input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: var(--transition);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes messageSlideIn {
      from { 
        opacity: 0; 
        transform: translateY(20px) scale(0.95); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-10px); }
    }

    /* Notification System */
    .notification-container {
      position: fixed;
      top: var(--space-4);
      right: var(--space-4);
      z-index: 5000;
      pointer-events: none;
    }

    .notification {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-2);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
      pointer-events: auto;
      cursor: pointer;
      transition: var(--transition);
      animation: slideInRight 0.3s ease;
      max-width: 300px;
      border-left: 4px solid var(--room-color, #6366f1);
    }

    .notification:hover {
      transform: translateX(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .notification.success {
      border-left-color: var(--success);
    }

    .notification.error {
      border-left-color: var(--error);
    }

    .notification.warning {
      border-left-color: var(--warning);
    }

    .notification-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }

    .notification-icon {
      width: 20px;
      height: 20px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: white;
      background: var(--room-color, #6366f1);
    }

    .notification-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .notification-close {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: var(--space-1);
      border-radius: var(--radius);
      transition: var(--transition);
    }

    .notification-close:hover {
      background: var(--surface-hover);
      color: var(--text-primary);
    }

    .notification-body {
      color: var(--text-secondary);
      font-size: 0.875rem;
      line-height: 1.4;
    }

    .notification-avatar {
      width: 24px;
      height: 24px;
      border-radius: var(--radius-full);
      margin-right: var(--space-2);
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      background: var(--glass);
      border-radius: var(--radius-lg);
      margin: var(--space-2) 0;
      font-size: 0.875rem;
      color: var(--text-secondary);
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }

    .typing-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }

    .typing-indicator.ai-typing {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      border-left: 3px solid #10b981;
    }

    .typing-indicator.ai-typing .typing-dot {
      background: #10b981;
    }

    .typing-dots {
      display: flex;
      gap: var(--space-1);
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: var(--radius-full);
      background: var(--room-color, #6366f1);
      animation: typingBounce 1.4s ease-in-out infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typingBounce {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      30% {
        transform: translateY(-8px);
        opacity: 1;
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    .animate-slide-in {
      animation: slideIn 0.3s ease-out;
    }

    .animate-pulse {
      animation: pulse 2s infinite;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: var(--space-2);
      }

      .chat-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        gap: var(--space-4);
        height: calc(100vh - var(--space-4));
      }
      
      .chat-header {
        padding: var(--space-4);
        flex-direction: column;
        gap: var(--space-3);
        align-items: flex-start;
      }

      .chat-header .header-actions {
        align-items: flex-start;
        width: 100%;
      }

      .header-actions-row {
        flex-wrap: wrap;
        gap: var(--space-2);
        width: 100%;
      }

      .btn span {
        display: none;
      }
      
      .btn i {
        margin: 0;
      }
      
      .xp-widget {
        min-width: 180px;
        width: 100%;
      }

      .rooms-sidebar {
        padding: var(--space-4);
      }

      .chat-header {
        padding: var(--space-4);
        flex-direction: column;
        gap: var(--space-3);
        align-items: flex-start;
      }

      .header-actions {
        flex-wrap: wrap;
        gap: var(--space-2);
      }

      .btn {
        padding: var(--space-2) var(--space-3);
        font-size: 0.75rem;
      }

      .art-container {
        padding: var(--space-4);
        max-width: 95vw;
      }
    }

    @media (max-width: 480px) {
      .sidebar-tab {
        padding: var(--space-2) var(--space-1);
        font-size: 0.7rem;
        gap: 0;
      }
      
      .sidebar-tab span:not(.sr-only) {
        display: none;
      }
      
      .sidebar-tab i {
        font-size: 1rem;
      }
    }

      .chat-header h2 {
        font-size: 1.125rem;
      }

      .message {
        padding: var(--space-3);
      }

      .room-item {
        padding: var(--space-3);
      }
    }

    /* Dark mode enhancements */
    @media (prefers-color-scheme: dark) {
      :root {
        --background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
      }
    }

    /* High contrast mode */
    @media (prefers-contrast: high) {
      :root {
        --border: rgba(255, 255, 255, 0.3);
        --border-hover: rgba(255, 255, 255, 0.5);
        --surface: rgba(255, 255, 255, 0.15);
      }
    }

    .room-item.default {
      border-color: var(--theme-gold);
      background: rgba(246, 193, 119, 0.1);
    }

    .room-item.temporary {
      border-color: var(--theme-iris);
      background: rgba(99, 102, 241, 0.1);
    }

    .room-item.ai-room {
      border-color: #10b981;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      position: relative;
    }

    .room-item.ai-room::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 0%, rgba(16, 185, 129, 0.03) 100%);
      border-radius: inherit;
    }

    .ai-room-icon {
      color: #10b981 !important;
      font-size: 1.1rem;
      animation: pulse 2s infinite;
    }

    .ai-room-name {
      color: #10b981;
      font-weight: 600;
    }

    .ai-room-badge {
      display: inline-block;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Message Styles */
    .message {
      margin-bottom: var(--space-4);
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      background: var(--glass);
      border: 1px solid var(--border);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
      animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      color: var(--text-primary);
    }
    
    /* Message Actions */
    .message-actions {
      position: absolute;
      top: var(--space-2);
      right: 85px;
      display: flex;
      gap: var(--space-1);
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 15;
    }
    
    .message:hover .message-actions {
      opacity: 1;
    }
    
    .message-delete-btn {
      background: rgba(239, 68, 68, 0.95);
      color: white;
      border: 1px solid rgba(239, 68, 68, 0.8);
      border-radius: var(--radius-md);
      padding: var(--space-1) var(--space-2);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 6px rgba(239, 68, 68, 0.4);
      backdrop-filter: blur(4px);
    }
    
    .message-delete-btn:hover {
      background: rgba(239, 68, 68, 1);
      border-color: rgba(239, 68, 68, 1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
    }
    
    .message-delete-btn:active {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(239, 68, 68, 0.4);
    }
    
    /* Notification Bell System */
    .notification-bell {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.15s ease;
      color: var(--text-secondary);
      z-index: 100000;
    }
    
    .notification-bell:hover {
      background: var(--surface-hover);
      color: var(--text-primary);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .notification-bell:active {
      transform: translateY(0) scale(1);
      transition: all 0.1s ease;
    }
    
    .notification-bell.has-notifications {
      color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
      animation: bellShake 0.5s ease-in-out;
    }

    @keyframes bellShake {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-5deg); }
      75% { transform: rotate(5deg); }
    }
    
    .notification-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: var(--error);
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 3px 7px;
      border-radius: 12px;
      min-width: 20px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4), 0 0 0 2px var(--surface);
      animation: pulse 1.5s infinite;
    }
    
    .notification-panel {
      position: fixed;
      top: 70px;
      right: 20px;
      width: 350px;
      max-height: 400px;
      background: var(--surface);
      border: 2px solid var(--primary);
      border-radius: var(--radius-xl);
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(99, 102, 241, 0.2);
      backdrop-filter: blur(20px);
      z-index: 99999;
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
      pointer-events: none;
      transition: all 0.15s cubic-bezier(0.16, 1, 0.3, 1);
      overflow: hidden;
    }
    
    .notification-panel.show {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: all;
    }


    
    .notification-panel-header {
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 48px;
      gap: var(--space-3);
    }
    
    .notification-panel-title {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 1.1rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .clear-all-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-md);
      transition: all 0.15s ease;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 60px;
    }
    
    .clear-all-btn:hover {
      background: var(--error);
      border-color: var(--error);
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .clear-all-btn:active {
      transform: translateY(0);
      transition: all 0.1s ease;
    }

    .notification-header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .notification-close-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: var(--space-1);
      border-radius: var(--radius-md);
      transition: all 0.15s ease;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .notification-close-btn:hover {
      background: var(--surface-hover);
      color: var(--text-primary);
      transform: translateY(-1px);
    }

    .notification-close-btn:active {
      transform: translateY(0);
      background: var(--surface-active);
    }
    
    .notification-list {
      max-height: 320px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }
    
    .notification-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .notification-list::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .notification-list::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    
    .notification-item {
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background-color 0.15s ease, border-left-color 0.15s ease;
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      border-left: 4px solid transparent;
    }
    
    .notification-item:hover {
      background: var(--surface-hover) !important;
      border-left-color: var(--primary) !important;
    }

    .notification-item:active {
      background: rgba(99, 102, 241, 0.15) !important;
      border-left-color: var(--primary) !important;
    }
    
    .notification-item.unread {
      background: rgba(99, 102, 241, 0.15);
      border-left-color: var(--primary);
      box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.2);
    }
    
    .notification-item.unread::before {
      content: '';
      position: absolute;
      right: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      width: 10px;
      height: 10px;
      background: var(--primary);
      border-radius: 50%;
      box-shadow: 0 0 0 2px var(--surface);
      animation: pulse 2s infinite;
    }
    
    .notification-content {
      display: flex;
      gap: var(--space-3);
      align-items: flex-start;
      flex: 1;
      min-width: 0;
    }
    
    .notification-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .notification-text {
      flex: 1;
      min-width: 0;
    }
    
    .notification-title {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 0.95rem;
      line-height: 1.3;
      margin-bottom: var(--space-1);
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
    }
    
    .notification-message {
      color: var(--text-primary);
      font-size: 0.85rem;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      opacity: 0.9;
    }
    
    .notification-time {
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-top: var(--space-1);
      font-weight: 500;
    }
    
    .notification-empty {
      padding: var(--space-8) var(--space-5);
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .notification-empty i {
      font-size: 2rem;
      margin-bottom: var(--space-3);
      opacity: 0.5;
    }

    /* Responsive Notification Panel */
    @media (max-width: 480px) {
      .notification-panel {
        position: fixed;
        top: 70px;
        left: 10px;
        right: 10px;
        width: auto;
        max-width: none;
        z-index: 99999;
      }
    }

    @media (max-width: 768px) {
      .notification-panel {
        width: 320px;
        right: 10px;
        top: 70px;
        z-index: 99999;
      }
    }

    /* Mention Highlights */
    .mention-highlight {
      background: rgba(99, 102, 241, 0.2);
      color: var(--primary) !important;
      padding: 2px 4px;
      border-radius: 4px;
      font-weight: 600;
      border: 1px solid rgba(99, 102, 241, 0.3);
      display: inline;
      position: relative;
      z-index: 1;
    }

    .mention-highlight:hover {
      background: rgba(99, 102, 241, 0.3);
      cursor: pointer;
    }

    /* Mention highlights in AI messages */
    .message.ai .mention-highlight {
      background: rgba(99, 102, 241, 0.4) !important;
      color: #ffffff !important;
      border: 2px solid var(--primary) !important;
      border-radius: 6px !important;
      font-weight: 700 !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
      box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3) !important;
    }

    .message.ai .mention-highlight:hover {
      background: rgba(99, 102, 241, 0.6) !important;
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(99, 102, 241, 0.4) !important;
    }

    /* Mention highlights in themed rooms */
    .custom-theme .mention-highlight {
      background: rgba(var(--room-color-rgb, 99, 102, 241), 0.2) !important;
      color: var(--room-color, var(--primary)) !important;
      border-color: rgba(var(--room-color-rgb, 99, 102, 241), 0.4) !important;
    }

    .custom-theme .message.ai .mention-highlight {
      background: rgba(var(--room-color-rgb, 99, 102, 241), 0.4) !important;
      color: #ffffff !important;
      border: 2px solid var(--room-color, var(--primary)) !important;
    }

    /* Mention Autocomplete Dropdown */
    .mention-dropdown {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(var(--backdrop-blur));
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
      display: none;
      margin-bottom: 8px;
    }

    .mention-dropdown.show {
      display: block;
    }

    .mention-dropdown::-webkit-scrollbar {
      width: 6px;
    }

    .mention-dropdown::-webkit-scrollbar-track {
      background: transparent;
    }

    .mention-dropdown::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .mention-item {
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: var(--space-3);
      border-bottom: 1px solid var(--border);
    }

    .mention-item:last-child {
      border-bottom: none;
    }

    .mention-item:hover,
    .mention-item.selected {
      background: var(--surface-hover);
    }

    .mention-item.selected {
      background: rgba(99, 102, 241, 0.1);
      border-left: 3px solid var(--primary);
    }

    .mention-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .mention-user-info {
      flex: 1;
      min-width: 0;
    }

    .mention-display-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
      line-height: 1.2;
    }

    .mention-username {
      color: var(--text-muted);
      font-size: 0.8rem;
      line-height: 1.2;
    }

    .mention-dropdown-header {
      padding: var(--space-2) var(--space-4);
      background: var(--glass);
      border-bottom: 1px solid var(--border);
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    .mention-no-results {
      padding: var(--space-6) var(--space-4);
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    /* Delete confirmation dialog */
    .delete-message-confirmation {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }
    
    .delete-message-confirmation.show {
      display: flex;
    }
    
    .delete-message-dialog {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      animation: slideIn 0.3s ease;
    }
    
    .delete-message-dialog h3 {
      color: var(--text-primary);
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: var(--space-4);
      text-align: center;
    }
    
    .delete-message-dialog p {
      color: var(--text-secondary);
      margin-bottom: var(--space-6);
      line-height: 1.6;
      text-align: center;
    }
    
    .delete-message-actions {
      display: flex;
      gap: var(--space-3);
      justify-content: center;
    }
    
    .delete-message-preview {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      margin: var(--space-4) 0;
      font-size: 0.875rem;
      color: var(--text-secondary);
      max-height: 100px;
      overflow: hidden;
      position: relative;
    }
    
    .delete-message-preview::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(transparent, var(--glass));
    }

    .message::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: var(--primary);
      opacity: 0.6;
    }

    .message.own {
      background: var(--theme-foam);
      color: var(--theme-base);
      margin-left: 20%;
    }

    .message.system {
      background: var(--theme-gold);
      color: var(--theme-base);
      text-align: center;
      font-style: italic;
    }

    .message.ai {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      border-left: 4px solid #10b981;
      position: relative;
      border-radius: var(--radius-lg);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
    }

    .message.ai::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      background: #10b981;
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      z-index: 1;
    }

    .message.ai .message-author {
      color: #10b981;
      font-weight: 600;
    }

    .message.ai .message-content {
      background: rgba(16, 185, 129, 0.03);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      margin-top: var(--space-2);
      border: 1px solid rgba(16, 185, 129, 0.1);
      color: var(--text-primary);
      line-height: 1.5;
    }

    .message.ai::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid var(--theme-iris);
      border-top: 8px solid var(--theme-iris);
      border-bottom: 8px solid transparent;
    }

    /* Reply functionality styles */
    .message {
      position: relative;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .message:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .message:hover .reply-button {
      opacity: 1;
    }

    .reply-button {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      opacity: 0;
      background: var(--room-color, var(--theme-foam));
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-md);
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 12;
      backdrop-filter: blur(4px);
    }

    .reply-button:hover {
      background: var(--room-color, var(--theme-iris));
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(var(--room-color-rgb, 99, 102, 241), 0.3);
    }

    .reply-preview {
      background: var(--theme-highlight-med);
      border-left: 3px solid var(--theme-foam);
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .reply-original {
      background: rgba(99, 102, 241, 0.1);
      border-left: 3px solid var(--theme-foam);
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .reply-chain {
      border-left: 2px solid var(--theme-muted);
      margin-left: 1rem;
      padding-left: 0.5rem;
    }

    .reply-input-container {
      background: var(--theme-highlight-med);
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-left: 3px solid var(--theme-foam);
    }

    .reply-cancel {
      background: var(--theme-love);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
      cursor: pointer;
      margin-left: 0.5rem;
    }

    /* Reaction styles */
    .message-reactions {
      margin-top: 0.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .reaction {
      background: var(--theme-highlight-med);
      border: 1px solid var(--theme-overlay);
      border-radius: 12px;
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .reaction:hover {
      background: var(--theme-highlight-high);
      transform: scale(1.05);
    }

    .reaction.reacted {
      background: var(--theme-foam);
      color: var(--theme-base);
      border-color: var(--theme-foam);
    }

    .reaction-count {
      font-size: 0.7rem;
      font-weight: 600;
    }

    .add-reaction {
      background: var(--theme-highlight-med);
      border: 1px dashed var(--theme-overlay);
      border-radius: 12px;
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0;
    }

    .message:hover .add-reaction {
      opacity: 1;
    }

    .add-reaction:hover {
      background: var(--theme-highlight-high);
      border-color: var(--theme-foam);
    }

    .reaction-picker {
      position: absolute;
      bottom: 100%;
      left: 0;
      background: var(--theme-surface);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 12px;
      padding: 1rem;
      width: 350px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .reaction-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--theme-highlight-med);
    }

    .reaction-picker-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--theme-text);
    }

    .reaction-search {
      background: var(--theme-overlay);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 6px;
      padding: 0.5rem;
      color: var(--theme-text);
      font-size: 0.8rem;
      width: 100%;
      margin-bottom: 0.75rem;
    }

    .reaction-search:focus {
      outline: none;
      border-color: var(--theme-foam);
    }

    .reaction-tabs {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 0.75rem;
      overflow-x: auto;
    }

    .reaction-tab {
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s ease;
      background: var(--theme-overlay);
      border: 1px solid transparent;
      min-width: 40px;
      text-align: center;
    }

    .reaction-tab:hover {
      background: var(--theme-highlight-med);
    }

    .reaction-tab.active {
      background: var(--theme-foam);
      color: var(--theme-base);
      border-color: var(--theme-foam);
    }

    .reaction-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 0.25rem;
      max-height: 200px;
      overflow-y: auto;
    }

    .reaction-emoji {
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.2s ease;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .reaction-emoji:hover {
      background: var(--theme-highlight-med);
      transform: scale(1.2);
    }

    .emoji-category-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--theme-muted);
      margin: 0.75rem 0 0.5rem 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* AFK styles */
    .afk-indicator {
      display: inline-block;
      background: var(--theme-gold);
      color: var(--theme-base);
      padding: 0.1rem 0.3rem;
      border-radius: 8px;
      font-size: 0.6rem;
      font-weight: 600;
      margin-left: 0.25rem;
    }

    .user-list {
      background: var(--theme-overlay);
      border-radius: 8px;
      padding: 0.5rem;
      margin-top: 0.5rem;
      max-height: 120px;
      overflow-y: auto;
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    .user-item.afk {
      opacity: 0.6;
    }

    .user-status {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--theme-foam);
    }

    .user-status.afk {
      background: var(--theme-gold);
    }

    /* XP and Leveling System */
    .level-badge {
      background: linear-gradient(135deg, var(--theme-gold), #e6a700);
      color: var(--theme-base);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 8px;
      box-shadow: 0 2px 6px rgba(231, 180, 0, 0.3);
    }

    .level-badge.prestige {
      background: linear-gradient(135deg, var(--theme-iris), var(--theme-love));
      box-shadow: 0 2px 6px rgba(99, 102, 241, 0.4);
    }

    .xp-bar-container {
      background: var(--surface);
      border-radius: var(--radius-lg);
      height: 10px;
      overflow: hidden;
      margin: var(--space-2) 0;
      border: 1px solid var(--border);
      position: relative;
    }

    .xp-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--room-color, #6366f1), rgba(var(--room-color-rgb, 99, 102, 241), 0.8));
      border-radius: var(--radius-lg);
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .xp-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: xpShimmer 2s infinite;
    }

    .xp-bar.leveling-up {
      animation: xpGlow 0.5s ease-in-out;
    }

    @keyframes xpGlow {
      0%, 100% { box-shadow: 0 0 8px var(--room-color, #6366f1); }
      50% { box-shadow: 0 0 20px var(--room-color, #6366f1), 0 0 30px rgba(var(--room-color-rgb, 99, 102, 241), 0.5); }
    }

    @keyframes xpShimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .xp-text {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-align: center;
      margin-top: var(--space-1);
      font-weight: 500;
    }

    .level-up-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, var(--theme-foam), var(--theme-iris));
      color: var(--theme-base);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 2000;
      display: none;
      text-align: center;
      min-width: 300px;
    }

    .level-up-notification.show {
      display: block;
      animation: levelUpPop 1s ease-out;
    }

    @keyframes levelUpPop {
      0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      20% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .level-up-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .level-up-details {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .xp-reward-popup {
      position: absolute;
      background: var(--theme-foam);
      color: var(--theme-base);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      z-index: 1000;
      pointer-events: none;
      animation: xpRewardFloat 1.5s ease-out forwards;
    }

    @keyframes xpRewardFloat {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-30px); }
    }

    /* Level-based styling for usernames */
    .user-link.level-novice { color: #8e8e93; }
    .user-link.level-bronze { color: #cd7f32; }
    .user-link.level-silver { color: #c0c0c0; }
    .user-link.level-gold { color: var(--theme-gold); }
    .user-link.level-platinum { color: #e5e4e2; }
    .user-link.level-diamond { color: #b9f2ff; }
    .user-link.level-master { color: var(--theme-iris); }
    .user-link.level-grandmaster { color: var(--theme-love); }

    .xp-widget {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-4);
      min-width: 240px;
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
      transition: var(--transition);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
    }

    .xp-widget:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(var(--room-color-rgb, 99, 102, 241), 0.15);
      border-color: rgba(var(--room-color-rgb, 99, 102, 241), 0.3);
    }

    .xp-widget-content {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .xp-widget-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-3);
    }

    .xp-widget-level {
      font-weight: 700;
      color: var(--room-color, #6366f1);
      font-size: 1rem;
      background: rgba(var(--room-color-rgb, 99, 102, 241), 0.1);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius);
      border: 1px solid rgba(var(--room-color-rgb, 99, 102, 241), 0.2);
    }

    .xp-widget-title {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 600;
    }

    /* Room Color Customization */
    .color-picker-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .color-picker-modal.show {
      display: flex;
    }

    .color-picker-content {
      background: var(--theme-surface);
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .color-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--theme-highlight-med);
    }

    .color-picker-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--theme-text);
    }

    .color-section {
      margin-bottom: 2rem;
    }

    .color-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--theme-text);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 0.75rem;
    }

    .color-option {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      border: 3px solid transparent;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .color-option:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .color-option.selected {
      border-color: var(--theme-foam);
      box-shadow: 0 0 0 2px var(--theme-foam);
    }

    .color-option.locked {
      opacity: 0.5;
      cursor: not-allowed;
      position: relative;
    }

    .color-option.locked::after {
      content: '';
      position: absolute;
      font-size: 1.2rem;
      color: white;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
    }

    .color-option.locked:hover {
      transform: none;
      box-shadow: none;
    }

    .color-option-label {
      position: absolute;
      bottom: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.7rem;
      color: var(--theme-muted);
      text-align: center;
      white-space: nowrap;
    }

    .custom-color-section {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05));
      border: 1px solid var(--theme-highlight-med);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .custom-color-picker {
      width: 100%;
      height: 60px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin-bottom: 1rem;
    }

    .unlock-requirement {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--theme-muted);
      margin-bottom: 1rem;
    }

    .unlock-requirement.unlocked {
      color: var(--theme-foam);
    }

    .color-preview {
      width: 100%;
      height: 80px;
      border-radius: 12px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .color-picker-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--theme-highlight-med);
    }

    .room-color-btn {
      background: var(--theme-foam);
      color: var(--theme-base);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .room-color-btn:hover {
      background: var(--theme-iris);
      transform: translateY(-1px);
    }

    .room-color-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .room-color-btn:disabled:hover {
      transform: none;
    }

    /* Enhanced Full-page Room Theme Application */
    body.custom-theme {
      background-color: var(--theme-base);
      min-height: 100vh;
      transition: background 0.5s ease;
    }

    body.custom-theme::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, 
        rgba(var(--room-color-rgb, 99, 102, 241), 0.02) 0%, 
        transparent 50%, 
        rgba(var(--room-color-rgb, 99, 102, 241), 0.01) 100%);
      pointer-events: none;
      z-index: -1;
    }

    .container.custom-theme {
      background: rgba(var(--room-color-rgb, 99, 102, 241), 0.03);
      border-radius: 20px;
      backdrop-filter: blur(15px);
      border: 1px solid rgba(var(--room-color-rgb, 99, 102, 241), 0.15);
      box-shadow: 0 8px 32px rgba(var(--room-color-rgb, 99, 102, 241), 0.08);
    }

    .sidebar.custom-theme {
      background: rgba(var(--room-color-rgb, 99, 102, 241), 0.06);
      border-right: 2px solid rgba(var(--room-color-rgb, 99, 102, 241), 0.2);
      backdrop-filter: blur(10px);
    }

    .chat-main.custom-theme {
      background: rgba(var(--room-color-rgb, 99, 102, 241), 0.02);
    }

    .chat-header.custom-theme {
      background: linear-gradient(135deg, 
        rgba(var(--room-color-rgb, 99, 102, 241), 0.15) 0%, 
        rgba(var(--room-color-rgb, 99, 102, 241), 0.08) 100%) !important;
      border-bottom: 2px solid rgba(var(--room-color-rgb, 99, 102, 241), 0.3);
      backdrop-filter: blur(15px);
      box-shadow: 0 4px 20px rgba(var(--room-color-rgb, 99, 102, 241), 0.15);
      color: white !important;
    }

    .chat-header.custom-theme h2,
    .chat-header.custom-theme span,
    .chat-header.custom-theme .btn-secondary {
      color: white !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .message.custom-theme {
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.08);
      border-left: 4px solid var(--room-color);
      backdrop-filter: blur(8px);
      border-radius: 12px;
      margin: 8px 0;
      box-shadow: 0 2px 8px rgba(var(--room-color-rgb, 156, 207, 216), 0.1);
      transition: all 0.3s ease;
    }

    .message.custom-theme:hover {
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.15);
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(var(--room-color-rgb, 156, 207, 216), 0.2);
    }

    .room-item.custom-theme {
      border-left: 5px solid var(--room-color);
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.1);
      margin: 4px 0;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .room-item.custom-theme.active {
      background: linear-gradient(90deg, 
        rgba(var(--room-color-rgb, 156, 207, 216), 0.4), 
        rgba(var(--room-color-rgb, 156, 207, 216), 0.15));
      box-shadow: 0 0 20px rgba(var(--room-color-rgb, 156, 207, 216), 0.4);
      border-left: 5px solid var(--room-color);
      transform: translateX(4px);
    }

    .room-item.custom-theme:hover {
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.2);
      transform: translateX(2px);
    }

    .chat-input-area.custom-theme {
      background: linear-gradient(135deg, 
        rgba(var(--room-color-rgb, 156, 207, 216), 0.12) 0%, 
        rgba(var(--room-color-rgb, 156, 207, 216), 0.06) 100%);
      border-top: 2px solid rgba(var(--room-color-rgb, 156, 207, 216), 0.3);
      backdrop-filter: blur(10px);
    }

    .btn-primary.custom-theme {
      background: var(--room-color, #6366f1) !important;
      border-color: var(--room-color, #6366f1) !important;
      color: white !important;
      box-shadow: 0 4px 12px rgba(var(--room-color-rgb, 99, 102, 241), 0.3);
    }

    .btn-primary.custom-theme:hover {
      background: var(--room-color) !important;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(var(--room-color-rgb, 156, 207, 216), 0.5);
    }

    .btn-secondary.custom-theme {
      border-color: rgba(var(--room-color-rgb, 156, 207, 216), 0.5) !important;
      color: var(--room-color) !important;
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.05);
    }

    .btn-secondary.custom-theme:hover {
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.15) !important;
      border-color: var(--room-color) !important;
      transform: translateY(-1px);
    }

    .xp-widget.custom-theme {
      background: linear-gradient(135deg, 
        rgba(var(--room-color-rgb, 156, 207, 216), 0.15), 
        rgba(var(--room-color-rgb, 156, 207, 216), 0.08)) !important;
      border-color: rgba(var(--room-color-rgb, 156, 207, 216), 0.4);
      box-shadow: 0 4px 16px rgba(var(--room-color-rgb, 156, 207, 216), 0.2);
    }

    .xp-bar.custom-theme {
      background: var(--room-color-gradient, linear-gradient(90deg, var(--room-color), rgba(var(--room-color-rgb, 156, 207, 216), 0.7))) !important;
      box-shadow: 0 0 10px rgba(var(--room-color-rgb, 156, 207, 216), 0.5);
    }

    .user-list.custom-theme {
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.1);
      border: 1px solid rgba(var(--room-color-rgb, 156, 207, 216), 0.3);
      backdrop-filter: blur(10px);
    }

    /* Enhanced scroll bar theming */
    .custom-theme ::-webkit-scrollbar {
      width: 8px;
    }

    .custom-theme ::-webkit-scrollbar-track {
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.1);
      border-radius: 4px;
    }

    .custom-theme ::-webkit-scrollbar-thumb {
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.4);
      border-radius: 4px;
      transition: background 0.3s ease;
    }

    .custom-theme ::-webkit-scrollbar-thumb:hover {
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.7);
    }

    /* Profile Modal Theme Application */
    .profile-modal.custom-theme .profile-modal-content {
      border-color: rgba(var(--room-color-rgb, 156, 207, 216), 0.3);
      box-shadow: 0 25px 50px -12px rgba(var(--room-color-rgb, 156, 207, 216), 0.2);
    }

    .profile-modal.custom-theme .profile-banner {
      background: var(--room-color-gradient, linear-gradient(135deg, var(--room-color, #6366f1), rgba(var(--room-color-rgb, 99, 102, 241), 0.8))) !important;
    }

    .profile-modal.custom-theme .profile-stats {
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.1);
      border-color: rgba(var(--room-color-rgb, 156, 207, 216), 0.2);
    }

    /* Leaderboard Theme Application */
    .leaderboard-container.custom-theme .search-input:focus {
      border-color: var(--room-color) !important;
      box-shadow: 0 0 0 3px rgba(var(--room-color-rgb, 156, 207, 216), 0.15) !important;
    }

    .leaderboard-container.custom-theme .leaderboard-tab.active {
      background: var(--room-color) !important;
      box-shadow: 0 2px 8px rgba(var(--room-color-rgb, 156, 207, 216), 0.4) !important;
    }

    .leaderboard-container.custom-theme .leaderboard-item {
      border-color: rgba(var(--room-color-rgb, 156, 207, 216), 0.2);
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.05);
    }

    .leaderboard-container.custom-theme .leaderboard-item:hover {
      border-color: rgba(var(--room-color-rgb, 156, 207, 216), 0.4);
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.1);
      box-shadow: 0 4px 12px rgba(var(--room-color-rgb, 156, 207, 216), 0.2);
    }

    .leaderboard-container.custom-theme .leaderboard-xp-amount {
      color: var(--room-color) !important;
    }

    .leaderboard-container.custom-theme .leaderboard-follow-btn {
      background: var(--room-color) !important;
    }

    .leaderboard-container.custom-theme .leaderboard-follow-btn:hover {
      background: rgba(var(--room-color-rgb, 156, 207, 216), 0.8) !important;
    }

    /* Carbon Art Drawing System */
    .art-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
    }

    .art-modal.show {
      display: flex;
    }

    .art-container {
      background: var(--surface);
      border-radius: var(--radius-2xl);
      padding: var(--space-8);
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
      border: 1px solid var(--border);
      backdrop-filter: blur(var(--backdrop-blur));
      -webkit-backdrop-filter: blur(var(--backdrop-blur));
    }

    .art-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--theme-highlight-med);
    }

    .art-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--theme-foam);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .canvas-container {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border: 3px solid var(--theme-highlight-med);
    }

    .drawing-canvas {
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: crosshair;
      background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .art-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--theme-overlay);
      border-radius: 12px;
      border: 1px solid var(--theme-highlight-med);
    }

    .tool-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: center;
    }

    .tool-label {
      font-size: 0.8rem;
      color: var(--theme-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .color-palette {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 0.25rem;
    }

    .color-swatch {
      width: 30px;
      height: 30px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
      position: relative;
    }

    .color-swatch:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .color-swatch.active {
      border-color: var(--theme-foam);
      box-shadow: 0 0 0 2px var(--theme-foam);
      transform: scale(1.15);
    }

    .brush-sizes {
      display: flex;
      gap: 0.5rem;
    }

    .brush-size {
      width: 40px;
      height: 40px;
      border: 2px solid var(--theme-highlight-med);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--theme-surface);
      transition: all 0.2s ease;
    }

    .brush-size:hover {
      border-color: var(--theme-foam);
      background: var(--theme-highlight-med);
    }

    .brush-size.active {
      border-color: var(--theme-foam);
      background: var(--theme-foam);
      color: var(--theme-base);
    }

    .brush-size-dot {
      background: currentColor;
      border-radius: 50%;
    }

    .art-actions {
      display: flex;
      gap: 1rem;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .art-button {
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .art-button.primary {
      background: linear-gradient(135deg, var(--theme-foam), var(--theme-iris));
      color: white;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }

    .art-button.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
    }

    .art-button.secondary {
      background: var(--theme-overlay);
      color: var(--theme-text);
      border: 1px solid var(--theme-highlight-med);
    }

    .art-button.secondary:hover {
      background: var(--theme-highlight-med);
      transform: translateY(-1px);
    }

    .art-button.danger {
      background: linear-gradient(135deg, #ff6b6b, #ff5252);
      color: white;
    }

    .art-button.danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }

    .art-info {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05));
      border: 1px solid var(--theme-foam);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      color: var(--theme-text);
    }

    .art-info h3 {
      color: var(--theme-foam);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .art-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .art-piece {
      background: white;
      border-radius: 8px;
      padding: 0.5rem;
      border: 2px solid var(--theme-highlight-med);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .art-piece:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-color: var(--theme-foam);
    }

    .art-piece img {
      width: 100%;
      border-radius: 4px;
      aspect-ratio: 1;
      object-fit: cover;
    }

    .art-piece-info {
      padding: 0.5rem 0;
      font-size: 0.8rem;
      color: var(--theme-muted);
    }

    .art-piece-author {
      font-weight: 600;
      color: var(--theme-text);
    }

    .art-piece-xp {
      color: var(--theme-foam);
      font-weight: 600;
    }

    /* Emoji picker styles */
    .emoji-picker {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: var(--theme-surface);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 12px;
      padding: 1rem;
      width: 300px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 0.5rem;
    }

    .emoji-item {
      padding: 0.5rem;
      text-align: center;
      cursor: pointer;
      border-radius: 6px;
      font-size: 1.2rem;
      transition: all 0.2s ease;
    }

    .emoji-item:hover {
      background: var(--theme-highlight-med);
      transform: scale(1.2);
    }

    .emoji-button {
      background: var(--theme-highlight-med);
      border: none;
      color: var(--theme-text);
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.2s ease;
    }

    .emoji-button:hover {
      background: var(--theme-foam);
      color: var(--theme-base);
    }

    /* Profile modal styles */
    .profile-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(4px);
    }

    .profile-modal-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 0;
      max-width: 480px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
    }

    .profile-banner {
      height: 120px;
      background: var(--room-color-gradient, linear-gradient(135deg, var(--room-color, #6366f1), rgba(var(--room-color-rgb, 99, 102, 241), 0.8)));
      position: relative;
      overflow: hidden;
    }

    .profile-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 25%, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.1) 50%, transparent 50%, transparent 75%, rgba(255,255,255,0.1) 75%);
      background-size: 20px 20px;
      animation: bannerPattern 20s linear infinite;
    }

    @keyframes bannerPattern {
      0% { transform: translateX(-20px); }
      100% { transform: translateX(0); }
    }

    .profile-avatar-container {
      position: relative;
      margin-top: -40px;
      text-align: center;
      margin-bottom: var(--space-4);
    }

    .profile-modal-body {
      padding: var(--space-6);
      padding-top: var(--space-3);
    }

    .profile-modal-header {
      position: absolute;
      top: var(--space-3);
      right: var(--space-3);
      z-index: 10;
    }

    .profile-stats {
      display: flex;
      gap: var(--space-6);
      justify-content: center;
      margin: var(--space-4) 0;
      padding: var(--space-4);
      background: var(--glass);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
    }

    .profile-stat {
      text-align: center;
    }

    .profile-stat-number {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--room-color, #6366f1);
      margin-bottom: var(--space-1);
    }

    .profile-stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .follow-button {
      background: var(--room-color-gradient, linear-gradient(135deg, var(--room-color, #6366f1), rgba(var(--room-color-rgb, 99, 102, 241), 0.8)));
      color: white;
      border: none;
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      width: 100%;
      justify-content: center;
      margin-bottom: var(--space-4);
    }

    .follow-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(var(--room-color-rgb, 99, 102, 241), 0.4);
      background: var(--room-color, #6366f1);
    }

    .follow-button.following {
      background: var(--surface);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .follow-button.following:hover {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }

    .profile-avatar-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid var(--theme-foam);
    }

    .clickable-avatar {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .clickable-avatar:hover {
      transform: scale(1.1);
      border-color: var(--theme-iris);
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .message-content {
      word-wrap: break-word;
      line-height: 1.4;
    }

    /* Button Styles */
    .btn-primary {
      background: linear-gradient(135deg, var(--theme-foam), var(--theme-iris));
      color: var(--theme-base);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .btn-secondary {
      background: var(--theme-overlay);
      color: var(--theme-text);
      border: 1px solid var(--theme-highlight-med);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: var(--theme-highlight-med);
    }

    .btn-danger {
      background: var(--theme-love);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Room Timer */
    .room-timer {
      font-size: 0.7rem;
      color: var(--theme-muted);
      margin-top: 0.25rem;
    }

    .room-timer.expiring {
      color: var(--theme-love);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--theme-surface);
      border: 1px solid var(--theme-highlight-med);
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    /* User Count Badge */
    .user-count {
      background: var(--theme-iris);
      color: var(--theme-base);
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .chat-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      
      .rooms-sidebar {
        max-height: 200px;
      }
      
      .message.own {
        margin-left: 10%;
      }

      /* Leaderboard responsive fixes */
      .leaderboard-tab {
        padding: var(--space-1);
        font-size: 0.7rem;
        gap: 2px;
      }
    }

    @media (max-width: 480px) {
      .leaderboard-tabs {
        padding: 2px;
      }

      .leaderboard-tab {
        padding: var(--space-1);
        min-width: 0;
        flex: 1;
        justify-content: center;
      }

      .leaderboard-tab i {
        font-size: 0.9rem;
      }

      .leaderboard-tab span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }

    @media (max-width: 320px) {
      .leaderboard-tab span {
        display: none;
      }

      .leaderboard-tab {
        padding: var(--space-1) 2px;
      }

      .leaderboard-tab i {
        font-size: 1rem;
      }
    }

    /* Online indicator */
    .online-indicator {
      width: 8px;
      height: 8px;
      background: var(--theme-foam);
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
      animation: pulse 2s infinite;
    }

    /* Input validation */
    .input-error {
      border-color: var(--theme-love) !important;
      box-shadow: 0 0 0 3px rgba(235, 111, 146, 0.1);
    }

    .error-message {
      color: var(--theme-love);
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="flex items-center justify-between px-6 py-4 bg-rp-surface/80 border-b border-rp-overlay backdrop-blur-sm">
    <div class="flex items-center gap-6">
      <a href="index.html" class="text-xl font-bold text-rp-foam tracking-tight">CARBON</a>
      <div class="hidden md:flex items-center gap-4">
        <a href="index.html" class="text-rp-subtle hover:text-rp-text transition-colors">Home</a>
        <a href="profile.html" class="text-rp-subtle hover:text-rp-text transition-colors">Profile</a>
        <a href="forum.html" class="text-rp-subtle hover:text-rp-text transition-colors">Forum</a>
        <a href="chat.html" class="text-rp-foam font-medium">Chat</a>
      </div>
    </div>
    
    <div id="userSection" class="flex items-center gap-3">
      <button id="signInBtn" onclick="googleSignIn()" class="btn-primary">
        <i class='bx bxl-google mr-2'></i>
        Sign In
      </button>
    </div>
  </nav>

  <!-- Main Chat Container -->
  <div class="chat-container">
    <!-- Rooms Sidebar -->
    <div class="rooms-sidebar">
      <!-- Sidebar Tabs -->
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="rooms">
          <i class='bx bx-chat'></i>
          <span>Rooms</span>
        </button>
        <button class="sidebar-tab" data-tab="gallery">
          <i class='bx bx-palette'></i>
          <span>Gallery</span>
        </button>
        <button class="sidebar-tab" data-tab="leaderboard">
          <i class='bx bx-trophy'></i>
          <span>Top</span>
        </button>
      </div>

      <!-- Rooms Tab Content -->
      <div id="roomsTab" class="sidebar-content">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-rp-foam">Chat Rooms</h3>
          <button id="createRoomBtn" onclick="showCreateRoomModal()" class="btn btn-secondary hidden">
            <i class='bx bx-plus'></i>
          </button>
        </div>
        
        <div id="roomsList">
          <!-- Rooms will be loaded dynamically -->
        </div>
      </div>

      <!-- Art Gallery Tab Content -->
      <div id="galleryTab" class="sidebar-content hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-rp-foam">Community Art</h3>
          <button onclick="openCarbonArt()" class="btn btn-secondary">
            <i class='bx bx-brush'></i>
          </button>
        </div>
        
        <div id="communityArtList" class="art-gallery-container">
          <!-- Community artworks will be loaded dynamically -->
        </div>
      </div>

      <!-- Leaderboard Tab Content -->
      <div id="leaderboardTab" class="sidebar-content hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-rp-foam">Leaderboard</h3>
        </div>
        
        <div class="leaderboard-container" id="leaderboardContainer">
          <!-- Search Bar -->
          <div class="leaderboard-search">
            <i class='bx bx-search search-icon'></i>
            <input type="text" id="userSearchInput" class="search-input" placeholder="Search users..." autocomplete="off">
          </div>

          <!-- Leaderboard Tabs -->
          <div class="leaderboard-tabs">
            <button class="leaderboard-tab active" data-board="xp">
              <i class='bx bx-star'></i>
              <span>XP</span>
            </button>
            <button class="leaderboard-tab" data-board="messages">
              <i class='bx bx-message'></i>
              <span>Messages</span>
            </button>
            <button class="leaderboard-tab" data-board="level">
              <i class='bx bx-medal'></i>
              <span>Level</span>
            </button>
          </div>

          <!-- Leaderboard Lists -->
          <div id="xpLeaderboard" class="leaderboard-list">
            <!-- XP leaderboard will be loaded here -->
          </div>

          <div id="messagesLeaderboard" class="leaderboard-list hidden">
            <!-- Messages leaderboard will be loaded here -->
          </div>

          <div id="levelLeaderboard" class="leaderboard-list hidden">
            <!-- Level leaderboard will be loaded here -->
          </div>

          <!-- Search Results -->
          <div id="searchResults" class="search-results hidden">
            <!-- Search results will be displayed here -->
          </div>
        </div>
      </div>
      
      <!-- Room Management -->
      <div id="roomManagement" class="mt-6 pt-4 border-t border-rp-highlight-med hidden">
        <h4 class="text-sm font-semibold text-rp-muted mb-2">Room Management</h4>
        <button onclick="cleanupExpiredRooms()" class="btn-secondary w-full text-sm mb-2">
          <i class='bx bx-trash mr-2'></i>
          Cleanup Expired Rooms
        </button>
        <button onclick="cleanupInactiveRooms()" class="btn-secondary w-full text-sm mb-2">
          <i class='bx bx-clock mr-2'></i>
          Cleanup Inactive Rooms
        </button>
        <button onclick="cleanupOldMessages(currentRoomId)" class="btn-secondary w-full text-sm">
          <i class='bx bx-message-x mr-2'></i>
          Cleanup Old Messages
        </button>
      </div>
    </div>

    <!-- Chat Main Area -->
    <div class="chat-main">
      <!-- Chat Header -->
      <div class="chat-header">
        <div id="loadingIndicator" class="loading-indicator" style="position: absolute; top: 0; left: 0; right: 0; background: rgba(99, 102, 241, 0.95); color: white; padding: 8px; text-align: center; font-size: 0.85rem; z-index: 10; border-radius: 0 0 8px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
          <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
          <span id="loadingText">Initializing chat system...</span>
        </div>
        <div class="chat-title-section">
          <div class="chat-title-main">
            <h2 id="chatTitle" class="chat-title-text">Select a room to start chatting</h2>
            <div id="roomTypeBadge" class="room-type-badge default hidden">
              <span id="roomType">Default Room</span>
            </div>
          </div>
          <div class="chat-stats-row">
            <div id="userCountDisplay" class="user-count-display hidden">
              <i class='bx bx-group'></i>
              <span id="userCount">0 users</span>
            </div>
            <div id="roomTimer" class="room-timer hidden"></div>
          </div>
        </div>
        <div class="header-actions">
          <!-- XP Widget -->
          <div id="xpWidget" class="xp-widget hidden">
            <div class="xp-widget-content">
              <div class="xp-widget-header">
                <div class="xp-widget-level" id="userLevel">Lv.1</div>
                <div class="xp-widget-title" id="userLevelTitle">Novice</div>
              </div>
              <div class="xp-bar-container">
                <div class="xp-bar" id="userXPBar" style="width: 0%"></div>
              </div>
              <div class="xp-text" id="userXPText">0 / 100 XP</div>
            </div>
          </div>
          
                    <div class="header-actions-row">
            <div class="notification-bell" id="notificationBell" onclick="event.stopPropagation(); toggleNotificationPanel(event)">
              <i class='bx bx-bell'></i>
              <span id="notificationBadge" class="notification-badge hidden">0</span>
              <div id="notificationPanel" class="notification-panel">
                <div class="notification-panel-header">
                  <span class="notification-panel-title">Notifications</span>
                  <div class="notification-header-actions">
                    <button class="clear-all-btn" onclick="clearAllNotifications()">Clear All</button>
                    <button class="notification-close-btn" onclick="toggleNotificationPanel(event)">
                      <i class='bx bx-x'></i>
                    </button>
                  </div>
                </div>
                <div id="notificationList" class="notification-list">
                  <div class="notification-empty">
                    <i class='bx bx-bell'></i>
                    <div>No notifications yet</div>
                  </div>
                </div>
              </div>
            </div>
            <button id="toggleUserListBtn" class="btn btn-secondary hidden" onclick="toggleUserList()">
              <i class='bx bx-group'></i>
              <span>Users</span>
            </button>
            <button id="customizeColorBtn" onclick="openColorPicker()" class="btn btn-secondary hidden">
              <i class='bx bx-palette'></i>
              <span>Colors</span>
            </button>
            <button id="carbonArtBtn" onclick="openCarbonArt()" class="btn btn-secondary hidden">
              <i class='bx bx-brush'></i>
              <span>Art</span>
            </button>
            <button id="soundToggle" onclick="toggleSounds()" class="btn btn-secondary" title="Toggle sound effects">
              <i class='bx bx-volume-full'></i>
            </button>
            <button id="leaveRoomBtn" onclick="leaveCurrentRoom()" class="btn btn-danger hidden">
              <i class='bx bx-exit'></i>
              <span>Leave</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- User List -->
      <div id="userListContainer" class="user-list hidden">
        <div class="text-xs font-semibold text-rp-muted mb-2">Active Users:</div>
        <div id="activeUsersList">
          <!-- Users will be populated here -->
        </div>
      </div>

      <!-- Chat Messages -->
      <div id="chatMessages" class="chat-messages">
        <div class="text-center text-rp-muted py-8">
          <i class='bx bx-chat text-4xl mb-4 block'></i>
          <p>Welcome to CARBON Chat!</p>
          <p class="text-sm mt-2">Select a room from the sidebar to start chatting.</p>
        </div>
      </div>
      
      <!-- Typing Indicator -->
      <div id="typingIndicator" class="typing-indicator">
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
        <span id="typingText">Someone is typing...</span>
      </div>

      <!-- Chat Input -->
      <div class="chat-input-area">
        <form id="messageForm" onsubmit="sendMessage(event)" class="hidden">
          <!-- Reply Preview -->
          <div id="replyPreview" class="reply-input-container hidden">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="text-xs text-rp-muted mb-1">Replying to:</div>
                <div id="replyPreviewContent" class="text-sm"></div>
              </div>
              <button type="button" onclick="cancelReply()" class="reply-cancel">
                <i class='bx bx-x'></i>
              </button>
            </div>
          </div>
          
          <div class="flex gap-2 relative">
            <div style="flex: 1; position: relative;">
              <input 
                type="text" 
                id="messageInput" 
                placeholder="Type your message..." 
                class="form-input"
                style="width: 100%; background: var(--glass); border: 1px solid var(--border); color: var(--text-primary); padding: var(--space-3) var(--space-4); border-radius: var(--radius-md);"
                maxlength="500"
                required
                oninput="handleTyping()"
                onkeydown="handleKeyDown(event)"
              >
              <div id="mentionDropdown" class="mention-dropdown">
                <div class="mention-dropdown-header">
                  <i class='bx bx-at'></i> Select user to mention
                </div>
                <div id="mentionList">
                  <!-- Mention suggestions will be populated here -->
                </div>
              </div>
            </div>
            <button type="button" id="emojiButton" class="emoji-button">
              
            </button>
            <button type="submit" class="btn-primary">
              <i class='bx bx-send'></i>
            </button>
            
            <!-- Emoji Picker -->
            <div id="emojiPicker" class="emoji-picker hidden">
              <div class="emoji-grid" id="emojiGrid">
                <!-- Emojis will be populated by JavaScript -->
              </div>
            </div>
          </div>
          <div class="text-xs text-rp-muted mt-2">
            Messages are automatically filtered for appropriate content
          </div>
        </form>
        <div id="guestMessage" class="text-center py-4">
          <p class="text-rp-muted">Please sign in to participate in chat rooms</p>
          <button onclick="googleSignIn()" class="btn-primary mt-2">
            <i class='bx bxl-google mr-2'></i>
            Sign In to Chat
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Room Modal -->
  <div id="createRoomModal" class="modal">
    <div class="modal-content">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-rp-foam">Create Chat Room</h3>
        <button onclick="hideCreateRoomModal()" class="text-rp-muted hover:text-rp-text">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      
      <form id="createRoomForm" onsubmit="createRoom(event)">
        <div class="mb-4">
          <label for="roomName" class="block text-sm font-medium text-rp-text mb-2">Room Name</label>
          <input 
            type="text" 
            id="roomName" 
            placeholder="Enter room name..." 
            class="form-input"
            style="background: var(--glass); border: 1px solid var(--border); color: var(--text-primary);"
            maxlength="50"
            required
            oninput="clearRoomNameError()"
          >
          <div id="roomNameError" class="error-message hidden">Room name contains inappropriate content</div>
        </div>
        
        <div class="mb-4">
          <label for="roomDescription" class="block text-sm font-medium text-rp-text mb-2">Description (Optional)</label>
          <textarea 
            id="roomDescription" 
            placeholder="Describe your room..." 
            class="form-input"
            style="background: var(--glass); border: 1px solid var(--border); color: var(--text-primary); resize: vertical;"
            rows="3"
            maxlength="200"
          ></textarea>
        </div>
        
        <div class="mb-6">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium text-rp-text">Room Duration</span>
            <span class="text-xs text-rp-muted">Temporary rooms auto-delete after expiry</span>
          </div>
          <select 
            id="roomDuration" 
            class="form-input"
            style="background: var(--glass); border: 1px solid var(--border); color: var(--text-primary);"
          >
            <option value="3600000">1 Hour</option>
            <option value="7200000">2 Hours</option>
            <option value="10800000">3 Hours</option>
            <option value="21600000">6 Hours</option>
          </select>
        </div>
        
        <div class="flex gap-2">
          <button type="button" onclick="hideCreateRoomModal()" class="btn-secondary flex-1">Cancel</button>
          <button type="submit" class="btn-primary flex-1">Create Room</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer" class="notification-container"></div>

  <!-- Profile Modal -->
  <div id="profileModal" class="profile-modal hidden">
    <div class="profile-modal-content">
      <!-- Profile Banner -->
      <div class="profile-banner"></div>
      
      <!-- Close Button -->
      <div class="profile-modal-header">
        <button onclick="closeProfileModal()" class="text-white hover:text-gray-200 transition-colors">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      
      <!-- Profile Content -->
      <div class="profile-modal-body">
        <!-- Avatar and Name -->
        <div class="profile-avatar-container">
          <img id="profileModalAvatar" src="" alt="User Avatar" class="profile-avatar-large mx-auto border-4 border-white shadow-xl">
          <h4 id="profileModalName" class="text-xl font-bold mt-3 mb-1" style="color: var(--room-color, #6366f1);"></h4>
          <div id="profileModalStatus" class="text-sm" style="color: var(--text-muted);"></div>
        </div>

        <!-- Stats -->
        <div class="profile-stats">
          <div class="profile-stat">
            <div class="profile-stat-number" id="profileModalXP">0</div>
            <div class="profile-stat-label">XP</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-number" id="profileModalLevel">1</div>
            <div class="profile-stat-label">Level</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-number" id="profileModalMessages">0</div>
            <div class="profile-stat-label">Messages</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-number" id="profileModalFollowers">0</div>
            <div class="profile-stat-label">Followers</div>
          </div>
        </div>

        <!-- Follow Button -->
        <button id="followButton" class="follow-button" style="display: none;">
          <i class='bx bx-user-plus'></i>
          <span id="followButtonText">Follow</span>
        </button>
        
        <!-- Bio Section -->
        <div class="mb-4">
          <div class="text-sm font-semibold mb-2" style="color: var(--room-color, #6366f1);">Bio</div>
          <div id="profileModalBio" class="text-sm bg-glass p-3 rounded-lg border border-border" style="color: var(--text-primary);">No bio available</div>
        </div>
        
        <!-- Joined Date -->
        <div class="mb-6">
          <div class="text-sm font-semibold mb-2" style="color: var(--room-color, #6366f1);">Member Since</div>
          <div id="profileModalJoined" class="text-sm" style="color: var(--text-secondary);"></div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex gap-3">
          <button onclick="closeProfileModal()" class="btn btn-secondary flex-1">Close</button>
          <button id="viewFullProfileBtn" class="btn btn-primary flex-1">View Full Profile</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Level Up Notification -->
  <div id="levelUpNotification" class="level-up-notification">
    <div class="level-up-title"> Level Up! </div>
    <div class="level-up-details">
      <div>You've reached <strong>Level <span id="newLevelNumber">2</span></strong></div>
      <div><span id="levelTitleText">Bronze</span></div>
      <div style="margin-top: 8px;">Bonus: <strong>+<span id="xpRewardAmount">50</span> XP</strong></div>
    </div>
  </div>

  <!-- Color Picker Modal -->
  <div id="colorPickerModal" class="color-picker-modal">
    <div class="color-picker-content">
      <div class="color-picker-header">
        <div class="color-picker-title"> Customize Room Color</div>
        <button onclick="closeColorPicker()" style="background: none; border: none; color: var(--theme-muted); cursor: pointer; font-size: 1.5rem;"></button>
      </div>

      <!-- Default Colors -->
      <div class="color-section">
        <div class="color-section-title">
          <i class='bx bx-palette'></i>
          Default Colors
        </div>
        <div class="color-grid" id="defaultColors">
          <!-- Populated by JavaScript -->
        </div>
      </div>

      <!-- XP Unlocked Colors -->
      <div class="color-section">
        <div class="color-section-title">
          <i class='bx bx-trophy'></i>
          XP Unlocked Colors
        </div>
        <div class="color-grid" id="xpColors">
          <!-- Populated by JavaScript -->
        </div>
      </div>

      <!-- Custom Color Section -->
      <div class="color-section">
        <div class="color-section-title">
          <i class='bx bx-customize'></i>
          Custom Color
        </div>
        <div class="custom-color-section">
          <div class="unlock-requirement" id="customColorRequirement">
            <i class='bx bx-lock'></i>
            <span>Unlock at Level 10 (Platinum)</span>
          </div>
          <input type="color" id="customColorPicker" class="custom-color-picker" value="#9ccfd8" disabled>
          <div class="color-preview" id="colorPreview">
            Custom Color Preview
          </div>
        </div>
      </div>

      <div class="color-picker-actions">
        <button class="room-color-btn" onclick="closeColorPicker()" style="background: var(--theme-muted);">
          <i class='bx bx-x'></i>
          Cancel
        </button>
        <button class="room-color-btn" onclick="applyRoomColor()" id="applyColorBtn">
          <i class='bx bx-check'></i>
          Apply Color
        </button>
      </div>
    </div>
  </div>



  <script>
    // Firebase Configuration (same as profile.html)
    const firebaseConfig = {
      apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
      authDomain: "carbon-services.firebaseapp.com",
      projectId: "carbon-services",
      storageBucket: "carbon-services.firebasestorage.app",
      messagingSenderId: "288385472070",
      appId: "1:288385472070:web:c4be3ff186e248fc645c47",
      measurementId: "G-Y2K1RQYE74"
    };

    // Initialize Firebase
    let app, auth, db;
    let firebaseInitialized = false;
    let isOnline = navigator.onLine;
    
    // Expose firebaseInitialized to global scope immediately
    window.firebaseInitialized = firebaseInitialized;

    async function initializeFirebase() {
      if (firebaseInitialized) return true;
      
      try {
        if (typeof firebase === 'undefined') {
          console.log('Firebase SDK not yet loaded');
          return false;
        }

        try {
          app = firebase.app();
        } catch (error) {
          app = firebase.initializeApp(firebaseConfig);
        }

        auth = app.auth();
        db = app.firestore();
        
        // Enable offline persistence with improved error handling
        try {
          await db.enablePersistence({ synchronizeTabs: true });
          console.log("Firestore persistence enabled successfully");
        } catch (err) {
          if (err.code == 'failed-precondition') {
            console.warn("Multiple tabs open, persistence can only be enabled in one tab at a time.");
          } else if (err.code == 'unimplemented') {
            console.warn("The current browser does not support all of the features required to enable persistence");
          } else {
            console.error("Firestore persistence error:", err);
          }
        }

        // Add connection monitoring
        db.enableNetwork().catch(err => {
          console.error("Failed to enable Firestore network:", err);
        });
        
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        firebaseInitialized = true;
        window.firebaseInitialized = true; // Expose to global scope
        console.log('Firebase initialized for chat');
        return true;
      } catch (error) {
        console.error('Firebase initialization error:', error);
        // Continue with offline mode
        return false;
      }
    }

    // Network status monitoring
    function setupNetworkMonitoring() {
      window.addEventListener('online', () => {
        console.log('Network connection restored');
        isOnline = true;
        updateConnectionStatus();
        retryFirebaseOperations();
      });

      window.addEventListener('offline', () => {
        console.log('Network connection lost');
        isOnline = false;
        updateConnectionStatus();
      });
    }

    function updateConnectionStatus() {
      const statusIndicator = document.getElementById('connectionStatus');
      if (!statusIndicator) {
        // Create connection status indicator
        const indicator = document.createElement('div');
        indicator.id = 'connectionStatus';
        indicator.style.cssText = `
          position: fixed;
          top: 10px;
          right: 10px;
          padding: 8px 12px;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 600;
          z-index: 1001;
          transition: all 0.3s ease;
        `;
        document.body.appendChild(indicator);
      }
      
      const indicator = document.getElementById('connectionStatus');
      if (isOnline) {
        indicator.textContent = ' Online';
        indicator.style.background = 'var(--theme-foam)';
        indicator.style.color = 'var(--theme-base)';
      } else {
        indicator.textContent = ' Offline';
        indicator.style.background = 'var(--theme-love)';
        indicator.style.color = 'white';
      }
    }

    function retryFirebaseOperations() {
      if (firebaseInitialized && isOnline) {
        // Retry loading rooms
        setTimeout(() => {
          loadRooms();
        }, 1000);
      }
    }

    // AI Chat functionality
    class AIChatbot {
      constructor() {
        this.isActive = false;
        this.apiEndpoint = 'https://text.pollinations.ai/';
        this.lastAiMessageTime = 0;
        this.conversationHistory = [];
      }

      async generateResponse(userMessage) {
        try {
          // Add context about the conversation
          const context = this.getConversationContext();
          const prompt = `${context}\n\nUser: ${userMessage}\nAI Assistant:`;
          
          // Try pollinations.ai text endpoint
          const response = await fetch(`${this.apiEndpoint}${encodeURIComponent(prompt)}`, {
            method: 'GET',
            headers: {
              'Accept': 'text/plain',
            }
          });

          if (!response.ok) {
            throw new Error(`AI API error: ${response.status}`);
          }

          const aiResponse = await response.text();
          return this.cleanResponse(aiResponse);
        } catch (error) {
          console.error('AI API error:', error);
          return this.getFallbackResponse(userMessage);
        }
      }

      getConversationContext() {
        return `You are a friendly AI assistant in a chat room. Keep responses concise and engaging. 
Be helpful and conversational. Respond naturally to user messages.`;
      }

      cleanResponse(response) {
        // Clean up the AI response
        let cleaned = response.trim();
        
        // Remove any prompt echoing
        if (cleaned.startsWith('AI Assistant:')) {
          cleaned = cleaned.substring(13).trim();
        }
        
        // Limit length
        if (cleaned.length > 300) {
          cleaned = cleaned.substring(0, 297) + '...';
        }
        
        return cleaned || "I'm here to chat! How can I help you today?";
      }

      getFallbackResponse(userMessage) {
        const fallbacks = [
          "I'm here to chat! How can I help you today?",
          "That's interesting! Tell me more about that.",
          "I'm an AI assistant here to keep you company while the chat room is quiet.",
          "Thanks for sharing! What else would you like to talk about?",
          "I'm still learning, but I'm here to chat with you!",
          "That sounds cool! I'd love to hear more about your thoughts on that.",
        ];
        
        return fallbacks[Math.floor(Math.random() * fallbacks.length)];
      }

      updateConversationHistory(userMessage, aiResponse) {
        this.conversationHistory.push({ user: userMessage, ai: aiResponse });
        // Keep only last 5 exchanges
        if (this.conversationHistory.length > 5) {
          this.conversationHistory.shift();
        }
      }

      shouldActivate(userCount) {
        return userCount <= 1; // Activate when user is alone or room is empty
      }

      activate() {
        this.isActive = true;
        console.log('AI chatbot activated');
      }

      deactivate() {
        this.isActive = false;
        this.conversationHistory = [];
        console.log('AI chatbot deactivated');
      }
    }

    const aiChatbot = new AIChatbot();

    // Initialize emoji converter
    function initializeEmoji() {
      // Check for the emoji library with different possible names
      if (typeof EmojiConvertor !== 'undefined') {
        emojiConverter = new EmojiConvertor();
      } else if (typeof window.EmojiConvertor !== 'undefined') {
        emojiConverter = new window.EmojiConvertor();
      } else if (typeof emoji !== 'undefined') {
        emojiConverter = emoji;
              } else {
          // Add retry limit and fallback
          if (typeof window.emojiInitRetries === 'undefined') {
            window.emojiInitRetries = 0;
          }
          window.emojiInitRetries++;
          
          if (window.emojiInitRetries < 50) { // Max 5 seconds
            console.warn('Emoji library not loaded yet, retrying...', window.emojiInitRetries);
            setTimeout(initializeEmoji, 100);
            return;
          } else {
            console.warn('Emoji library failed to load, using fallback');
            emojiConverter = {
              replace_colons: function(text) { return text; },
              replace_mode: 'unified',
              allow_native: true
            };
            setupEmojiPicker();
            return;
          }
        }
      
      if (emojiConverter) {
        if (typeof emojiConverter.replace_mode !== 'undefined') {
          emojiConverter.replace_mode = 'unified';
        }
        if (typeof emojiConverter.allow_native !== 'undefined') {
          emojiConverter.allow_native = true;
        }
        console.log('Emoji converter initialized successfully');
        setupEmojiPicker();
      }
    }

    function setupEmojiPicker() {
      const emojiButton = document.getElementById('emojiButton');
      const emojiPicker = document.getElementById('emojiPicker');
      const emojiGrid = document.getElementById('emojiGrid');

      // Populate emoji grid
      emojiGrid.innerHTML = '';
      quickEmojis.forEach(emoji => {
        const emojiItem = document.createElement('div');
        emojiItem.className = 'emoji-item';
        emojiItem.textContent = emoji;
        emojiItem.addEventListener('click', () => {
          insertEmoji(emoji);
          emojiPicker.classList.add('hidden');
        });
        emojiGrid.appendChild(emojiItem);
      });

      // Toggle emoji picker
      emojiButton.addEventListener('click', (e) => {
        e.stopPropagation();
        emojiPicker.classList.toggle('hidden');
      });

      // Close picker when clicking outside
      document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && !emojiButton.contains(e.target)) {
          emojiPicker.classList.add('hidden');
        }
      });
    }

    function insertEmoji(emoji) {
      const messageInput = document.getElementById('messageInput');
      const cursorPos = messageInput.selectionStart;
      const textBefore = messageInput.value.substring(0, cursorPos);
      const textAfter = messageInput.value.substring(messageInput.selectionEnd);
      
      messageInput.value = textBefore + emoji + textAfter;
      messageInput.focus();
      messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
    }

    async function waitForFirebaseAndInitialize() {
      if (typeof firebase !== 'undefined') {
        await initializeFirebase();
      } else {
        setTimeout(waitForFirebaseAndInitialize, 100);
      }
    }

    // Firebase initialization will be handled by waitForFirebaseAndStartChat in DOMContentLoaded
    initializeEmoji();

    // Global variables
    let currentUser = null;
    let currentRoomId = null;
    let messagesListener = null;
    let roomsListener = null;
    let userPresenceListener = null;
    let cleanupInterval = null;
    let replyingTo = null; // Store the message being replied to
    let messageCleanupInterval = null; // For message cleanup
    let emojiConverter = null; // Emoji converter instance
    let lastActivity = Date.now(); // Track user activity for AFK detection
    let afkCheckInterval = null; // AFK check interval
    let userActivityMap = new Map(); // Track activity for all users
    let activeUsers = new Map(); // Store active users data

    // XP System
    const XP_REWARDS = {
      MESSAGE: 5,
      REACTION_RECEIVED: 2,
      REACTION_GIVEN: 1,
      LEVEL_UP_BONUS: 50
    };

    const LEVEL_THRESHOLDS = [
      { level: 1, xp: 0, title: 'Novice', tier: 'novice' },
      { level: 2, xp: 100, title: 'Beginner', tier: 'novice' },
      { level: 3, xp: 250, title: 'Learner', tier: 'novice' },
      { level: 4, xp: 500, title: 'Bronze', tier: 'bronze' },
      { level: 5, xp: 850, title: 'Bronze II', tier: 'bronze' },
      { level: 6, xp: 1300, title: 'Silver', tier: 'silver' },
      { level: 7, xp: 1850, title: 'Silver II', tier: 'silver' },
      { level: 8, xp: 2500, title: 'Gold', tier: 'gold' },
      { level: 9, xp: 3250, title: 'Gold II', tier: 'gold' },
      { level: 10, xp: 4100, title: 'Platinum', tier: 'platinum' },
      { level: 11, xp: 5050, title: 'Platinum II', tier: 'platinum' },
      { level: 12, xp: 6100, title: 'Diamond', tier: 'diamond' },
      { level: 13, xp: 7250, title: 'Diamond II', tier: 'diamond' },
      { level: 14, xp: 8500, title: 'Master', tier: 'master' },
      { level: 15, xp: 9850, title: 'Grandmaster', tier: 'grandmaster' },
      { level: 16, xp: 11300, title: 'Legendary', tier: 'grandmaster' },
      { level: 17, xp: 12850, title: 'Mythical', tier: 'grandmaster' },
      { level: 18, xp: 14500, title: 'Ascended', tier: 'grandmaster' },
      { level: 19, xp: 16250, title: 'Divine', tier: 'grandmaster' },
      { level: 20, xp: 18100, title: 'Transcendent', tier: 'grandmaster' }
    ];

    // Extended emoji database for Discord-style suggestions
    window.allEmojis = [
      // Smileys & Emotion
      { emoji: '', name: 'grinning', keywords: ['happy', 'smile', 'grin'], category: 'smileys' },
      { emoji: '', name: 'smiley', keywords: ['happy', 'smile', 'joy'], category: 'smileys' },
      { emoji: '', name: 'smile', keywords: ['happy', 'smile', 'laugh'], category: 'smileys' },
      { emoji: '', name: 'grin', keywords: ['happy', 'smile', 'grin'], category: 'smileys' },
      { emoji: '', name: 'laughing', keywords: ['happy', 'laugh', 'funny'], category: 'smileys' },
      { emoji: '', name: 'sweat_smile', keywords: ['happy', 'laugh', 'nervous'], category: 'smileys' },
      { emoji: '', name: 'rofl', keywords: ['laugh', 'funny', 'hilarious'], category: 'smileys' },
      { emoji: '', name: 'joy', keywords: ['laugh', 'funny', 'tears'], category: 'smileys' },
      { emoji: '', name: 'slightly_smiling', keywords: ['smile', 'happy'], category: 'smileys' },
      { emoji: '', name: 'upside_down', keywords: ['silly', 'playful'], category: 'smileys' },
      { emoji: '', name: 'wink', keywords: ['flirt', 'playful'], category: 'smileys' },
      { emoji: '', name: 'blush', keywords: ['happy', 'shy', 'sweet'], category: 'smileys' },
      { emoji: '', name: 'innocent', keywords: ['angel', 'good', 'halo'], category: 'smileys' },
      { emoji: '', name: 'smiling_face_with_hearts', keywords: ['love', 'happy', 'hearts'], category: 'hearts' },
      { emoji: '', name: 'heart_eyes', keywords: ['love', 'crush', 'heart'], category: 'hearts' },
      { emoji: '', name: 'star_struck', keywords: ['excited', 'wow', 'star'], category: 'smileys' },
      { emoji: '', name: 'kissing_heart', keywords: ['kiss', 'love', 'heart'], category: 'hearts' },
      { emoji: '', name: 'kissing', keywords: ['kiss', 'love'], category: 'hearts' },
      { emoji: '', name: 'kissing_closed_eyes', keywords: ['kiss', 'love'], category: 'hearts' },
      { emoji: '', name: 'kissing_smiling_eyes', keywords: ['kiss', 'love'], category: 'hearts' },
      { emoji: '', name: 'smiling_face_with_tear', keywords: ['happy', 'cry', 'tear'], category: 'smileys' },
      { emoji: '', name: 'yum', keywords: ['delicious', 'food', 'hungry'], category: 'smileys' },
      { emoji: '', name: 'stuck_out_tongue', keywords: ['playful', 'silly'], category: 'smileys' },
      { emoji: '', name: 'stuck_out_tongue_winking_eye', keywords: ['playful', 'silly', 'wink'], category: 'smileys' },
      { emoji: '', name: 'zany_face', keywords: ['crazy', 'silly', 'wild'], category: 'smileys' },
      { emoji: '', name: 'stuck_out_tongue_closed_eyes', keywords: ['playful', 'silly'], category: 'smileys' },
      { emoji: '', name: 'money_mouth', keywords: ['money', 'rich', 'greedy'], category: 'smileys' },
      
      // Negative emotions
      { emoji: '', name: 'neutral', keywords: ['neutral', 'meh', 'ok'], category: 'smileys' },
      { emoji: '', name: 'expressionless', keywords: ['blank', 'meh', 'whatever'], category: 'smileys' },
      { emoji: '', name: 'no_mouth', keywords: ['silent', 'quiet', 'speechless'], category: 'smileys' },
      { emoji: '', name: 'smirk', keywords: ['smug', 'confident'], category: 'smileys' },
      { emoji: '', name: 'unamused', keywords: ['annoyed', 'meh', 'bored'], category: 'smileys' },
      { emoji: '', name: 'eye_roll', keywords: ['annoyed', 'whatever', 'sarcastic'], category: 'smileys' },
      { emoji: '', name: 'grimacing', keywords: ['awkward', 'nervous', 'cringe'], category: 'smileys' },
      { emoji: '', name: 'lying', keywords: ['lie', 'pinocchio'], category: 'smileys' },
      { emoji: '', name: 'relieved', keywords: ['calm', 'peaceful', 'relieved'], category: 'smileys' },
      { emoji: '', name: 'pensive', keywords: ['sad', 'thoughtful', 'down'], category: 'smileys' },
      { emoji: '', name: 'sleepy', keywords: ['tired', 'sleep', 'sleepy'], category: 'smileys' },
      { emoji: '', name: 'drooling', keywords: ['hungry', 'desire', 'want'], category: 'smileys' },
      { emoji: '', name: 'sleeping', keywords: ['sleep', 'tired', 'zzz'], category: 'smileys' },
      { emoji: '', name: 'mask', keywords: ['sick', 'ill', 'covid'], category: 'smileys' },
      { emoji: '', name: 'thermometer_face', keywords: ['sick', 'fever', 'ill'], category: 'smileys' },
      { emoji: '', name: 'head_bandage', keywords: ['hurt', 'injured', 'sick'], category: 'smileys' },
      { emoji: '', name: 'nauseated', keywords: ['sick', 'gross', 'disgusted'], category: 'smileys' },
      { emoji: '', name: 'vomiting', keywords: ['sick', 'gross', 'disgusted'], category: 'smileys' },
      { emoji: '', name: 'sneezing', keywords: ['sick', 'sneeze', 'cold'], category: 'smileys' },
      { emoji: '', name: 'hot', keywords: ['hot', 'heat', 'sweating'], category: 'smileys' },
      { emoji: '', name: 'cold', keywords: ['cold', 'freezing', 'blue'], category: 'smileys' },
      { emoji: '', name: 'dizzy', keywords: ['dizzy', 'confused', 'spiral'], category: 'smileys' },
      { emoji: '', name: 'exploding_head', keywords: ['mind_blown', 'shocked', 'wow'], category: 'smileys' },
      { emoji: '', name: 'flushed', keywords: ['embarrassed', 'shy', 'red'], category: 'smileys' },
      { emoji: '', name: 'pleading', keywords: ['cute', 'puppy_eyes', 'please'], category: 'smileys' },
      { emoji: '', name: 'frowning', keywords: ['sad', 'disappointed'], category: 'smileys' },
      { emoji: '', name: 'anguished', keywords: ['worried', 'anxious', 'sad'], category: 'smileys' },
      { emoji: '', name: 'fearful', keywords: ['scared', 'afraid', 'fear'], category: 'smileys' },
      { emoji: '', name: 'cold_sweat', keywords: ['nervous', 'anxious', 'worried'], category: 'smileys' },
      { emoji: '', name: 'disappointed_relieved', keywords: ['sad', 'disappointed', 'relieved'], category: 'smileys' },
      { emoji: '', name: 'cry', keywords: ['sad', 'cry', 'tear'], category: 'smileys' },
      { emoji: '', name: 'sob', keywords: ['cry', 'sad', 'tears'], category: 'smileys' },
      { emoji: '', name: 'scream', keywords: ['scared', 'shocked', 'afraid'], category: 'smileys' },
      { emoji: '', name: 'confounded', keywords: ['frustrated', 'confused', 'annoyed'], category: 'smileys' },
      { emoji: '', name: 'persevere', keywords: ['frustrated', 'struggling', 'effort'], category: 'smileys' },
      { emoji: '', name: 'disappointed', keywords: ['sad', 'disappointed', 'down'], category: 'smileys' },
      { emoji: '', name: 'sweat', keywords: ['tired', 'working', 'effort'], category: 'smileys' },
      { emoji: '', name: 'weary', keywords: ['tired', 'exhausted', 'frustrated'], category: 'smileys' },
      { emoji: '', name: 'tired_face', keywords: ['tired', 'exhausted', 'worn_out'], category: 'smileys' },
      { emoji: '', name: 'triumph', keywords: ['proud', 'steaming', 'huffing'], category: 'smileys' },
      { emoji: '', name: 'rage', keywords: ['angry', 'mad', 'furious'], category: 'smileys' },
      { emoji: '', name: 'angry', keywords: ['angry', 'mad', 'upset'], category: 'smileys' },
      { emoji: '', name: 'swearing', keywords: ['angry', 'cursing', 'mad'], category: 'smileys' },
      
      // Gestures & People
      { emoji: '', name: 'thumbs_up', keywords: ['good', 'like', 'yes', 'approve'], category: 'gestures' },
      { emoji: '', name: 'thumbs_down', keywords: ['bad', 'dislike', 'no', 'disapprove'], category: 'gestures' },
      { emoji: '', name: 'ok_hand', keywords: ['ok', 'good', 'perfect'], category: 'gestures' },
      { emoji: '', name: 'peace', keywords: ['peace', 'victory', 'two'], category: 'gestures' },
      { emoji: '', name: 'crossed_fingers', keywords: ['luck', 'hope', 'wish'], category: 'gestures' },
      { emoji: '', name: 'love_you', keywords: ['love', 'rock', 'metal'], category: 'gestures' },
      { emoji: '', name: 'rock', keywords: ['rock', 'metal', 'horns'], category: 'gestures' },
      { emoji: '', name: 'call_me', keywords: ['call', 'phone', 'shaka'], category: 'gestures' },
      { emoji: '', name: 'point_left', keywords: ['point', 'left', 'direction'], category: 'gestures' },
      { emoji: '', name: 'point_right', keywords: ['point', 'right', 'direction'], category: 'gestures' },
      { emoji: '', name: 'point_up', keywords: ['point', 'up', 'direction'], category: 'gestures' },
      { emoji: '', name: 'point_down', keywords: ['point', 'down', 'direction'], category: 'gestures' },
      { emoji: '', name: 'index_pointing_up', keywords: ['point', 'up', 'one'], category: 'gestures' },
      { emoji: '', name: 'raised_hand', keywords: ['stop', 'hand', 'high_five'], category: 'gestures' },
      { emoji: '', name: 'raised_back_of_hand', keywords: ['stop', 'hand'], category: 'gestures' },
      { emoji: '', name: 'hand_with_fingers_splayed', keywords: ['hand', 'five', 'stop'], category: 'gestures' },
      { emoji: '', name: 'vulcan_salute', keywords: ['spock', 'star_trek', 'vulcan'], category: 'gestures' },
      { emoji: '', name: 'wave', keywords: ['hello', 'goodbye', 'wave'], category: 'gestures' },
      { emoji: '', name: 'pinching_hand', keywords: ['small', 'tiny', 'little'], category: 'gestures' },
      { emoji: '', name: 'flexed_biceps', keywords: ['strong', 'muscle', 'power'], category: 'gestures' },
      { emoji: '', name: 'pray', keywords: ['thank', 'please', 'hope'], category: 'gestures' },
      
      // Hearts
      { emoji: '', name: 'heart', keywords: ['love', 'heart', 'red'], category: 'hearts' },
      { emoji: '', name: 'orange_heart', keywords: ['love', 'heart', 'orange'], category: 'hearts' },
      { emoji: '', name: 'yellow_heart', keywords: ['love', 'heart', 'yellow'], category: 'hearts' },
      { emoji: '', name: 'green_heart', keywords: ['love', 'heart', 'green'], category: 'hearts' },
      { emoji: '', name: 'blue_heart', keywords: ['love', 'heart', 'blue'], category: 'hearts' },
      { emoji: '', name: 'purple_heart', keywords: ['love', 'heart', 'purple'], category: 'hearts' },
      { emoji: '', name: 'black_heart', keywords: ['love', 'heart', 'black'], category: 'hearts' },
      { emoji: '', name: 'white_heart', keywords: ['love', 'heart', 'white'], category: 'hearts' },
      { emoji: '', name: 'brown_heart', keywords: ['love', 'heart', 'brown'], category: 'hearts' },
      { emoji: '', name: 'broken_heart', keywords: ['heartbreak', 'sad', 'break'], category: 'hearts' },
      { emoji: '', name: 'exclamation_heart', keywords: ['love', 'exclamation'], category: 'hearts' },
      { emoji: '', name: 'two_hearts', keywords: ['love', 'hearts', 'two'], category: 'hearts' },
      { emoji: '', name: 'revolving_hearts', keywords: ['love', 'hearts', 'spinning'], category: 'hearts' },
      { emoji: '', name: 'beating_heart', keywords: ['love', 'heartbeat', 'pulse'], category: 'hearts' },
      { emoji: '', name: 'growing_heart', keywords: ['love', 'growing', 'pink'], category: 'hearts' },
      { emoji: '', name: 'sparkling_heart', keywords: ['love', 'sparkle', 'shine'], category: 'hearts' },
      { emoji: '', name: 'cupid', keywords: ['love', 'arrow', 'cupid'], category: 'hearts' },
      { emoji: '', name: 'gift_heart', keywords: ['love', 'gift', 'present'], category: 'hearts' },
      
      // Objects & Symbols
      { emoji: '', name: 'fire', keywords: ['hot', 'burn', 'flame'], category: 'objects' },
      { emoji: '', name: 'hundred', keywords: ['perfect', 'score', '100'], category: 'objects' },
      { emoji: '', name: 'anger', keywords: ['angry', 'mad', 'symbol'], category: 'objects' },
      { emoji: '', name: 'boom', keywords: ['explosion', 'bang', 'pow'], category: 'objects' },
      { emoji: '', name: 'dizzy', keywords: ['star', 'sparkle', 'dizzy'], category: 'objects' },
      { emoji: '', name: 'sweat_drops', keywords: ['water', 'sweat', 'splash'], category: 'objects' },
      { emoji: '', name: 'dash', keywords: ['fast', 'wind', 'speed'], category: 'objects' },
      { emoji: '', name: 'star', keywords: ['star', 'favorite', 'yellow'], category: 'objects' },
      { emoji: '', name: 'glowing_star', keywords: ['star', 'sparkle', 'glow'], category: 'objects' },
      { emoji: '', name: 'sparkles', keywords: ['sparkle', 'shine', 'magic'], category: 'objects' },
      { emoji: '', name: 'lightning', keywords: ['electric', 'fast', 'power'], category: 'objects' },
      { emoji: '', name: 'party', keywords: ['celebration', 'party', 'confetti'], category: 'objects' },
      { emoji: '', name: 'confetti', keywords: ['celebration', 'party', 'confetti'], category: 'objects' }
    ];

    // Reaction emojis organized by category
    const reactionCategories = {
      frequent: ['', '', '', '', '', '', '', ''],
      smileys: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      hearts: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      gestures: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
      objects: ['', '', '', '', '', '', '', '', '', '', '', '', '']
    };

    // Room Color System
    const DEFAULT_COLORS = [
      { name: 'Default Blue', color: '#9ccfd8', unlocked: true },
      { name: 'Rose Red', color: '#eb6f92', unlocked: true },
      { name: 'Iris Purple', color: '#c4a7e7', unlocked: true },
      { name: 'Foam Green', color: '#9ccfd8', unlocked: true },
      { name: 'Love Pink', color: '#f6c177', unlocked: true },
      { name: 'Gold Yellow', color: '#f6c177', unlocked: true }
    ];

    const XP_UNLOCKED_COLORS = [
      { name: 'Ocean Deep', color: '#1e3a8a', requiredLevel: 2, requiredXP: 100 },
      { name: 'Forest Grove', color: '#166534', requiredLevel: 3, requiredXP: 250 },
      { name: 'Sunset Orange', color: '#ea580c', requiredLevel: 4, requiredXP: 500 },
      { name: 'Royal Purple', color: '#7c3aed', requiredLevel: 5, requiredXP: 850 },
      { name: 'Crimson Fire', color: '#dc2626', requiredLevel: 6, requiredXP: 1300 },
      { name: 'Emerald Shine', color: '#059669', requiredLevel: 7, requiredXP: 1850 },
      { name: 'Cosmic Indigo', color: '#4338ca', requiredLevel: 8, requiredXP: 2500 },
      { name: 'Magenta Blast', color: '#c2410c', requiredLevel: 9, requiredXP: 3250 },
      { name: 'Neon Green', color: '#16a34a', requiredLevel: 10, requiredXP: 4100 },
      { name: 'Electric Blue', color: '#0ea5e9', requiredLevel: 11, requiredXP: 5050 },
      { name: 'Volcano Red', color: '#b91c1c', requiredLevel: 12, requiredXP: 6100 },
      { name: 'Mystic Violet', color: '#8b5cf6', requiredLevel: 13, requiredXP: 7250 },
      { name: 'Galaxy Black', color: '#1f2937', requiredLevel: 14, requiredXP: 8500 },
      { name: 'Phoenix Gold', color: '#d97706', requiredLevel: 15, requiredXP: 9850 },
      { name: 'Divine White', color: '#f8fafc', requiredLevel: 16, requiredXP: 11300 },
      { name: 'Shadow Void', color: '#0f172a', requiredLevel: 17, requiredXP: 12850 },
      { name: 'Rainbow Prism', color: 'linear-gradient(45deg, #ff0000, #ff7700, #ffdd00, #00ff00, #0077ff, #3300ff, #7700ff)', requiredLevel: 18, requiredXP: 14500 },
      { name: 'Aurora Borealis', color: 'linear-gradient(135deg, #00ffff, #0077ff, #7700ff, #ff00ff)', requiredLevel: 19, requiredXP: 16250 },
      { name: 'Transcendent Glow', color: 'linear-gradient(45deg, #ffd700, #ffb347, #ff69b4, #9370db, #00ced1)', requiredLevel: 20, requiredXP: 18100 }
    ];

    // Color picker state
    let selectedColor = null;
    let currentUserXP = 0;
    let currentUserLevel = 1;

    // Emoji data
    const quickEmojis = [
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '',
      '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''
    ];

    // Content Filter Class
    class ChatContentFilter {
      constructor() {
        this.badWords = [
          'spam', 'scam', 'hack', 'cheat', 'bot', 'fake', 'phishing',
          // Add more filtered words as needed
        ];
        this.suspiciousPatterns = [
          /(.)\1{4,}/g, // Repeated characters
          /[A-Z]{10,}/g, // Excessive caps
          /(https?:\/\/[^\s]+)/g, // URLs (for security)
        ];
      }

      filter(text) {
        if (!text || typeof text !== 'string') return '';
        
        // Remove potentially harmful content
        let filtered = text.trim();
        
        // Security: Remove script tags and other dangerous content
        filtered = filtered.replace(/<script[\s\S]*?<\/script>/gi, '[SCRIPT REMOVED]');
        filtered = filtered.replace(/javascript:/gi, '[JS REMOVED]');
        filtered = filtered.replace(/on\w+\s*=/gi, '[EVENT REMOVED]');
        
        // Check for bad words
        for (const word of this.badWords) {
          const regex = new RegExp(`\\b${word}\\b`, 'gi');
          filtered = filtered.replace(regex, '*'.repeat(word.length));
        }
        
        // Apply pattern filters
        filtered = filtered.replace(/(.)\1{4,}/g, (match) => match[0].repeat(3));
        filtered = filtered.replace(/[A-Z]{10,}/g, (match) => match.toLowerCase());
        filtered = filtered.replace(/(https?:\/\/[^\s]+)/g, '[LINK REMOVED]');
        
        // Process emojis if converter is available
        if (emojiConverter) {
          filtered = emojiConverter.replace_colons(filtered);
        }
        
        return filtered.substring(0, 500); // Limit length
      }

      isAppropriate(text) {
        if (!text) return false;
        
        const originalText = text.trim();
        const filtered = this.filter(originalText);
        
        // Text is appropriate if:
        // 1. It's not empty after filtering
        // 2. It doesn't contain bad words (filtered text should be similar to original)
        // 3. No excessive repeated characters or other suspicious patterns
        
        // Check if bad words were replaced (contains asterisks)
        if (filtered.includes('*')) {
          return false;
        }
        
        // Check if the text was significantly modified by pattern filters
        const normalizedOriginal = originalText.replace(/(.)\1{4,}/g, (match) => match[0].repeat(3));
        const normalizedFiltered = filtered.replace(/\[LINK REMOVED\]/g, ''); // Remove link placeholders for comparison
        
        // Text is appropriate if it wasn't heavily modified
        return filtered.length > 0 && Math.abs(normalizedOriginal.length - normalizedFiltered.length) < originalText.length * 0.3;
      }
    }

    const contentFilter = new ChatContentFilter();

    // Sanitization functions
    function sanitizeText(text) {
      if (!text) return '';
      return DOMPurify.sanitize(text, { 
        ALLOWED_TAGS: [], 
        ALLOWED_ATTR: [] 
      }).trim();
    }

    function sanitizeHTML(html) {
      return DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong'],
        ALLOWED_ATTR: []
      });
    }

    // Authentication - Main implementation
    async function mainGoogleSignIn() {
      if (!firebaseInitialized) {
        showNotification('Please Wait', 'Chat system is still loading. Please try again in a moment.', 'warning');
        return;
      }

      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');
        
        try {
          const result = await auth.signInWithPopup(provider);
          console.log('Signed in successfully:', result.user.email);
        } catch (popupError) {
          if (popupError.code === 'auth/popup-blocked' || 
              popupError.code === 'auth/popup-closed-by-user' ||
              popupError.message.includes('Cross-Origin-Opener-Policy')) {
            console.log('Popup blocked, using redirect method');
            await auth.signInWithRedirect(provider);
          } else {
            throw popupError;
          }
        }
      } catch (error) {
        console.error('Sign in error:', error);
        showNotification('Sign In Failed', 'Please try again or check your connection.', 'error');
      }
    }
    
    // Expose main function to global scope immediately
    window.mainGoogleSignIn = mainGoogleSignIn;

    async function signOut() {
      try {
        await leaveCurrentRoom();
        await auth.signOut();
        console.log('Signed out successfully');
      } catch (error) {
        console.error('Sign out error:', error);
      }
    }

    // Room Management
    async function loadRooms() {
      if (!firebaseInitialized) {
        console.log('Firebase not initialized, cannot load rooms');
        showOfflineMessage();
        return;
      }

      try {
        // Create default room if it doesn't exist
        await ensureDefaultRoom();

        // Listen to rooms collection
        roomsListener = db.collection('chatRooms')
          .orderBy('createdAt', 'desc')
          .onSnapshot(snapshot => {
            const roomsList = document.getElementById('roomsList');
            roomsList.innerHTML = '';

            if (snapshot.empty) {
              showEmptyRoomsMessage();
              return;
            }

            snapshot.forEach(doc => {
              const room = { id: doc.id, ...doc.data() };
              displayRoom(room);
            });

            // Auto-cleanup expired rooms
            cleanupExpiredRooms();
          }, error => {
            console.error('Error in rooms snapshot listener:', error);
            if (error.code === 'unavailable' || error.message.includes('offline')) {
              showOfflineMessage();
            }
          });
      } catch (error) {
        console.error('Error loading rooms:', error);
        if (error.code === 'unavailable' || error.message.includes('offline')) {
          showOfflineMessage();
        }
      }
    }

    function showOfflineMessage() {
      const roomsList = document.getElementById('roomsList');
      roomsList.innerHTML = `
        <div class="text-center py-8 text-rp-muted">
          <i class='bx bx-wifi-off text-4xl mb-4 block'></i>
          <p>You're currently offline</p>
          <p class="text-sm mt-2">Rooms will load when connection is restored</p>
        </div>
      `;
    }

    function showEmptyRoomsMessage() {
      const roomsList = document.getElementById('roomsList');
      roomsList.innerHTML = `
        <div class="text-center py-8 text-rp-muted">
          <i class='bx bx-chat text-4xl mb-4 block'></i>
          <p>No chat rooms available</p>
          <p class="text-sm mt-2">Create a new room to get started</p>
        </div>
      `;
    }

    async function ensureDefaultRoom() {
      if (!firebaseInitialized) {
        console.log('Firebase not initialized, skipping default room creation');
        return;
      }

      try {
        // Create default general chat room
        const defaultRoomRef = db.collection('chatRooms').doc('default');
        const defaultRoom = await defaultRoomRef.get();

        if (!defaultRoom.exists) {
          await defaultRoomRef.set({
            name: 'General Chat',
            description: 'Welcome to the default chat room! Chat with everyone here.',
            type: 'default',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: 'system',
            userCount: 0,
            lastActivity: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log('Default room created');
        }

        // Create AI assistant room
        const aiRoomRef = db.collection('chatRooms').doc('ai-assistant');
        const aiRoom = await aiRoomRef.get();

        if (!aiRoom.exists) {
          await aiRoomRef.set({
            name: 'AI Assistant',
            description: 'Chat with our intelligent AI assistant powered by Pollinations AI ',
            type: 'ai',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: 'system',
            userCount: 0,
            lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
            isAIRoom: true,
            aiProvider: 'pollinations'
          });
          console.log('AI room created');
        }
      } catch (error) {
        if (error.code === 'unavailable' || error.message.includes('offline')) {
          console.log('Cannot ensure default rooms while offline, will retry when online');
        } else {
          console.error('Error ensuring default rooms:', error);
        }
      }
    }

    function displayRoom(room) {
      const roomsList = document.getElementById('roomsList');
      const isExpired = room.type === 'temporary' && room.expiresAt && room.expiresAt.toDate() < new Date();
      
      if (isExpired) return; // Don't display expired rooms

      const roomDiv = document.createElement('div');
      const isAIRoom = room.isAIRoom || room.type === 'ai';
      roomDiv.className = `room-item ${room.type} ${isAIRoom ? 'ai-room' : ''} ${currentRoomId === room.id ? 'active' : ''}`;
      roomDiv.setAttribute('data-room-id', room.id);
      roomDiv.addEventListener('click', () => joinRoom(room.id));

      let timeInfo = '';
      if (room.type === 'temporary' && room.expiresAt) {
        const timeLeft = room.expiresAt.toDate() - new Date();
        const hoursLeft = Math.floor(timeLeft / 3600000);
        const minutesLeft = Math.floor((timeLeft % 3600000) / 60000);
        
        if (timeLeft > 0) {
          timeInfo = `<div class="room-timer ${timeLeft < 600000 ? 'expiring' : ''}">
            <i class='bx bx-time'></i> ${hoursLeft}h ${minutesLeft}m left
          </div>`;
        }
      }

      // AI room special indicators
      let roomIcon = '';
      if (room.type === 'default') {
        roomIcon = '<i class="bx bx-crown text-rp-gold"></i>';
      } else if (room.type === 'temporary') {
        roomIcon = '<i class="bx bx-clock text-rp-iris"></i>';
      } else if (isAIRoom) {
        roomIcon = '<i class="bx bx-brain ai-room-icon"></i>';
      }

      roomDiv.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="font-semibold ${isAIRoom ? 'ai-room-name' : ''}">${sanitizeText(room.name)} ${isAIRoom ? '' : ''}</div>
            ${room.description ? `<div class="text-sm opacity-75">${sanitizeText(room.description)}</div>` : ''}
            ${timeInfo}
            ${isAIRoom ? '<div class="ai-room-badge">AI Assistant</div>' : ''}
          </div>
          <div class="flex items-center gap-2">
            ${roomIcon}
            <span class="user-count">${room.userCount || 0}</span>
          </div>
        </div>
      `;

      roomsList.appendChild(roomDiv);
    }

    async function joinRoom(roomId) {
      if (!currentUser) {
        showNotification('Sign In Required', 'Please sign in to join chat rooms.', 'warning');
        return;
      }

      try {
        // Leave current room first
        await leaveCurrentRoom();

        // Get room data first
        const roomDoc = await db.collection('chatRooms').doc(roomId).get();
        const roomData = roomDoc.data() || {};

        // Join new room
        currentRoomId = roomId;
        console.log(` Joining room: ${roomId}`);
        
        // Check if user is already in this room to prevent duplicate increments
        const existingPresence = await db.collection('chatRooms').doc(roomId).collection('presence').doc(currentUser.uid).get();
        
        if (!existingPresence.exists) {
          // Only increment if user wasn't already in the room
          await db.collection('chatRooms').doc(roomId).set({
            userCount: firebase.firestore.FieldValue.increment(1),
            lastActivity: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          console.log(` Incremented user count for room ${roomId}`);
        } else {
          // Just update lastActivity if already present
          await db.collection('chatRooms').doc(roomId).set({
            lastActivity: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          console.log(` User ${currentUser.uid} already present in room ${roomId}, skipping increment`);
        }

        // Add user to room presence (always update this)
        await db.collection('chatRooms').doc(roomId).collection('presence').doc(currentUser.uid).set({
          userId: currentUser.uid,
          userName: currentUser.displayName || 'Anonymous',
          userPhoto: currentUser.photoURL || '',
          joinedAt: existingPresence.exists ? existingPresence.data().joinedAt : firebase.firestore.FieldValue.serverTimestamp(),
          lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
          lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
          isActive: true,
          isAFK: false,
          afkSince: null
        });

        // Update UI
        updateChatUI(roomId);
        loadMessages(roomId);
        updateRoomHighlight();

        // Setup typing indicator
        setupTypingIndicator();

        // Show room joined notification with special message for AI room
        const isAIRoom = roomData.isAIRoom || roomData.type === 'ai';
        const welcomeText = isAIRoom ? 
          `Welcome to ${roomData.name || 'Chat Room'}! Your AI assistant is ready to help ` : 
          `Welcome to ${roomData.name || 'Chat Room'}`;
        
        showNotification('Room Joined', welcomeText, 'success', { 
          duration: 3000,
          roomId: roomId 
        });

        // Auto-activate AI in AI rooms
        if (isAIRoom && !aiChatbot.isActive) {
          aiChatbot.activate();
          setTimeout(async () => {
            await sendAIWelcomeMessage('Welcome to the AI Assistant room! I\'m here to help, answer questions, or just have a friendly chat. What would you like to talk about? ');
          }, 2000);
        }

        // Check if AI should be activated for this room
        
        if (roomData && aiChatbot.shouldActivate(roomData.userCount || 0)) {
          setTimeout(() => {
            if (aiChatbot.shouldActivate(roomData.userCount || 0)) {
              aiChatbot.activate();
            }
          }, 2000); // Wait 2 seconds to see if others join
        } else {
          aiChatbot.deactivate();
        }

        // Setup AFK detection for this room
        setupAFKDetection();

        console.log('Joined room:', roomId);
      } catch (error) {
        console.error('Error joining room:', error);
        showNotification('Join Failed', 'Failed to join room. Please try again.', 'error');
      }
    }

    // Update user count display in the UI
    async function updateUserCountDisplay(roomId) {
      if (!roomId) return;
      
      try {
        const presenceSnapshot = await db.collection('chatRooms').doc(roomId).collection('presence').get();
        const userCount = presenceSnapshot.size;
        
        const userCountElement = document.getElementById('userCount');
        if (userCountElement) {
          userCountElement.textContent = `${userCount} ${userCount === 1 ? 'user' : 'users'}`;
        }
        
        console.log(` Updated user count display: ${userCount} users in room ${roomId}`);
      } catch (error) {
        console.error('Error updating user count display:', error);
      }
    }

    // Fix negative user counts by recalculating from actual presence
    async function fixUserCounts() {
      if (!firebaseInitialized) return;
      
      try {
        console.log(' Fixing user counts...');
        const roomsSnapshot = await db.collection('chatRooms').get();
        
        for (const roomDoc of roomsSnapshot.docs) {
          const roomId = roomDoc.id;
          const roomData = roomDoc.data();
          
          // Count actual presence documents
          const presenceSnapshot = await db.collection('chatRooms').doc(roomId).collection('presence').get();
          const actualUserCount = presenceSnapshot.size;
          
          // Update if different from stored count
          if (roomData.userCount !== actualUserCount) {
            await db.collection('chatRooms').doc(roomId).set({
              userCount: actualUserCount
            }, { merge: true });
            console.log(` Fixed ${roomId}: ${roomData.userCount}  ${actualUserCount} users`);
          }
        }
        console.log(' User count fix completed');
      } catch (error) {
        console.error('Error fixing user counts:', error);
      }
    }

    async function leaveCurrentRoom() {
      if (!currentRoomId || !currentUser) return;

      const roomToLeave = currentRoomId; // Store current room ID
      console.log(` Leaving room: ${roomToLeave}`);

      try {
        // Check if user is actually in the room before decrementing
        const presenceDoc = await db.collection('chatRooms').doc(roomToLeave).collection('presence').doc(currentUser.uid).get();
        
        if (presenceDoc.exists) {
          // Remove from presence
          await db.collection('chatRooms').doc(roomToLeave).collection('presence').doc(currentUser.uid).delete();
          console.log(` Removed presence for user ${currentUser.uid} from room ${roomToLeave}`);

          // Only decrement if user was actually present
          await db.collection('chatRooms').doc(roomToLeave).set({
            userCount: firebase.firestore.FieldValue.increment(-1)
          }, { merge: true });
          console.log(` Decremented user count for room ${roomToLeave}`);
        } else {
          console.log(` User ${currentUser.uid} was not present in room ${roomToLeave}, skipping decrement`);
        }

        // Clean up listeners
        if (messagesListener) {
          messagesListener();
          messagesListener = null;
        }

        if (userPresenceListener) {
          userPresenceListener();
          userPresenceListener = null;
        }

        // Cleanup AFK detection
        if (afkCheckInterval) {
          clearInterval(afkCheckInterval);
          afkCheckInterval = null;
        }

        // Remove activity listeners
        ['keypress', 'click', 'mousemove', 'scroll'].forEach(event => {
          document.removeEventListener(event, updateActivity);
        });

        activeUsers.clear();
        currentRoomId = null;
        updateChatUI();
        updateRoomHighlight();
      } catch (error) {
        console.error('Error leaving room:', error);
      }
    }

    function updateChatUI(roomId = null) {
      const chatTitle = document.getElementById('chatTitle');
      const roomTypeBadge = document.getElementById('roomTypeBadge');
      const roomType = document.getElementById('roomType');
      const messageForm = document.getElementById('messageForm');
      const leaveBtn = document.getElementById('leaveRoomBtn');
      const userCountDisplay = document.getElementById('userCountDisplay');
      const toggleUserListBtn = document.getElementById('toggleUserListBtn');
      const userListContainer = document.getElementById('userListContainer');
      const roomTimer = document.getElementById('roomTimer');

      if (roomId) {
        db.collection('chatRooms').doc(roomId).get().then(doc => {
          if (doc.exists) {
            const room = doc.data();
            chatTitle.textContent = room.name;
            roomTypeBadge.classList.remove('hidden');
            
            // Update room type badge
            roomType.textContent = room.type === 'default' ? 'Default Room' : 'Temporary Room';
            roomTypeBadge.className = `room-type-badge ${room.type}`;
            
            if (room.type === 'temporary' && room.expiresAt) {
              roomTimer.classList.remove('hidden');
              updateRoomTimer(room.expiresAt.toDate());
            } else {
              roomTimer.classList.add('hidden');
            }
          }
        });

        messageForm.classList.remove('hidden');
        leaveBtn.classList.remove('hidden');
        userCountDisplay.classList.remove('hidden');
        toggleUserListBtn.classList.remove('hidden');
        document.getElementById('customizeColorBtn').classList.remove('hidden');
        document.getElementById('carbonArtBtn').classList.remove('hidden');
        document.getElementById('xpWidget').classList.remove('hidden');
        document.getElementById('guestMessage').style.display = 'none';
        document.getElementById('chatMessages').innerHTML = '';
        
        // Initialize/update XP widget
        updateXPWidget();
        
        // Load room theme
        loadRoomTheme(roomId);
        
        // Update user count display
        updateUserCountDisplay(roomId);
      } else {
        chatTitle.textContent = 'Select a room to start chatting';
        roomTypeBadge.classList.add('hidden');
        roomTimer.classList.add('hidden');
        messageForm.classList.add('hidden');
        leaveBtn.classList.add('hidden');
        userCountDisplay.classList.add('hidden');
        toggleUserListBtn.classList.add('hidden');
        userListContainer.classList.add('hidden');
        document.getElementById('customizeColorBtn').classList.add('hidden');
        document.getElementById('carbonArtBtn').classList.add('hidden');
        document.getElementById('xpWidget').classList.add('hidden');
        
        // Remove room theme when leaving
        removeRoomTheme();
        
        if (!currentUser) {
          document.getElementById('guestMessage').style.display = 'block';
        }
      }
    }

    function updateRoomTimer(expiresAt) {
      const timer = document.getElementById('roomTimer');
      
      function updateTimer() {
        const timeLeft = expiresAt - new Date();
        if (timeLeft <= 0) {
          timer.textContent = 'Expired';
          timer.className = 'room-timer expiring';
          return;
        }

        const hours = Math.floor(timeLeft / 3600000);
        const minutes = Math.floor((timeLeft % 3600000) / 60000);
        timer.textContent = `  Expires in ${hours}h ${minutes}m`;
        timer.className = timeLeft < 600000 ? 'room-timer expiring' : 'room-timer';
      }

      updateTimer();
      setInterval(updateTimer, 60000); // Update every minute
    }

    function updateRoomHighlight() {
      document.querySelectorAll('.room-item').forEach(item => {
        item.classList.remove('active');
      });

      if (currentRoomId) {
        const activeRoom = document.querySelector(`[data-room-id="${currentRoomId}"]`);
        if (activeRoom) {
          activeRoom.classList.add('active');
        }
      }
    }

    // Message Management
    async function sendMessage(event) {
      event.preventDefault();
      
      if (!currentUser || !currentRoomId) return;

      const messageInput = document.getElementById('messageInput');
      const content = messageInput.value.trim();

      if (!content) return;

      // Sanitize and filter content
      const sanitizedContent = sanitizeText(content);
      const filteredContent = contentFilter.filter(sanitizedContent);

      if (!filteredContent || filteredContent.length === 0) {
        showNotification('Content Filtered', 'Your message contains inappropriate content and cannot be sent.', 'warning');
        return;
      }

      try {
        // Process mentions in the message
        const mentions = processMentionsInMessage(filteredContent);

        // Prepare message data
        const messageData = {
          content: filteredContent,
          authorId: currentUser.uid,
          authorName: currentUser.displayName || 'Anonymous',
          authorPhoto: currentUser.photoURL || '',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          type: 'user',
          mentions: mentions
        };

        // Add reply information if replying to a message
        if (replyingTo) {
          messageData.replyTo = {
            messageId: replyingTo.id,
            authorName: replyingTo.authorName,
            content: replyingTo.content.length > 100 ? replyingTo.content.substring(0, 100) + '...' : replyingTo.content
            // Note: timestamp will be set when message is retrieved from Firestore
          };
        }

        // Send user message
        await db.collection('chatRooms').doc(currentRoomId).collection('messages').add(messageData);

        // Send mention notifications
        if (mentions.length > 0) {
          await sendMentionNotifications(mentions, filteredContent, currentRoomId);
        }

        // Update room activity
        await db.collection('chatRooms').doc(currentRoomId).set({
          lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        messageInput.value = '';
        cancelReply(); // Clear any active reply
        updateActivity(); // Reset AFK status

        // Stop typing indicator
        stopTyping();

        // Award XP for sending message
        const messageElement = document.getElementById('messageInput');
        awardXP(currentUser.uid, XP_REWARDS.MESSAGE, 'Message sent', messageElement);

        // Update message count
        await updateMessageCount(currentUser.uid);

        // Show success feedback
        showNotification('Message Sent', 'Your message was sent successfully', 'success', { duration: 2000 });

        // Check if AI should respond (when room is empty or user is alone)
        const roomDoc = await db.collection('chatRooms').doc(currentRoomId).get();
        const roomData = roomDoc.data();
        
        // AI responds in AI rooms or when room is empty/user is alone
        const isAIRoom = roomData && (roomData.isAIRoom || roomData.type === 'ai');
        const shouldActivateGeneral = roomData && aiChatbot.shouldActivate(roomData.userCount || 0);
        
        if (isAIRoom || shouldActivateGeneral) {
          if (!aiChatbot.isActive) {
            aiChatbot.activate();
            // Send welcome message from AI
            setTimeout(async () => {
              if (isAIRoom) {
                await sendAIWelcomeMessage('Hello! I\'m your AI assistant powered by Pollinations AI. How can I help you today? ');
              } else {
                await sendAIWelcomeMessage();
              }
            }, 1000);
          } else {
            // Generate AI response
            setTimeout(async () => {
              await generateAIResponse(filteredContent);
            }, isAIRoom ? 800 + Math.random() * 1200 : 1500 + Math.random() * 2000); // Faster response in AI rooms
          }
        } else if (aiChatbot.isActive && !isAIRoom && (roomData.userCount || 0) > 1) {
          aiChatbot.deactivate();
        }

      } catch (error) {
        console.error('Error sending message:', error);
        if (error.code === 'unavailable' || error.message.includes('offline')) {
          showNotification('Offline', 'Cannot send message while offline. Please check your connection.', 'error');
        } else {
          showNotification('Send Failed', 'Failed to send message. Please try again.', 'error');
        }
      }
    }

    async function sendAIWelcomeMessage(customMessage = null) {
      if (!currentRoomId || !aiChatbot.isActive) return;

      let welcomeMessage = customMessage;
      
      if (!customMessage) {
        const welcomeMessages = [
          "Hello! I'm your AI assistant. Since it's quiet in here, I'm here to chat with you! ",
          "Hi there! Looks like you're the only one here right now. I'm an AI and I'd love to chat!",
          "Welcome! I'm an AI assistant keeping you company while the room is empty. What's on your mind?",
          "Hey! I'm your friendly AI companion. Feel free to ask me anything or just chat!",
        ];
        welcomeMessage = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
      }

      try {
        await db.collection('chatRooms').doc(currentRoomId).collection('messages').add({
          content: welcomeMessage,
          authorId: 'ai-assistant',
          authorName: 'AI Assistant',
          authorPhoto: '',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          type: 'ai'
        });
      } catch (error) {
        console.error('Error sending AI welcome message:', error);
      }
    }

    async function generateAIResponse(userMessage) {
      if (!currentRoomId || !aiChatbot.isActive) return;

      try {
        // Show AI typing indicator
        showAITyping();
        
        const aiResponse = await aiChatbot.generateResponse(userMessage);
        aiChatbot.updateConversationHistory(userMessage, aiResponse);
        
        // Hide typing indicator
        hideAITyping();

        await db.collection('chatRooms').doc(currentRoomId).collection('messages').add({
          content: aiResponse,
          authorId: 'ai-assistant',
          authorName: 'AI Assistant',
          authorPhoto: '',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          type: 'ai'
        });
      } catch (error) {
        console.error('Error generating AI response:', error);
      }
    }

    function loadMessages(roomId) {
      if (messagesListener) {
        messagesListener();
      }

      messagesListener = db.collection('chatRooms').doc(roomId).collection('messages')
        .orderBy('timestamp', 'asc')
        .limit(100) // Increased limit for better conversation context
        .onSnapshot(snapshot => {
          const messagesContainer = document.getElementById('chatMessages');
          messagesContainer.innerHTML = '';

          // Clear any active reply when switching rooms
          cancelReply();

          snapshot.forEach(doc => {
            const message = { id: doc.id, ...doc.data() };
            displayMessage(message);
          });

          // Scroll to bottom
          messagesContainer.scrollTop = messagesContainer.scrollHeight;

          // Clean up old messages if there are too many
          if (snapshot.size > 80) {
            cleanupOldMessages(roomId);
          }
        });
    }

    function displayMessage(message) {
      const messagesContainer = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      
      const isOwn = currentUser && message.authorId === currentUser.uid;
      const isSystem = message.type === 'system';
      const isAI = message.type === 'ai' || message.authorId === 'ai-assistant';
      
      messageDiv.className = `message ${isOwn ? 'own' : ''} ${isSystem ? 'system' : ''} ${isAI ? 'ai' : ''}`;
      messageDiv.setAttribute('data-message-id', message.id);

      if (isSystem) {
        messageDiv.innerHTML = `
          <div class="message-content">
            <i class='bx bx-info-circle mr-2'></i>
            ${sanitizeHTML(message.content)}
          </div>
        `;
      } else if (isAI) {
        const timestamp = message.timestamp ? message.timestamp.toDate().toLocaleTimeString() : 'Sending...';
        let replyHtml = '';
        if (message.replyTo) {
          replyHtml = `
            <div class="reply-original">
              <div class="text-xs text-rp-muted">${sanitizeText(message.replyTo.authorName)}</div>
              <div class="text-sm">${sanitizeHTML(message.replyTo.content)}</div>
            </div>
          `;
        }
        
        messageDiv.innerHTML = `
          ${replyHtml}
          <div class="message-header">
            <div class="flex items-center gap-2">
              <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 flex items-center justify-center">
                <i class='bx bx-bot text-white text-xs'></i>
              </div>
              <span class="font-semibold text-rp-iris">${sanitizeText(message.authorName)}</span>
              <span class="text-xs bg-rp-iris text-rp-base px-2 py-0.5 rounded-full">AI</span>
            </div>
            <span class="timestamp">${timestamp}</span>
          </div>
          <div class="message-content">${highlightMentions(sanitizeHTML(message.content))}</div>
          ${generateReactionsHTML(message)}
          <button class="reply-button" data-message-id="${message.id}" data-author-name="${sanitizeText(message.authorName)}" data-content="${sanitizeText(message.content)}">
            <i class='bx bx-reply'></i> Reply
          </button>
          ${isOwn ? `
            <div class="message-actions">
              <button class="message-delete-btn" data-message-id="${message.id}" data-content="${sanitizeText(message.content)}">
                <i class='bx bx-trash'></i> Delete
              </button>
            </div>
          ` : ''}
        `;
      } else {
        const timestamp = message.timestamp ? message.timestamp.toDate().toLocaleTimeString() : 'Sending...';
        let replyHtml = '';
        if (message.replyTo) {
          replyHtml = `
            <div class="reply-original">
              <div class="text-xs text-rp-muted">${sanitizeText(message.replyTo.authorName)}</div>
              <div class="text-sm">${sanitizeHTML(message.replyTo.content)}</div>
            </div>
          `;
        }
        
        messageDiv.innerHTML = `
          ${replyHtml}
          <div class="message-header">
            <div class="flex items-center gap-2">
              ${message.authorPhoto ? `<img src="${message.authorPhoto}" alt="Avatar" class="w-6 h-6 rounded-full clickable-avatar" data-user-id="${message.authorId}" data-user-name="${sanitizeText(message.authorName)}" data-user-photo="${message.authorPhoto}">` : '<div class="w-6 h-6 rounded-full bg-rp-foam"></div>'}
              <span class="font-semibold clickable-avatar" data-user-id="${message.authorId}" data-user-name="${sanitizeText(message.authorName)}" data-user-photo="${message.authorPhoto || ''}">${sanitizeText(message.authorName)}${getUserAFKIndicator(message.authorId)}</span>
            </div>
            <span class="timestamp">${timestamp}</span>
          </div>
          <div class="message-content">
            ${highlightMentions(sanitizeHTML(message.content))}
            ${message.messageType === 'artwork' && message.imageData ? `
              <div class="artwork-container" style="margin: 0.5rem 0; background: white; padding: 0.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <img src="${message.imageData}" alt="Shared artwork" 
                     style="max-width: 200px; max-height: 200px; border-radius: 6px; cursor: pointer;"
                     class="artwork-image"
                     data-artwork-title="${message.content.replace(/.*: \"/, '').replace(/\"$/, '')}"
                     data-artwork-image="${message.imageData}"
                     data-artwork-author="${message.authorName}">
              </div>
            ` : ''}
          </div>
          ${generateReactionsHTML(message)}
          ${currentUser ? `<button class="reply-button" data-message-id="${message.id}" data-author-name="${sanitizeText(message.authorName)}" data-content="${sanitizeText(message.content)}">
            <i class='bx bx-reply'></i> Reply
          </button>` : ''}
          ${isOwn ? `
            <div class="message-actions">
              <button class="message-delete-btn" data-message-id="${message.id}" data-content="${sanitizeText(message.content)}">
                <i class='bx bx-trash'></i> Delete
              </button>
            </div>
          ` : ''}
        `;
      }

      // Apply current theme to new message if one is active
      if (document.body.classList.contains('custom-theme')) {
        messageDiv.classList.add('custom-theme');
      }
      
      messagesContainer.appendChild(messageDiv);

              // Show notification for new messages if tab is not focused OR if user is in the room
        if (!isOwn && !isSystem) {
          const shouldNotify = !document.hasFocus() || 
                              (currentRoomId && message.roomId === currentRoomId && document.hasFocus());
          
          if (shouldNotify) {
            playNotificationSound(); // Play sound for all new messages in current room
            
            // Only show visual notification if tab is not focused
            if (!document.hasFocus()) {
              showNotification(
                'New Message',
                `${message.authorName}: ${message.content.substring(0, 100)}${message.content.length > 100 ? '...' : ''}`,
                'message',
                {
                  avatar: message.authorPhoto,
                  roomId: currentRoomId,
                  duration: 5000
                }
              );
            }
          }

          // Check for mentions of current user
          if (currentUser && message.mentions && message.mentions.length > 0) {
            const currentUsername = getUsernameFromDisplayName(currentUser.displayName);
            const isMentioned = message.mentions.some(mention => 
              mention.toLowerCase() === currentUsername.toLowerCase());
            
            if (isMentioned) {
              addNotification(
                'mention',
                `${message.authorName} mentioned you`,
                message.content.length > 100 ? message.content.substring(0, 100) + '...' : message.content,
                {
                  avatar: message.authorPhoto,
                  userName: message.authorName,
                  roomId: currentRoomId
                }
              );
              
              // Play special sound for mentions (double beep)
              playNotificationSound();
              setTimeout(() => playNotificationSound(), 200);
            }
          }
        }
    }

    // Reactions functionality
    function generateReactionsHTML(message) {
      if (!message.reactions || !currentUser) return '';

      let reactionsHTML = '<div class="message-reactions">';
      
      // Display existing reactions
      Object.entries(message.reactions).forEach(([emoji, data]) => {
        const count = data.users ? Object.keys(data.users).length : 0;
        const hasReacted = data.users && data.users[currentUser.uid];
        
        reactionsHTML += `
          <div class="reaction ${hasReacted ? 'reacted' : ''}" 
               data-message-id="${message.id}" 
               data-emoji="${emoji}">
            <span>${emoji}</span>
            <span class="reaction-count">${count}</span>
          </div>
        `;
      });

      // Add reaction button
      reactionsHTML += `
        <div class="add-reaction" data-message-id="${message.id}">
          <i class='bx bx-plus'></i>
        </div>
      `;

      reactionsHTML += '</div>';
      return reactionsHTML;
    }

    async function toggleReaction(messageId, emoji) {
      if (!currentUser || !currentRoomId) return;

      try {
        const messageRef = db.collection('chatRooms').doc(currentRoomId).collection('messages').doc(messageId);
        const messageDoc = await messageRef.get();
        
        if (!messageDoc.exists) return;

        const messageData = messageDoc.data();
        const reactions = messageData.reactions || {};
        
        if (!reactions[emoji]) {
          reactions[emoji] = { users: {} };
        }

        const userReacted = reactions[emoji].users && reactions[emoji].users[currentUser.uid];
        
        if (userReacted) {
          // Remove reaction
          delete reactions[emoji].users[currentUser.uid];
          if (Object.keys(reactions[emoji].users).length === 0) {
            delete reactions[emoji];
          }
        } else {
          // Add reaction
          reactions[emoji].users[currentUser.uid] = {
            name: currentUser.displayName || 'Anonymous',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };

          // Award XP for giving reaction
          awardXP(currentUser.uid, XP_REWARDS.REACTION_GIVEN, 'Reaction given');
          
          // Award XP to message author for receiving reaction
          if (messageData.authorId && messageData.authorId !== currentUser.uid) {
            awardXP(messageData.authorId, XP_REWARDS.REACTION_RECEIVED, 'Reaction received');
          }
        }

        await messageRef.set({ reactions }, { merge: true });
      } catch (error) {
        console.error('Error toggling reaction:', error);
      }
    }

    function showReactionPicker(messageId, event) {
      event.stopPropagation();
      
      // Remove any existing picker
      const existingPicker = document.querySelector('.reaction-picker');
      if (existingPicker) {
        existingPicker.remove();
      }

      const picker = document.createElement('div');
      picker.className = 'reaction-picker';
      picker.innerHTML = `
        <div class="reaction-picker-header">
          <div class="reaction-picker-title">Add Reaction</div>
          <button onclick="this.closest('.reaction-picker').remove()" style="background: none; border: none; color: var(--theme-muted); cursor: pointer;"></button>
        </div>
        <input type="text" class="reaction-search" placeholder="Search emojis..." id="emojiSearch-${messageId}">
        <div class="reaction-tabs">
          <div class="reaction-tab active" data-category="frequent"></div>
          <div class="reaction-tab" data-category="smileys"></div>
          <div class="reaction-tab" data-category="hearts"></div>
          <div class="reaction-tab" data-category="gestures"></div>
          <div class="reaction-tab" data-category="objects"></div>
        </div>
        <div class="reaction-grid" id="reactionGrid-${messageId}">
          <!-- Emojis will be populated here -->
        </div>
      `;

      // Populate initial emojis (frequent)
      updateReactionGrid(messageId, 'frequent');

      // Add event listeners
      const tabs = picker.querySelectorAll('.reaction-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          updateReactionGrid(messageId, tab.getAttribute('data-category'));
        });
      });

      // Search functionality
      const searchInput = picker.querySelector(`#emojiSearch-${messageId}`);
      let searchTimeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.toLowerCase();
        
        searchTimeout = setTimeout(() => {
          if (query.length > 0) {
            searchEmojis(messageId, query);
          } else {
            updateReactionGrid(messageId, 'frequent');
          }
        }, 200);
      });

      // Add click handler for emojis
      picker.addEventListener('click', (e) => {
        if (e.target.classList.contains('reaction-emoji')) {
          const emoji = e.target.textContent;
          if (emoji && messageId) {
            toggleReaction(messageId, emoji);
            picker.remove();
          }
        }
      });

      // Position and show picker
      event.target.style.position = 'relative';
      event.target.appendChild(picker);

      // Close picker when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closePicker(e) {
          if (!picker.contains(e.target) && !event.target.contains(e.target)) {
            picker.remove();
            document.removeEventListener('click', closePicker);
          }
        });
      }, 100);
    }

    function updateReactionGrid(messageId, category) {
      const grid = document.getElementById(`reactionGrid-${messageId}`);
      if (!grid) return;

      const emojis = reactionCategories[category] || reactionCategories.frequent;
      grid.innerHTML = '';

      emojis.forEach(emoji => {
        const emojiDiv = document.createElement('div');
        emojiDiv.className = 'reaction-emoji';
        emojiDiv.textContent = emoji;
        emojiDiv.title = getEmojiName(emoji);
        grid.appendChild(emojiDiv);
      });
    }

    function searchEmojis(messageId, query) {
      const grid = document.getElementById(`reactionGrid-${messageId}`);
      if (!grid) return;

      const results = window.allEmojis.filter(emojiData => {
        const searchTerm = query.toLowerCase();
        return emojiData.name.toLowerCase().includes(searchTerm) ||
               emojiData.keywords.some(keyword => keyword.toLowerCase().includes(searchTerm));
      }).slice(0, 32); // Limit results

      grid.innerHTML = '';

      if (results.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--theme-muted); padding: 1rem;">No emojis found</div>';
        return;
      }

      results.forEach(emojiData => {
        const emojiDiv = document.createElement('div');
        emojiDiv.className = 'reaction-emoji';
        emojiDiv.textContent = emojiData.emoji;
        emojiDiv.title = emojiData.name;
        grid.appendChild(emojiDiv);
      });
    }

    function getEmojiName(emoji) {
      const emojiData = window.allEmojis.find(e => e.emoji === emoji);
      return emojiData ? emojiData.name : emoji;
    }

    // AFK Detection functionality
    function setupAFKDetection() {
      if (!currentUser || !currentRoomId) return;

      // Track user activity
      lastActivity = Date.now();
      
      // Update activity on any user interaction
      ['keypress', 'click', 'mousemove', 'scroll'].forEach(event => {
        document.addEventListener(event, updateActivity);
      });

      // Start AFK checking interval
      afkCheckInterval = setInterval(checkAFKStatus, 30000); // Check every 30 seconds
      
      // Listen for user presence updates
      setupUserPresenceListener();
    }

    async function ensurePresenceDocument() {
      if (!currentUser || !currentRoomId) return false;
      
      try {
        const presenceRef = db.collection('chatRooms').doc(currentRoomId).collection('presence').doc(currentUser.uid);
        const presenceDoc = await presenceRef.get();
        
        if (!presenceDoc.exists) {
          // Create the presence document if it doesn't exist
          await presenceRef.set({
            userId: currentUser.uid,
            userName: currentUser.displayName || 'Anonymous',
            userPhoto: currentUser.photoURL || '',
            joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
            lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
            isActive: true,
            isAFK: false,
            afkSince: null
          });
        }
        return true;
      } catch (error) {
        console.error('Error ensuring presence document:', error);
        return false;
      }
    }

    function updateActivity() {
      lastActivity = Date.now();
      
      // Update user's last activity in Firebase
      if (currentUser && currentRoomId) {
        // Ensure the presence document exists first, then update
        ensurePresenceDocument().then(success => {
          if (success) {
            db.collection('chatRooms').doc(currentRoomId).collection('presence').doc(currentUser.uid).set({
              lastActivity: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).catch(error => {
              console.error('Error updating activity:', error);
            });
          }
        });
      }
    }

    function checkAFKStatus() {
      if (!currentUser || !currentRoomId) return;

      const now = Date.now();
      const timeSinceActivity = now - lastActivity;
      const isAFK = timeSinceActivity > 5 * 60 * 1000; // 5 minutes

      // Update AFK status in Firebase
      ensurePresenceDocument().then(success => {
        if (success) {
          db.collection('chatRooms').doc(currentRoomId).collection('presence').doc(currentUser.uid).set({
            isAFK: isAFK,
            afkSince: isAFK ? firebase.firestore.FieldValue.serverTimestamp() : null
          }, { merge: true }).catch(error => {
            console.error('Error updating AFK status:', error);
          });
        }
      });
    }

    function setupUserPresenceListener() {
      if (!currentRoomId || userPresenceListener) return;

      userPresenceListener = db.collection('chatRooms').doc(currentRoomId).collection('presence')
        .onSnapshot(snapshot => {
          try {
            activeUsers.clear();
            
            snapshot.forEach(doc => {
              const userData = doc.data();
              if (userData && doc.id) {
                activeUsers.set(doc.id, userData);
              }
            });

            updateUsersList();
            updateUserCount();
          } catch (error) {
            console.error('Error processing user presence updates:', error);
          }
        }, error => {
          console.error('Error listening to user presence:', error);
        });
    }

    function updateUsersList() {
      const usersList = document.getElementById('activeUsersList');
      if (!usersList) return;

      usersList.innerHTML = '';

      activeUsers.forEach((userData, userId) => {
        const userItem = document.createElement('div');
        userItem.className = `user-item ${userData.isAFK ? 'afk' : ''}`;
        
        const afkIndicator = userData.isAFK ? '<span class="afk-indicator">AFK</span>' : '';
        
        userItem.innerHTML = `
          <div class="user-status ${userData.isAFK ? 'afk' : ''}"></div>
          <img src="${userData.userPhoto || 'https://via.placeholder.com/20'}" alt="Avatar" class="w-4 h-4 rounded-full">
          <span class="flex-1">${sanitizeText(userData.userName || 'Unknown')}</span>
          ${afkIndicator}
        `;
        
        usersList.appendChild(userItem);
      });
    }

    function updateUserCount() {
      const userCountEl = document.getElementById('userCount');
      if (userCountEl) {
        const activeCount = Array.from(activeUsers.values()).filter(user => !user.isAFK).length;
        const totalCount = activeUsers.size;
        userCountEl.textContent = `${activeCount}/${totalCount} users`;
      }
    }

    function toggleUserList() {
      const userListContainer = document.getElementById('userListContainer');
      userListContainer.classList.toggle('hidden');
    }

    function getUserAFKIndicator(userId) {
      if (!activeUsers.has(userId)) return '';
      const userData = activeUsers.get(userId);
      return userData.isAFK ? '<span class="afk-indicator">AFK</span>' : '';
    }

    // XP System Functions
    function calculateLevel(xp) {
      for (let i = LEVEL_THRESHOLDS.length - 1; i >= 0; i--) {
        if (xp >= LEVEL_THRESHOLDS[i].xp) {
          return LEVEL_THRESHOLDS[i];
        }
      }
      return LEVEL_THRESHOLDS[0];
    }

    function getNextLevel(currentLevel) {
      const nextLevelIndex = LEVEL_THRESHOLDS.findIndex(l => l.level === currentLevel + 1);
      return nextLevelIndex !== -1 ? LEVEL_THRESHOLDS[nextLevelIndex] : null;
    }

    async function awardXP(userId, amount, reason, element = null) {
      if (!userId || amount <= 0) return;

      try {
        const userRef = db.collection('users').doc(userId);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
          // Initialize user with starting XP
          await userRef.set({
            xp: amount,
            level: 1,
            levelTitle: 'Novice',
            levelTier: 'novice',
            lastXPGain: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          if (element) {
            showXPReward(element, amount, reason);
          }
          return;
        }
        
        const userData = userDoc.data();
        const currentXP = userData.xp || 0;
        const currentLevel = calculateLevel(currentXP);
        const newXP = currentXP + amount;
        const newLevel = calculateLevel(newXP);
        
        // Update user XP using set with merge to handle non-existent documents
        await userRef.set({
          xp: newXP,
          level: newLevel.level,
          levelTitle: newLevel.title,
          levelTier: newLevel.tier,
          lastXPGain: firebase.firestore.FieldValue.serverTimestamp(),
          // Preserve other user data
          displayName: userData.displayName || currentUser.displayName || 'Anonymous',
          email: userData.email || currentUser.email || '',
          photoURL: userData.photoURL || currentUser.photoURL || '',
          joinDate: userData.joinDate || firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // Show XP reward popup
        if (element && userId === currentUser.uid) {
          showXPReward(element, amount, reason);
        }

        // Check for level up
        if (newLevel.level > currentLevel.level && userId === currentUser.uid) {
          // Award level up bonus
          const bonusXP = newXP + XP_REWARDS.LEVEL_UP_BONUS;
          await userRef.set({
            xp: bonusXP,
            level: newLevel.level,
            levelTitle: newLevel.title,
            levelTier: newLevel.tier,
            lastXPGain: firebase.firestore.FieldValue.serverTimestamp(),
            displayName: userData.displayName || currentUser.displayName || 'Anonymous',
            email: userData.email || currentUser.email || '',
            photoURL: userData.photoURL || currentUser.photoURL || '',
            joinDate: userData.joinDate || firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          
          showLevelUpNotification(newLevel);
          updateXPWidget();
        } else if (userId === currentUser.uid) {
          updateXPWidget();
        }
      } catch (error) {
        console.error('Error awarding XP:', error);
      }
    }

    function showXPReward(element, amount, reason) {
      if (!element) return;
      
      const rect = element.getBoundingClientRect();
      const popup = document.createElement('div');
      popup.className = 'xp-reward-popup';
      popup.innerHTML = `
        <div style="display: flex; align-items: center; gap: 4px;">
          <i class='bx bx-plus-circle'></i>
          <span>+${amount} XP</span>
        </div>
        <div style="font-size: 0.7rem; opacity: 0.9;">${reason}</div>
      `;
      
      popup.style.position = 'fixed';
      popup.style.left = (rect.left + rect.width / 2) + 'px';
      popup.style.top = (rect.top - 10) + 'px';
      popup.style.transform = 'translateX(-50%)';
      
      document.body.appendChild(popup);
      
      setTimeout(() => {
        popup.remove();
      }, 1500);
    }

    function showLevelUpNotification(levelData) {
      const notification = document.getElementById('levelUpNotification');
      const levelNumber = document.getElementById('newLevelNumber');
      const levelTitle = document.getElementById('levelTitleText');
      const xpReward = document.getElementById('xpRewardAmount');
      
      levelNumber.textContent = levelData.level;
      levelTitle.textContent = levelData.title;
      xpReward.textContent = XP_REWARDS.LEVEL_UP_BONUS;
      
      notification.classList.add('show');
      
      // Auto-hide after 4 seconds
      setTimeout(() => {
        notification.classList.remove('show');
      }, 4000);
    }

    function formatXPProgress(currentXP, currentLevel) {
      const nextLevel = getNextLevel(currentLevel.level);
      if (!nextLevel) {
        return { percentage: 100, current: currentXP, needed: 0, total: currentXP };
      }
      
      const currentLevelXP = currentLevel.xp;
      const nextLevelXP = nextLevel.xp;
      const progressXP = currentXP - currentLevelXP;
      const neededXP = nextLevelXP - currentLevelXP;
      const percentage = Math.round((progressXP / neededXP) * 100);
      
      return {
        percentage: Math.min(100, Math.max(0, percentage)),
        current: progressXP,
        needed: neededXP,
        total: nextLevelXP
      };
    }

    async function updateXPWidget() {
      if (!currentUser) return;
      
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data() || {};
        const currentXP = userData.xp || 0;
        const levelData = calculateLevel(currentXP);
        const progress = formatXPProgress(currentXP, levelData);
        
        // Update XP widget elements
        const userLevel = document.getElementById('userLevel');
        const userLevelTitle = document.getElementById('userLevelTitle');
        const userXPBar = document.getElementById('userXPBar');
        const userXPText = document.getElementById('userXPText');
        
        if (userLevel) userLevel.textContent = `Lv.${levelData.level}`;
        if (userLevelTitle) userLevelTitle.textContent = levelData.title;
        if (userXPBar) userXPBar.style.width = `${progress.percentage}%`;
        if (userXPText) userXPText.textContent = `${progress.current} / ${progress.needed} XP`;
        
      } catch (error) {
        console.error('Error updating XP widget:', error);
      }
    }

    function getLevelBadgeHTML(levelData) {
      const isPrestige = levelData.level >= 15;
      return `<span class="level-badge ${isPrestige ? 'prestige' : ''}" title="${levelData.title}">
        <i class='bx bx-trophy'></i>
        Lv.${levelData.level}
      </span>`;
    }

    // Room Color Customization Functions
    async function openColorPicker() {
      if (!currentUser || !currentRoomId) return;

      // Update current user XP and level
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data() || {};
        currentUserXP = userData.xp || 0;
        const levelData = calculateLevel(currentUserXP);
        currentUserLevel = levelData.level;
      } catch (error) {
        console.error('Error fetching user data:', error);
      }

      // Get current room color
      try {
        const roomDoc = await db.collection('chatRooms').doc(currentRoomId).get();
        const roomData = roomDoc.data() || {};
        selectedColor = roomData.customColor || null;
      } catch (error) {
        console.error('Error fetching room color:', error);
      }

      // Populate color picker
      populateColorPicker();
      
      // Show modal
      document.getElementById('colorPickerModal').classList.add('show');
    }

    function closeColorPicker() {
      document.getElementById('colorPickerModal').classList.remove('show');
      selectedColor = null;
    }

    function populateColorPicker() {
      // Populate default colors
      const defaultGrid = document.getElementById('defaultColors');
      defaultGrid.innerHTML = '';
      
      DEFAULT_COLORS.forEach((colorData, index) => {
        const colorDiv = createColorOption(colorData.color, colorData.name, true);
        if (selectedColor === colorData.color) {
          colorDiv.classList.add('selected');
        }
        defaultGrid.appendChild(colorDiv);
      });

      // Populate XP unlocked colors
      const xpGrid = document.getElementById('xpColors');
      xpGrid.innerHTML = '';
      
      XP_UNLOCKED_COLORS.forEach((colorData, index) => {
        const isUnlocked = currentUserXP >= colorData.requiredXP;
        const colorDiv = createColorOption(colorData.color, colorData.name, isUnlocked, colorData);
        if (selectedColor === colorData.color) {
          colorDiv.classList.add('selected');
        }
        if (!isUnlocked) {
          colorDiv.classList.add('locked');
        }
        xpGrid.appendChild(colorDiv);
      });

      // Setup custom color picker
      const customRequirement = document.getElementById('customColorRequirement');
      const customPicker = document.getElementById('customColorPicker');
      const colorPreview = document.getElementById('colorPreview');
      
      const canUseCustom = currentUserLevel >= 10; // Platinum level
      if (canUseCustom) {
        customRequirement.classList.add('unlocked');
        customRequirement.innerHTML = '<i class="bx bx-check"></i><span>Custom colors unlocked!</span>';
        customPicker.disabled = false;
        
        customPicker.addEventListener('input', (e) => {
          const color = e.target.value;
          selectedColor = color;
          colorPreview.style.background = color;
          colorPreview.textContent = 'Custom Color Selected';
          
          // Clear other selections
          document.querySelectorAll('.color-option.selected').forEach(el => {
            el.classList.remove('selected');
          });
        });
      } else {
        customRequirement.classList.remove('unlocked');
        customRequirement.innerHTML = '<i class="bx bx-lock"></i><span>Unlock at Level 10 (Platinum)</span>';
        customPicker.disabled = true;
      }
    }

    function createColorOption(color, name, unlocked, colorData = null) {
      const colorDiv = document.createElement('div');
      colorDiv.className = 'color-option';
      
      // Handle gradient colors
      if (color.includes('gradient')) {
        colorDiv.style.background = color;
      } else {
        colorDiv.style.backgroundColor = color;
      }
      
      // Add label
      const label = document.createElement('div');
      label.className = 'color-option-label';
      if (colorData && !unlocked) {
        label.textContent = `${name} (Lv.${colorData.requiredLevel})`;
      } else {
        label.textContent = name;
      }
      colorDiv.appendChild(label);
      
      if (unlocked) {
        colorDiv.addEventListener('click', () => {
          // Clear previous selections
          document.querySelectorAll('.color-option.selected').forEach(el => {
            el.classList.remove('selected');
          });
          
          // Select this color
          colorDiv.classList.add('selected');
          selectedColor = color;
          
          // Update custom color preview if needed
          const colorPreview = document.getElementById('colorPreview');
          colorPreview.style.background = color;
          colorPreview.textContent = 'Selected: ' + name;
        });
      } else {
        colorDiv.addEventListener('click', () => {
          if (colorData) {
            showNotification('Level Required', `This color requires Level ${colorData.requiredLevel} (${colorData.requiredXP} XP). You are currently Level ${currentUserLevel} (${currentUserXP} XP).`, 'warning');
          }
        });
      }
      
      return colorDiv;
    }

    async function applyRoomColor() {
      if (!selectedColor || !currentRoomId || !currentUser) {
        showNotification('Color Required', 'Please select a color and make sure you are in a room.', 'warning');
        return;
      }

      try {
        console.log("Updating Firestore with color:", selectedColor);
        
        // Update room with custom color using set with merge
        await db.collection('chatRooms').doc(currentRoomId).set({
          customColor: selectedColor,
          lastColorUpdate: firebase.firestore.FieldValue.serverTimestamp(),
          colorUpdatedBy: currentUser.uid
        }, { merge: true });

        console.log("Successfully updated room color in Firestore");

        // Apply the color to UI immediately
        applyRoomTheme(selectedColor);
        
        // Close modal
        closeColorPicker();
        
        // Show success message
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
          showXPReward(chatMessages, 0, 'Room color updated!');
        }
        

        
      } catch (error) {
        console.error('Error applying room color:', error);
        console.error('Error details:', error.code, error.message);
        showNotification('Color Update Failed', `Failed to update room color: ${error.message || error.code || 'Unknown error'}`, 'error');
      }
    }

    function applyRoomTheme(color) {
      if (!color) {
        console.log("No color provided to applyRoomTheme");
        return;
      }



      // Convert hex to RGB for CSS variables with improved gradient handling
      let rgbColor = '';
      let actualColor = color;
      
      if (color.includes('gradient')) {
        // Extract all hex colors from gradient
        const hexMatches = color.match(/#[0-9a-fA-F]{6}/g);
        if (hexMatches && hexMatches.length > 0) {
          // Use the first color for RGB calculations
          const hex = hexMatches[0];
          const r = parseInt(hex.slice(1, 3), 16);
          const g = parseInt(hex.slice(3, 5), 16);
          const b = parseInt(hex.slice(5, 7), 16);
          rgbColor = `${r}, ${g}, ${b}`;
          actualColor = hex; // Use solid color for elements that need it
        }
      } else if (color.startsWith('#')) {
        const r = parseInt(color.slice(1, 3), 16);
        const g = parseInt(color.slice(3, 5), 16);
        const b = parseInt(color.slice(5, 7), 16);
        rgbColor = `${r}, ${g}, ${b}`;
        actualColor = color;
      }
      
      // Fallback if no valid color found
      if (!rgbColor) {
        rgbColor = '156, 207, 216'; // Default foam color
        actualColor = '#9ccfd8';
      }
      
      // Set CSS custom properties
      document.documentElement.style.setProperty('--room-color', actualColor);
      document.documentElement.style.setProperty('--room-color-gradient', color);
      document.documentElement.style.setProperty('--room-color-rgb', rgbColor);
      
      // Mark if we have a gradient
      const hasGradient = color.includes('gradient');
      document.body.setAttribute('data-has-gradient', hasGradient.toString());
      
      console.log("Set CSS variables:", { 
        roomColor: document.documentElement.style.getPropertyValue('--room-color'),
        rgbColor: document.documentElement.style.getPropertyValue('--room-color-rgb')
      });
      
      // Apply theme to entire page
      const body = document.body;
      const container = document.querySelector('.container');
      const sidebar = document.querySelector('.sidebar');
      const chatMain = document.querySelector('.chat-main');
      const chatHeader = document.querySelector('.chat-header');
      const chatInputArea = document.querySelector('.chat-input-area');
      const xpWidget = document.querySelector('.xp-widget');
      const userList = document.querySelector('.user-list');
      
      // Add custom-theme class to all major elements
      if (body) body.classList.add('custom-theme');
      if (container) container.classList.add('custom-theme');
      if (sidebar) sidebar.classList.add('custom-theme');
      if (chatMain) chatMain.classList.add('custom-theme');
      if (chatHeader) chatHeader.classList.add('custom-theme');
      if (chatInputArea) chatInputArea.classList.add('custom-theme');
      if (xpWidget) xpWidget.classList.add('custom-theme');
      if (userList) userList.classList.add('custom-theme');
      
      // Apply to all messages
      const messages = document.querySelectorAll('.message');
      messages.forEach(message => {
        message.classList.add('custom-theme');
      });
      
      // Apply to all room items, but highlight the current one
      const roomItems = document.querySelectorAll('.room-item');
      roomItems.forEach(item => {
        item.classList.add('custom-theme');
      });
      
      // Apply to all buttons
      const primaryButtons = document.querySelectorAll('.btn-primary');
      const secondaryButtons = document.querySelectorAll('.btn-secondary');
      primaryButtons.forEach(btn => btn.classList.add('custom-theme'));
      secondaryButtons.forEach(btn => btn.classList.add('custom-theme'));
      
      // Apply to XP bar
      const xpBar = document.querySelector('.xp-bar');
      if (xpBar) xpBar.classList.add('custom-theme');

      console.log("Applied full-page theme to all elements");
    }

    function removeRoomTheme() {
      console.log("Removing full-page room theme");
      
      // Remove custom-theme class from all elements
      const elements = document.querySelectorAll('.custom-theme');
      elements.forEach(el => el.classList.remove('custom-theme'));
      
      // Remove CSS custom properties
      document.documentElement.style.removeProperty('--room-color');
      document.documentElement.style.removeProperty('--room-color-rgb');
      
      console.log("Removed theme from all page elements");
    }

    async function loadRoomTheme(roomId) {
      if (!roomId) return;

      try {
        const roomDoc = await db.collection('chatRooms').doc(roomId).get();
        const roomData = roomDoc.data() || {};
        
        if (roomData.customColor) {
          applyRoomTheme(roomData.customColor);
        } else {
          removeRoomTheme();
        }
      } catch (error) {
        console.error('Error loading room theme:', error);
      }
    }



    // Room Creation - Main implementation
    function mainShowCreateRoomModal() {
      if (!currentUser) {
        showNotification('Sign In Required', 'Please sign in to create chat rooms.', 'warning');
        return;
      }
      
      document.getElementById('createRoomModal').classList.add('show');
    }

    function mainHideCreateRoomModal() {
      document.getElementById('createRoomModal').classList.remove('show');
      document.getElementById('createRoomForm').reset();
      clearRoomNameError();
    }
    
    // Expose modal functions to global scope immediately  
    window.mainShowCreateRoomModal = mainShowCreateRoomModal;
    window.mainHideCreateRoomModal = mainHideCreateRoomModal;

    function clearRoomNameError() {
      document.getElementById('roomNameError').classList.add('hidden');
      document.getElementById('roomName').classList.remove('input-error');
    }

    // Reply functionality
    function startReply(messageId, authorName, content) {
      if (!currentUser) return;
      
      replyingTo = {
        id: messageId,
        authorName: authorName,
        content: content
      };
      
      // Show reply preview
      const replyPreview = document.getElementById('replyPreview');
      const replyPreviewContent = document.getElementById('replyPreviewContent');
      
      replyPreviewContent.innerHTML = `
        <div class="font-semibold text-rp-foam">${sanitizeText(authorName)}</div>
        <div class="text-rp-text">${sanitizeHTML(content.length > 100 ? content.substring(0, 100) + '...' : content)}</div>
      `;
      
      replyPreview.classList.remove('hidden');
      
      // Focus on message input
      const messageInput = document.getElementById('messageInput');
      messageInput.focus();
      messageInput.placeholder = `Reply to ${authorName}...`;
    }

    function cancelReply() {
      replyingTo = null;
      
      // Hide reply preview
      const replyPreview = document.getElementById('replyPreview');
      replyPreview.classList.add('hidden');
      
      // Reset message input placeholder
      const messageInput = document.getElementById('messageInput');
      messageInput.placeholder = 'Type your message...';
    }

    // Profile viewing functions
    async function showUserProfile(userId, userName, userPhoto) {
      if (!userId || userId === 'ai-assistant') {
        return; // Don't show profile for AI
      }

      const modal = document.getElementById('profileModal');
      const avatar = document.getElementById('profileModalAvatar');
      const name = document.getElementById('profileModalName');
      const status = document.getElementById('profileModalStatus');
      const bio = document.getElementById('profileModalBio');
      const joined = document.getElementById('profileModalJoined');
      const xpElement = document.getElementById('profileModalXP');
      const levelElement = document.getElementById('profileModalLevel');
      const messagesElement = document.getElementById('profileModalMessages');
      const followersElement = document.getElementById('profileModalFollowers');
      const followButton = document.getElementById('followButton');
      const followButtonText = document.getElementById('followButtonText');
      const viewFullBtn = document.getElementById('viewFullProfileBtn');

      // Set basic info
      avatar.src = userPhoto || 'https://via.placeholder.com/80';
      name.textContent = userName || 'Unknown User';
      status.textContent = 'Loading...';
      bio.textContent = 'Loading...';
      joined.textContent = 'Loading...';
      xpElement.textContent = '0';
      levelElement.textContent = '1';
      messagesElement.textContent = '0';
      followersElement.textContent = '0';

      // Hide follow button initially
      followButton.style.display = 'none';

      // Apply room theme to modal if active
      if (document.body.classList.contains('custom-theme')) {
        modal.classList.add('custom-theme');
      } else {
        modal.classList.remove('custom-theme');
      }

      // Show modal
      modal.classList.remove('hidden');

      try {
        // Fetch user profile data
        const userDoc = await db.collection('users').doc(userId).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          
          // Update modal with user data
          status.textContent = userData.status || 'Online';
          bio.textContent = userData.bio || 'No bio available';
          xpElement.textContent = userData.totalXP || 0;
          levelElement.textContent = userData.level || 1;
          messagesElement.textContent = userData.messageCount || 0;
          
          // Get follower count
          try {
            const followersSnapshot = await db.collection('users').doc(userId).collection('followers').get();
            followersElement.textContent = followersSnapshot.size;
          } catch (error) {
            console.log('Could not load followers count:', error);
            followersElement.textContent = '0';
          }
          
          if (userData.createdAt) {
            const joinDate = userData.createdAt.toDate ? userData.createdAt.toDate() : new Date(userData.createdAt);
            joined.textContent = joinDate.toLocaleDateString();
          } else {
            joined.textContent = 'Unknown';
          }
          
          // Show follow button if not viewing own profile
          if (currentUser && userId !== currentUser.uid) {
            followButton.style.display = 'block';
            await updateFollowButtonState(userId);
          }
          
          // Set up view full profile button
          viewFullBtn.onclick = () => {
            window.open(`/profile.html?uid=${userId}`, '_blank');
          };
        } else {
          status.textContent = 'User not found';
          bio.textContent = 'No profile data available';
          joined.textContent = 'Unknown';
          viewFullBtn.style.display = 'none';
        }
      } catch (error) {
        console.error('Error fetching user profile:', error);
        status.textContent = 'Error loading profile';
        bio.textContent = 'Could not load profile data';
        joined.textContent = 'Unknown';
      }
    }

    async function updateFollowButtonState(targetUserId) {
      if (!currentUser) return;

      const followButton = document.getElementById('followButton');
      const followButtonText = document.getElementById('followButtonText');
      const followButtonIcon = followButton.querySelector('i');

      try {
        // Check if currently following
        const followDoc = await db.collection('users').doc(currentUser.uid).collection('following').doc(targetUserId).get();
        const isFollowing = followDoc.exists;

        if (isFollowing) {
          followButton.classList.add('following');
          followButtonIcon.className = 'bx bx-user-check';
          followButtonText.textContent = 'Following';
        } else {
          followButton.classList.remove('following');
          followButtonIcon.className = 'bx bx-user-plus';
          followButtonText.textContent = 'Follow';
        }

        // Set up click handler
        followButton.onclick = () => toggleFollow(targetUserId);

      } catch (error) {
        console.error('Error checking follow status:', error);
      }
    }

    async function toggleFollow(targetUserId) {
      if (!currentUser) return;

      const followButton = document.getElementById('followButton');
      const followButtonText = document.getElementById('followButtonText');
      const followButtonIcon = followButton.querySelector('i');
      const followersElement = document.getElementById('profileModalFollowers');

      try {
        const followDoc = await db.collection('users').doc(currentUser.uid).collection('following').doc(targetUserId).get();
        const isFollowing = followDoc.exists;

        if (isFollowing) {
          // Unfollow
          await db.collection('users').doc(currentUser.uid).collection('following').doc(targetUserId).delete();
          await db.collection('users').doc(targetUserId).collection('followers').doc(currentUser.uid).delete();
          
          followButton.classList.remove('following');
          followButtonIcon.className = 'bx bx-user-plus';
          followButtonText.textContent = 'Follow';
          
          // Update follower count
          const currentCount = parseInt(followersElement.textContent) || 0;
          followersElement.textContent = Math.max(0, currentCount - 1);
          
        } else {
          // Follow
          await db.collection('users').doc(currentUser.uid).collection('following').doc(targetUserId).set({
            followedAt: firebase.firestore.FieldValue.serverTimestamp(),
            displayName: document.getElementById('profileModalName').textContent,
            photoURL: document.getElementById('profileModalAvatar').src
          });
          
          await db.collection('users').doc(targetUserId).collection('followers').doc(currentUser.uid).set({
            followedAt: firebase.firestore.FieldValue.serverTimestamp(),
            displayName: currentUser.displayName,
            photoURL: currentUser.photoURL
          });
          
          followButton.classList.add('following');
          followButtonIcon.className = 'bx bx-user-check';
          followButtonText.textContent = 'Following';
          
          // Update follower count
          const currentCount = parseInt(followersElement.textContent) || 0;
          followersElement.textContent = currentCount + 1;
        }

      } catch (error) {
        console.error('Error toggling follow:', error);
        showNotification('Follow Failed', 'Failed to update follow status. Please try again.', 'error');
      }
    }

    function closeProfileModal() {
      const modal = document.getElementById('profileModal');
      modal.classList.add('hidden');
    }

    // Secure event handling
    function setupSecureEventListeners() {
      // Reply button event delegation
      document.addEventListener('click', (e) => {
        if (e.target.closest('.reply-button')) {
          const button = e.target.closest('.reply-button');
          const messageId = button.getAttribute('data-message-id');
          const authorName = button.getAttribute('data-author-name');
          const content = button.getAttribute('data-content');
          
          if (messageId && authorName && content) {
            startReply(messageId, authorName, content);
          }
        }
      });

      // Message delete button event delegation
      document.addEventListener('click', (e) => {
        if (e.target.closest('.message-delete-btn')) {
          const button = e.target.closest('.message-delete-btn');
          const messageId = button.getAttribute('data-message-id');
          const content = button.getAttribute('data-content');
          
          if (messageId && content) {
            deleteMessage(messageId, content);
          }
        }
      });

      // Close mention dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('mentionDropdown');
        const messageInput = document.getElementById('messageInput');
        
        if (mentionDropdownVisible && 
            !dropdown.contains(e.target) && 
            !messageInput.contains(e.target)) {
          hideMentionDropdown();
        }
      });



      // Profile viewing event delegation
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('clickable-avatar')) {
          const userId = e.target.getAttribute('data-user-id');
          const userName = e.target.getAttribute('data-user-name');
          const userPhoto = e.target.getAttribute('data-user-photo');
          
          if (userId) {
            showUserProfile(userId, userName, userPhoto);
          }
        }
      });

      // Close profile modal when clicking outside
      document.addEventListener('click', (e) => {
        const modal = document.getElementById('profileModal');
        if (e.target === modal) {
          closeProfileModal();
        }
      });

      // Reaction click handlers
      document.addEventListener('click', (e) => {
        if (e.target.closest('.reaction')) {
          const reaction = e.target.closest('.reaction');
          const messageId = reaction.getAttribute('data-message-id');
          const emoji = reaction.getAttribute('data-emoji');
          
          if (messageId && emoji) {
            toggleReaction(messageId, emoji);
          }
        }
      });

      // Add reaction button handlers
      document.addEventListener('click', (e) => {
        if (e.target.closest('.add-reaction')) {
          const button = e.target.closest('.add-reaction');
          const messageId = button.getAttribute('data-message-id');
          
          if (messageId) {
            showReactionPicker(messageId, e);
          }
        }
      });

      // Artwork image click handlers
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('artwork-image')) {
          const title = e.target.getAttribute('data-artwork-title') || 'Untitled';
          const imageData = e.target.getAttribute('data-artwork-image');
          const authorName = e.target.getAttribute('data-artwork-author');
          
          if (imageData) {
            showArtworkModal({
              title: title,
              imageData: imageData,
              authorName: authorName
            });
          }
        }
      });

      // Sidebar tab click handlers
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('sidebar-tab')) {
          const tabName = e.target.getAttribute('data-tab');
          if (tabName) {
            switchSidebarTab(tabName);
          }
        }
      });

      // Art deletion button handlers
      document.addEventListener('click', (e) => {
        if (e.target.closest('.art-delete-btn')) {
          e.stopPropagation();
          const button = e.target.closest('.art-delete-btn');
          const artworkId = button.getAttribute('data-artwork-id');
          const artPiece = button.closest('.art-piece, .art-piece-small');
          
          if (artworkId && artPiece && artPiece.artworkData) {
            deleteArtwork(artworkId, artPiece.artworkData);
          }
        }
      });

      // Leaderboard tab click handlers
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('leaderboard-tab')) {
          const boardType = e.target.getAttribute('data-board');
          if (boardType) {
            switchLeaderboard(boardType);
          }
        }
      });

      // User search input handler
      const searchInput = document.getElementById('userSearchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          
          // Clear previous timeout
          if (searchTimeout) {
            clearTimeout(searchTimeout);
          }
          
          // Debounce search
          searchTimeout = setTimeout(() => {
            searchUsers(query);
          }, 300);
        });

        // Clear search on escape
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            e.target.value = '';
            searchUsers('');
          }
        });
      }

      // Leaderboard follow button handlers
      document.addEventListener('click', async (e) => {
        if (e.target.closest('.leaderboard-follow-btn')) {
          e.stopPropagation();
          const button = e.target.closest('.leaderboard-follow-btn');
          const userId = button.getAttribute('data-user-id');
          const userName = button.getAttribute('data-user-name');
          const userPhoto = button.getAttribute('data-user-photo');
          
          if (userId && currentUser) {
            await toggleLeaderboardFollow(button, userId, userName, userPhoto);
          }
        }
      });
    }

    async function createRoom(event) {
      event.preventDefault();
      
      if (!currentUser) return;

      const roomName = sanitizeText(document.getElementById('roomName').value);
      const roomDescription = sanitizeText(document.getElementById('roomDescription').value);
      const roomDuration = parseInt(document.getElementById('roomDuration').value);

      // Validate room name
      if (!contentFilter.isAppropriate(roomName)) {
        console.log('Room name rejected:', roomName, 'Filtered:', contentFilter.filter(roomName));
        document.getElementById('roomNameError').classList.remove('hidden');
        document.getElementById('roomName').classList.add('input-error');
        return;
      }

      try {
        const expiresAt = new Date(Date.now() + roomDuration);
        
        const roomRef = await db.collection('chatRooms').add({
          name: roomName,
          description: roomDescription,
          type: 'temporary',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser.uid,
          creatorName: currentUser.displayName || 'Anonymous',
          expiresAt: firebase.firestore.Timestamp.fromDate(expiresAt),
          userCount: 0,
          lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Add creation message
        await roomRef.collection('messages').add({
          content: `Room "${roomName}" created by ${currentUser.displayName || 'Anonymous'}`,
          type: 'system',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        hideCreateRoomModal();
        joinRoom(roomRef.id);
      } catch (error) {
        console.error('Error creating room:', error);
        showNotification('Room Creation Failed', 'Failed to create room. Please try again.', 'error');
      }
    }

    // Cleanup Functions
    async function cleanupExpiredRooms() {
      if (!firebaseInitialized) return;

      try {
        const now = new Date();
        const expiredRooms = await db.collection('chatRooms')
          .where('type', '==', 'temporary')
          .where('expiresAt', '<', firebase.firestore.Timestamp.fromDate(now))
          .get();

        const batch = db.batch();
        
        for (const doc of expiredRooms.docs) {
          await cleanupRoomCompletely(doc.ref, batch);
        }

        if (!expiredRooms.empty) {
          await batch.commit();
          console.log(`Cleaned up ${expiredRooms.size} expired rooms`);
        }
      } catch (error) {
        console.error('Error cleaning up expired rooms:', error);
      }
    }

    async function cleanupRoomCompletely(roomRef, batch = null) {
      const shouldCommit = !batch;
      if (!batch) batch = db.batch();

      try {
        // Delete messages subcollection in smaller batches
        const messages = await roomRef.collection('messages').orderBy('timestamp', 'desc').limit(100).get();
        messages.docs.forEach(messageDoc => {
          batch.delete(messageDoc.ref);
        });

        // Delete presence subcollection
        const presence = await roomRef.collection('presence').get();
        presence.docs.forEach(presenceDoc => {
          batch.delete(presenceDoc.ref);
        });

        // Delete room document
        batch.delete(roomRef);

        if (shouldCommit) {
          await batch.commit();
        }

        // If there were 100 messages, there might be more
        if (messages.size === 100) {
          setTimeout(() => cleanupRoomCompletely(roomRef), 1000);
        }
      } catch (error) {
        console.error('Error cleaning up room completely:', error);
      }
    }

    async function cleanupOldMessages(roomId) {
      if (!firebaseInitialized) return;

      try {
        // Get messages older than 24 hours, keeping only the most recent 50
        const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        const oldMessages = await db.collection('chatRooms').doc(roomId).collection('messages')
          .where('timestamp', '<', firebase.firestore.Timestamp.fromDate(oneDayAgo))
          .orderBy('timestamp', 'asc')
          .limit(20) // Delete in small batches
          .get();

        if (!oldMessages.empty) {
          const batch = db.batch();
          oldMessages.docs.forEach(doc => {
            batch.delete(doc.ref);
          });
          
          await batch.commit();
          console.log(`Cleaned up ${oldMessages.size} old messages from room ${roomId}`);
        }
      } catch (error) {
        console.error('Error cleaning up old messages:', error);
      }
    }

    async function cleanupInactiveRooms() {
      if (!firebaseInitialized) return;

      try {
        // Clean up temporary rooms with no activity for 2 hours
        const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000);
        const inactiveRooms = await db.collection('chatRooms')
          .where('type', '==', 'temporary')
          .where('lastActivity', '<', firebase.firestore.Timestamp.fromDate(twoHoursAgo))
          .where('userCount', '==', 0)
          .get();

        const batch = db.batch();
        for (const doc of inactiveRooms.docs) {
          await cleanupRoomCompletely(doc.ref, batch);
        }

        if (!inactiveRooms.empty) {
          await batch.commit();
          console.log(`Cleaned up ${inactiveRooms.size} inactive rooms`);
        }
      } catch (error) {
        console.error('Error cleaning up inactive rooms:', error);
      }
    }

    // User Interface Management
    function updateUserSection() {
      const userSection = document.getElementById('userSection');
      const signInBtn = document.getElementById('signInBtn');
      const createRoomBtn = document.getElementById('createRoomBtn');
      const roomManagement = document.getElementById('roomManagement');
      const guestMessage = document.getElementById('guestMessage');
      const messageForm = document.getElementById('messageForm');

      if (currentUser) {
        userSection.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${currentUser.photoURL || 'https://via.placeholder.com/32'}" alt="Profile" class="w-8 h-8 rounded-full">
            <span class="text-rp-text font-medium hidden md:block">${sanitizeText(currentUser.displayName || 'User')}</span>
            <button onclick="signOut()" class="btn-secondary">
              <i class='bx bx-log-out'></i>
            </button>
          </div>
        `;
        
        createRoomBtn.classList.remove('hidden');
        roomManagement.classList.remove('hidden');
        guestMessage.style.display = 'none';
        
        if (currentRoomId) {
          messageForm.classList.remove('hidden');
        }
      } else {
        userSection.innerHTML = `
          <button onclick="googleSignIn()" class="btn-primary">
            <i class='bx bxl-google mr-2'></i>
            Sign In
          </button>
        `;
        
        createRoomBtn.classList.add('hidden');
        roomManagement.classList.add('hidden');
        messageForm.classList.add('hidden');
        guestMessage.style.display = 'block';
      }
    }

    // Auth State Management
    function startAuthMonitoring() {
      if (!firebaseInitialized) {
        setTimeout(startAuthMonitoring, 100);
        return;
      }

      auth.onAuthStateChanged(async (user) => {
        console.log('Auth state changed:', user ? `Signed in as ${user.email}` : 'Signed out');
        
        if (user) {
          currentUser = user;
          
          // Handle redirect result
          try {
            const result = await auth.getRedirectResult();
            if (result && result.user) {
              console.log('Redirect sign-in successful');
            }
          } catch (error) {
            console.error('Redirect result error:', error);
          }

          // Setup notification listener for mentions
          setupNotificationListener();

          // Load users for mention autocomplete
          loadMentionUsers();
        } else {
          await leaveCurrentRoom();
          currentUser = null;
        }

        updateUserSection();
      });
    }

    // Initialize Chat System
    function initializeChatSystem() {
      // Start automatic cleanup every 30 minutes for expired rooms
      cleanupInterval = setInterval(() => {
        cleanupExpiredRooms();
        cleanupInactiveRooms();
        fixUserCounts(); // Also fix user counts during cleanup
      }, 30 * 60 * 1000);
      
      // Start message cleanup every 2 hours
      messageCleanupInterval = setInterval(() => {
        if (currentRoomId) {
          cleanupOldMessages(currentRoomId);
        }
      }, 2 * 60 * 60 * 1000);
      
      // Load rooms
      loadRooms();
      
      // Initialize UI
      updateUserSection();
      
      // Start auth monitoring
      startAuthMonitoring();

      // Initial cleanup on startup
      setTimeout(() => {
        cleanupExpiredRooms();
        cleanupInactiveRooms();
        fixUserCounts(); // Fix any negative user counts
      }, 5000);

      // Handle page unload
      window.addEventListener('beforeunload', () => {
        leaveCurrentRoom();
        if (cleanupInterval) {
          clearInterval(cleanupInterval);
        }
        if (messageCleanupInterval) {
          clearInterval(messageCleanupInterval);
        }
      });

      console.log('Chat system initialized with enhanced cleanup');
    }

    // Wait for Firebase and initialize
    async function waitForFirebaseAndStartChat() {
      console.log(' Starting Firebase initialization process...');
      updateLoadingStatus('Loading Firebase SDK...');
      
      // First ensure Firebase is loaded and initialized
      if (typeof firebase === 'undefined') {
        console.log(' Firebase SDK not loaded yet, waiting...');
        setTimeout(waitForFirebaseAndStartChat, 100);
        return;
      }
      
      console.log(' Firebase SDK loaded, connecting...');
      updateLoadingStatus('Connecting to Firebase...');
      
      // Initialize Firebase if not already done
      if (!firebaseInitialized) {
        console.log(' Initializing Firebase...');
        try {
          const result = await initializeFirebase();
          console.log(' Firebase initialization completed, result:', result);
          console.log(' firebaseInitialized status:', { local: firebaseInitialized, global: window.firebaseInitialized });
        } catch (error) {
          console.error(' Firebase initialization failed:', error);
          updateLoadingStatus('Connection failed, running in offline mode...');
          // Continue anyway for offline mode
          firebaseInitialized = true;
          window.firebaseInitialized = true; // Expose to global scope
          console.log(' Set offline mode, firebaseInitialized:', { local: firebaseInitialized, global: window.firebaseInitialized });
        }
      }
      
      if (firebaseInitialized) {
        console.log(' Starting chat system...');
        console.log(' Final status check:', {
          firebaseInitialized: firebaseInitialized,
          windowFirebaseInitialized: window.firebaseInitialized,
          mainGoogleSignIn: typeof window.mainGoogleSignIn,
          mainShowCreateRoomModal: typeof window.mainShowCreateRoomModal
        });
        updateLoadingStatus('Starting chat system...');
        initializeChatSystem();
        hideLoadingIndicator();
      } else {
        console.log(' Firebase still not initialized, retrying...');
        updateLoadingStatus('Retrying connection...');
        setTimeout(waitForFirebaseAndStartChat, 100);
      }
    }

    // Loading indicator functions
    function updateLoadingStatus(message) {
      const loadingText = document.getElementById('loadingText');
      if (loadingText) {
        loadingText.textContent = message;
      }
    }

    function hideLoadingIndicator() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
      }
    }

    // Carbon Art Drawing System
    let drawingCanvas = null;
    let drawingContext = null;
    let isDrawing = false;
    let currentColor = '#000000';
    let currentBrushSize = 2;
    let canvasHistory = [];
    let historyIndex = -1;

    const ART_XP_REWARD = 20;
    const artColors = [
      '#000000', '#ffffff', '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff',
      '#800000', '#008000', '#000080', '#808000', '#800080', '#008080', '#c0c0c0', '#808080',
      '#ff8080', '#80ff80', '#8080ff', '#ffff80', '#ff80ff', '#80ffff', '#ffa500', '#a52a2a'
    ];

    function openCarbonArt() {
      if (!currentUser) {
        showNotification('Sign In Required', 'Please sign in to use Carbon Art Studio.', 'warning');
        return;
      }

      document.getElementById('carbonArtModal').classList.add('show');
      
      // Show loading state
      const gallery = document.getElementById('artGallery');
      if (gallery) {
        gallery.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--theme-muted);">Loading artworks...</p>';
      }
      
      initializeCanvas();
      populateColorPalette();
      setupBrushSizes();
      loadArtGallery();
    }

    function closeCarbonArt() {
      document.getElementById('carbonArtModal').classList.remove('show');
      if (drawingCanvas) {
        drawingContext.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        // Reset to white background
        drawingContext.fillStyle = '#ffffff';
        drawingContext.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
      }
      document.getElementById('artTitle').value = '';
      // Reset canvas history
      canvasHistory = [];
      historyIndex = -1;
    }

    function initializeCanvas() {
      try {
        drawingCanvas = document.getElementById('drawingCanvas');
        if (!drawingCanvas) {
          console.error('Drawing canvas not found');
          return;
        }
        
        drawingContext = drawingCanvas.getContext('2d');
        if (!drawingContext) {
          console.error('Could not get 2D context from canvas');
          return;
        }
        
        // Set default drawing properties
        drawingContext.lineCap = 'round';
        drawingContext.lineJoin = 'round';
        drawingContext.strokeStyle = currentColor;
        drawingContext.lineWidth = currentBrushSize;
        
        // Clear canvas with white background
        drawingContext.fillStyle = '#ffffff';
        drawingContext.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        
        // Reset canvas history
        canvasHistory = [];
        historyIndex = -1;
        
        // Save initial state
        saveCanvasState();
        
        // Remove any existing event listeners to prevent duplicates
        drawingCanvas.removeEventListener('mousedown', startDrawing);
        drawingCanvas.removeEventListener('mousemove', draw);
        drawingCanvas.removeEventListener('mouseup', stopDrawing);
        drawingCanvas.removeEventListener('mouseout', stopDrawing);
        drawingCanvas.removeEventListener('touchstart', handleTouch);
        drawingCanvas.removeEventListener('touchmove', handleTouch);
        drawingCanvas.removeEventListener('touchend', stopDrawing);
        
        // Add event listeners
        drawingCanvas.addEventListener('mousedown', startDrawing);
        drawingCanvas.addEventListener('mousemove', draw);
        drawingCanvas.addEventListener('mouseup', stopDrawing);
        drawingCanvas.addEventListener('mouseout', stopDrawing);
        
        // Touch events for mobile
        drawingCanvas.addEventListener('touchstart', handleTouch);
        drawingCanvas.addEventListener('touchmove', handleTouch);
        drawingCanvas.addEventListener('touchend', stopDrawing);
        

      } catch (error) {
        console.error('Error initializing canvas:', error);
        showNotification('Canvas Error', 'Failed to initialize drawing canvas. Please try refreshing the page.', 'error');
      }
    }

    function populateColorPalette() {
      const palette = document.getElementById('colorPalette');
      palette.innerHTML = '';
      
      artColors.forEach((color, index) => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = color;
        if (index === 0) swatch.classList.add('active');
        
        swatch.addEventListener('click', () => {
          document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
          swatch.classList.add('active');
          currentColor = color;
          drawingContext.strokeStyle = currentColor;
        });
        
        palette.appendChild(swatch);
      });
    }

    function setupBrushSizes() {
      const brushSizes = document.querySelectorAll('.brush-size');
      brushSizes.forEach(brush => {
        brush.addEventListener('click', () => {
          brushSizes.forEach(b => b.classList.remove('active'));
          brush.classList.add('active');
          currentBrushSize = parseInt(brush.getAttribute('data-size'));
          drawingContext.lineWidth = currentBrushSize;
        });
      });
    }

    function startDrawing(e) {
      isDrawing = true;
      const rect = drawingCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      drawingContext.beginPath();
      drawingContext.moveTo(x, y);
    }

    function draw(e) {
      if (!isDrawing) return;
      
      const rect = drawingCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      drawingContext.lineTo(x, y);
      drawingContext.stroke();
    }

    function stopDrawing() {
      if (isDrawing) {
        isDrawing = false;
        saveCanvasState();
      }
    }

    function handleTouch(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                       e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      drawingCanvas.dispatchEvent(mouseEvent);
    }

    function clearCanvas() {
      if (confirm('Are you sure you want to clear the canvas?')) {
        drawingContext.fillStyle = '#ffffff';
        drawingContext.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        saveCanvasState();
      }
    }

    function saveCanvasState() {
      try {
        if (!drawingCanvas) return;
        
        historyIndex++;
        if (historyIndex < canvasHistory.length) {
          canvasHistory.length = historyIndex;
        }
        canvasHistory.push(drawingCanvas.toDataURL());
        
        // Limit history to 20 states
        if (canvasHistory.length > 20) {
          canvasHistory.shift();
          historyIndex--;
        }
      } catch (error) {
        console.error('Error saving canvas state:', error);
      }
    }

    function undoCanvas() {
      try {
        if (!drawingCanvas || !drawingContext || historyIndex <= 0) return;
        
        historyIndex--;
        const img = new Image();
        img.onload = function() {
          try {
            drawingContext.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            drawingContext.drawImage(img, 0, 0);
          } catch (error) {
            console.error('Error restoring canvas state:', error);
          }
        };
        img.onerror = function() {
          console.error('Error loading canvas history image');
          historyIndex++; // Revert the history index change
        };
        img.src = canvasHistory[historyIndex];
      } catch (error) {
        console.error('Error in undoCanvas:', error);
      }
    }

    async function shareArtwork() {
      if (!currentUser || !drawingCanvas) {
        showNotification('Sign In Required', 'Please sign in and create artwork first.', 'warning');
        return;
      }

      const title = document.getElementById('artTitle').value.trim() || 'Untitled Artwork';
      
      // Basic content validation
      if (title.length > 100) {
        showNotification('Title Too Long', 'Title must be less than 100 characters.', 'warning');
        return;
      }

      // Sanitize title
      const sanitizedTitle = contentFilter.filter(title);
      if (!contentFilter.isAppropriate(sanitizedTitle)) {
        showNotification('Inappropriate Content', 'Please use appropriate language in your artwork title.', 'warning');
        return;
      }

      try {
        if (!drawingCanvas) {
          showNotification('Canvas Error', 'Canvas not ready. Please try again.', 'warning');
          return;
        }

        // Convert canvas to data URL (base64)
        const artworkData = drawingCanvas.toDataURL('image/png');
        
        // Validate the canvas has content (not just blank)
        const blankCanvas = document.createElement('canvas');
        blankCanvas.width = drawingCanvas.width;
        blankCanvas.height = drawingCanvas.height;
        const blankContext = blankCanvas.getContext('2d');
        blankContext.fillStyle = '#ffffff';
        blankContext.fillRect(0, 0, blankCanvas.width, blankCanvas.height);
        const blankData = blankCanvas.toDataURL('image/png');
        
        if (artworkData === blankData) {
          showNotification('No Artwork', 'Please create some artwork before sharing!', 'warning');
          return;
        }
        
        // Create artwork document
        const artworkDoc = {
          title: sanitizedTitle,
          imageData: artworkData,
          authorId: currentUser.uid,
          authorName: currentUser.displayName || 'Anonymous',
          authorPhoto: currentUser.photoURL || '',
          roomId: currentRoomId,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          likes: 0,
          likedBy: []
        };

        // Save to Firestore with better error handling
        const artworkRef = await db.collection('artworks').add(artworkDoc);
        if (!artworkRef.id) {
          throw new Error('Failed to save artwork to database');
        }

        // Award XP for creating art
        try {
          await awardXP(currentUser.uid, ART_XP_REWARD, 'Artwork shared', document.querySelector('.art-button.primary'));
        } catch (xpError) {
          console.warn('Failed to award XP, but artwork was saved:', xpError);
        }

        // Share in chat as a message
        const artMessage = {
          content: ` ${currentUser.displayName || 'Anonymous'} shared artwork: "${sanitizedTitle}"`,
          imageData: artworkData,
          messageType: 'artwork',
          authorId: currentUser.uid,
          authorName: currentUser.displayName || 'Anonymous',
          authorPhoto: currentUser.photoURL || '',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          roomId: currentRoomId
        };

        await db.collection('chatRooms').doc(currentRoomId).collection('messages').add(artMessage);

        // Show success notification
        showXPReward(ART_XP_REWARD, 'Artwork shared!');
        
        closeCarbonArt();
        loadArtGallery();
        // Also refresh community gallery if it's visible
        if (!document.getElementById('galleryTab').classList.contains('hidden')) {
          loadCommunityArt();
        }

      } catch (error) {
        console.error('Error sharing artwork:', error);
        let errorMessage = 'Failed to share artwork. ';
        if (error.code === 'permission-denied') {
          errorMessage += 'Permission denied. Please check your authentication.';
        } else if (error.code === 'unavailable') {
          errorMessage += 'Database unavailable. Please check your connection.';
        } else {
          errorMessage += 'Please try again.';
        }
        showNotification('Share Failed', errorMessage, 'error');
      }
    }

    async function loadArtGallery() {
      if (!currentRoomId) return;

      try {
        const artworksQuery = await db.collection('artworks')
          .where('roomId', '==', currentRoomId)
          .orderBy('createdAt', 'desc')
          .limit(12)
          .get();

        const gallery = document.getElementById('artGallery');
        if (!gallery) {
          console.error('Art gallery element not found');
          return;
        }
        
        gallery.innerHTML = '';

        if (artworksQuery.empty) {
          gallery.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--theme-muted);">No artworks yet. Be the first to create one!</p>';
          return;
        }

        artworksQuery.forEach(doc => {
          try {
            const artwork = doc.data();
            if (!artwork.imageData || !artwork.title) {
              console.warn('Artwork missing required data:', doc.id);
              return;
            }
            
            const isOwner = currentUser && artwork.authorId === currentUser.uid;
            
            const artPiece = document.createElement('div');
            artPiece.className = 'art-piece';
            artPiece.innerHTML = `
              <img src="${artwork.imageData}" alt="${sanitizeText(artwork.title)}" loading="lazy" onerror="this.style.display='none'">
              ${isOwner ? '<div class="art-piece-ownership">Your Art</div>' : ''}
              ${isOwner ? `
                <div class="art-piece-actions">
                  <button class="art-action-btn art-delete-btn" data-artwork-id="${doc.id}">
                    <i class='bx bx-trash'></i>
                  </button>
                </div>
              ` : ''}
              <div class="art-piece-info">
                <div class="art-piece-author">${sanitizeText(artwork.authorName || 'Anonymous')}</div>
                <div>${sanitizeText(artwork.title)}</div>
                <div class="art-piece-xp">+${ART_XP_REWARD} XP</div>
              </div>
            `;
            
            // Store artwork data on the element
            artPiece.artworkData = artwork;
            artPiece.artworkId = doc.id;
            
            artPiece.addEventListener('click', (e) => {
              if (!e.target.closest('.art-piece-actions')) {
                showArtworkModal(artwork);
              }
            });
            
            gallery.appendChild(artPiece);
          } catch (itemError) {
            console.error('Error processing artwork item:', itemError);
          }
        });

      } catch (error) {
        console.error('Error loading art gallery:', error);
        const gallery = document.getElementById('artGallery');
        if (gallery) {
          gallery.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--theme-muted);">Failed to load artworks. Please try refreshing.</p>';
        }
      }
    }

    function showArtworkModal(artwork) {
      // Create a simple modal to view the artwork
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); display: flex; justify-content: center;
        align-items: center; z-index: 4000; backdrop-filter: blur(10px);
      `;
      
      modal.innerHTML = `
        <div style="max-width: 80vw; max-height: 80vh; background: white; border-radius: 16px; padding: 2rem; text-align: center;">
          <h3 style="margin-bottom: 1rem; color: #333;">${artwork.title}</h3>
          <img src="${artwork.imageData}" style="max-width: 100%; max-height: 60vh; border-radius: 8px; box-shadow: 0 8px 25px rgba(0,0,0,0.2);">
          <p style="margin-top: 1rem; color: #666;">by ${artwork.authorName}</p>
          <button onclick="this.closest('div').parentNode.remove()" 
                  style="margin-top: 1rem; padding: 0.5rem 1rem; background: #9ccfd8; color: white; border: none; border-radius: 6px; cursor: pointer;">
            Close
          </button>
        </div>
      `;
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      document.body.appendChild(modal);
    }

    // Art Deletion System
    let pendingDeletion = null;

    function deleteArtwork(artworkId, artworkData) {
      if (!currentUser) {
        showNotification('Sign In Required', 'Please sign in to delete artwork.', 'warning');
        return;
      }

      // Check ownership
      if (artworkData.authorId !== currentUser.uid) {
        showNotification('Permission Denied', 'You can only delete your own artwork.', 'warning');
        return;
      }

      // Store pending deletion data
      pendingDeletion = { id: artworkId, data: artworkData };

      // Show confirmation dialog
      const dialog = document.getElementById('deleteConfirmation');
      const preview = document.getElementById('deletePreview');
      const title = document.getElementById('deleteArtTitle');

      preview.src = artworkData.imageData;
      title.textContent = artworkData.title;
      dialog.classList.add('show');
    }

    function cancelArtDeletion() {
      const dialog = document.getElementById('deleteConfirmation');
      dialog.classList.remove('show');
      pendingDeletion = null;
    }

    async function confirmArtDeletion() {
      if (!pendingDeletion || !currentUser) {
        cancelArtDeletion();
        return;
      }

      try {
        const { id, data } = pendingDeletion;

        // Double-check ownership before deletion
        if (data.authorId !== currentUser.uid) {
          showNotification('Permission Denied', 'You can only delete your own artwork.', 'warning');
          cancelArtDeletion();
          return;
        }

        // Delete from Firestore
        await db.collection('artworks').doc(id).delete();

        // Show success feedback
        showArtDeletionSuccess();

        // Refresh galleries
        if (!document.getElementById('galleryTab').classList.contains('hidden')) {
          loadCommunityArt();
        }
        loadArtGallery();

        cancelArtDeletion();

      } catch (error) {
        console.error('Error deleting artwork:', error);
        showNotification('Delete Failed', 'Failed to delete artwork. Please try again.', 'error');
        cancelArtDeletion();
      }
    }

    function showArtDeletionSuccess() {
      // Create temporary success notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success);
        color: white;
        padding: var(--space-4) var(--space-6);
        border-radius: var(--radius-lg);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        z-index: 5000;
        display: flex;
        align-items: center;
        gap: var(--space-2);
        animation: slideIn 0.3s ease;
      `;
      
      notification.innerHTML = `
        <i class='bx bx-check-circle'></i>
        Artwork deleted successfully
      `;
      
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Message Deletion Functions
    let pendingMessageDeletion = null;

    function deleteMessage(messageId, messageContent) {
      if (!currentUser || !currentRoomId) {
        showNotification('Sign In Required', 'Please sign in to delete messages.', 'warning');
        return;
      }

      // Store pending deletion data
      pendingMessageDeletion = { id: messageId, content: messageContent };

      // Show confirmation dialog
      const dialog = document.getElementById('deleteMessageConfirmation');
      const preview = document.getElementById('deleteMessagePreview');

      // Show message preview
      preview.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Your message:</div>
        <div style="font-style: italic; color: var(--text-secondary);">"${messageContent.length > 150 ? messageContent.substring(0, 150) + '...' : messageContent}"</div>
      `;

      dialog.classList.add('show');
    }

    function cancelMessageDeletion() {
      const dialog = document.getElementById('deleteMessageConfirmation');
      dialog.classList.remove('show');
      pendingMessageDeletion = null;
    }

    async function confirmMessageDeletion() {
      if (!pendingMessageDeletion || !currentUser || !currentRoomId) {
        cancelMessageDeletion();
        return;
      }

      try {
        const messageId = pendingMessageDeletion.id;
        
        // Delete the message from Firestore
        await db.collection('chatRooms')
          .doc(currentRoomId)
          .collection('messages')
          .doc(messageId)
          .delete();

        // Remove the message from the UI
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
          messageElement.style.animation = 'fadeOut 0.3s ease-in-out';
          setTimeout(() => {
            messageElement.remove();
          }, 300);
        }

        // Show success notification
        showNotification('Message Deleted', 'Your message has been successfully deleted.', 'success');
        
        // Close dialog
        cancelMessageDeletion();

      } catch (error) {
        console.error('Error deleting message:', error);
        showNotification('Delete Failed', 'Failed to delete message. Please try again.', 'error');
        cancelMessageDeletion();
      }
    }

    // Notification System
    let userNotifications = [];
    let unreadCount = 0;

    function toggleNotificationPanel(event) {
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      
      const panel = document.getElementById('notificationPanel');
      const isShowing = panel.classList.contains('show');
      
      if (isShowing) {
        panel.classList.remove('show');
        document.removeEventListener('click', closeNotificationPanelOnOutsideClick);
      } else {
        panel.classList.add('show');
        markNotificationsAsRead();
        // Add event listener after a brief delay to prevent immediate closure
        setTimeout(() => {
          document.addEventListener('click', closeNotificationPanelOnOutsideClick);
        }, 150);
      }
    }

    function closeNotificationPanelOnOutsideClick(event) {
      // Only handle click events, ignore all other events
      if (event.type !== 'click') {
        return;
      }
      
      const bell = document.getElementById('notificationBell');
      const panel = document.getElementById('notificationPanel');
      
      // Don't close if the panel isn't showing
      if (!panel.classList.contains('show')) {
        return;
      }
      
      // Don't close if clicking within the notification system
      if (bell.contains(event.target) || panel.contains(event.target)) {
        return;
      }
      
      // Close panel and remove listener
      panel.classList.remove('show');
      document.removeEventListener('click', closeNotificationPanelOnOutsideClick);
    }

    function addNotification(type, title, message, data = {}) {
      const notification = {
        id: Date.now(),
        type: type, // 'mention', 'message', 'reply'
        title: title,
        message: message,
        timestamp: new Date(),
        read: false,
        data: data // Additional data like user info, room info, etc.
      };

      userNotifications.unshift(notification);
      if (userNotifications.length > 50) {
        userNotifications = userNotifications.slice(0, 50);
      }

      updateNotificationUI();
      saveNotificationsToStorage();
    }

    function markNotificationsAsRead() {
      userNotifications.forEach(notif => notif.read = true);
      unreadCount = 0;
      updateNotificationUI();
      saveNotificationsToStorage();
    }

    function clearAllNotifications() {
      userNotifications = [];
      unreadCount = 0;
      updateNotificationUI();
      saveNotificationsToStorage();
    }

    function updateNotificationUI() {
      unreadCount = userNotifications.filter(n => !n.read).length;
      
      const badge = document.getElementById('notificationBadge');
      const bell = document.getElementById('notificationBell');
      const list = document.getElementById('notificationList');

      // Update badge
      if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.classList.remove('hidden');
        bell.classList.add('has-notifications');
      } else {
        badge.classList.add('hidden');
        bell.classList.remove('has-notifications');
      }

      // Update notification list
      if (userNotifications.length === 0) {
        list.innerHTML = `
          <div class="notification-empty">
            <i class='bx bx-bell'></i>
            <div>No notifications yet</div>
          </div>
        `;
      } else {
        list.innerHTML = userNotifications.map(notification => `
          <div class="notification-item ${!notification.read ? 'unread' : ''}" 
               onclick="handleNotificationClick('${notification.id}', event)">
            <div class="notification-content">
              ${notification.data.avatar ? `<img src="${notification.data.avatar}" class="notification-avatar" alt="Avatar">` : 
                `<div class="notification-avatar" style="background: var(--primary); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem;">${notification.data.userName ? notification.data.userName.charAt(0).toUpperCase() : '?'}</div>`}
              <div class="notification-text">
                <div class="notification-title">${sanitizeHTML(notification.title)}</div>
                <div class="notification-message">${sanitizeHTML(notification.message)}</div>
                <div class="notification-time">${timeAgo(notification.timestamp)}</div>
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    function handleNotificationClick(notificationId, event) {
      // Prevent event bubbling to avoid triggering outside click
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      
      const notification = userNotifications.find(n => n.id == notificationId);
      if (notification && notification.data.roomId) {
        // Mark notification as read immediately
        notification.read = true;
        updateNotificationUI();
        saveNotificationsToStorage();
        
        // Close panel immediately - no delay needed
        const panel = document.getElementById('notificationPanel');
        panel.classList.remove('show');
        document.removeEventListener('click', closeNotificationPanelOnOutsideClick);
        
        // Join the room where the notification came from
        if (notification.data.roomId !== currentRoomId) {
          joinRoom(notification.data.roomId);
        }
      }
    }

    function saveNotificationsToStorage() {
      try {
        localStorage.setItem('carbon-chat-notifications', JSON.stringify(userNotifications));
      } catch (e) {
        console.warn('Failed to save notifications to localStorage:', e);
      }
    }

    function loadNotificationsFromStorage() {
      try {
        const stored = localStorage.getItem('carbon-chat-notifications');
        if (stored) {
          userNotifications = JSON.parse(stored).map(n => ({
            ...n,
            timestamp: new Date(n.timestamp)
          }));
          updateNotificationUI();
        }
      } catch (e) {
        console.warn('Failed to load notifications from localStorage:', e);
        userNotifications = [];
      }
    }

    // Set up Firestore listener for mention notifications
    function setupNotificationListener() {
      if (!currentUser) return;

      // Listen for new notifications from Firestore
      const notificationsRef = db.collection('users').doc(currentUser.uid).collection('notifications');
      
      notificationsRef.orderBy('timestamp', 'desc').limit(20).onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added') {
            const notificationData = change.doc.data();
            
            // Add to local notifications
            addNotification(
              notificationData.type,
              notificationData.title,
              notificationData.message,
              {
                avatar: notificationData.fromUser?.photo,
                userName: notificationData.fromUser?.name,
                roomId: notificationData.roomId
              }
            );

            // Mark as read in Firestore immediately to prevent duplicate notifications
            requestAnimationFrame(() => {
              change.doc.ref.update({ read: true }).catch(console.error);
            });
          }
        });
      });
    }

    // User Mention System
    function processMentionsInMessage(content) {
      // Find @username mentions
      const mentionRegex = /@([a-zA-Z0-9_]+)/g;
      const mentions = [];
      let match;

      while ((match = mentionRegex.exec(content)) !== null) {
        mentions.push(match[1]);
      }

      return mentions;
    }

    function highlightMentions(content) {
      const mentionRegex = /@([a-zA-Z0-9_]+)/g;
      const result = content.replace(mentionRegex, '<span class="mention-highlight">@$1</span>');
      
      // Debug logging to check if mentions are being highlighted
      if (result !== content) {
        console.log(' Highlighting mentions in content:', content);
        console.log(' Result:', result);
      }
      
      return result;
    }

    function getUsernameFromDisplayName(displayName) {
      if (!displayName) return '';
      // Convert display name to username: remove spaces, special chars, lowercase
      return displayName.replace(/[^\w]/g, '').toLowerCase();
    }

    // Mention Autocomplete System
    let mentionUsers = [];
    let mentionQuery = '';
    let mentionStartPos = -1;
    let selectedMentionIndex = -1;
    let mentionDropdownVisible = false;

    async function loadMentionUsers() {
      if (!currentUser) return;
      
      try {
        const usersSnapshot = await db.collection('users').get();
        mentionUsers = [];
        
        usersSnapshot.docs.forEach(doc => {
          const userData = doc.data();
          if (userData.displayName && doc.id !== currentUser.uid) {
            const username = getUsernameFromDisplayName(userData.displayName);
            if (username) {
              mentionUsers.push({
                id: doc.id,
                displayName: userData.displayName,
                username: username,
                photo: userData.photoURL || null
              });
            }
          }
        });

        // Sort users alphabetically by display name
        mentionUsers.sort((a, b) => a.displayName.localeCompare(b.displayName));
      } catch (error) {
        console.error('Error loading mention users:', error);
      }
    }

    function showMentionDropdown(query = '') {
      const dropdown = document.getElementById('mentionDropdown');
      const list = document.getElementById('mentionList');
      
      // Filter users based on query
      const filteredUsers = mentionUsers.filter(user => 
        user.displayName.toLowerCase().includes(query.toLowerCase()) ||
        user.username.toLowerCase().includes(query.toLowerCase())
      );

      if (filteredUsers.length === 0) {
        list.innerHTML = '<div class="mention-no-results">No users found</div>';
      } else {
        list.innerHTML = filteredUsers.map((user, index) => `
          <div class="mention-item ${index === selectedMentionIndex ? 'selected' : ''}" 
               data-user-id="${user.id}" 
               data-username="${user.username}"
               data-display-name="${user.displayName}"
               onclick="selectMention('${user.username}', '${user.displayName}')">
            ${user.photo ? 
              `<img src="${user.photo}" class="mention-avatar" alt="${user.displayName}">` :
              `<div class="mention-avatar">${user.displayName.charAt(0).toUpperCase()}</div>`
            }
            <div class="mention-user-info">
              <div class="mention-display-name">${sanitizeHTML(user.displayName)}</div>
              <div class="mention-username">@${user.username}</div>
            </div>
          </div>
        `).join('');
      }

      dropdown.classList.add('show');
      mentionDropdownVisible = true;
    }

    function hideMentionDropdown() {
      const dropdown = document.getElementById('mentionDropdown');
      dropdown.classList.remove('show');
      mentionDropdownVisible = false;
      selectedMentionIndex = -1;
      mentionStartPos = -1;
      mentionQuery = '';
    }

    function selectMention(username, displayName) {
      const messageInput = document.getElementById('messageInput');
      const value = messageInput.value;
      
      // Replace the @query with @username
      const beforeMention = value.substring(0, mentionStartPos);
      const afterMention = value.substring(messageInput.selectionStart);
      const newValue = beforeMention + '@' + username + ' ' + afterMention;
      
      messageInput.value = newValue;
      const newCursorPos = mentionStartPos + username.length + 2; // +2 for @ and space
      messageInput.setSelectionRange(newCursorPos, newCursorPos);
      messageInput.focus();
      
      hideMentionDropdown();
    }

    function handleMentionNavigation(event) {
      if (!mentionDropdownVisible) return false;

      switch (event.key) {
        case 'ArrowDown':
          event.preventDefault();
          const items = document.querySelectorAll('.mention-item');
          if (selectedMentionIndex < items.length - 1) {
            selectedMentionIndex++;
            updateMentionSelection();
          }
          return true;

        case 'ArrowUp':
          event.preventDefault();
          if (selectedMentionIndex > 0) {
            selectedMentionIndex--;
            updateMentionSelection();
          }
          return true;

        case 'Enter':
        case 'Tab':
          event.preventDefault();
          const selectedItem = document.querySelector('.mention-item.selected');
          if (selectedItem) {
            const username = selectedItem.getAttribute('data-username');
            const displayName = selectedItem.getAttribute('data-display-name');
            selectMention(username, displayName);
          }
          return true;

        case 'Escape':
          event.preventDefault();
          hideMentionDropdown();
          return true;

        default:
          return false;
      }
    }

    function updateMentionSelection() {
      const items = document.querySelectorAll('.mention-item');
      items.forEach((item, index) => {
        if (index === selectedMentionIndex) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
        }
      });
    }

    function handleMentionInput() {
      const messageInput = document.getElementById('messageInput');
      const value = messageInput.value;
      const cursorPos = messageInput.selectionStart;
      
      // Find the last @ before cursor position
      let atPos = -1;
      for (let i = cursorPos - 1; i >= 0; i--) {
        if (value[i] === '@') {
          // Check if @ is at start or preceded by whitespace
          if (i === 0 || /\s/.test(value[i - 1])) {
            atPos = i;
            break;
          }
        } else if (/\s/.test(value[i])) {
          // If we hit whitespace before finding @, stop
          break;
        }
      }

      if (atPos !== -1) {
        // Extract query after @
        const query = value.substring(atPos + 1, cursorPos);
        
        // Only show dropdown if query doesn't contain spaces
        if (!/\s/.test(query)) {
          mentionStartPos = atPos;
          mentionQuery = query;
          selectedMentionIndex = 0;
          showMentionDropdown(query);
          return;
        }
      }

      // Hide dropdown if not in mention mode
      if (mentionDropdownVisible) {
        hideMentionDropdown();
      }
    }

    async function sendMentionNotifications(mentionedUsernames, messageContent, roomId) {
      if (!currentUser || mentionedUsernames.length === 0) return;

              try {
          // Get all users to find mentioned ones
          const usersSnapshot = await db.collection('users').get();
          const users = {};
          usersSnapshot.docs.forEach(doc => {
            const userData = doc.data();
            if (userData.displayName) {
              // Create a simple username from display name
              const username = getUsernameFromDisplayName(userData.displayName);
              if (username) {
                users[username] = { id: doc.id, ...userData };
              }
            }
          });

        // Send notifications to mentioned users
        for (const username of mentionedUsernames) {
          const mentionedUser = users[username.toLowerCase()];
          if (mentionedUser && mentionedUser.id !== currentUser.uid) {
            // Add notification to Firestore for the mentioned user
            await db.collection('users').doc(mentionedUser.id).collection('notifications').add({
              type: 'mention',
              title: `${currentUser.displayName} mentioned you`,
              message: messageContent.length > 100 ? messageContent.substring(0, 100) + '...' : messageContent,
              fromUser: {
                id: currentUser.uid,
                name: currentUser.displayName,
                photo: currentUser.photoURL
              },
              roomId: roomId,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              read: false
            });
          }
        }
      } catch (error) {
        console.error('Error sending mention notifications:', error);
      }
    }

    // Leaderboard System
    let currentLeaderboard = 'xp';
    let searchTimeout = null;

    async function loadLeaderboard(type = 'xp') {
      const leaderboardContainer = document.getElementById(`${type}Leaderboard`);
      if (!leaderboardContainer) return;

      // Show loading state
      leaderboardContainer.innerHTML = `
        <div class="leaderboard-loading">
          <div class="loading-spinner"></div>
          Loading ${type} leaderboard...
        </div>
      `;

      try {
        let query;
        let sortField;

        switch (type) {
          case 'xp':
            query = db.collection('users').orderBy('totalXP', 'desc').limit(50);
            sortField = 'totalXP';
            break;
          case 'messages':
            query = db.collection('users').orderBy('messageCount', 'desc').limit(50);
            sortField = 'messageCount';
            break;
          case 'level':
            query = db.collection('users').orderBy('level', 'desc').orderBy('totalXP', 'desc').limit(50);
            sortField = 'level';
            break;
          default:
            return;
        }

        const snapshot = await query.get();
        
        if (snapshot.empty) {
          leaderboardContainer.innerHTML = `
            <div class="search-no-results">
              No ${type} data available yet. Start chatting to see rankings!
            </div>
          `;
          return;
        }

        leaderboardContainer.innerHTML = '';
        
        snapshot.docs.forEach((doc, index) => {
          const userData = doc.data();
          const userId = doc.id;
          const rank = index + 1;
          
          const leaderboardItem = createLeaderboardItem(userData, userId, rank, type);
          leaderboardContainer.appendChild(leaderboardItem);
        });

        // Update follow button states after loading
        setTimeout(() => updateLeaderboardFollowStates(), 100);

        // Apply room theme to leaderboard container if active
        const mainLeaderboardContainer = document.getElementById('leaderboardContainer');
        if (document.body.classList.contains('custom-theme')) {
          mainLeaderboardContainer.classList.add('custom-theme');
        } else {
          mainLeaderboardContainer.classList.remove('custom-theme');
        }

      } catch (error) {
        console.error(`Error loading ${type} leaderboard:`, error);
        const errorContainer = document.getElementById(`${type}Leaderboard`);
        if (errorContainer) {
          errorContainer.innerHTML = `
            <div class="search-no-results">
              Failed to load leaderboard. Please try again.
            </div>
          `;
        }
      }
    }

    function createLeaderboardItem(userData, userId, rank, type) {
      const isCurrentUser = currentUser && userId === currentUser.uid;
      
      const item = document.createElement('div');
      item.className = `leaderboard-item ${isCurrentUser ? 'current-user' : ''}`;
      
      // Determine rank class
      let rankClass = 'regular';
      if (rank === 1) rankClass = 'top-1';
      else if (rank === 2) rankClass = 'top-2';
      else if (rank === 3) rankClass = 'top-3';

      // Get display value based on type
      let primaryValue, secondaryValue;
      switch (type) {
        case 'xp':
          primaryValue = `${userData.totalXP || 0} XP`;
          secondaryValue = `Level ${userData.level || 1}`;
          break;
        case 'messages':
          primaryValue = `${userData.messageCount || 0}`;
          secondaryValue = `${userData.totalXP || 0} XP`;
          break;
        case 'level':
          primaryValue = `Level ${userData.level || 1}`;
          secondaryValue = `${userData.totalXP || 0} XP`;
          break;
      }

      // Create avatar
      const avatarElement = userData.photoURL 
        ? `<img src="${userData.photoURL}" alt="${userData.displayName}" class="leaderboard-avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
           <div class="leaderboard-avatar placeholder" style="display: none;">${(userData.displayName || 'U').charAt(0).toUpperCase()}</div>`
        : `<div class="leaderboard-avatar placeholder">${(userData.displayName || 'User').charAt(0).toUpperCase()}</div>`;

      // Show follow button for other users (not current user)
      const showFollowButton = currentUser && userId !== currentUser.uid;
      
      item.innerHTML = `
        ${rank === 1 ? '<i class="bx bx-crown leaderboard-crown"></i>' : ''}
        <div class="leaderboard-rank ${rankClass}">${rank}</div>
        ${avatarElement}
        <div class="leaderboard-info">
          <div class="leaderboard-name">${sanitizeText(userData.displayName || 'Anonymous User')}</div>
          <div class="leaderboard-stats">
            <div class="leaderboard-stat">
              <i class='bx bx-message'></i>
              ${userData.messageCount || 0} messages
            </div>
            <div class="leaderboard-stat">
              <i class='bx bx-time'></i>
              ${userData.lastActivity ? timeAgo(userData.lastActivity.toDate()) : 'Never'}
            </div>
          </div>
          ${showFollowButton ? `
            <button class="leaderboard-follow-btn" data-user-id="${userId}" data-user-name="${sanitizeText(userData.displayName || 'User')}" data-user-photo="${userData.photoURL || ''}">
              <i class='bx bx-user-plus'></i>
            </button>
          ` : ''}
        </div>
        <div class="leaderboard-xp">
          <div class="leaderboard-xp-amount">${primaryValue}</div>
          <div class="leaderboard-level">${secondaryValue}</div>
        </div>
      `;

      // Add click handler to view user profile
      item.addEventListener('click', () => {
        if (userData.displayName) {
          showUserProfile(userId, userData.displayName, userData.photoURL);
        }
      });

      return item;
    }

    function timeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString();
    }

    async function searchUsers(query) {
      const searchResults = document.getElementById('searchResults');
      
      if (!query || query.length < 2) {
        searchResults.classList.add('hidden');
        showCurrentLeaderboard();
        return;
      }

      // Show loading
      searchResults.innerHTML = `
        <div class="leaderboard-loading">
          <div class="loading-spinner"></div>
          Searching users...
        </div>
      `;
      searchResults.classList.remove('hidden');
      hideAllLeaderboards();

      try {
        // Search by display name (case insensitive)
        const queryLower = query.toLowerCase();
        
        // Get all users and filter client-side (Firestore doesn't support case-insensitive search)
        const snapshot = await db.collection('users').limit(100).get();
        
        const results = [];
        snapshot.docs.forEach(doc => {
          const userData = doc.data();
          const displayName = (userData.displayName || '').toLowerCase();
          
          if (displayName.includes(queryLower)) {
            results.push({ id: doc.id, data: userData });
          }
        });

        if (results.length === 0) {
          searchResults.innerHTML = `
            <div class="search-no-results">
              No users found matching "${sanitizeText(query)}"
            </div>
          `;
          return;
        }

        // Sort by XP for search results
        results.sort((a, b) => (b.data.totalXP || 0) - (a.data.totalXP || 0));

        searchResults.innerHTML = '';
        results.forEach((result, index) => {
          const leaderboardItem = createLeaderboardItem(result.data, result.id, index + 1, 'xp');
          searchResults.appendChild(leaderboardItem);
        });

      } catch (error) {
        console.error('Error searching users:', error);
        searchResults.innerHTML = `
          <div class="search-no-results">
            Search failed. Please try again.
          </div>
        `;
      }
    }

    function switchLeaderboard(type) {
      currentLeaderboard = type;
      
      // Update tab buttons
      document.querySelectorAll('.leaderboard-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-board') === type) {
          tab.classList.add('active');
        }
      });

      // Clear search if active
      document.getElementById('userSearchInput').value = '';
      document.getElementById('searchResults').classList.add('hidden');
      
      showCurrentLeaderboard();
      loadLeaderboard(type);
    }

    function showCurrentLeaderboard() {
      hideAllLeaderboards();
      document.getElementById(`${currentLeaderboard}Leaderboard`).classList.remove('hidden');
    }

    function hideAllLeaderboards() {
      document.getElementById('xpLeaderboard').classList.add('hidden');
      document.getElementById('messagesLeaderboard').classList.add('hidden');
      document.getElementById('levelLeaderboard').classList.add('hidden');
    }

    // Update user message count
    async function updateMessageCount(userId) {
      if (!userId) return;

      try {
        const userRef = db.collection('users').doc(userId);
        await userRef.set({
          messageCount: firebase.firestore.FieldValue.increment(1),
          lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      } catch (error) {
        console.error('Error updating message count:', error);
      }
    }

    // Toggle follow from leaderboard
    async function toggleLeaderboardFollow(button, userId, userName, userPhoto) {
      if (!currentUser) return;

      const icon = button.querySelector('i');
      
      try {
        const followDoc = await db.collection('users').doc(currentUser.uid).collection('following').doc(userId).get();
        const isFollowing = followDoc.exists;

        if (isFollowing) {
          // Unfollow
          await db.collection('users').doc(currentUser.uid).collection('following').doc(userId).delete();
          await db.collection('users').doc(userId).collection('followers').doc(currentUser.uid).delete();
          
          button.classList.remove('following');
          icon.className = 'bx bx-user-plus';
          
        } else {
          // Follow
          await db.collection('users').doc(currentUser.uid).collection('following').doc(userId).set({
            followedAt: firebase.firestore.FieldValue.serverTimestamp(),
            displayName: userName,
            photoURL: userPhoto
          });
          
          await db.collection('users').doc(userId).collection('followers').doc(currentUser.uid).set({
            followedAt: firebase.firestore.FieldValue.serverTimestamp(),
            displayName: currentUser.displayName,
            photoURL: currentUser.photoURL
          });
          
          button.classList.add('following');
          icon.className = 'bx bx-user-check';
        }

      } catch (error) {
        console.error('Error toggling follow from leaderboard:', error);
        // Revert button state on error
        setTimeout(() => {
          button.classList.toggle('following');
          icon.className = button.classList.contains('following') ? 'bx bx-user-check' : 'bx bx-user-plus';
        }, 100);
      }
    }

    // Update leaderboard follow button states
    async function updateLeaderboardFollowStates() {
      if (!currentUser) return;

      try {
        const followingSnapshot = await db.collection('users').doc(currentUser.uid).collection('following').get();
        const followingIds = new Set(followingSnapshot.docs.map(doc => doc.id));

        document.querySelectorAll('.leaderboard-follow-btn').forEach(button => {
          const userId = button.getAttribute('data-user-id');
          const icon = button.querySelector('i');
          
          if (followingIds.has(userId)) {
            button.classList.add('following');
            icon.className = 'bx bx-user-check';
          } else {
            button.classList.remove('following');
            icon.className = 'bx bx-user-plus';
          }
        });
      } catch (error) {
        console.error('Error updating follow states:', error);
      }
    }

    // Notification System
    let notificationId = 0;
    let soundEnabled = localStorage.getItem('chatSounds') !== 'false';

    function showNotification(title, message, type = 'info', options = {}) {
      const container = document.getElementById('notificationContainer');
      if (!container) return;

      const id = ++notificationId;
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.dataset.id = id;

      const iconMap = {
        info: 'bx-info-circle',
        success: 'bx-check-circle',
        error: 'bx-error-circle',
        warning: 'bx-error',
        message: 'bx-message'
      };

      const avatar = options.avatar ? `<img src="${options.avatar}" class="notification-avatar" alt="Avatar">` : '';

      notification.innerHTML = `
        <div class="notification-header">
          ${avatar}
          <div class="notification-icon">
            <i class='bx ${iconMap[type] || iconMap.info}'></i>
          </div>
          <div class="notification-title">${sanitizeText(title)}</div>
          <button class="notification-close" onclick="closeNotification(${id})">
            <i class='bx bx-x'></i>
          </button>
        </div>
        <div class="notification-body">${sanitizeText(message)}</div>
      `;

      // Click to focus room
      if (options.roomId) {
        notification.addEventListener('click', (e) => {
          if (!e.target.closest('.notification-close')) {
            joinRoom(options.roomId);
            closeNotification(id);
          }
        });
      }

      container.appendChild(notification);

      // Play sound for new messages
      if (soundEnabled && type === 'message') {
        playNotificationSound();
      }

      // Auto-close after 5 seconds
      setTimeout(() => closeNotification(id), options.duration || 5000);

      return id;
    }

    function closeNotification(id) {
      const notification = document.querySelector(`[data-id="${id}"]`);
      if (notification) {
        notification.style.animation = 'slideOutRight 0.3s ease forwards';
        setTimeout(() => notification.remove(), 300);
      }
    }

    function playNotificationSound() {
      try {
        // Create audio context and generate notification sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
        gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.2);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
      } catch (error) {
        console.log('Audio notification not available:', error);
      }
    }

    function toggleSounds() {
      soundEnabled = !soundEnabled;
      localStorage.setItem('chatSounds', soundEnabled);
      showNotification('Sound Effects', `Sounds ${soundEnabled ? 'enabled' : 'disabled'}`, 'success');
      updateSoundButton();
    }

    function updateSoundButton() {
      const button = document.getElementById('soundToggle');
      if (button) {
        const icon = button.querySelector('i');
        icon.className = soundEnabled ? 'bx bx-volume-full' : 'bx bx-volume-mute';
        button.classList.toggle('active', soundEnabled);
      }
    }

    // Typing Indicator System
    let typingTimeout;
    let isTyping = false;
    let typingUsers = new Set();

    function startTyping() {
      if (!currentUser || !currentRoomId) return;

      if (!isTyping) {
        isTyping = true;
        db.collection('chatRooms').doc(currentRoomId).collection('typing').doc(currentUser.uid).set({
          userName: currentUser.displayName || 'Anonymous',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(stopTyping, 3000);
    }

    function stopTyping() {
      if (!currentUser || !currentRoomId || !isTyping) return;

      isTyping = false;
      db.collection('chatRooms').doc(currentRoomId).collection('typing').doc(currentUser.uid).delete();
      clearTimeout(typingTimeout);
    }

    function setupTypingIndicator() {
      if (!currentRoomId) return;

      // Listen for typing indicators
      db.collection('chatRooms').doc(currentRoomId).collection('typing')
        .onSnapshot(snapshot => {
          typingUsers.clear();
          
          snapshot.docs.forEach(doc => {
            const data = doc.data();
            if (doc.id !== currentUser?.uid) {
              typingUsers.add(data.userName);
            }
          });

          updateTypingIndicator();
        });
    }

    // AI-specific typing indicators
    function showAITyping() {
      const indicator = document.getElementById('typingIndicator');
      const text = document.getElementById('typingText');
      
      if (indicator && text) {
        text.textContent = 'AI Assistant is thinking...';
        indicator.classList.add('show');
        indicator.classList.add('ai-typing');
      }
    }

    function hideAITyping() {
      const indicator = document.getElementById('typingIndicator');
      
      if (indicator) {
        indicator.classList.remove('show');
        indicator.classList.remove('ai-typing');
      }
    }

    function updateTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      const text = document.getElementById('typingText');
      
      if (typingUsers.size === 0) {
        indicator.classList.remove('show');
      } else {
        const names = Array.from(typingUsers);
        let message = '';
        
        if (names.length === 1) {
          message = `${names[0]} is typing...`;
        } else if (names.length === 2) {
          message = `${names[0]} and ${names[1]} are typing...`;
        } else {
          message = `${names[0]} and ${names.length - 1} others are typing...`;
        }
        
        text.textContent = message;
        indicator.classList.add('show');
      }
    }

    // Input handling for typing detection
    function handleTyping() {
      startTyping();
      handleMentionInput(); // Check for mention trigger
    }

    function handleKeyDown(event) {
      // First check if mention dropdown is handling the key
      if (handleMentionNavigation(event)) {
        return; // Mention system handled the key
      }

      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        document.getElementById('messageForm').dispatchEvent(new Event('submit'));
      }
    }

    // Sidebar Tab Management
    function switchSidebarTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-tab') === tabName) {
          tab.classList.add('active');
        }
      });

      // Update tab content
      document.getElementById('roomsTab').classList.toggle('hidden', tabName !== 'rooms');
      document.getElementById('galleryTab').classList.toggle('hidden', tabName !== 'gallery');
      document.getElementById('leaderboardTab').classList.toggle('hidden', tabName !== 'leaderboard');

      // Load content based on tab
      if (tabName === 'gallery') {
        loadCommunityArt();
      } else if (tabName === 'leaderboard') {
        loadLeaderboard(currentLeaderboard);
        
        // Apply room theme to leaderboard if active
        const leaderboardTab = document.getElementById('leaderboardTab');
        if (document.body.classList.contains('custom-theme')) {
          leaderboardTab.classList.add('custom-theme');
        } else {
          leaderboardTab.classList.remove('custom-theme');
        }
      }
    }

    // Load Community Art Gallery
    async function loadCommunityArt() {
      try {
        const artworksQuery = await db.collection('artworks')
          .orderBy('createdAt', 'desc')
          .limit(50)
          .get();

        const artList = document.getElementById('communityArtList');
        if (!artList) return;

        artList.innerHTML = '';

        if (artworksQuery.empty) {
          artList.innerHTML = '<p style="text-align: center; color: var(--theme-muted); padding: 2rem;">No community artwork yet. Be the first to create something!</p>';
          return;
        }

        artworksQuery.forEach(doc => {
          try {
            const artwork = doc.data();
            if (!artwork.imageData || !artwork.title) return;

            const isOwner = currentUser && artwork.authorId === currentUser.uid;

            const artPiece = document.createElement('div');
            artPiece.className = 'art-piece-small';
            artPiece.innerHTML = `
              <img src="${artwork.imageData}" alt="${sanitizeText(artwork.title)}" 
                   class="art-piece-thumbnail" loading="lazy" 
                   onerror="this.style.display='none'">
              ${isOwner ? '<div class="art-piece-ownership">Your Art</div>' : ''}
              ${isOwner ? `
                <div class="art-piece-actions">
                  <button class="art-action-btn art-delete-btn" data-artwork-id="${doc.id}">
                    <i class='bx bx-trash'></i>
                  </button>
                </div>
              ` : ''}
              <div class="art-piece-details">
                <div class="art-piece-title">${sanitizeText(artwork.title)}</div>
                <div class="art-piece-author">by ${sanitizeText(artwork.authorName || 'Anonymous')}</div>
                <div class="art-piece-meta">${artwork.createdAt ? new Date(artwork.createdAt.toDate()).toLocaleDateString() : 'Recently'}</div>
              </div>
            `;

            // Store artwork data on the element
            artPiece.artworkData = artwork;
            artPiece.artworkId = doc.id;

            artPiece.addEventListener('click', (e) => {
              if (!e.target.closest('.art-piece-actions')) {
                showArtworkModal(artwork);
              }
            });

            artList.appendChild(artPiece);
          } catch (itemError) {
            console.error('Error processing community artwork item:', itemError);
          }
        });

      } catch (error) {
        console.error('Error loading community art:', error);
        const artList = document.getElementById('communityArtList');
        if (artList) {
          artList.innerHTML = '<p style="text-align: center; color: var(--theme-muted); padding: 2rem;">Failed to load community art. Please try refreshing.</p>';
        }
      }
    }

    // Ensure all functions are available in global scope for onclick handlers  
    // Main functions already exposed immediately after definition
    window.cleanupExpiredRooms = cleanupExpiredRooms;
    window.cleanupInactiveRooms = cleanupInactiveRooms;
    window.cleanupOldMessages = cleanupOldMessages;
    window.toggleUserList = toggleUserList;
    window.openColorPicker = openColorPicker;
    window.closeColorPicker = closeColorPicker;
    window.applyRoomColor = applyRoomColor;
    window.openCarbonArt = openCarbonArt;
    window.closeCarbonArt = closeCarbonArt;
    window.clearCanvas = clearCanvas;
    window.undoCanvas = undoCanvas;
    window.shareArtwork = shareArtwork;
    window.showArtworkModal = showArtworkModal;
    window.deleteArtwork = deleteArtwork;
    window.cancelArtDeletion = cancelArtDeletion;
    window.confirmArtDeletion = confirmArtDeletion;
    window.switchSidebarTab = switchSidebarTab;
    window.loadCommunityArt = loadCommunityArt;
    window.loadLeaderboard = loadLeaderboard;
    window.switchLeaderboard = switchLeaderboard;
    window.searchUsers = searchUsers;
    window.toggleLeaderboardFollow = toggleLeaderboardFollow;
    window.updateLeaderboardFollowStates = updateLeaderboardFollowStates;
    window.leaveCurrentRoom = leaveCurrentRoom;
    window.showNotification = showNotification;
    window.closeNotification = closeNotification;
    window.toggleSounds = toggleSounds;
    window.handleTyping = handleTyping;
    window.handleKeyDown = handleKeyDown;
    window.cancelReply = cancelReply;
    window.closeProfileModal = closeProfileModal;
    window.deleteMessage = deleteMessage;
    window.cancelMessageDeletion = cancelMessageDeletion;
    window.confirmMessageDeletion = confirmMessageDeletion;
    window.toggleNotificationPanel = toggleNotificationPanel;
    window.clearAllNotifications = clearAllNotifications;
    window.handleNotificationClick = handleNotificationClick;
    window.setupNotificationListener = setupNotificationListener;
    window.selectMention = selectMention;
    window.hideMentionDropdown = hideMentionDropdown;
    window.signOut = signOut;

    // Start when page loads
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Chat page loaded');
      setupNetworkMonitoring(); // Start network monitoring
      updateConnectionStatus(); // Set initial status
      setupSecureEventListeners(); // Setup secure event handling
      updateSoundButton(); // Initialize sound button state
      loadNotificationsFromStorage(); // Load stored notifications
      waitForFirebaseAndStartChat();
      
      // Timeout fallback if Firebase takes too long (15 seconds)
      setTimeout(() => {
        if (!firebaseInitialized) {
          console.warn('Firebase initialization timeout, forcing offline mode');
          updateLoadingStatus('Connection timeout - running in offline mode');
          firebaseInitialized = true;
          window.firebaseInitialized = true; // Expose to global scope
          initializeChatSystem();
          hideLoadingIndicator();
          
          if (window.showNotification) {
            showNotification('Offline Mode', 'Running in offline mode. Some features may be limited.', 'warning', { duration: 5000 });
          }
        }
      }, 15000);
      
      // Show welcome notification after Firebase is ready
      setTimeout(() => {
        if (firebaseInitialized && window.showNotification) {
          showNotification('Welcome to CARBON Chat', 'Select a room to start chatting!', 'info', { duration: 4000 });
        }
      }, 2000);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideCreateRoomModal();
      }
    });

    // Click outside modal to close
    document.getElementById('createRoomModal').addEventListener('click', (e) => {
      if (e.target.id === 'createRoomModal') {
        hideCreateRoomModal();
      }
    });
  </script>

  <!-- Carbon Art Modal -->
  <div id="carbonArtModal" class="art-modal">
    <div class="art-container">
      <div class="art-header">
        <div class="art-title">
          <i class='bx bx-brush'></i>
          Carbon Art Studio
        </div>
        <button onclick="closeCarbonArt()" style="background: none; border: none; color: var(--theme-muted); cursor: pointer; font-size: 1.5rem;"></button>
      </div>

      <div class="art-info">
        <h3> Create & Share Digital Art</h3>
        <p>Draw amazing artwork and share it with the community! Earn <strong>+20 XP</strong> for each masterpiece you create and share.</p>
      </div>

      <div class="canvas-container">
        <canvas id="drawingCanvas" class="drawing-canvas" width="600" height="400"></canvas>
      </div>

      <div class="art-tools">
        <div class="tool-group">
          <div class="tool-label">Colors</div>
          <div class="color-palette" id="colorPalette">
            <!-- Colors will be populated by JavaScript -->
          </div>
        </div>

        <div class="tool-group">
          <div class="tool-label">Brush Size</div>
          <div class="brush-sizes" id="brushSizes">
            <div class="brush-size active" data-size="2">
              <div class="brush-size-dot" style="width: 4px; height: 4px;"></div>
            </div>
            <div class="brush-size" data-size="5">
              <div class="brush-size-dot" style="width: 8px; height: 8px;"></div>
            </div>
            <div class="brush-size" data-size="10">
              <div class="brush-size-dot" style="width: 12px; height: 12px;"></div>
            </div>
            <div class="brush-size" data-size="20">
              <div class="brush-size-dot" style="width: 16px; height: 16px;"></div>
            </div>
          </div>
        </div>

        <div class="tool-group">
          <div class="tool-label">Tools</div>
          <div style="display: flex; gap: 0.5rem;">
            <button class="art-button secondary" onclick="clearCanvas()">
              <i class='bx bx-trash'></i>
              Clear
            </button>
            <button class="art-button secondary" onclick="undoCanvas()">
              <i class='bx bx-undo'></i>
              Undo
            </button>
          </div>
        </div>
      </div>

      <div class="art-actions">
        <div>
          <input type="text" id="artTitle" placeholder="Give your art a title..." 
                 style="padding: 0.5rem; border: 1px solid var(--theme-highlight-med); border-radius: 6px; background: var(--theme-surface); color: var(--theme-text); margin-right: 1rem;">
        </div>
        <div style="display: flex; gap: 1rem;">
          <button class="art-button secondary" onclick="closeCarbonArt()">
            <i class='bx bx-x'></i>
            Cancel
          </button>
          <button class="art-button primary" onclick="shareArtwork()">
            <i class='bx bx-share'></i>
            Share Art (+20 XP)
          </button>
        </div>
      </div>

      <div id="artGallery" class="art-gallery">
        <!-- Recent artworks will be displayed here -->
      </div>
    </div>
  </div>

  <!-- Art Deletion Confirmation Dialog -->
  <div id="deleteConfirmation" class="delete-confirmation">
    <div class="delete-dialog">
      <h3>Delete Artwork</h3>
      <img id="deletePreview" class="delete-preview" src="" alt="Artwork to delete">
      <p>Are you sure you want to delete "<span id="deleteArtTitle"></span>"? This action cannot be undone.</p>
      <div class="delete-dialog-actions">
        <button onclick="cancelArtDeletion()" class="btn btn-secondary">
          <i class='bx bx-x'></i>
          Cancel
        </button>
        <button onclick="confirmArtDeletion()" class="btn btn-danger">
          <i class='bx bx-trash'></i>
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Message Deletion Confirmation Dialog -->
  <div id="deleteMessageConfirmation" class="delete-message-confirmation">
    <div class="delete-message-dialog">
      <h3><i class='bx bx-trash'></i> Delete Message</h3>
      <p>Are you sure you want to delete this message? This action cannot be undone.</p>
      
      <div id="deleteMessagePreview" class="delete-message-preview">
        <!-- Message preview will be inserted here -->
      </div>
      
      <div class="delete-message-actions">
        <button onclick="cancelMessageDeletion()" class="btn btn-secondary">
          <i class='bx bx-x'></i>
          Cancel
        </button>
        <button onclick="confirmMessageDeletion()" class="btn btn-danger">
          <i class='bx bx-trash'></i>
          Delete Message
        </button>
      </div>
    </div>
  </div>

</body>
</html>