<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Play Game - CARBON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- XSS Protection Headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://www.gstatic.com https://cdn.jsdelivr.net https://apis.google.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com https://unpkg.com; img-src 'self' data: https:; media-src 'self' blob: https:; connect-src 'self' https:; frame-src 'self' https:;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link href='https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="../carbon-theme.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    // FIREBASE INIT
    const firebaseConfig = {
      apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
      authDomain: "carbon-services.firebaseapp.com",
      projectId: "carbon-services",
      storageBucket: "carbon-services.firebasestorage.app",
      messagingSenderId: "288385472070",
      appId: "1:288385472070:web:c4be3ff186e248fc645c47",
      measurementId: "G-Y2K1RQYE74"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
  <script>
    function setConfig() {
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ["Inter", "sans-serif"],
                    },
                    colors: {
                        'rp-base': '#191724',
                        'rp-surface': '#1f1d2e',
                        'rp-overlay': '#26233a',
                        'rp-muted': '#6e6a86',
                        'rp-subtle': '#908caa',
                        'rp-text': '#e0def4',
                        'rp-love': '#eb6f92',
                        'rp-gold': '#f6c177',
                        'rp-rose': '#ebbcba',
                        'rp-pine': '#31748f',
                        'rp-foam': '#9ccfd8',
                        'rp-iris': '#c4a7e7',
                        'rp-highlight-low': '#21202e',
                        'rp-highlight-med': '#403d52',
                        'rp-highlight-high': '#524f67'
                    },
                },
            },
        };
    }
    setConfig();
  </script>
  <style>
    :root {
      /* Theme variables - Rose Pine (default) */
      --theme-base: #191724;
      --theme-surface: #1f1d2e;
      --theme-overlay: #26233a;
      --theme-muted: #6e6a86;
      --theme-subtle: #908caa;
      --theme-text: #e0def4;
      --theme-love: #eb6f92;
      --theme-gold: #f6c177;
      --theme-rose: #ebbcba;
      --theme-pine: #31748f;
      --theme-foam: #9ccfd8;
      --theme-iris: #c4a7e7;
      --theme-highlight-low: #21202e;
      --theme-highlight-med: #403d52;
      --theme-highlight-high: #524f67;
      --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
      --theme-solid: #191724;
    }

    body {
      transition: all 0.3s ease;
    }

    .loader {
      border: 8px solid var(--theme-overlay);
      border-top: 8px solid var(--theme-foam);
      border-radius: 50%;
      width: 70px;
      height: 70px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    /* Game action button states */
    .game-action-btn.liked {
      background: rgba(34, 197, 94, 0.8) !important;
      border-color: rgba(34, 197, 94, 0.8) !important;
      color: white !important;
    }

    .game-action-btn.favorited {
      background: rgba(236, 72, 153, 0.8) !important;
      border-color: rgba(236, 72, 153, 0.8) !important;
      color: white !important;
    }

    .game-action-btn {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .game-action-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    .carbon-profile-avatar {
      transition: all 0.2s ease;
    }

    .carbon-profile-avatar:hover {
      transform: scale(1.05);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body class="bg-rp-base min-h-screen text-rp-text overflow-x-hidden relative font-[Inter] antialiased">

  <!-- Floating background elements -->
  <div class="pointer-events-none absolute rounded-full opacity-5 blur-3xl w-[300px] h-[300px] top-[10%] left-[10%] bg-gradient-to-br from-rp-foam to-rp-iris animate-[float_20s_infinite_ease-in-out]"></div>
  <div class="pointer-events-none absolute rounded-full opacity-5 blur-3xl w-[250px] h-[250px] top-[60%] right-[10%] bg-gradient-to-br from-rp-iris to-rp-love animate-[float_20s_infinite_ease-in-out] delay-[7s]"></div>

  <!-- Preloader -->
  <div id="preloader" class="fixed z-[9999] inset-0 flex flex-col justify-center items-center bg-rp-base">
    <div class="loader"></div>
  </div>

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-8 py-4 bg-rp-surface/80 border-b border-rp-overlay backdrop-blur-md fixed top-0 left-0 right-0 z-50">
    <div class="flex items-center gap-4">
      <a href="../index.html" class="text-2xl font-extrabold text-rp-foam tracking-tighter">CARBON</a>
      <a href="../games.html" class="flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-cyan-400/20 text-white rounded-lg transition-all duration-300 border border-white/20 hover:border-cyan-400/40">
        <i class='bx bx-arrow-back text-lg'></i>
        <span class="font-medium">Back to Games</span>
      </a>
    </div>
    <div class="flex items-center gap-4">
      <div id="userSection"></div>
    </div>
  </nav>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen w-full bg-rp-base fixed left-0 top-0 z-50">
    <div class="bg-rp-surface rounded-2xl shadow-2xl p-12 border border-rp-overlay flex flex-col items-center">
      <div class="text-3xl font-bold text-rp-foam mb-6">Sign In to Play</div>
      <button onclick="googleSignIn()" class="flex items-center gap-3 bg-rp-foam hover:bg-rp-foam/90 text-rp-base font-bold px-6 py-3 rounded-lg text-lg transition">
        <i class='bx bxl-google text-2xl'></i> Sign in with Google
      </button>
      <div id="loginError" class="text-rp-love mt-6 hidden"></div>
    </div>
  </div>

  <main class="pt-28 max-w-4xl mx-auto px-4">
    <div id="gameInfoHolder" class="rounded-2xl shadow-2xl bg-rp-surface border border-rp-overlay overflow-hidden mt-2">
      <!-- Game "cover" with play button -->
      <div class="relative aspect-video bg-black flex items-center justify-center">
        <img id="gameCoverImg" src="" class="w-full h-full object-cover pointer-events-none select-none rounded-t-2xl" alt="Game Cover" />
        <button id="bigPlayBtn" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-10 bg-gradient-to-br from-rp-foam to-rp-iris text-rp-base font-extrabold rounded-lg px-6 py-3 shadow-lg text-lg hover:scale-105 transition-all flex items-center gap-3 group min-w-[120px]">
          <i class='bx bx-play-circle text-2xl drop-shadow-lg group-hover:scale-110 transition-transform'></i>
          <span class="block text-base font-bold">Play</span>
        </button>
        <div class="absolute bottom-4 left-4 flex gap-3">
          <span id="gameCategoryTag" class="bg-rp-foam/30 text-rp-foam px-3 py-1 rounded text-xs font-semibold"></span>
          <span id="gameFeaturedTag" class="bg-rp-iris/30 text-rp-iris px-3 py-1 rounded text-xs font-semibold hidden">Featured</span>
        </div>
      </div>
      <div class="flex flex-col md:flex-row p-6 gap-6 items-start bg-rp-overlay">
        <div class="flex-1">
          <div id="gameTitleDisplay" class="text-2xl md:text-3xl font-extrabold text-rp-foam mb-3"></div>
          <div id="starRatingSection" class="my-4">
            <div id="starsContainer" class="flex gap-1 text-3xl"></div>
            <div class="text-sm mt-1 flex flex-wrap items-center gap-2 text-rp-subtle">
              <span id="starRatingSummary"></span>
              <span id="starRatingCount"></span>
              <span id="starRatingError" class="text-rp-love"></span>
            </div>
            <div id="ratingPercentContainer" class="flex items-center mt-2 gap-2">
              <span id="ratingPercentText" class="text-rp-iris font-semibold"></span>
              <div class="w-40 h-2 bg-rp-muted rounded overflow-hidden">
                <div id="ratingPercentBar" class="h-2 bg-rp-iris rounded transition-all duration-300" style="width:0%"></div>
              </div>
            </div>
          </div>
          <p id="gameFrameDesc" class="text-rp-text/80 mb-2 text-base leading-relaxed"></p>
          <!-- Game info -->
          <div id="gameInfoBox" class="mt-6 w-full">
            <div class="bg-rp-surface border border-rp-overlay rounded-2xl px-6 py-5 text-rp-text">
              <table class="w-full text-left">
                <tbody id="gameInfoTable"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="flex flex-col gap-2 w-full md:w-auto">
          <button id="fullscreenBtn" class="bg-gradient-to-r from-rp-foam to-rp-iris text-rp-base font-bold px-6 py-2 rounded-lg hover:scale-105 transition-transform">Fullscreen</button>
          <a href="../profile.html" class="bg-rp-text/10 text-rp-text px-6 py-2 rounded-lg hover:bg-rp-foam/20 transition text-center">View Profile</a>
        </div>
      </div>
    </div>

    <!-- Real iframe, shown after play -->
    <div id="gameFrameContainer" class="rounded-2xl shadow-2xl overflow-hidden mt-8 hidden" style="background: var(--theme-surface); border: 1px solid rgba(156, 207, 216, 0.3);">
      <div class="relative aspect-video bg-black">
        <iframe id="gameFrameEmbed" src="" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
        
        <div id="gameActionButtons" class="absolute top-4 right-4 flex gap-3 z-[9999] transition-all duration-300 opacity-100 pointer-events-auto">
          <button id="likeBtn" class="w-12 h-12 bg-black/60 backdrop-blur-md hover:bg-cyan-500/90 text-white rounded-full flex items-center justify-center transition-all duration-300 border-2 border-white/20 hover:border-cyan-400/60 shadow-lg hover:shadow-cyan-400/30 hover:scale-110 game-action-btn" title="Like">
            <i class='bx bx-like text-xl'></i>
          </button>
          <button id="favBtn" class="w-12 h-12 bg-black/60 backdrop-blur-md hover:bg-pink-500/90 text-white rounded-full flex items-center justify-center transition-all duration-300 border-2 border-white/20 hover:border-pink-400/60 shadow-lg hover:shadow-pink-400/30 hover:scale-110 game-action-btn" title="Favorite">
            <i class='bx bx-heart text-xl'></i>
          </button>
          <button id="dislikeBtn" class="w-12 h-12 bg-black/60 backdrop-blur-md hover:bg-red-500/90 text-white rounded-full flex items-center justify-center transition-all duration-300 border-2 border-white/20 hover:border-red-400/60 shadow-lg hover:shadow-red-400/30 hover:scale-110 game-action-btn" title="Dislike">
            <i class='bx bx-dislike text-xl'></i>
          </button>
          <button id="shareBtn" class="w-12 h-12 bg-black/60 backdrop-blur-md hover:bg-indigo-500/90 text-white rounded-full flex items-center justify-center transition-all duration-300 border-2 border-white/20 hover:border-indigo-400/60 shadow-lg hover:shadow-indigo-400/30 hover:scale-110 game-action-btn" title="Share">
            <i class='bx bx-share-alt text-xl'></i>
          </button>
          <button id="playlistBtn" class="w-12 h-12 bg-black/60 backdrop-blur-md hover:bg-yellow-400/90 text-white rounded-full flex items-center justify-center transition-all duration-300 border-2 border-white/20 hover:border-yellow-400/60 shadow-lg hover:shadow-yellow-400/30 hover:scale-110 game-action-btn" title="Add to Playlist">
            <i class='bx bx-list-plus text-xl'></i>
          </button>
          <button id="redirectBtn" class="w-12 h-12 bg-black/60 backdrop-blur-md hover:bg-orange-500/90 text-white rounded-full flex items-center justify-center transition-all duration-300 border-2 border-white/20 hover:border-orange-400/60 shadow-lg hover:shadow-orange-400/30 hover:scale-110 game-action-btn" title="Open Game in New Tab">
            <i class='bx bx-box text-xl'></i>
          </button>
        </div>
      </div>
      
      <!-- Game frame additional content -->
      <div class="flex flex-col md:flex-row p-6 gap-6 items-start" style="background: var(--theme-overlay);">
        <div class="flex-1">
          <div id="gameTitleDisplayFrame" class="text-2xl md:text-3xl font-extrabold mb-3" style="color: var(--theme-foam);"></div>
          <div id="starRatingSectionFrame" class="max-w-xl my-4">
            <div id="starsContainerFrame" class="flex gap-1 text-3xl"></div>
            <div class="text-sm mt-1 flex flex-wrap items-center gap-2" style="color: var(--theme-subtle);">
              <span id="starRatingSummaryFrame"></span>
              <span id="starRatingCountFrame"></span>
              <span id="starRatingErrorFrame" style="color: var(--theme-love);"></span>
            </div>
            <div id="ratingPercentContainerFrame" class="flex items-center mt-2 gap-2">
              <span id="ratingPercentTextFrame" class="font-semibold" style="color: var(--theme-iris);"></span>
              <div class="w-40 h-2 bg-slate-700 rounded overflow-hidden">
                <div id="ratingPercentBarFrame" class="h-2 bg-indigo-400 rounded transition-all duration-300" style="width:0%"></div>
              </div>
            </div>
            <!-- Tag area -->
            <div id="tagsAreaFrame" class="mt-5 flex flex-wrap gap-2"></div>
            <!-- Category count -->
            <div id="categoryGamesCountFrame" class="mt-4 text-base font-semibold" style="color: var(--theme-foam);"></div>
          </div>
        </div>
        <div class="flex flex-col gap-2 w-full md:w-auto">
          <button id="fullscreenBtnBottom" class="bg-gradient-to-r from-cyan-400 to-indigo-500 text-black font-bold px-6 py-2 rounded-lg hover:scale-105 transition-transform">Fullscreen</button>
          <a href="../profile.html" class="bg-white/10 text-white px-6 py-2 rounded-lg hover:bg-cyan-400/20 transition text-center">View Profile</a>
        </div>
      </div>
      
      <!-- Game info in frame panel -->
      <div id="gameInfoBoxFrame" class="mt-6 w-full">
        <div class="rounded-2xl px-6 py-5 mx-6 mb-8" style="background: var(--theme-surface); border: 1px solid rgba(156, 207, 216, 0.3); color: var(--theme-text);">
          <table class="w-full text-left">
            <tbody id="gameInfoTableFrame"></tbody>
          </table>
        </div>
      </div>

      <!-- Comments Section -->
      <div id="commentsSection" class="mt-8 mx-6 mb-8">
        <div class="rounded-2xl px-6 py-6" style="background: var(--theme-surface); border: 1px solid rgba(156, 207, 216, 0.3); color: var(--theme-text);">
          <!-- Comments Header -->
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold flex items-center gap-2" style="color: var(--theme-foam);">
              <i class='bx bx-message-square-dots text-3xl'></i>
              Reviews & Comments
              <span id="commentsCount" class="text-lg font-normal" style="color: var(--theme-foam);">
                (0)
              </span>
            </h3>
            
            <!-- Filter Dropdown -->
            <div class="relative">
              <select id="commentFilter" class="px-4 py-2 rounded-lg text-sm focus:outline-none" style="background: var(--theme-overlay); border: 1px solid rgba(156, 207, 216, 0.3); color: var(--theme-text);">
                <option value="all">All Comments</option>
                <option value="5">⭐⭐⭐⭐⭐ (5 stars)</option>
                <option value="4">⭐⭐⭐⭐ (4 stars)</option>
                <option value="3">⭐⭐⭐ (3 stars)</option>
                <option value="2">⭐⭐ (2 stars)</option>
                <option value="1">⭐ (1 star)</option>
                <option value="no-rating">No Rating</option>
              </select>
            </div>
          </div>

          <!-- Add Comment Form -->
          <div id="addCommentForm" class="mb-6 p-4 rounded-lg" style="background: var(--theme-overlay); border: 1px solid rgba(156, 207, 216, 0.2);">
            <h4 class="text-lg font-semibold mb-3" style="color: var(--theme-foam);">Write a Review</h4>
            
            <!-- Star Rating Input -->
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2" style="color: var(--theme-foam);">Your Rating (Optional)</label>
              <div id="commentStarInput" class="flex gap-1 text-2xl mb-2">
                <!-- Stars will be rendered here -->
              </div>
              <p class="text-xs" style="color: var(--theme-muted);">Click stars to rate this game</p>
            </div>

            <!-- Comment Text -->
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2" style="color: var(--theme-foam);">Your Comment</label>
              <textarea 
                id="commentText" 
                placeholder="Share your thoughts about this game..."
                class="comment-textarea w-full"
                maxlength="1000"
                style="background: var(--theme-overlay); border: 1px solid rgba(156, 207, 216, 0.3); color: var(--theme-text); border-radius: 8px; padding: 12px; resize: vertical; min-height: 80px;"
              ></textarea>
              <div class="flex justify-between text-xs mt-1" style="color: var(--theme-muted);">
                <span>Be respectful and constructive</span>
                <span id="commentCharCount">0/1000</span>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="flex gap-3">
              <button 
                id="submitComment" 
                class="bg-gradient-to-r from-cyan-400 to-indigo-500 text-black font-bold px-6 py-2 rounded-lg hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                <i class='bx bx-send mr-2'></i>
                Post Review
              </button>
              <button 
                id="cancelComment" 
                class="bg-white/10 text-white px-6 py-2 rounded-lg hover:bg-red-500/20 transition"
              >
                Cancel
              </button>
            </div>
            
            <!-- Rate Limit Warning -->
            <div id="rateLimitWarning" class="rate-limit-warning hidden bg-red-500/20 border border-red-500/30 text-red-400 rounded-lg p-3 mt-3">
              <i class='bx bx-error-circle mr-2'></i>
              <span id="rateLimitText">Please wait before posting another comment</span>
            </div>
          </div>

          <!-- Comments List -->
          <div id="commentsList" class="space-y-4">
            <!-- Comments will be rendered here -->
            <div id="commentsLoader" class="text-center py-8 hidden">
              <div class="inline-block w-6 h-6 border-2 border-cyan-400 border-t-transparent rounded-full animate-spin"></div>
              <p class="mt-2" style="color: var(--theme-foam);">Loading comments...</p>
            </div>
            <div id="noComments" class="text-center py-8" style="color: var(--theme-muted);">
              <i class='bx bx-message-square text-4xl mb-2 block'></i>
              <p>No comments yet. Be the first to share your thoughts!</p>
            </div>
          </div>

          <!-- Load More Button -->
          <div id="loadMoreComments" class="text-center mt-6 hidden">
            <button class="bg-white/10 px-6 py-2 rounded-lg transition" style="color: var(--theme-foam);">
              Load More Comments
            </button>
          </div>
        </div>
      </div>

      <!-- Suggested Games Section -->
      <div id="suggestedGamesSection" class="mt-8 mx-6 mb-8">
        <div class="rounded-2xl px-6 py-6" style="background: var(--theme-surface); border: 1px solid rgba(156, 207, 216, 0.3); color: var(--theme-text);">
          <h3 class="text-2xl font-bold mb-6 flex items-center gap-2" style="color: var(--theme-foam);">
            <i class='bx bx-joystick text-3xl'></i>
            You Might Also Like
          </h3>
          <div class="relative">
            <div class="overflow-hidden rounded-2xl">
              <div id="suggestedGamesList" class="flex transition-transform duration-500 ease-in-out">
                <!-- Suggested games will be rendered here -->
                <div class="flex-shrink-0 w-full text-center py-8" style="color: var(--theme-muted);">
                  <i class='bx bx-loader-alt text-4xl mb-2 block animate-spin'></i>
                  <p>Loading suggested games...</p>
                </div>
              </div>
            </div>
            <button id="suggestedPrevBtn" class="carousel-nav-btn absolute left-2 top-1/2 p-3 rounded-full opacity-0 pointer-events-none z-10 transform -translate-y-1/2 bg-black/60 backdrop-blur-md border border-cyan-400/30 text-cyan-400">
              <i class='bx bx-chevron-left text-2xl'></i>
            </button>
            <button id="suggestedNextBtn" class="carousel-nav-btn absolute right-2 top-1/2 p-3 rounded-full opacity-0 pointer-events-none z-10 transform -translate-y-1/2 bg-black/60 backdrop-blur-md border border-cyan-400/30 text-cyan-400">
              <i class='bx bx-chevron-right text-2xl'></i>
            </button>
          </div>
          <!-- Carousel indicators -->
          <div id="suggestedCarouselDots" class="flex justify-center mt-6 gap-2">
            <!-- Dots will be rendered here -->
          </div>
        </div>
      </div>

      <!-- Modals -->
      <!-- Reply Modal -->
      <div id="replyModal" class="hidden fixed inset-0 z-[10001] bg-black/70 flex items-center justify-center">
        <div class="rounded-xl p-6 max-w-lg w-full mx-4 shadow-2xl relative" style="background: var(--theme-overlay); border: 1px solid rgba(156, 207, 216, 0.2);">
          <button onclick="closeReplyModal()" class="absolute top-3 right-4 text-white/70 text-xl">
            <i class='bx bx-x'></i>
          </button>
          <h3 class="text-xl font-bold mb-4" style="color: var(--theme-foam);">Reply to Comment</h3>
          
          <div id="replyToComment" class="mb-4 p-3 rounded-lg" style="background: var(--theme-surface); border: 1px solid rgba(156, 207, 216, 0.2);">
            <!-- Original comment will be shown here -->
          </div>
          
          <textarea 
            id="replyText" 
            placeholder="Write your reply..."
            class="w-full mb-4 px-3 py-2 rounded-lg" 
            style="background: var(--theme-overlay); border: 1px solid rgba(156, 207, 216, 0.3); color: var(--theme-text);"
            maxlength="500"
          ></textarea>
          <div class="text-xs mb-4 text-right" style="color: var(--theme-muted);">
            <span id="replyCharCount">0/500</span>
          </div>
          
          <div class="flex gap-3">
            <button 
              id="submitReply" 
              class="bg-gradient-to-r from-cyan-400 to-indigo-500 text-black font-bold px-4 py-2 rounded-lg hover:scale-105 transition-transform disabled:opacity-50"
              disabled
            >
              Post Reply
            </button>
            <button 
              onclick="closeReplyModal()" 
              class="bg-white/10 text-white px-4 py-2 rounded-lg hover:bg-red-500/20 transition"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Reaction Picker -->
      <div id="reactionPicker" class="hidden absolute z-[10002] bg-black/80 backdrop-blur-md border border-cyan-400/30 rounded-lg p-4">
        <emoji-picker></emoji-picker>
      </div>
    </div>
  </main>

  <!-- Floating Chat Circle -->
  <div id="chatFloatingBtn" class="fixed bottom-6 right-6 z-[9999] group cursor-pointer" onclick="toggleChat()">
    <div class="relative">
      <!-- Main Circle -->
      <div class="w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 transform hover:scale-110 shadow-2xl border-2" 
           style="background: linear-gradient(135deg, var(--theme-foam), var(--theme-iris)); border-color: rgba(156, 207, 216, 0.5);">
        <i id="chatIcon" class="bx bx-message-dots text-2xl text-black transition-transform duration-300"></i>
      </div>
      
      <!-- Pulse Animation -->
      <div class="absolute inset-0 rounded-full animate-pulse opacity-75" 
           style="background: linear-gradient(135deg, var(--theme-foam), var(--theme-iris));"></div>
      
      <!-- Notification Badge (if needed) -->
      <div id="chatNotificationBadge" class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold hidden">
        <span id="chatNotificationCount">0</span>
      </div>
      
      <!-- Tooltip -->
      <div class="absolute bottom-full right-0 mb-2 px-3 py-1 bg-black/80 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap pointer-events-none">
        Open Chat
        <div class="absolute top-full right-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-black/80"></div>
      </div>
    </div>
  </div>

  <!-- Chat Modal/Popup -->
  <div id="chatModal" class="fixed inset-0 z-[10000] bg-black/70 backdrop-blur-sm flex items-center justify-center hidden">
    <div class="w-full max-w-4xl h-[80vh] mx-4 rounded-2xl overflow-hidden shadow-2xl" 
         style="background: var(--theme-surface); border: 2px solid rgba(156, 207, 216, 0.3);">
      
      <!-- Chat Header -->
      <div class="flex items-center justify-between p-4 border-b" style="border-color: rgba(156, 207, 216, 0.2); background: var(--theme-overlay);">
        <div class="flex items-center gap-3">
          <i class="bx bx-message-dots text-2xl" style="color: var(--theme-foam);"></i>
          <h3 class="text-xl font-bold" style="color: var(--theme-foam);">CARBON Chat</h3>
        </div>
        <button onclick="closeChat()" class="w-8 h-8 rounded-full flex items-center justify-center transition-colors" 
                style="background: rgba(156, 207, 216, 0.1); color: var(--theme-text);" 
                onmouseover="this.style.background='rgba(235, 111, 146, 0.2)'" 
                onmouseout="this.style.background='rgba(156, 207, 216, 0.1)'">
          <i class="bx bx-x text-xl"></i>
        </button>
      </div>
      
      <!-- Chat Content (iframe) -->
      <iframe id="chatFrame" 
              src="../chat.html" 
              class="w-full h-full border-0"
              style="height: calc(100% - 73px);">
      </iframe>
    </div>
  </div>

  <script>
    // NO PROXY SYSTEM - Direct JSON loading for /games directory
    
    // --- STAR RATING SYSTEM ---
    let starRatingData = {
      average: 0,
      count: 0,
      yourRating: 0,
      loading: false,
      error: "",
      percent: 0
    };

    function renderStarRatingUI(target = "") {
      const pre = target ? target : "";
      const container = document.getElementById('starsContainer' + pre);
      if (!container) return;
      container.innerHTML = '';
      let fill = starRatingData.yourRating ? starRatingData.yourRating : Math.round(starRatingData.average);
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.textContent = '★';
        star.className = 'transition-colors duration-150 select-none ' +
          (i <= fill ? 'star-filled' : 'star-empty') +
          (auth.currentUser ? ' cursor-pointer star-hover' : ' cursor-not-allowed');
        star.style.color = i <= fill ? 'var(--theme-gold)' : 'var(--theme-muted)';
        if (auth.currentUser) {
          star.addEventListener('mouseenter', () => {
            for (let j = 0; j < 5; j++) {
              container.children[j].style.color = j < i ? 'var(--theme-gold)' : 'var(--theme-muted)';
            }
          });
          star.addEventListener('mouseleave', () => {
            for (let j = 0; j < 5; j++) {
              container.children[j].style.color = j < fill ? 'var(--theme-gold)' : 'var(--theme-muted)';
            }
          });
          star.addEventListener('click', async () => {
            await submitStarRating(i);
          });
        }
        container.appendChild(star);
      }
      document.getElementById('starRatingSummary' + pre).textContent =
        starRatingData.count ? `${starRatingData.average.toFixed(2)} / 5` : "Not rated";
      document.getElementById('starRatingCount' + pre).textContent =
        starRatingData.count === 1 ? "1 rating" : (starRatingData.count ? `${starRatingData.count} ratings` : "");
      document.getElementById('starRatingError' + pre).textContent = starRatingData.error || '';
      renderRatingPercentUI(target);
    }

    async function loadStarRating(gameId) {
      starRatingData.loading = true;
      starRatingData.error = "";
      starRatingData.average = 0;
      starRatingData.count = 0;
      starRatingData.yourRating = 0;
      starRatingData.percent = 0;
      try {
        const ratingsRef = db.collection("games").doc(gameId).collection("ratings");
        const snap = await ratingsRef.get();
        let total = 0, count = 0, your = 0, user = auth.currentUser;
        let highCount = 0;
        snap.forEach(doc => {
          const d = doc.data();
          if (typeof d.rating === "number" && d.rating >= 1 && d.rating <= 5) {
            total += d.rating;
            count++;
            if (d.rating >= 4) highCount++;
            if (user && doc.id === user.uid) your = d.rating;
          }
        });
        starRatingData.average = count ? total / count : 0;
        starRatingData.count = count;
        starRatingData.yourRating = your;
        starRatingData.percent = count ? Math.round((highCount / count) * 100) : 0;
      } catch (e) {
        starRatingData.error = "Failed to load ratings.";
      }
      starRatingData.loading = false;
      renderStarRatingUI();
      renderStarRatingUI("Frame");
    }

    async function submitStarRating(stars) {
      if (!auth.currentUser) {
        starRatingData.error = "Sign in first!";
        renderStarRatingUI();
        renderStarRatingUI("Frame");
        return;
      }
      if (!currentGameId) {
        starRatingData.error = "Game not loaded!";
        renderStarRatingUI();
        renderStarRatingUI("Frame");
        return;
      }
      if (stars < 1 || stars > 5) {
        starRatingData.error = "Invalid rating value!";
        renderStarRatingUI();
        renderStarRatingUI("Frame");
        return;
      }
      starRatingData.loading = true;
      starRatingData.error = "";
      renderStarRatingUI();
      renderStarRatingUI("Frame");
      try {
        const ref = db.collection("games").doc(currentGameId).collection("ratings").doc(auth.currentUser.uid);
        await ref.set({
          rating: stars,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        starRatingData.yourRating = stars;
        await loadStarRating(currentGameId);
      } catch (e) {
        starRatingData.error = "Failed to rate, try again.";
        renderStarRatingUI();
        renderStarRatingUI("Frame");
      }
      starRatingData.loading = false;
      renderStarRatingUI();
      renderStarRatingUI("Frame");
    }

    function renderRatingPercentUI(target = "") {
      const pre = target ? target : "";
      const txt = document.getElementById('ratingPercentText' + pre);
      const bar = document.getElementById('ratingPercentBar' + pre);
      if (!txt || !bar) return;
      if (starRatingData.count === 0) {
        txt.textContent = "Not enough ratings yet";
        bar.style.width = "0%";
      } else {
        txt.textContent = `${starRatingData.percent}% of raters gave 4 or 5 stars`;
        bar.style.width = `${starRatingData.percent}%`;
      }
    }

    // --- COMMENT SYSTEM ---
    let commentsData = {
      comments: [],
      loading: false,
      currentFilter: 'all',
      currentCommentRating: 0,
      currentReplyingTo: null,
      lastVisible: null,
      commentsPerPage: 10
    };

    // Initialize comment star rating input
    function initCommentStarInput() {
      const container = document.getElementById('commentStarInput');
      if (!container) return;
      
      container.innerHTML = '';
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.textContent = '★';
        star.className = 'cursor-pointer transition-colors duration-150 select-none ' + 
          (i <= commentsData.currentCommentRating ? 'text-yellow-400' : 'text-slate-600');
        
        star.addEventListener('mouseenter', () => {
          for (let j = 0; j < 5; j++) {
            container.children[j].classList.toggle('text-yellow-400', j < i);
            container.children[j].classList.toggle('text-slate-600', j >= i);
          }
        });
        
        star.addEventListener('mouseleave', () => {
          for (let j = 0; j < 5; j++) {
            container.children[j].classList.toggle('text-yellow-400', j < commentsData.currentCommentRating);
            container.children[j].classList.toggle('text-slate-600', j >= commentsData.currentCommentRating);
          }
        });
        
        star.addEventListener('click', () => {
          commentsData.currentCommentRating = commentsData.currentCommentRating === i ? 0 : i;
          updateCommentStarInput();
        });
        
        container.appendChild(star);
      }
    }

    function updateCommentStarInput() {
      const container = document.getElementById('commentStarInput');
      if (!container) return;
      
      for (let j = 0; j < 5; j++) {
        container.children[j].classList.toggle('text-yellow-400', j < commentsData.currentCommentRating);
        container.children[j].classList.toggle('text-slate-600', j >= commentsData.currentCommentRating);
      }
    }
    
    function googleSignIn() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .catch((error) => {
          document.getElementById('loginError').innerText = error.message;
          document.getElementById('loginError').classList.remove('hidden');
        });
    }
    
    function signOutUser() {
      auth.signOut().then(() => location.reload());
    }

    async function ensureUserDoc(user) {
      const userRef = db.collection('users').doc(user.uid);
      const doc = await userRef.get();
      if (!doc.exists) {
        await userRef.set({
          displayName: user.displayName || "",
          photoURL: user.photoURL || "",
          email: user.email || "",
          username: "",
          likedGames: [],
          favoriteGames: [],
          history: [],
        });
      } else {
        let needsUpdate = false;
        const data = doc.data();
        const updateFields = {};
        if (!data.displayName && user.displayName) {
          updateFields.displayName = user.displayName;
          needsUpdate = true;
        }
        if (!data.photoURL && user.photoURL) {
          updateFields.photoURL = user.photoURL;
          needsUpdate = true;
        }
        if (needsUpdate) await userRef.update(updateFields);
      }
    }

    let gamesData = [];
    let currentGameId = null;
    let currentGame = null;

    // Load games data from parent directory JSON - NO PROXY SYSTEM
    async function loadGamesData() {
      try {
        const res = await fetch('../games.json');
        gamesData = await res.json();
        window.gamesData = gamesData;
        console.log('Loaded', gamesData.length, 'games from JSON');
      } catch (error) {
        console.error('Error loading games data:', error);
        throw error;
      }
    }

    function getGameIdFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      return validateGameId(id);
    }

    function validateGameId(id) {
      if (!id) return null;
      return /^[a-zA-Z0-9_-]+$/.test(id) ? id : null;
    }

    function renderUserSection(user) {
      const section = document.getElementById('userSection');
      if (!user) {
        section.innerHTML = '';
      } else {
        const photoURL = validateUrl(user.photoURL) || '/default-avatar.png';
        const displayName = escapeHtml(user.displayName) || 'User';
        const titleAttr = escapeHtmlAttribute(user.displayName) || 'User';
        
        section.innerHTML = `
          <img src="${escapeHtmlAttribute(photoURL)}" class="carbon-profile-avatar w-8 h-8 rounded-full inline mr-2" title="${titleAttr}">
          <span class="mr-3">${displayName}</span>
          <button onclick="signOutUser()" class="bg-white/10 px-3 py-1 rounded hover:bg-pink-600 text-white">Sign Out</button>
        `;
      }
    }

    function requestFullScreen(element) {
      if (element.requestFullscreen) element.requestFullscreen();
      else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();
      else if (element.msRequestFullscreen) element.msRequestFullscreen();
      else if (element.mozRequestFullScreen) element.mozRequestFullScreen();
    }

    // XSS Protection functions
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeHtmlAttribute(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, function(match) {
        switch (match) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          case "'": return '&#39;';
          default: return match;
        }
      });
    }

    function validateUrl(url) {
      if (!url) return '';
      const allowedProtocols = ['http:', 'https:', 'data:'];
      try {
        const urlObj = new URL(url);
        return allowedProtocols.includes(urlObj.protocol) ? url : '';
      } catch (e) {
        return '';
      }
    }

          // DIRECT GAME LOADING WITHOUT PROXY - Key difference from main play.html
      async function loadDirectGameIframe() {
        if (!currentGame) return;
        
        // For games in /games directory, construct direct path
        let gameUrl = currentGame.url;
        
        // Convert the JSON URL path to relative path for /games directory
        // Original: "./games/amaze/index.html" 
        // Convert to: "./amaze/index.html" (relative to current /games/ directory)
        if (gameUrl.startsWith('./games/')) {
          gameUrl = gameUrl.replace('./games/', './');
        }
        
        console.log('Loading game directly without proxy:', gameUrl);
        console.log('Game:', currentGame.title);
        
        // Check if this game has known iframe compatibility issues
        const gameFrame = document.getElementById("gameFrameEmbed");
        
        // Set up iframe error detection and auto-redirect fallback
        setupIframeErrorDetection(gameUrl, gameFrame);
        
        // Load directly into iframe - NO PROXY SYSTEM
        gameFrame.src = gameUrl;
        
        // Track game activity for profile integration (only for signed-in users)
        if (auth.currentUser) {
          console.log('Tracking game start for profile integration...');
          await window.trackGameStart(currentGameId);
          
          // Update play count for profile statistics
          await updatePlayCount(currentGameId);
        } else {
          console.log('Anonymous user playing - no profile tracking');
        }
        
        // Set up game end tracking when user leaves
        window.addEventListener('beforeunload', async () => {
          await window.trackGameEnd();
        });
      }

      // Set up iframe error detection and auto-redirect fallback
      function setupIframeErrorDetection(gameUrl, iframe) {
        let loadTimeout;
        let hasLoaded = false;
        
        // Create loading indicator
        showIframeLoadingState();
        
        // Set up load success handler
        iframe.onload = function() {
          hasLoaded = true;
          clearTimeout(loadTimeout);
          hideIframeLoadingState();
          console.log('Game loaded successfully in iframe');
        };
        
        // Set up error handler
        iframe.onerror = function() {
          console.warn('Iframe failed to load game, using auto-redirect fallback');
          handleIframeFailure(gameUrl);
        };
        
        // Set up timeout for detecting stuck/frozen games
        loadTimeout = setTimeout(() => {
          if (!hasLoaded) {
            console.warn('Game taking too long to load in iframe, offering redirect option');
            showRedirectFallback(gameUrl);
          }
        }, 8000); // 8 second timeout
        
        // Check for external base URL issues by examining the game content
        checkForExternalResources(gameUrl);
      }

      function showIframeLoadingState() {
        const iframe = document.getElementById("gameFrameEmbed");
        const container = iframe.parentElement;
        
        // Add loading overlay
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'gameLoadingOverlay';
        loadingOverlay.className = 'absolute inset-0 bg-black/70 flex items-center justify-center z-10';
        loadingOverlay.innerHTML = `
          <div class="text-center text-white">
            <div class="inline-block w-8 h-8 border-4 border-cyan-400 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-lg font-semibold">Loading ${currentGame.title}...</p>
            <p class="text-sm text-gray-300 mt-2">This may take a moment</p>
          </div>
        `;
        container.appendChild(loadingOverlay);
      }

      function hideIframeLoadingState() {
        const overlay = document.getElementById('gameLoadingOverlay');
        if (overlay) {
          overlay.remove();
        }
      }

      function showRedirectFallback(gameUrl) {
        const overlay = document.getElementById('gameLoadingOverlay');
        if (overlay) {
          overlay.innerHTML = `
            <div class="text-center text-white max-w-md mx-auto p-6">
              <i class="bx bx-error-circle text-6xl text-yellow-400 mb-4"></i>
              <h3 class="text-xl font-bold mb-2">Game Loading Issue</h3>
              <p class="text-gray-300 mb-6">This game may have compatibility issues with iframe loading. We recommend using the redirect option for the best experience.</p>
              <div class="flex gap-3 justify-center">
                <button onclick="redirectToGame('${gameUrl}')" 
                        class="bg-orange-500 hover:bg-orange-600 px-6 py-3 rounded-lg font-semibold transition-colors">
                  <i class="bx bx-box mr-2"></i>
                  Open in New Tab
                </button>
                <button onclick="retryIframeLoad('${gameUrl}')" 
                        class="bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-lg font-semibold transition-colors">
                  <i class="bx bx-refresh mr-2"></i>
                  Try Again
                </button>
              </div>
            </div>
          `;
        }
      }

      function handleIframeFailure(gameUrl) {
        console.error('Iframe completely failed to load game');
        showRedirectFallback(gameUrl);
      }

      async function checkForExternalResources(gameUrl) {
        try {
          // Fetch the game HTML to check for external base URLs
          const response = await fetch(gameUrl);
          const html = await response.text();
          
          // Check for problematic patterns
          const hasExternalBase = html.includes('base href="http') && 
                                 (html.includes('cdn.jsdelivr.net') || 
                                  html.includes('github.io') || 
                                  html.includes('googleapis.com'));
          
          if (hasExternalBase) {
            console.warn('Game detected with external base URL - may have iframe issues');
            // Show a warning after a short delay
            setTimeout(() => {
              const iframe = document.getElementById("gameFrameEmbed");
              if (iframe && iframe.src && !iframe.contentDocument) {
                console.warn('External resource game not loading properly, showing fallback');
                showRedirectFallback(gameUrl);
              }
            }, 5000);
          }
        } catch (error) {
          console.warn('Could not check game resources:', error);
        }
      }

      // Global functions for fallback buttons
      window.redirectToGame = function(gameUrl) {
        // Convert back to directory path for redirect
        let redirectUrl = gameUrl;
        if (redirectUrl.endsWith('/index.html')) {
          redirectUrl = redirectUrl.replace('/index.html', '/');
        }
        
        console.log('Auto-redirecting to game directory:', redirectUrl);
        window.open(redirectUrl, '_blank');
        
        // Track the auto-redirect
        trackGameActivity(currentGameId, 'auto-redirected');
        hideIframeLoadingState();
      };

      window.retryIframeLoad = function(gameUrl) {
        console.log('Retrying iframe load for:', gameUrl);
        const iframe = document.getElementById("gameFrameEmbed");
        hideIframeLoadingState();
        iframe.src = '';
        setTimeout(() => {
          setupIframeErrorDetection(gameUrl, iframe);
          iframe.src = gameUrl;
        }, 1000);
      };

    function renderGameInfoBox(game, tableId) {
      const el = document.getElementById(tableId);
      if (!el) return;
      
      const developer = escapeHtml(game.developer) || "Unknown";
      const release = escapeHtml(game.release) || "Unknown";
      const technology = escapeHtml(game.technology) || "Unknown";
      const controls = escapeHtml(game.controls) || "See in-game";
      
      let platformsHtml = "Unknown";
      if (Array.isArray(game.platforms)) {
        platformsHtml = game.platforms.map(p => 
          `<span class="px-2 py-[2px] rounded-full text-xs font-semibold" style="background: var(--theme-overlay); color: var(--theme-foam);">${escapeHtml(p)}</span>`
        ).join('');
      } else if (game.platforms) {
        platformsHtml = escapeHtml(game.platforms);
      }
      
      el.innerHTML = `
        <tr>
          <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Developer</th>
          <td class="py-1">${developer}</td>
        </tr>
        <tr>
          <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Release</th>
          <td class="py-1">${release}</td>
        </tr>
        <tr>
          <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Technology</th>
          <td class="py-1">${technology}</td>
        </tr>
        <tr>
          <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Platforms</th>
          <td class="flex flex-wrap gap-2 py-1">
            ${platformsHtml}
          </td>
        </tr>
        <tr>
          <th class="pr-4 py-1 text-cyan-400 font-semibold align-top">Controls</th>
          <td class="py-1">${controls}</td>
        </tr>
      `;
    }

    // Load comments from Firebase
    async function loadComments(gameId, loadMore = false) {
      if (!gameId) return;
      
      commentsData.loading = true;
      updateCommentsUI();
      
      try {
        let commentsQuery = db.collection("games").doc(gameId).collection("comments")
          .orderBy("createdAt", "desc")
          .limit(commentsData.commentsPerPage);
        
        if (loadMore && commentsData.lastVisible) {
          commentsQuery = db.collection("games").doc(gameId).collection("comments")
            .orderBy("createdAt", "desc")
            .startAfter(commentsData.lastVisible)
            .limit(commentsData.commentsPerPage);
        }
        
        const snapshot = await commentsQuery.get();
        
        if (loadMore) {
          snapshot.forEach(doc => {
            commentsData.comments.push({ id: doc.id, ...doc.data() });
          });
        } else {
          commentsData.comments = [];
          snapshot.forEach(doc => {
            commentsData.comments.push({ id: doc.id, ...doc.data() });
          });
        }
        
        commentsData.lastVisible = snapshot.docs[snapshot.docs.length - 1] || null;
        
        // Load replies for each comment
        for (let comment of commentsData.comments) {
          if (!comment.replies) {
            const repliesQuery = db.collection("games").doc(gameId).collection("comments").doc(comment.id).collection("replies")
              .orderBy("createdAt", "asc");
            const repliesSnapshot = await repliesQuery.get();
            
            comment.replies = [];
            repliesSnapshot.forEach(replyDoc => {
              comment.replies.push({ id: replyDoc.id, ...replyDoc.data() });
            });
          }
        }
        
      } catch (error) {
        console.error("Error loading comments:", error);
      }
      
      commentsData.loading = false;
      updateCommentsUI();
    }

    // Submit new comment
    async function submitComment() {
      const user = auth.currentUser;
      const text = document.getElementById('commentText').value.trim();
      
      if (!user) {
        alert('Please sign in to comment');
        return;
      }
      
      if (!text) {
        alert('Please enter a comment');
        return;
      }
      
      if (!currentGameId) {
        alert('Game not loaded');
        return;
      }
      
      const sanitizedText = sanitizeText(text, 1000);
      if (!sanitizedText) {
        alert('Invalid comment text');
        return;
      }
      
      const validatedGameId = validateGameId(currentGameId);
      if (!validatedGameId) {
        alert('Invalid game ID');
        return;
      }
      
      try {
        const commentData = {
          text: sanitizedText,
          rating: commentsData.currentCommentRating || null,
          authorId: user.uid,
          authorName: user.displayName || 'Anonymous',
          authorPhoto: user.photoURL || '/default-avatar.png',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          reactions: {},
          reactionCounts: {}
        };
        
        const docRef = await db.collection("games").doc(validatedGameId).collection("comments").add(commentData);
        
        // Reset form
        document.getElementById('commentText').value = '';
        commentsData.currentCommentRating = 0;
        updateCommentStarInput();
        updateSubmitButtonState();
        
        // Reload comments
        await loadComments(validatedGameId);
        
      } catch (error) {
        console.error("Error submitting comment:", error);
        alert('Failed to submit comment. Please try again.');
      }
    }

    function updateCommentsUI() {
      const commentsLoader = document.getElementById('commentsLoader');
      const noComments = document.getElementById('noComments');
      const commentsList = document.getElementById('commentsList');
      const commentsCount = document.getElementById('commentsCount');
      
      if (commentsData.loading) {
        if (commentsLoader) commentsLoader.classList.remove('hidden');
        if (noComments) noComments.classList.add('hidden');
        return;
      }
      
      if (commentsLoader) commentsLoader.classList.add('hidden');
      
      if (commentsData.comments.length === 0) {
        if (noComments) noComments.classList.remove('hidden');
        if (commentsList) commentsList.innerHTML = '';
      } else {
        if (noComments) noComments.classList.add('hidden');
        renderComments();
      }
      
      if (commentsCount) {
        commentsCount.textContent = `(${commentsData.comments.length})`;
      }
    }

    function renderComments() {
      const commentsList = document.getElementById('commentsList');
      if (!commentsList) return;
      
      const filteredComments = commentsData.comments.filter(comment => {
        if (commentsData.currentFilter === 'all') return true;
        if (commentsData.currentFilter === 'no-rating') return !comment.rating;
        return comment.rating && comment.rating.toString() === commentsData.currentFilter;
      });
      
      commentsList.innerHTML = filteredComments.map(comment => {
        const stars = comment.rating ? '★'.repeat(comment.rating) + '☆'.repeat(5 - comment.rating) : '';
        return `
          <div class="comment-item bg-white/5 rounded-lg p-4 border border-white/10">
            <div class="flex items-start gap-3">
              <img src="${comment.authorPhoto || '/default-avatar.png'}" class="w-8 h-8 rounded-full flex-shrink-0" alt="${comment.authorName}">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="font-medium text-sm" style="color: var(--theme-foam);">${comment.authorName}</span>
                  ${comment.rating ? `<span class="comment-stars text-xs" style="color: var(--theme-gold);">${stars}</span>` : ''}
                  <span class="text-xs" style="color: var(--theme-muted);">${formatDate(comment.createdAt)}</span>
                </div>
                <p class="text-white/80 text-sm mb-3">${escapeHtml(comment.text)}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'Just now';
      let date;
      if (timestamp && timestamp.toDate) {
        date = timestamp.toDate();
      } else if (timestamp && timestamp.seconds) {
        date = new Date(timestamp.seconds * 1000);
      } else {
        return 'Just now';
      }
      
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor(diff / (1000 * 60));
      
      if (days > 0) return `${days}d ago`;
      if (hours > 0) return `${hours}h ago`;
      if (minutes > 0) return `${minutes}m ago`;
      return 'Just now';
    }

    function updateSubmitButtonState() {
      const submitBtn = document.getElementById('submitComment');
      const commentText = document.getElementById('commentText');
      
      if (submitBtn && commentText) {
        const hasText = commentText.value.trim().length > 0;
        submitBtn.disabled = !hasText;
      }
    }

    function sanitizeText(text, maxLength = 10000) {
      if (!text) return '';
      return text.replace(/\0/g, '').substring(0, maxLength);
    }

    // Suggested games functionality
    async function loadSuggestedGames() {
      if (!gamesData || !currentGame) return;
      
      try {
        // Get games from same category or similar tags
        let suggested = gamesData.filter(game => 
          game.id !== currentGame.id && 
          (game.category === currentGame.category || 
           (game.tags && currentGame.tags && 
            game.tags.some(tag => currentGame.tags.includes(tag))))
        );
        
        // If not enough, get random games
        if (suggested.length < 6) {
          const randomGames = gamesData
            .filter(game => game.id !== currentGame.id && !suggested.includes(game))
            .sort(() => Math.random() - 0.5)
            .slice(0, 6 - suggested.length);
          suggested = [...suggested, ...randomGames];
        }
        
        // Limit to 6 games
        suggested = suggested.slice(0, 6);
        
        renderSuggestedGames(suggested);
        
      } catch (error) {
        console.error('Error loading suggested games:', error);
      }
    }

    function renderSuggestedGames(games) {
      const container = document.getElementById('suggestedGamesList');
      if (!container || !games.length) return;
      
      container.innerHTML = games.map(game => `
        <div class="flex-shrink-0 w-48 mr-4 cursor-pointer suggested-game-card" onclick="window.location.href='play.html?id=${game.id}'">
          <div class="bg-white/10 rounded-lg overflow-hidden hover:bg-white/20 transition-all duration-300">
            <img src="${game.image}" alt="${game.title}" class="w-full h-32 object-cover">
            <div class="p-3">
              <h4 class="font-semibold text-sm mb-1" style="color: var(--theme-text);">${game.title}</h4>
              <p class="text-xs" style="color: var(--theme-muted);">${game.category}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Tag and category functions
    function renderTagsAreaFrame(currentGame) {
      const el = document.getElementById('tagsAreaFrame');
      if (!el) return;
      if (!currentGame || !currentGame.tags || !currentGame.tags.length) {
        el.innerHTML = "";
        return;
      }
      
      el.innerHTML = currentGame.tags.map(tag => {
        const sanitizedTag = escapeHtml(tag);
        return `
          <button type="button"
            class="tag-btn inline-block px-3 py-1 text-xs rounded-full border transition font-semibold" 
            style="background: linear-gradient(to right, rgba(156, 207, 216, 0.2), rgba(196, 167, 231, 0.2)); color: var(--theme-foam); border-color: rgba(156, 207, 216, 0.3);"
            >
            ${sanitizedTag.charAt(0).toUpperCase() + sanitizedTag.slice(1)}
          </button>
        `;
      }).join('');
    }

    function renderCategoryGamesCountFrame(currentGame) {
      const el = document.getElementById('categoryGamesCountFrame');
      if (!el || !currentGame || !currentGame.category) {
        if (el) el.textContent = "";
        return;
      }
      const cat = currentGame.category;
      const count = gamesData.filter(g => g.category === cat).length;
      el.textContent = `${cat.charAt(0).toUpperCase() + cat.slice(1)} (${count}) games`;
    }

    // Game initialization for direct JSON loading
    async function initializeGame() {
      const gameId = getGameIdFromURL();
      if (!gameId) {
        alert('No game ID provided');
        window.location.href = '../games.html';
        return;
      }

      try {
        console.log('Initializing game with ID:', gameId);
        await loadGamesData();
        
        currentGameId = gameId;
        currentGame = gamesData.find(g => String(g.id) === String(gameId));
        
        if (!currentGame) {
          alert('Game not found in JSON data');
          window.location.href = '../games.html';
          return;
        }

        console.log('Found game:', currentGame.title);

        // Update UI with game info
        document.getElementById('gameTitleDisplay').textContent = currentGame.title;
        document.getElementById('gameFrameDesc').textContent = currentGame.description;
        document.getElementById('gameCoverImg').src = currentGame.image;
        
        // Set category tag
        if (currentGame.category) {
          document.getElementById('gameCategoryTag').textContent = currentGame.category.charAt(0).toUpperCase() + currentGame.category.slice(1);
        }
        
        // Set featured tag
        if (currentGame.featured) {
          document.getElementById('gameFeaturedTag').classList.remove('hidden');
        }

        // Render game info box
        renderGameInfoBox(currentGame, 'gameInfoTable');

        // Update frame sections too
        document.getElementById('gameTitleDisplayFrame').textContent = currentGame.title;
        renderGameInfoBox(currentGame, 'gameInfoTableFrame');
        renderTagsAreaFrame(currentGame);
        renderCategoryGamesCountFrame(currentGame);

        // Set up play button
        document.getElementById('bigPlayBtn').addEventListener('click', function() {
          console.log('Play button clicked, loading game...');
          document.getElementById('gameInfoHolder').style.display = 'none';
          document.getElementById('gameFrameContainer').classList.remove('hidden');
          loadDirectGameIframe();
        });

        // Set up fullscreen button
        document.getElementById('fullscreenBtn').addEventListener('click', function() {
          const gameFrame = document.getElementById('gameFrameEmbed');
          requestFullScreen(gameFrame);
        });

        // Set up game action buttons
        setupGameActionButtons();

        // Set up comment event listeners
        setupCommentEventListeners();

        // Load star rating
        await loadStarRating(currentGameId);

        // Initialize comments
        initCommentStarInput();
        await loadComments(currentGameId);
        
        // Set up suggested games
        await loadSuggestedGames();

        // Hide preloader
        document.getElementById('preloader').style.display = 'none';

      } catch (error) {
        console.error('Error initializing game:', error);
        alert('Error loading game: ' + error.message);
        window.location.href = '../games.html';
      }
    }

    function setupGameActionButtons() {
      // Like button
      document.getElementById('likeBtn').addEventListener('click', async function() {
        if (!auth.currentUser) {
          showSignInModal('like games');
          return;
        }
        
        try {
          const userRef = db.collection('users').doc(auth.currentUser.uid);
          const doc = await userRef.get();
          const userData = doc.data() || {};
          const likedGames = userData.likedGames || [];
          
          if (likedGames.includes(currentGameId)) {
            // Remove like
            await userRef.update({
              likedGames: firebase.firestore.FieldValue.arrayRemove(currentGameId)
            });
            this.classList.remove('liked');
          } else {
            // Add like
            await userRef.update({
              likedGames: firebase.firestore.FieldValue.arrayUnion(currentGameId)
            });
            this.classList.add('liked');
          }
        } catch (error) {
          console.error('Error toggling like:', error);
        }
      });

      // Favorite button
      document.getElementById('favBtn').addEventListener('click', async function() {
        if (!auth.currentUser) {
          showSignInModal('favorite games');
          return;
        }
        
        try {
          const userRef = db.collection('users').doc(auth.currentUser.uid);
          const doc = await userRef.get();
          const userData = doc.data() || {};
          const favoriteGames = userData.favoriteGames || [];
          
          if (favoriteGames.includes(currentGameId)) {
            // Remove favorite
            await userRef.update({
              favoriteGames: firebase.firestore.FieldValue.arrayRemove(currentGameId)
            });
            this.classList.remove('favorited');
          } else {
            // Add favorite
            await userRef.update({
              favoriteGames: firebase.firestore.FieldValue.arrayUnion(currentGameId)
            });
            this.classList.add('favorited');
          }
        } catch (error) {
          console.error('Error toggling favorite:', error);
        }
      });

      // Share button
      document.getElementById('shareBtn').addEventListener('click', function() {
        const gameUrl = window.location.href;
        navigator.clipboard.writeText(gameUrl).then(() => {
          alert('Game link copied to clipboard!');
        }).catch(() => {
          alert('Failed to copy link');
        });
      });

      // Playlist button
      document.getElementById('playlistBtn').addEventListener('click', async function() {
        if (!auth.currentUser) {
          showSignInModal('add games to your playlist');
          return;
        }
        
        try {
          const userRef = db.collection('users').doc(auth.currentUser.uid);
          const doc = await userRef.get();
          const userData = doc.data() || {};
          const playlist = userData.playlist || [];
          
          if (playlist.includes(currentGameId)) {
            // Remove from playlist
            await userRef.update({
              playlist: firebase.firestore.FieldValue.arrayRemove(currentGameId)
            });
            this.classList.remove('in-playlist');
            alert('Removed from playlist');
          } else {
            // Add to playlist
            await userRef.update({
              playlist: firebase.firestore.FieldValue.arrayUnion(currentGameId)
            });
            this.classList.add('in-playlist');
            alert('Added to playlist');
          }
        } catch (error) {
          console.error('Error toggling playlist:', error);
        }
      });

      // Redirect button - Open game in new tab and track activity
      document.getElementById('redirectBtn').addEventListener('click', async function() {
        if (!currentGame) {
          console.error('No current game to redirect to');
          return;
        }

        console.log('Redirect button clicked for game:', currentGame.title);
        
        try {
          // Track the redirect activity for profile integration (only for signed-in users)
          if (auth.currentUser) {
            await window.trackGameStart(currentGameId);
          }
          
          // Get the game URL and convert it for direct access
          let gameUrl = currentGame.url;
          
          // Convert the JSON URL path to direct path
          // Original: "./games/amaze/index.html" 
          // Convert to: "./amaze/" (remove index.html and games prefix)
          if (gameUrl.startsWith('./games/')) {
            gameUrl = gameUrl.replace('./games/', './');
            // Remove index.html to get directory
            if (gameUrl.endsWith('/index.html')) {
              gameUrl = gameUrl.replace('/index.html', '/');
            }
          }
          
          console.log('Redirecting to game directory:', gameUrl);
          
          // Open in new tab
          window.open(gameUrl, '_blank');
          
          // Track the redirect as a play action for profile (only for signed-in users)
          if (auth.currentUser) {
            await trackGameActivity(currentGameId, 'redirected');
            
            // Update play count for profile integration
            await updatePlayCount(currentGameId);
          }
          
          // Keep the user status as ingame for a bit then back to online (only for signed-in users)
          if (auth.currentUser) {
            setTimeout(async () => {
              await window.trackGameEnd();
            }, 5000); // 5 seconds delay
          }
          
        } catch (error) {
          console.error('Error handling redirect:', error);
        }
      });
    }

    function setupCommentEventListeners() {
      // Comment text character count
      const commentText = document.getElementById('commentText');
      const commentCharCount = document.getElementById('commentCharCount');
      
      if (commentText && commentCharCount) {
        commentText.addEventListener('input', function() {
          const length = this.value.length;
          commentCharCount.textContent = `${length}/1000`;
          updateSubmitButtonState();
        });
      }

      // Submit comment button
      const submitComment = document.getElementById('submitComment');
      if (submitComment) {
        submitComment.addEventListener('click', async function() {
          await window.submitComment();
        });
      }

      // Comment filter
      const commentFilter = document.getElementById('commentFilter');
      if (commentFilter) {
        commentFilter.addEventListener('change', function() {
          commentsData.currentFilter = this.value;
          renderComments();
        });
      }

      // Cancel comment button
      const cancelComment = document.getElementById('cancelComment');
      if (cancelComment) {
        cancelComment.addEventListener('click', function() {
          document.getElementById('commentText').value = '';
          commentsData.currentCommentRating = 0;
          updateCommentStarInput();
          updateSubmitButtonState();
        });
      }
    }

    // Modal functions (stubs for compatibility)
    function closeReplyModal() {
      const modal = document.getElementById('replyModal');
      if (modal) modal.classList.add('hidden');
    }

    // --- PROFILE INTEGRATION FUNCTIONS ---
    // Status tracking and colors (matching profile.html)
    const statusColors = {
      online: 'bg-green-500',
      idle: 'bg-yellow-500', 
      dnd: 'bg-red-500',
      offline: 'bg-gray-500',
      ingame: 'bg-blue-500'
    };

    async function updateUserStatus(status, gameId = null) {
      if (!auth.currentUser) return;
      
      try {
        const updateData = {
          status: status,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (gameId) {
          updateData.currentGame = gameId;
          updateData.status = 'ingame';
        } else if (!gameId && status !== 'ingame') {
          updateData.currentGame = null;
        }
        
        await db.collection('users').doc(auth.currentUser.uid).update(updateData);
        
        // Save status to localStorage for persistence across refreshes
        localStorage.setItem('carbon-user-status', status);
        localStorage.setItem('carbon-user-status-timestamp', Date.now().toString());
        
      } catch (error) {
        console.error('Error updating status:', error);
      }
    }

    // Track game activity for activity feed
    async function trackGameActivity(gameId, action = 'played') {
      if (!auth.currentUser || !gameId) return;
      
      try {
        const game = gamesData.find(g => String(g.id) === String(gameId));
        if (!game) return;
        
        const activityData = {
          userId: auth.currentUser.uid,
          userName: sanitizeText(auth.currentUser.displayName || 'Anonymous'),
          userPhoto: auth.currentUser.photoURL || '/default-avatar.png',
          gameId: gameId,
          gameTitle: sanitizeText(game.title),
          gameImage: game.image || '/default-game.png',
          action: action,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('activity').add(activityData);
        
        // Update user's last played game
        await db.collection('users').doc(auth.currentUser.uid).update({
          lastPlayedGame: gameId,
          lastPlayedTime: firebase.firestore.FieldValue.serverTimestamp()
        });
        
      } catch (error) {
        console.error('Error tracking game activity:', error);
      }
    }

    // Update play count for profile integration
    async function updatePlayCount(gameId) {
      if (!auth.currentUser || !gameId) return;
      
      try {
        const userRef = db.collection('users').doc(auth.currentUser.uid);
        const gameStatsRef = userRef.collection('gameStats').doc(gameId);
        
        // Get current stats
        const statsDoc = await gameStatsRef.get();
        const currentStats = statsDoc.exists ? statsDoc.data() : {};
        
        // Update play count and total time
        const updateData = {
          gameId: gameId,
          playCount: (currentStats.playCount || 0) + 1,
          totalPlayTime: (currentStats.totalPlayTime || 0),
          lastPlayed: firebase.firestore.FieldValue.serverTimestamp(),
          firstPlayed: currentStats.firstPlayed || firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await gameStatsRef.set(updateData, { merge: true });
        
        // Also update user's total stats
        await userRef.update({
          totalGamesPlayed: firebase.firestore.FieldValue.increment(1),
          lastActivity: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('Play count updated for game:', gameId);
        
      } catch (error) {
        console.error('Error updating play count:', error);
      }
    }

    // Session tracking for play time
    let gameSessionStart = null;

    // Functions for profile.html integration
    window.trackGameStart = async function(gameId) {
      if (!auth.currentUser) {
        console.log('Anonymous user - skipping profile tracking');
        return;
      }
      
      gameSessionStart = new Date();
      await updateUserStatus('ingame', gameId);
      await trackGameActivity(gameId, 'started');
      console.log('Game session started for:', gameId);
    };

    window.trackGameEnd = async function() {
      if (!auth.currentUser) {
        console.log('Anonymous user - skipping profile tracking');
        return;
      }
      
      if (gameSessionStart && currentGameId) {
        const sessionEnd = new Date();
        const sessionDuration = Math.round((sessionEnd - gameSessionStart) / 1000); // seconds
        
        // Update session duration in game stats
        await updateSessionDuration(currentGameId, sessionDuration);
        
        // Track the end activity
        await trackGameActivity(currentGameId, 'ended');
        
        console.log('Game session ended. Duration:', sessionDuration, 'seconds');
      }
      
      gameSessionStart = null;
      await updateUserStatus('online');
    };

    // Update session duration for detailed profile stats
    async function updateSessionDuration(gameId, duration) {
      if (!auth.currentUser || !gameId || !duration) return;
      
      try {
        const userRef = db.collection('users').doc(auth.currentUser.uid);
        const gameStatsRef = userRef.collection('gameStats').doc(gameId);
        
        // Get current stats
        const statsDoc = await gameStatsRef.get();
        const currentStats = statsDoc.exists ? statsDoc.data() : {};
        
        // Update total play time
        const newTotalTime = (currentStats.totalPlayTime || 0) + duration;
        const sessions = (currentStats.sessions || 0) + 1;
        
        await gameStatsRef.update({
          totalPlayTime: newTotalTime,
          sessions: sessions,
          averageSessionTime: Math.round(newTotalTime / sessions),
          lastSessionDuration: duration,
          lastPlayed: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update user's total play time
        await userRef.update({
          totalPlayTime: firebase.firestore.FieldValue.increment(duration)
        });
        
        console.log(`Session duration updated: ${duration}s for game ${gameId}`);
        
      } catch (error) {
        console.error('Error updating session duration:', error);
      }
    }

    // Restore user's saved status or set to online
    async function restoreUserStatus() {
      if (!auth.currentUser) return;
      
      try {
        // Get saved status from localStorage
        const savedStatus = localStorage.getItem('carbon-user-status');
        const savedTimestamp = parseInt(localStorage.getItem('carbon-user-status-timestamp') || '0');
        const currentTime = Date.now();
        const statusAge = currentTime - savedTimestamp;
        
        // If status is less than 1 hour old, restore it. Otherwise default to online.
        const validStatuses = ['online', 'idle', 'dnd'];
        let statusToRestore = 'online';
        
        if (savedStatus && validStatuses.includes(savedStatus) && statusAge < 3600000) { // 1 hour = 3600000ms
          statusToRestore = savedStatus;
        }
        
        await updateUserStatus(statusToRestore);
        
        // Set user offline when page unloads - use multiple reliable methods
        setupOfflineDetection();
        
        // Periodic heartbeat - maintain current status (not force online)
        setInterval(async () => {
          if (auth.currentUser && document.visibilityState === 'visible') {
            const currentStatus = localStorage.getItem('carbon-user-status') || 'online';
            await updateUserStatus(currentStatus);
          }
        }, 30000); // Update every 30 seconds
        
      } catch (error) {
        console.error('Error restoring user status:', error);
        // Fallback to online if there's an error
        await updateUserStatus('online');
      }
    }

    function setupOfflineDetection() {
      if (!auth.currentUser) return;
      
      const goOffline = async () => {
        if (auth.currentUser) {
          await updateUserStatus('offline');
        }
      };
      
      // Listen for page unload
      window.addEventListener('beforeunload', goOffline);
      window.addEventListener('unload', goOffline);
      
      // Listen for visibility change (tab switch/minimize)
      document.addEventListener('visibilitychange', async () => {
        if (document.hidden) {
          // User switched tab/minimized - wait before going offline
          setTimeout(async () => {
            if (document.hidden && auth.currentUser) {
              await updateUserStatus('idle');
            }
          }, 60000); // 1 minute delay
        } else {
          // User came back - restore status
          if (auth.currentUser) {
            const savedStatus = localStorage.getItem('carbon-user-status') || 'online';
            if (savedStatus !== 'offline') {
              await updateUserStatus(savedStatus);
            }
          }
        }
      });
    }

    // --- CHAT FUNCTIONALITY ---
    let chatIsOpen = false;

    function toggleChat() {
      if (!auth.currentUser) {
        showSignInModal('access chat features');
        return;
      }
      
      if (chatIsOpen) {
        closeChat();
      } else {
        openChat();
      }
    }

    function openChat() {
      const modal = document.getElementById('chatModal');
      const icon = document.getElementById('chatIcon');
      
      if (modal) {
        modal.classList.remove('hidden');
        chatIsOpen = true;
        
        // Change icon to indicate it's open
        if (icon) {
          icon.classList.remove('bx-message-dots');
          icon.classList.add('bx-x');
        }
        
        // Focus the chat iframe
        const iframe = document.getElementById('chatFrame');
        if (iframe) {
          iframe.focus();
        }
      }
    }

    function closeChat() {
      const modal = document.getElementById('chatModal');
      const icon = document.getElementById('chatIcon');
      
      if (modal) {
        modal.classList.add('hidden');
        chatIsOpen = false;
        
        // Restore original icon
        if (icon) {
          icon.classList.remove('bx-x');
          icon.classList.add('bx-message-dots');
        }
      }
    }

    // Close chat when clicking outside the modal content
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('chatModal');
      const chatContent = modal?.querySelector('div');
      
      if (modal && !modal.classList.contains('hidden') && 
          e.target === modal && !chatContent?.contains(e.target)) {
        closeChat();
      }
    });

    // Close chat with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && chatIsOpen) {
        closeChat();
      }
    });

    // UI state management for signed-in vs anonymous users
    function updateUIForSignedInUser() {
      console.log('Updating UI for signed-in user - all features enabled');
      
      // Show user info
      document.getElementById('loginBtn').style.display = 'none';
      
      // Enable all interactive features
      enableAdvancedFeatures();
      
      // Update action buttons to show full functionality
      updateActionButtonsForSignedUser();
      
      // Show comments section with full functionality
      updateCommentsForSignedUser();
    }

    function updateUIForAnonymousUser() {
      console.log('Updating UI for anonymous user - basic play only');
      
      // Show sign-in prompt but don't block game play
      showSignInPrompts();
      
      // Disable advanced features but keep game playable
      disableAdvancedFeatures();
      
      // Update action buttons to show sign-in requirements
      updateActionButtonsForAnonymous();
      
      // Show comments in read-only mode
      updateCommentsForAnonymous();
    }

    function enableAdvancedFeatures() {
      // Enable star rating interaction
      const starContainers = document.querySelectorAll('#starsContainer, #starsContainerFrame');
      starContainers.forEach(container => {
        container.classList.remove('pointer-events-none', 'opacity-50');
      });
      
      // Enable comment submission
      const commentForm = document.getElementById('addCommentForm');
      if (commentForm) {
        commentForm.classList.remove('opacity-50', 'pointer-events-none');
      }
      
      // Enable chat
      const chatBtn = document.getElementById('chatFloatingBtn');
      if (chatBtn) {
        chatBtn.classList.remove('opacity-50', 'pointer-events-none');
      }
    }

    function disableAdvancedFeatures() {
      // Disable star rating interaction for anonymous users
      const starContainers = document.querySelectorAll('#starsContainer, #starsContainerFrame');
      starContainers.forEach(container => {
        container.classList.add('pointer-events-none');
        // Add sign-in hint
        if (!container.querySelector('.signin-hint')) {
          const hint = document.createElement('div');
          hint.className = 'signin-hint text-xs text-gray-400 mt-1';
          hint.textContent = 'Sign in to rate games';
          container.parentElement.appendChild(hint);
        }
      });
      
      // Keep chat available but show sign-in requirement when clicked
    }

    function updateActionButtonsForSignedUser() {
      // All action buttons work normally for signed-in users
      const actionButtons = document.querySelectorAll('.game-action-btn');
      actionButtons.forEach(btn => {
        btn.classList.remove('opacity-50');
        btn.title = btn.title.replace(' (Sign in required)', '');
      });
    }

    function updateActionButtonsForAnonymous() {
      // Show sign-in requirement for interactive buttons
      const interactiveButtons = ['likeBtn', 'favBtn', 'playlistBtn'];
      interactiveButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.classList.add('opacity-75');
          btn.title = btn.title + ' (Sign in required)';
        }
      });
      
      // Keep redirect button fully functional
      const redirectBtn = document.getElementById('redirectBtn');
      if (redirectBtn) {
        redirectBtn.classList.remove('opacity-50');
      }
    }

    function updateCommentsForSignedUser() {
      // Comments work normally for signed-in users
      const addCommentForm = document.getElementById('addCommentForm');
      if (addCommentForm) {
        addCommentForm.classList.remove('hidden');
      }
      
      // Remove any sign-in prompts
      const signinPrompts = document.querySelectorAll('.comments-signin-prompt');
      signinPrompts.forEach(prompt => prompt.remove());
    }

    function updateCommentsForAnonymous() {
      // Show read-only comments with sign-in prompt
      const addCommentForm = document.getElementById('addCommentForm');
      if (addCommentForm) {
        addCommentForm.style.display = 'none';
        
        // Add sign-in prompt for commenting
        if (!document.getElementById('commentsSigninPrompt')) {
          const signinPrompt = document.createElement('div');
          signinPrompt.id = 'commentsSigninPrompt';
          signinPrompt.className = 'comments-signin-prompt bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 mb-6';
          signinPrompt.innerHTML = `
            <div class="flex items-center gap-3">
              <i class="bx bx-user-plus text-2xl text-blue-400"></i>
              <div class="flex-1">
                <h4 class="font-semibold text-blue-400 mb-1">Join the Conversation</h4>
                <p class="text-gray-300 text-sm">Sign in to rate games, leave comments, and track your gaming activity!</p>
              </div>
              <button onclick="googleSignIn()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg font-semibold transition-colors">
                Sign In
              </button>
            </div>
          `;
          addCommentForm.parentElement.insertBefore(signinPrompt, addCommentForm);
        }
      }
    }

    function showSignInPrompts() {
      // Add a subtle sign-in banner at the top
      if (!document.getElementById('topSigninBanner')) {
        const banner = document.createElement('div');
        banner.id = 'topSigninBanner';
        banner.className = 'bg-gradient-to-r from-blue-600/20 to-purple-600/20 border-b border-blue-500/30 p-3';
        banner.innerHTML = `
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
              <i class="bx bx-info-circle text-blue-400"></i>
              <span class="text-white text-sm">
                <strong>Playing as Guest</strong> - Sign in to unlock ratings, comments, and progress tracking!
              </span>
            </div>
            <button onclick="googleSignIn()" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
              Sign In
            </button>
          </div>
        `;
        document.body.insertBefore(banner, document.body.firstChild);
      }
    }

    // Show sign-in modal for specific actions
    function showSignInModal(action) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-[10001] bg-black/70 flex items-center justify-center';
      modal.innerHTML = `
        <div class="bg-gray-800 rounded-xl p-6 max-w-md mx-4 shadow-2xl border border-blue-500/30">
          <div class="text-center">
            <i class="bx bx-user-plus text-5xl text-blue-400 mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">Sign In Required</h3>
            <p class="text-gray-300 mb-6">You need to sign in to ${action}. Don't worry, you can still play games as a guest!</p>
            <div class="flex gap-3 justify-center">
              <button onclick="googleSignIn(); this.closest('.fixed').remove();" 
                      class="bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-lg font-semibold transition-colors text-white">
                <i class="bx bx-user mr-2"></i>
                Sign In with Google
              </button>
              <button onclick="this.closest('.fixed').remove();" 
                      class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold transition-colors text-white">
                Continue as Guest
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Close on escape key
      const closeOnEscape = (e) => {
        if (e.key === 'Escape') {
          modal.remove();
          document.removeEventListener('keydown', closeOnEscape);
        }
      };
      document.addEventListener('keydown', closeOnEscape);
    }

    // Expose functions to global scope
    window.submitComment = submitComment;
    window.closeReplyModal = closeReplyModal;
    window.updateUserStatus = updateUserStatus;
    window.trackGameActivity = trackGameActivity;
    window.updatePlayCount = updatePlayCount;
    window.updateSessionDuration = updateSessionDuration;
    window.toggleChat = toggleChat;
    window.openChat = openChat;
    window.closeChat = closeChat;
    // Iframe fallback functions are exposed in their definitions above

    // Initialize when DOM is loaded - MAIN ENTRY POINT
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up auth state listener...');
      
      auth.onAuthStateChanged(async (user) => {
        console.log('Auth state changed:', user ? 'Logged in' : 'Not logged in');
        
        if (user) {
          document.getElementById('loginScreen').style.display = 'none';
          await ensureUserDoc(user);
          renderUserSection(user);
          console.log('User authenticated, restoring status and initializing game...');
          await restoreUserStatus();
          await initializeGame();
          updateUIForSignedInUser();
        } else {
          // Allow anonymous game playing
          document.getElementById('loginScreen').style.display = 'none';
          console.log('No user signed in, allowing anonymous game play...');
          await initializeGame();
          updateUIForAnonymousUser();
        }
      });
    });

    // Profile integration functions for compatibility
    window.trackGameStart = async function(gameId) {
      console.log('Tracking game start:', gameId);
      if (auth.currentUser) {
        try {
          await db.collection('users').doc(auth.currentUser.uid).update({
            [`gameStats.${gameId}.plays`]: firebase.firestore.FieldValue.increment(1),
            [`gameStats.${gameId}.lastPlayed`]: firebase.firestore.FieldValue.serverTimestamp(),
            lastPlayedGame: gameId,
            lastPlayedTime: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (error) {
          console.error('Error tracking game start:', error);
        }
      }
    };

    window.trackGameEnd = async function() {
      console.log('Tracking game end');
      // Can be used for session tracking
    };

    // Function to hide preloader
    function hidePreloader() {
      document.getElementById('preloader').style.display = 'none';
    }

    // Set button active state
    function setButtonActive(btn, isActive, activeClass='liked') {
      btn.classList.remove('liked', 'favorited', 'in-playlist');
      if (isActive) {
        if (btn.id === 'likeBtn') {
          btn.classList.add('liked');
        } else if (btn.id === 'favBtn') {
          btn.classList.add('favorited');
        } else if (btn.id === 'playlistBtn') {
          btn.classList.add('in-playlist');
        } else {
          btn.classList.add(activeClass);
        }
      }
    }

    console.log('CARBON Games - Direct JSON Loading System Initialized');
    console.log('This version loads all 67 games directly from JSON without proxies');
    
  </script>

</body>
</html>
