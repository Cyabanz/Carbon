<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Profile - CARBON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="carbon-theme.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    // Tailwind config will be dynamically updated by the enhanced theme system
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'rp-base': '#191724',
            'rp-surface': '#1f1d2e',
            'rp-overlay': '#26233a',
            'rp-muted': '#6e6a86',
            'rp-subtle': '#908caa',
            'rp-text': '#e0def4',
            'rp-love': '#eb6f92',
            'rp-gold': '#f6c177',
            'rp-rose': '#ebbcba',
            'rp-pine': '#31748f',
            'rp-foam': '#9ccfd8',
            'rp-iris': '#c4a7e7',
            'rp-highlight-low': '#21202e',
            'rp-highlight-med': '#403d52',
            'rp-highlight-high': '#524f67'
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --text-color: #e0def4;
      --surface-color: #1f1d2e;
      --overlay-color: #26233a;
      --highlight-med: #403d52;
      --highlight-high: #524f67;
      --foam: #9ccfd8;
      --love: #eb6f92;
      --gold: #f6c177;
      --pine: #31748f;
      --iris: #c4a7e7;
      --muted: #6e6a86;
      --subtle: #908caa;

      /* Theme variables - Rose Pine (default) */
      --theme-base: #191724;
      --theme-surface: #1f1d2e;
      --theme-overlay: #26233a;
      --theme-muted: #6e6a86;
      --theme-subtle: #908caa;
      --theme-text: #e0def4;
      --theme-love: #eb6f92;
      --theme-gold: #f6c177;
      --theme-rose: #ebbcba;
      --theme-pine: #31748f;
      --theme-foam: #9ccfd8;
      --theme-iris: #c4a7e7;
      --theme-highlight-low: #21202e;
      --theme-highlight-med: #403d52;
      --theme-highlight-high: #524f67;
      --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
    }
    
    body {
      background: var(--theme-gradient);
      background-attachment: fixed;
    }
    
    /* Add all theme variations */
    [data-theme="dark"] {
      --theme-base: #0f172a;
      --theme-surface: #1e293b;
      --theme-overlay: #334155;
      --theme-muted: #64748b;
      --theme-subtle: #94a3b8;
      --theme-text: #f1f5f9;
      --theme-love: #ef4444;
      --theme-gold: #f59e0b;
      --theme-rose: #f97316;
      --theme-pine: #059669;
      --theme-foam: #06b6d4;
      --theme-iris: #8b5cf6;
      --theme-highlight-low: #1e293b;
      --theme-highlight-med: #475569;
      --theme-highlight-high: #64748b;
      --theme-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
    }
    
    [data-theme="light"] {
      --theme-base: #f8fafc;
      --theme-surface: #e2e8f0;
      --theme-overlay: #cbd5e1;
      --theme-muted: #64748b;
      --theme-subtle: #475569;
      --theme-text: #0f172a;
      --theme-love: #dc2626;
      --theme-gold: #d97706;
      --theme-rose: #ea580c;
      --theme-pine: #047857;
      --theme-foam: #0891b2;
      --theme-iris: #7c3aed;
      --theme-highlight-low: #f1f5f9;
      --theme-highlight-med: #e2e8f0;
      --theme-highlight-high: #cbd5e1;
      --theme-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
    }
    
    [data-theme="catppuccin"] {
      --theme-base: #1e1e2e;
      --theme-surface: #313244;
      --theme-overlay: #45475a;
      --theme-muted: #6c7086;
      --theme-subtle: #9399b2;
      --theme-text: #cdd6f4;
      --theme-love: #f38ba8;
      --theme-gold: #f9e2af;
      --theme-rose: #fab387;
      --theme-pine: #a6e3a1;
      --theme-foam: #89dceb;
      --theme-iris: #cba6f7;
      --theme-highlight-low: #181825;
      --theme-highlight-med: #313244;
      --theme-highlight-high: #45475a;
      --theme-gradient: linear-gradient(135deg, #1e1e2e 0%, #313244 50%, #45475a 100%);
    }
    
    [data-theme="nord"] {
      --theme-base: #2e3440;
      --theme-surface: #3b4252;
      --theme-overlay: #434c5e;
      --theme-muted: #4c566a;
      --theme-subtle: #d8dee9;
      --theme-text: #eceff4;
      --theme-love: #bf616a;
      --theme-gold: #ebcb8b;
      --theme-rose: #d08770;
      --theme-pine: #a3be8c;
      --theme-foam: #88c0d0;
      --theme-iris: #b48ead;
      --theme-highlight-low: #2e3440;
      --theme-highlight-med: #434c5e;
      --theme-highlight-high: #4c566a;
      --theme-gradient: linear-gradient(135deg, #2e3440 0%, #3b4252 50%, #434c5e 100%);
    }
    
    [data-theme="gruvbox"] {
      --theme-base: #282828;
      --theme-surface: #3c3836;
      --theme-overlay: #504945;
      --theme-muted: #665c54;
      --theme-subtle: #a89984;
      --theme-text: #ebdbb2;
      --theme-love: #fb4934;
      --theme-gold: #fabd2f;
      --theme-rose: #fe8019;
      --theme-pine: #b8bb26;
      --theme-foam: #8ec07c;
      --theme-iris: #d3869b;
      --theme-highlight-low: #1d2021;
      --theme-highlight-med: #3c3836;
      --theme-highlight-high: #504945;
      --theme-gradient: linear-gradient(135deg, #282828 0%, #3c3836 50%, #504945 100%);
    }
    
    [data-theme="tokyo-night"] {
      --theme-base: #1a1b26;
      --theme-surface: #24283b;
      --theme-overlay: #414868;
      --theme-muted: #565f89;
      --theme-subtle: #a9b1d6;
      --theme-text: #c0caf5;
      --theme-love: #f7768e;
      --theme-gold: #e0af68;
      --theme-rose: #ff9e64;
      --theme-pine: #9ece6a;
      --theme-foam: #7dcfff;
      --theme-iris: #bb9af7;
      --theme-highlight-low: #16161e;
      --theme-highlight-med: #24283b;
      --theme-highlight-high: #414868;
      --theme-gradient: linear-gradient(135deg, #1a1b26 0%, #24283b 50%, #414868 100%);
    }
    
    [data-theme="dracula"] {
      --theme-base: #282a36;
      --theme-surface: #44475a;
      --theme-overlay: #6272a4;
      --theme-muted: #6272a4;
      --theme-subtle: #f8f8f2;
      --theme-text: #f8f8f2;
      --theme-love: #ff5555;
      --theme-gold: #f1fa8c;
      --theme-rose: #ffb86c;
      --theme-pine: #50fa7b;
      --theme-foam: #8be9fd;
      --theme-iris: #bd93f9;
      --theme-highlight-low: #21222c;
      --theme-highlight-med: #44475a;
      --theme-highlight-high: #6272a4;
      --theme-gradient: linear-gradient(135deg, #282a36 0%, #44475a 50%, #6272a4 100%);
    }

    /* Activity item hover effect */
    .activity-item {
      transition: all 0.3s ease;
    }
    .activity-item:hover {
      background: rgba(156, 207, 216, 0.05);
    }
  </style>
</head>
<body class="bg-rp-base min-h-screen text-rp-text font-[Inter] antialiased">

  <!-- Particles Canvas -->
  <canvas id="particles-canvas" class="fixed inset-0 pointer-events-none hidden"></canvas>

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-6 py-4 bg-rp-surface/80 border-b border-rp-overlay backdrop-blur-sm fixed top-0 left-0 right-0 z-50">
    <a href="index.html" class="text-xl font-bold text-rp-foam tracking-tight">CARBON</a>
    <div class="flex items-center gap-4">
      <div id="userSection"></div>
    </div>
  </nav>

  <!-- LOGIN SCREEN -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen w-full bg-rp-base fixed left-0 top-0 z-50">
    <div class="bg-rp-surface rounded-xl shadow-2xl p-8 border border-rp-overlay max-w-md w-full mx-4">
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-rp-foam mb-2">Welcome Back</h1>
        <p class="text-rp-subtle">Sign in to view your profile</p>
      </div>
      <button onclick="googleSignIn()" class="w-full flex items-center justify-center gap-3 bg-rp-foam hover:bg-rp-foam/90 text-rp-base font-medium px-6 py-3 rounded-lg transition-all duration-200">
        <i class='bx bxl-google text-xl'></i>
        Continue with Google
      </button>
      <div id="loginError" class="text-rp-love mt-4 text-sm text-center hidden"></div>
    </div>
  </div>

  <main class="pt-20 pb-12 max-w-4xl mx-auto px-4">
    <!-- PRIVATE PROFILE -->
    <div id="profileContent" class="hidden">
      <!-- Profile Header -->
      <div class="bg-rp-surface rounded-xl p-6 mb-8 border border-rp-overlay">
        <div class="flex flex-col sm:flex-row items-center gap-6">
          <img id="profilePhoto" class="w-16 h-16 rounded-full ring-2 ring-rp-foam/50" src="" alt="Profile Photo">
          <div class="flex-1 text-center sm:text-left">
            <h1 id="profileName" class="text-2xl font-bold text-rp-text mb-1"></h1>
            <p id="profileEmail" class="text-rp-subtle text-sm"></p>
          </div>
          <button onclick="signOut()" class="text-rp-subtle hover:text-rp-love transition-colors text-sm">
            Sign Out
          </button>
        </div>
        
        <!-- Public Profile Link -->
        <div class="mt-6 pt-6 border-t border-rp-overlay">
          <label class="block text-sm font-medium text-rp-text mb-2">Your Public Profile</label>
          <div class="flex gap-2">
            <input id="publicProfileLink" type="text" class="flex-1 px-3 py-2 bg-rp-overlay border border-rp-highlight-med rounded-lg text-rp-text text-sm font-mono focus:outline-none focus:ring-2 focus:ring-rp-foam/50" readonly>
            <button id="copyProfileLinkBtn" class="px-4 py-2 bg-rp-foam hover:bg-rp-foam/90 text-rp-base rounded-lg transition-colors">
              <i class='bx bx-copy'></i>
            </button>
          </div>
          <div id="copyFeedback" class="text-rp-foam mt-2 text-sm opacity-0 transition-opacity duration-300">Copied to clipboard!</div>
        </div>
      </div>

      <!-- Background Selection -->
      <div class="bg-rp-surface rounded-xl p-6 mb-8 border border-rp-overlay">
        <h2 class="text-xl font-semibold text-rp-text mb-4 flex items-center gap-2">
          <i class='bx bx-palette text-rp-iris'></i>
          Background
        </h2>
        <p class="text-rp-subtle text-sm mb-4">Customize your background appearance</p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-rp-text mb-2">Background Type</label>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            <div class="bg-preview active rounded-lg p-2 cursor-pointer border border-rp-foam transition-all duration-200" data-bg="gradient" style="background: var(--theme-gradient);">
              <div class="text-center text-xs text-white">Gradient</div>
            </div>
            <div class="bg-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-rp-foam transition-all duration-200" data-bg="solid">
              <div class="text-center text-xs text-white">Solid</div>
            </div>
            <div class="bg-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-rp-foam transition-all duration-200" data-bg="pattern">
              <div class="text-center text-xs text-white">Pattern</div>
            </div>
            <div class="bg-preview rounded-lg p-2 cursor-pointer border border-transparent hover:border-rp-foam transition-all duration-200" data-bg="particles">
              <div class="text-center text-xs text-white">Particles</div>
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-rp-text mb-2">Custom Background</label>
          <div id="bg-upload" class="border-2 border-dashed border-rp-highlight-med rounded-lg p-4 text-center cursor-pointer hover:bg-rp-overlay transition-all duration-200">
            <i class="bx bx-cloud-upload text-2xl text-rp-muted mb-1"></i>
            <p class="text-rp-muted text-sm">Upload or drag and drop an image</p>
            <p class="text-xs text-rp-subtle">JPG, PNG, WebP</p>
          </div>
          <input type="file" id="bg-file-input" accept="image/*" class="hidden">
          <div id="custom-bg-preview" class="mt-4 hidden">
            <div id="bg-preview-image" class="w-full h-40 rounded-lg bg-cover bg-center border border-rp-highlight-med hover:border-rp-foam transition-all duration-200"></div>
            <div class="flex gap-2 mt-2">
              <button id="remove-bg" class="px-3 py-1 bg-rp-love text-white rounded-lg text-sm hover:bg-rp-love/80 transition-all duration-200">Remove</button>
              <button id="change-bg" class="px-3 py-1 bg-rp-foam text-rp-base rounded-lg text-sm hover:bg-rp-foam/80 transition-all duration-200">Change</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Games -->
      <div id="recentGamesContainer" class="mb-8">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-rp-text flex items-center gap-2">
            <i class='bx bx-time text-rp-gold'></i>
            Recently Played
          </h2>
          <button id="clearRecentGamesBtn" class="px-4 py-2 bg-rp-love/20 hover:bg-rp-love/30 text-rp-love border border-rp-love/30 hover:border-rp-love/50 rounded-lg transition-all duration-200 text-sm font-medium flex items-center gap-2">
            <i class='bx bx-trash'></i>
            Clear History
          </button>
        </div>
        <div id="recentGamesList" class="space-y-3"></div>
      </div>

      <!-- Games Grid -->
      <div class="grid lg:grid-cols-2 gap-8 mb-8">
        <!-- Favorite Games -->
        <div>
          <h2 class="text-xl font-semibold text-rp-text mb-4 flex items-center gap-2">
            <i class='bx bx-heart text-rp-love'></i>
            Favorite Games
          </h2>
          <div id="favoriteGamesList" class="space-y-3"></div>
        </div>

        <!-- Liked Games -->
        <div>
          <h2 class="text-xl font-semibold text-rp-text mb-4 flex items-center gap-2">
            <i class='bx bx-like text-rp-iris'></i>
            Liked Games
          </h2>
          <div id="likedGamesList" class="space-y-3"></div>
        </div>
      </div>

      <!-- Activity Feed -->
      <div id="activityFeedSection" class="mb-8">
        <h2 class="text-xl font-semibold text-rp-text mb-4 flex items-center gap-2">
          <i class='bx bx-activity text-rp-pine'></i>
          Recent Activity
        </h2>
        <div class="bg-rp-surface rounded-xl border border-rp-overlay p-4">
          <div id="activityFeed" class="max-h-64 overflow-y-auto"></div>
          <div id="activityLoader" class="text-center py-8 hidden">
            <div class="inline-block w-6 h-6 border-2 border-rp-foam border-t-transparent rounded-full animate-spin"></div>
            <p class="text-rp-foam mt-2">Loading activity...</p>
          </div>
          <div id="noActivity" class="text-rp-subtle text-sm text-center py-4 hidden">No recent activity</div>
        </div>
      </div>
    </div>

    <!-- PUBLIC PROFILE -->
    <div id="publicProfileContent" class="hidden">
      <!-- Public Profile Header -->
      <div class="bg-rp-surface rounded-xl p-6 mb-8 border border-rp-overlay">
        <div class="flex flex-col sm:flex-row items-center gap-6">
          <img id="publicProfilePhoto" class="w-16 h-16 rounded-full ring-2 ring-rp-foam/50" src="" alt="Profile Photo">
          <div class="flex-1 text-center sm:text-left">
            <h1 id="publicProfileName" class="text-2xl font-bold text-rp-text mb-1"></h1>
            <p id="publicProfileUsername" class="text-rp-subtle text-sm"></p>
          </div>
        </div>
        
        <!-- Share Profile -->
        <div class="mt-6 pt-6 border-t border-rp-overlay">
          <label class="block text-sm font-medium text-rp-text mb-2">Share this profile</label>
          <div class="flex gap-2">
            <input id="publicProfileUrl" type="text" class="flex-1 px-3 py-2 bg-rp-overlay border border-rp-highlight-med rounded-lg text-rp-text text-sm font-mono focus:outline-none focus:ring-2 focus:ring-rp-foam/50" readonly>
            <button id="copyPublicProfileUrlBtn" class="px-4 py-2 bg-rp-foam hover:bg-rp-foam/90 text-rp-base rounded-lg transition-colors">
              <i class='bx bx-copy'></i>
            </button>
          </div>
          <div id="copyPublicFeedback" class="text-rp-foam mt-2 text-sm opacity-0 transition-opacity duration-300">Copied to clipboard!</div>
        </div>
      </div>

      <!-- Public Recent Games -->
      <div id="publicRecentGamesContainer" class="mb-8">
        <h2 class="text-xl font-semibold text-rp-text mb-4 flex items-center gap-2">
          <i class='bx bx-time text-rp-gold'></i>
          Recently Played
        </h2>
        <div id="publicRecentGamesList" class="space-y-3"></div>
      </div>

      <!-- Public Games Grid -->
      <div class="grid lg:grid-cols-2 gap-8 mb-8">
        <!-- Public Favorite Games -->
        <div>
          <h2 class="text-xl font-semibold text-rp-text mb-4 flex items-center gap-2">
            <i class='bx bx-heart text-rp-love'></i>
            Favorite Games
          </h2>
          <div id="publicFavoriteGamesList" class="space-y-3"></div>
        </div>

        <!-- Public Liked Games -->
        <div>
          <h2 class="text-xl font-semibold text-rp-text mb-4 flex items-center gap-2">
            <i class='bx bx-like text-rp-iris'></i>
            Liked Games
          </h2>
          <div id="publicLikedGamesList" class="space-y-3"></div>
        </div>
      </div>

      <!-- Public Activity Feed -->
      <div id="publicActivityFeedSection" class="mb-8">
        <h2 class="text-xl font-semibold text-rp-text mb-4 flex items-center gap-2">
          <i class='bx bx-activity text-rp-pine'></i>
          Recent Activity
        </h2>
        <div class="bg-rp-surface rounded-xl border border-rp-overlay p-4">
          <div id="publicActivityFeed" class="max-h-64 overflow-y-auto"></div>
          <div id="publicActivityLoader" class="text-center py-8 hidden">
            <div class="inline-block w-6 h-6 border-2 border-rp-foam border-t-transparent rounded-full animate-spin"></div>
            <p class="text-rp-foam mt-2">Loading activity...</p>
          </div>
          <div id="publicNoActivity" class="text-rp-subtle text-sm text-center py-4 hidden">No recent activity</div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // FIREBASE INIT
    const firebaseConfig = {
      apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
      authDomain: "carbon-services.firebaseapp.com",
      projectId: "carbon-services",
      storageBucket: "carbon-services.firebasestorage.app",
      messagingSenderId: "288385472070",
      appId: "1:288385472070:web:c4be3ff186e248fc645c47",
      measurementId: "G-Y2K1RQYE74"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function googleSignIn() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .catch((error) => {
          document.getElementById('loginError').innerText = error.message;
          document.getElementById('loginError').classList.remove('hidden');
        });
    }
    function signOut() {
      auth.signOut().then(() => location.reload());
    }

    let gamesData = [];
    async function loadGamesData() {
      try {
        const res = await fetch('games.json');
        gamesData = await res.json();
      } catch (error) {
        console.error('Error loading games data:', error);
      }
    }

    async function getUserGameLists(uid) {
      const doc = await db.collection('users').doc(uid).get();
      return doc.exists ? doc.data() : { likedGames: [], favoriteGames: [], playlist: [], history: [] };
    }

    async function getUserPublicProfile(uid) {
      const doc = await db.collection('users').doc(uid).get();
      if (doc.exists) {
        const user = doc.data();
        return {
          displayName: user.displayName || '',
          username: user.username || '',
          photoURL: user.photoURL || '',
          likedGames: user.likedGames || [],
          favoriteGames: user.favoriteGames || [],
          history: user.history || [],
        };
      }
      return null;
    }

    async function ensureUserDoc(user) {
      const userRef = db.collection('users').doc(user.uid);
      const doc = await userRef.get();
      if (!doc.exists) {
        await userRef.set({
          displayName: user.displayName || "",
          photoURL: user.photoURL || "",
          email: user.email || "",
          username: "",
          likedGames: [],
          favoriteGames: [],
          history: [],
        });
      } else {
        let needsUpdate = false;
        const data = doc.data();
        const updateFields = {};
        if (!data.displayName && user.displayName) {
          updateFields.displayName = user.displayName;
          needsUpdate = true;
        }
        if (!data.photoURL && user.photoURL) {
          updateFields.photoURL = user.photoURL;
          needsUpdate = true;
        }
        if (needsUpdate) await userRef.update(updateFields);
      }
    }

    async function clearRecentGames() {
      const user = auth.currentUser;
      if (!user) return;

      if (confirm('Are you sure you want to clear your entire game history? This action cannot be undone.')) {
        try {
          const userRef = db.collection('users').doc(user.uid);
          await userRef.update({
            history: []
          });
          
          // Refresh the recent games list
          renderGamesList('recentGamesList', [], 'recent games');
          
          // Show success message
          showTemporaryMessage('Game history cleared successfully!', 'success');
        } catch (error) {
          console.error('Error clearing game history:', error);
          showTemporaryMessage('Failed to clear game history. Please try again.', 'error');
        }
      }
    }

    function showTemporaryMessage(message, type = 'info') {
      const messageEl = document.createElement('div');
      messageEl.className = `fixed top-4 right-4 px-6 py-3 rounded-lg font-medium shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
      
      if (type === 'success') {
        messageEl.className += ' bg-green-500 text-white';
      } else if (type === 'error') {
        messageEl.className += ' bg-red-500 text-white';
      } else {
        messageEl.className += ' bg-rp-foam text-rp-base';
      }
      
      messageEl.textContent = message;
      document.body.appendChild(messageEl);
      
      // Animate in
      setTimeout(() => {
        messageEl.classList.remove('translate-x-full');
      }, 100);
      
      // Animate out and remove
      setTimeout(() => {
        messageEl.classList.add('translate-x-full');
        setTimeout(() => {
          if (messageEl.parentNode) {
            document.body.removeChild(messageEl);
          }
        }, 300);
      }, 3000);
    }

    function renderUserSection(user) {
      const section = document.getElementById('userSection');
      if (!user) {
        section.innerHTML = '';
      } else {
        section.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${user.photoURL}" class="w-8 h-8 rounded-full ring-1 ring-rp-foam/30">
            <span class="text-rp-text font-medium">${user.displayName}</span>
          </div>
        `;
      }
    }

    function renderGamesList(listId, gameIds, label) {
      const listEl = document.getElementById(listId);
      if (!Array.isArray(gameIds) || gameIds.length === 0) {
        listEl.innerHTML = `<div class="text-rp-subtle text-sm italic py-4 text-center">No ${label} yet</div>`;
        return;
      }
      const seen = {};
      const uniqueIds = [];
      for (const id of gameIds) {
        if (!seen[id]) {
          seen[id] = true;
          uniqueIds.push(id);
        }
      }
      listEl.innerHTML = uniqueIds.map(id => {
        const game = gamesData.find(g => String(g.id) === String(id));
        if (!game) return '';
        return `
          <a href="play.html?id=${game.id}" class="group block bg-rp-surface border border-rp-overlay rounded-lg p-4 hover:border-rp-foam/50 transition-all duration-200">
            <div class="flex items-center gap-4">
              <div class="w-16 h-12 flex-shrink-0 rounded-lg overflow-hidden bg-rp-overlay">
                <img src="${game.image}" alt="${game.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
              </div>
              <div class="flex-1 min-w-0">
                <h3 class="font-medium text-rp-text truncate">${game.title}</h3>
                <p class="text-sm text-rp-subtle truncate">${game.description}</p>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-xs px-2 py-1 bg-rp-foam/20 text-rp-foam rounded">${game.category}</span>
                  ${game.featured ? '<span class="text-xs px-2 py-1 bg-rp-iris/20 text-rp-iris rounded">Featured</span>' : ''}
                </div>
              </div>
              <div class="flex items-center text-rp-foam group-hover:text-rp-foam/80 transition-colors">
                <i class='bx bx-play-circle text-xl'></i>
              </div>
            </div>
          </a>
        `;
      }).join('');
    }

    function getActivityDescription(activity) {
      const gameTitle = activity.data && activity.data.gameId 
        ? (gamesData.find(g => String(g.id) === String(activity.data.gameId))?.title || 'Unknown Game') 
        : '';
      switch (activity.action) {
        case 'play':
          return `Started playing ${gameTitle}`;
        case 'continue':
          return `Continued playing ${gameTitle}`;
        case 'random-play':
          return `Played random game: ${gameTitle}`;
        case 'search':
          return `Searched for "${activity.data.query || 'unknown'}"`;
        case 'pin':
          return `Pinned ${gameTitle}`;
        case 'unpin':
          return `Unpinned ${gameTitle}`;
        case 'page-view':
          return `Visited ${activity.data.page || 'unknown'} page`;
        case 'like':
          return `Liked ${gameTitle}`;
        case 'unlike':
          return `Unliked ${gameTitle}`;
        case 'favorite':
          return `Favorited ${gameTitle}`;
        case 'unfavorite':
          return `Unfavorited ${gameTitle}`;
        case 'comment':
          return `Commented on ${gameTitle}`;
        case 'reply':
          return `Replied to a comment on ${gameTitle}`;
        case 'rate':
          return `Rated ${gameTitle} ${activity.data.rating || 0} stars`;
        default:
          return 'Performed an action';
      }
    }

    function getActivityIcon(action) {
      switch (action) {
        case 'play':
        case 'continue':
        case 'random-play':
          return 'bx-play-circle';
        case 'search':
          return 'bx-search';
        case 'pin':
        case 'favorite':
          return 'bx-heart';
        case 'unpin':
        case 'unfavorite':
          return 'bx-heart';
        case 'page-view':
          return 'bx-globe';
        case 'like':
        case 'unlike':
          return 'bx-like';
        case 'comment':
        case 'reply':
          return 'bx-message-square-dots';
        case 'rate':
          return 'bx-star';
        default:
          return 'bx-activity';
      }
    }

    function getTimeAgo(timestamp) {
      if (!timestamp || !timestamp.toDate) return 'Just now';
      const now = Date.now();
      const diff = now - timestamp.toDate().getTime();
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      if (days > 0) return `${days}d ago`;
      if (hours > 0) return `${hours}h ago`;
      if (minutes > 0) return `${minutes}m ago`;
      return 'Just now';
    }

    function renderActivityFeed(activities, feedId) {
      const feed = document.getElementById(feedId);
      const loader = document.getElementById(feedId === 'activityFeed' ? 'activityLoader' : 'publicActivityLoader');
      const noActivity = document.getElementById(feedId === 'activityFeed' ? 'noActivity' : 'publicNoActivity');

      if (loader) loader.classList.add('hidden');
      if (!activities || activities.length === 0) {
        feed.innerHTML = '';
        if (noActivity) noActivity.classList.remove('hidden');
        return;
      }

      if (noActivity) noActivity.classList.add('hidden');
      feed.innerHTML = activities.map(activity => {
        if (!activity.action || !activity.timestamp) return '';
        const timeAgo = getTimeAgo(activity.timestamp);
        const description = getActivityDescription(activity);
        return `
          <div class="activity-item flex items-start gap-3 py-3 border-b border-rp-overlay last:border-0">
            <div class="w-8 h-8 rounded-full bg-rp-overlay flex items-center justify-center flex-shrink-0">
              <i class='bx ${getActivityIcon(activity.action)} text-rp-foam text-sm'></i>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-rp-text text-sm">${description}</p>
              <p class="text-rp-muted text-xs mt-1">${timeAgo}</p>
            </div>
          </div>
        `;
      }).filter(item => item).join('');
    }

    async function loadActivityFeed(uid, feedId) {
      const loader = document.getElementById(feedId === 'activityFeed' ? 'activityLoader' : 'publicActivityLoader');
      const noActivity = document.getElementById(feedId === 'activityFeed' ? 'noActivity' : 'publicNoActivity');
      if (loader) loader.classList.remove('hidden');
      if (noActivity) noActivity.classList.add('hidden');

      try {
        const doc = await db.collection('user-activity').doc(uid).get();
        const activities = doc.exists ? (doc.data().activities || []).filter(activity => 
          activity.action && activity.timestamp
        ) : [];
        renderActivityFeed(activities.slice(-10).reverse(), feedId);
      } catch (error) {
        console.error('Error loading activity feed:', error);
        renderActivityFeed([], feedId);
      }
    }

    function getUidFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('uid');
    }

    async function showPublicProfile(uid) {
      await loadGamesData();
      const userProfile = await getUserPublicProfile(uid);
      if (!userProfile || !userProfile.displayName) {
        document.getElementById('publicProfileContent').innerHTML = `
          <div class="text-center py-16">
            <div class="bg-rp-surface rounded-xl p-8 border border-rp-overlay">
              <i class='bx bx-user-x text-4xl text-rp-muted mb-4'></i>
              <h2 class="text-xl font-semibold text-rp-text mb-2">User not found</h2>
              <p class="text-rp-subtle">This profile doesn't exist or has been removed.</p>
            </div>
          </div>
        `;
        document.getElementById('publicProfileContent').classList.remove('hidden');
        return;
      }
      document.getElementById('publicProfilePhoto').src = userProfile.photoURL;
      document.getElementById('publicProfileName').textContent = userProfile.displayName || "Unknown User";
      document.getElementById('publicProfileUsername').textContent = userProfile.username ? `@${userProfile.username}` : '';
      renderGamesList('publicRecentGamesList', (userProfile.history || []).slice().reverse(), 'recent games');
      renderGamesList('publicFavoriteGamesList', userProfile.favoriteGames, 'favorite games');
      renderGamesList('publicLikedGamesList', userProfile.likedGames, 'liked games');
      await loadActivityFeed(uid, 'publicActivityFeed');
      
      const url = `${window.location.origin}${window.location.pathname}?uid=${encodeURIComponent(uid)}`;
      const urlInput = document.getElementById('publicProfileUrl');
      urlInput.value = url;
      const copyBtn = document.getElementById('copyPublicProfileUrlBtn');
      const feedback = document.getElementById('copyPublicFeedback');
      copyBtn.onclick = function() {
        urlInput.select();
        urlInput.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(urlInput.value).then(function() {
          feedback.style.opacity = 1;
          setTimeout(() => feedback.style.opacity = 0, 1200);
        });
      };
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const publicUid = getUidFromUrl();
      if (publicUid) {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('profileContent').classList.add('hidden');
        document.getElementById('publicProfileContent').classList.remove('hidden');
        await showPublicProfile(publicUid);
        return;
      }

      document.getElementById('profileContent').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      await loadGamesData();
      auth.onAuthStateChanged(async (user) => {
        renderUserSection(user);
        if (!user) {
          document.getElementById('loginScreen').classList.remove('hidden');
          document.getElementById('profileContent').classList.add('hidden');
          document.getElementById('publicProfileContent').classList.add('hidden');
          return;
        }
        await ensureUserDoc(user);
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('profileContent').classList.remove('hidden');
        document.getElementById('publicProfileContent').classList.add('hidden');
        document.getElementById('profilePhoto').src = user.photoURL;
        document.getElementById('profileName').textContent = user.displayName;
        document.getElementById('profileEmail').textContent = user.email;
        
        // Load background settings from Firebase
        await loadBackgroundFromFirebase(user.uid);
        
        const lists = await getUserGameLists(user.uid);
        renderGamesList('recentGamesList', (lists.history || []).slice().reverse(), 'recent games');
        renderGamesList('favoriteGamesList', lists.favoriteGames, 'favorite games');
        renderGamesList('likedGamesList', lists.likedGames, 'liked games');
        await loadActivityFeed(user.uid, 'activityFeed');
        
        // Set up clear recent games button
        const clearBtn = document.getElementById('clearRecentGamesBtn');
        if (clearBtn) {
          clearBtn.onclick = clearRecentGames;
        }
        
        const url = `${window.location.origin}${window.location.pathname}?uid=${encodeURIComponent(user.uid)}`;
        const linkInput = document.getElementById('publicProfileLink');
        linkInput.value = url;
        const copyBtn = document.getElementById('copyProfileLinkBtn');
        const feedback = document.getElementById('copyFeedback');
        copyBtn.onclick = function() {
          linkInput.select();
          linkInput.setSelectionRange(0, 99999);
          navigator.clipboard.writeText(linkInput.value).then(function() {
            feedback.style.opacity = 1;
            setTimeout(() => feedback.style.opacity = 0, 1200);
          });
        };
      });
    });

    // THEME SYNC - Auto-syncs from settings.html via enhanced theme system
    // The carbon-theme.js handles theme application automatically from global storage
    
    // Listen for theme changes from settings page
    window.addEventListener('storage', (event) => {
      if (event.key === 'carbon-theme-global' && event.newValue) {
        // Theme changed in another tab/window - apply automatically
        if (window.carbonTheme) {
          window.carbonTheme.applyTheme(event.newValue);
        }
      }
    });
    
    // Listen for theme broadcast messages
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'carbon-theme-change') {
        // Theme changed in settings - apply automatically
        if (window.carbonTheme) {
          window.carbonTheme.applyTheme(event.data.theme);
        }
      }
    });

    // Initialize theme on load (carbon-theme.js handles this automatically)

    // Background Selection Functionality
    let currentBackground = 'gradient';
    const validBackgrounds = ['gradient', 'solid', 'pattern', 'particles', 'custom'];

    function initializeBackgroundSystem() {
      // Load saved background preference
      const savedBg = localStorage.getItem('carbon-background-global') || 'gradient';
      if (validBackgrounds.includes(savedBg)) {
        currentBackground = savedBg;
        updateBackgroundUI();
      }

      // Background selection event listeners
      document.querySelectorAll('.bg-preview').forEach(preview => {
        preview.addEventListener('click', () => {
          const bgType = preview.dataset.bg;
          if (bgType && validBackgrounds.includes(bgType)) {
            currentBackground = bgType;
            localStorage.setItem('carbon-background-global', bgType);
            updateBackgroundUI();
            saveBackgroundToFirebase();
          }
        });
      });

      // Custom background upload
      const bgUpload = document.getElementById('bg-upload');
      const bgFileInput = document.getElementById('bg-file-input');
      
      if (bgUpload && bgFileInput) {
        bgUpload.addEventListener('click', () => bgFileInput.click());
        bgUpload.addEventListener('dragover', (e) => {
          e.preventDefault();
          bgUpload.classList.add('bg-rp-highlight-med');
        });
        bgUpload.addEventListener('dragleave', () => {
          bgUpload.classList.remove('bg-rp-highlight-med');
        });
        bgUpload.addEventListener('drop', (e) => {
          e.preventDefault();
          bgUpload.classList.remove('bg-rp-highlight-med');
          const files = e.dataTransfer.files;
          if (files.length > 0) handleCustomBackground(files[0]);
        });
        
        bgFileInput.addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            handleCustomBackground(e.target.files[0]);
          }
        });
      }

      // Custom background remove/change buttons
      const removeBtn = document.getElementById('remove-bg');
      const changeBtn = document.getElementById('change-bg');
      
      if (removeBtn) {
        removeBtn.addEventListener('click', () => {
          localStorage.removeItem('carbon-custom-bg-global');
          document.getElementById('custom-bg-preview').classList.add('hidden');
          if (currentBackground === 'custom') {
            currentBackground = 'gradient';
            localStorage.setItem('carbon-background-global', 'gradient');
            updateBackgroundUI();
          }
          saveBackgroundToFirebase();
        });
      }
      
      if (changeBtn) {
        changeBtn.addEventListener('click', () => bgFileInput.click());
      }

      // Check for custom background on load
      const savedCustomBg = localStorage.getItem('carbon-custom-bg-global');
      if (savedCustomBg && currentBackground === 'custom') {
        showCustomBgPreview(savedCustomBg);
      }
    }

    function updateBackgroundUI() {
      // Update active states
      document.querySelectorAll('.bg-preview').forEach(el => {
        el.classList.remove('active', 'border-rp-foam');
        el.classList.add('border-transparent');
      });
      
      if (currentBackground !== 'custom') {
        const bgElement = document.querySelector(`[data-bg="${currentBackground}"]`);
        if (bgElement) {
          bgElement.classList.add('active', 'border-rp-foam');
          bgElement.classList.remove('border-transparent');
        }
      }
      
      applyBackground();
      updateBackgroundPreviews();
    }

    function updateBackgroundPreviews() {
      const gradientPreview = document.querySelector('[data-bg="gradient"]');
      const solidPreview = document.querySelector('[data-bg="solid"]');
      const patternPreview = document.querySelector('[data-bg="pattern"]');
      const particlesPreview = document.querySelector('[data-bg="particles"]');
      
      const baseColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-base').trim();
      
      if (gradientPreview) gradientPreview.style.background = 'var(--theme-gradient)';
      if (solidPreview) solidPreview.style.background = baseColor;
      if (patternPreview) {
        patternPreview.style.background = `${baseColor} url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="2" fill="%23ffffff" fill-opacity="0.2"/></svg>') repeat`;
      }
      if (particlesPreview) particlesPreview.style.background = baseColor;
    }

    function applyBackground() {
      const body = document.body;
      const particlesCanvas = document.getElementById('particles-canvas');
      const baseColor = getComputedStyle(document.documentElement).getPropertyValue('--theme-base').trim();
      
      // Hide particles canvas by default
      if (particlesCanvas) particlesCanvas.classList.add('hidden');
      
      // Reset body background
      body.style.background = '';
      
      const customBg = localStorage.getItem('carbon-custom-bg-global');
      
      if (currentBackground === 'custom' && customBg) {
        body.style.background = `url(${customBg}) center/cover fixed`;
      } else {
        switch (currentBackground) {
          case 'solid':
            body.style.background = baseColor;
            break;
          case 'pattern':
            body.style.background = `${baseColor} url('data:image/svg+xml,<svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="2" fill="%23ffffff" fill-opacity="0.2"/></svg>') repeat`;
            break;
          case 'particles':
            body.style.background = baseColor;
            if (particlesCanvas) {
              particlesCanvas.classList.remove('hidden');
              initParticles();
            }
            break;
          case 'gradient':
          default:
            body.style.background = 'var(--theme-gradient)';
            body.style.backgroundAttachment = 'fixed';
            break;
        }
      }
    }

    function handleCustomBackground(file) {
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;
        localStorage.setItem('carbon-custom-bg-global', dataUrl);
        showCustomBgPreview(dataUrl);
        currentBackground = 'custom';
        localStorage.setItem('carbon-background-global', 'custom');
        updateBackgroundUI();
        saveBackgroundToFirebase();
      };
      reader.readAsDataURL(file);
    }

    function showCustomBgPreview(dataUrl) {
      const preview = document.getElementById('custom-bg-preview');
      const image = document.getElementById('bg-preview-image');
      if (preview && image) {
        image.style.backgroundImage = `url(${dataUrl})`;
        preview.classList.remove('hidden');
      }
    }

    function initParticles() {
      const canvas = document.getElementById('particles-canvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      const particlesArray = [];
      const particleCount = 50;
      
      class Particle {
        constructor() {
          this.x = Math.random() * canvas.width;
          this.y = Math.random() * canvas.height;
          this.vx = (Math.random() - 0.5) * 2;
          this.vy = (Math.random() - 0.5) * 2;
          this.radius = Math.random() * 3 + 1;
          this.opacity = Math.random() * 0.5 + 0.2;
        }
        
        update() {
          this.x += this.vx;
          this.y += this.vy;
          
          if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
          if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
        }
        
        draw() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(156, 207, 216, ${this.opacity})`;
          ctx.fill();
        }
      }
      
      function createParticles() {
        particlesArray.length = 0;
        for (let i = 0; i < particleCount; i++) {
          particlesArray.push(new Particle());
        }
      }
      
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particlesArray.forEach(particle => {
          particle.update();
          particle.draw();
        });
        
        if (!canvas.classList.contains('hidden')) {
          requestAnimationFrame(animate);
        }
      }
      
      createParticles();
      animate();
      
      window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        createParticles();
      });
    }

    async function saveBackgroundToFirebase() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      
      try {
        const settings = {
          background: currentBackground,
          customBackground: localStorage.getItem('carbon-custom-bg-global') || '',
        };
        await db.collection('users').doc(user.uid).set({ settings }, { merge: true });
      } catch (error) {
        console.error('Error saving background to Firebase:', error);
      }
    }

    async function loadBackgroundFromFirebase(uid) {
      try {
        const userDoc = await db.collection('users').doc(uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          const settings = userData.settings || {};
          
          if (settings.background && validBackgrounds.includes(settings.background)) {
            currentBackground = settings.background;
            localStorage.setItem('carbon-background-global', currentBackground);
          }
          
          if (settings.customBackground) {
            localStorage.setItem('carbon-custom-bg-global', settings.customBackground);
            if (currentBackground === 'custom') {
              showCustomBgPreview(settings.customBackground);
            }
          }
          
          updateBackgroundUI();
        }
      } catch (error) {
        console.error('Error loading background from Firebase:', error);
      }
    }

    // Initialize background system when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializeBackgroundSystem, 100);
    });

    // Update background when theme changes
    window.addEventListener('storage', (event) => {
      if (event.key === 'carbon-background-global' && event.newValue) {
        currentBackground = event.newValue;
        updateBackgroundUI();
      }
    });
  </script>
</body>
</html>
