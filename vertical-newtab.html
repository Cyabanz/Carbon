<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Tab - Carbon</title>
    <script defer async>
      function setConfig() {
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                display: ["Switzer", "Helvetica", "sans-serif"],
                inter: ["Inter", "sans-serif"],
              },
              colors: {
                base: "#191724",
                surface: "#1f1d2e",
                overlay: "#26233a",
                muted: "#6e6a86",
                subtle: "#908caa",
                text: "#e0def4",
                love: "#eb6f92",
                gold: "#f6c177",
                rose: "#ebbcba",
                pine: "#31748f",
                foam: "#9ccfd8",
                iris: "#c4a7e7",
                "highlight-low": "#21202e",
                "highlight-med": "#403d52",
                "highlight-high": "#524f67",
              },
            },
          },
        };
      }
    </script>

    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" />
    <script
      defer
      async
      src="https://cdn.tailwindcss.com"
      onload="setConfig()"
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />

    <style>
      :root {
        --text-color: #e0def4;
        --surface-color: #1f1d2e;
        --overlay-color: #26233a;
        --highlight-med: #403d52;
        --highlight-high: #524f67;
        --foam: #9ccfd8;
        --love: #eb6f92;
        --gold: #f6c177;
        --pine: #31748f;
        --iris: #c4a7e7;
        --muted: #6e6a86;
        --subtle: #908caa;

        --carbon-border-radius: 0.5rem;
        --carbon-transition-fast: 0.15s ease;
        --carbon-transition-normal: 0.3s ease;
        --carbon-font-size-base: 16px;

        --theme-base: #191724;
        --theme-surface: #1f1d2e;
        --theme-overlay: #26233a;
        --theme-muted: #6e6a86;
        --theme-subtle: #908caa;
        --theme-text: #e0def4;
        --theme-love: #eb6f92;
        --theme-gold: #f6c177;
        --theme-rose: #ebbcba;
        --theme-pine: #31748f;
        --theme-foam: #9ccfd8;
        --theme-iris: #c4a7e7;
        --theme-highlight-low: #21202e;
        --theme-highlight-med: #403d52;
        --theme-highlight-high: #524f67;
        --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
      }

      body {
        background: var(--theme-gradient);
        background-attachment: fixed;
        min-height: 100vh;
      }

      /* Vertical tabs optimized layout */
      .vertical-layout {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        max-width: 100vw;
        overflow-x: hidden;
      }

      /* Compact header for vertical tabs */
      .compact-header {
        padding: 1rem 1.5rem 0.5rem;
        border-bottom: 1px solid var(--theme-overlay);
        background: rgba(31, 29, 46, 0.8);
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .compact-header h1 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--theme-text);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .compact-header .subtitle {
        font-size: 0.75rem;
        color: var(--theme-muted);
        margin-top: 0.25rem;
      }

      /* Main content with better spacing for vertical tabs */
      .main-content {
        flex: 1;
        padding: 1.5rem;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
      }

      /* Enhanced search section */
      .search-section {
        margin-bottom: 2rem;
      }

      .search-container {
        max-width: 600px;
        margin: 0 auto;
        position: relative;
      }

      .search-input {
        width: 100%;
        height: 3rem;
        padding: 0 5rem 0 3rem;
        background: var(--theme-surface);
        border: 2px solid var(--theme-overlay);
        border-radius: 1rem;
        color: var(--theme-text);
        font-size: 1rem;
        transition: all var(--carbon-transition-normal);
      }

      .search-input:focus {
        outline: none;
        border-color: var(--theme-foam);
        box-shadow: 0 0 0 4px rgba(156, 207, 216, 0.1);
      }

      .search-input::placeholder {
        color: var(--theme-muted);
      }

      .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--theme-muted);
        font-size: 1.25rem;
      }

      .search-controls {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 0.5rem;
      }

      .control-btn {
        width: 2rem;
        height: 2rem;
        border-radius: 0.5rem;
        background: var(--theme-highlight-med);
        border: 2px solid var(--theme-overlay);
        color: var(--theme-text);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all var(--carbon-transition-fast);
      }

      .control-btn:hover {
        background: var(--theme-highlight-high);
        transform: translateY(-1px);
      }

      .control-btn.active {
        border-color: var(--theme-foam);
        background: var(--theme-foam);
        color: var(--theme-base);
      }

      /* Quick actions optimized for vertical tabs */
      .quick-actions {
        margin-bottom: 2rem;
      }

      .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--theme-text);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        max-width: 600px;
        margin: 0 auto;
      }

      .quick-action {
        background: var(--theme-surface);
        border: 1px solid var(--theme-overlay);
        border-radius: 0.75rem;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all var(--carbon-transition-normal);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }

      .quick-action:hover {
        background: var(--theme-overlay);
        border-color: var(--theme-foam);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(156, 207, 216, 0.15);
      }

      .quick-action i {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
      }

      .quick-action span {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--theme-text);
      }

      /* Bookmarks section */
      .bookmarks-section {
        margin-bottom: 2rem;
      }

      .bookmarks-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .add-bookmark-btn {
        background: var(--theme-foam);
        color: var(--theme-base);
        border: none;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--carbon-transition-fast);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .add-bookmark-btn:hover {
        background: var(--theme-pine);
        transform: translateY(-1px);
      }

      .bookmark-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
      }

      .bookmark-item {
        background: var(--theme-surface);
        border: 1px solid var(--theme-overlay);
        border-radius: 0.75rem;
        padding: 1rem;
        cursor: pointer;
        transition: all var(--carbon-transition-normal);
        position: relative;
        overflow: hidden;
      }

      .bookmark-item:hover {
        background: var(--theme-overlay);
        border-color: var(--theme-foam);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(156, 207, 216, 0.15);
      }

      .bookmark-item.editing {
        border-color: var(--theme-gold);
        background: var(--theme-highlight-med);
      }

      .bookmark-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
      }

      .bookmark-icon {
        width: 2rem;
        height: 2rem;
        border-radius: 0.5rem;
        background: rgba(156, 207, 216, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--theme-foam);
        font-size: 1rem;
      }

      .bookmark-actions {
        display: flex;
        gap: 0.25rem;
        opacity: 0;
        transition: opacity var(--carbon-transition-fast);
      }

      .bookmark-item:hover .bookmark-actions {
        opacity: 1;
      }

      .bookmark-action {
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 0.25rem;
        background: transparent;
        border: none;
        color: var(--theme-muted);
        cursor: pointer;
        transition: all var(--carbon-transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .bookmark-action:hover {
        background: var(--theme-highlight-med);
        color: var(--theme-text);
      }

      .bookmark-action.delete:hover {
        background: var(--theme-love);
        color: var(--theme-text);
      }

      .bookmark-title {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--theme-text);
        margin-bottom: 0.25rem;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .bookmark-url {
        font-size: 0.75rem;
        color: var(--theme-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* Modal styles */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity var(--carbon-transition-normal);
        z-index: 1000;
      }

      .modal.active {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-content {
        background: var(--theme-surface);
        border: 1px solid var(--theme-overlay);
        border-radius: 1rem;
        padding: 1.5rem;
        width: 90vw;
        max-width: 400px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--theme-text);
        margin-bottom: 1rem;
      }

      .form-group {
        margin-bottom: 1rem;
      }

      .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--theme-text);
        margin-bottom: 0.5rem;
      }

      .form-input {
        width: 100%;
        padding: 0.75rem;
        background: var(--theme-highlight-med);
        border: 1px solid var(--theme-overlay);
        border-radius: 0.5rem;
        color: var(--theme-text);
        font-size: 0.875rem;
        transition: all var(--carbon-transition-fast);
      }

      .form-input:focus {
        outline: none;
        border-color: var(--theme-foam);
        box-shadow: 0 0 0 3px rgba(156, 207, 216, 0.1);
      }

      .form-input::placeholder {
        color: var(--theme-muted);
      }

      .form-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1.5rem;
      }

      .btn {
        flex: 1;
        padding: 0.75rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--carbon-transition-fast);
      }

      .btn-primary {
        background: var(--theme-foam);
        color: var(--theme-base);
      }

      .btn-primary:hover {
        background: var(--theme-pine);
      }

      .btn-secondary {
        background: var(--theme-highlight-med);
        color: var(--theme-text);
      }

      .btn-secondary:hover {
        background: var(--theme-highlight-high);
      }

      /* Suggestion box */
      .suggestion-box {
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        z-index: 1200;
        background: var(--theme-surface);
        border-radius: 0 0 var(--carbon-border-radius) var(--carbon-border-radius);
        border: 1px solid var(--theme-overlay);
        border-top: none;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        color: var(--theme-text);
        font-size: 0.9rem;
        display: none;
      }

      .suggestion-box.active {
        display: block;
      }

      .suggestion-item {
        padding: 0.75rem;
        cursor: pointer;
        transition: background var(--carbon-transition-fast);
        border-bottom: 1px solid var(--theme-overlay);
      }

      .suggestion-item:last-child {
        border-bottom: none;
      }

      .suggestion-item:hover,
      .suggestion-item.active {
        background: var(--theme-overlay);
        color: var(--theme-foam);
      }

      /* Footer */
      .footer {
        padding: 1rem 1.5rem;
        text-align: center;
        color: var(--theme-muted);
        font-size: 0.75rem;
        border-top: 1px solid var(--theme-overlay);
        background: rgba(31, 29, 46, 0.5);
      }

      .footer kbd {
        background: var(--theme-highlight-med);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        color: var(--theme-text);
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .main-content {
          padding: 1rem;
        }
        
        .quick-actions-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        
        .bookmark-grid {
          grid-template-columns: 1fr;
        }
        
        .search-container {
          max-width: none;
        }
      }

      @media (max-width: 480px) {
        .compact-header {
          padding: 0.75rem 1rem 0.5rem;
        }
        
        .search-input {
          height: 2.5rem;
          padding: 0 4rem 0 2.5rem;
        }
        
        .search-icon {
          left: 0.75rem;
        }
        
        .search-controls {
          right: 0.5rem;
        }
      }
    </style>
  </head>
  <body class="font-inter">
    <div class="vertical-layout">
      <!-- Compact Header -->
      <header class="compact-header">
        <h1>
          <i class="bx bx-atom text-foam"></i>
          Carbon
        </h1>
        <p class="subtitle">New Tab</p>
      </header>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Search Section -->
        <section class="search-section">
          <div class="search-container">
            <form id="search-form">
              <div style="position: relative;">
                <i class="bx bx-search search-icon"></i>
                <input
                  id="search-input"
                  type="text"
                  class="search-input"
                  spellcheck="false"
                  autocomplete="off"
                  placeholder="Search or enter website URL"
                />
                <div class="search-controls">
                  <button
                    id="proxy-toggle"
                    type="button"
                    class="control-btn"
                    title="UV Proxy"
                  >
                    <i id="proxy-icon" class="bx bx-cloud"></i>
                  </button>
                  <button
                    id="search-engine-toggle"
                    type="button"
                    class="control-btn"
                    title="Search Engine"
                  >
                    <i id="search-engine-icon" class="bxl-brave"></i>
                  </button>
                </div>
              </div>
              <div id="suggestion-box" class="suggestion-box"></div>
            </form>
          </div>
        </section>

        <!-- Quick Actions -->
        <section class="quick-actions">
          <h2 class="section-title">
            <i class="bx bx-flash text-gold"></i>
          </h2>
          <div class="quick-actions-grid">
            <button class="quick-action" onclick="navigateToCarbon('carbon://games')">
              <i class="bx bx-game text-foam"></i>
              <span>Games</span>
            </button>
            <button class="quick-action" onclick="navigateToCarbon('carbon://history')">
              <i class="bx bx-history text-iris"></i>
              <span>History</span>
            </button>
            <button class="quick-action" onclick="navigateToCarbon('carbon://settings')">
              <i class="bx bx-cog text-gold"></i>
              <span>Settings</span>
            </button>
            <button class="quick-action" onclick="navigateToCarbon('carbon://account')">
              <i class="bx bx-user text-pine"></i>
              <span>Profile</span>
            </button>
          </div>
        </section>


    <script src="carbon-theme.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script type="module">
      import { makeURL, getProxied, setProxy, getProxy } from '/lethal.mjs';
      
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
        authDomain: "carbon-services.firebaseapp.com",
        projectId: "carbon-services",
        storageBucket: "carbon-services.firebasestorage.app",
        messagingSenderId: "288385472070",
        appId: "1:288385472070:web:c4be3ff186e248fc645c47",
        measurementId: "G-Y2K1RQYE74"
      };
      
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // Search Engine Configuration
      const searchEngines = {
        'https://search.brave.com/search?q=%s': ['Brave', 'bxl-brave'],
        'https://duckduckgo.com/?q=%s': ['DuckDuckGo', 'bxl-duckduckgo'],
        'https://www.google.com/search?q=%s': ['Google', 'bxl-google'],
        'https://www.bing.com/search?q=%s': ['Bing', 'bxl-microsoft'],
        'https://search.yahoo.com/search?p=%s': ['Yahoo', 'bxl-yahoo'],
      };

      // State Management
      let currentSearchEngine = localStorage.getItem('search-engine') || 'https://search.brave.com/search?q=%s';
      let currentProxy = localStorage.getItem('proxy-backend') || 'uv';
      let bookmarks = JSON.parse(localStorage.getItem('carbon-bookmarks') || '[]');
      let currentUser = null;
      
      // Authentication state observer
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        if (user) {
          loadBookmarksFromFirebase();
        }
      });

      // Navigation function for Carbon pages
      function navigateToCarbon(url) {
        window.parent.postMessage({
          type: 'carbon-navigate',
          url: url
        }, '*');
      }

      // Theme integration
      window.addEventListener('storage', (event) => {
        if (event.key === 'carbon-theme-global' && event.newValue) {
          if (window.carbonTheme) {
            window.carbonTheme.applyTheme(event.newValue);
          }
        }
      });

      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'carbon-theme-change') {
          if (window.carbonTheme) {
            window.carbonTheme.applyTheme(event.data.theme);
          }
        } else if (event.data && event.data.type === 'carbon-vertical-tabs-state') {
          // Adjust layout based on vertical tabs state
          const layout = document.querySelector('.vertical-layout');
          if (event.data.enabled) {
            layout.classList.add('vertical-layout');
          } else {
            layout.classList.remove('vertical-layout');
          }
        }
      });

      // Proxy Management
      function toggleProxy() {
        const proxies = ['uv', 'scram'];
        const currentIndex = proxies.indexOf(currentProxy);
        const nextIndex = (currentIndex + 1) % proxies.length;
        currentProxy = proxies[nextIndex];
        
        localStorage.setItem('proxy-backend', currentProxy);
        setProxy(currentProxy);
        updateProxyUI();
        
        // Broadcast proxy change
        window.parent.postMessage({
          type: 'carbon-proxy-sync',
          proxy: currentProxy
        }, '*');
      }

      function updateProxyUI() {
        const proxyIcon = document.getElementById('proxy-icon');
        const proxyToggle = document.getElementById('proxy-toggle');
        
        if (currentProxy === 'uv') {
          proxyIcon.className = 'bx bx-cloud';
          proxyToggle.title = 'UV Proxy';
          proxyToggle.style.borderColor = 'var(--theme-foam)';
        } else {
          proxyIcon.className = 'bx bx-network-chart';
          proxyToggle.title = 'Scramjet Proxy';
          proxyToggle.style.borderColor = 'var(--theme-pine)';
        }
      }

      // Search Engine Management
      function toggleSearchEngine() {
        const engines = Object.keys(searchEngines);
        const currentIndex = engines.indexOf(currentSearchEngine);
        const nextIndex = (currentIndex + 1) % engines.length;
        currentSearchEngine = engines[nextIndex];
        
        localStorage.setItem('search-engine', currentSearchEngine);
        updateSearchEngineUI();
        
        // Broadcast search engine change
        window.parent.postMessage({
          type: 'carbon-search-engine-sync',
          searchEngine: currentSearchEngine
        }, '*');
      }

      function updateSearchEngineUI() {
        const engineIcon = document.getElementById('search-engine-icon');
        const engineToggle = document.getElementById('search-engine-toggle');
        const [name, icon] = searchEngines[currentSearchEngine];
        
        engineIcon.className = `bx ${icon}`;
        engineToggle.title = name;
      }

      // Bookmark Management
      async function loadBookmarksFromFirebase() {
        if (!currentUser) return;
        
        try {
          const userDoc = await db.collection('users').doc(currentUser.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            if (userData.bookmarks) {
              bookmarks = userData.bookmarks;
              localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
              renderBookmarks();
            }
          }
        } catch (error) {
          console.error('Error loading bookmarks from Firebase:', error);
        }
      }

      async function saveBookmarksToFirebase() {
        if (!currentUser) return;
        
        try {
          await db.collection('users').doc(currentUser.uid).set({
            bookmarks: bookmarks,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        } catch (error) {
          console.error('Error saving bookmarks to Firebase:', error);
        }
      }

      function renderBookmarks() {
        const grid = document.getElementById('bookmarks-grid');
        
        if (bookmarks.length === 0) {
          grid.innerHTML = `
            <div class="col-span-full text-center text-muted py-8">
              <i class="bx bx-bookmark text-4xl mb-2"></i>
              <p>No bookmarks yet. Click "Add Bookmark" to get started!</p>
            </div>
          `;
          return;
        }
        
        grid.innerHTML = bookmarks.map((bookmark, index) => `
          <div class="bookmark-item" data-index="${index}">
            <div class="flex items-start justify-between mb-3">
              <div class="w-8 h-8 rounded-lg bg-foam/20 flex items-center justify-center flex-shrink-0">
                <i class="bx bx-bookmark text-foam"></i>
              </div>
              <div class="flex gap-1">
                <button class="edit-bookmark w-6 h-6 rounded hover:bg-highlight-med flex items-center justify-center text-muted hover:text-text transition-colors">
                  <i class="bx bx-edit text-xs"></i>
                </button>
                <button class="delete-bookmark w-6 h-6 rounded hover:bg-love/20 flex items-center justify-center text-muted hover:text-love transition-colors">
                  <i class="bx bx-trash text-xs"></i>
                </button>
              </div>
            </div>
            <h3 class="font-medium text-text mb-1 leading-tight line-clamp-2">${bookmark.title}</h3>
            <p class="text-xs text-muted truncate">${bookmark.url}</p>
          </div>
        `).join('');

        // Add event listeners for bookmark interactions
        grid.querySelectorAll('.bookmark-item').forEach((item, index) => {
          const bookmark = bookmarks[index];
          
          item.addEventListener('click', (e) => {
            if (!e.target.closest('button')) {
              openBookmark(bookmark.url);
            }
          });
          
          const deleteBtn = item.querySelector('.delete-bookmark');
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            removeBookmark(bookmark.id);
          });
          
          const editBtn = item.querySelector('.edit-bookmark');
          editBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            editBookmark(index);
          });
        });
      }

      function openBookmark(url) {
        window.parent.postMessage({
          type: 'carbon-navigate',
          url: url
        }, '*');
      }

      function addBookmark(title, url) {
        const bookmark = {
          id: Date.now().toString(),
          title: title.trim(),
          url: url.trim(),
          created: new Date().toISOString()
        };
        
        bookmarks.unshift(bookmark);
        localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
        saveBookmarksToFirebase();
        renderBookmarks();
      }

      function removeBookmark(id) {
        bookmarks = bookmarks.filter(b => b.id !== id);
        localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
        saveBookmarksToFirebase();
        renderBookmarks();
      }

      function editBookmark(index) {
        const bookmark = bookmarks[index];
        const newTitle = prompt('Edit bookmark title:', bookmark.title);
        const newUrl = prompt('Edit bookmark URL:', bookmark.url);
        
        if (newTitle !== null && newUrl !== null && newTitle.trim() && newUrl.trim()) {
          bookmarks[index] = {
            ...bookmark,
            title: newTitle.trim(),
            url: newUrl.trim()
          };
          localStorage.setItem('carbon-bookmarks', JSON.stringify(bookmarks));
          saveBookmarksToFirebase();
          renderBookmarks();
        }
      }

      // Search functionality
      function handleSearch(query) {
        if (!query.trim()) return;
        
        const url = makeURL(query, currentSearchEngine);
        window.parent.postMessage({
          type: 'carbon-navigate',
          url: url
        }, '*');
      }

      // Event Listeners
      document.getElementById('proxy-toggle').addEventListener('click', toggleProxy);
      document.getElementById('search-engine-toggle').addEventListener('click', toggleSearchEngine);

      document.getElementById('search-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const query = document.getElementById('search-input').value;
        handleSearch(query);
      });

      document.getElementById('add-bookmark-btn').addEventListener('click', () => {
        const modal = document.getElementById('bookmark-modal');
        modal.classList.remove('opacity-0', 'pointer-events-none');
        modal.classList.add('opacity-100', 'pointer-events-auto');
        document.getElementById('bookmark-title').focus();
      });

      document.getElementById('cancel-bookmark').addEventListener('click', () => {
        const modal = document.getElementById('bookmark-modal');
        modal.classList.add('opacity-0', 'pointer-events-none');
        modal.classList.remove('opacity-100', 'pointer-events-auto');
        document.getElementById('bookmark-form').reset();
      });

      document.getElementById('bookmark-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const title = document.getElementById('bookmark-title').value;
        const url = document.getElementById('bookmark-url').value;
        
        if (title && url) {
          addBookmark(title, url);
          document.getElementById('cancel-bookmark').click();
        }
      });

      // Initialize
      setProxy(currentProxy);
      updateProxyUI();
      updateSearchEngineUI();
      renderBookmarks();

      // Request vertical tabs state from parent
      window.parent.postMessage({
        type: 'carbon-request-vertical-tabs-state'
      }, '*');

      // Expose functions globally for onclick handlers
      window.navigateToCarbon = navigateToCarbon;
      window.removeBookmark = removeBookmark;
      window.editBookmark = editBookmark;
    </script>
  </body>
</html>
