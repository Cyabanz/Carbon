<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>History - Carbon</title>
    <script defer async>
      function setConfig() {
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                display: ["Switzer", "Helvetica", "sans-serif"],
                inter: ["Inter", "sans-serif"],
              },
              colors: {
                base: "#191724",
                surface: "#1f1d2e",
                overlay: "#26233a",
                muted: "#6e6a86",
                subtle: "#908caa",
                text: "#e0def4",
                love: "#eb6f92",
                gold: "#f6c177",
                rose: "#ebbcba",
                pine: "#31748f",
                foam: "#9ccfd8",
                iris: "#c4a7e7",
                "highlight-low": "#21202e",
                "highlight-med": "#403d52",
                "highlight-high": "#524f67",
              },
            },
          },
        };
      }
    </script>

    <link rel="preconnect" href="https://unpkg.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" />
    <script
      defer
      async
      src="https://cdn.tailwindcss.com"
      onload="setConfig()"
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <script src="carbon-theme.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
      /* Theme Color Variables */
      :root {
        --text-color: #e0def4;
        --surface-color: #1f1d2e;
        --overlay-color: #26233a;
        --highlight-med: #403d52;
        --highlight-high: #524f67;
        --foam: #9ccfd8;
        --love: #eb6f92;
        --gold: #f6c177;
        --pine: #31748f;
        --iris: #c4a7e7;
        --muted: #6e6a86;
        --subtle: #908caa;

        /* Theme variables - Rose Pine (default) */
        --theme-base: #191724;
        --theme-surface: #1f1d2e;
        --theme-overlay: #26233a;
        --theme-muted: #6e6a86;
        --theme-subtle: #908caa;
        --theme-text: #e0def4;
        --theme-love: #eb6f92;
        --theme-gold: #f6c177;
        --theme-rose: #ebbcba;
        --theme-pine: #31748f;
        --theme-foam: #9ccfd8;
        --theme-iris: #c4a7e7;
        --theme-highlight-low: #21202e;
        --theme-highlight-med: #403d52;
        --theme-highlight-high: #524f67;
        --theme-gradient: linear-gradient(135deg, #191724 0%, #1f1d2e 50%, #26233a 100%);
      }
      
      /* Add all theme variations */
      [data-theme="dark"] {
        --theme-base: #0f172a;
        --theme-surface: #1e293b;
        --theme-overlay: #334155;
        --theme-muted: #64748b;
        --theme-subtle: #94a3b8;
        --theme-text: #f1f5f9;
        --theme-love: #ef4444;
        --theme-gold: #f59e0b;
        --theme-rose: #f97316;
        --theme-pine: #059669;
        --theme-foam: #06b6d4;
        --theme-iris: #8b5cf6;
        --theme-highlight-low: #1e293b;
        --theme-highlight-med: #475569;
        --theme-highlight-high: #64748b;
        --theme-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      }
      
      [data-theme="light"] {
        --theme-base: #f8fafc;
        --theme-surface: #e2e8f0;
        --theme-overlay: #cbd5e1;
        --theme-muted: #64748b;
        --theme-subtle: #475569;
        --theme-text: #0f172a;
        --theme-love: #dc2626;
        --theme-gold: #d97706;
        --theme-rose: #ea580c;
        --theme-pine: #047857;
        --theme-foam: #0891b2;
        --theme-iris: #7c3aed;
        --theme-highlight-low: #f1f5f9;
        --theme-highlight-med: #e2e8f0;
        --theme-highlight-high: #cbd5e1;
        --theme-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
      }
      
      [data-theme="catppuccin"] {
        --theme-base: #1e1e2e;
        --theme-surface: #313244;
        --theme-overlay: #45475a;
        --theme-muted: #6c7086;
        --theme-subtle: #9399b2;
        --theme-text: #cdd6f4;
        --theme-love: #f38ba8;
        --theme-gold: #f9e2af;
        --theme-rose: #fab387;
        --theme-pine: #a6e3a1;
        --theme-foam: #89dceb;
        --theme-iris: #cba6f7;
        --theme-highlight-low: #181825;
        --theme-highlight-med: #313244;
        --theme-highlight-high: #45475a;
        --theme-gradient: linear-gradient(135deg, #1e1e2e 0%, #313244 50%, #45475a 100%);
      }
      
      [data-theme="nord"] {
        --theme-base: #2e3440;
        --theme-surface: #3b4252;
        --theme-overlay: #434c5e;
        --theme-muted: #4c566a;
        --theme-subtle: #d8dee9;
        --theme-text: #eceff4;
        --theme-love: #bf616a;
        --theme-gold: #ebcb8b;
        --theme-rose: #d08770;
        --theme-pine: #a3be8c;
        --theme-foam: #88c0d0;
        --theme-iris: #b48ead;
        --theme-highlight-low: #2e3440;
        --theme-highlight-med: #434c5e;
        --theme-highlight-high: #4c566a;
        --theme-gradient: linear-gradient(135deg, #2e3440 0%, #3b4252 50%, #434c5e 100%);
      }
      
      [data-theme="gruvbox"] {
        --theme-base: #282828;
        --theme-surface: #3c3836;
        --theme-overlay: #504945;
        --theme-muted: #665c54;
        --theme-subtle: #a89984;
        --theme-text: #ebdbb2;
        --theme-love: #fb4934;
        --theme-gold: #fabd2f;
        --theme-rose: #fe8019;
        --theme-pine: #b8bb26;
        --theme-foam: #8ec07c;
        --theme-iris: #d3869b;
        --theme-highlight-low: #1d2021;
        --theme-highlight-med: #3c3836;
        --theme-highlight-high: #504945;
        --theme-gradient: linear-gradient(135deg, #282828 0%, #3c3836 50%, #504945 100%);
      }
      
      [data-theme="tokyo-night"] {
        --theme-base: #1a1b26;
        --theme-surface: #24283b;
        --theme-overlay: #414868;
        --theme-muted: #565f89;
        --theme-subtle: #a9b1d6;
        --theme-text: #c0caf5;
        --theme-love: #f7768e;
        --theme-gold: #e0af68;
        --theme-rose: #ff9e64;
        --theme-pine: #9ece6a;
        --theme-foam: #7dcfff;
        --theme-iris: #bb9af7;
        --theme-highlight-low: #16161e;
        --theme-highlight-med: #24283b;
        --theme-highlight-high: #414868;
        --theme-gradient: linear-gradient(135deg, #1a1b26 0%, #24283b 50%, #414868 100%);
      }
      
      [data-theme="dracula"] {
        --theme-base: #282a36;
        --theme-surface: #44475a;
        --theme-overlay: #6272a4;
        --theme-muted: #6272a4;
        --theme-subtle: #f8f8f2;
        --theme-text: #f8f8f2;
        --theme-love: #ff5555;
        --theme-gold: #f1fa8c;
        --theme-rose: #ffb86c;
        --theme-pine: #50fa7b;
        --theme-foam: #8be9fd;
        --theme-iris: #bd93f9;
        --theme-highlight-low: #21222c;
        --theme-highlight-med: #44475a;
        --theme-highlight-high: #6272a4;
        --theme-gradient: linear-gradient(135deg, #282a36 0%, #44475a 50%, #6272a4 100%);
      }

      body {
        background: var(--theme-gradient);
        background-attachment: fixed;
      }

      .history-item {
        background: var(--theme-surface);
        border: 1px solid var(--theme-overlay);
        border-radius: 0.5rem;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .history-item:hover {
        background: var(--theme-overlay);
        border-color: var(--theme-foam);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(156, 207, 216, 0.1);
      }
      .search-container {
        position: sticky;
        top: 0;
        background: var(--theme-base);
        backdrop-filter: blur(10px);
        z-index: 10;
        border-bottom: 1px solid var(--theme-overlay);
      }
    </style>
  </head>
  <body class="font-inter min-h-screen" style="background: var(--theme-gradient); color: var(--theme-text);">
    <div class="min-h-screen">
      <!-- Header -->
      <header class="p-6 text-center">
        <h1 class="text-4xl font-bold mb-2 flex items-center justify-center gap-3" style="color: var(--theme-text);">
          <i class="bx bx-history" style="color: var(--theme-iris);"></i>
          History
        </h1>
        <p class="text-sm" style="color: var(--theme-muted);">Your browsing history</p>
      </header>

      <!-- Search and Controls -->
      <div class="search-container px-6 py-4">
        <div class="max-w-4xl mx-auto">
          <div class="flex items-center gap-4 mb-4">
            <div class="flex-1 relative">
              <i class="bx bx-search absolute left-3 top-1/2 transform -translate-y-1/2 text-muted"></i>
              <input
                id="history-search"
                type="text"
                placeholder="Search history..."
                class="w-full pl-10 pr-4 py-2 rounded-lg focus:outline-none transition-colors history-search-input"
              />
            </div>
            <button
              id="clear-all-history"
              class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2 text-white clear-history-btn"
            >
              <i class="bx bx-trash"></i>
              Clear All
            </button>
          </div>
          
          <!-- Filter Tabs -->
          <div class="flex gap-2">
            <button class="filter-tab active" data-filter="all">
              <i class="bx bx-globe"></i>
              All History
            </button>
            <button class="filter-tab" data-filter="today">
              <i class="bx bx-calendar-day"></i>
              Today
            </button>
            <button class="filter-tab" data-filter="week">
              <i class="bx bx-calendar-week"></i>
              This Week
            </button>
            <button class="filter-tab" data-filter="month">
              <i class="bx bx-calendar"></i>
              This Month
            </button>
          </div>
        </div>
      </div>

      <!-- History Content -->
      <main class="max-w-4xl mx-auto px-6 pb-6">
        <div id="history-list" class="space-y-3">
          <!-- History items will be populated here -->
        </div>
        
        <div id="no-history" class="text-center py-12 hidden">
          <i class="bx bx-history text-6xl text-muted mb-4"></i>
          <h3 class="text-xl font-semibold text-text mb-2">No History Found</h3>
          <p class="text-muted">Your browsing history will appear here as you navigate.</p>
        </div>
      </main>
    </div>

    <style>
              .filter-tab {
          padding: 0.5rem 1rem;
          background: transparent;
          border: 1px solid var(--theme-overlay);
          border-radius: 0.5rem;
          color: var(--theme-subtle);
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 0.875rem;
        }
        .filter-tab:hover {
          background: var(--theme-overlay);
          color: var(--theme-text);
        }
        .filter-tab.active {
          background: var(--theme-foam);
          color: var(--theme-base);
          border-color: var(--theme-foam);
        }
        
        .history-search-input {
          background: var(--theme-surface);
          border: 1px solid var(--theme-overlay);
          color: var(--theme-text);
        }
        
        .history-search-input:focus {
          border-color: var(--theme-foam);
          box-shadow: 0 0 0 2px rgba(156, 207, 216, 0.2);
        }
        
        .history-search-input::placeholder {
          color: var(--theme-muted);
        }
        
        .clear-history-btn {
          background: var(--theme-love);
        }
        
        .clear-history-btn:hover {
          opacity: 0.8;
        }
    </style>

    <script type="module">
      import { makeURL, getProxied } from '/lethal.mjs';
      
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyC4ilHYP1T-kdXbWPoHJHhD2aj0pNWmMec",
        authDomain: "carbon-services.firebaseapp.com",
        projectId: "carbon-services",
        storageBucket: "carbon-services.firebasestorage.app",
        messagingSenderId: "288385472070",
        appId: "1:288385472070:web:c4be3ff186e248fc645c47",
        measurementId: "G-Y2K1RQYE74"
      };
      
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();

      // DOM Elements
      const historyList = document.getElementById('history-list');
      const noHistory = document.getElementById('no-history');
      const historySearch = document.getElementById('history-search');
      const clearAllBtn = document.getElementById('clear-all-history');
      const filterTabs = document.querySelectorAll('.filter-tab');

      // State
      let allHistory = [];
      let filteredHistory = [];
      let currentFilter = 'all';
      let currentUser = null;
      
      // Firebase sync functions
      async function loadHistoryFromFirebase() {
        if (!currentUser) return;
        
        try {
          const userDoc = await db.collection('users').doc(currentUser.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            if (userData.history) {
              allHistory = userData.history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
              localStorage.setItem('carbon-history', JSON.stringify(allHistory));
              filterHistory();
              renderHistory();
            }
          }
        } catch (error) {
          console.error('Error loading history from Firebase:', error);
        }
      }
      
      async function saveHistoryToFirebase() {
        if (!currentUser) return;
        
        try {
          await db.collection('users').doc(currentUser.uid).set({
            history: allHistory,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        } catch (error) {
          console.error('Error saving history to Firebase:', error);
        }
      }
      
      // Authentication state observer
      auth.onAuthStateChanged((user) => {
        currentUser = user;
        if (user) {
          loadHistoryFromFirebase();
        } else {
          loadHistory();
        }
      });

      // Load history from localStorage
      function loadHistory() {
        const history = JSON.parse(localStorage.getItem('carbon-history') || '[]');
        allHistory = history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        filterHistory();
        renderHistory();
      }

              // Save history to localStorage and Firebase
        async function saveHistory() {
          localStorage.setItem('carbon-history', JSON.stringify(allHistory));
          await saveHistoryToFirebase();
        }

      // Add item to history (called from parent frame)
      function addToHistory(url, title = '') {
        // Don't add carbon:// URLs to history
        if (url.startsWith('carbon://')) return;
        
        const item = {
          id: Date.now() + Math.random(),
          url: url,
          title: title || url,
          timestamp: new Date().toISOString(),
          visits: 1
        };

        // Check if URL already exists
        const existingIndex = allHistory.findIndex(h => h.url === url);
        if (existingIndex !== -1) {
          allHistory[existingIndex].timestamp = item.timestamp;
          allHistory[existingIndex].visits++;
          allHistory[existingIndex].title = title || allHistory[existingIndex].title;
        } else {
          allHistory.unshift(item);
        }

        // Limit history to 1000 items
        if (allHistory.length > 1000) {
          allHistory = allHistory.slice(0, 1000);
        }

        saveHistory();
        filterHistory();
        renderHistory();
      }

      // Filter history based on current filter
      function filterHistory() {
        const searchTerm = historySearch.value.toLowerCase();
        const now = new Date();
        
        let filtered = allHistory;

        // Apply time filter
        if (currentFilter === 'today') {
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          filtered = allHistory.filter(item => new Date(item.timestamp) >= today);
        } else if (currentFilter === 'week') {
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          filtered = allHistory.filter(item => new Date(item.timestamp) >= weekAgo);
        } else if (currentFilter === 'month') {
          const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          filtered = allHistory.filter(item => new Date(item.timestamp) >= monthAgo);
        }

        // Apply search filter
        if (searchTerm) {
          filtered = filtered.filter(item => 
            item.url.toLowerCase().includes(searchTerm) ||
            item.title.toLowerCase().includes(searchTerm)
          );
        }

        filteredHistory = filtered;
      }

      // Render history items
      function renderHistory() {
        if (filteredHistory.length === 0) {
          historyList.classList.add('hidden');
          noHistory.classList.remove('hidden');
          return;
        }

        historyList.classList.remove('hidden');
        noHistory.classList.add('hidden');

        // Group by date
        const groupedHistory = {};
        filteredHistory.forEach(item => {
          const date = new Date(item.timestamp).toDateString();
          if (!groupedHistory[date]) {
            groupedHistory[date] = [];
          }
          groupedHistory[date].push(item);
        });

        historyList.innerHTML = Object.entries(groupedHistory).map(([date, items]) => {
          const isToday = date === new Date().toDateString();
          const isYesterday = date === new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString();
          
          let displayDate = date;
          if (isToday) displayDate = 'Today';
          else if (isYesterday) displayDate = 'Yesterday';

          return `
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-text mb-3 flex items-center gap-2">
                <i class="bx bx-calendar text-foam"></i>
                ${displayDate}
              </h3>
              <div class="space-y-2">
                ${items.map(item => `
                  <div class="history-item" data-url="${item.url}">
                    <div class="flex items-start justify-between">
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                          <i class="bx bx-world text-foam flex-shrink-0"></i>
                          <h4 class="font-medium text-text truncate">${item.title}</h4>
                          ${item.visits > 1 ? `<span class="text-xs bg-highlight-med px-2 py-0.5 rounded text-muted">${item.visits} visits</span>` : ''}
                        </div>
                        <p class="text-sm text-muted truncate">${item.url}</p>
                        <p class="text-xs text-subtle mt-1">${formatTime(item.timestamp)}</p>
                      </div>
                      <div class="flex items-center gap-1 ml-2">
                        <button class="delete-item w-8 h-8 rounded hover:bg-love/20 flex items-center justify-center text-muted hover:text-love transition-colors" data-id="${item.id}">
                          <i class="bx bx-trash text-sm"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }).join('');

        // Add event listeners
        document.querySelectorAll('.history-item').forEach(item => {
          item.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-item')) return;
            
            const url = item.dataset.url;
            
            // Check if we're in an iframe (within the proxy browser)
            if (window.parent && window.parent !== window) {
              // Send message to parent frame to navigate
              window.parent.postMessage({
                type: 'carbon-navigate',
                url: url
              }, '*');
            } else {
              // Navigate normally if not in iframe
              const proxiedUrl = await getProxied(makeURL(url));
              window.location.href = proxiedUrl;
            }
          });
        });

        document.querySelectorAll('.delete-item').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = parseFloat(btn.dataset.id);
            deleteHistoryItem(id);
          });
        });
      }

      // Format timestamp
      function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) { // Less than 1 minute
          return 'Just now';
        } else if (diff < 3600000) { // Less than 1 hour
          const minutes = Math.floor(diff / 60000);
          return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        } else if (diff < 86400000) { // Less than 1 day
          return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        } else {
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
      }

              // Delete single history item
        async function deleteHistoryItem(id) {
          allHistory = allHistory.filter(item => item.id !== id);
          await saveHistory();
          filterHistory();
          renderHistory();
        }

        // Clear all history
        async function clearAllHistory() {
          if (confirm('Are you sure you want to clear all history? This action cannot be undone.')) {
            allHistory = [];
            await saveHistory();
            filterHistory();
            renderHistory();
          }
        }

      // Event listeners
      historySearch.addEventListener('input', () => {
        filterHistory();
        renderHistory();
      });

      clearAllBtn.addEventListener('click', clearAllHistory);

      filterTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          filterTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.filter;
          filterHistory();
          renderHistory();
        });
      });

      // Listen for history updates from parent frame
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'carbon-add-history') {
          addToHistory(event.data.url, event.data.title);
        }
      });

      // Expose addToHistory for external use
      window.addToHistory = addToHistory;

      // Initialize
      loadHistory();
    </script>
  </body>
</html>